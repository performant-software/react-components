import{a as S,x as M,c as O,u as q,b as P,d as m,m as T,e as D,g as H,v as I,s as W,h as X,S as _,F as B,l as A,i as G}from"./peripleo-maplibre.es26-DiUCIHtK.js";import{r as l}from"./index-C0dDX-lL.js";const Y=o=>{const{position:r}=o;return S.jsx("div",{className:r?`p6o-controls-container ${r}`:"p6o-controls-container",children:o.children})},ee=o=>S.jsx(M,{breakPoint:o.deviceBreakpoint||540,children:S.jsx(O,{children:S.jsx(q,{children:S.jsx(P,{children:o.children})})})}),J=(o,r)=>{const n=o.getCanvasContainer().querySelector("canvas").getBoundingClientRect();let t=0,s=0;r.left-40<n.left?t=r.left-n.left-40:r.right+40>n.right&&(t=r.right-n.right+40),r.top-40<n.top?s=r.top-n.top-40:r.bottom+40>n.bottom&&(s=r.bottom+40-n.bottom),(t!==0||s!==0)&&o.panBy([t,s])},K=o=>{const{popup:r,...n}=o,{map:t,selected:s}=n,p=l.useRef(null);return l.useEffect(()=>{if(!s)return;const{offsetWidth:a}=p.current,h=()=>{const{coordinates:C}=s.geometry,g=t.project(C),{height:j}=t._container.getBoundingClientRect(),v=p.current.style;v.left=`${g.x-a/2}px`,v.bottom=`${j-g.y}px`},f=()=>h();return t.on("move",f),h(),J(t,p.current.getBoundingClientRect()),()=>{t.off("move",f)}},[s]),m.jsx("div",{ref:p,className:"p6o-popup-container",children:s?r(n):null})},te=()=>{const o=T(),r=n=>()=>{o.easeTo({zoom:o.getZoom()+n})};return m.jsxs("div",{className:"p6o-zoom",children:[m.jsx("button",{className:"p6o-control p6o-control-btn p6o-zoom-in","aria-label":"Zoom in",onClick:r(1),children:m.jsx(D,{size:20})}),m.jsx("button",{className:"p6o-control p6o-control-btn p6o-zoom-out","aria-label":"Zoom out",onClick:r(-1),children:m.jsx(H,{size:20})})]})},F=o=>{const[r,n]=l.useState();return[r,(t,s,p)=>n(a=>{var h;if((s==null?void 0:s.id)===((h=a==null?void 0:a.feature)==null?void 0:h.id))return a;if(a)try{t.setFeatureState({source:a.source,id:a.feature.id},{[o]:!1})}catch{}if(s){const f=p||I(t,s.id);if(f)return t.setFeatureState({source:f,id:s.id},{[o]:!0}),{source:f,feature:s}}})]},$=3,oe=o=>{const r=l.useRef(null),n=l.useContext(W),t=n.map,{setMap:s}=n,p=l.useRef(new Set),[a,h]=F("hover"),{hover:f,setHover:C}=X(),[g,j]=F("selected"),{selected:v,setSelected:N}=_(),y=l.useRef(!0),w=(e,c)=>{const i=e.target,d=c?[[e.point.x-$,e.point.y-$],[e.point.x+$,e.point.y+$]]:e.point,x=i.queryRenderedFeatures(d).filter(b=>"interactive"in(b.layer.metadata||{}));if(x.length>0)return x[0]},R=e=>{const c=w(e);y.current=!1,h(e.target,c)},k=e=>{const c=w(e,!0);y.current=!1,j(e.target,c,c==null?void 0:c.source)},z=(e,c)=>new Promise(i=>{if(!c)i(void 0);else if(c.properties.cluster)G(e,c).then(d=>i(d.length>0?d[0]:void 0)).catch(()=>{});else{const{id:d,type:x,properties:b,geometry:E}=c;i({id:d,type:x,properties:b,geometry:E})}});l.useLayoutEffect(()=>{y.current||z(t,a==null?void 0:a.feature).then(C)},[t,a]),l.useLayoutEffect(()=>{t&&(y.current&&(f?B(t,f.id).then(e=>h(t,e)):h(t,void 0)),y.current=!0)},[t,f]),l.useLayoutEffect(()=>{y.current||z(t,g==null?void 0:g.feature).then(N)},[t,g]),l.useLayoutEffect(()=>{t&&(y.current&&(v?B(t,v.id).then(e=>j(t,e)):j(t,void 0)),y.current=!0)},[t,v]);const L=e=>{const{layers:c}=e.getStyle()||{};if(!c)console.warn("No base layers loaded");else{const i=c.map(d=>d.id);p.current=new Set(i)}};return l.useEffect(()=>{const e=new A.Map({container:r.current,style:o.style,bounds:o.defaultBounds,hash:"map"});return e.once("styledata",()=>L(e)),e.on("click",k),e.on("mousemove",R),o.disableScrollZoom&&e.scrollZoom.disable(),s(e),()=>{s(void 0),e.off("click",k),e.off("mousemove",R),e.remove()}},[]),l.useEffect(()=>{const e=t==null?void 0:t.getStyle();if(!e)return;const c=i=>{const d=e.layers.filter(u=>!p.current.has(u.id)),x=new Set(d.map(u=>u.id)),b=new Set(d.map(u=>"source"in u&&u.source).filter(Boolean)),E=Object.entries(e.sources).filter(([u,Q])=>b.has(u)),Z={...e,layers:[...i.layers,...e.layers.filter(u=>x.has(u.id))],sources:Object.fromEntries([...Object.entries(i.sources),...E])};p.current=new Set(i.layers.map(u=>u.id)),t.setStyle(Z)};typeof o.style=="string"?fetch(o.style).then(i=>i.json()).then(i=>c(i)):c(o.style)},[o.style]),m.jsx("div",{ref:r,className:o.className?`${o.className} p6o-map-container`:"p6o-map-container",children:t&&m.jsxs(m.Fragment,{children:[o.children,o.popup&&m.jsx(K,{map:t,selected:v,popup:o.popup,onClose:()=>N(void 0)})]})})};export{oe as X,Y as i,ee as k,te as z};
