import{r as v,j as r}from"./iframe-ZimVXjeC.js";import"./index.es28-DBRy2idf.js";import{J as b}from"./index.es33-CKBte7ac.js";import{o as g}from"./index.es35-NGGuPWEW.js";import{_ as a}from"./index-default-C0I3bBxV.js";import{M as p}from"./Message-DRhI_AG0.js";import{I as C}from"./Icon-D86Ecimj.js";import{I as P}from"./Input-26X5zsSc.js";import{i as m}from"./i18n-DkobdbHY.js";import{L as u}from"./ListSession-hS-NIzK1.js";import{T as c}from"./Toaster-B4oQyfpz.js";import{v as I}from"./v4-BKrj-4V8.js";const S="ascending",x="descending",N=D=>class extends v.Component{static defaultProps={filters:{},searchable:!0};pollingInterval;constructor(t){super(t),this.state=this.initializeState(t)}componentDidMount(){this.props.polling&&(this.pollingInterval=setInterval(this.fetchData.bind(this),this.props.polling))}componentDidUpdate(t){t.saved!==this.props.saved&&this.props.saved&&this.setState({saved:this.props.saved},this.fetchData.bind(this)),t.updateItem!==this.props.updateItem&&this.props.updateItem&&this.onUpdateItem(),t.reload!==this.props.reload&&this.props.reload&&this.setState(this.onReload.bind(this),this.fetchData.bind(this))}componentWillUnmount(){this.pollingInterval&&clearInterval(this.pollingInterval)}afterDelete(){return this.state.items.length===1?this.setState(t=>({page:t.page-1>1?t.page-1:1}),this.fetchData.bind(this)):this.fetchData()}afterDeleteAll(){this.setState({page:1},this.fetchData.bind(this))}fetchData(){this.setSession(),this.setState({loading:!0},()=>{const{page:t,perPage:e,search:i,sortColumn:s,sortDirection:o}=this.state,h={...this.state.filters,page:t,search:i,per_page:e,sort_by:s,sort_direction:o};this.props.onLoad(h).then(({data:n})=>{const l=n[this.props.collectionName],{pages:d,count:f}=n.list;this.setState({count:f,items:l,page:t,pages:d,loading:!1})})})}getDefaultFilters(t){const e=[];return t.filters&&t.filters.defaults&&a.each(t.filters.defaults.filters,i=>{const s=a.findWhere(t.filters.props.filters,{key:i.key});s&&e.push(this.onCreateFilter({...s,...i}))}),{filters:e}}initializeState(t){const{key:e,storage:i}=t.session||{},s=u.restoreSession(e,i)||{},o=s.filters||this.getDefaultFilters(t),h=s.page||1,n=s.perPage||t.defaultPerPage||a.first(t.perPageOptions),l=s.search||t.defaultSearch||null,d=s.sortColumn||t.defaultSort||null,f=s.sortDirection||t.defaultSortDirection||null;return{count:0,error:null,filters:o,items:[],loading:!1,page:h,pages:1,perPage:n,saved:t.saved||!1,search:l,sortColumn:d,sortDirection:f}}isFilterActive(){let t=!1;return a.each(a.values(this.state.filters),e=>{b.isEmpty(e)||(t=!0)}),t}onClearSearch(t){this.onSearchChange(t,{value:""}),this.searchRef?.inputRef?.current?.focus(),this.onSearch()}onCreateFilter(t){return{...t,uid:I()}}onDelete(t){return this.props.onDelete?this.props.onDelete(t).then(this.afterDelete.bind(this)).catch(this.onError.bind(this)):Promise.resolve()}onDeleteAll(){return this.props.onDeleteAll?this.props.onDeleteAll().then(this.afterDeleteAll.bind(this)):Promise.resolve()}onError(t){return this.props.resolveErrors&&this.setState({error:t})}onFilterChange(t){return new Promise(e=>{this.props.filters&&this.props.filters.onChange&&this.props.filters.onChange(t),this.setState({filters:t,page:1},()=>{this.fetchData(),e()})})}onInit(t=1){this.setState({sortColumn:"",sortDirection:"",page:t},this.fetchData.bind(this))}onPageChange(t,{activePage:e}){this.setState({page:e},this.fetchData.bind(this))}onPerPageChange(t,{value:e}){this.setState({page:1,perPage:e},this.fetchData.bind(this))}onReload(t){return this.props.onReload?this.props.onReload(t):t}onSave(t){return this.props.onSave?Promise.resolve(this.props.onSave(t)).then(()=>this.setState({saved:!0},this.fetchData.bind(this))):Promise.resolve()}onSearch(){this.setState({page:1},this.fetchData.bind(this))}onSearchChange(t,{value:e}){this.setState({search:e})}onSort(t,e,i=1){let s=e;s||(s=this.state.sortColumn===t&&this.state.sortDirection===S?x:S),this.setState({sortColumn:t,sortDirection:s,page:i},this.fetchData.bind(this))}onUpdateItem(){this.setState(t=>({items:a.map(t.items,e=>e.id!==this.props.updateItem.id?e:this.props.updateItem)}))}render(){const{filters:t={}}=this.props,{component:e,props:i,showLabels:s}=t;return r.jsxs(r.Fragment,{children:[r.jsx(D,{...this.props,count:this.state.count,filters:{active:this.isFilterActive(),component:e,onChange:this.onFilterChange.bind(this),showLabels:s,props:{...i,onCreateFilter:this.onCreateFilter.bind(this),item:this.state.filters}},items:this.state.items,loading:this.state.loading,page:this.state.page,pages:this.state.pages,perPage:this.state.perPage,onDelete:this.onDelete.bind(this),onDeleteAll:this.onDeleteAll.bind(this),onPageChange:this.onPageChange.bind(this),onPerPageChange:this.onPerPageChange.bind(this),onSave:this.onSave.bind(this),onSort:this.onSort.bind(this),onInit:this.onInit.bind(this),renderSearch:this.renderSearch.bind(this),sortColumn:this.state.sortColumn,sortDirection:this.state.sortDirection}),this.state.saved&&r.jsxs(c,{onDismiss:()=>this.setState({saved:!1}),type:c.MessageTypes.positive,children:[r.jsx(p.Header,{content:m.t("Common.messages.save.header")}),r.jsx(p.Content,{content:m.t("Common.messages.save.content")})]}),this.state.error&&r.jsxs(c,{onDismiss:()=>this.setState({error:!1}),timeout:0,type:c.MessageTypes.negative,children:[r.jsx(p.Header,{content:m.t("Common.messages.error.header")}),r.jsx(p.List,{items:this.props.resolveErrors&&this.props.resolveErrors(this.state.error)})]})]})}renderSearch(){return this.props.searchable?r.jsx(P,{"aria-label":"Search",type:"text",icon:r.jsx(C,{link:!a.isEmpty(this.state.search),name:a.isEmpty(this.state.search)?"search":"times",onClick:this.onClearSearch.bind(this)}),input:{"aria-label":"search"},ref:t=>{this.searchRef=t},loading:this.state.loading,onKeyDown:g.clearSearchTimer.bind(this),onKeyUp:g.setSearchTimer.bind(this,this.onSearch.bind(this)),onChange:this.onSearchChange.bind(this),size:"small",value:this.state.search||""}):null}setSession(){const{key:t,storage:e}=this.props.session||{};if(!t)return;const{filters:i,page:s,perPage:o,search:h,sortColumn:n,sortDirection:l}=this.state;u.setSession(t,e,{filters:i,page:s,perPage:o,search:h,sortColumn:n,sortDirection:l})}};export{S,x as a,N as u};
