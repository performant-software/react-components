import{d as S,x as O,e as Z,u as q,h as P,i as f,m as T,j as D,k as H,v as I,s as W,l as X,S as _,F as B,n as A,o as G}from"./peripleo-maplibre.es26-D4QoMT78.js";import{r as l}from"./index-C0dDX-lL.js";const oe=o=>{const{position:s}=o;return S.jsx("div",{className:s?`p6o-controls-container ${s}`:"p6o-controls-container",children:o.children})},se=o=>S.jsx(O,{breakPoint:o.deviceBreakpoint||540,children:S.jsx(Z,{children:S.jsx(q,{children:S.jsx(P,{children:o.children})})})}),J=(o,s)=>{const n=o.getCanvasContainer().querySelector("canvas").getBoundingClientRect();let t=0,r=0;s.left-40<n.left?t=s.left-n.left-40:s.right+40>n.right&&(t=s.right-n.right+40),s.top-40<n.top?r=s.top-n.top-40:s.bottom+40>n.bottom&&(r=s.bottom+40-n.bottom),(t!==0||r!==0)&&o.panBy([t,r])},K=o=>{const{popup:s,...n}=o,{map:t,selected:r}=n,d=l.useRef(null);return l.useEffect(()=>{if(!r)return;const{offsetWidth:a}=d.current,h=()=>{const{coordinates:C}=r.geometry,g=t.project(C),{height:j}=t._container.getBoundingClientRect(),v=d.current.style;v.left=`${g.x-a/2}px`,v.bottom=`${j-g.y}px`},m=()=>h();return t.on("move",m),h(),J(t,d.current.getBoundingClientRect()),()=>{t.off("move",m)}},[r]),f.jsx("div",{ref:d,className:"p6o-popup-container",children:r?s(n):null})},re=()=>{const o=T(),s=n=>()=>{o.easeTo({zoom:o.getZoom()+n})};return f.jsxs("div",{className:"p6o-zoom",children:[f.jsx("button",{className:"p6o-control p6o-control-btn p6o-zoom-in","aria-label":"Zoom in",onClick:s(1),children:f.jsx(D,{size:20})}),f.jsx("button",{className:"p6o-control p6o-control-btn p6o-zoom-out","aria-label":"Zoom out",onClick:s(-1),children:f.jsx(H,{size:20})})]})},F=o=>{const[s,n]=l.useState();return[s,(t,r,d)=>n(a=>{var h;if((r==null?void 0:r.id)===((h=a==null?void 0:a.feature)==null?void 0:h.id))return a;if(a)try{t.setFeatureState({source:a.source,id:a.feature.id},{[o]:!1})}catch{}if(r){const m=d||I(t,r.id);if(m)return t.setFeatureState({source:m,id:r.id},{[o]:!0}),{source:m,feature:r}}})]},$=3,ne=o=>{const s=l.useRef(null),n=l.useContext(W),t=n.map,{setMap:r}=n,d=l.useRef(new Set),[a,h]=F("hover"),{hover:m,setHover:C}=X(),[g,j]=F("selected"),{selected:v,setSelected:E}=_(),y=l.useRef(!0),N=(e,c)=>{const i=e.target,p=c?[[e.point.x-$,e.point.y-$],[e.point.x+$,e.point.y+$]]:e.point,x=i.queryRenderedFeatures(p).filter(b=>"interactive"in(b.layer.metadata||{}));if(x.length>0)return x[0]},w=e=>{const c=N(e);y.current=!1,h(e.target,c)},R=e=>{const c=N(e,!0);y.current=!1,j(e.target,c,c==null?void 0:c.source)},k=(e,c)=>new Promise(i=>{if(!c)i(void 0);else if(c.properties.cluster)G(e,c).then(p=>i(p.length>0?p[0]:void 0)).catch(()=>{});else{const{id:p,type:x,properties:b,geometry:z}=c;i({id:p,type:x,properties:b,geometry:z})}});l.useLayoutEffect(()=>{y.current||k(t,a==null?void 0:a.feature).then(C)},[t,a]),l.useLayoutEffect(()=>{t&&(y.current&&(m?B(t,m.id).then(e=>h(t,e)):h(t,void 0)),y.current=!0)},[t,m]),l.useLayoutEffect(()=>{y.current||k(t,g==null?void 0:g.feature).then(E)},[t,g]),l.useLayoutEffect(()=>{t&&(y.current&&(v?B(t,v.id).then(e=>j(t,e)):j(t,void 0)),y.current=!0)},[t,v]);const L=e=>{const{layers:c}=e.getStyle()||{};if(!c)console.warn("No base layers loaded");else{const i=c.map(p=>p.id);d.current=new Set(i)}};return l.useEffect(()=>{const e=new A.Map({container:s.current,style:o.style,bounds:o.defaultBounds,hash:"map"});return e.once("styledata",()=>L(e)),e.on("click",R),e.on("mousemove",w),o.disableScrollZoom&&e.scrollZoom.disable(),r(e),()=>{r(void 0),e.off("click",R),e.off("mousemove",w),e.remove()}},[]),l.useEffect(()=>{const e=t==null?void 0:t.getStyle();if(!e)return;const c=i=>{const p=e.layers.filter(u=>!d.current.has(u.id)),x=new Set(p.map(u=>u.id)),b=new Set(p.map(u=>"source"in u&&u.source).filter(Boolean)),z=Object.entries(e.sources).filter(([u,Y])=>b.has(u)),M={...e,layers:[...i.layers,...e.layers.filter(u=>x.has(u.id))],sources:Object.fromEntries([...Object.entries(i.sources),...z])};d.current=new Set(i.layers.map(u=>u.id)),t.setStyle(M)};typeof o.style=="string"?fetch(o.style).then(i=>i.json()).then(i=>c(i)):c(o.style)},[o.style]),f.jsx("div",{ref:s,className:o.className?`${o.className} p6o-map-container`:"p6o-map-container",children:t&&f.jsxs(f.Fragment,{children:[o.children,o.popup&&f.jsx(K,{map:t,selected:v,popup:o.popup,onClose:()=>E(void 0)})]})})},Q=8,U={osm:{type:"raster",tiles:["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"&copy; OpenStreetMap Contributors",maxzoom:19}},V=[{id:"osm",type:"raster",source:"osm"}],ce={version:Q,sources:U,layers:V};export{ne as X,oe as i,se as k,ce as m,re as z};
