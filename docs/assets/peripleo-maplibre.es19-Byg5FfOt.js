import{i as C,x as M,m as Z,S as _,a as q,b,c as D,d as H,t as J,e as W,g as A,f as G,C as I,L as O}from"./peripleo-maplibre.es40-DLgvyBLR.js";import{r as c}from"./iframe-ZimVXjeC.js";const X=s=>C.jsx(M,{breakPoint:s.deviceBreakpoint||540,children:C.jsx(Z,{children:C.jsx(_,{children:C.jsx(q,{children:s.children})})})}),K=(s,l)=>{const a=s.getCanvasContainer().querySelector("canvas").getBoundingClientRect();let e=0,u=0;l.left-40<a.left?e=l.left-a.left-40:l.right+40>a.right&&(e=l.right-a.right+40),l.top-40<a.top?u=l.top-a.top-40:l.bottom+40>a.bottom&&(u=l.bottom+40-a.bottom),(e!==0||u!==0)&&s.panBy([e,u])},Q=s=>{const{popup:l,...a}=s,{map:e,selected:u}=a,i=c.useRef(null);return c.useEffect(()=>{if(!u)return;const{offsetWidth:y}=i.current,f=()=>{const{coordinates:p}=u.geometry,E=e.project(p),{height:h}=e._container.getBoundingClientRect(),g=i.current.style;g.left=`${E.x-y/2}px`,g.bottom=`${h-E.y}px`},m=()=>f();return e.on("move",m),f(),K(e,i.current.getBoundingClientRect()),()=>{e.off("move",m)}},[u]),b.jsx("div",{ref:i,className:"p6o-popup-container",children:u?l(a):null})},P=s=>{const[l,a]=c.useState();return[l,(e,u,i,y)=>a(f=>{var m;if(i?.id===((m=f?.feature)==null?void 0:m.id))return f;if(f)try{e.setFeatureState({source:f.source,id:f.feature.id},{[s]:!1})}catch{}if(i){const p=y||D(e,i.id);if(p)return e.setFeatureState({source:p,id:i.id},{[s]:!0}),{event:u,feature:i,source:p}}})]},Y=s=>{const l=c.useRef(null),a=c.useContext(H),e=a.map,{setMap:u,setLoaded:i}=a,y=c.useRef(new Set),[f,m]=P("hover"),{hover:p,setHover:E}=J(),[h,g]=P("selected"),{selection:S,setSelection:L}=W(),x=c.useRef(!0),$=c.useRef(!0),v=o=>{const r=O(o);x.current=!1,m(o.target,o,r)},F=o=>{x.current=!1,m(o.target,o,void 0)},N=o=>{const r=O(o,!0);$.current=!1,g(o.target,o,r,r?.source)},k=(o,r)=>new Promise(n=>{if(!r)n(void 0);else if(r.properties.cluster)I(o,r).then(d=>n({mapFeature:r,resolved:d.length===1?d[0]:d.length>1?d:void 0})).catch(()=>{});else{const{id:d,type:j,properties:R,geometry:w}=r;n({mapFeature:r,resolved:{id:d,type:j,properties:R,geometry:w}})}});c.useLayoutEffect(()=>{x.current||k(e,f?.feature).then(o=>{E(o?{mapFeature:o.mapFeature,hovered:o.resolved,mapEvent:f.event}:void 0)})},[e,f]),c.useLayoutEffect(()=>{if(e){if(x.current)if(p){const o=Array.isArray(p.hovered)?p.hovered[0]:p.hovered;o&&A(e,o.id).then(r=>m(e,void 0,r))}else m(e);x.current=!0}},[e,p]),c.useLayoutEffect(()=>{$.current||k(e,h?.feature).then(o=>L(o?{mapFeature:o.mapFeature,selected:o.resolved,mapEvent:h.event}:void 0))},[e,h]),c.useLayoutEffect(()=>{if(e){if($.current)if(S){const o=Array.isArray(S.selected)?S.selected[0]:S.selected;o&&A(e,o.id).then(r=>g(e,void 0,r))}else g(e,void 0);$.current=!0}},[e,S]);const z=o=>{const{layers:r}=o.getStyle()||{};if(r){const n=r.map(d=>d.id);y.current=new Set(n)}};return c.useEffect(()=>{const{bounds:o,children:r,className:n,defaultBounds:d,disableScrollZoom:j,lang:R,popup:w,...B}=s,t=new G.Map({...B,container:l.current,bounds:d,hash:B.hash||"map"});return u(t),s.style||i(!0),t.once("load",()=>i(!0)),t.once("styledata",()=>z(t)),t.on("click",N),t.on("mousemove",v),t.on("mouseout",F),t.on("mouseleave",F),t.on("move",v),t.on("zoom",v),t.on("rotate",v),t.on("pitch",v),j&&t.scrollZoom.disable(),()=>{u(void 0),t.off("click",N),t.off("mousemove",v),t.off("mouseout",F),t.off("mouseleave",F),t.off("move",v),t.off("zoom",v),t.off("rotate",v),t.off("pitch",v),t.loaded()||!t.style?t.remove():t.on("load",()=>t.remove())}},[]),c.useEffect(()=>{const o=e?.getStyle();if(!o)return;const r=n=>{const d=o.layers.filter(t=>!y.current.has(t.id)),j=new Set(d.map(t=>t.id)),R=new Set(d.map(t=>"source"in t&&t.source).filter(Boolean)),w=Object.entries(o.sources).filter(([t,T])=>R.has(t)),B={...o,layers:[...n.layers,...o.layers.filter(t=>j.has(t.id))],sources:Object.fromEntries([...Object.entries(n.sources),...w])};y.current=new Set(n.layers.map(t=>t.id)),e.setStyle(B)};typeof s.style=="string"?fetch(s.style).then(n=>n.json()).then(n=>r(n)):r(s.style)},[s.style]),c.useEffect(()=>{var o;if(!s.lang||!(e!=null&&e.style))return;const r=()=>e.getStyle().layers.forEach(n=>{n.layout&&n.layout["text-field"]&&e.setLayoutProperty(n.id,"text-field",["get",`name:${s.lang}`])});(o=e.getStyle())!=null&&o.layers?r():e.once("styledata",r)},[e,s.lang]),b.jsx("div",{ref:l,className:s.className?`${s.className} p6o-map-container`:"p6o-map-container",children:e&&b.jsxs(b.Fragment,{children:[s.children,s.popup&&b.jsx(Q,{map:e,selected:h?.feature,popup:s.popup,onClose:()=>L(void 0)})]})})};export{Y as t,X as v};
