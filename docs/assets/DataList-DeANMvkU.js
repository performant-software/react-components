var P=Object.defineProperty;var x=(n,r,h)=>r in n?P(n,r,{enumerable:!0,configurable:!0,writable:!0,value:h}):n[r]=h;var S=(n,r,h)=>(x(n,typeof r!="symbol"?r+"":r,h),h);import{j as a}from"./jsx-runtime-D9TvR9R2.js";import{u as v}from"./index.es33-R8Sn8jra.js";import{r as y}from"./index-C0dDX-lL.js";import{B as I}from"./index.es31-BEPK4q4Q.js";import{u as E}from"./uuid-BH6G0oTz.js";import{_ as o}from"./index-default-C_maRo4o.js";import{M as g}from"./Message-smmiVK7n.js";import{I as j}from"./Icon-C_3d7-zE.js";import{I as A}from"./Input-Bwh_HEb3.js";import{i as D}from"./i18n-C9xJ7SCg.js";import{L as C}from"./ListSession-hS-NIzK1.js";import{T as d}from"./Toaster-gMCa2mDU.js";const b="ascending",F="descending",T=n=>{var r;return r=class extends y.Component{constructor(t){super(t);S(this,"pollingInterval");this.state=this.initializeState(t)}componentDidMount(){this.props.polling&&(this.pollingInterval=setInterval(this.fetchData.bind(this),this.props.polling))}componentDidUpdate(t){t.saved!==this.props.saved&&this.props.saved&&this.setState({saved:this.props.saved},this.fetchData.bind(this))}componentWillUnmount(){this.pollingInterval&&clearInterval(this.pollingInterval)}afterDelete(){return this.state.items.length===1?this.setState(t=>({page:t.page-1>1?t.page-1:1}),this.fetchData.bind(this)):this.fetchData()}afterDeleteAll(){this.setState({page:1},this.fetchData.bind(this))}fetchData(){this.setSession(),this.setState({loading:!0},()=>{const{page:t,perPage:e,search:i,sortColumn:s,sortDirection:c}=this.state,p={...this.state.filters,page:t,search:i,per_page:e,sort_by:s,sort_direction:c};this.props.onLoad(p).then(({data:l})=>{const f=l[this.props.collectionName],{pages:m,count:u}=l.list;this.setState({count:u,items:f,page:t,pages:m,loading:!1})})})}getDefaultFilters(t){const e=[];return t.filters&&t.filters.defaults&&o.each(t.filters.defaults.filters,i=>{const s=o.findWhere(t.filters.props.filters,{key:i.key});s&&e.push(this.onCreateFilter({...s,...i}))}),{filters:e}}initializeState(t){const{key:e,storage:i}=t.session||{},s=C.restoreSession(e,i)||{},c=s.filters||this.getDefaultFilters(t),p=s.page||1,l=s.perPage||t.defaultPerPage||o.first(t.perPageOptions),f=s.search||t.defaultSearch||null,m=s.sortColumn||t.defaultSort||null,u=s.sortDirection||t.defaultSortDirection||null;return{count:0,error:null,filters:c,items:[],loading:!1,page:p,pages:1,perPage:l,saved:t.saved||!1,search:f,sortColumn:m,sortDirection:u}}isFilterActive(){let t=!1;return o.each(o.values(this.state.filters),e=>{I.isEmpty(e)||(t=!0)}),t}onClearSearch(t){var e,i,s;this.onSearchChange(t,{value:""}),(s=(i=(e=this.searchRef)==null?void 0:e.inputRef)==null?void 0:i.current)==null||s.focus(),this.onSearch()}onCreateFilter(t){return{...t,uid:E()}}onDelete(t){return this.props.onDelete?this.props.onDelete(t).then(this.afterDelete.bind(this)).catch(this.onError.bind(this)):Promise.resolve()}onDeleteAll(){return this.props.onDeleteAll?this.props.onDeleteAll().then(this.afterDeleteAll.bind(this)):Promise.resolve()}onError(t){return this.props.resolveErrors&&this.setState({error:t})}onFilterChange(t){return new Promise(e=>{this.props.filters&&this.props.filters.onChange&&this.props.filters.onChange(t),this.setState({filters:t,page:1},()=>{this.fetchData(),e()})})}onInit(t=1){this.setState({sortColumn:"",sortDirection:"",page:t},this.fetchData.bind(this))}onPageChange(t,{activePage:e}){this.setState({page:e},this.fetchData.bind(this))}onPerPageChange(t,{value:e}){this.setState({perPage:e},this.fetchData.bind(this))}onSave(t){return this.props.onSave?Promise.resolve(this.props.onSave(t)).then(()=>this.setState({saved:!0},this.fetchData.bind(this))):Promise.resolve()}onSearch(){this.setState({page:1},this.fetchData.bind(this))}onSearchChange(t,{value:e}){this.setState({search:e})}onSort(t,e,i=1){let s=e;s||(s=this.state.sortColumn===t&&this.state.sortDirection===b?F:b),this.setState({sortColumn:t,sortDirection:s,page:i},this.fetchData.bind(this))}render(){const{filters:t={}}=this.props,{component:e,props:i,showLabels:s}=t;return a.jsxs(a.Fragment,{children:[a.jsx(n,{...this.props,count:this.state.count,filters:{active:this.isFilterActive(),component:e,onChange:this.onFilterChange.bind(this),showLabels:s,props:{...i,onCreateFilter:this.onCreateFilter.bind(this),item:this.state.filters}},items:this.state.items,loading:this.state.loading,page:this.state.page,pages:this.state.pages,perPage:this.state.perPage,onDelete:this.onDelete.bind(this),onDeleteAll:this.onDeleteAll.bind(this),onPageChange:this.onPageChange.bind(this),onPerPageChange:this.onPerPageChange.bind(this),onSave:this.onSave.bind(this),onSort:this.onSort.bind(this),onInit:this.onInit.bind(this),renderSearch:this.renderSearch.bind(this),sortColumn:this.state.sortColumn,sortDirection:this.state.sortDirection}),this.state.saved&&a.jsxs(d,{onDismiss:()=>this.setState({saved:!1}),type:d.MessageTypes.positive,children:[a.jsx(g.Header,{content:D.t("Common.messages.save.header")}),a.jsx(g.Content,{content:D.t("Common.messages.save.content")})]}),this.state.error&&a.jsxs(d,{onDismiss:()=>this.setState({error:!1}),timeout:0,type:d.MessageTypes.negative,children:[a.jsx(g.Header,{content:D.t("Common.messages.error.header")}),a.jsx(g.List,{items:this.props.resolveErrors&&this.props.resolveErrors(this.state.error)})]})]})}renderSearch(){return this.props.searchable?a.jsx(A,{"aria-label":"Search",type:"text",icon:a.jsx(j,{link:!o.isEmpty(this.state.search),name:o.isEmpty(this.state.search)?"search":"times",onClick:this.onClearSearch.bind(this)}),input:{"aria-label":"search"},ref:t=>{this.searchRef=t},loading:this.state.loading,onKeyDown:v.clearSearchTimer.bind(this),onKeyUp:v.setSearchTimer.bind(this,this.onSearch.bind(this)),onChange:this.onSearchChange.bind(this),size:"small",value:this.state.search}):null}setSession(){const{key:t,storage:e}=this.props.session||{};if(!t)return;const{filters:i,page:s,perPage:c,search:p,sortColumn:l,sortDirection:f}=this.state;C.setSession(t,e,{filters:i,page:s,perPage:c,search:p,sortColumn:l,sortDirection:f})}},S(r,"defaultProps",{filters:{},searchable:!0}),r},W=T;export{b as S,F as a,W as u};
