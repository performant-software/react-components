/*! For license information please see 2927.108f11b7.iframe.bundle.js.LICENSE.txt */
(self.webpackChunk_performant_software_storybook=self.webpackChunk_performant_software_storybook||[]).push([[2927],{"../../node_modules/@floating-ui/core/dist/floating-ui.core.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Cp:()=>hide,RR:()=>flip,cv:()=>offset,dp:()=>size,dr:()=>limitShift,oo:()=>computePosition,uY:()=>shift,x7:()=>arrow});var _floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/@floating-ui/utils/dist/floating-ui.utils.mjs");function computeCoordsFromPlacement(_ref,placement,rtl){let{reference,floating}=_ref;const sideAxis=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Qq)(placement),alignmentAxis=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Wh)(placement),alignLength=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.I4)(alignmentAxis),side=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.k3)(placement),isVertical="y"===sideAxis,commonX=reference.x+reference.width/2-floating.width/2,commonY=reference.y+reference.height/2-floating.height/2,commonAlign=reference[alignLength]/2-floating[alignLength]/2;let coords;switch(side){case"top":coords={x:commonX,y:reference.y-floating.height};break;case"bottom":coords={x:commonX,y:reference.y+reference.height};break;case"right":coords={x:reference.x+reference.width,y:commonY};break;case"left":coords={x:reference.x-floating.width,y:commonY};break;default:coords={x:reference.x,y:reference.y}}switch((0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.hp)(placement)){case"start":coords[alignmentAxis]-=commonAlign*(rtl&&isVertical?-1:1);break;case"end":coords[alignmentAxis]+=commonAlign*(rtl&&isVertical?-1:1)}return coords}const computePosition=async(reference,floating,config)=>{const{placement="bottom",strategy="absolute",middleware=[],platform}=config,validMiddleware=middleware.filter(Boolean),rtl=await(null==platform.isRTL?void 0:platform.isRTL(floating));let rects=await platform.getElementRects({reference,floating,strategy}),{x,y}=computeCoordsFromPlacement(rects,placement,rtl),statefulPlacement=placement,middlewareData={},resetCount=0;for(let i=0;i<validMiddleware.length;i++){const{name,fn}=validMiddleware[i],{x:nextX,y:nextY,data,reset}=await fn({x,y,initialPlacement:placement,placement:statefulPlacement,strategy,middlewareData,rects,platform,elements:{reference,floating}});x=null!=nextX?nextX:x,y=null!=nextY?nextY:y,middlewareData={...middlewareData,[name]:{...middlewareData[name],...data}},reset&&resetCount<=50&&(resetCount++,"object"==typeof reset&&(reset.placement&&(statefulPlacement=reset.placement),reset.rects&&(rects=!0===reset.rects?await platform.getElementRects({reference,floating,strategy}):reset.rects),({x,y}=computeCoordsFromPlacement(rects,statefulPlacement,rtl))),i=-1)}return{x,y,placement:statefulPlacement,strategy,middlewareData}};async function detectOverflow(state,options){var _await$platform$isEle;void 0===options&&(options={});const{x,y,platform,rects,elements,strategy}=state,{boundary="clippingAncestors",rootBoundary="viewport",elementContext="floating",altBoundary=!1,padding=0}=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state),paddingObject=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.yd)(padding),element=elements[altBoundary?"floating"===elementContext?"reference":"floating":elementContext],clippingClientRect=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.JB)(await platform.getClippingRect({element:null==(_await$platform$isEle=await(null==platform.isElement?void 0:platform.isElement(element)))||_await$platform$isEle?element:element.contextElement||await(null==platform.getDocumentElement?void 0:platform.getDocumentElement(elements.floating)),boundary,rootBoundary,strategy})),rect="floating"===elementContext?{...rects.floating,x,y}:rects.reference,offsetParent=await(null==platform.getOffsetParent?void 0:platform.getOffsetParent(elements.floating)),offsetScale=await(null==platform.isElement?void 0:platform.isElement(offsetParent))&&await(null==platform.getScale?void 0:platform.getScale(offsetParent))||{x:1,y:1},elementClientRect=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.JB)(platform.convertOffsetParentRelativeRectToViewportRelativeRect?await platform.convertOffsetParentRelativeRectToViewportRelativeRect({elements,rect,offsetParent,strategy}):rect);return{top:(clippingClientRect.top-elementClientRect.top+paddingObject.top)/offsetScale.y,bottom:(elementClientRect.bottom-clippingClientRect.bottom+paddingObject.bottom)/offsetScale.y,left:(clippingClientRect.left-elementClientRect.left+paddingObject.left)/offsetScale.x,right:(elementClientRect.right-clippingClientRect.right+paddingObject.right)/offsetScale.x}}const arrow=options=>({name:"arrow",options,async fn(state){const{x,y,placement,rects,platform,elements,middlewareData}=state,{element,padding=0}=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state)||{};if(null==element)return{};const paddingObject=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.yd)(padding),coords={x,y},axis=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Wh)(placement),length=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.I4)(axis),arrowDimensions=await platform.getDimensions(element),isYAxis="y"===axis,minProp=isYAxis?"top":"left",maxProp=isYAxis?"bottom":"right",clientProp=isYAxis?"clientHeight":"clientWidth",endDiff=rects.reference[length]+rects.reference[axis]-coords[axis]-rects.floating[length],startDiff=coords[axis]-rects.reference[axis],arrowOffsetParent=await(null==platform.getOffsetParent?void 0:platform.getOffsetParent(element));let clientSize=arrowOffsetParent?arrowOffsetParent[clientProp]:0;clientSize&&await(null==platform.isElement?void 0:platform.isElement(arrowOffsetParent))||(clientSize=elements.floating[clientProp]||rects.floating[length]);const centerToReference=endDiff/2-startDiff/2,largestPossiblePadding=clientSize/2-arrowDimensions[length]/2-1,minPadding=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.VV)(paddingObject[minProp],largestPossiblePadding),maxPadding=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.VV)(paddingObject[maxProp],largestPossiblePadding),min$1=minPadding,max=clientSize-arrowDimensions[length]-maxPadding,center=clientSize/2-arrowDimensions[length]/2+centerToReference,offset=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.uZ)(min$1,center,max),shouldAddOffset=!middlewareData.arrow&&null!=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.hp)(placement)&&center!==offset&&rects.reference[length]/2-(center<min$1?minPadding:maxPadding)-arrowDimensions[length]/2<0,alignmentOffset=shouldAddOffset?center<min$1?center-min$1:center-max:0;return{[axis]:coords[axis]+alignmentOffset,data:{[axis]:offset,centerOffset:center-offset-alignmentOffset,...shouldAddOffset&&{alignmentOffset}},reset:shouldAddOffset}}});const flip=function(options){return void 0===options&&(options={}),{name:"flip",options,async fn(state){var _middlewareData$arrow,_middlewareData$flip;const{placement,middlewareData,rects,initialPlacement,platform,elements}=state,{mainAxis:checkMainAxis=!0,crossAxis:checkCrossAxis=!0,fallbackPlacements:specifiedFallbackPlacements,fallbackStrategy="bestFit",fallbackAxisSideDirection="none",flipAlignment=!0,...detectOverflowOptions}=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state);if(null!=(_middlewareData$arrow=middlewareData.arrow)&&_middlewareData$arrow.alignmentOffset)return{};const side=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.k3)(placement),isBasePlacement=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.k3)(initialPlacement)===initialPlacement,rtl=await(null==platform.isRTL?void 0:platform.isRTL(elements.floating)),fallbackPlacements=specifiedFallbackPlacements||(isBasePlacement||!flipAlignment?[(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.pw)(initialPlacement)]:(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.gy)(initialPlacement));specifiedFallbackPlacements||"none"===fallbackAxisSideDirection||fallbackPlacements.push(...(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.KX)(initialPlacement,flipAlignment,fallbackAxisSideDirection,rtl));const placements=[initialPlacement,...fallbackPlacements],overflow=await detectOverflow(state,detectOverflowOptions),overflows=[];let overflowsData=(null==(_middlewareData$flip=middlewareData.flip)?void 0:_middlewareData$flip.overflows)||[];if(checkMainAxis&&overflows.push(overflow[side]),checkCrossAxis){const sides=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.i8)(placement,rects,rtl);overflows.push(overflow[sides[0]],overflow[sides[1]])}if(overflowsData=[...overflowsData,{placement,overflows}],!overflows.every((side=>side<=0))){var _middlewareData$flip2,_overflowsData$filter;const nextIndex=((null==(_middlewareData$flip2=middlewareData.flip)?void 0:_middlewareData$flip2.index)||0)+1,nextPlacement=placements[nextIndex];if(nextPlacement)return{data:{index:nextIndex,overflows:overflowsData},reset:{placement:nextPlacement}};let resetPlacement=null==(_overflowsData$filter=overflowsData.filter((d=>d.overflows[0]<=0)).sort(((a,b)=>a.overflows[1]-b.overflows[1]))[0])?void 0:_overflowsData$filter.placement;if(!resetPlacement)switch(fallbackStrategy){case"bestFit":{var _overflowsData$map$so;const placement=null==(_overflowsData$map$so=overflowsData.map((d=>[d.placement,d.overflows.filter((overflow=>overflow>0)).reduce(((acc,overflow)=>acc+overflow),0)])).sort(((a,b)=>a[1]-b[1]))[0])?void 0:_overflowsData$map$so[0];placement&&(resetPlacement=placement);break}case"initialPlacement":resetPlacement=initialPlacement}if(placement!==resetPlacement)return{reset:{placement:resetPlacement}}}return{}}}};function getSideOffsets(overflow,rect){return{top:overflow.top-rect.height,right:overflow.right-rect.width,bottom:overflow.bottom-rect.height,left:overflow.left-rect.width}}function isAnySideFullyClipped(overflow){return _floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.mA.some((side=>overflow[side]>=0))}const hide=function(options){return void 0===options&&(options={}),{name:"hide",options,async fn(state){const{rects}=state,{strategy="referenceHidden",...detectOverflowOptions}=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state);switch(strategy){case"referenceHidden":{const offsets=getSideOffsets(await detectOverflow(state,{...detectOverflowOptions,elementContext:"reference"}),rects.reference);return{data:{referenceHiddenOffsets:offsets,referenceHidden:isAnySideFullyClipped(offsets)}}}case"escaped":{const offsets=getSideOffsets(await detectOverflow(state,{...detectOverflowOptions,altBoundary:!0}),rects.floating);return{data:{escapedOffsets:offsets,escaped:isAnySideFullyClipped(offsets)}}}default:return{}}}}};const offset=function(options){return void 0===options&&(options=0),{name:"offset",options,async fn(state){var _middlewareData$offse,_middlewareData$arrow;const{x,y,placement,middlewareData}=state,diffCoords=await async function convertValueToCoords(state,options){const{placement,platform,elements}=state,rtl=await(null==platform.isRTL?void 0:platform.isRTL(elements.floating)),side=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.k3)(placement),alignment=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.hp)(placement),isVertical="y"===(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Qq)(placement),mainAxisMulti=["left","top"].includes(side)?-1:1,crossAxisMulti=rtl&&isVertical?-1:1,rawValue=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state);let{mainAxis,crossAxis,alignmentAxis}="number"==typeof rawValue?{mainAxis:rawValue,crossAxis:0,alignmentAxis:null}:{mainAxis:0,crossAxis:0,alignmentAxis:null,...rawValue};return alignment&&"number"==typeof alignmentAxis&&(crossAxis="end"===alignment?-1*alignmentAxis:alignmentAxis),isVertical?{x:crossAxis*crossAxisMulti,y:mainAxis*mainAxisMulti}:{x:mainAxis*mainAxisMulti,y:crossAxis*crossAxisMulti}}(state,options);return placement===(null==(_middlewareData$offse=middlewareData.offset)?void 0:_middlewareData$offse.placement)&&null!=(_middlewareData$arrow=middlewareData.arrow)&&_middlewareData$arrow.alignmentOffset?{}:{x:x+diffCoords.x,y:y+diffCoords.y,data:{...diffCoords,placement}}}}},shift=function(options){return void 0===options&&(options={}),{name:"shift",options,async fn(state){const{x,y,placement}=state,{mainAxis:checkMainAxis=!0,crossAxis:checkCrossAxis=!1,limiter={fn:_ref=>{let{x,y}=_ref;return{x,y}}},...detectOverflowOptions}=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state),coords={x,y},overflow=await detectOverflow(state,detectOverflowOptions),crossAxis=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Qq)((0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.k3)(placement)),mainAxis=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Rn)(crossAxis);let mainAxisCoord=coords[mainAxis],crossAxisCoord=coords[crossAxis];if(checkMainAxis){const maxSide="y"===mainAxis?"bottom":"right",min=mainAxisCoord+overflow["y"===mainAxis?"top":"left"],max=mainAxisCoord-overflow[maxSide];mainAxisCoord=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.uZ)(min,mainAxisCoord,max)}if(checkCrossAxis){const maxSide="y"===crossAxis?"bottom":"right",min=crossAxisCoord+overflow["y"===crossAxis?"top":"left"],max=crossAxisCoord-overflow[maxSide];crossAxisCoord=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.uZ)(min,crossAxisCoord,max)}const limitedCoords=limiter.fn({...state,[mainAxis]:mainAxisCoord,[crossAxis]:crossAxisCoord});return{...limitedCoords,data:{x:limitedCoords.x-x,y:limitedCoords.y-y}}}}},limitShift=function(options){return void 0===options&&(options={}),{options,fn(state){const{x,y,placement,rects,middlewareData}=state,{offset=0,mainAxis:checkMainAxis=!0,crossAxis:checkCrossAxis=!0}=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state),coords={x,y},crossAxis=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Qq)(placement),mainAxis=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Rn)(crossAxis);let mainAxisCoord=coords[mainAxis],crossAxisCoord=coords[crossAxis];const rawOffset=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(offset,state),computedOffset="number"==typeof rawOffset?{mainAxis:rawOffset,crossAxis:0}:{mainAxis:0,crossAxis:0,...rawOffset};if(checkMainAxis){const len="y"===mainAxis?"height":"width",limitMin=rects.reference[mainAxis]-rects.floating[len]+computedOffset.mainAxis,limitMax=rects.reference[mainAxis]+rects.reference[len]-computedOffset.mainAxis;mainAxisCoord<limitMin?mainAxisCoord=limitMin:mainAxisCoord>limitMax&&(mainAxisCoord=limitMax)}if(checkCrossAxis){var _middlewareData$offse,_middlewareData$offse2;const len="y"===mainAxis?"width":"height",isOriginSide=["top","left"].includes((0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.k3)(placement)),limitMin=rects.reference[crossAxis]-rects.floating[len]+(isOriginSide&&(null==(_middlewareData$offse=middlewareData.offset)?void 0:_middlewareData$offse[crossAxis])||0)+(isOriginSide?0:computedOffset.crossAxis),limitMax=rects.reference[crossAxis]+rects.reference[len]+(isOriginSide?0:(null==(_middlewareData$offse2=middlewareData.offset)?void 0:_middlewareData$offse2[crossAxis])||0)-(isOriginSide?computedOffset.crossAxis:0);crossAxisCoord<limitMin?crossAxisCoord=limitMin:crossAxisCoord>limitMax&&(crossAxisCoord=limitMax)}return{[mainAxis]:mainAxisCoord,[crossAxis]:crossAxisCoord}}}},size=function(options){return void 0===options&&(options={}),{name:"size",options,async fn(state){const{placement,rects,platform,elements}=state,{apply=()=>{},...detectOverflowOptions}=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.ku)(options,state),overflow=await detectOverflow(state,detectOverflowOptions),side=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.k3)(placement),alignment=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.hp)(placement),isYAxis="y"===(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Qq)(placement),{width,height}=rects.floating;let heightSide,widthSide;"top"===side||"bottom"===side?(heightSide=side,widthSide=alignment===(await(null==platform.isRTL?void 0:platform.isRTL(elements.floating))?"start":"end")?"left":"right"):(widthSide=side,heightSide="end"===alignment?"top":"bottom");const overflowAvailableHeight=height-overflow[heightSide],overflowAvailableWidth=width-overflow[widthSide],noShift=!state.middlewareData.shift;let availableHeight=overflowAvailableHeight,availableWidth=overflowAvailableWidth;if(isYAxis){const maximumClippingWidth=width-overflow.left-overflow.right;availableWidth=alignment||noShift?(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.VV)(overflowAvailableWidth,maximumClippingWidth):maximumClippingWidth}else{const maximumClippingHeight=height-overflow.top-overflow.bottom;availableHeight=alignment||noShift?(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.VV)(overflowAvailableHeight,maximumClippingHeight):maximumClippingHeight}if(noShift&&!alignment){const xMin=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Fp)(overflow.left,0),xMax=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Fp)(overflow.right,0),yMin=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Fp)(overflow.top,0),yMax=(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Fp)(overflow.bottom,0);isYAxis?availableWidth=width-2*(0!==xMin||0!==xMax?xMin+xMax:(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Fp)(overflow.left,overflow.right)):availableHeight=height-2*(0!==yMin||0!==yMax?yMin+yMax:(0,_floating_ui_utils__WEBPACK_IMPORTED_MODULE_0__.Fp)(overflow.top,overflow.bottom))}await apply({...state,availableWidth,availableHeight});const nextDimensions=await platform.getDimensions(elements.floating);return width!==nextDimensions.width||height!==nextDimensions.height?{reset:{rects:!0}}:{}}}}},"../../node_modules/@floating-ui/dom/dist/floating-ui.dom.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{x7:()=>arrow,Me:()=>autoUpdate,oo:()=>computePosition,RR:()=>flip,Cp:()=>hide,dr:()=>limitShift,uY:()=>shift,dp:()=>size});var floating_ui_utils=__webpack_require__("../../node_modules/@floating-ui/utils/dist/floating-ui.utils.mjs"),floating_ui_core=__webpack_require__("../../node_modules/@floating-ui/core/dist/floating-ui.core.mjs");function getNodeName(node){return isNode(node)?(node.nodeName||"").toLowerCase():"#document"}function getWindow(node){var _node$ownerDocument;return(null==node||null==(_node$ownerDocument=node.ownerDocument)?void 0:_node$ownerDocument.defaultView)||window}function getDocumentElement(node){var _ref;return null==(_ref=(isNode(node)?node.ownerDocument:node.document)||window.document)?void 0:_ref.documentElement}function isNode(value){return value instanceof Node||value instanceof getWindow(value).Node}function isElement(value){return value instanceof Element||value instanceof getWindow(value).Element}function isHTMLElement(value){return value instanceof HTMLElement||value instanceof getWindow(value).HTMLElement}function isShadowRoot(value){return"undefined"!=typeof ShadowRoot&&(value instanceof ShadowRoot||value instanceof getWindow(value).ShadowRoot)}function isOverflowElement(element){const{overflow,overflowX,overflowY,display}=getComputedStyle(element);return/auto|scroll|overlay|hidden|clip/.test(overflow+overflowY+overflowX)&&!["inline","contents"].includes(display)}function isTableElement(element){return["table","td","th"].includes(getNodeName(element))}function isContainingBlock(element){const webkit=isWebKit(),css=getComputedStyle(element);return"none"!==css.transform||"none"!==css.perspective||!!css.containerType&&"normal"!==css.containerType||!webkit&&!!css.backdropFilter&&"none"!==css.backdropFilter||!webkit&&!!css.filter&&"none"!==css.filter||["transform","perspective","filter"].some((value=>(css.willChange||"").includes(value)))||["paint","layout","strict","content"].some((value=>(css.contain||"").includes(value)))}function getContainingBlock(element){let currentNode=getParentNode(element);for(;isHTMLElement(currentNode)&&!isLastTraversableNode(currentNode);){if(isContainingBlock(currentNode))return currentNode;currentNode=getParentNode(currentNode)}return null}function isWebKit(){return!("undefined"==typeof CSS||!CSS.supports)&&CSS.supports("-webkit-backdrop-filter","none")}function isLastTraversableNode(node){return["html","body","#document"].includes(getNodeName(node))}function getComputedStyle(element){return getWindow(element).getComputedStyle(element)}function getNodeScroll(element){return isElement(element)?{scrollLeft:element.scrollLeft,scrollTop:element.scrollTop}:{scrollLeft:element.pageXOffset,scrollTop:element.pageYOffset}}function getParentNode(node){if("html"===getNodeName(node))return node;const result=node.assignedSlot||node.parentNode||isShadowRoot(node)&&node.host||getDocumentElement(node);return isShadowRoot(result)?result.host:result}function getNearestOverflowAncestor(node){const parentNode=getParentNode(node);return isLastTraversableNode(parentNode)?node.ownerDocument?node.ownerDocument.body:node.body:isHTMLElement(parentNode)&&isOverflowElement(parentNode)?parentNode:getNearestOverflowAncestor(parentNode)}function getOverflowAncestors(node,list,traverseIframes){var _node$ownerDocument2;void 0===list&&(list=[]),void 0===traverseIframes&&(traverseIframes=!0);const scrollableAncestor=getNearestOverflowAncestor(node),isBody=scrollableAncestor===(null==(_node$ownerDocument2=node.ownerDocument)?void 0:_node$ownerDocument2.body),win=getWindow(scrollableAncestor);return isBody?list.concat(win,win.visualViewport||[],isOverflowElement(scrollableAncestor)?scrollableAncestor:[],win.frameElement&&traverseIframes?getOverflowAncestors(win.frameElement):[]):list.concat(scrollableAncestor,getOverflowAncestors(scrollableAncestor,[],traverseIframes))}function getCssDimensions(element){const css=getComputedStyle(element);let width=parseFloat(css.width)||0,height=parseFloat(css.height)||0;const hasOffset=isHTMLElement(element),offsetWidth=hasOffset?element.offsetWidth:width,offsetHeight=hasOffset?element.offsetHeight:height,shouldFallback=(0,floating_ui_utils.NM)(width)!==offsetWidth||(0,floating_ui_utils.NM)(height)!==offsetHeight;return shouldFallback&&(width=offsetWidth,height=offsetHeight),{width,height,$:shouldFallback}}function unwrapElement(element){return isElement(element)?element:element.contextElement}function getScale(element){const domElement=unwrapElement(element);if(!isHTMLElement(domElement))return(0,floating_ui_utils.ze)(1);const rect=domElement.getBoundingClientRect(),{width,height,$}=getCssDimensions(domElement);let x=($?(0,floating_ui_utils.NM)(rect.width):rect.width)/width,y=($?(0,floating_ui_utils.NM)(rect.height):rect.height)/height;return x&&Number.isFinite(x)||(x=1),y&&Number.isFinite(y)||(y=1),{x,y}}const noOffsets=(0,floating_ui_utils.ze)(0);function getVisualOffsets(element){const win=getWindow(element);return isWebKit()&&win.visualViewport?{x:win.visualViewport.offsetLeft,y:win.visualViewport.offsetTop}:noOffsets}function getBoundingClientRect(element,includeScale,isFixedStrategy,offsetParent){void 0===includeScale&&(includeScale=!1),void 0===isFixedStrategy&&(isFixedStrategy=!1);const clientRect=element.getBoundingClientRect(),domElement=unwrapElement(element);let scale=(0,floating_ui_utils.ze)(1);includeScale&&(offsetParent?isElement(offsetParent)&&(scale=getScale(offsetParent)):scale=getScale(element));const visualOffsets=function shouldAddVisualOffsets(element,isFixed,floatingOffsetParent){return void 0===isFixed&&(isFixed=!1),!(!floatingOffsetParent||isFixed&&floatingOffsetParent!==getWindow(element))&&isFixed}(domElement,isFixedStrategy,offsetParent)?getVisualOffsets(domElement):(0,floating_ui_utils.ze)(0);let x=(clientRect.left+visualOffsets.x)/scale.x,y=(clientRect.top+visualOffsets.y)/scale.y,width=clientRect.width/scale.x,height=clientRect.height/scale.y;if(domElement){const win=getWindow(domElement),offsetWin=offsetParent&&isElement(offsetParent)?getWindow(offsetParent):offsetParent;let currentIFrame=win.frameElement;for(;currentIFrame&&offsetParent&&offsetWin!==win;){const iframeScale=getScale(currentIFrame),iframeRect=currentIFrame.getBoundingClientRect(),css=getComputedStyle(currentIFrame),left=iframeRect.left+(currentIFrame.clientLeft+parseFloat(css.paddingLeft))*iframeScale.x,top=iframeRect.top+(currentIFrame.clientTop+parseFloat(css.paddingTop))*iframeScale.y;x*=iframeScale.x,y*=iframeScale.y,width*=iframeScale.x,height*=iframeScale.y,x+=left,y+=top,currentIFrame=getWindow(currentIFrame).frameElement}}return(0,floating_ui_utils.JB)({width,height,x,y})}const topLayerSelectors=[":popover-open",":modal"];function topLayer(floating){let isTopLayer=!1,x=0,y=0;if(topLayerSelectors.forEach((selector=>{!function setIsTopLayer(selector){try{isTopLayer=isTopLayer||floating.matches(selector)}catch(e){}}(selector)})),isTopLayer){const containingBlock=getContainingBlock(floating);if(containingBlock){const rect=containingBlock.getBoundingClientRect();x=rect.x,y=rect.y}}return[isTopLayer,x,y]}function getWindowScrollBarX(element){return getBoundingClientRect(getDocumentElement(element)).left+getNodeScroll(element).scrollLeft}function getClientRectFromClippingAncestor(element,clippingAncestor,strategy){let rect;if("viewport"===clippingAncestor)rect=function getViewportRect(element,strategy){const win=getWindow(element),html=getDocumentElement(element),visualViewport=win.visualViewport;let width=html.clientWidth,height=html.clientHeight,x=0,y=0;if(visualViewport){width=visualViewport.width,height=visualViewport.height;const visualViewportBased=isWebKit();(!visualViewportBased||visualViewportBased&&"fixed"===strategy)&&(x=visualViewport.offsetLeft,y=visualViewport.offsetTop)}return{width,height,x,y}}(element,strategy);else if("document"===clippingAncestor)rect=function getDocumentRect(element){const html=getDocumentElement(element),scroll=getNodeScroll(element),body=element.ownerDocument.body,width=(0,floating_ui_utils.Fp)(html.scrollWidth,html.clientWidth,body.scrollWidth,body.clientWidth),height=(0,floating_ui_utils.Fp)(html.scrollHeight,html.clientHeight,body.scrollHeight,body.clientHeight);let x=-scroll.scrollLeft+getWindowScrollBarX(element);const y=-scroll.scrollTop;return"rtl"===getComputedStyle(body).direction&&(x+=(0,floating_ui_utils.Fp)(html.clientWidth,body.clientWidth)-width),{width,height,x,y}}(getDocumentElement(element));else if(isElement(clippingAncestor))rect=function getInnerBoundingClientRect(element,strategy){const clientRect=getBoundingClientRect(element,!0,"fixed"===strategy),top=clientRect.top+element.clientTop,left=clientRect.left+element.clientLeft,scale=isHTMLElement(element)?getScale(element):(0,floating_ui_utils.ze)(1);return{width:element.clientWidth*scale.x,height:element.clientHeight*scale.y,x:left*scale.x,y:top*scale.y}}(clippingAncestor,strategy);else{const visualOffsets=getVisualOffsets(element);rect={...clippingAncestor,x:clippingAncestor.x-visualOffsets.x,y:clippingAncestor.y-visualOffsets.y}}return(0,floating_ui_utils.JB)(rect)}function hasFixedPositionAncestor(element,stopNode){const parentNode=getParentNode(element);return!(parentNode===stopNode||!isElement(parentNode)||isLastTraversableNode(parentNode))&&("fixed"===getComputedStyle(parentNode).position||hasFixedPositionAncestor(parentNode,stopNode))}function getRectRelativeToOffsetParent(element,offsetParent,strategy,floating){const isOffsetParentAnElement=isHTMLElement(offsetParent),documentElement=getDocumentElement(offsetParent),isFixed="fixed"===strategy,rect=getBoundingClientRect(element,!0,isFixed,offsetParent);let scroll={scrollLeft:0,scrollTop:0};const offsets=(0,floating_ui_utils.ze)(0);if(isOffsetParentAnElement||!isOffsetParentAnElement&&!isFixed)if(("body"!==getNodeName(offsetParent)||isOverflowElement(documentElement))&&(scroll=getNodeScroll(offsetParent)),isOffsetParentAnElement){const offsetRect=getBoundingClientRect(offsetParent,!0,isFixed,offsetParent);offsets.x=offsetRect.x+offsetParent.clientLeft,offsets.y=offsetRect.y+offsetParent.clientTop}else documentElement&&(offsets.x=getWindowScrollBarX(documentElement));let x=rect.left+scroll.scrollLeft-offsets.x,y=rect.top+scroll.scrollTop-offsets.y;const[isTopLayer,topLayerX,topLayerY]=topLayer(floating);return isTopLayer&&(x+=topLayerX,y+=topLayerY,isOffsetParentAnElement&&(x+=offsetParent.clientLeft,y+=offsetParent.clientTop)),{x,y,width:rect.width,height:rect.height}}function getTrueOffsetParent(element,polyfill){return isHTMLElement(element)&&"fixed"!==getComputedStyle(element).position?polyfill?polyfill(element):element.offsetParent:null}function getOffsetParent(element,polyfill){const window=getWindow(element);if(!isHTMLElement(element))return window;let offsetParent=getTrueOffsetParent(element,polyfill);for(;offsetParent&&isTableElement(offsetParent)&&"static"===getComputedStyle(offsetParent).position;)offsetParent=getTrueOffsetParent(offsetParent,polyfill);return offsetParent&&("html"===getNodeName(offsetParent)||"body"===getNodeName(offsetParent)&&"static"===getComputedStyle(offsetParent).position&&!isContainingBlock(offsetParent))?window:offsetParent||getContainingBlock(element)||window}const platform={convertOffsetParentRelativeRectToViewportRelativeRect:function convertOffsetParentRelativeRectToViewportRelativeRect(_ref){let{elements,rect,offsetParent,strategy}=_ref;const documentElement=getDocumentElement(offsetParent),[isTopLayer]=elements?topLayer(elements.floating):[!1];if(offsetParent===documentElement||isTopLayer)return rect;let scroll={scrollLeft:0,scrollTop:0},scale=(0,floating_ui_utils.ze)(1);const offsets=(0,floating_ui_utils.ze)(0),isOffsetParentAnElement=isHTMLElement(offsetParent);if((isOffsetParentAnElement||!isOffsetParentAnElement&&"fixed"!==strategy)&&(("body"!==getNodeName(offsetParent)||isOverflowElement(documentElement))&&(scroll=getNodeScroll(offsetParent)),isHTMLElement(offsetParent))){const offsetRect=getBoundingClientRect(offsetParent);scale=getScale(offsetParent),offsets.x=offsetRect.x+offsetParent.clientLeft,offsets.y=offsetRect.y+offsetParent.clientTop}return{width:rect.width*scale.x,height:rect.height*scale.y,x:rect.x*scale.x-scroll.scrollLeft*scale.x+offsets.x,y:rect.y*scale.y-scroll.scrollTop*scale.y+offsets.y}},getDocumentElement,getClippingRect:function getClippingRect(_ref){let{element,boundary,rootBoundary,strategy}=_ref;const clippingAncestors=[..."clippingAncestors"===boundary?function getClippingElementAncestors(element,cache){const cachedResult=cache.get(element);if(cachedResult)return cachedResult;let result=getOverflowAncestors(element,[],!1).filter((el=>isElement(el)&&"body"!==getNodeName(el))),currentContainingBlockComputedStyle=null;const elementIsFixed="fixed"===getComputedStyle(element).position;let currentNode=elementIsFixed?getParentNode(element):element;for(;isElement(currentNode)&&!isLastTraversableNode(currentNode);){const computedStyle=getComputedStyle(currentNode),currentNodeIsContaining=isContainingBlock(currentNode);currentNodeIsContaining||"fixed"!==computedStyle.position||(currentContainingBlockComputedStyle=null),(elementIsFixed?!currentNodeIsContaining&&!currentContainingBlockComputedStyle:!currentNodeIsContaining&&"static"===computedStyle.position&&currentContainingBlockComputedStyle&&["absolute","fixed"].includes(currentContainingBlockComputedStyle.position)||isOverflowElement(currentNode)&&!currentNodeIsContaining&&hasFixedPositionAncestor(element,currentNode))?result=result.filter((ancestor=>ancestor!==currentNode)):currentContainingBlockComputedStyle=computedStyle,currentNode=getParentNode(currentNode)}return cache.set(element,result),result}(element,this._c):[].concat(boundary),rootBoundary],firstClippingAncestor=clippingAncestors[0],clippingRect=clippingAncestors.reduce(((accRect,clippingAncestor)=>{const rect=getClientRectFromClippingAncestor(element,clippingAncestor,strategy);return accRect.top=(0,floating_ui_utils.Fp)(rect.top,accRect.top),accRect.right=(0,floating_ui_utils.VV)(rect.right,accRect.right),accRect.bottom=(0,floating_ui_utils.VV)(rect.bottom,accRect.bottom),accRect.left=(0,floating_ui_utils.Fp)(rect.left,accRect.left),accRect}),getClientRectFromClippingAncestor(element,firstClippingAncestor,strategy));return{width:clippingRect.right-clippingRect.left,height:clippingRect.bottom-clippingRect.top,x:clippingRect.left,y:clippingRect.top}},getOffsetParent,getElementRects:async function(data){const getOffsetParentFn=this.getOffsetParent||getOffsetParent,getDimensionsFn=this.getDimensions;return{reference:getRectRelativeToOffsetParent(data.reference,await getOffsetParentFn(data.floating),data.strategy,data.floating),floating:{x:0,y:0,...await getDimensionsFn(data.floating)}}},getClientRects:function getClientRects(element){return Array.from(element.getClientRects())},getDimensions:function getDimensions(element){const{width,height}=getCssDimensions(element);return{width,height}},getScale,isElement,isRTL:function isRTL(element){return"rtl"===getComputedStyle(element).direction}};function autoUpdate(reference,floating,update,options){void 0===options&&(options={});const{ancestorScroll=!0,ancestorResize=!0,elementResize="function"==typeof ResizeObserver,layoutShift="function"==typeof IntersectionObserver,animationFrame=!1}=options,referenceEl=unwrapElement(reference),ancestors=ancestorScroll||ancestorResize?[...referenceEl?getOverflowAncestors(referenceEl):[],...getOverflowAncestors(floating)]:[];ancestors.forEach((ancestor=>{ancestorScroll&&ancestor.addEventListener("scroll",update,{passive:!0}),ancestorResize&&ancestor.addEventListener("resize",update)}));const cleanupIo=referenceEl&&layoutShift?function observeMove(element,onMove){let timeoutId,io=null;const root=getDocumentElement(element);function cleanup(){var _io;clearTimeout(timeoutId),null==(_io=io)||_io.disconnect(),io=null}return function refresh(skip,threshold){void 0===skip&&(skip=!1),void 0===threshold&&(threshold=1),cleanup();const{left,top,width,height}=element.getBoundingClientRect();if(skip||onMove(),!width||!height)return;const options={rootMargin:-(0,floating_ui_utils.GW)(top)+"px "+-(0,floating_ui_utils.GW)(root.clientWidth-(left+width))+"px "+-(0,floating_ui_utils.GW)(root.clientHeight-(top+height))+"px "+-(0,floating_ui_utils.GW)(left)+"px",threshold:(0,floating_ui_utils.Fp)(0,(0,floating_ui_utils.VV)(1,threshold))||1};let isFirstUpdate=!0;function handleObserve(entries){const ratio=entries[0].intersectionRatio;if(ratio!==threshold){if(!isFirstUpdate)return refresh();ratio?refresh(!1,ratio):timeoutId=setTimeout((()=>{refresh(!1,1e-7)}),100)}isFirstUpdate=!1}try{io=new IntersectionObserver(handleObserve,{...options,root:root.ownerDocument})}catch(e){io=new IntersectionObserver(handleObserve,options)}io.observe(element)}(!0),cleanup}(referenceEl,update):null;let frameId,reobserveFrame=-1,resizeObserver=null;elementResize&&(resizeObserver=new ResizeObserver((_ref=>{let[firstEntry]=_ref;firstEntry&&firstEntry.target===referenceEl&&resizeObserver&&(resizeObserver.unobserve(floating),cancelAnimationFrame(reobserveFrame),reobserveFrame=requestAnimationFrame((()=>{var _resizeObserver;null==(_resizeObserver=resizeObserver)||_resizeObserver.observe(floating)}))),update()})),referenceEl&&!animationFrame&&resizeObserver.observe(referenceEl),resizeObserver.observe(floating));let prevRefRect=animationFrame?getBoundingClientRect(reference):null;return animationFrame&&function frameLoop(){const nextRefRect=getBoundingClientRect(reference);!prevRefRect||nextRefRect.x===prevRefRect.x&&nextRefRect.y===prevRefRect.y&&nextRefRect.width===prevRefRect.width&&nextRefRect.height===prevRefRect.height||update();prevRefRect=nextRefRect,frameId=requestAnimationFrame(frameLoop)}(),update(),()=>{var _resizeObserver2;ancestors.forEach((ancestor=>{ancestorScroll&&ancestor.removeEventListener("scroll",update),ancestorResize&&ancestor.removeEventListener("resize",update)})),null==cleanupIo||cleanupIo(),null==(_resizeObserver2=resizeObserver)||_resizeObserver2.disconnect(),resizeObserver=null,animationFrame&&cancelAnimationFrame(frameId)}}const shift=floating_ui_core.uY,flip=floating_ui_core.RR,size=floating_ui_core.dp,hide=floating_ui_core.Cp,arrow=floating_ui_core.x7,limitShift=floating_ui_core.dr,computePosition=(reference,floating,options)=>{const cache=new Map,mergedOptions={platform,...options},platformWithCache={...mergedOptions.platform,_c:cache};return(0,floating_ui_core.oo)(reference,floating,{...mergedOptions,platform:platformWithCache})}},"../../node_modules/@floating-ui/react-dom/dist/floating-ui.react-dom.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{YF:()=>useFloating,x7:()=>arrow});var _floating_ui_dom__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@floating-ui/dom/dist/floating-ui.dom.mjs"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),react_dom__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/react-dom/index.js");const arrow=options=>({name:"arrow",options,fn(state){const{element,padding}="function"==typeof options?options(state):options;return element&&function isRef(value){return{}.hasOwnProperty.call(value,"current")}(element)?null!=element.current?(0,_floating_ui_dom__WEBPACK_IMPORTED_MODULE_2__.x7)({element:element.current,padding}).fn(state):{}:element?(0,_floating_ui_dom__WEBPACK_IMPORTED_MODULE_2__.x7)({element,padding}).fn(state):{}}});var index="undefined"!=typeof document?react__WEBPACK_IMPORTED_MODULE_0__.useLayoutEffect:react__WEBPACK_IMPORTED_MODULE_0__.useEffect;function deepEqual(a,b){if(a===b)return!0;if(typeof a!=typeof b)return!1;if("function"==typeof a&&a.toString()===b.toString())return!0;let length,i,keys;if(a&&b&&"object"==typeof a){if(Array.isArray(a)){if(length=a.length,length!==b.length)return!1;for(i=length;0!=i--;)if(!deepEqual(a[i],b[i]))return!1;return!0}if(keys=Object.keys(a),length=keys.length,length!==Object.keys(b).length)return!1;for(i=length;0!=i--;)if(!{}.hasOwnProperty.call(b,keys[i]))return!1;for(i=length;0!=i--;){const key=keys[i];if(("_owner"!==key||!a.$$typeof)&&!deepEqual(a[key],b[key]))return!1}return!0}return a!=a&&b!=b}function getDPR(element){if("undefined"==typeof window)return 1;return(element.ownerDocument.defaultView||window).devicePixelRatio||1}function roundByDPR(element,value){const dpr=getDPR(element);return Math.round(value*dpr)/dpr}function useLatestRef(value){const ref=react__WEBPACK_IMPORTED_MODULE_0__.useRef(value);return index((()=>{ref.current=value})),ref}function useFloating(options){void 0===options&&(options={});const{placement="bottom",strategy="absolute",middleware=[],platform,elements:{reference:externalReference,floating:externalFloating}={},transform=!0,whileElementsMounted,open}=options,[data,setData]=react__WEBPACK_IMPORTED_MODULE_0__.useState({x:0,y:0,strategy,placement,middlewareData:{},isPositioned:!1}),[latestMiddleware,setLatestMiddleware]=react__WEBPACK_IMPORTED_MODULE_0__.useState(middleware);deepEqual(latestMiddleware,middleware)||setLatestMiddleware(middleware);const[_reference,_setReference]=react__WEBPACK_IMPORTED_MODULE_0__.useState(null),[_floating,_setFloating]=react__WEBPACK_IMPORTED_MODULE_0__.useState(null),setReference=react__WEBPACK_IMPORTED_MODULE_0__.useCallback((node=>{node!==referenceRef.current&&(referenceRef.current=node,_setReference(node))}),[]),setFloating=react__WEBPACK_IMPORTED_MODULE_0__.useCallback((node=>{node!==floatingRef.current&&(floatingRef.current=node,_setFloating(node))}),[]),referenceEl=externalReference||_reference,floatingEl=externalFloating||_floating,referenceRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),floatingRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),dataRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(data),hasWhileElementsMounted=null!=whileElementsMounted,whileElementsMountedRef=useLatestRef(whileElementsMounted),platformRef=useLatestRef(platform),update=react__WEBPACK_IMPORTED_MODULE_0__.useCallback((()=>{if(!referenceRef.current||!floatingRef.current)return;const config={placement,strategy,middleware:latestMiddleware};platformRef.current&&(config.platform=platformRef.current),(0,_floating_ui_dom__WEBPACK_IMPORTED_MODULE_2__.oo)(referenceRef.current,floatingRef.current,config).then((data=>{const fullData={...data,isPositioned:!0};isMountedRef.current&&!deepEqual(dataRef.current,fullData)&&(dataRef.current=fullData,react_dom__WEBPACK_IMPORTED_MODULE_1__.flushSync((()=>{setData(fullData)})))}))}),[latestMiddleware,placement,strategy,platformRef]);index((()=>{!1===open&&dataRef.current.isPositioned&&(dataRef.current.isPositioned=!1,setData((data=>({...data,isPositioned:!1}))))}),[open]);const isMountedRef=react__WEBPACK_IMPORTED_MODULE_0__.useRef(!1);index((()=>(isMountedRef.current=!0,()=>{isMountedRef.current=!1})),[]),index((()=>{if(referenceEl&&(referenceRef.current=referenceEl),floatingEl&&(floatingRef.current=floatingEl),referenceEl&&floatingEl){if(whileElementsMountedRef.current)return whileElementsMountedRef.current(referenceEl,floatingEl,update);update()}}),[referenceEl,floatingEl,update,whileElementsMountedRef,hasWhileElementsMounted]);const refs=react__WEBPACK_IMPORTED_MODULE_0__.useMemo((()=>({reference:referenceRef,floating:floatingRef,setReference,setFloating})),[setReference,setFloating]),elements=react__WEBPACK_IMPORTED_MODULE_0__.useMemo((()=>({reference:referenceEl,floating:floatingEl})),[referenceEl,floatingEl]),floatingStyles=react__WEBPACK_IMPORTED_MODULE_0__.useMemo((()=>{const initialStyles={position:strategy,left:0,top:0};if(!elements.floating)return initialStyles;const x=roundByDPR(elements.floating,data.x),y=roundByDPR(elements.floating,data.y);return transform?{...initialStyles,transform:"translate("+x+"px, "+y+"px)",...getDPR(elements.floating)>=1.5&&{willChange:"transform"}}:{position:strategy,left:x,top:y}}),[strategy,transform,elements.floating,data.x,data.y]);return react__WEBPACK_IMPORTED_MODULE_0__.useMemo((()=>({...data,update,refs,elements,floatingStyles})),[data,update,refs,elements,floatingStyles])}},"../../node_modules/@floating-ui/utils/dist/floating-ui.utils.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Fp:()=>max,GW:()=>floor,I4:()=>getAxisLength,JB:()=>rectToClientRect,KX:()=>getOppositeAxisPlacements,NM:()=>round,Qq:()=>getSideAxis,Rn:()=>getOppositeAxis,VV:()=>min,Wh:()=>getAlignmentAxis,gy:()=>getExpandedPlacements,hp:()=>getAlignment,i8:()=>getAlignmentSides,k3:()=>getSide,ku:()=>evaluate,mA:()=>sides,pw:()=>getOppositePlacement,uZ:()=>clamp,yd:()=>getPaddingObject,ze:()=>createCoords});const sides=["top","right","bottom","left"],min=Math.min,max=Math.max,round=Math.round,floor=Math.floor,createCoords=v=>({x:v,y:v}),oppositeSideMap={left:"right",right:"left",bottom:"top",top:"bottom"},oppositeAlignmentMap={start:"end",end:"start"};function clamp(start,value,end){return max(start,min(value,end))}function evaluate(value,param){return"function"==typeof value?value(param):value}function getSide(placement){return placement.split("-")[0]}function getAlignment(placement){return placement.split("-")[1]}function getOppositeAxis(axis){return"x"===axis?"y":"x"}function getAxisLength(axis){return"y"===axis?"height":"width"}function getSideAxis(placement){return["top","bottom"].includes(getSide(placement))?"y":"x"}function getAlignmentAxis(placement){return getOppositeAxis(getSideAxis(placement))}function getAlignmentSides(placement,rects,rtl){void 0===rtl&&(rtl=!1);const alignment=getAlignment(placement),alignmentAxis=getAlignmentAxis(placement),length=getAxisLength(alignmentAxis);let mainAlignmentSide="x"===alignmentAxis?alignment===(rtl?"end":"start")?"right":"left":"start"===alignment?"bottom":"top";return rects.reference[length]>rects.floating[length]&&(mainAlignmentSide=getOppositePlacement(mainAlignmentSide)),[mainAlignmentSide,getOppositePlacement(mainAlignmentSide)]}function getExpandedPlacements(placement){const oppositePlacement=getOppositePlacement(placement);return[getOppositeAlignmentPlacement(placement),oppositePlacement,getOppositeAlignmentPlacement(oppositePlacement)]}function getOppositeAlignmentPlacement(placement){return placement.replace(/start|end/g,(alignment=>oppositeAlignmentMap[alignment]))}function getOppositeAxisPlacements(placement,flipAlignment,direction,rtl){const alignment=getAlignment(placement);let list=function getSideList(side,isStart,rtl){const lr=["left","right"],rl=["right","left"],tb=["top","bottom"],bt=["bottom","top"];switch(side){case"top":case"bottom":return rtl?isStart?rl:lr:isStart?lr:rl;case"left":case"right":return isStart?tb:bt;default:return[]}}(getSide(placement),"start"===direction,rtl);return alignment&&(list=list.map((side=>side+"-"+alignment)),flipAlignment&&(list=list.concat(list.map(getOppositeAlignmentPlacement)))),list}function getOppositePlacement(placement){return placement.replace(/left|right|bottom|top/g,(side=>oppositeSideMap[side]))}function getPaddingObject(padding){return"number"!=typeof padding?function expandPaddingObject(padding){return{top:0,right:0,bottom:0,left:0,...padding}}(padding):{top:padding,right:padding,bottom:padding,left:padding}}function rectToClientRect(rect){return{...rect,top:rect.y,left:rect.x,right:rect.x+rect.width,bottom:rect.y+rect.height}}},"../../node_modules/@iiif/vault/dist/esm/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{j:()=>Vault});var __defProp=Object.defineProperty,__publicField=(obj,key,value)=>(((obj,key,value)=>{key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value})(obj,"symbol"!=typeof key?key+"":key,value),value);const EMPTY=[];Object.freeze(EMPTY);const emptyAnnotationPage={id:"https://iiif-parser/annotation-page",type:"AnnotationPage",behavior:EMPTY,motivation:null,label:null,thumbnail:EMPTY,summary:null,requiredStatement:null,metadata:EMPTY,rights:null,provider:EMPTY,items:EMPTY,seeAlso:EMPTY,homepage:EMPTY,logo:EMPTY,rendering:EMPTY,service:EMPTY},emptyCanvas={id:"https://iiif-parser/empty-canvas",type:"Canvas",label:null,behavior:EMPTY,motivation:null,thumbnail:EMPTY,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:EMPTY,rights:null,navDate:null,provider:EMPTY,items:EMPTY,annotations:EMPTY,seeAlso:EMPTY,homepage:EMPTY,logo:EMPTY,partOf:EMPTY,rendering:EMPTY,service:EMPTY,duration:0,height:0,width:0},emptyCollection={id:"https://iiif-parser/empty-collection",type:"Collection",label:null,viewingDirection:"left-to-right",behavior:EMPTY,motivation:null,thumbnail:EMPTY,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:EMPTY,rights:null,navDate:null,provider:EMPTY,items:EMPTY,annotations:EMPTY,seeAlso:EMPTY,homepage:EMPTY,logo:EMPTY,partOf:EMPTY,rendering:EMPTY,service:EMPTY,services:EMPTY},emptyManifest={id:"https://iiif-parser/empty-manifest",type:"Manifest",annotations:EMPTY,behavior:EMPTY,homepage:EMPTY,items:EMPTY,label:null,logo:EMPTY,metadata:EMPTY,motivation:null,navDate:null,provider:EMPTY,partOf:EMPTY,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,rendering:EMPTY,requiredStatement:null,rights:null,seeAlso:EMPTY,service:EMPTY,services:EMPTY,start:null,structures:EMPTY,summary:null,thumbnail:EMPTY,viewingDirection:"left-to-right"},emptyRange={id:"https://iiif-parser/empty-canvas",type:"Range",label:null,behavior:EMPTY,motivation:null,thumbnail:EMPTY,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:EMPTY,rights:null,navDate:null,provider:EMPTY,items:EMPTY,annotations:EMPTY,seeAlso:EMPTY,homepage:EMPTY,logo:EMPTY,partOf:EMPTY,rendering:EMPTY,service:EMPTY,start:null,supplementary:null,viewingDirection:"left-to-right"},emptyAgent={id:"https://iiif-parser/empty-agent",type:"Agent",label:{},logo:EMPTY,seeAlso:EMPTY,homepage:EMPTY};function ensureArray$1(maybeArray){return Array.isArray(maybeArray)?maybeArray:[maybeArray]}const types$1=["Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent"];class Traverse$1{constructor(traversals,options={}){__publicField(this,"traversals"),__publicField(this,"options"),this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],...traversals},this.options={allowUndefinedReturn:!1,...options}}static all(traversal){return new Traverse$1({collection:[traversal],manifest:[traversal],canvas:[traversal],annotationCollection:[traversal],annotationPage:[traversal],annotation:[traversal],contentResource:[traversal],choice:[traversal],range:[traversal],service:[traversal]})}traverseDescriptive(resource){return resource.thumbnail&&(resource.thumbnail=resource.thumbnail.map((thumbnail=>this.traverseType(thumbnail,this.traversals.contentResource)))),resource.provider&&(resource.provider=resource.provider.map((agent=>this.traverseAgent(agent)))),resource}traverseLinking(resource){return resource.seeAlso&&(resource.seeAlso=resource.seeAlso.map((content=>this.traverseType(content,this.traversals.contentResource)))),resource.service&&(resource.service=ensureArray$1(resource.service).map((service=>this.traverseType(service,this.traversals.service)))),resource.services&&(resource.services=resource.services.map((service=>this.traverseType(service,this.traversals.service)))),resource.logo&&(resource.logo=resource.logo.map((content=>this.traverseType(content,this.traversals.contentResource)))),resource.homepage&&(resource.homepage=resource.homepage.map((homepage=>this.traverseType(homepage,this.traversals.contentResource)))),resource.partOf&&(resource.partOf=resource.partOf.map((partOf=>"string"!=typeof partOf&&partOf.type?"Canvas"===partOf.type?this.traverseType(partOf,this.traversals.canvas):"AnnotationCollection"===partOf.type?this.traverseType(partOf,this.traversals.annotationCollection):"Collection"===partOf.type?this.traverseType(partOf,this.traversals.collection):this.traverseType(partOf,this.traversals.contentResource):this.traverseType(partOf,this.traversals.contentResource)))),resource.start&&(resource.start=resource.start?this.traverseType(resource.start,this.traversals.canvas):null),resource.rendering&&(resource.rendering=resource.rendering.map((content=>this.traverseType(content,this.traversals.contentResource)))),resource.supplementary&&(resource.supplementary=resource.supplementary.map((content=>this.traverseType(content,this.traversals.contentResource)))),resource}traverseCollectionItems(collection){return collection.items&&collection.items.map((collectionOrManifest=>"Collection"===collectionOrManifest.type?this.traverseCollection(collectionOrManifest):this.traverseManifest(collectionOrManifest))),collection}traverseCollection(collection){return this.traverseType(this.traverseDescriptive(this.traverseInlineAnnotationPages(this.traverseLinking(this.traversePosterCanvas(this.traverseCollectionItems(collection))))),this.traversals.collection)}traverseManifestItems(manifest){return manifest.items&&(manifest.items=manifest.items.map((canvas=>this.traverseCanvas(canvas)))),manifest}traverseManifestStructures(manifest){return manifest.structures&&(manifest.structures=manifest.structures.map((range=>this.traverseRange(range)))),manifest}traverseManifest(manifest){return this.traverseType(this.traverseInlineAnnotationPages(this.traverseManifestStructures(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest)))))),this.traversals.manifest)}traverseCanvasItems(canvas){return canvas.items=(canvas.items||[]).map((annotationPage=>this.traverseAnnotationPage(annotationPage))),canvas}traverseInlineAnnotationPages(resource){return"string"!=typeof resource&&resource?(resource.annotations&&(resource.annotations=resource.annotations.map((annotationPage=>this.traverseAnnotationPage(annotationPage)))),resource):resource}traverseCanvas(canvas){return this.traverseType(this.traverseInlineAnnotationPages(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))))),this.traversals.canvas)}traverseAnnotationPageItems(annotationPage){return annotationPage.items&&(annotationPage.items=annotationPage.items.map((annotation=>this.traverseAnnotation(annotation)))),annotationPage}traverseAnnotationPage(annotationPageJson){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationPageItems(annotationPageJson))),this.traversals.annotationPage)}traverseAnnotationBody(annotation){return Array.isArray(annotation.body)?annotation.body=annotation.body.map((annotationBody=>this.traverseContentResource(annotationBody))):annotation.body&&(annotation.body=this.traverseContentResource(annotation.body)),annotation}traversePosterCanvas(json){return json.posterCanvas&&(json.posterCanvas=this.traverseCanvas(json.posterCanvas)),json.placeholderCanvas&&(json.placeholderCanvas=this.traverseCanvas(json.placeholderCanvas)),json.accompanyingCanvas&&(json.accompanyingCanvas=this.traverseCanvas(json.accompanyingCanvas)),json}traverseAnnotation(annotationJson){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(annotationJson)),this.traversals.annotation)}traverseContentResourceLinking(contentResourceJson){return"string"!=typeof contentResourceJson&&contentResourceJson?(contentResourceJson&&contentResourceJson.service&&(contentResourceJson.service=ensureArray$1(contentResourceJson.service||[]).map((service=>this.traverseType(service,this.traversals.service)))),contentResourceJson):contentResourceJson}traverseContentResource(contentResourceJson){return"Choice"===contentResourceJson.type&&(contentResourceJson.items=contentResourceJson.items.map((choiceItem=>this.traverseContentResource(choiceItem)))),this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(contentResourceJson)),this.traversals.contentResource)}traverseRangeRanges(range){return range.items&&(range.items=range.items.map((rangeOrManifest=>"string"==typeof rangeOrManifest?this.traverseCanvas({id:rangeOrManifest,type:"Canvas"}):"Manifest"===rangeOrManifest.type?this.traverseManifest(rangeOrManifest):this.traverseRange(rangeOrManifest)))),range}traverseRange(range){return this.traverseType(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseRangeRanges(range)))),this.traversals.range)}traverseAgent(agent){return this.traverseType(this.traverseDescriptive(this.traverseLinking(agent)),this.traversals.agent)}traverseType(object,traversals){return traversals.reduce(((acc,traversal)=>{const returnValue=traversal(acc);return void 0!==returnValue||this.options.allowUndefinedReturn?returnValue:acc}),object)}traverseService(service){return this.traverseType(service,this.traversals.service)}traverseUnknown(resource){const type=function identifyResource$1(resource){if(null==resource)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(resource))throw new Error("Array is not a valid entity");if("object"!=typeof resource)throw new Error(typeof resource+" is not a valid entity");if("string"==typeof resource.type){const hasType=types$1.indexOf(resource.type);if(-1!==hasType)return types$1[hasType]}if(resource.profile)return"Service";throw new Error("Resource type is not known")}(resource);switch(type){case"Collection":return this.traverseCollection(resource);case"Manifest":return this.traverseManifest(resource);case"Canvas":return this.traverseCanvas(resource);case"AnnotationPage":return this.traverseAnnotationPage(resource);case"Annotation":return this.traverseAnnotation(resource);case"ContentResource":return this.traverseContentResource(resource);case"Range":return this.traverseRange(resource);case"Service":return this.traverseService(resource);case"Agent":return this.traverseAgent(resource);default:throw new Error(`Unknown or unsupported resource type of ${type}`)}}}const types=["sc:Collection","sc:Manifest","sc:Canvas","sc:AnnotationList","oa:Annotation","sc:Range","sc:Layer","sc:Sequence","oa:Choice","Service","ContentResource"];class Traverse{constructor(traversals,options={}){__publicField(this,"traversals"),__publicField(this,"options"),this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...traversals},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...options}}static all(traversal){return new Traverse({collection:[traversal],manifest:[traversal],canvas:[traversal],annotationList:[traversal],sequence:[traversal],annotation:[traversal],contentResource:[traversal],choice:[traversal],range:[traversal],service:[traversal],layer:[traversal]})}traverseCollection(collection){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(collection))),this.traversals.collection)}traverseCollectionItems(collection){if(this.options.mergeMemberProperties){const members=[...(collection.manifests||[]).map((manifest=>"string"==typeof manifest?{"@id":manifest,"@type":"sc:Manifest"}:manifest)),...(collection.collections||[]).map((subCollection=>"string"==typeof subCollection?{"@id":subCollection,"@type":"sc:Collection"}:subCollection)),...collection.members||[]];delete collection.collections,delete collection.manifests,collection.members=members}return collection.manifests&&(collection.manifests=collection.manifests.map((manifest=>this.traverseManifest("string"==typeof manifest?{"@id":manifest,"@type":"sc:Manifest"}:manifest)))),collection.collections&&(collection.collections=collection.collections.map((subCollection=>this.traverseCollection("string"==typeof subCollection?{"@id":subCollection,"@type":"sc:Collection"}:subCollection)))),collection.members&&(collection.members=collection.members.map((member=>"string"==typeof member?member:this.traverseUnknown(member)))),collection}traverseManifest(manifest){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest))),this.traversals.manifest)}traverseManifestItems(manifest){return manifest.sequences&&(manifest.sequences=manifest.sequences.map((sequence=>this.traverseSequence(sequence)))),manifest.structures&&(manifest.structures=manifest.structures.map((structure=>this.traverseRange(structure)))),manifest}traverseSequence(sequence){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(sequence))),this.traversals.sequence)}traverseSequenceItems(sequence){return sequence.canvases&&(sequence.canvases=sequence.canvases.map((canvas=>this.traverseCanvas(canvas)))),sequence}traverseCanvas(canvas){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))),this.traversals.canvas)}traverseCanvasItems(canvas){return canvas.images&&(canvas.images=canvas.images.map((image=>this.traverseAnnotation(image)))),canvas.otherContent&&(canvas.otherContent=canvas.otherContent.map((annotationList=>this.traverseAnnotationList(annotationList)))),canvas}traverseRange(range){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(range))),this.traversals.range)}traverseRangeItems(range){if(this.options.mergeMemberProperties){const members=[...(range.ranges||[]).map((innerRange=>"string"==typeof innerRange?{"@id":innerRange,"@type":"sc:Range"}:innerRange)),...(range.canvases||[]).map((canvas=>"string"==typeof canvas?{"@id":canvas,"@type":"sc:Canvas"}:canvas)),...range.members||[]];delete range.ranges,delete range.canvases,range.members=members.length?members.map((member=>this.traverseUnknown(member))):void 0}return range}traverseAnnotationList(annotationList){const list="string"==typeof annotationList?{"@id":annotationList,"@type":"sc:AnnotationList"}:annotationList;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(list)),this.traversals.annotationList)}traverseAnnotationListItems(annotationList){return annotationList.resources&&(annotationList.resources=annotationList.resources.map((annotation=>this.traverseAnnotation(annotation)))),annotationList}traverseAnnotation(annotation){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(annotation))),this.traversals.annotation)}traverseAnnotationItems(annotation){return annotation.resource&&(Array.isArray(annotation.resource)?annotation.resource=annotation.resource.map((res=>this.traverseContentResource(res))):annotation.resource=this.traverseContentResource(annotation.resource)),annotation.on,annotation}traverseLayer(layer){return this.traverseType(this.traverseLinking(this.traverseLayerItems(layer)),this.traversals.layer)}traverseLayerItems(layer){return layer.otherContent&&(layer.otherContent=layer.otherContent.map((annotationList=>this.traverseAnnotationList(annotationList)))),layer}traverseChoice(choice){return this.traverseType(this.traverseChoiceItems(choice),this.traversals.choice)}traverseChoiceItems(choice){return choice.default&&"rdf:nil"!==choice.default&&(choice.default=this.traverseContentResource(choice.default)),choice.item&&"rdf:nil"!==choice.item&&(choice.item=choice.item.map((item=>this.traverseContentResource(item)))),choice}traverseService(service){return this.traverseType(this.traverseLinking(service),this.traversals.service)}traverseContentResource(contentResource){return"oa:Choice"===contentResource["@type"]?this.traverseChoice(contentResource):this.traverseType(this.traverseDescriptive(this.traverseLinking(contentResource)),this.traversals.contentResource)}traverseUnknown(item){if(!item["@type"]||"string"==typeof item)return item;switch(function identifyResource(resource){if(null==resource)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(resource))throw new Error("Array is not a valid entity");if("object"!=typeof resource)throw new Error(typeof resource+" is not a valid entity");if("string"==typeof resource["@type"]){const hasType=types.indexOf(resource["@type"]);if(-1!==hasType)return types[hasType]}if(resource.profile)return"Service";if(resource.format)return"ContentResource";if(resource["@type"])return"ContentResource";throw new Error("Resource type is not known")}(item)){case"sc:Collection":return this.traverseCollection(item);case"sc:Manifest":return this.traverseManifest(item);case"sc:Canvas":return this.traverseCanvas(item);case"sc:Sequence":return this.traverseSequence(item);case"sc:Range":return this.traverseRange(item);case"oa:Annotation":return this.traverseAnnotation(item);case"sc:AnnotationList":return this.traverseAnnotationList(item);case"sc:Layer":return this.traverseLayer(item);case"Service":return this.traverseService(item);case"oa:Choice":return this.traverseChoice(item);case"ContentResource":return this.traverseContentResource(item)}return item.profile?this.traverseService(item):item}traverseImageResource(contentResource){const wasArray=Array.isArray(contentResource),resourceList=Array.isArray(contentResource)?contentResource:[contentResource],newResourceList=[];for(const singleResource of resourceList)"string"==typeof singleResource?newResourceList.push(this.traverseContentResource({"@id":singleResource,"@type":"dctypes:Image"})):newResourceList.push(this.traverseContentResource(singleResource));return wasArray||this.options.convertPropsToArray?newResourceList:newResourceList[0]}traverseDescriptive(resource){return resource.thumbnail&&(resource.thumbnail=this.traverseImageResource(resource.thumbnail)),resource.logo&&(resource.logo=this.traverseImageResource(resource.logo)),resource}traverseOneOrMoreServices(allServices){const wasArray=Array.isArray(allServices),services=Array.isArray(allServices)?allServices:[allServices],newServices=[];for(const service of services)newServices.push(this.traverseService(service));return wasArray||this.options.convertPropsToArray?newServices:newServices[0]}traverseLinking(resource){return resource.related&&(resource.related=this.traverseOneOrManyType(resource.related,this.traversals.contentResource)),resource.rendering&&(resource.rendering=this.traverseOneOrManyType(resource.rendering,this.traversals.contentResource)),resource.service&&(resource.service=this.traverseOneOrMoreServices(resource.service)),resource.seeAlso&&(resource.seeAlso=this.traverseOneOrManyType(resource.seeAlso,this.traversals.contentResource)),resource.within&&("string"==typeof resource.within||(resource.within=this.traverseOneOrManyType(resource.within,this.traversals.contentResource))),resource.startCanvas&&("string"==typeof resource.startCanvas?resource.startCanvas=this.traverseType({"@id":resource.startCanvas,"@type":"sc:Canvas"},this.traversals.canvas):resource.startCanvas&&this.traverseType(resource.startCanvas,this.traversals.canvas)),resource.contentLayer&&("string"==typeof resource.contentLayer?resource.contentLayer=this.traverseLayer({"@id":resource.contentLayer,"@type":"sc:Layer"}):resource.contentLayer=this.traverseLayer(resource.contentLayer)),resource}traverseOneOrManyType(object,traversals){if(!Array.isArray(object)){if(!this.options.convertPropsToArray)return this.traverseType(object,traversals);object=[object]}return object.map((singleObj=>this.traverseType(singleObj,traversals)))}traverseType(object,traversals){return traversals.reduce(((acc,traversal)=>{const returnValue=traversal(acc);return void 0!==returnValue||this.options.allowUndefinedReturn?returnValue:acc}),object)}}const level1Support=["http://iiif.io/api/image/2/level1","http://iiif.io/api/image/2/level2","http://library.stanford.edu/iiif/image-api/compliance.html#level1","http://library.stanford.edu/iiif/image-api/compliance.html#level2","http://library.stanford.edu/iiif/image-api/conformance.html#level1","http://library.stanford.edu/iiif/image-api/conformance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2","http://iiif.io/api/image/1/level1.json","http://iiif.io/api/image/1/profiles/level1.json","http://iiif.io/api/image/1/level2.json","http://iiif.io/api/image/1/profiles/level2.json","http://iiif.io/api/image/2/level1.json","http://iiif.io/api/image/2/profiles/level1.json","http://iiif.io/api/image/2/level2.json","http://iiif.io/api/image/2/profiles/level2.json","level1","level2"],imageServiceProfiles=["http://iiif.io/api/image/2/level0","http://iiif.io/api/image/2/level1","http://iiif.io/api/image/2/level2","http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/compliance.html#level1","http://library.stanford.edu/iiif/image-api/compliance.html#level2","http://library.stanford.edu/iiif/image-api/conformance.html#level0","http://library.stanford.edu/iiif/image-api/conformance.html#level1","http://library.stanford.edu/iiif/image-api/conformance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2","http://iiif.io/api/image/1/level0.json","http://iiif.io/api/image/1/profiles/level0.json","http://iiif.io/api/image/1/level1.json","http://iiif.io/api/image/1/profiles/level1.json","http://iiif.io/api/image/1/level2.json","http://iiif.io/api/image/1/profiles/level2.json","http://iiif.io/api/image/2/level0.json","http://iiif.io/api/image/2/profiles/level0.json","http://iiif.io/api/image/2/level1.json","http://iiif.io/api/image/2/profiles/level1.json","http://iiif.io/api/image/2/level2.json","http://iiif.io/api/image/2/profiles/level2.json","level0","level1","level2"],configuration={attributionLabel:"Attribution",lang:"none",providerId:"http://example.org/provider",providerName:"Unknown"};function convertLanguageMapping(inputLangProperty,defaultLang="none"){if(!inputLangProperty)return{};const arrayOfValues=Array.isArray(inputLangProperty)?inputLangProperty:[inputLangProperty],languageMap={};for(const language of arrayOfValues){if("string"==typeof language){languageMap[defaultLang]=languageMap[defaultLang]?languageMap[defaultLang]:[],languageMap[defaultLang].push(language||"");continue}if(!language["@language"]){languageMap[defaultLang]=languageMap[defaultLang]?languageMap[defaultLang]:[],languageMap[defaultLang].push(language["@value"]||"");continue}const lang=language["@language"];languageMap[lang]=languageMap[lang]?languageMap[lang]:[],languageMap[lang].push(language["@value"]||"")}return languageMap}function getProfile(profile){return Array.isArray(profile)?getProfile(profile.find((s=>"string"==typeof s))):-1!==imageServiceProfiles.indexOf(profile)?"level2":-1!==level1Support.indexOf(profile)?"level1":"string"==typeof profile?profile:void 0}function removePrefix(str){for(const prefix of["sc","oa","dcterms","dctypes","iiif"])if(str.startsWith(`${prefix}:`))return str.slice(prefix.length+1);return str}const knownTypes=["Collection","Manifest","Annotation","AnnotationPage","Range","Service"];function getNewType(resource){const id=resource["@id"]||resource.id;let oldType=resource["@type"]||resource.type;const profile=resource.profile||void 0,context=resource["@context"]||void 0;if(profile){const possibleType=function getTypeFromProfile(inputProfile){switch(inputProfile){case"http://iiif.io/api/image/2/level0.json":case"http://iiif.io/api/image/2/level1.json":case"http://iiif.io/api/image/2/level2.json":return"ImageService2";case"http://iiif.io/api/auth/1/kiosk":case"http://iiif.io/api/auth/1/login":case"http://iiif.io/api/auth/1/clickthrough":case"http://iiif.io/api/auth/1/external":case"http://iiif.io/api/auth/0/kiosk":case"http://iiif.io/api/auth/0/login":case"http://iiif.io/api/auth/0/clickthrough":case"http://iiif.io/api/auth/0/external":return"AuthCookieService1";case"http://iiif.io/api/auth/1/token":case"http://iiif.io/api/auth/0/token":return"AuthTokenService1";case"http://iiif.io/api/auth/1/logout":case"http://iiif.io/api/auth/0/logout":return"AuthLogoutService1";case"http://iiif.io/api/search/1/search":case"http://iiif.io/api/search/0/search":return"SearchService1";case"http://iiif.io/api/search/1/autocomplete":case"http://iiif.io/api/search/0/autocomplete":return"AutoCompleteService1"}}(profile);if(possibleType)return possibleType}if(context){const possibleType=function getTypeFromContext(inputContexts){const contexts=Array.isArray(inputContexts)?inputContexts:[inputContexts];for(const context of contexts)switch(context){case"http://iiif.io/api/image/2/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":return"ImageService2";case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return"ImageService1";case"http://iiif.io/api/annex/openannotation/context.json":return"ImageApiSelector"}}(context);if(possibleType)return possibleType}if(oldType){if(Array.isArray(oldType)){if(-1!==oldType.indexOf("oa:CssStylesheet"))return"CssStylesheet";if(-1!==oldType.indexOf("cnt:ContentAsText"))return"TextualBody";oldType=oldType[0]}for(const prefix of["sc","oa","dcterms","dctypes","iiif"])if(oldType.startsWith(`${prefix}:`)){oldType=oldType.slice(prefix.length+1);break}switch(oldType){case"Layer":return"AnnotationCollection";case"AnnotationList":return"AnnotationPage";case"cnt:ContentAsText":return"TextualBody"}}if(oldType&&-1!==knownTypes.indexOf(oldType))return oldType;if(resource.format){if(resource.format.startsWith("image/"))return"Image";if(resource.format.startsWith("text/"))return"Text";if("application/pdf"===resource.format)return"Text";if(resource.format.startsWith("application/"))return"Dataset"}return id&&(id.endsWith(".jpg")||id.endsWith(".png")||id.endsWith(".jpeg"))?"Image":oldType||"unknown"}const licenseRegex=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function extractLicense(license){const matches=license.match(licenseRegex);return matches?matches[0]:license}const removeContexts=["http://iiif.io/api/presentation/2/context.json","http://iiif.io/api/image/2/context.json","http://iiif.io/api/image/1/context.json","http://library.stanford.edu/iiif/image-api/1.1/context.json","http://iiif.io/api/search/1/context.json","http://iiif.io/api/search/0/context.json","http://iiif.io/api/auth/1/context.json","http://iiif.io/api/auth/0/context.json","http://iiif.io/api/annex/openannotation/context.json"];function fixContext(inputContext){if(inputContext){const contexts=Array.isArray(inputContext)?inputContext:[inputContext],newContexts=[];for(const context of contexts)"http://iiif.io/api/presentation/2/context.json"===context&&newContexts.push("http://iiif.io/api/presentation/3/context.json"),-1===removeContexts.indexOf(context)&&newContexts.push(context);if(contexts.length)return 1===newContexts.length?newContexts[0]:newContexts}}function removeUndefinedProperties(obj){for(const prop in obj)void 0!==obj[prop]&&null!==obj[prop]||delete obj[prop];return obj}let mintedIdCounter=0;function mintNewIdFromResource(resource,subresource){const origId=encodeURI(resource.id||resource["@id"]||"").trim();return origId&&subresource?`${origId}/${subresource}`:origId||(mintedIdCounter++,`http://example.org/${resource["@type"]}${subresource?`/${subresource}`:""}/${mintedIdCounter}`)}function technicalProperties$2(resource){const allBehaviours=[...resource.behavior||[]];let motivation;return resource.viewingHint&&allBehaviours.push(resource.viewingHint),Array.isArray(resource.motivation)?motivation=resource.motivation.map(removePrefix):resource.motivation&&(motivation=removePrefix(resource.motivation)),{"@context":resource["@context"]?fixContext(resource["@context"]):void 0,id:(resource["@id"]||mintNewIdFromResource(resource)).trim(),type:getNewType(resource),behavior:allBehaviours.length?allBehaviours:void 0,height:resource.height?resource.height:void 0,width:resource.width?resource.width:void 0,motivation,viewingDirection:resource.viewingDirection,profile:resource.profile,format:resource.format?resource.format:void 0,duration:void 0,timeMode:void 0}}function descriptiveProperties$2(resource){const[rights,extraMetadata]=function fixLicense(license,licenseLabel="Rights/License",lang="none"){let rights=null;const metadata=[],licenseList=Array.isArray(license)?license:[license];for(const rawLicense of licenseList){const singleLicense=rawLicense?extractLicense(rawLicense):void 0;!singleLicense||-1===singleLicense.indexOf("creativecommons.org")&&-1===singleLicense.indexOf("rightsstatements.org")?singleLicense&&metadata.push({label:{[lang]:[licenseLabel]},value:{[lang]:[singleLicense]}}):rights=singleLicense.startsWith("https://")?`http://${singleLicense.slice(8)}`:singleLicense}return[rights,metadata]}(resource.license),allMetadata=[...resource.metadata?(metadata=resource.metadata,metadata?metadata.map((item=>({label:convertLanguageMapping(item.label),value:convertLanguageMapping(item.value)}))):[]):[],...extraMetadata];var metadata;return{rights,metadata:allMetadata.length?allMetadata:void 0,label:resource.label?convertLanguageMapping(resource.label):void 0,requiredStatement:resource.attribution?{label:convertLanguageMapping(configuration.attributionLabel),value:convertLanguageMapping(resource.attribution)}:void 0,navDate:resource.navDate,summary:resource.description?convertLanguageMapping(resource.description):void 0,thumbnail:resource.thumbnail}}function parseWithin(resource){if(!resource.within)return;const withinProperties=Array.isArray(resource.within)?resource.within:[resource.within],returnPartOf=[];for(const within of withinProperties)if("string"==typeof within){if(within&&"sc:Manifest"===resource["@type"])returnPartOf.push({id:within,type:"Collection"})}else within["@id"]&&returnPartOf.push({id:within["@id"],type:getNewType(within)});return returnPartOf.length?returnPartOf:void 0}function linkingProperties$2(resource){const related=resource.related?Array.isArray(resource.related)?resource.related:[resource.related]:[],layer=resource.contentLayer;return{provider:resource.logo||related.length?[{id:configuration.providerId,type:"Agent",homepage:related.length?[related[0]]:void 0,logo:resource.logo?Array.isArray(resource.logo)?resource.logo:[resource.logo]:void 0,label:convertLanguageMapping(configuration.providerName)}]:void 0,partOf:parseWithin(resource),rendering:resource.rendering,seeAlso:resource.seeAlso,start:resource.startCanvas,service:resource.service?ensureArray$1(resource.service):void 0,supplementary:layer?[layer]:void 0}}function upgradeContentResource(inputContentResource){const contentResource=inputContentResource;return removeUndefinedProperties({...technicalProperties$2(contentResource),...descriptiveProperties$2(contentResource),...linkingProperties$2(contentResource),...(resource=contentResource,{chars:resource.chars,format:resource.format?resource.format:void 0,language:resource.language})});var resource}const presentation2to3=new Traverse({collection:[function upgradeCollection(collection){return removeUndefinedProperties({...technicalProperties$2(collection),...descriptiveProperties$2(collection),...linkingProperties$2(collection),items:collection.members})}],manifest:[function upgradeManifest(manifest){const allCanvases=[],behavior=[];for(const sequence of manifest.sequences||[])sequence.canvases.length&&allCanvases.push(...sequence.canvases),sequence.behavior&&behavior.push(...sequence.behavior);const technical=technicalProperties$2(manifest);return behavior.length&&(technical.behavior?technical.behavior.push(...behavior):technical.behavior=behavior),removeUndefinedProperties({...technical,...descriptiveProperties$2(manifest),...linkingProperties$2(manifest),items:allCanvases,structures:manifest.structures})}],canvas:[function upgradeCanvas(canvas){return removeUndefinedProperties({...technicalProperties$2(canvas),...descriptiveProperties$2(canvas),...linkingProperties$2(canvas),annotations:canvas.otherContent&&canvas.otherContent.length?canvas.otherContent:void 0,items:canvas.images&&canvas.images.length?[{id:mintNewIdFromResource(canvas,"annotation-page"),type:"AnnotationPage",items:canvas.images}]:void 0})}],annotationList:[function upgradeAnnotationList(annotationPage){return removeUndefinedProperties({...technicalProperties$2(annotationPage),...descriptiveProperties$2(annotationPage),...linkingProperties$2(annotationPage),items:annotationPage.resources&&annotationPage.resources.length?annotationPage.resources:void 0})}],sequence:[function upgradeSequence(sequence){return sequence.canvases&&0!==sequence.canvases.length?{canvases:sequence.canvases,behavior:sequence.viewingHint?[sequence.viewingHint]:[]}:{canvases:[],behavior:[]}}],annotation:[function upgradeAnnotation(annotation){return removeUndefinedProperties({...technicalProperties$2(annotation),...descriptiveProperties$2(annotation),...linkingProperties$2(annotation),target:function upgradeTarget(target){if(Array.isArray(target)){if(target.length>1)return{type:"List",items:target.map(upgradeTarget)};target=target[0]}if("string"==typeof target)return encodeURI(target).trim();if("@type"in target){let source;if("string"==typeof target.full)source=target.full;else if("dctypes:Image"===target.full["@type"])source={id:target.full["@id"],type:"Image"};else{if("sc:Canvas"!==target.full["@type"])throw new Error(`Unsupported source type on annotation: ${target.full["@type"]}`);source={id:target.full["@id"],type:"Canvas"}}return{type:"SpecificResource",source,selector:upgradeSelector(target.selector)}}return encodeURI(target["@id"]).trim()}(annotation.on),body:Array.isArray(annotation.resource)?annotation.resource.map(upgradeContentResource):upgradeContentResource(annotation.resource)})}],contentResource:[upgradeContentResource],choice:[function upgradeChoice(choice){const items=[];return choice.default&&"rdf:nil"!==choice.default&&items.push(choice.default),choice.item&&"rdf:nil"!==choice.item&&items.push(...choice.item),{...technicalProperties$2(choice),...descriptiveProperties$2(choice),items}}],range:[function upgradeRange(range){return removeUndefinedProperties({...technicalProperties$2(range),...descriptiveProperties$2(range),...linkingProperties$2(range),items:range.members})}],service:[function upgradeService(service){const{"@id":id,"@type":type,"@context":context,profile,...additionalProps}=service,newService={};return id&&(newService["@id"]=id),newService["@type"]=getNewType(service),"unknown"===newService["@type"]&&(context&&context.length&&(newService["@context"]=context),newService["@type"]="Service"),profile&&(newService.profile=getProfile(profile)),removeUndefinedProperties({...newService,...additionalProps})}],layer:[function upgradeLayer(layer){return removeUndefinedProperties({...technicalProperties$2(layer),...descriptiveProperties$2(layer),...linkingProperties$2(layer)})}]});function upgradeSelector(selector){if((Array.isArray(selector["@type"])&&selector["@type"].includes("oa:SvgSelector")||"oa:SvgSelector"==selector["@type"])&&("chars"in selector||"value"in selector))return{type:"SvgSelector",value:"chars"in selector?selector.chars:selector.value};if("oa:FragmentSelector"===selector["@type"])return{type:"FragmentSelector",value:selector.value};if("oa:Choice"===selector["@type"])return[upgradeSelector(selector.default),...(Array.isArray(selector.item)?selector.item:[selector.item]).map(upgradeSelector)];if("iiif:ImageApiSelector"==selector["@type"])return{type:"ImageApiSelector",region:"region"in selector?selector.region:void 0,rotation:"rotation"in selector?selector.rotation:void 0};throw new Error(`Unsupported selector type: ${selector["@type"]}`)}function getResource(entityOrString,type){if("string"==typeof entityOrString)return{id:entityOrString,type};if(!entityOrString.id)throw new Error(`Invalid resource does not have an ID (${type})`);return entityOrString}function mapToEntities(entities){return(type,defaultStringType)=>{const storeType=entities[type]?entities[type]:{};return r=>{const resource=getResource(r,defaultStringType||type);return resource&&resource.id&&type?(storeType[resource.id]=storeType[resource.id]?function mergeEntities(existing,incoming){if("string"==typeof existing)return existing;if(incoming.id!==existing.id||incoming.type!==existing.type)throw new Error("Can only merge entities with identical identifiers and type!");return merge({...existing},incoming)}(storeType[resource.id],resource):Object.assign({},resource),{id:resource.id,type:"ContentResource"===type?type:resource.type}):resource}}}function merge(existing,incoming){if(!incoming)return existing;if(Array.isArray(existing)){if(!Array.isArray(incoming))throw new Error("Cannot merge array with non-array");const merged=[...existing];for(const item of incoming)if(null!=item)if(Array.isArray(item))merged.push(item);else if("object"==typeof item&&item.id&&item.type){const existingIdx=merged.findIndex((e=>e.id===item.id&&e.type===item.type));existingIdx>=0&&(merged[existingIdx]=merge(merged[existingIdx],item))}else-1===existing.indexOf(item)&&merged.push(item);return merged}if("object"==typeof existing){if(Array.isArray(incoming)||"object"!=typeof incoming)throw new Error("Cannot merge object with non-object");const merged={...existing};for(const[key,val]of Object.entries(incoming)){const currentVal=merged[key];merged[key]=currentVal!==EMPTY&&currentVal?merge(currentVal,val):val}return merged}return existing||incoming}function hash(object){const text=JSON.stringify(object);let numHash=5381,index=text.length;for(;index;)numHash=33*numHash^text.charCodeAt(--index);const hexString=(numHash>>>0).toString(16);return hexString.length%2?"0"+hexString:hexString}function addMissingIdToContentResource(type){return resource=>"string"==typeof resource?{id:resource,type}:resource.id?resource.type?resource:{type,...resource}:{id:`vault://${hash(resource)}`,type,...resource}}function ensureDefaultFields(defaultResource){return resource=>({...defaultResource,...resource})}function ensureArray(maybeArray){return Array.isArray(maybeArray)?maybeArray:[maybeArray]}function ensureArrayOnAnnotation(annotation){return annotation.body&&(annotation.body=ensureArray(annotation.body)),annotation.seeAlso&&(annotation.seeAlso=ensureArray(annotation.seeAlso)),annotation.body&&(annotation.body=ensureArray(annotation.body)),annotation.audience&&(annotation.audience=ensureArray(annotation.audience)),annotation.accessibility&&(annotation.accessibility=ensureArray(annotation.accessibility)),annotation.motivation&&(annotation.motivation=ensureArray(annotation.motivation)),annotation}function normalize(unknownEntity){const entity=function convertPresentation2(entity){return entity&&entity["@context"]&&("http://iiif.io/api/presentation/2/context.json"===entity["@context"]||-1!==entity["@context"].indexOf("http://iiif.io/api/presentation/2/context.json")||"http://www.shared-canvas.org/ns/context.json"===entity["@context"])||"http://iiif.io/api/image/2/context.json"===entity["@context"]?presentation2to3.traverseUnknown(entity):entity}(unknownEntity),entities={Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}},mapping={},addToEntities=mapToEntities(entities),addToMapping=function recordTypeInMapping(mapping){return(type,defaultStringType)=>r=>{const{id,type:foundType}=getResource(r,defaultStringType||type);if(void 0===id)throw new Error("Found invalid entity without an ID.");return mapping[id]="ContentResource"===type?type:foundType,r}}(mapping);return{entities,resource:new Traverse$1({collection:[ensureDefaultFields(emptyCollection),addToMapping("Collection"),addToEntities("Collection")],manifest:[ensureDefaultFields(emptyManifest),addToMapping("Manifest"),addToEntities("Manifest")],canvas:[ensureDefaultFields(emptyCanvas),addToMapping("Canvas"),addToEntities("Canvas")],annotationPage:[addMissingIdToContentResource("AnnotationPage"),ensureDefaultFields(emptyAnnotationPage),addToMapping("AnnotationPage"),addToEntities("AnnotationPage")],annotation:[addMissingIdToContentResource("Annotation"),ensureArrayOnAnnotation,addToMapping("Annotation"),addToEntities("Annotation")],contentResource:[addMissingIdToContentResource("ContentResource"),addToMapping("ContentResource"),addToEntities("ContentResource")],range:[ensureDefaultFields(emptyRange),addToMapping("Range","Canvas"),addToEntities("Range","Canvas")],agent:[ensureDefaultFields(emptyAgent),addToMapping("Agent"),addToEntities("Agent")]}).traverseUnknown(entity),mapping}}const UNSET="__$UNSET$__",UNWRAP="__$UNWRAP$__";function serialize(state,subject,config){if(!subject.type||!subject.id)throw new Error("Unknown entity");if(!config[subject.type])throw new Error(`Serializer not found for ${subject.type}`);return function flatten(sub){const generator=config[sub.type];if(!generator)return UNSET;const resource=function resolveIfExists(state,url){const request=state.requests[url],resourceType=state.mapping[url];if(resourceType&&(!request||!request.resourceUri||state.entities[resourceType][request.resourceUri]))return state.entities[resourceType][request?request.resourceUri:url]}(state,sub.id)||(sub.id&&sub.type?sub:null);if(!resource)return UNSET;const iterator=generator(resource,state,{isTopLevel:subject.id===sub.id});let current=iterator.next();for(;!current.done;){const requestToHydrate=current.value;let next=UNSET;if(requestToHydrate)if(Array.isArray(requestToHydrate)){const nextList=[];for(const req of requestToHydrate)nextList.push(flatten(req));next=nextList}else next=flatten(requestToHydrate);current=iterator.next(next)}return current.value===UNSET?UNSET:function serializedFieldsToObject(fields){const object={};for(const[key,value]of fields){if(key===UNWRAP&&value!==UNSET)return value;value!==UNSET&&null!=value&&(object[key]=value)}return object}(current.value)}(subject)}function languageString2to3(value){if(!value)return;const languages=Object.keys(value);if(0!==languages.length){if(1===languages.length){const language=languages[0];if(!language)return"";const singleValue=(value[language]||[]).join("");return"@none"===language||"none"===language||"en"===language?singleValue:{"@language":language,"@value":singleValue}}return languages.map((language=>({"@language":language,"@value":(value[language]||[]).join("")})))}}function parseCanvasTarget(target){return Array.isArray(target)?target.map((t=>parseCanvasTarget(t))):"string"==typeof target?target:target.type&&"Canvas"===target.type?target.id:target}function unNestArray(oneOrArray,onlyOne=!1){if(oneOrArray)return oneOrArray.length>1&&!onlyOne?oneOrArray:oneOrArray[0]||void 0}function convertService(service){if(service){if("string"==typeof service)return{"@id":service};if("@id"in service){const newService={...service};return delete newService["@type"],newService}return{"@context":"http://iiif.io/api/image/2/context.json","@id":service.id,profile:`http://iiif.io/api/image/2/profiles/${service.profile}.json`}}}function technicalProperties$1(props,type){return[["@id",props.id],["@type",type],["format",props.format],["height",props.height],["width",props.width],["viewingDirection","left-to-right"!==props.viewingDirection?props.viewingDirection:void 0]]}function*descriptiveProperties$1(prop){const provider=prop.provider?yield prop.provider[0]:void 0;return[["label",languageString2to3(prop.label)],["metadata",prop.metadata&&prop.metadata.length?prop.metadata.map((item=>({label:languageString2to3(item.label)||"",value:languageString2to3(item.value)||""}))):void 0],["description",languageString2to3(prop.summary)],["thumbnail",unNestArray(yield prop.thumbnail)],["navDate",prop.navDate],["logo",provider?unNestArray(provider.logo):void 0],["homepage",provider?provider.homepage:void 0],["attribution",prop.requiredStatement?languageString2to3(prop.requiredStatement.value):void 0]]}function*linkingProperties$1(prop){return[["seeAlso",unNestArray(yield prop.seeAlso)],["service",unNestArray((prop.service||[]).map(convertService))],["rendering",unNestArray(yield prop.rendering)],["startCanvas",prop.start?prop.start.id:void 0]]}const serializeConfigPresentation2={Manifest:function*(entity){return[...technicalProperties$1(entity,"sc:Manifest"),...yield*descriptiveProperties$1(entity),...yield*linkingProperties$1(entity),["sequences",[{"@id":`${entity.id}/sequence0`,"@type":"sc:Sequence",canvases:yield entity.items}]],["structures",yield entity.structures]]},Canvas:function*(entity){const resources=(yield entity.items)[0];return[...technicalProperties$1(entity,"sc:Canvas"),...yield*descriptiveProperties$1(entity),...yield*linkingProperties$1(entity),["images",resources?[resources.resources]:void 0],["annotations",entity.annotations&&entity.annotations.length?unNestArray(yield entity.annotations):void 0]]},AnnotationPage:function*(entity){return[...technicalProperties$1(entity,"sc:AnnotationList"),...yield*descriptiveProperties$1(entity),["resources",entity.items&&entity.items.length?unNestArray(yield entity.items):void 0]]},Annotation:function*(entity){return[["@id",entity.id],["@type","oa:Annotation"],["motivation","sc:painting"],["on",parseCanvasTarget(entity.target)],["resource",unNestArray(yield entity.body,!0)]]},ContentResource:function*(entity){return"Image"===entity.type?[...technicalProperties$1(entity,"dctypes:Image"),...yield*descriptiveProperties$1(entity),...yield*linkingProperties$1(entity)]:[...technicalProperties$1(entity,void 0),...yield*descriptiveProperties$1(entity)]},AnnotationCollection:function*(entity){return[["@id",entity.id],["@type","sc:Layer"],["label",languageString2to3(entity.label)]]},Collection:function*(entity){return[...technicalProperties$1(entity,"sc:Collection"),...yield*descriptiveProperties$1(entity),...yield*linkingProperties$1(entity),["members",yield*entity.items]]},Range:function*(entity){const members=[],canvases=[];if(entity.items)for(const item of entity.items){const canvas=yield item;members.push({"@id":item.id,"@type":item.type,label:canvas?canvas.label:void 0,within:entity.id}),"Canvas"===item.type&&canvases.push(item.id)}return[...technicalProperties$1(entity,"sc:Range"),...yield*descriptiveProperties$1(entity),...yield*linkingProperties$1(entity),["canvases",canvases.length===members.length?canvases:void 0],["members",canvases.length!==members.length?members:void 0]]}};function technicalProperties(entity){var _a;return[["id",(null==(_a=entity.id)?void 0:_a.startsWith("vault://"))?void 0:entity.id],["type",entity.type],["format",entity.format],["profile",entity.profile],["height",entity.height],["width",entity.width],["duration",entity.duration||void 0],["viewingDirection","left-to-right"!==entity.viewingDirection?entity.viewingDirection:void 0],["behavior",entity.behavior&&entity.behavior.length?entity.behavior:void 0],["timeMode",entity.timeMode],["motivation",Array.isArray(entity.motivation)?entity.motivation[0]:entity.motivation]]}function filterEmpty(item){if(item&&0!==item.length)return item}function service2compat(service){if(service&&service.type&&"ImageService2"===service.type){const{id,type,profile:_profile,..._service}=service,profile="string"==typeof _profile?_profile:Array.isArray(_profile)?_profile.find((p=>"string"==typeof p)):"";return{"@id":id,"@type":type,profile:profile?profile.startsWith("http")?profile:`http://iiif.io/api/image/2/${profile}.json`:"http://iiif.io/api/image/2/level0.json",..._service}}return service}function filterService2Compat(services){if(services&&0!==services.length)return services.map(service2compat)}function*descriptiveProperties(entity){return[["label",entity.label],["metadata",filterEmpty(entity.metadata)],["summary",entity.summary],["requiredStatement",entity.requiredStatement],["rights",entity.rights],["navDate",entity.navDate],["language",entity.language],["thumbnail",filterEmpty(yield entity.thumbnail)],["placeholderCanvas",yield entity.placeholderCanvas],["accompanyingCanvas",yield entity.accompanyingCanvas],["provider",filterEmpty(yield entity.provider)]]}function*linkingProperties(entity){return[["seeAlso",filterEmpty(yield entity.seeAlso)],["service",filterService2Compat(entity.service)],["services",filterService2Compat(entity.services)],["rendering",filterEmpty(yield entity.rendering)],["supplementary",filterEmpty(yield entity.supplementary)],["homepage",filterEmpty(yield entity.homepage)],["logo",filterEmpty(yield entity.logo)],["partOf",filterEmpty(yield entity.partOf)],["start",entity.start]]}const serializeConfigPresentation3={Manifest:function*(entity,state,{isTopLevel}){return isTopLevel?[["@context","http://iiif.io/api/presentation/3/context.json"],...technicalProperties(entity),...yield*descriptiveProperties(entity),...yield*linkingProperties(entity),["items",yield entity.items],["structures",filterEmpty(yield entity.structures)],["annotations",filterEmpty(yield entity.annotations)]]:[...technicalProperties(entity),...yield*descriptiveProperties(entity)]},Canvas:function*(entity){return[...technicalProperties(entity),...yield*descriptiveProperties(entity),...yield*linkingProperties(entity),["items",yield entity.items],["annotations",filterEmpty(yield entity.annotations)]]},Agent:function*(entity){return[["id",entity.id],["type","Agent"],["label",entity.label],...yield*linkingProperties(entity)]},AnnotationPage:function*(entity){return[...Object.entries(entity).map((([key,item])=>[key,Array.isArray(item)?filterEmpty(item):item])).filter((([key,value])=>"items"!==key)),...yield*linkingProperties(entity),["items",yield entity.items]]},Service:function*(entity){return[[UNWRAP,service2compat(entity)]]},Annotation:function*(entity){const entries=Object.entries(entity).map((([key,item])=>"motivation"===key?[key,Array.isArray(item)?item[0]:item]:[key,Array.isArray(item)?filterEmpty(item):item])).filter((([key])=>"body"!==key)),resolvedBody=yield entity.body;return[...entries,["body",1===resolvedBody.length?resolvedBody[0]:resolvedBody]]},ContentResource:function*(entity){return[...technicalProperties(entity),...yield*descriptiveProperties(entity),...yield*linkingProperties(entity),["annotations",filterEmpty(yield entity.annotations)],["items",filterEmpty(yield entity.items)]]},AnnotationCollection:function*(entity){return[["id",entity.id],["type","AnnotationCollection"],["label",entity.label]]},Collection:function*(entity,state,{isTopLevel}){return isTopLevel?[["@context","http://iiif.io/api/presentation/3/context.json"],...technicalProperties(entity),...yield*descriptiveProperties(entity),...yield*linkingProperties(entity),["items",filterEmpty(yield entity.items)]]:[...technicalProperties(entity),...yield*descriptiveProperties(entity)]},Range:function*(entity){const rangeItems=[];for(const item of entity.items)"Range"===item.type?rangeItems.push(yield item):rangeItems.push(item);return[...technicalProperties(entity),...yield*descriptiveProperties(entity),...yield*linkingProperties(entity),["items",rangeItems],["annotations",filterEmpty(yield entity.annotations)]]}};var typesafe_actions_umd_production=__webpack_require__("../../node_modules/typesafe-actions/dist/typesafe-actions.umd.production.js"),redux=__webpack_require__("../../node_modules/redux/es/redux.js");const importEntities=(0,typesafe_actions_umd_production.createAction)("@iiif/IMPORT_ENTITIES")(),modifyEntityField=(0,typesafe_actions_umd_production.createAction)("@iiif/MODIFY_ENTITY_FIELD")(),reorderEntityField=(0,typesafe_actions_umd_production.createAction)("@iiif/REORDER_ENTITY_FIELD")(),addReference=(0,typesafe_actions_umd_production.createAction)("@iiif/ADD_REFERENCE")(),removeReference=(0,typesafe_actions_umd_production.createAction)("@iiif/REMOVE_REFERENCE")(),entityActions={importEntities,modifyEntityField,reorderEntityField,addReference,removeReference},addMapping=(0,typesafe_actions_umd_production.createAction)("@iiif/ADD_MAPPING")(),addMappings=(0,typesafe_actions_umd_production.createAction)("@iiif/ADD_MAPPINGS")(),metaActions={setMetaValue:(0,typesafe_actions_umd_production.createAction)("@iiif/SET_META_VALUE")(),setMetaValueDynamic:(0,typesafe_actions_umd_production.createAction)("@iiif/SET_META_VALUE_DYNAMIC")(),unsetMetaValue:(0,typesafe_actions_umd_production.createAction)("@iiif/UNSET_META_VALUE")()},requestResource=(0,typesafe_actions_umd_production.createAction)("@iiif/REQUEST_RESOURCE")(),requestError=(0,typesafe_actions_umd_production.createAction)("@iiif/REQUEST_ERROR")(),requestMismatch=(0,typesafe_actions_umd_production.createAction)("@iiif/REQUEST_MISMATCH")(),requestComplete=(0,typesafe_actions_umd_production.createAction)("@iiif/REQUEST_COMPLETE")();(0,typesafe_actions_umd_production.createAction)("@iiif/REQUEST_OFFLINE_RESOURCE")();const BATCH_ACTIONS="@iiif/BATCH",BATCH_IMPORT="@iiif/BATCH_IMPORT",batchActions=(0,typesafe_actions_umd_production.createAction)(BATCH_ACTIONS)();(0,typesafe_actions_umd_production.createAction)(BATCH_IMPORT)();const safeIsNaN=Number.isNaN||function ponyfill(value){return"number"==typeof value&&value!=value};function areInputsEqual(newInputs,lastInputs){if(!Array.isArray(newInputs)||!Array.isArray(lastInputs))return newInputs===lastInputs;if(newInputs.length!==lastInputs.length)return!1;for(let i=0;i<newInputs.length;i++)if(first=newInputs[i],second=lastInputs[i],!(first===second||safeIsNaN(first)&&safeIsNaN(second)))return!1;var first,second;return!0}function esm_resolveIfExists(state,url){const request=state.iiif.requests[url],resourceType=state.iiif.mapping[url];if(resourceType&&state.iiif.entities[resourceType][request.resourceUri])return state.iiif.entities[resourceType][request.resourceUri]}function createFetchHelper(store,fetcher,{waitTimeout=30}={}){return async(url,options)=>{const state=store.getState(),request=state.iiif.requests[url];if(request)switch(request.loadingState){case"RESOURCE_ERROR":break;case"RESOURCE_LOADING":{let cleanupSubscription,didContinue=!1;try{const resolvedEntity=await Promise.race([new Promise(((resolve,reject)=>{didContinue||(cleanupSubscription=store.subscribe((()=>{const latestState=store.getState();if("RESOURCE_ERROR"!==latestState.iiif.requests[url].loadingState){if("RESOURCE_READY"===latestState.iiif.requests[url].loadingState){const maybeResolvedEntity=esm_resolveIfExists(latestState,url);maybeResolvedEntity?resolve(maybeResolvedEntity):reject()}}else reject()})))})),new Promise(((resolve,reject)=>setTimeout((()=>{didContinue=!0,reject()}),60*waitTimeout)))]);if(cleanupSubscription&&cleanupSubscription(),resolvedEntity)return resolvedEntity}catch(e){cleanupSubscription&&cleanupSubscription();break}break}case"RESOURCE_READY":{const resolvedEntity=esm_resolveIfExists(state,url);if(resolvedEntity)return resolvedEntity;break}}store.dispatch(requestResource({id:url}));try{const resource=await fetcher(url,options);resource.id||resource["@id"]||(resource["@type"]?(resource["@id"]=url,resource.id=url):resource.id=url);const toDispatch=((id,response)=>{const{entities,resource,mapping}=normalize(response);if(void 0===resource.id)return[requestError({id,message:"ID is not defined in resource."})];const actions=[importEntities({entities}),addMappings({mapping})];return resource.id!==id&&(actions.push(addMapping({id,type:resource.type})),actions.push(requestMismatch({requestId:id,actualId:resource.id}))),actions.push(requestComplete({id})),actions})(url,resource);return store.dispatch(batchActions({actions:toDispatch})),esm_resolveIfExists(store.getState(),url)}catch(err){throw store.dispatch(requestError({id:url,message:err.toString()})),err}}}function isReferenceList(state,id,type,key){return!!(state[type]&&state[type][id]&&state[type][id][key]&&Array.isArray(state[type][id][key]))}function quickMerge(a,b){const newResource={},added=[];for(const[key,value]of Object.entries(a||{})){added.push(key);const bValue=(b||{})[key];bValue&&0!==bValue.length?newResource[key]=bValue:newResource[key]=value}for(const[key,value]of Object.entries(b||{}))-1===added.indexOf(key)&&(newResource[key]=value);return newResource}const reducers=(0,redux.UY)({mapping:(state={},action)=>{switch(action.type){case"@iiif/ADD_MAPPING":return{...state,[action.payload.id]:action.payload.type};case"@iiif/ADD_MAPPINGS":return{...state,...action.payload.mapping};default:return state}},entities:(state={Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}},action)=>{switch(action.type){case"@iiif/MODIFY_ENTITY_FIELD":{if(!state[action.payload.type]||!state[action.payload.type][action.payload.id])return state;const entity=state[action.payload.type][action.payload.id];return"string"==typeof entity?state:{...state,[action.payload.type]:{...state[action.payload.type],[action.payload.id]:{...entity,[action.payload.key]:action.payload.value}}}}case"@iiif/REORDER_ENTITY_FIELD":{if(!isReferenceList(state,action.payload.id,action.payload.type,action.payload.key))return state;const entity=state[action.payload.type][action.payload.id];if("string"==typeof entity)return state;const result=Array.from(entity[action.payload.key]),[removed]=result.splice(action.payload.startIndex,1);return result.splice(action.payload.endIndex,0,removed),{...state,[action.payload.type]:{...state[action.payload.type],[action.payload.id]:{...entity,[action.payload.key]:result}}}}case"@iiif/IMPORT_ENTITIES":{const keys=Object.keys(action.payload.entities),toReturn={...state};for(const key of keys){const entities=action.payload.entities[key],newEntities={...state[key]||{}};let changed=!1;const ids=Object.keys(entities||{})||[];if(entities&&ids){for(const id of ids)changed=!0,newEntities[id]=state[key][id]?quickMerge(state[key][id],entities[id]):entities[id];changed&&(toReturn[key]=newEntities)}}return toReturn}case"@iiif/ADD_REFERENCE":{if(!isReferenceList(state,action.payload.id,action.payload.type,action.payload.key))return state;const entity=state[action.payload.type][action.payload.id],result=Array.from(entity[action.payload.key]);return result.splice(action.payload.index||result.length+1,0,action.payload.reference),{...state,[action.payload.type]:{...state[action.payload.type],[action.payload.id]:{...entity,[action.payload.key]:result}}}}case"@iiif/REMOVE_REFERENCE":{if(!isReferenceList(state,action.payload.id,action.payload.type,action.payload.key))return state;const entity=state[action.payload.type][action.payload.id],result=Array.from(entity[action.payload.key]),indexToRemove=action.payload.index||result.findIndex((e=>e&&e.id===action.payload.reference.id));return-1===indexToRemove||result[indexToRemove]?.id!==action.payload.reference.id?state:(result.splice(indexToRemove,1),{...state,[action.payload.type]:{...state[action.payload.type],[action.payload.id]:{...entity,[action.payload.key]:result}}})}default:return state}},requests:(state={},action)=>{switch(action.type){case"@iiif/REQUEST_RESOURCE":case"@iiif/REQUEST_OFFLINE_RESOURCE":return{...state,[action.payload.id]:{requestUri:action.payload.id,loadingState:"RESOURCE_LOADING",uriMismatch:!1,resourceUri:action.payload.id}};case"@iiif/REQUEST_MISMATCH":return{...state,[action.payload.requestId]:{...state[action.payload.requestId]||{},uriMismatch:!0,resourceUri:action.payload.actualId},[action.payload.actualId]:{requestUri:action.payload.requestId,loadingState:state[action.payload.requestId].loadingState,uriMismatch:!0,resourceUri:action.payload.actualId}};case"@iiif/REQUEST_ERROR":return{...state,[action.payload.id]:{...state[action.payload.id]||{},loadingState:"RESOURCE_ERROR",error:action.payload.message}};case"@iiif/REQUEST_COMPLETE":return{...state,[action.payload.id]:{...state[action.payload.id]||{},loadingState:"RESOURCE_READY",error:void 0}}}return state},meta:(state={},action)=>{const{id,updateValue,value,meta,key}=action&&action.payload||{};switch(action.type){case"@iiif/SET_META_VALUE":return{...state,[id]:{...state[id]||{},[meta]:{...state[id]&&state[id][meta]||{},[key]:value}}};case"@iiif/SET_META_VALUE_DYNAMIC":return{...state,[id]:{...state[id]||{},[meta]:{...state[id]&&state[id][meta]||{},[key]:state[id]&&state[id][meta]?updateValue(state[id][meta][key]):updateValue(void 0)}}};case"@iiif/UNSET_META_VALUE":return state[id]&&state[id][meta]&&state[id][meta][key]?{...state,[id]:{...state[id]||{},[meta]:{...state[id]&&state[id][meta]||{},[key]:void 0}}}:state;default:return state}}}),composeEnhancers="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__||redux.qC;function createStore(options={}){const{enableDevtools=!0,iiifStoreName="iiif",defaultState={},extraMiddleware=[],customReducers={}}=options,rootReducer=(0,redux.UY)({[iiifStoreName]:reducers,...customReducers}),store=(0,redux.MT)(function createBatchReducer(rootReducer){return(state,action)=>action&&action.type===BATCH_ACTIONS?action.payload.actions.reduce(rootReducer,state):action&&action.type===BATCH_IMPORT?action.payload.state:rootReducer(state,action)}(rootReducer),defaultState,enableDevtools?composeEnhancers((0,redux.md)(...extraMiddleware)):(0,redux.qC)((0,redux.md)(...extraMiddleware)));return store}class Vault{options;store;emitter;isBatching=!1;batchQueue=[];remoteFetcher;staticFetcher;constructor(options,store){this.options=Object.assign({reducers:{},middleware:[],defaultState:{},customFetcher:this.defaultFetcher,enableDevtools:!0},options||{}),this.store=store||createStore({customReducers:this.options.reducers,extraMiddleware:[...this.options.middleware,this.middleware],defaultState:this.options.defaultState,enableDevtools:this.options.enableDevtools}),this.emitter=function mitt(n){return{all:n=n||new Map,on:function(t,e){var i=n.get(t);i?i.push(e):n.set(t,[e])},off:function(t,e){var i=n.get(t);i&&(e?i.splice(i.indexOf(e)>>>0,1):n.set(t,[]))},emit:function(t,e){var i=n.get(t);i&&i.slice().map((function(n){n(e)})),(i=n.get("*"))&&i.slice().map((function(n){n(t,e)}))}}}(),this.remoteFetcher=createFetchHelper(this.store,this.options.customFetcher),this.staticFetcher=createFetchHelper(this.store,((id,json)=>json))}defaultFetcher=url=>fetch(url).then((r=>r.json()));batch(cb){this.isBatching=!0;try{cb(this),this.store.dispatch(batchActions({actions:this.batchQueue}))}catch(e){throw this.batchQueue=[],this.isBatching=!1,e}this.batchQueue=[],this.isBatching=!1}async asyncBatch(cb){this.isBatching=!0;try{await cb(this),this.store.dispatch(batchActions({actions:this.batchQueue}))}catch(e){throw this.batchQueue=[],this.isBatching=!1,e}this.batchQueue=[],this.isBatching=!1}modifyEntityField(entity,key,value){this.dispatch(entityActions.modifyEntityField({id:entity.id,type:entity.type,key,value}))}dispatch(action){this.isBatching?this.batchQueue.push(action):this.store.dispatch(action)}middleware=store=>next=>action=>{if(action.type===BATCH_ACTIONS){for(const realAction of action.payload.actions)this.emitter.emit(realAction.type,{realAction,state:store.getState()});const state2=next(action);for(const realAction of action.payload.actions)this.emitter.emit(`after:${action.type}`,{action,state:state2});return state2}this.emitter.emit(action.type,{action,state:store.getState()});const state=next(action);return this.emitter.emit(`after:${action.type}`,{action,state}),state};serialize(entity,config){return serialize(this.getState().iiif,entity,config)}toPresentation2(entity){return this.serialize(entity,serializeConfigPresentation2)}toPresentation3(entity){return this.serialize(entity,serializeConfigPresentation3)}hydrate(reference,type){return this.get(reference,type,{skipSelfReturn:!1})}get(reference,type,options={}){"string"!=typeof type&&(options=type||{},type=void 0);const{skipSelfReturn=!0}=options||{};if(Array.isArray(reference))return reference.map((i=>this.get(i,options)));const state=this.getState();if("string"==typeof reference){const _type2=type||state.iiif.mapping[reference];if(!_type2)return skipSelfReturn?null:{id:reference,type:"unknown"};reference={id:reference,type:_type2}}const _type=type||reference.type,_id=reference.id,entities=state.iiif.entities[_type];if(!entities){const request=state.iiif.requests[_id];return request&&request.resourceUri!==_id?this.get(request.resourceUri,options):skipSelfReturn?null:reference}return entities[reference.id]||(skipSelfReturn?null:reference)}select(selector){return selector(this.getState())}getStore(){return this.store}getState(){return this.store.getState()}loadManifest(id,json){const _id="string"==typeof id?id:id.id;return this.load(_id,json)}loadCollection(id,json){const _id="string"==typeof id?id:id.id;return this.load(_id,json)}load(id,json){const _id="string"==typeof id?id:id.id;return json?this.staticFetcher(_id,json):this.remoteFetcher(_id)}areInputsEqual(newInputs,lastInputs){return areInputsEqual(newInputs,lastInputs)}subscribe(selector,subscription,skipInitial){void 0!==skipInitial||void 0!==subscription&&!1!==subscription&&!0!==subscription||(skipInitial=subscription,subscription=selector,selector=a=>a);let lastState=skipInitial?null:selector(this.store.getState());return skipInitial||subscription(lastState,this),this.store.subscribe((()=>{const state=this.store.getState(),selectedState=selector(state);lastState===selectedState||areInputsEqual(lastState,selectedState)||subscription(selectedState,this),lastState=selectedState}))}async ensureLoaded(_id){const id="string"==typeof _id?_id:_id.id;this.requestStatus(id)||await this.load(id)}requestStatus(id){return this.select((state=>state.iiif.requests[id]))}getResourceMeta(resource,metaKey){const resourceMeta=this.getState().iiif.meta[resource];if(resourceMeta)return metaKey?resourceMeta[metaKey]:resourceMeta}setMetaValue([id,meta,key],newValueOrUpdate){this.dispatch("function"==typeof newValueOrUpdate?metaActions.setMetaValueDynamic({id,meta,key,updateValue:newValueOrUpdate}):metaActions.setMetaValue({id,meta,key,value:newValueOrUpdate}))}}},"../../node_modules/@radix-ui/number/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function $ae6933e535247d3d$export$7d15b64cf5a3a4c4(value,[min,max]){return Math.min(max,Math.max(min,value))}__webpack_require__.d(__webpack_exports__,{u:()=>$ae6933e535247d3d$export$7d15b64cf5a3a4c4})},"../../node_modules/@radix-ui/primitive/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function $e42e1063c40fb3ef$export$b9ecd428b558ff10(originalEventHandler,ourEventHandler,{checkForDefaultPrevented=!0}={}){return function handleEvent(event){if(null==originalEventHandler||originalEventHandler(event),!1===checkForDefaultPrevented||!event.defaultPrevented)return null==ourEventHandler?void 0:ourEventHandler(event)}}__webpack_require__.d(__webpack_exports__,{M:()=>$e42e1063c40fb3ef$export$b9ecd428b558ff10})},"../../node_modules/@radix-ui/react-arrow/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{f:()=>$7e8f5cd07187803e$export$be92b6f5f03c0fe9});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-primitive/dist/index.mjs");const $7e8f5cd07187803e$export$21b07c8f274aebd5=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{children,width=10,height=5,...arrowProps}=props;return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_1__.WV.svg,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_2__.Z)({},arrowProps,{ref:forwardedRef,width,height,viewBox:"0 0 30 10",preserveAspectRatio:"none"}),props.asChild?children:(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)("polygon",{points:"0,0 30,0 15,10"}))})),$7e8f5cd07187803e$export$be92b6f5f03c0fe9=$7e8f5cd07187803e$export$21b07c8f274aebd5},"../../node_modules/@radix-ui/react-collapsible/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{VY:()=>$409067139f391064$export$7c6e2c02157bb7d2,fC:()=>$409067139f391064$export$be92b6f5f03c0fe9,p_:()=>$409067139f391064$export$952b32dcbe73087a,xz:()=>$409067139f391064$export$41fb9f06171c75f4});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../node_modules/@radix-ui/primitive/dist/index.mjs"),_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-context/dist/index.mjs"),_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-use-controllable-state/dist/index.mjs"),_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../node_modules/@radix-ui/react-use-layout-effect/dist/index.mjs"),_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs"),_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/@radix-ui/react-primitive/dist/index.mjs"),_radix_ui_react_presence__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/@radix-ui/react-presence/dist/index.mjs"),_radix_ui_react_id__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@radix-ui/react-id/dist/index.mjs");const[$409067139f391064$var$createCollapsibleContext,$409067139f391064$export$952b32dcbe73087a]=(0,_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__.b)("Collapsible"),[$409067139f391064$var$CollapsibleProvider,$409067139f391064$var$useCollapsibleContext]=$409067139f391064$var$createCollapsibleContext("Collapsible"),$409067139f391064$export$6eb0f7ddcda6131f=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeCollapsible,open:openProp,defaultOpen,disabled,onOpenChange,...collapsibleProps}=props,[open=!1,setOpen]=(0,_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_2__.T)({prop:openProp,defaultProp:defaultOpen,onChange:onOpenChange});return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($409067139f391064$var$CollapsibleProvider,{scope:__scopeCollapsible,disabled,contentId:(0,_radix_ui_react_id__WEBPACK_IMPORTED_MODULE_3__.M)(),open,onOpenToggle:(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((()=>setOpen((prevOpen=>!prevOpen))),[setOpen])},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_4__.WV.div,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__.Z)({"data-state":$409067139f391064$var$getState(open),"data-disabled":disabled?"":void 0},collapsibleProps,{ref:forwardedRef})))})),$409067139f391064$export$c135dce7b15bbbdc=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeCollapsible,...triggerProps}=props,context=$409067139f391064$var$useCollapsibleContext("CollapsibleTrigger",__scopeCollapsible);return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_4__.WV.button,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__.Z)({type:"button","aria-controls":context.contentId,"aria-expanded":context.open||!1,"data-state":$409067139f391064$var$getState(context.open),"data-disabled":context.disabled?"":void 0,disabled:context.disabled},triggerProps,{ref:forwardedRef,onClick:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_6__.M)(props.onClick,context.onOpenToggle)}))})),$409067139f391064$export$aadde00976f34151=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{forceMount,...contentProps}=props,context=$409067139f391064$var$useCollapsibleContext("CollapsibleContent",props.__scopeCollapsible);return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_presence__WEBPACK_IMPORTED_MODULE_7__.z,{present:forceMount||context.open},(({present})=>(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($409067139f391064$var$CollapsibleContentImpl,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__.Z)({},contentProps,{ref:forwardedRef,present}))))})),$409067139f391064$var$CollapsibleContentImpl=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeCollapsible,present,children,...contentProps}=props,context=$409067139f391064$var$useCollapsibleContext("CollapsibleContent",__scopeCollapsible),[isPresent,setIsPresent]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(present),ref=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),composedRefs=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_8__.e)(forwardedRef,ref),heightRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(0),height=heightRef.current,widthRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(0),width=widthRef.current,isOpen=context.open||isPresent,isMountAnimationPreventedRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(isOpen),originalStylesRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)();return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const rAF=requestAnimationFrame((()=>isMountAnimationPreventedRef.current=!1));return()=>cancelAnimationFrame(rAF)}),[]),(0,_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_9__.b)((()=>{const node=ref.current;if(node){originalStylesRef.current=originalStylesRef.current||{transitionDuration:node.style.transitionDuration,animationName:node.style.animationName},node.style.transitionDuration="0s",node.style.animationName="none";const rect=node.getBoundingClientRect();heightRef.current=rect.height,widthRef.current=rect.width,isMountAnimationPreventedRef.current||(node.style.transitionDuration=originalStylesRef.current.transitionDuration,node.style.animationName=originalStylesRef.current.animationName),setIsPresent(present)}}),[context.open,present]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_4__.WV.div,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__.Z)({"data-state":$409067139f391064$var$getState(context.open),"data-disabled":context.disabled?"":void 0,id:context.contentId,hidden:!isOpen},contentProps,{ref:composedRefs,style:{"--radix-collapsible-content-height":height?`${height}px`:void 0,"--radix-collapsible-content-width":width?`${width}px`:void 0,...props.style}}),isOpen&&children)}));function $409067139f391064$var$getState(open){return open?"open":"closed"}const $409067139f391064$export$be92b6f5f03c0fe9=$409067139f391064$export$6eb0f7ddcda6131f,$409067139f391064$export$41fb9f06171c75f4=$409067139f391064$export$c135dce7b15bbbdc,$409067139f391064$export$7c6e2c02157bb7d2=$409067139f391064$export$aadde00976f34151},"../../node_modules/@radix-ui/react-collection/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{B:()=>$e02a7d9cb1dc128c$export$c74125a8e3af6bb2});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-context/dist/index.mjs"),_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs"),_radix_ui_react_slot__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@radix-ui/react-slot/dist/index.mjs");function $e02a7d9cb1dc128c$export$c74125a8e3af6bb2(name){const PROVIDER_NAME=name+"CollectionProvider",[createCollectionContext,createCollectionScope]=(0,_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__.b)(PROVIDER_NAME),[CollectionProviderImpl,useCollectionContext]=createCollectionContext(PROVIDER_NAME,{collectionRef:{current:null},itemMap:new Map}),CollectionProvider=props=>{const{scope,children}=props,ref=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),itemMap=react__WEBPACK_IMPORTED_MODULE_0__.useRef(new Map).current;return react__WEBPACK_IMPORTED_MODULE_0__.createElement(CollectionProviderImpl,{scope,itemMap,collectionRef:ref},children)},COLLECTION_SLOT_NAME=name+"CollectionSlot",CollectionSlot=react__WEBPACK_IMPORTED_MODULE_0__.forwardRef(((props,forwardedRef)=>{const{scope,children}=props,context=useCollectionContext(COLLECTION_SLOT_NAME,scope),composedRefs=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__.e)(forwardedRef,context.collectionRef);return react__WEBPACK_IMPORTED_MODULE_0__.createElement(_radix_ui_react_slot__WEBPACK_IMPORTED_MODULE_3__.g7,{ref:composedRefs},children)})),ITEM_SLOT_NAME=name+"CollectionItemSlot",CollectionItemSlot=react__WEBPACK_IMPORTED_MODULE_0__.forwardRef(((props,forwardedRef)=>{const{scope,children,...itemData}=props,ref=react__WEBPACK_IMPORTED_MODULE_0__.useRef(null),composedRefs=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__.e)(forwardedRef,ref),context=useCollectionContext(ITEM_SLOT_NAME,scope);return react__WEBPACK_IMPORTED_MODULE_0__.useEffect((()=>(context.itemMap.set(ref,{ref,...itemData}),()=>{context.itemMap.delete(ref)}))),react__WEBPACK_IMPORTED_MODULE_0__.createElement(_radix_ui_react_slot__WEBPACK_IMPORTED_MODULE_3__.g7,{"data-radix-collection-item":"",ref:composedRefs},children)}));return[{Provider:CollectionProvider,Slot:CollectionSlot,ItemSlot:CollectionItemSlot},function useCollection(scope){const context=useCollectionContext(name+"CollectionConsumer",scope);return react__WEBPACK_IMPORTED_MODULE_0__.useCallback((()=>{const collectionNode=context.collectionRef.current;if(!collectionNode)return[];const orderedNodes=Array.from(collectionNode.querySelectorAll("[data-radix-collection-item]"));return Array.from(context.itemMap.values()).sort(((a,b)=>orderedNodes.indexOf(a.ref.current)-orderedNodes.indexOf(b.ref.current)))}),[context.collectionRef,context.itemMap])},createCollectionScope]}},"../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{F:()=>$6ed0406888f73fc4$export$43e446d32b3d21af,e:()=>$6ed0406888f73fc4$export$c7b2cbe3552a0d05});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js");function $6ed0406888f73fc4$export$43e446d32b3d21af(...refs){return node=>refs.forEach((ref=>function $6ed0406888f73fc4$var$setRef(ref,value){"function"==typeof ref?ref(value):null!=ref&&(ref.current=value)}(ref,node)))}function $6ed0406888f73fc4$export$c7b2cbe3552a0d05(...refs){return(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)($6ed0406888f73fc4$export$43e446d32b3d21af(...refs),refs)}},"../../node_modules/@radix-ui/react-context/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{b:()=>$c512c27ab02ef895$export$50c7b4e9d9f19c1,k:()=>$c512c27ab02ef895$export$fd42f52fd3ae1109});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js");function $c512c27ab02ef895$export$fd42f52fd3ae1109(rootComponentName,defaultContext){const Context=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)(defaultContext);function Provider(props){const{children,...context}=props,value=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>context),Object.values(context));return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(Context.Provider,{value},children)}return Provider.displayName=rootComponentName+"Provider",[Provider,function useContext(consumerName){const context=(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(Context);if(context)return context;if(void 0!==defaultContext)return defaultContext;throw new Error(`\`${consumerName}\` must be used within \`${rootComponentName}\``)}]}function $c512c27ab02ef895$export$50c7b4e9d9f19c1(scopeName,createContextScopeDeps=[]){let defaultContexts=[];const createScope=()=>{const scopeContexts=defaultContexts.map((defaultContext=>(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)(defaultContext)));return function useScope(scope){const contexts=(null==scope?void 0:scope[scopeName])||scopeContexts;return(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>({[`__scope${scopeName}`]:{...scope,[scopeName]:contexts}})),[scope,contexts])}};return createScope.scopeName=scopeName,[function $c512c27ab02ef895$export$fd42f52fd3ae1109(rootComponentName,defaultContext){const BaseContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)(defaultContext),index=defaultContexts.length;function Provider(props){const{scope,children,...context}=props,Context=(null==scope?void 0:scope[scopeName][index])||BaseContext,value=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>context),Object.values(context));return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(Context.Provider,{value},children)}return defaultContexts=[...defaultContexts,defaultContext],Provider.displayName=rootComponentName+"Provider",[Provider,function useContext(consumerName,scope){const Context=(null==scope?void 0:scope[scopeName][index])||BaseContext,context=(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(Context);if(context)return context;if(void 0!==defaultContext)return defaultContext;throw new Error(`\`${consumerName}\` must be used within \`${rootComponentName}\``)}]},$c512c27ab02ef895$var$composeContextScopes(createScope,...createContextScopeDeps)]}function $c512c27ab02ef895$var$composeContextScopes(...scopes){const baseScope=scopes[0];if(1===scopes.length)return baseScope;const createScope1=()=>{const scopeHooks=scopes.map((createScope=>({useScope:createScope(),scopeName:createScope.scopeName})));return function useComposedScopes(overrideScopes){const nextScopes1=scopeHooks.reduce(((nextScopes,{useScope,scopeName})=>({...nextScopes,...useScope(overrideScopes)[`__scope${scopeName}`]})),{});return(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>({[`__scope${baseScope.scopeName}`]:nextScopes1})),[nextScopes1])}};return createScope1.scopeName=baseScope.scopeName,createScope1}},"../../node_modules/@radix-ui/react-direction/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{gm:()=>$f631663db3294ace$export$b39126d51d94e6f3});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js");const $f631663db3294ace$var$DirectionContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)(void 0);function $f631663db3294ace$export$b39126d51d94e6f3(localDir){const globalDir=(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)($f631663db3294ace$var$DirectionContext);return localDir||globalDir||"ltr"}},"../../node_modules/@radix-ui/react-focus-guards/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{EW:()=>$3db38b7d1fb3fe6a$export$b7ece24a22aeda8c});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js");let $3db38b7d1fb3fe6a$var$count=0;function $3db38b7d1fb3fe6a$export$b7ece24a22aeda8c(){(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{var _edgeGuards$,_edgeGuards$2;const edgeGuards=document.querySelectorAll("[data-radix-focus-guard]");return document.body.insertAdjacentElement("afterbegin",null!==(_edgeGuards$=edgeGuards[0])&&void 0!==_edgeGuards$?_edgeGuards$:$3db38b7d1fb3fe6a$var$createFocusGuard()),document.body.insertAdjacentElement("beforeend",null!==(_edgeGuards$2=edgeGuards[1])&&void 0!==_edgeGuards$2?_edgeGuards$2:$3db38b7d1fb3fe6a$var$createFocusGuard()),$3db38b7d1fb3fe6a$var$count++,()=>{1===$3db38b7d1fb3fe6a$var$count&&document.querySelectorAll("[data-radix-focus-guard]").forEach((node=>node.remove())),$3db38b7d1fb3fe6a$var$count--}}),[])}function $3db38b7d1fb3fe6a$var$createFocusGuard(){const element=document.createElement("span");return element.setAttribute("data-radix-focus-guard",""),element.tabIndex=0,element.style.cssText="outline: none; opacity: 0; position: fixed; pointer-events: none",element}},"../../node_modules/@radix-ui/react-id/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";var react__WEBPACK_IMPORTED_MODULE_0___namespace_cache;__webpack_require__.d(__webpack_exports__,{M:()=>$1746a345f3d73bb7$export$f680877a34711e37});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-use-layout-effect/dist/index.mjs");const $1746a345f3d73bb7$var$useReactId=(react__WEBPACK_IMPORTED_MODULE_0___namespace_cache||(react__WEBPACK_IMPORTED_MODULE_0___namespace_cache=__webpack_require__.t(react__WEBPACK_IMPORTED_MODULE_0__,2)))["useId".toString()]||(()=>{});let $1746a345f3d73bb7$var$count=0;function $1746a345f3d73bb7$export$f680877a34711e37(deterministicId){const[id,setId]=react__WEBPACK_IMPORTED_MODULE_0__.useState($1746a345f3d73bb7$var$useReactId());return(0,_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_1__.b)((()=>{deterministicId||setId((reactId=>null!=reactId?reactId:String($1746a345f3d73bb7$var$count++)))}),[deterministicId]),deterministicId||(id?`radix-${id}`:"")}},"../../node_modules/@radix-ui/react-presence/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{z:()=>$921a889cee6df7e8$export$99c2b779aa4e8b8b});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),react_dom__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/react-dom/index.js"),_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs"),_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@radix-ui/react-use-layout-effect/dist/index.mjs");const $921a889cee6df7e8$export$99c2b779aa4e8b8b=props=>{const{present,children}=props,presence=function $921a889cee6df7e8$var$usePresence(present){const[node1,setNode]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(),stylesRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)({}),prevPresentRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(present),prevAnimationNameRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)("none"),initialState=present?"mounted":"unmounted",[state,send]=function $fe963b355347cc68$export$3e6543de14f8614f(initialState,machine){return(0,react__WEBPACK_IMPORTED_MODULE_0__.useReducer)(((state,event)=>{const nextState=machine[state][event];return null!=nextState?nextState:state}),initialState)}(initialState,{mounted:{UNMOUNT:"unmounted",ANIMATION_OUT:"unmountSuspended"},unmountSuspended:{MOUNT:"mounted",ANIMATION_END:"unmounted"},unmounted:{MOUNT:"mounted"}});return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const currentAnimationName=$921a889cee6df7e8$var$getAnimationName(stylesRef.current);prevAnimationNameRef.current="mounted"===state?currentAnimationName:"none"}),[state]),(0,_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_3__.b)((()=>{const styles=stylesRef.current,wasPresent=prevPresentRef.current;if(wasPresent!==present){const prevAnimationName=prevAnimationNameRef.current,currentAnimationName=$921a889cee6df7e8$var$getAnimationName(styles);if(present)send("MOUNT");else if("none"===currentAnimationName||"none"===(null==styles?void 0:styles.display))send("UNMOUNT");else{send(wasPresent&&prevAnimationName!==currentAnimationName?"ANIMATION_OUT":"UNMOUNT")}prevPresentRef.current=present}}),[present,send]),(0,_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_3__.b)((()=>{if(node1){const handleAnimationEnd=event=>{const isCurrentAnimation=$921a889cee6df7e8$var$getAnimationName(stylesRef.current).includes(event.animationName);event.target===node1&&isCurrentAnimation&&(0,react_dom__WEBPACK_IMPORTED_MODULE_1__.flushSync)((()=>send("ANIMATION_END")))},handleAnimationStart=event=>{event.target===node1&&(prevAnimationNameRef.current=$921a889cee6df7e8$var$getAnimationName(stylesRef.current))};return node1.addEventListener("animationstart",handleAnimationStart),node1.addEventListener("animationcancel",handleAnimationEnd),node1.addEventListener("animationend",handleAnimationEnd),()=>{node1.removeEventListener("animationstart",handleAnimationStart),node1.removeEventListener("animationcancel",handleAnimationEnd),node1.removeEventListener("animationend",handleAnimationEnd)}}send("ANIMATION_END")}),[node1,send]),{isPresent:["mounted","unmountSuspended"].includes(state),ref:(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((node=>{node&&(stylesRef.current=getComputedStyle(node)),setNode(node)}),[])}}(present),child="function"==typeof children?children({present:presence.isPresent}):react__WEBPACK_IMPORTED_MODULE_0__.Children.only(children),ref=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__.e)(presence.ref,child.ref);return"function"==typeof children||presence.isPresent?(0,react__WEBPACK_IMPORTED_MODULE_0__.cloneElement)(child,{ref}):null};function $921a889cee6df7e8$var$getAnimationName(styles){return(null==styles?void 0:styles.animationName)||"none"}$921a889cee6df7e8$export$99c2b779aa4e8b8b.displayName="Presence"},"../../node_modules/@radix-ui/react-primitive/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{WV:()=>$8927f6f2acc4f386$export$250ffa63cdc0d034,jH:()=>$8927f6f2acc4f386$export$6d1a0317bde7de7f});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),react_dom__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/react-dom/index.js"),_radix_ui_react_slot__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-slot/dist/index.mjs");const $8927f6f2acc4f386$export$250ffa63cdc0d034=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","span","svg","ul"].reduce(((primitive,node)=>{const Node=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{asChild,...primitiveProps}=props,Comp=asChild?_radix_ui_react_slot__WEBPACK_IMPORTED_MODULE_2__.g7:node;return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{window[Symbol.for("radix-ui")]=!0}),[]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(Comp,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_3__.Z)({},primitiveProps,{ref:forwardedRef}))}));return Node.displayName=`Primitive.${node}`,{...primitive,[node]:Node}}),{});function $8927f6f2acc4f386$export$6d1a0317bde7de7f(target,event){target&&(0,react_dom__WEBPACK_IMPORTED_MODULE_1__.flushSync)((()=>target.dispatchEvent(event)))}},"../../node_modules/@radix-ui/react-radio-group/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{ck:()=>$f99a8c78507165f7$export$6d08773d2e66f8f2,fC:()=>$f99a8c78507165f7$export$be92b6f5f03c0fe9});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../node_modules/@radix-ui/primitive/dist/index.mjs"),_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs"),_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-context/dist/index.mjs"),_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@radix-ui/react-primitive/dist/index.mjs"),_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../node_modules/@radix-ui/react-roving-focus/dist/index.mjs"),_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("../../node_modules/@radix-ui/react-use-controllable-state/dist/index.mjs"),_radix_ui_react_direction__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../node_modules/@radix-ui/react-direction/dist/index.mjs"),_radix_ui_react_use_size__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../node_modules/@radix-ui/react-use-size/dist/index.mjs"),_radix_ui_react_use_previous__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/@radix-ui/react-use-previous/dist/index.mjs");__webpack_require__("../../node_modules/@radix-ui/react-presence/dist/index.mjs");const[$ce77a8961b41be9e$var$createRadioContext,$ce77a8961b41be9e$export$67d2296460f1b002]=(0,_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__.b)("Radio"),[$ce77a8961b41be9e$var$RadioProvider,$ce77a8961b41be9e$var$useRadioContext]=$ce77a8961b41be9e$var$createRadioContext("Radio"),$ce77a8961b41be9e$export$d7b12c4107be0d61=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeRadio,name,checked=!1,required,disabled,value="on",onCheck,...radioProps}=props,[button,setButton]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(null),composedRefs=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__.e)(forwardedRef,(node=>setButton(node))),hasConsumerStoppedPropagationRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(!1),isFormControl=!button||Boolean(button.closest("form"));return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($ce77a8961b41be9e$var$RadioProvider,{scope:__scopeRadio,checked,disabled},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_3__.WV.button,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_4__.Z)({type:"button",role:"radio","aria-checked":checked,"data-state":$ce77a8961b41be9e$var$getState(checked),"data-disabled":disabled?"":void 0,disabled,value},radioProps,{ref:composedRefs,onClick:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_5__.M)(props.onClick,(event=>{checked||null==onCheck||onCheck(),isFormControl&&(hasConsumerStoppedPropagationRef.current=event.isPropagationStopped(),hasConsumerStoppedPropagationRef.current||event.stopPropagation())}))})),isFormControl&&(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($ce77a8961b41be9e$var$BubbleInput,{control:button,bubbles:!hasConsumerStoppedPropagationRef.current,name,value,checked,required,disabled,style:{transform:"translateX(-100%)"}}))})),$ce77a8961b41be9e$var$BubbleInput=props=>{const{control,checked,bubbles=!0,...inputProps}=props,ref=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),prevChecked=(0,_radix_ui_react_use_previous__WEBPACK_IMPORTED_MODULE_7__.D)(checked),controlSize=(0,_radix_ui_react_use_size__WEBPACK_IMPORTED_MODULE_8__.t)(control);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const input=ref.current,inputProto=window.HTMLInputElement.prototype,setChecked=Object.getOwnPropertyDescriptor(inputProto,"checked").set;if(prevChecked!==checked&&setChecked){const event=new Event("click",{bubbles});setChecked.call(input,checked),input.dispatchEvent(event)}}),[prevChecked,checked,bubbles]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)("input",(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_4__.Z)({type:"radio","aria-hidden":!0,defaultChecked:checked},inputProps,{tabIndex:-1,ref,style:{...props.style,...controlSize,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function $ce77a8961b41be9e$var$getState(checked){return checked?"checked":"unchecked"}const $f99a8c78507165f7$var$ARROW_KEYS=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],[$f99a8c78507165f7$var$createRadioGroupContext,$f99a8c78507165f7$export$c547093f11b76da2]=(0,_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__.b)("RadioGroup",[_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_9__.Pc,$ce77a8961b41be9e$export$67d2296460f1b002]),$f99a8c78507165f7$var$useRovingFocusGroupScope=(0,_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_9__.Pc)(),$f99a8c78507165f7$var$useRadioScope=$ce77a8961b41be9e$export$67d2296460f1b002(),[$f99a8c78507165f7$var$RadioGroupProvider,$f99a8c78507165f7$var$useRadioGroupContext]=$f99a8c78507165f7$var$createRadioGroupContext("RadioGroup"),$f99a8c78507165f7$export$a98f0dcb43a68a25=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeRadioGroup,name,defaultValue,value:valueProp,required=!1,disabled=!1,orientation,dir,loop=!0,onValueChange,...groupProps}=props,rovingFocusGroupScope=$f99a8c78507165f7$var$useRovingFocusGroupScope(__scopeRadioGroup),direction=(0,_radix_ui_react_direction__WEBPACK_IMPORTED_MODULE_10__.gm)(dir),[value,setValue]=(0,_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_11__.T)({prop:valueProp,defaultProp:defaultValue,onChange:onValueChange});return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($f99a8c78507165f7$var$RadioGroupProvider,{scope:__scopeRadioGroup,name,required,disabled,value,onValueChange:setValue},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_9__.fC,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_4__.Z)({asChild:!0},rovingFocusGroupScope,{orientation,dir:direction,loop}),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_3__.WV.div,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_4__.Z)({role:"radiogroup","aria-required":required,"aria-orientation":orientation,"data-disabled":disabled?"":void 0,dir:direction},groupProps,{ref:forwardedRef}))))})),$f99a8c78507165f7$export$9f866c100ef519e4=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeRadioGroup,disabled,...itemProps}=props,context=$f99a8c78507165f7$var$useRadioGroupContext("RadioGroupItem",__scopeRadioGroup),isDisabled=context.disabled||disabled,rovingFocusGroupScope=$f99a8c78507165f7$var$useRovingFocusGroupScope(__scopeRadioGroup),radioScope=$f99a8c78507165f7$var$useRadioScope(__scopeRadioGroup),ref=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),composedRefs=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__.e)(forwardedRef,ref),checked=context.value===itemProps.value,isArrowKeyPressedRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(!1);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const handleKeyDown=event=>{$f99a8c78507165f7$var$ARROW_KEYS.includes(event.key)&&(isArrowKeyPressedRef.current=!0)},handleKeyUp=()=>isArrowKeyPressedRef.current=!1;return document.addEventListener("keydown",handleKeyDown),document.addEventListener("keyup",handleKeyUp),()=>{document.removeEventListener("keydown",handleKeyDown),document.removeEventListener("keyup",handleKeyUp)}}),[]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_9__.ck,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_4__.Z)({asChild:!0},rovingFocusGroupScope,{focusable:!isDisabled,active:checked}),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($ce77a8961b41be9e$export$d7b12c4107be0d61,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_4__.Z)({disabled:isDisabled,required:context.required,checked},radioScope,itemProps,{name:context.name,ref:composedRefs,onCheck:()=>context.onValueChange(itemProps.value),onKeyDown:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_5__.M)((event=>{"Enter"===event.key&&event.preventDefault()})),onFocus:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_5__.M)(itemProps.onFocus,(()=>{var _ref$current;isArrowKeyPressedRef.current&&(null===(_ref$current=ref.current)||void 0===_ref$current||_ref$current.click())}))})))})),$f99a8c78507165f7$export$be92b6f5f03c0fe9=$f99a8c78507165f7$export$a98f0dcb43a68a25,$f99a8c78507165f7$export$6d08773d2e66f8f2=$f99a8c78507165f7$export$9f866c100ef519e4},"../../node_modules/@radix-ui/react-roving-focus/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Pc:()=>$d7bdfb9eb0fdf311$export$c7109489551a4f4,ck:()=>$d7bdfb9eb0fdf311$export$6d08773d2e66f8f2,fC:()=>$d7bdfb9eb0fdf311$export$be92b6f5f03c0fe9});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../node_modules/@radix-ui/primitive/dist/index.mjs"),_radix_ui_react_collection__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-collection/dist/index.mjs"),_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs"),_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-context/dist/index.mjs"),_radix_ui_react_id__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("../../node_modules/@radix-ui/react-id/dist/index.mjs"),_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../node_modules/@radix-ui/react-primitive/dist/index.mjs"),_radix_ui_react_use_callback_ref__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/@radix-ui/react-use-callback-ref/dist/index.mjs"),_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../node_modules/@radix-ui/react-use-controllable-state/dist/index.mjs"),_radix_ui_react_direction__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../node_modules/@radix-ui/react-direction/dist/index.mjs");const $d7bdfb9eb0fdf311$var$EVENT_OPTIONS={bubbles:!1,cancelable:!0},[$d7bdfb9eb0fdf311$var$Collection,$d7bdfb9eb0fdf311$var$useCollection,$d7bdfb9eb0fdf311$var$createCollectionScope]=(0,_radix_ui_react_collection__WEBPACK_IMPORTED_MODULE_1__.B)("RovingFocusGroup"),[$d7bdfb9eb0fdf311$var$createRovingFocusGroupContext,$d7bdfb9eb0fdf311$export$c7109489551a4f4]=(0,_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_2__.b)("RovingFocusGroup",[$d7bdfb9eb0fdf311$var$createCollectionScope]),[$d7bdfb9eb0fdf311$var$RovingFocusProvider,$d7bdfb9eb0fdf311$var$useRovingFocusContext]=$d7bdfb9eb0fdf311$var$createRovingFocusGroupContext("RovingFocusGroup"),$d7bdfb9eb0fdf311$export$8699f7c8af148338=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($d7bdfb9eb0fdf311$var$Collection.Provider,{scope:props.__scopeRovingFocusGroup},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($d7bdfb9eb0fdf311$var$Collection.Slot,{scope:props.__scopeRovingFocusGroup},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($d7bdfb9eb0fdf311$var$RovingFocusGroupImpl,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_3__.Z)({},props,{ref:forwardedRef})))))),$d7bdfb9eb0fdf311$var$RovingFocusGroupImpl=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeRovingFocusGroup,orientation,loop=!1,dir,currentTabStopId:currentTabStopIdProp,defaultCurrentTabStopId,onCurrentTabStopIdChange,onEntryFocus,...groupProps}=props,ref=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),composedRefs=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_4__.e)(forwardedRef,ref),direction=(0,_radix_ui_react_direction__WEBPACK_IMPORTED_MODULE_5__.gm)(dir),[currentTabStopId=null,setCurrentTabStopId]=(0,_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_6__.T)({prop:currentTabStopIdProp,defaultProp:defaultCurrentTabStopId,onChange:onCurrentTabStopIdChange}),[isTabbingBackOut,setIsTabbingBackOut]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(!1),handleEntryFocus=(0,_radix_ui_react_use_callback_ref__WEBPACK_IMPORTED_MODULE_7__.W)(onEntryFocus),getItems=$d7bdfb9eb0fdf311$var$useCollection(__scopeRovingFocusGroup),isClickFocusRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(!1),[focusableItemsCount,setFocusableItemsCount]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(0);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const node=ref.current;if(node)return node.addEventListener("rovingFocusGroup.onEntryFocus",handleEntryFocus),()=>node.removeEventListener("rovingFocusGroup.onEntryFocus",handleEntryFocus)}),[handleEntryFocus]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($d7bdfb9eb0fdf311$var$RovingFocusProvider,{scope:__scopeRovingFocusGroup,orientation,dir:direction,loop,currentTabStopId,onItemFocus:(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((tabStopId=>setCurrentTabStopId(tabStopId)),[setCurrentTabStopId]),onItemShiftTab:(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((()=>setIsTabbingBackOut(!0)),[]),onFocusableItemAdd:(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((()=>setFocusableItemsCount((prevCount=>prevCount+1))),[]),onFocusableItemRemove:(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((()=>setFocusableItemsCount((prevCount=>prevCount-1))),[])},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_8__.WV.div,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_3__.Z)({tabIndex:isTabbingBackOut||0===focusableItemsCount?-1:0,"data-orientation":orientation},groupProps,{ref:composedRefs,style:{outline:"none",...props.style},onMouseDown:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_9__.M)(props.onMouseDown,(()=>{isClickFocusRef.current=!0})),onFocus:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_9__.M)(props.onFocus,(event=>{const isKeyboardFocus=!isClickFocusRef.current;if(event.target===event.currentTarget&&isKeyboardFocus&&!isTabbingBackOut){const entryFocusEvent=new CustomEvent("rovingFocusGroup.onEntryFocus",$d7bdfb9eb0fdf311$var$EVENT_OPTIONS);if(event.currentTarget.dispatchEvent(entryFocusEvent),!entryFocusEvent.defaultPrevented){const items=getItems().filter((item=>item.focusable));$d7bdfb9eb0fdf311$var$focusFirst([items.find((item=>item.active)),items.find((item=>item.id===currentTabStopId)),...items].filter(Boolean).map((item=>item.ref.current)))}}isClickFocusRef.current=!1})),onBlur:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_9__.M)(props.onBlur,(()=>setIsTabbingBackOut(!1)))})))})),$d7bdfb9eb0fdf311$export$ab9df7c53fe8454=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeRovingFocusGroup,focusable=!0,active=!1,tabStopId,...itemProps}=props,autoId=(0,_radix_ui_react_id__WEBPACK_IMPORTED_MODULE_10__.M)(),id=tabStopId||autoId,context=$d7bdfb9eb0fdf311$var$useRovingFocusContext("RovingFocusGroupItem",__scopeRovingFocusGroup),isCurrentTabStop=context.currentTabStopId===id,getItems=$d7bdfb9eb0fdf311$var$useCollection(__scopeRovingFocusGroup),{onFocusableItemAdd,onFocusableItemRemove}=context;return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{if(focusable)return onFocusableItemAdd(),()=>onFocusableItemRemove()}),[focusable,onFocusableItemAdd,onFocusableItemRemove]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($d7bdfb9eb0fdf311$var$Collection.ItemSlot,{scope:__scopeRovingFocusGroup,id,focusable,active},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_8__.WV.span,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_3__.Z)({tabIndex:isCurrentTabStop?0:-1,"data-orientation":context.orientation},itemProps,{ref:forwardedRef,onMouseDown:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_9__.M)(props.onMouseDown,(event=>{focusable?context.onItemFocus(id):event.preventDefault()})),onFocus:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_9__.M)(props.onFocus,(()=>context.onItemFocus(id))),onKeyDown:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_9__.M)(props.onKeyDown,(event=>{if("Tab"===event.key&&event.shiftKey)return void context.onItemShiftTab();if(event.target!==event.currentTarget)return;const focusIntent=function $d7bdfb9eb0fdf311$var$getFocusIntent(event,orientation,dir){const key=function $d7bdfb9eb0fdf311$var$getDirectionAwareKey(key,dir){return"rtl"!==dir?key:"ArrowLeft"===key?"ArrowRight":"ArrowRight"===key?"ArrowLeft":key}(event.key,dir);return"vertical"===orientation&&["ArrowLeft","ArrowRight"].includes(key)||"horizontal"===orientation&&["ArrowUp","ArrowDown"].includes(key)?void 0:$d7bdfb9eb0fdf311$var$MAP_KEY_TO_FOCUS_INTENT[key]}(event,context.orientation,context.dir);if(void 0!==focusIntent){event.preventDefault();let candidateNodes=getItems().filter((item=>item.focusable)).map((item=>item.ref.current));if("last"===focusIntent)candidateNodes.reverse();else if("prev"===focusIntent||"next"===focusIntent){"prev"===focusIntent&&candidateNodes.reverse();const currentIndex=candidateNodes.indexOf(event.currentTarget);candidateNodes=context.loop?function $d7bdfb9eb0fdf311$var$wrapArray(array,startIndex){return array.map(((_,index)=>array[(startIndex+index)%array.length]))}(candidateNodes,currentIndex+1):candidateNodes.slice(currentIndex+1)}setTimeout((()=>$d7bdfb9eb0fdf311$var$focusFirst(candidateNodes)))}}))})))})),$d7bdfb9eb0fdf311$var$MAP_KEY_TO_FOCUS_INTENT={ArrowLeft:"prev",ArrowUp:"prev",ArrowRight:"next",ArrowDown:"next",PageUp:"first",Home:"first",PageDown:"last",End:"last"};function $d7bdfb9eb0fdf311$var$focusFirst(candidates){const PREVIOUSLY_FOCUSED_ELEMENT=document.activeElement;for(const candidate of candidates){if(candidate===PREVIOUSLY_FOCUSED_ELEMENT)return;if(candidate.focus(),document.activeElement!==PREVIOUSLY_FOCUSED_ELEMENT)return}}const $d7bdfb9eb0fdf311$export$be92b6f5f03c0fe9=$d7bdfb9eb0fdf311$export$8699f7c8af148338,$d7bdfb9eb0fdf311$export$6d08773d2e66f8f2=$d7bdfb9eb0fdf311$export$ab9df7c53fe8454},"../../node_modules/@radix-ui/react-slot/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{g7:()=>$5e63c961fc1ce211$export$8c6ed5c666ac1360});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs");const $5e63c961fc1ce211$export$8c6ed5c666ac1360=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{children,...slotProps}=props,childrenArray=react__WEBPACK_IMPORTED_MODULE_0__.Children.toArray(children),slottable=childrenArray.find($5e63c961fc1ce211$var$isSlottable);if(slottable){const newElement=slottable.props.children,newChildren=childrenArray.map((child=>child===slottable?react__WEBPACK_IMPORTED_MODULE_0__.Children.count(newElement)>1?react__WEBPACK_IMPORTED_MODULE_0__.Children.only(null):(0,react__WEBPACK_IMPORTED_MODULE_0__.isValidElement)(newElement)?newElement.props.children:null:child));return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($5e63c961fc1ce211$var$SlotClone,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_1__.Z)({},slotProps,{ref:forwardedRef}),(0,react__WEBPACK_IMPORTED_MODULE_0__.isValidElement)(newElement)?(0,react__WEBPACK_IMPORTED_MODULE_0__.cloneElement)(newElement,void 0,newChildren):null)}return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($5e63c961fc1ce211$var$SlotClone,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_1__.Z)({},slotProps,{ref:forwardedRef}),children)}));$5e63c961fc1ce211$export$8c6ed5c666ac1360.displayName="Slot";const $5e63c961fc1ce211$var$SlotClone=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{children,...slotProps}=props;return(0,react__WEBPACK_IMPORTED_MODULE_0__.isValidElement)(children)?(0,react__WEBPACK_IMPORTED_MODULE_0__.cloneElement)(children,{...$5e63c961fc1ce211$var$mergeProps(slotProps,children.props),ref:forwardedRef?(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__.F)(forwardedRef,children.ref):children.ref}):react__WEBPACK_IMPORTED_MODULE_0__.Children.count(children)>1?react__WEBPACK_IMPORTED_MODULE_0__.Children.only(null):null}));$5e63c961fc1ce211$var$SlotClone.displayName="SlotClone";const $5e63c961fc1ce211$export$d9f1ccf0bdb05d45=({children})=>(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(react__WEBPACK_IMPORTED_MODULE_0__.Fragment,null,children);function $5e63c961fc1ce211$var$isSlottable(child){return(0,react__WEBPACK_IMPORTED_MODULE_0__.isValidElement)(child)&&child.type===$5e63c961fc1ce211$export$d9f1ccf0bdb05d45}function $5e63c961fc1ce211$var$mergeProps(slotProps,childProps){const overrideProps={...childProps};for(const propName in childProps){const slotPropValue=slotProps[propName],childPropValue=childProps[propName];/^on[A-Z]/.test(propName)?slotPropValue&&childPropValue?overrideProps[propName]=(...args)=>{childPropValue(...args),slotPropValue(...args)}:slotPropValue&&(overrideProps[propName]=slotPropValue):"style"===propName?overrideProps[propName]={...slotPropValue,...childPropValue}:"className"===propName&&(overrideProps[propName]=[slotPropValue,childPropValue].filter(Boolean).join(" "))}return{...slotProps,...overrideProps}}},"../../node_modules/@radix-ui/react-switch/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{bU:()=>$6be4966fd9bbc698$export$6521433ed15a34db,fC:()=>$6be4966fd9bbc698$export$be92b6f5f03c0fe9});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../node_modules/@radix-ui/primitive/dist/index.mjs"),_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-compose-refs/dist/index.mjs"),_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-context/dist/index.mjs"),_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@radix-ui/react-use-controllable-state/dist/index.mjs"),_radix_ui_react_use_previous__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/@radix-ui/react-use-previous/dist/index.mjs"),_radix_ui_react_use_size__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../node_modules/@radix-ui/react-use-size/dist/index.mjs"),_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/@radix-ui/react-primitive/dist/index.mjs");const[$6be4966fd9bbc698$var$createSwitchContext,$6be4966fd9bbc698$export$cf7f5f17f69cbd43]=(0,_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__.b)("Switch"),[$6be4966fd9bbc698$var$SwitchProvider,$6be4966fd9bbc698$var$useSwitchContext]=$6be4966fd9bbc698$var$createSwitchContext("Switch"),$6be4966fd9bbc698$export$b5d5cf8927ab7262=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeSwitch,name,checked:checkedProp,defaultChecked,required,disabled,value="on",onCheckedChange,...switchProps}=props,[button,setButton]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(null),composedRefs=(0,_radix_ui_react_compose_refs__WEBPACK_IMPORTED_MODULE_2__.e)(forwardedRef,(node=>setButton(node))),hasConsumerStoppedPropagationRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(!1),isFormControl=!button||Boolean(button.closest("form")),[checked=!1,setChecked]=(0,_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_3__.T)({prop:checkedProp,defaultProp:defaultChecked,onChange:onCheckedChange});return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($6be4966fd9bbc698$var$SwitchProvider,{scope:__scopeSwitch,checked,disabled},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_4__.WV.button,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__.Z)({type:"button",role:"switch","aria-checked":checked,"aria-required":required,"data-state":$6be4966fd9bbc698$var$getState(checked),"data-disabled":disabled?"":void 0,disabled,value},switchProps,{ref:composedRefs,onClick:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_6__.M)(props.onClick,(event=>{setChecked((prevChecked=>!prevChecked)),isFormControl&&(hasConsumerStoppedPropagationRef.current=event.isPropagationStopped(),hasConsumerStoppedPropagationRef.current||event.stopPropagation())}))})),isFormControl&&(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($6be4966fd9bbc698$var$BubbleInput,{control:button,bubbles:!hasConsumerStoppedPropagationRef.current,name,value,checked,required,disabled,style:{transform:"translateX(-100%)"}}))})),$6be4966fd9bbc698$export$4d07bf653ea69106=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeSwitch,...thumbProps}=props,context=$6be4966fd9bbc698$var$useSwitchContext("SwitchThumb",__scopeSwitch);return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_4__.WV.span,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__.Z)({"data-state":$6be4966fd9bbc698$var$getState(context.checked),"data-disabled":context.disabled?"":void 0},thumbProps,{ref:forwardedRef}))})),$6be4966fd9bbc698$var$BubbleInput=props=>{const{control,checked,bubbles=!0,...inputProps}=props,ref=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),prevChecked=(0,_radix_ui_react_use_previous__WEBPACK_IMPORTED_MODULE_7__.D)(checked),controlSize=(0,_radix_ui_react_use_size__WEBPACK_IMPORTED_MODULE_8__.t)(control);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const input=ref.current,inputProto=window.HTMLInputElement.prototype,setChecked=Object.getOwnPropertyDescriptor(inputProto,"checked").set;if(prevChecked!==checked&&setChecked){const event=new Event("click",{bubbles});setChecked.call(input,checked),input.dispatchEvent(event)}}),[prevChecked,checked,bubbles]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)("input",(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_5__.Z)({type:"checkbox","aria-hidden":!0,defaultChecked:checked},inputProps,{tabIndex:-1,ref,style:{...props.style,...controlSize,position:"absolute",pointerEvents:"none",opacity:0,margin:0}}))};function $6be4966fd9bbc698$var$getState(checked){return checked?"checked":"unchecked"}const $6be4966fd9bbc698$export$be92b6f5f03c0fe9=$6be4966fd9bbc698$export$b5d5cf8927ab7262,$6be4966fd9bbc698$export$6521433ed15a34db=$6be4966fd9bbc698$export$4d07bf653ea69106},"../../node_modules/@radix-ui/react-tabs/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{VY:()=>$69cb30bb0017df05$export$7c6e2c02157bb7d2,aV:()=>$69cb30bb0017df05$export$54c2e3dc7acea9f5,fC:()=>$69cb30bb0017df05$export$be92b6f5f03c0fe9,xz:()=>$69cb30bb0017df05$export$41fb9f06171c75f4});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("../../node_modules/@radix-ui/primitive/dist/index.mjs"),_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-context/dist/index.mjs"),_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@radix-ui/react-roving-focus/dist/index.mjs"),_radix_ui_react_presence__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("../../node_modules/@radix-ui/react-presence/dist/index.mjs"),_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("../../node_modules/@radix-ui/react-primitive/dist/index.mjs"),_radix_ui_react_direction__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../node_modules/@radix-ui/react-direction/dist/index.mjs"),_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../node_modules/@radix-ui/react-use-controllable-state/dist/index.mjs"),_radix_ui_react_id__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../node_modules/@radix-ui/react-id/dist/index.mjs");const[$69cb30bb0017df05$var$createTabsContext,$69cb30bb0017df05$export$355f5bd209d7b13a]=(0,_radix_ui_react_context__WEBPACK_IMPORTED_MODULE_1__.b)("Tabs",[_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_2__.Pc]),$69cb30bb0017df05$var$useRovingFocusGroupScope=(0,_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_2__.Pc)(),[$69cb30bb0017df05$var$TabsProvider,$69cb30bb0017df05$var$useTabsContext]=$69cb30bb0017df05$var$createTabsContext("Tabs"),$69cb30bb0017df05$export$b2539bed5023c21c=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeTabs,value:valueProp,onValueChange,defaultValue,orientation="horizontal",dir,activationMode="automatic",...tabsProps}=props,direction=(0,_radix_ui_react_direction__WEBPACK_IMPORTED_MODULE_3__.gm)(dir),[value,setValue]=(0,_radix_ui_react_use_controllable_state__WEBPACK_IMPORTED_MODULE_4__.T)({prop:valueProp,onChange:onValueChange,defaultProp:defaultValue});return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)($69cb30bb0017df05$var$TabsProvider,{scope:__scopeTabs,baseId:(0,_radix_ui_react_id__WEBPACK_IMPORTED_MODULE_5__.M)(),value,onValueChange:setValue,orientation,dir:direction,activationMode},(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_6__.WV.div,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_7__.Z)({dir:direction,"data-orientation":orientation},tabsProps,{ref:forwardedRef})))})),$69cb30bb0017df05$export$9712d22edc0d78c1=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeTabs,loop=!0,...listProps}=props,context=$69cb30bb0017df05$var$useTabsContext("TabsList",__scopeTabs),rovingFocusGroupScope=$69cb30bb0017df05$var$useRovingFocusGroupScope(__scopeTabs);return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_2__.fC,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_7__.Z)({asChild:!0},rovingFocusGroupScope,{orientation:context.orientation,dir:context.dir,loop}),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_6__.WV.div,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_7__.Z)({role:"tablist","aria-orientation":context.orientation},listProps,{ref:forwardedRef})))})),$69cb30bb0017df05$export$8114b9fdfdf9f3ba=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeTabs,value,disabled=!1,...triggerProps}=props,context=$69cb30bb0017df05$var$useTabsContext("TabsTrigger",__scopeTabs),rovingFocusGroupScope=$69cb30bb0017df05$var$useRovingFocusGroupScope(__scopeTabs),triggerId=$69cb30bb0017df05$var$makeTriggerId(context.baseId,value),contentId=$69cb30bb0017df05$var$makeContentId(context.baseId,value),isSelected=value===context.value;return(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_roving_focus__WEBPACK_IMPORTED_MODULE_2__.ck,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_7__.Z)({asChild:!0},rovingFocusGroupScope,{focusable:!disabled,active:isSelected}),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_6__.WV.button,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_7__.Z)({type:"button",role:"tab","aria-selected":isSelected,"aria-controls":contentId,"data-state":isSelected?"active":"inactive","data-disabled":disabled?"":void 0,disabled,id:triggerId},triggerProps,{ref:forwardedRef,onMouseDown:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_8__.M)(props.onMouseDown,(event=>{disabled||0!==event.button||!1!==event.ctrlKey?event.preventDefault():context.onValueChange(value)})),onKeyDown:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_8__.M)(props.onKeyDown,(event=>{[" ","Enter"].includes(event.key)&&context.onValueChange(value)})),onFocus:(0,_radix_ui_primitive__WEBPACK_IMPORTED_MODULE_8__.M)(props.onFocus,(()=>{const isAutomaticActivation="manual"!==context.activationMode;isSelected||disabled||!isAutomaticActivation||context.onValueChange(value)}))})))})),$69cb30bb0017df05$export$bd905d70e8fd2ebb=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>{const{__scopeTabs,value,forceMount,children,...contentProps}=props,context=$69cb30bb0017df05$var$useTabsContext("TabsContent",__scopeTabs),triggerId=$69cb30bb0017df05$var$makeTriggerId(context.baseId,value),contentId=$69cb30bb0017df05$var$makeContentId(context.baseId,value),isSelected=value===context.value,isMountAnimationPreventedRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(isSelected);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const rAF=requestAnimationFrame((()=>isMountAnimationPreventedRef.current=!1));return()=>cancelAnimationFrame(rAF)}),[]),(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_presence__WEBPACK_IMPORTED_MODULE_9__.z,{present:forceMount||isSelected},(({present})=>(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_6__.WV.div,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_7__.Z)({"data-state":isSelected?"active":"inactive","data-orientation":context.orientation,role:"tabpanel","aria-labelledby":triggerId,hidden:!present,id:contentId,tabIndex:0},contentProps,{ref:forwardedRef,style:{...props.style,animationDuration:isMountAnimationPreventedRef.current?"0s":void 0}}),present&&children)))}));function $69cb30bb0017df05$var$makeTriggerId(baseId,value){return`${baseId}-trigger-${value}`}function $69cb30bb0017df05$var$makeContentId(baseId,value){return`${baseId}-content-${value}`}const $69cb30bb0017df05$export$be92b6f5f03c0fe9=$69cb30bb0017df05$export$b2539bed5023c21c,$69cb30bb0017df05$export$54c2e3dc7acea9f5=$69cb30bb0017df05$export$9712d22edc0d78c1,$69cb30bb0017df05$export$41fb9f06171c75f4=$69cb30bb0017df05$export$8114b9fdfdf9f3ba,$69cb30bb0017df05$export$7c6e2c02157bb7d2=$69cb30bb0017df05$export$bd905d70e8fd2ebb},"../../node_modules/@radix-ui/react-use-callback-ref/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{W:()=>$b1b2314f5f9a1d84$export$25bec8c6f54ee79a});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js");function $b1b2314f5f9a1d84$export$25bec8c6f54ee79a(callback){const callbackRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(callback);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{callbackRef.current=callback})),(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>(...args)=>{var _callbackRef$current;return null===(_callbackRef$current=callbackRef.current)||void 0===_callbackRef$current?void 0:_callbackRef$current.call(callbackRef,...args)}),[])}},"../../node_modules/@radix-ui/react-use-controllable-state/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{T:()=>$71cd76cc60e0454e$export$6f32135080cb4c3});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_use_callback_ref__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-use-callback-ref/dist/index.mjs");function $71cd76cc60e0454e$export$6f32135080cb4c3({prop,defaultProp,onChange=()=>{}}){const[uncontrolledProp,setUncontrolledProp]=function $71cd76cc60e0454e$var$useUncontrolledState({defaultProp,onChange}){const uncontrolledState=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(defaultProp),[value]=uncontrolledState,prevValueRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(value),handleChange=(0,_radix_ui_react_use_callback_ref__WEBPACK_IMPORTED_MODULE_1__.W)(onChange);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{prevValueRef.current!==value&&(handleChange(value),prevValueRef.current=value)}),[value,prevValueRef,handleChange]),uncontrolledState}({defaultProp,onChange}),isControlled=void 0!==prop,value1=isControlled?prop:uncontrolledProp,handleChange=(0,_radix_ui_react_use_callback_ref__WEBPACK_IMPORTED_MODULE_1__.W)(onChange);return[value1,(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((nextValue=>{if(isControlled){const value="function"==typeof nextValue?nextValue(prop):nextValue;value!==prop&&handleChange(value)}else setUncontrolledProp(nextValue)}),[isControlled,prop,setUncontrolledProp,handleChange])]}},"../../node_modules/@radix-ui/react-use-escape-keydown/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{e:()=>$addc16e1bbe58fd0$export$3a72a57244d6e765});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_use_callback_ref__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-use-callback-ref/dist/index.mjs");function $addc16e1bbe58fd0$export$3a72a57244d6e765(onEscapeKeyDownProp,ownerDocument=(null===globalThis||void 0===globalThis?void 0:globalThis.document)){const onEscapeKeyDown=(0,_radix_ui_react_use_callback_ref__WEBPACK_IMPORTED_MODULE_1__.W)(onEscapeKeyDownProp);(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((()=>{const handleKeyDown=event=>{"Escape"===event.key&&onEscapeKeyDown(event)};return ownerDocument.addEventListener("keydown",handleKeyDown),()=>ownerDocument.removeEventListener("keydown",handleKeyDown)}),[onEscapeKeyDown,ownerDocument])}},"../../node_modules/@radix-ui/react-use-layout-effect/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{b:()=>$9f79659886946c16$export$e5c5a5f917a5871c});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js");const $9f79659886946c16$export$e5c5a5f917a5871c=Boolean(null===globalThis||void 0===globalThis?void 0:globalThis.document)?react__WEBPACK_IMPORTED_MODULE_0__.useLayoutEffect:()=>{}},"../../node_modules/@radix-ui/react-use-previous/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{D:()=>$010c2913dbd2fe3d$export$5cae361ad82dce8b});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js");function $010c2913dbd2fe3d$export$5cae361ad82dce8b(value){const ref=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)({value,previous:value});return(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((()=>(ref.current.value!==value&&(ref.current.previous=ref.current.value,ref.current.value=value),ref.current.previous)),[value])}},"../../node_modules/@radix-ui/react-use-size/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{t:()=>$db6c3485150b8e66$export$1ab7ae714698c4b8});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-use-layout-effect/dist/index.mjs");function $db6c3485150b8e66$export$1ab7ae714698c4b8(element){const[size,setSize]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(void 0);return(0,_radix_ui_react_use_layout_effect__WEBPACK_IMPORTED_MODULE_1__.b)((()=>{if(element){setSize({width:element.offsetWidth,height:element.offsetHeight});const resizeObserver=new ResizeObserver((entries=>{if(!Array.isArray(entries))return;if(!entries.length)return;const entry=entries[0];let width,height;if("borderBoxSize"in entry){const borderSizeEntry=entry.borderBoxSize,borderSize=Array.isArray(borderSizeEntry)?borderSizeEntry[0]:borderSizeEntry;width=borderSize.inlineSize,height=borderSize.blockSize}else width=element.offsetWidth,height=element.offsetHeight;setSize({width,height})}));return resizeObserver.observe(element,{box:"border-box"}),()=>resizeObserver.unobserve(element)}setSize(void 0)}),[element]),size}},"../../node_modules/@radix-ui/react-visually-hidden/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{T:()=>$ea1ef594cf570d83$export$439d29a4e110a164});var _babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../node_modules/@babel/runtime/helpers/esm/extends.js"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/@radix-ui/react-primitive/dist/index.mjs");const $ea1ef594cf570d83$export$439d29a4e110a164=(0,react__WEBPACK_IMPORTED_MODULE_0__.forwardRef)(((props,forwardedRef)=>(0,react__WEBPACK_IMPORTED_MODULE_0__.createElement)(_radix_ui_react_primitive__WEBPACK_IMPORTED_MODULE_1__.WV.span,(0,_babel_runtime_helpers_esm_extends__WEBPACK_IMPORTED_MODULE_2__.Z)({},props,{ref:forwardedRef,style:{position:"absolute",border:0,width:1,height:1,padding:0,margin:-1,overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",wordWrap:"normal",...props.style}}))))},"../../node_modules/@stitches/react/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Th:()=>q,jG:()=>Q,zo:()=>re});var X,react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),e="colors",t="sizes",r="space",n={gap:r,gridGap:r,columnGap:r,gridColumnGap:r,rowGap:r,gridRowGap:r,inset:r,insetBlock:r,insetBlockEnd:r,insetBlockStart:r,insetInline:r,insetInlineEnd:r,insetInlineStart:r,margin:r,marginTop:r,marginRight:r,marginBottom:r,marginLeft:r,marginBlock:r,marginBlockEnd:r,marginBlockStart:r,marginInline:r,marginInlineEnd:r,marginInlineStart:r,padding:r,paddingTop:r,paddingRight:r,paddingBottom:r,paddingLeft:r,paddingBlock:r,paddingBlockEnd:r,paddingBlockStart:r,paddingInline:r,paddingInlineEnd:r,paddingInlineStart:r,top:r,right:r,bottom:r,left:r,scrollMargin:r,scrollMarginTop:r,scrollMarginRight:r,scrollMarginBottom:r,scrollMarginLeft:r,scrollMarginX:r,scrollMarginY:r,scrollMarginBlock:r,scrollMarginBlockEnd:r,scrollMarginBlockStart:r,scrollMarginInline:r,scrollMarginInlineEnd:r,scrollMarginInlineStart:r,scrollPadding:r,scrollPaddingTop:r,scrollPaddingRight:r,scrollPaddingBottom:r,scrollPaddingLeft:r,scrollPaddingX:r,scrollPaddingY:r,scrollPaddingBlock:r,scrollPaddingBlockEnd:r,scrollPaddingBlockStart:r,scrollPaddingInline:r,scrollPaddingInlineEnd:r,scrollPaddingInlineStart:r,fontSize:"fontSizes",background:e,backgroundColor:e,backgroundImage:e,borderImage:e,border:e,borderBlock:e,borderBlockEnd:e,borderBlockStart:e,borderBottom:e,borderBottomColor:e,borderColor:e,borderInline:e,borderInlineEnd:e,borderInlineStart:e,borderLeft:e,borderLeftColor:e,borderRight:e,borderRightColor:e,borderTop:e,borderTopColor:e,caretColor:e,color:e,columnRuleColor:e,fill:e,outline:e,outlineColor:e,stroke:e,textDecorationColor:e,fontFamily:"fonts",fontWeight:"fontWeights",lineHeight:"lineHeights",letterSpacing:"letterSpacings",blockSize:t,minBlockSize:t,maxBlockSize:t,inlineSize:t,minInlineSize:t,maxInlineSize:t,width:t,minWidth:t,maxWidth:t,height:t,minHeight:t,maxHeight:t,flexBasis:t,gridTemplateColumns:t,gridTemplateRows:t,borderWidth:"borderWidths",borderTopWidth:"borderWidths",borderRightWidth:"borderWidths",borderBottomWidth:"borderWidths",borderLeftWidth:"borderWidths",borderStyle:"borderStyles",borderTopStyle:"borderStyles",borderRightStyle:"borderStyles",borderBottomStyle:"borderStyles",borderLeftStyle:"borderStyles",borderRadius:"radii",borderTopLeftRadius:"radii",borderTopRightRadius:"radii",borderBottomRightRadius:"radii",borderBottomLeftRadius:"radii",boxShadow:"shadows",textShadow:"shadows",transition:"transitions",zIndex:"zIndices"},i=(e,t)=>"function"==typeof t?{"()":Function.prototype.toString.call(t)}:t,o=()=>{const e=Object.create(null);return(t,r,...n)=>{const o=(e=>JSON.stringify(e,i))(t);return o in e?e[o]:e[o]=r(t,...n)}},l=Symbol.for("sxs.internal"),s=(e,t)=>Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)),a=e=>{for(const t in e)return!0;return!1},{hasOwnProperty:c}=Object.prototype,d=e=>e.includes("-")?e:e.replace(/[A-Z]/g,(e=>"-"+e.toLowerCase())),g=/\s+(?![^()]*\))/,p=e=>t=>e(..."string"==typeof t?String(t).split(g):[t]),u={appearance:e=>({WebkitAppearance:e,appearance:e}),backfaceVisibility:e=>({WebkitBackfaceVisibility:e,backfaceVisibility:e}),backdropFilter:e=>({WebkitBackdropFilter:e,backdropFilter:e}),backgroundClip:e=>({WebkitBackgroundClip:e,backgroundClip:e}),boxDecorationBreak:e=>({WebkitBoxDecorationBreak:e,boxDecorationBreak:e}),clipPath:e=>({WebkitClipPath:e,clipPath:e}),content:e=>({content:e.includes('"')||e.includes("'")||/^([A-Za-z]+\([^]*|[^]*-quote|inherit|initial|none|normal|revert|unset)$/.test(e)?e:`"${e}"`}),hyphens:e=>({WebkitHyphens:e,hyphens:e}),maskImage:e=>({WebkitMaskImage:e,maskImage:e}),maskSize:e=>({WebkitMaskSize:e,maskSize:e}),tabSize:e=>({MozTabSize:e,tabSize:e}),textSizeAdjust:e=>({WebkitTextSizeAdjust:e,textSizeAdjust:e}),userSelect:e=>({WebkitUserSelect:e,userSelect:e}),marginBlock:p(((e,t)=>({marginBlockStart:e,marginBlockEnd:t||e}))),marginInline:p(((e,t)=>({marginInlineStart:e,marginInlineEnd:t||e}))),maxSize:p(((e,t)=>({maxBlockSize:e,maxInlineSize:t||e}))),minSize:p(((e,t)=>({minBlockSize:e,minInlineSize:t||e}))),paddingBlock:p(((e,t)=>({paddingBlockStart:e,paddingBlockEnd:t||e}))),paddingInline:p(((e,t)=>({paddingInlineStart:e,paddingInlineEnd:t||e})))},h=/([\d.]+)([^]*)/,f=(e,t)=>e.length?e.reduce(((e,r)=>(e.push(...t.map((e=>e.includes("&")?e.replace(/&/g,/[ +>|~]/.test(r)&&/&.*&/.test(e)?`:is(${r})`:r):r+" "+e))),e)),[]):t,m=(e,t)=>e in b&&"string"==typeof t?t.replace(/^((?:[^]*[^\w-])?)(fit-content|stretch)((?:[^\w-][^]*)?)$/,((t,r,n,i)=>r+("stretch"===n?`-moz-available${i};${d(e)}:${r}-webkit-fill-available`:`-moz-fit-content${i};${d(e)}:${r}fit-content`)+i)):String(t),b={blockSize:1,height:1,inlineSize:1,maxBlockSize:1,maxHeight:1,maxInlineSize:1,maxWidth:1,minBlockSize:1,minHeight:1,minInlineSize:1,minWidth:1,width:1},S=e=>e?e+"-":"",k=(e,t,r)=>e.replace(/([+-])?((?:\d+(?:\.\d*)?|\.\d+)(?:[Ee][+-]?\d+)?)?(\$|--)([$\w-]+)/g,((e,n,i,o,l)=>"$"==o==!!i?e:(n||"--"==o?"calc(":"")+"var(--"+("$"===o?S(t)+(l.includes("$")?"":S(r))+l.replace(/\$/g,"-"):l)+")"+(n||"--"==o?"*"+(n||"")+(i||"1")+")":""))),y=/\s*,\s*(?![^()]*\))/,B=Object.prototype.toString,$=(e,t,r,n,i)=>{let o,l,s;const a=(e,t,r)=>{let c,g;const p=e=>{for(c in e){const R=64===c.charCodeAt(0),z=R&&Array.isArray(e[c])?e[c]:[e[c]];for(g of z){const e=/[A-Z]/.test($=c)?$:$.replace(/-[^]/g,(e=>e[1].toUpperCase())),z="object"==typeof g&&g&&g.toString===B&&(!n.utils[e]||!t.length);if(e in n.utils&&!z){const t=n.utils[e];if(t!==l){l=t,p(t(g)),l=null;continue}}else if(e in u){const t=u[e];if(t!==s){s=t,p(t(g)),s=null;continue}}if(R&&(b=c.slice(1)in n.media?"@media "+n.media[c.slice(1)]:c,c=b.replace(/\(\s*([\w-]+)\s*(=|<|<=|>|>=)\s*([\w-]+)\s*(?:(<|<=|>|>=)\s*([\w-]+)\s*)?\)/g,((e,t,r,n,i,o)=>{const l=h.test(t),s=.0625*(l?-1:1),[a,c]=l?[n,t]:[t,n];return"("+("="===r[0]?"":">"===r[0]===l?"max-":"min-")+a+":"+("="!==r[0]&&1===r.length?c.replace(h,((e,t,n)=>Number(t)+s*(">"===r?1:-1)+n)):c)+(i?") and ("+(">"===i[0]?"min-":"max-")+a+":"+(1===i.length?o.replace(h,((e,t,r)=>Number(t)+s*(">"===i?-1:1)+r)):o):"")+")"}))),z){const e=R?r.concat(c):[...r],n=R?[...t]:f(t,c.split(y));void 0!==o&&i(x(...o)),o=void 0,a(g,n,e)}else void 0===o&&(o=[[],t,r]),c=R||36!==c.charCodeAt(0)?c:`--${S(n.prefix)}${c.slice(1).replace(/\$/g,"-")}`,g=z?g:"number"==typeof g?g&&e in I?String(g)+"px":String(g):k(m(e,null==g?"":g),n.prefix,n.themeMap[e]),o[0].push(`${R?`${c} `:`${d(c)}:`}${g}`)}}var b,$};p(e),void 0!==o&&i(x(...o)),o=void 0};a(e,t,r)},x=(e,t,r)=>`${r.map((e=>`${e}{`)).join("")}${t.length?`${t.join(",")}{`:""}${e.join(";")}${t.length?"}":""}${Array(r.length?r.length+1:0).join("}")}`,I={animationDelay:1,animationDuration:1,backgroundSize:1,blockSize:1,border:1,borderBlock:1,borderBlockEnd:1,borderBlockEndWidth:1,borderBlockStart:1,borderBlockStartWidth:1,borderBlockWidth:1,borderBottom:1,borderBottomLeftRadius:1,borderBottomRightRadius:1,borderBottomWidth:1,borderEndEndRadius:1,borderEndStartRadius:1,borderInlineEnd:1,borderInlineEndWidth:1,borderInlineStart:1,borderInlineStartWidth:1,borderInlineWidth:1,borderLeft:1,borderLeftWidth:1,borderRadius:1,borderRight:1,borderRightWidth:1,borderSpacing:1,borderStartEndRadius:1,borderStartStartRadius:1,borderTop:1,borderTopLeftRadius:1,borderTopRightRadius:1,borderTopWidth:1,borderWidth:1,bottom:1,columnGap:1,columnRule:1,columnRuleWidth:1,columnWidth:1,containIntrinsicSize:1,flexBasis:1,fontSize:1,gap:1,gridAutoColumns:1,gridAutoRows:1,gridTemplateColumns:1,gridTemplateRows:1,height:1,inlineSize:1,inset:1,insetBlock:1,insetBlockEnd:1,insetBlockStart:1,insetInline:1,insetInlineEnd:1,insetInlineStart:1,left:1,letterSpacing:1,margin:1,marginBlock:1,marginBlockEnd:1,marginBlockStart:1,marginBottom:1,marginInline:1,marginInlineEnd:1,marginInlineStart:1,marginLeft:1,marginRight:1,marginTop:1,maxBlockSize:1,maxHeight:1,maxInlineSize:1,maxWidth:1,minBlockSize:1,minHeight:1,minInlineSize:1,minWidth:1,offsetDistance:1,offsetRotate:1,outline:1,outlineOffset:1,outlineWidth:1,overflowClipMargin:1,padding:1,paddingBlock:1,paddingBlockEnd:1,paddingBlockStart:1,paddingBottom:1,paddingInline:1,paddingInlineEnd:1,paddingInlineStart:1,paddingLeft:1,paddingRight:1,paddingTop:1,perspective:1,right:1,rowGap:1,scrollMargin:1,scrollMarginBlock:1,scrollMarginBlockEnd:1,scrollMarginBlockStart:1,scrollMarginBottom:1,scrollMarginInline:1,scrollMarginInlineEnd:1,scrollMarginInlineStart:1,scrollMarginLeft:1,scrollMarginRight:1,scrollMarginTop:1,scrollPadding:1,scrollPaddingBlock:1,scrollPaddingBlockEnd:1,scrollPaddingBlockStart:1,scrollPaddingBottom:1,scrollPaddingInline:1,scrollPaddingInlineEnd:1,scrollPaddingInlineStart:1,scrollPaddingLeft:1,scrollPaddingRight:1,scrollPaddingTop:1,shapeMargin:1,textDecoration:1,textDecorationThickness:1,textIndent:1,textUnderlineOffset:1,top:1,transitionDelay:1,transitionDuration:1,verticalAlign:1,width:1,wordSpacing:1},R=e=>String.fromCharCode(e+(e>25?39:97)),z=e=>(e=>{let t,r="";for(t=Math.abs(e);t>52;t=t/52|0)r=R(t%52)+r;return R(t%52)+r})(((e,t)=>{let r=t.length;for(;r;)e=33*e^t.charCodeAt(--r);return e})(5381,JSON.stringify(e))>>>0),W=["themed","global","styled","onevar","resonevar","allvar","inline"],j=e=>{if(e.href&&!e.href.startsWith(location.origin))return!1;try{return!!e.cssRules}catch(e){return!1}},E=e=>{let t;const r=()=>{const{cssRules:e}=t.sheet;return[].map.call(e,((r,n)=>{const{cssText:i}=r;let o="";if(i.startsWith("--sxs"))return"";if(e[n-1]&&(o=e[n-1].cssText).startsWith("--sxs")){if(!r.cssRules.length)return"";for(const e in t.rules)if(t.rules[e].group===r)return`--sxs{--sxs:${[...t.rules[e].cache].join(" ")}}${i}`;return r.cssRules.length?`${o}${i}`:""}return i})).join("")},n=()=>{if(t){const{rules:e,sheet:r}=t;if(!r.deleteRule){for(;3===Object(Object(r.cssRules)[0]).type;)r.cssRules.splice(0,1);r.cssRules=[]}for(const t in e)delete e[t]}const i=Object(e).styleSheets||[];for(const e of i)if(j(e)){for(let i=0,o=e.cssRules;o[i];++i){const l=Object(o[i]);if(1!==l.type)continue;const s=Object(o[i+1]);if(4!==s.type)continue;++i;const{cssText:a}=l;if(!a.startsWith("--sxs"))continue;const c=a.slice(14,-3).trim().split(/\s+/),d=W[c[0]];d&&(t||(t={sheet:e,reset:n,rules:{},toString:r}),t.rules[d]={group:s,index:i,cache:new Set(c)})}if(t)break}if(!t){const i=(e,t)=>({type:t,cssRules:[],insertRule(e,t){this.cssRules.splice(t,0,i(e,{import:3,undefined:1}[(e.toLowerCase().match(/^@([a-z]+)/)||[])[1]]||4))},get cssText(){return"@media{}"===e?`@media{${[].map.call(this.cssRules,(e=>e.cssText)).join("")}}`:e}});t={sheet:e?(e.head||e).appendChild(document.createElement("style")).sheet:i("","text/css"),rules:{},reset:n,toString:r}}const{sheet:o,rules:l}=t;for(let e=W.length-1;e>=0;--e){const t=W[e];if(!l[t]){const r=W[e+1],n=l[r]?l[r].index:o.cssRules.length;o.insertRule("@media{}",n),o.insertRule(`--sxs{--sxs:${e}}`,n),l[t]={group:o.cssRules[n+1],index:n,cache:new Set([e])}}v(l[t])}};return n(),t},v=e=>{const t=e.group;let r=t.cssRules.length;e.apply=e=>{try{t.insertRule(e,r),++r}catch(e){}}},T=Symbol(),w=o(),M=(e,t)=>w(e,(()=>(...r)=>{let n={type:null,composers:new Set};for(const t of r)if(null!=t)if(t[l]){null==n.type&&(n.type=t[l].type);for(const e of t[l].composers)n.composers.add(e)}else t.constructor!==Object||t.$$typeof?null==n.type&&(n.type=t):n.composers.add(C(t,e));return null==n.type&&(n.type="span"),n.composers.size||n.composers.add(["PJLV",{},[],[],{},[]]),P(e,n,t)})),C=({variants:e,compoundVariants:t,defaultVariants:r,...n},i)=>{const o=`${S(i.prefix)}c-${z(n)}`,l=[],s=[],d=Object.create(null),g=[];for(const e in r)d[e]=String(r[e]);if("object"==typeof e&&e)for(const t in e){p=d,u=t,c.call(p,u)||(d[t]="undefined");const r=e[t];for(const e in r){const n={[t]:String(e)};"undefined"===String(e)&&g.push(t);const i=r[e],o=[n,i,!a(i)];l.push(o)}}var p,u;if("object"==typeof t&&t)for(const e of t){let{css:t,...r}=e;t="object"==typeof t&&t||{};for(const e in r)r[e]=String(r[e]);const n=[r,t,!a(t)];s.push(n)}return[o,n,l,s,d,g]},P=(e,t,r)=>{const[n,i,o,a]=L(t.composers),c="function"==typeof t.type||t.type.$$typeof?(e=>{function t(){for(let r=0;r<t[T].length;r++){const[n,i]=t[T][r];e.rules[n].apply(i)}return t[T]=[],null}return t[T]=[],t.rules={},W.forEach((e=>t.rules[e]={apply:r=>t[T].push([e,r])})),t})(r):null,d=(c||r).rules,g=`.${n}${i.length>1?`:where(.${i.slice(1).join(".")})`:""}`,p=l=>{l="object"==typeof l&&l||A;const{css:s,...p}=l,u={};for(const e in o)if(delete p[e],e in l){let t=l[e];"object"==typeof t&&t?u[e]={"@initial":o[e],...t}:(t=String(t),u[e]="undefined"!==t||a.has(e)?t:o[e])}else u[e]=o[e];const h=new Set([...i]);for(const[n,i,o,l]of t.composers){r.rules.styled.cache.has(n)||(r.rules.styled.cache.add(n),$(i,[`.${n}`],[],e,(e=>{d.styled.apply(e)})));const t=O(o,u,e.media),s=O(l,u,e.media,!0);for(const i of t)if(void 0!==i)for(const[t,o,l]of i){const i=`${n}-${z(o)}-${t}`;h.add(i);const s=(l?r.rules.resonevar:r.rules.onevar).cache,a=l?d.resonevar:d.onevar;s.has(i)||(s.add(i),$(o,[`.${i}`],[],e,(e=>{a.apply(e)})))}for(const t of s)if(void 0!==t)for(const[i,o]of t){const t=`${n}-${z(o)}-${i}`;h.add(t),r.rules.allvar.cache.has(t)||(r.rules.allvar.cache.add(t),$(o,[`.${t}`],[],e,(e=>{d.allvar.apply(e)})))}}if("object"==typeof s&&s){const t=`${n}-i${z(s)}-css`;h.add(t),r.rules.inline.cache.has(t)||(r.rules.inline.cache.add(t),$(s,[`.${t}`],[],e,(e=>{d.inline.apply(e)})))}for(const e of String(l.className||"").trim().split(/\s+/))e&&h.add(e);const f=p.className=[...h].join(" ");return{type:t.type,className:f,selector:g,props:p,toString:()=>f,deferredInjector:c}};return s(p,{className:n,selector:g,[l]:t,toString:()=>(r.rules.styled.cache.has(n)||p(),n)})},L=e=>{let t="";const r=[],n={},i=[];for(const[o,,,,l,s]of e){""===t&&(t=o),r.push(o),i.push(...s);for(const e in l){const t=l[e];(void 0===n[e]||"undefined"!==t||s.includes(t))&&(n[e]=t)}}return[t,r,n,new Set(i)]},O=(e,t,r,n)=>{const i=[];e:for(let[o,l,s]of e){if(s)continue;let e,a=0,c=!1;for(e in o){const n=o[e];let i=t[e];if(i!==n){if("object"!=typeof i||!i)continue e;{let e,t,o=0;for(const l in i){if(n===String(i[l])){if("@initial"!==l){const e=l.slice(1);(t=t||[]).push(e in r?r[e]:l.replace(/^@media ?/,"")),c=!0}a+=o,e=!0}++o}if(t&&t.length&&(l={["@media "+t.join(", ")]:l}),!e)continue e}}}(i[a]=i[a]||[]).push([n?"cv":`${e}-${o[e]}`,l,c])}return i},A={},N=o(),D=(e,t)=>N(e,(()=>(...r)=>{const n=()=>{for(let n of r){n="object"==typeof n&&n||{};let r=z(n);if(!t.rules.global.cache.has(r)){if(t.rules.global.cache.add(r),"@import"in n){let e=[].indexOf.call(t.sheet.cssRules,t.rules.themed.group)-1;for(let r of[].concat(n["@import"]))r=r.includes('"')||r.includes("'")?r:`"${r}"`,t.sheet.insertRule(`@import ${r};`,e++);delete n["@import"]}$(n,[],[],e,(e=>{t.rules.global.apply(e)}))}}return""};return s(n,{toString:n})})),H=o(),V=(e,t)=>H(e,(()=>r=>{const n=`${S(e.prefix)}k-${z(r)}`,i=()=>{if(!t.rules.global.cache.has(n)){t.rules.global.cache.add(n);const i=[];$(r,[],[],e,(e=>i.push(e)));const o=`@keyframes ${n}{${i.join("")}}`;t.rules.global.apply(o)}return n};return s(i,{get name(){return i()},toString:i})})),G=class{constructor(e,t,r,n){this.token=null==e?"":String(e),this.value=null==t?"":String(t),this.scale=null==r?"":String(r),this.prefix=null==n?"":String(n)}get computedValue(){return"var("+this.variable+")"}get variable(){return"--"+S(this.prefix)+S(this.scale)+this.token}toString(){return this.computedValue}},F=o(),J=(e,t)=>F(e,(()=>(r,n)=>{n="object"==typeof r&&r||Object(n);const i=`.${r=(r="string"==typeof r?r:"")||`${S(e.prefix)}t-${z(n)}`}`,o={},l=[];for(const t in n){o[t]={};for(const r in n[t]){const i=`--${S(e.prefix)}${t}-${r}`,s=k(String(n[t][r]),e.prefix,t);o[t][r]=new G(r,s,t,e.prefix),l.push(`${i}:${s}`)}}const s=()=>{if(l.length&&!t.rules.themed.cache.has(r)){t.rules.themed.cache.add(r);const i=`${n===e.theme?":root,":""}.${r}{${l.join(";")}}`;t.rules.themed.apply(i)}return r};return{...o,get className(){return s()},selector:i,toString:s}})),U=o(),Y=o(),q=e=>{const t=(e=>{let t=!1;const r=U(e,(e=>{t=!0;const r="prefix"in(e="object"==typeof e&&e||{})?String(e.prefix):"",i="object"==typeof e.media&&e.media||{},o="object"==typeof e.root?e.root||null:globalThis.document||null,l="object"==typeof e.theme&&e.theme||{},s={prefix:r,media:i,theme:l,themeMap:"object"==typeof e.themeMap&&e.themeMap||{...n},utils:"object"==typeof e.utils&&e.utils||{}},a=E(o),c={css:M(s,a),globalCss:D(s,a),keyframes:V(s,a),createTheme:J(s,a),reset(){a.reset(),c.theme.toString()},theme:{},sheet:a,config:s,prefix:r,getCssText:a.toString,toString:a.toString};return String(c.theme=c.createTheme(l)),c}));return t||r.reset(),r})(e);return t.styled=(({config:e,sheet:t})=>Y(e,(()=>{const r=M(e,t);return(...e)=>{const t=r(...e),n=t[l].type,i=react__WEBPACK_IMPORTED_MODULE_0__.forwardRef(((e,r)=>{const i=e&&e.as||n,{props:o,deferredInjector:l}=t(e);return delete o.as,o.ref=r,l?react__WEBPACK_IMPORTED_MODULE_0__.createElement(react__WEBPACK_IMPORTED_MODULE_0__.Fragment,null,react__WEBPACK_IMPORTED_MODULE_0__.createElement(i,o),react__WEBPACK_IMPORTED_MODULE_0__.createElement(l,null)):react__WEBPACK_IMPORTED_MODULE_0__.createElement(i,o)}));return i.className=t.className,i.displayName=`Styled.${n.displayName||n.name||n}`,i.selector=t.selector,i.toString=()=>t.selector,i[l]=t[l],i}})))(t),t},K=()=>X||(X=q()),Q=(...e)=>K().createTheme(...e),re=(...e)=>K().styled(...e)},"../../node_modules/aria-hidden/dist/es2015/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Ry:()=>hideOthers});var getDefaultParent=function(originalTarget){return"undefined"==typeof document?null:(Array.isArray(originalTarget)?originalTarget[0]:originalTarget).ownerDocument.body},counterMap=new WeakMap,uncontrolledNodes=new WeakMap,markerMap={},lockCount=0,unwrapHost=function(node){return node&&(node.host||unwrapHost(node.parentNode))},applyAttributeToOthers=function(originalTarget,parentNode,markerName,controlAttribute){var targets=function(parent,targets){return targets.map((function(target){if(parent.contains(target))return target;var correctedTarget=unwrapHost(target);return correctedTarget&&parent.contains(correctedTarget)?correctedTarget:(console.error("aria-hidden",target,"in not contained inside",parent,". Doing nothing"),null)})).filter((function(x){return Boolean(x)}))}(parentNode,Array.isArray(originalTarget)?originalTarget:[originalTarget]);markerMap[markerName]||(markerMap[markerName]=new WeakMap);var markerCounter=markerMap[markerName],hiddenNodes=[],elementsToKeep=new Set,elementsToStop=new Set(targets),keep=function(el){el&&!elementsToKeep.has(el)&&(elementsToKeep.add(el),keep(el.parentNode))};targets.forEach(keep);var deep=function(parent){parent&&!elementsToStop.has(parent)&&Array.prototype.forEach.call(parent.children,(function(node){if(elementsToKeep.has(node))deep(node);else{var attr=node.getAttribute(controlAttribute),alreadyHidden=null!==attr&&"false"!==attr,counterValue=(counterMap.get(node)||0)+1,markerValue=(markerCounter.get(node)||0)+1;counterMap.set(node,counterValue),markerCounter.set(node,markerValue),hiddenNodes.push(node),1===counterValue&&alreadyHidden&&uncontrolledNodes.set(node,!0),1===markerValue&&node.setAttribute(markerName,"true"),alreadyHidden||node.setAttribute(controlAttribute,"true")}}))};return deep(parentNode),elementsToKeep.clear(),lockCount++,function(){hiddenNodes.forEach((function(node){var counterValue=counterMap.get(node)-1,markerValue=markerCounter.get(node)-1;counterMap.set(node,counterValue),markerCounter.set(node,markerValue),counterValue||(uncontrolledNodes.has(node)||node.removeAttribute(controlAttribute),uncontrolledNodes.delete(node)),markerValue||node.removeAttribute(markerName)})),--lockCount||(counterMap=new WeakMap,counterMap=new WeakMap,uncontrolledNodes=new WeakMap,markerMap={})}},hideOthers=function(originalTarget,parentNode,markerName){void 0===markerName&&(markerName="data-aria-hidden");var targets=Array.from(Array.isArray(originalTarget)?originalTarget:[originalTarget]),activeParentNode=parentNode||getDefaultParent(originalTarget);return activeParentNode?(targets.push.apply(targets,Array.from(activeParentNode.querySelectorAll("[aria-live]"))),applyAttributeToOthers(targets,activeParentNode,markerName,"aria-hidden")):function(){return null}}},"../../node_modules/deepmerge/dist/cjs.js":module=>{"use strict";var isMergeableObject=function isMergeableObject(value){return function isNonNullObject(value){return!!value&&"object"==typeof value}(value)&&!function isSpecial(value){var stringValue=Object.prototype.toString.call(value);return"[object RegExp]"===stringValue||"[object Date]"===stringValue||function isReactElement(value){return value.$$typeof===REACT_ELEMENT_TYPE}(value)}(value)};var REACT_ELEMENT_TYPE="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function cloneUnlessOtherwiseSpecified(value,options){return!1!==options.clone&&options.isMergeableObject(value)?deepmerge(function emptyTarget(val){return Array.isArray(val)?[]:{}}(value),value,options):value}function defaultArrayMerge(target,source,options){return target.concat(source).map((function(element){return cloneUnlessOtherwiseSpecified(element,options)}))}function getKeys(target){return Object.keys(target).concat(function getEnumerableOwnPropertySymbols(target){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(target).filter((function(symbol){return Object.propertyIsEnumerable.call(target,symbol)})):[]}(target))}function propertyIsOnObject(object,property){try{return property in object}catch(_){return!1}}function mergeObject(target,source,options){var destination={};return options.isMergeableObject(target)&&getKeys(target).forEach((function(key){destination[key]=cloneUnlessOtherwiseSpecified(target[key],options)})),getKeys(source).forEach((function(key){(function propertyIsUnsafe(target,key){return propertyIsOnObject(target,key)&&!(Object.hasOwnProperty.call(target,key)&&Object.propertyIsEnumerable.call(target,key))})(target,key)||(propertyIsOnObject(target,key)&&options.isMergeableObject(source[key])?destination[key]=function getMergeFunction(key,options){if(!options.customMerge)return deepmerge;var customMerge=options.customMerge(key);return"function"==typeof customMerge?customMerge:deepmerge}(key,options)(target[key],source[key],options):destination[key]=cloneUnlessOtherwiseSpecified(source[key],options))})),destination}function deepmerge(target,source,options){(options=options||{}).arrayMerge=options.arrayMerge||defaultArrayMerge,options.isMergeableObject=options.isMergeableObject||isMergeableObject,options.cloneUnlessOtherwiseSpecified=cloneUnlessOtherwiseSpecified;var sourceIsArray=Array.isArray(source);return sourceIsArray===Array.isArray(target)?sourceIsArray?options.arrayMerge(target,source,options):mergeObject(target,source,options):cloneUnlessOtherwiseSpecified(source,options)}deepmerge.all=function deepmergeAll(array,options){if(!Array.isArray(array))throw new Error("first argument should be an array");return array.reduce((function(prev,next){return deepmerge(prev,next,options)}),{})};var deepmerge_1=deepmerge;module.exports=deepmerge_1},"../../node_modules/escape-string-regexp/index.js":module=>{"use strict";module.exports=string=>{if("string"!=typeof string)throw new TypeError("Expected a string");return string.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}},"../../node_modules/hls.js/dist/hls.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function getDefaultExportFromCjs(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x}__webpack_require__.d(__webpack_exports__,{ZP:()=>Hls});var URL_REGEX,FIRST_SEGMENT_REGEX,SLASH_DOT_REGEX,SLASH_DOT_DOT_REGEX,URLToolkit,urlToolkit={exports:{}};URL_REGEX=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,FIRST_SEGMENT_REGEX=/^(?=([^\/?#]*))\1([^]*)$/,SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g,SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,urlToolkit.exports=URLToolkit={buildAbsoluteURL:function(baseURL,relativeURL,opts){if(opts=opts||{},baseURL=baseURL.trim(),!(relativeURL=relativeURL.trim())){if(!opts.alwaysNormalize)return baseURL;var basePartsForNormalise=URLToolkit.parseURL(baseURL);if(!basePartsForNormalise)throw new Error("Error trying to parse base URL.");return basePartsForNormalise.path=URLToolkit.normalizePath(basePartsForNormalise.path),URLToolkit.buildURLFromParts(basePartsForNormalise)}var relativeParts=URLToolkit.parseURL(relativeURL);if(!relativeParts)throw new Error("Error trying to parse relative URL.");if(relativeParts.scheme)return opts.alwaysNormalize?(relativeParts.path=URLToolkit.normalizePath(relativeParts.path),URLToolkit.buildURLFromParts(relativeParts)):relativeURL;var baseParts=URLToolkit.parseURL(baseURL);if(!baseParts)throw new Error("Error trying to parse base URL.");if(!baseParts.netLoc&&baseParts.path&&"/"!==baseParts.path[0]){var pathParts=FIRST_SEGMENT_REGEX.exec(baseParts.path);baseParts.netLoc=pathParts[1],baseParts.path=pathParts[2]}baseParts.netLoc&&!baseParts.path&&(baseParts.path="/");var builtParts={scheme:baseParts.scheme,netLoc:relativeParts.netLoc,path:null,params:relativeParts.params,query:relativeParts.query,fragment:relativeParts.fragment};if(!relativeParts.netLoc&&(builtParts.netLoc=baseParts.netLoc,"/"!==relativeParts.path[0]))if(relativeParts.path){var baseURLPath=baseParts.path,newPath=baseURLPath.substring(0,baseURLPath.lastIndexOf("/")+1)+relativeParts.path;builtParts.path=URLToolkit.normalizePath(newPath)}else builtParts.path=baseParts.path,relativeParts.params||(builtParts.params=baseParts.params,relativeParts.query||(builtParts.query=baseParts.query));return null===builtParts.path&&(builtParts.path=opts.alwaysNormalize?URLToolkit.normalizePath(relativeParts.path):relativeParts.path),URLToolkit.buildURLFromParts(builtParts)},parseURL:function(url){var parts=URL_REGEX.exec(url);return parts?{scheme:parts[1]||"",netLoc:parts[2]||"",path:parts[3]||"",params:parts[4]||"",query:parts[5]||"",fragment:parts[6]||""}:null},normalizePath:function(path){for(path=path.split("").reverse().join("").replace(SLASH_DOT_REGEX,"");path.length!==(path=path.replace(SLASH_DOT_DOT_REGEX,"")).length;);return path.split("").reverse().join("")},buildURLFromParts:function(parts){return parts.scheme+parts.netLoc+parts.path+parts.params+parts.query+parts.fragment}};var urlToolkitExports=urlToolkit.exports;function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,o)}return t}function _objectSpread2(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach((function(r){_defineProperty(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function _toPropertyKey(t){var i=function _toPrimitive(t,r){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}(t,"string");return"symbol"==typeof i?i:String(i)}function _defineProperty(obj,key,value){return(key=_toPropertyKey(key))in obj?Object.defineProperty(obj,key,{value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _extends(){return _extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},_extends.apply(this,arguments)}const isFiniteNumber=Number.isFinite||function(value){return"number"==typeof value&&isFinite(value)},isSafeInteger=Number.isSafeInteger||function(value){return"number"==typeof value&&Math.abs(value)<=MAX_SAFE_INTEGER},MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991;let Events=function(Events){return Events.MEDIA_ATTACHING="hlsMediaAttaching",Events.MEDIA_ATTACHED="hlsMediaAttached",Events.MEDIA_DETACHING="hlsMediaDetaching",Events.MEDIA_DETACHED="hlsMediaDetached",Events.BUFFER_RESET="hlsBufferReset",Events.BUFFER_CODECS="hlsBufferCodecs",Events.BUFFER_CREATED="hlsBufferCreated",Events.BUFFER_APPENDING="hlsBufferAppending",Events.BUFFER_APPENDED="hlsBufferAppended",Events.BUFFER_EOS="hlsBufferEos",Events.BUFFER_FLUSHING="hlsBufferFlushing",Events.BUFFER_FLUSHED="hlsBufferFlushed",Events.MANIFEST_LOADING="hlsManifestLoading",Events.MANIFEST_LOADED="hlsManifestLoaded",Events.MANIFEST_PARSED="hlsManifestParsed",Events.LEVEL_SWITCHING="hlsLevelSwitching",Events.LEVEL_SWITCHED="hlsLevelSwitched",Events.LEVEL_LOADING="hlsLevelLoading",Events.LEVEL_LOADED="hlsLevelLoaded",Events.LEVEL_UPDATED="hlsLevelUpdated",Events.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",Events.LEVELS_UPDATED="hlsLevelsUpdated",Events.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",Events.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",Events.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",Events.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",Events.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",Events.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",Events.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",Events.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",Events.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",Events.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",Events.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",Events.CUES_PARSED="hlsCuesParsed",Events.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",Events.INIT_PTS_FOUND="hlsInitPtsFound",Events.FRAG_LOADING="hlsFragLoading",Events.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",Events.FRAG_LOADED="hlsFragLoaded",Events.FRAG_DECRYPTED="hlsFragDecrypted",Events.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",Events.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",Events.FRAG_PARSING_METADATA="hlsFragParsingMetadata",Events.FRAG_PARSED="hlsFragParsed",Events.FRAG_BUFFERED="hlsFragBuffered",Events.FRAG_CHANGED="hlsFragChanged",Events.FPS_DROP="hlsFpsDrop",Events.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",Events.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",Events.ERROR="hlsError",Events.DESTROYING="hlsDestroying",Events.KEY_LOADING="hlsKeyLoading",Events.KEY_LOADED="hlsKeyLoaded",Events.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",Events.BACK_BUFFER_REACHED="hlsBackBufferReached",Events.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",Events}({}),ErrorTypes=function(ErrorTypes){return ErrorTypes.NETWORK_ERROR="networkError",ErrorTypes.MEDIA_ERROR="mediaError",ErrorTypes.KEY_SYSTEM_ERROR="keySystemError",ErrorTypes.MUX_ERROR="muxError",ErrorTypes.OTHER_ERROR="otherError",ErrorTypes}({}),ErrorDetails=function(ErrorDetails){return ErrorDetails.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",ErrorDetails.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",ErrorDetails.KEY_SYSTEM_NO_SESSION="keySystemNoSession",ErrorDetails.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",ErrorDetails.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",ErrorDetails.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",ErrorDetails.MANIFEST_LOAD_ERROR="manifestLoadError",ErrorDetails.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",ErrorDetails.MANIFEST_PARSING_ERROR="manifestParsingError",ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",ErrorDetails.LEVEL_EMPTY_ERROR="levelEmptyError",ErrorDetails.LEVEL_LOAD_ERROR="levelLoadError",ErrorDetails.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",ErrorDetails.LEVEL_PARSING_ERROR="levelParsingError",ErrorDetails.LEVEL_SWITCH_ERROR="levelSwitchError",ErrorDetails.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",ErrorDetails.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",ErrorDetails.FRAG_LOAD_ERROR="fragLoadError",ErrorDetails.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",ErrorDetails.FRAG_DECRYPT_ERROR="fragDecryptError",ErrorDetails.FRAG_PARSING_ERROR="fragParsingError",ErrorDetails.FRAG_GAP="fragGap",ErrorDetails.REMUX_ALLOC_ERROR="remuxAllocError",ErrorDetails.KEY_LOAD_ERROR="keyLoadError",ErrorDetails.KEY_LOAD_TIMEOUT="keyLoadTimeOut",ErrorDetails.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",ErrorDetails.BUFFER_APPEND_ERROR="bufferAppendError",ErrorDetails.BUFFER_APPENDING_ERROR="bufferAppendingError",ErrorDetails.BUFFER_STALLED_ERROR="bufferStalledError",ErrorDetails.BUFFER_FULL_ERROR="bufferFullError",ErrorDetails.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",ErrorDetails.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",ErrorDetails.INTERNAL_EXCEPTION="internalException",ErrorDetails.INTERNAL_ABORTED="aborted",ErrorDetails.UNKNOWN="unknown",ErrorDetails}({});const noop=function noop(){},fakeLogger={trace:noop,debug:noop,log:noop,warn:noop,info:noop,error:noop};let exportedLogger=fakeLogger;function exportLoggerFunctions(debugConfig,...functions){functions.forEach((function(type){exportedLogger[type]=debugConfig[type]?debugConfig[type].bind(debugConfig):function consolePrintFn(type){const func=self.console[type];return func?func.bind(self.console,`[${type}] >`):noop}(type)}))}const logger=exportedLogger,DECIMAL_RESOLUTION_REGEX=/^(\d+)x(\d+)$/,ATTR_LIST_REGEX=/(.+?)=(".*?"|.*?)(?:,|$)/g;class AttrList{constructor(attrs){"string"==typeof attrs&&(attrs=AttrList.parseAttrList(attrs)),_extends(this,attrs)}get clientAttrs(){return Object.keys(this).filter((attr=>"X-"===attr.substring(0,2)))}decimalInteger(attrName){const intValue=parseInt(this[attrName],10);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue}hexadecimalInteger(attrName){if(this[attrName]){let stringValue=(this[attrName]||"0x").slice(2);stringValue=(1&stringValue.length?"0":"")+stringValue;const value=new Uint8Array(stringValue.length/2);for(let i=0;i<stringValue.length/2;i++)value[i]=parseInt(stringValue.slice(2*i,2*i+2),16);return value}return null}hexadecimalIntegerAsNumber(attrName){const intValue=parseInt(this[attrName],16);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue}decimalFloatingPoint(attrName){return parseFloat(this[attrName])}optionalFloat(attrName,defaultValue){const value=this[attrName];return value?parseFloat(value):defaultValue}enumeratedString(attrName){return this[attrName]}bool(attrName){return"YES"===this[attrName]}decimalResolution(attrName){const res=DECIMAL_RESOLUTION_REGEX.exec(this[attrName]);if(null!==res)return{width:parseInt(res[1],10),height:parseInt(res[2],10)}}static parseAttrList(input){let match;const attrs={};for(ATTR_LIST_REGEX.lastIndex=0;null!==(match=ATTR_LIST_REGEX.exec(input));){let value=match[2];0===value.indexOf('"')&&value.lastIndexOf('"')===value.length-1&&(value=value.slice(1,-1));attrs[match[1].trim()]=value}return attrs}}function isSCTE35Attribute(attrName){return"SCTE35-OUT"===attrName||"SCTE35-IN"===attrName}class DateRange{constructor(dateRangeAttr,dateRangeWithSameId){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,dateRangeWithSameId){const previousAttr=dateRangeWithSameId.attr;for(const key in previousAttr)if(Object.prototype.hasOwnProperty.call(dateRangeAttr,key)&&dateRangeAttr[key]!==previousAttr[key]){logger.warn(`DATERANGE tag attribute: "${key}" does not match for tags with ID: "${dateRangeAttr.ID}"`),this._badValueForSameId=key;break}dateRangeAttr=_extends(new AttrList({}),previousAttr,dateRangeAttr)}if(this.attr=dateRangeAttr,this._startDate=new Date(dateRangeAttr["START-DATE"]),"END-DATE"in this.attr){const endDate=new Date(this.attr["END-DATE"]);isFiniteNumber(endDate.getTime())&&(this._endDate=endDate)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const duration=this.duration;return null!==duration?new Date(this._startDate.getTime()+1e3*duration):null}get duration(){if("DURATION"in this.attr){const duration=this.attr.decimalFloatingPoint("DURATION");if(isFiniteNumber(duration))return duration}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&isFiniteNumber(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class LoadStats{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var ElementaryStreamTypes_AUDIO="audio",ElementaryStreamTypes_VIDEO="video",ElementaryStreamTypes_AUDIOVIDEO="audiovideo";class BaseSegment{constructor(baseurl){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[ElementaryStreamTypes_AUDIO]:null,[ElementaryStreamTypes_VIDEO]:null,[ElementaryStreamTypes_AUDIOVIDEO]:null},this.baseurl=baseurl}setByteRange(value,previous){const params=value.split("@",2);let start;start=1===params.length?(null==previous?void 0:previous.byteRangeEndOffset)||0:parseInt(params[1]),this._byteRange=[start,parseInt(params[0])+start]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=urlToolkitExports.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(value){this._url=value}}class Fragment extends BaseSegment{constructor(type,baseurl){super(baseurl),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new LoadStats,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=type}get decryptdata(){const{levelkeys}=this;if(!levelkeys&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const key=this.levelkeys.identity;if(key)this._decryptdata=key.getDecryptData(this.sn);else{const keyFormats=Object.keys(this.levelkeys);if(1===keyFormats.length)return this._decryptdata=this.levelkeys[keyFormats[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!isFiniteNumber(this.programDateTime))return null;const duration=isFiniteNumber(this.duration)?this.duration:0;return this.programDateTime+1e3*duration}get encrypted(){var _this$_decryptdata;if(null!=(_this$_decryptdata=this._decryptdata)&&_this$_decryptdata.encrypted)return!0;if(this.levelkeys){const keyFormats=Object.keys(this.levelkeys),len=keyFormats.length;if(len>1||1===len&&this.levelkeys[keyFormats[0]].encrypted)return!0}return!1}setKeyFormat(keyFormat){if(this.levelkeys){const key=this.levelkeys[keyFormat];key&&!this._decryptdata&&(this._decryptdata=key.getDecryptData(this.sn))}}abortRequests(){var _this$loader,_this$keyLoader;null==(_this$loader=this.loader)||_this$loader.abort(),null==(_this$keyLoader=this.keyLoader)||_this$keyLoader.abort()}setElementaryStreamInfo(type,startPTS,endPTS,startDTS,endDTS,partial=!1){const{elementaryStreams}=this,info=elementaryStreams[type];info?(info.startPTS=Math.min(info.startPTS,startPTS),info.endPTS=Math.max(info.endPTS,endPTS),info.startDTS=Math.min(info.startDTS,startDTS),info.endDTS=Math.max(info.endDTS,endDTS)):elementaryStreams[type]={startPTS,endPTS,startDTS,endDTS,partial}}clearElementaryStreamInfo(){const{elementaryStreams}=this;elementaryStreams[ElementaryStreamTypes_AUDIO]=null,elementaryStreams[ElementaryStreamTypes_VIDEO]=null,elementaryStreams[ElementaryStreamTypes_AUDIOVIDEO]=null}}class Part extends BaseSegment{constructor(partAttrs,frag,baseurl,index,previous){super(baseurl),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new LoadStats,this.duration=partAttrs.decimalFloatingPoint("DURATION"),this.gap=partAttrs.bool("GAP"),this.independent=partAttrs.bool("INDEPENDENT"),this.relurl=partAttrs.enumeratedString("URI"),this.fragment=frag,this.index=index;const byteRange=partAttrs.enumeratedString("BYTERANGE");byteRange&&this.setByteRange(byteRange,previous),previous&&(this.fragOffset=previous.fragOffset+previous.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams}=this;return!!(elementaryStreams.audio||elementaryStreams.video||elementaryStreams.audiovideo)}}class LevelDetails{constructor(baseUrl){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=baseUrl}reloaded(previous){if(!previous)return this.advanced=!0,void(this.updated=!0);const partSnDiff=this.lastPartSn-previous.lastPartSn,partIndexDiff=this.lastPartIndex-previous.lastPartIndex;this.updated=this.endSN!==previous.endSN||!!partIndexDiff||!!partSnDiff||!this.live,this.advanced=this.endSN>previous.endSN||partSnDiff>0||0===partSnDiff&&partIndexDiff>0,this.updated||this.advanced?this.misses=Math.floor(.6*previous.misses):this.misses=previous.misses+1,this.availabilityDelay=previous.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&isFiniteNumber(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const runTime=this.driftEndTime-this.driftStartTime;if(runTime>0){return 1e3*(this.driftEnd-this.driftStart)/runTime}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var _this$partList;return null!=(_this$partList=this.partList)&&_this$partList.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var _this$fragments;return null!=(_this$fragments=this.fragments)&&_this$fragments.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var _this$partList2;return null!=(_this$partList2=this.partList)&&_this$partList2.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var _this$partList3;return null!=(_this$partList3=this.partList)&&_this$partList3.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function base64Decode(base64encodedStr){return Uint8Array.from(atob(base64encodedStr),(c=>c.charCodeAt(0)))}function convertDataUriToArrayBytes(uri){const colonsplit=uri.split(":");let keydata=null;if("data"===colonsplit[0]&&2===colonsplit.length){const semicolonsplit=colonsplit[1].split(";"),commasplit=semicolonsplit[semicolonsplit.length-1].split(",");if(2===commasplit.length){const isbase64="base64"===commasplit[0],data=commasplit[1];isbase64?(semicolonsplit.splice(-1,1),keydata=base64Decode(data)):keydata=function getKeyIdBytes(str){const keyIdbytes=strToUtf8array(str).subarray(0,16),paddedkeyIdbytes=new Uint8Array(16);return paddedkeyIdbytes.set(keyIdbytes,16-keyIdbytes.length),paddedkeyIdbytes}(data)}}return keydata}function strToUtf8array(str){return Uint8Array.from(unescape(encodeURIComponent(str)),(c=>c.charCodeAt(0)))}const optionalSelf="undefined"!=typeof self?self:void 0;var KeySystems={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},KeySystemFormats_CLEARKEY="org.w3.clearkey",KeySystemFormats_FAIRPLAY="com.apple.streamingkeydelivery",KeySystemFormats_PLAYREADY="com.microsoft.playready",KeySystemFormats_WIDEVINE="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";function keySystemFormatToKeySystemDomain(format){switch(format){case KeySystemFormats_FAIRPLAY:return KeySystems.FAIRPLAY;case KeySystemFormats_PLAYREADY:return KeySystems.PLAYREADY;case KeySystemFormats_WIDEVINE:return KeySystems.WIDEVINE;case KeySystemFormats_CLEARKEY:return KeySystems.CLEARKEY}}var KeySystemIds_WIDEVINE="edef8ba979d64acea3c827dcd51d21ed";function keySystemDomainToKeySystemFormat(keySystem){switch(keySystem){case KeySystems.FAIRPLAY:return KeySystemFormats_FAIRPLAY;case KeySystems.PLAYREADY:return KeySystemFormats_PLAYREADY;case KeySystems.WIDEVINE:return KeySystemFormats_WIDEVINE;case KeySystems.CLEARKEY:return KeySystemFormats_CLEARKEY}}function getKeySystemsForConfig(config){const{drmSystems,widevineLicenseUrl}=config,keySystemsToAttempt=drmSystems?[KeySystems.FAIRPLAY,KeySystems.WIDEVINE,KeySystems.PLAYREADY,KeySystems.CLEARKEY].filter((keySystem=>!!drmSystems[keySystem])):[];return!keySystemsToAttempt[KeySystems.WIDEVINE]&&widevineLicenseUrl&&keySystemsToAttempt.push(KeySystems.WIDEVINE),keySystemsToAttempt}const requestMediaKeySystemAccess=null!=optionalSelf&&null!=(_optionalSelf$navigat=optionalSelf.navigator)&&_optionalSelf$navigat.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var _optionalSelf$navigat;function sliceUint8(array,start,end){return Uint8Array.prototype.slice?array.slice(start,end):new Uint8Array(Array.prototype.slice.call(array,start,end))}const isHeader$2=(data,offset)=>offset+10<=data.length&&73===data[offset]&&68===data[offset+1]&&51===data[offset+2]&&data[offset+3]<255&&data[offset+4]<255&&data[offset+6]<128&&data[offset+7]<128&&data[offset+8]<128&&data[offset+9]<128,isFooter=(data,offset)=>offset+10<=data.length&&51===data[offset]&&68===data[offset+1]&&73===data[offset+2]&&data[offset+3]<255&&data[offset+4]<255&&data[offset+6]<128&&data[offset+7]<128&&data[offset+8]<128&&data[offset+9]<128,getID3Data=(data,offset)=>{const front=offset;let length=0;for(;isHeader$2(data,offset);){length+=10;length+=readSize(data,offset+6),isFooter(data,offset+10)&&(length+=10),offset+=length}if(length>0)return data.subarray(front,front+length)},readSize=(data,offset)=>{let size=0;return size=(127&data[offset])<<21,size|=(127&data[offset+1])<<14,size|=(127&data[offset+2])<<7,size|=127&data[offset+3],size},canParse$2=(data,offset)=>isHeader$2(data,offset)&&readSize(data,offset+6)+10<=data.length-offset,getTimeStamp=data=>{const frames=getID3Frames(data);for(let i=0;i<frames.length;i++){const frame=frames[i];if(isTimeStampFrame(frame))return readTimeStamp(frame)}},isTimeStampFrame=frame=>frame&&"PRIV"===frame.key&&"com.apple.streaming.transportStreamTimestamp"===frame.info,getFrameData=data=>{const type=String.fromCharCode(data[0],data[1],data[2],data[3]),size=readSize(data,4);return{type,size,data:data.subarray(10,10+size)}},getID3Frames=id3Data=>{let offset=0;const frames=[];for(;isHeader$2(id3Data,offset);){const size=readSize(id3Data,offset+6);offset+=10;const end=offset+size;for(;offset+8<end;){const frameData=getFrameData(id3Data.subarray(offset)),frame=decodeFrame(frameData);frame&&frames.push(frame),offset+=frameData.size+10}isFooter(id3Data,offset)&&(offset+=10)}return frames},decodeFrame=frame=>"PRIV"===frame.type?decodePrivFrame(frame):"W"===frame.type[0]?decodeURLFrame(frame):decodeTextFrame(frame),decodePrivFrame=frame=>{if(frame.size<2)return;const owner=utf8ArrayToStr(frame.data,!0),privateData=new Uint8Array(frame.data.subarray(owner.length+1));return{key:frame.type,info:owner,data:privateData.buffer}},decodeTextFrame=frame=>{if(frame.size<2)return;if("TXXX"===frame.type){let index=1;const description=utf8ArrayToStr(frame.data.subarray(index),!0);index+=description.length+1;const value=utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value}}const text=utf8ArrayToStr(frame.data.subarray(1));return{key:frame.type,data:text}},decodeURLFrame=frame=>{if("WXXX"===frame.type){if(frame.size<2)return;let index=1;const description=utf8ArrayToStr(frame.data.subarray(index),!0);index+=description.length+1;const value=utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value}}const url=utf8ArrayToStr(frame.data);return{key:frame.type,data:url}},readTimeStamp=timeStampFrame=>{if(8===timeStampFrame.data.byteLength){const data=new Uint8Array(timeStampFrame.data),pts33Bit=1&data[3];let timestamp=(data[4]<<23)+(data[5]<<15)+(data[6]<<7)+data[7];return timestamp/=45,pts33Bit&&(timestamp+=47721858.84),Math.round(timestamp)}},utf8ArrayToStr=(array,exitOnNull=!1)=>{const decoder=getTextDecoder();if(decoder){const decoded=decoder.decode(array);if(exitOnNull){const idx=decoded.indexOf("\0");return-1!==idx?decoded.substring(0,idx):decoded}return decoded.replace(/\0/g,"")}const len=array.length;let c,char2,char3,out="",i=0;for(;i<len;){if(c=array[i++],0===c&&exitOnNull)return out;if(0!==c&&3!==c)switch(c>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:out+=String.fromCharCode(c);break;case 12:case 13:char2=array[i++],out+=String.fromCharCode((31&c)<<6|63&char2);break;case 14:char2=array[i++],char3=array[i++],out+=String.fromCharCode((15&c)<<12|(63&char2)<<6|(63&char3)<<0)}}return out};let decoder;function getTextDecoder(){if(!navigator.userAgent.includes("PlayStation 4"))return decoder||void 0===self.TextDecoder||(decoder=new self.TextDecoder("utf-8")),decoder}const Hex_hexDump=function(array){let str="";for(let i=0;i<array.length;i++){let h=array[i].toString(16);h.length<2&&(h="0"+h),str+=h}return str},UINT32_MAX$1=Math.pow(2,32)-1,push=[].push,RemuxerTrackIdConfig={video:1,audio:2,id3:3,text:4};function bin2str(data){return String.fromCharCode.apply(null,data)}function readUint16(buffer,offset){const val=buffer[offset]<<8|buffer[offset+1];return val<0?65536+val:val}function readUint32(buffer,offset){const val=readSint32(buffer,offset);return val<0?4294967296+val:val}function readSint32(buffer,offset){return buffer[offset]<<24|buffer[offset+1]<<16|buffer[offset+2]<<8|buffer[offset+3]}function writeUint32(buffer,offset,value){buffer[offset]=value>>24,buffer[offset+1]=value>>16&255,buffer[offset+2]=value>>8&255,buffer[offset+3]=255&value}function findBox(data,path){const results=[];if(!path.length)return results;const end=data.byteLength;for(let i=0;i<end;){const size=readUint32(data,i),endbox=size>1?i+size:end;if(bin2str(data.subarray(i+4,i+8))===path[0])if(1===path.length)results.push(data.subarray(i+8,endbox));else{const subresults=findBox(data.subarray(i+8,endbox),path.slice(1));subresults.length&&push.apply(results,subresults)}i=endbox}return results}function parseSegmentIndex(sidx){const references=[],version=sidx[0];let index=8;const timescale=readUint32(sidx,index);index+=4;index+=0===version?8:16,index+=2;let startByte=sidx.length+0;const referencesCount=readUint16(sidx,index);index+=2;for(let i=0;i<referencesCount;i++){let referenceIndex=index;const referenceInfo=readUint32(sidx,referenceIndex);referenceIndex+=4;const referenceSize=2147483647&referenceInfo;if(1===(2147483648&referenceInfo)>>>31)return logger.warn("SIDX has hierarchical references (not supported)"),null;const subsegmentDuration=readUint32(sidx,referenceIndex);referenceIndex+=4,references.push({referenceSize,subsegmentDuration,info:{duration:subsegmentDuration/timescale,start:startByte,end:startByte+referenceSize-1}}),startByte+=referenceSize,referenceIndex+=4,index=referenceIndex}return{earliestPresentationTime:0,timescale,version,referencesCount,references}}function parseInitSegment(initSegment){const result=[],traks=findBox(initSegment,["moov","trak"]);for(let i=0;i<traks.length;i++){const trak=traks[i],tkhd=findBox(trak,["tkhd"])[0];if(tkhd){let version=tkhd[0];const trackId=readUint32(tkhd,0===version?12:20),mdhd=findBox(trak,["mdia","mdhd"])[0];if(mdhd){version=mdhd[0];const timescale=readUint32(mdhd,0===version?12:20),hdlr=findBox(trak,["mdia","hdlr"])[0];if(hdlr){const hdlrType=bin2str(hdlr.subarray(8,12)),type={soun:ElementaryStreamTypes_AUDIO,vide:ElementaryStreamTypes_VIDEO}[hdlrType];if(type){const stsdData=parseStsd(findBox(trak,["mdia","minf","stbl","stsd"])[0]);result[trackId]={timescale,type},result[type]=_objectSpread2({timescale,id:trackId},stsdData)}}}}}return findBox(initSegment,["moov","mvex","trex"]).forEach((trex=>{const trackId=readUint32(trex,4),track=result[trackId];track&&(track.default={duration:readUint32(trex,12),flags:readUint32(trex,20)})})),result}function parseStsd(stsd){const sampleEntries=stsd.subarray(8),sampleEntriesEnd=sampleEntries.subarray(86),fourCC=bin2str(sampleEntries.subarray(4,8));let codec=fourCC;const encrypted="enca"===fourCC||"encv"===fourCC;if(encrypted){const encBox=findBox(sampleEntries,[fourCC])[0];findBox(encBox.subarray("enca"===fourCC?28:78),["sinf"]).forEach((sinf=>{const schm=findBox(sinf,["schm"])[0];if(schm){const scheme=bin2str(schm.subarray(4,8));if("cbcs"===scheme||"cenc"===scheme){const frma=findBox(sinf,["frma"])[0];frma&&(codec=bin2str(frma))}}}))}switch(codec){case"avc1":case"avc2":case"avc3":case"avc4":{const avcCBox=findBox(sampleEntriesEnd,["avcC"])[0];codec+="."+toHex(avcCBox[1])+toHex(avcCBox[2])+toHex(avcCBox[3]);break}case"mp4a":{const codecBox=findBox(sampleEntries,[fourCC])[0],esdsBox=findBox(codecBox.subarray(28),["esds"])[0];if(esdsBox&&esdsBox.length>12){let i=4;if(3!==esdsBox[i++])break;i=skipBERInteger(esdsBox,i),i+=2;const flags=esdsBox[i++];if(128&flags&&(i+=2),64&flags&&(i+=esdsBox[i++]),4!==esdsBox[i++])break;i=skipBERInteger(esdsBox,i);const objectType=esdsBox[i++];if(64!==objectType)break;if(codec+="."+toHex(objectType),i+=12,5!==esdsBox[i++])break;i=skipBERInteger(esdsBox,i);const firstByte=esdsBox[i++];let audioObjectType=(248&firstByte)>>3;31===audioObjectType&&(audioObjectType+=1+((7&firstByte)<<3)+((224&esdsBox[i])>>5)),codec+="."+audioObjectType}break}case"hvc1":case"hev1":{const hvcCBox=findBox(sampleEntriesEnd,["hvcC"])[0],profileByte=hvcCBox[1],profileSpace=["","A","B","C"][profileByte>>6],generalProfileIdc=31&profileByte,profileCompat=readUint32(hvcCBox,2),tierFlag=(32&profileByte)>>5?"H":"L",levelIDC=hvcCBox[12],constraintIndicator=hvcCBox.subarray(6,12);codec+="."+profileSpace+generalProfileIdc,codec+="."+profileCompat.toString(16).toUpperCase(),codec+="."+tierFlag+levelIDC;let constraintString="";for(let i=constraintIndicator.length;i--;){const byte=constraintIndicator[i];if(byte||constraintString){constraintString="."+byte.toString(16).toUpperCase()+constraintString}}codec+=constraintString;break}case"dvh1":case"dvhe":{const dvcCBox=findBox(sampleEntriesEnd,["dvcC"])[0],profile=dvcCBox[2]>>1&127,level=dvcCBox[2]<<5&32|dvcCBox[3]>>3&31;codec+="."+addLeadingZero(profile)+"."+addLeadingZero(level);break}case"vp09":{const vpcCBox=findBox(sampleEntriesEnd,["vpcC"])[0],profile=vpcCBox[4],level=vpcCBox[5],bitDepth=vpcCBox[6]>>4&15;codec+="."+addLeadingZero(profile)+"."+addLeadingZero(level)+"."+addLeadingZero(bitDepth);break}case"av01":{const av1CBox=findBox(sampleEntriesEnd,["av1C"])[0],profile=av1CBox[1]>>>5,level=31&av1CBox[1],tierFlag=av1CBox[2]>>>7?"H":"M",highBitDepth=(64&av1CBox[2])>>6,twelveBit=(32&av1CBox[2])>>5,bitDepth=2===profile&&highBitDepth?twelveBit?12:10:highBitDepth?10:8,monochrome=(16&av1CBox[2])>>4,chromaSubsamplingX=(8&av1CBox[2])>>3,chromaSubsamplingY=(4&av1CBox[2])>>2,chromaSamplePosition=3&av1CBox[2],colorPrimaries=1,transferCharacteristics=1,matrixCoefficients=1,videoFullRangeFlag=0;codec+="."+profile+"."+addLeadingZero(level)+tierFlag+"."+addLeadingZero(bitDepth)+"."+monochrome+"."+chromaSubsamplingX+chromaSubsamplingY+chromaSamplePosition+"."+addLeadingZero(colorPrimaries)+"."+addLeadingZero(transferCharacteristics)+"."+addLeadingZero(matrixCoefficients)+"."+videoFullRangeFlag;break}}return{codec,encrypted}}function skipBERInteger(bytes,i){const limit=i+5;for(;128&bytes[i++]&&i<limit;);return i}function toHex(x){return("0"+x.toString(16).toUpperCase()).slice(-2)}function addLeadingZero(num){return(num<10?"0":"")+num}function parseSinf(sinf){const schm=findBox(sinf,["schm"])[0];if(schm){const scheme=bin2str(schm.subarray(4,8));if("cbcs"===scheme||"cenc"===scheme)return findBox(sinf,["schi","tenc"])[0]}return logger.error("[eme] missing 'schm' box"),null}function computeRawDurationFromSamples(trun){const flags=readUint32(trun,0);let offset=8;1&flags&&(offset+=4),4&flags&&(offset+=4);let duration=0;const sampleCount=readUint32(trun,4);for(let i=0;i<sampleCount;i++){if(256&flags){duration+=readUint32(trun,offset),offset+=4}512&flags&&(offset+=4),1024&flags&&(offset+=4),2048&flags&&(offset+=4)}return duration}function appendUint8Array(data1,data2){const temp=new Uint8Array(data1.length+data2.length);return temp.set(data1),temp.set(data2,data1.length),temp}function parseSamples(timeOffset,track){const seiSamples=[],videoData=track.samples,timescale=track.timescale,trackId=track.id;let isHEVCFlavor=!1;return findBox(videoData,["moof"]).map((moof=>{const moofOffset=moof.byteOffset-8;findBox(moof,["traf"]).map((traf=>{const baseTime=findBox(traf,["tfdt"]).map((tfdt=>{const version=tfdt[0];let result=readUint32(tfdt,4);return 1===version&&(result*=Math.pow(2,32),result+=readUint32(tfdt,8)),result/timescale}))[0];return void 0!==baseTime&&(timeOffset=baseTime),findBox(traf,["tfhd"]).map((tfhd=>{const id=readUint32(tfhd,4),tfhdFlags=16777215&readUint32(tfhd,0);let defaultSampleDuration=0;const defaultSampleSizePresent=0!=(16&tfhdFlags);let defaultSampleSize=0;const defaultSampleFlagsPresent=0!=(32&tfhdFlags);let tfhdOffset=8;id===trackId&&(0!=(1&tfhdFlags)&&(tfhdOffset+=8),0!=(2&tfhdFlags)&&(tfhdOffset+=4),0!=(8&tfhdFlags)&&(defaultSampleDuration=readUint32(tfhd,tfhdOffset),tfhdOffset+=4),defaultSampleSizePresent&&(defaultSampleSize=readUint32(tfhd,tfhdOffset),tfhdOffset+=4),defaultSampleFlagsPresent&&(tfhdOffset+=4),"video"===track.type&&(isHEVCFlavor=function isHEVC(codec){if(!codec)return!1;const delimit=codec.indexOf("."),baseCodec=delimit<0?codec:codec.substring(0,delimit);return"hvc1"===baseCodec||"hev1"===baseCodec||"dvh1"===baseCodec||"dvhe"===baseCodec}(track.codec)),findBox(traf,["trun"]).map((trun=>{const version=trun[0],flags=16777215&readUint32(trun,0),dataOffsetPresent=0!=(1&flags);let dataOffset=0;const firstSampleFlagsPresent=0!=(4&flags),sampleDurationPresent=0!=(256&flags);let sampleDuration=0;const sampleSizePresent=0!=(512&flags);let sampleSize=0;const sampleFlagsPresent=0!=(1024&flags),sampleCompositionOffsetsPresent=0!=(2048&flags);let compositionOffset=0;const sampleCount=readUint32(trun,4);let trunOffset=8;dataOffsetPresent&&(dataOffset=readUint32(trun,trunOffset),trunOffset+=4),firstSampleFlagsPresent&&(trunOffset+=4);let sampleOffset=dataOffset+moofOffset;for(let ix=0;ix<sampleCount;ix++){if(sampleDurationPresent?(sampleDuration=readUint32(trun,trunOffset),trunOffset+=4):sampleDuration=defaultSampleDuration,sampleSizePresent?(sampleSize=readUint32(trun,trunOffset),trunOffset+=4):sampleSize=defaultSampleSize,sampleFlagsPresent&&(trunOffset+=4),sampleCompositionOffsetsPresent&&(compositionOffset=0===version?readUint32(trun,trunOffset):readSint32(trun,trunOffset),trunOffset+=4),track.type===ElementaryStreamTypes_VIDEO){let naluTotalSize=0;for(;naluTotalSize<sampleSize;){const naluSize=readUint32(videoData,sampleOffset);if(sampleOffset+=4,isSEIMessage(isHEVCFlavor,videoData[sampleOffset])){parseSEIMessageFromNALu(videoData.subarray(sampleOffset,sampleOffset+naluSize),isHEVCFlavor?2:1,timeOffset+compositionOffset/timescale,seiSamples)}sampleOffset+=naluSize,naluTotalSize+=naluSize+4}}timeOffset+=sampleDuration/timescale}})))}))}))})),seiSamples}function isSEIMessage(isHEVCFlavor,naluHeader){if(isHEVCFlavor){const naluType=naluHeader>>1&63;return 39===naluType||40===naluType}return 6===(31&naluHeader)}function parseSEIMessageFromNALu(unescapedData,headerSize,pts,samples){const data=discardEPB(unescapedData);let seiPtr=0;seiPtr+=headerSize;let payloadType=0,payloadSize=0,b=0;for(;seiPtr<data.length;){payloadType=0;do{if(seiPtr>=data.length)break;b=data[seiPtr++],payloadType+=b}while(255===b);payloadSize=0;do{if(seiPtr>=data.length)break;b=data[seiPtr++],payloadSize+=b}while(255===b);const leftOver=data.length-seiPtr;let payPtr=seiPtr;if(payloadSize<leftOver)seiPtr+=payloadSize;else if(payloadSize>leftOver){logger.error(`Malformed SEI payload. ${payloadSize} is too small, only ${leftOver} bytes left to parse.`);break}if(4===payloadType){if(181===data[payPtr++]){const providerCode=readUint16(data,payPtr);if(payPtr+=2,49===providerCode){const userStructure=readUint32(data,payPtr);if(payPtr+=4,1195456820===userStructure){const userDataType=data[payPtr++];if(3===userDataType){const firstByte=data[payPtr++],enabled=64&firstByte,totalBytes=enabled?2+3*(31&firstByte):0,byteArray=new Uint8Array(totalBytes);if(enabled){byteArray[0]=firstByte;for(let i=1;i<totalBytes;i++)byteArray[i]=data[payPtr++]}samples.push({type:userDataType,payloadType,pts,bytes:byteArray})}}}}}else if(5===payloadType&&payloadSize>16){const uuidStrArray=[];for(let i=0;i<16;i++){const _b=data[payPtr++].toString(16);uuidStrArray.push(1==_b.length?"0"+_b:_b),3!==i&&5!==i&&7!==i&&9!==i||uuidStrArray.push("-")}const length=payloadSize-16,userDataBytes=new Uint8Array(length);for(let i=0;i<length;i++)userDataBytes[i]=data[payPtr++];samples.push({payloadType,pts,uuid:uuidStrArray.join(""),userData:utf8ArrayToStr(userDataBytes),userDataBytes})}}}function discardEPB(data){const length=data.byteLength,EPBPositions=[];let i=1;for(;i<length-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(EPBPositions.push(i+2),i+=2):i++;if(0===EPBPositions.length)return data;const newLength=length-EPBPositions.length,newData=new Uint8Array(newLength);let sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++)sourceIndex===EPBPositions[0]&&(sourceIndex++,EPBPositions.shift()),newData[i]=data[sourceIndex];return newData}function mp4pssh(systemId,keyids,data){if(16!==systemId.byteLength)throw new RangeError("Invalid system id");let version,kids,kidCount;if(keyids){version=1,kids=new Uint8Array(16*keyids.length);for(let ix=0;ix<keyids.length;ix++){const k=keyids[ix];if(16!==k.byteLength)throw new RangeError("Invalid key");kids.set(k,16*ix)}}else version=0,kids=new Uint8Array;version>0?(kidCount=new Uint8Array(4),keyids.length>0&&new DataView(kidCount.buffer).setUint32(0,keyids.length,!1)):kidCount=new Uint8Array;const dataSize=new Uint8Array(4);return data&&data.byteLength>0&&new DataView(dataSize.buffer).setUint32(0,data.byteLength,!1),function mp4Box(type,...payload){const len=payload.length;let size=8,i=len;for(;i--;)size+=payload[i].byteLength;const result=new Uint8Array(size);for(result[0]=size>>24&255,result[1]=size>>16&255,result[2]=size>>8&255,result[3]=255&size,result.set(type,4),i=0,size=8;i<len;i++)result.set(payload[i],size),size+=payload[i].byteLength;return result}([112,115,115,104],new Uint8Array([version,0,0,0]),systemId,kidCount,kids,dataSize,data||new Uint8Array)}let keyUriToKeyIdMap={};class LevelKey{static clearKeyUriToKeyIdMap(){keyUriToKeyIdMap={}}constructor(method,uri,format,formatversions=[1],iv=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=method,this.uri=uri,this.keyFormat=format,this.keyFormatVersions=formatversions,this.iv=iv,this.encrypted=!!method&&"NONE"!==method,this.isCommonEncryption=this.encrypted&&"AES-128"!==method}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case KeySystemFormats_FAIRPLAY:case KeySystemFormats_WIDEVINE:case KeySystemFormats_PLAYREADY:case KeySystemFormats_CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(sn){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof sn&&("AES-128"!==this.method||this.iv||logger.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),sn=0);const iv=function createInitializationVector(segmentNumber){const uint8View=new Uint8Array(16);for(let i=12;i<16;i++)uint8View[i]=segmentNumber>>8*(15-i)&255;return uint8View}(sn);return new LevelKey(this.method,this.uri,"identity",this.keyFormatVersions,iv)}const keyBytes=convertDataUriToArrayBytes(this.uri);if(keyBytes)switch(this.keyFormat){case KeySystemFormats_WIDEVINE:this.pssh=keyBytes,keyBytes.length>=22&&(this.keyId=keyBytes.subarray(keyBytes.length-22,keyBytes.length-6));break;case KeySystemFormats_PLAYREADY:{const PlayReadyKeySystemUUID=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=mp4pssh(PlayReadyKeySystemUUID,null,keyBytes);const keyBytesUtf16=new Uint16Array(keyBytes.buffer,keyBytes.byteOffset,keyBytes.byteLength/2),keyByteStr=String.fromCharCode.apply(null,Array.from(keyBytesUtf16)),xmlKeyBytes=keyByteStr.substring(keyByteStr.indexOf("<"),keyByteStr.length),keyData=(new DOMParser).parseFromString(xmlKeyBytes,"text/xml").getElementsByTagName("KID")[0];if(keyData){const keyId=keyData.childNodes[0]?keyData.childNodes[0].nodeValue:keyData.getAttribute("VALUE");if(keyId){const keyIdArray=base64Decode(keyId).subarray(0,16);!function changeEndianness(keyId){const swap=function swap(array,from,to){const cur=array[from];array[from]=array[to],array[to]=cur};swap(keyId,0,3),swap(keyId,1,2),swap(keyId,4,5),swap(keyId,6,7)}(keyIdArray),this.keyId=keyIdArray}}break}default:{let keydata=keyBytes.subarray(0,16);if(16!==keydata.length){const padded=new Uint8Array(16);padded.set(keydata,16-keydata.length),keydata=padded}this.keyId=keydata;break}}if(!this.keyId||16!==this.keyId.byteLength){let keyId=keyUriToKeyIdMap[this.uri];if(!keyId){const val=Object.keys(keyUriToKeyIdMap).length%Number.MAX_SAFE_INTEGER;keyId=new Uint8Array(16);new DataView(keyId.buffer,12,4).setUint32(0,val),keyUriToKeyIdMap[this.uri]=keyId}this.keyId=keyId}return this}}const VARIABLE_REPLACEMENT_REGEX=/\{\$([a-zA-Z0-9-_]+)\}/g;function hasVariableReferences(str){return VARIABLE_REPLACEMENT_REGEX.test(str)}function substituteVariablesInAttributes(parsed,attr,attributeNames){if(null!==parsed.variableList||parsed.hasVariableRefs)for(let i=attributeNames.length;i--;){const name=attributeNames[i],value=attr[name];value&&(attr[name]=substituteVariables(parsed,value))}}function substituteVariables(parsed,value){if(null!==parsed.variableList||parsed.hasVariableRefs){const variableList=parsed.variableList;return value.replace(VARIABLE_REPLACEMENT_REGEX,(variableReference=>{const variableName=variableReference.substring(2,variableReference.length-1),variableValue=null==variableList?void 0:variableList[variableName];return void 0===variableValue?(parsed.playlistParsingError||(parsed.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${variableName}"`)),variableReference):variableValue}))}return value}function addVariableDefinition(parsed,attr,parentUrl){let NAME,VALUE,variableList=parsed.variableList;if(variableList||(parsed.variableList=variableList={}),"QUERYPARAM"in attr){NAME=attr.QUERYPARAM;try{const searchParams=new self.URL(parentUrl).searchParams;if(!searchParams.has(NAME))throw new Error(`"${NAME}" does not match any query parameter in URI: "${parentUrl}"`);VALUE=searchParams.get(NAME)}catch(error){parsed.playlistParsingError||(parsed.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${error.message}`))}}else NAME=attr.NAME,VALUE=attr.VALUE;NAME in variableList?parsed.playlistParsingError||(parsed.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${NAME}"`)):variableList[NAME]=VALUE||""}function importVariableDefinition(parsed,attr,sourceVariableList){const IMPORT=attr.IMPORT;if(sourceVariableList&&IMPORT in sourceVariableList){let variableList=parsed.variableList;variableList||(parsed.variableList=variableList={}),variableList[IMPORT]=sourceVariableList[IMPORT]}else parsed.playlistParsingError||(parsed.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${IMPORT}"`))}function getMediaSource(preferManagedMediaSource=!0){if("undefined"==typeof self)return;return(preferManagedMediaSource||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const sampleEntryCodesISO={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function areCodecsMediaSourceSupported(codecs,type,preferManagedMediaSource=!0){return!codecs.split(",").some((codec=>!isCodecMediaSourceSupported(codec,type,preferManagedMediaSource)))}function isCodecMediaSourceSupported(codec,type,preferManagedMediaSource=!0){var _MediaSource$isTypeSu;const MediaSource=getMediaSource(preferManagedMediaSource);return null!=(_MediaSource$isTypeSu=null==MediaSource?void 0:MediaSource.isTypeSupported(mimeTypeForCodec(codec,type)))&&_MediaSource$isTypeSu}function mimeTypeForCodec(codec,type){return`${type}/mp4;codecs="${codec}"`}function videoCodecPreferenceValue(videoCodec){if(videoCodec){const fourCC=videoCodec.substring(0,4);return sampleEntryCodesISO.video[fourCC]}return 2}function codecsSetSelectionPreferenceValue(codecSet){return codecSet.split(",").reduce(((num,fourCC)=>{const preferenceValue=sampleEntryCodesISO.video[fourCC];return preferenceValue?(2*preferenceValue+num)/(num?3:2):(sampleEntryCodesISO.audio[fourCC]+num)/(num?2:1)}),0)}const CODEC_COMPATIBLE_NAMES={};const AUDIO_CODEC_REGEXP=/flac|opus/i;function getCodecCompatibleName(codec,preferManagedMediaSource=!0){return codec.replace(AUDIO_CODEC_REGEXP,(m=>function getCodecCompatibleNameLower(lowerCaseCodec,preferManagedMediaSource=!0){if(CODEC_COMPATIBLE_NAMES[lowerCaseCodec])return CODEC_COMPATIBLE_NAMES[lowerCaseCodec];const codecsToCheck={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[lowerCaseCodec];for(let i=0;i<codecsToCheck.length;i++)if(isCodecMediaSourceSupported(codecsToCheck[i],"audio",preferManagedMediaSource))return CODEC_COMPATIBLE_NAMES[lowerCaseCodec]=codecsToCheck[i],codecsToCheck[i];return lowerCaseCodec}(m.toLowerCase(),preferManagedMediaSource)))}function pickMostCompleteCodecName(parsedCodec,levelCodec){return parsedCodec&&"mp4a"!==parsedCodec?parsedCodec:levelCodec}const MASTER_PLAYLIST_REGEX=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,MASTER_PLAYLIST_MEDIA_REGEX=/#EXT-X-MEDIA:(.*)/g,IS_MEDIA_PLAYLIST=/^#EXT(?:INF|-X-TARGETDURATION):/m,LEVEL_PLAYLIST_REGEX_FAST=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),LEVEL_PLAYLIST_REGEX_SLOW=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class M3U8Parser{static findGroup(groups,mediaGroupId){for(let i=0;i<groups.length;i++){const group=groups[i];if(group.id===mediaGroupId)return group}}static resolve(url,baseUrl){return urlToolkitExports.buildAbsoluteURL(baseUrl,url,{alwaysNormalize:!0})}static isMediaPlaylist(str){return IS_MEDIA_PLAYLIST.test(str)}static parseMasterPlaylist(string,baseurl){const parsed={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:hasVariableReferences(string)},levelsWithKnownCodecs=[];let result;for(MASTER_PLAYLIST_REGEX.lastIndex=0;null!=(result=MASTER_PLAYLIST_REGEX.exec(string));)if(result[1]){var _level$unknownCodecs;const attrs=new AttrList(result[1]);substituteVariablesInAttributes(parsed,attrs,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const uri=substituteVariables(parsed,result[2]),level={attrs,bitrate:attrs.decimalInteger("BANDWIDTH")||attrs.decimalInteger("AVERAGE-BANDWIDTH"),name:attrs.NAME,url:M3U8Parser.resolve(uri,baseurl)},resolution=attrs.decimalResolution("RESOLUTION");resolution&&(level.width=resolution.width,level.height=resolution.height),setCodecs(attrs.CODECS,level),null!=(_level$unknownCodecs=level.unknownCodecs)&&_level$unknownCodecs.length||levelsWithKnownCodecs.push(level),parsed.levels.push(level)}else if(result[3]){const tag=result[3],attributes=result[4];switch(tag){case"SESSION-DATA":{const sessionAttrs=new AttrList(attributes);substituteVariablesInAttributes(parsed,sessionAttrs,["DATA-ID","LANGUAGE","VALUE","URI"]);const dataId=sessionAttrs["DATA-ID"];dataId&&(null===parsed.sessionData&&(parsed.sessionData={}),parsed.sessionData[dataId]=sessionAttrs);break}case"SESSION-KEY":{const sessionKey=parseKey(attributes,baseurl,parsed);sessionKey.encrypted&&sessionKey.isSupported()?(null===parsed.sessionKeys&&(parsed.sessionKeys=[]),parsed.sessionKeys.push(sessionKey)):logger.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${attributes}"`);break}case"DEFINE":{const variableAttributes=new AttrList(attributes);substituteVariablesInAttributes(parsed,variableAttributes,["NAME","VALUE","QUERYPARAM"]),addVariableDefinition(parsed,variableAttributes,baseurl)}break;case"CONTENT-STEERING":{const contentSteeringAttributes=new AttrList(attributes);substituteVariablesInAttributes(parsed,contentSteeringAttributes,["SERVER-URI","PATHWAY-ID"]),parsed.contentSteering={uri:M3U8Parser.resolve(contentSteeringAttributes["SERVER-URI"],baseurl),pathwayId:contentSteeringAttributes["PATHWAY-ID"]||"."};break}case"START":parsed.startTimeOffset=parseStartTimeOffset(attributes)}}const stripUnknownCodecLevels=levelsWithKnownCodecs.length>0&&levelsWithKnownCodecs.length<parsed.levels.length;return parsed.levels=stripUnknownCodecLevels?levelsWithKnownCodecs:parsed.levels,0===parsed.levels.length&&(parsed.playlistParsingError=new Error("no levels found in manifest")),parsed}static parseMasterPlaylistMedia(string,baseurl,parsed){let result;const results={},levels=parsed.levels,groupsByType={AUDIO:levels.map((level=>({id:level.attrs.AUDIO,audioCodec:level.audioCodec}))),SUBTITLES:levels.map((level=>({id:level.attrs.SUBTITLES,textCodec:level.textCodec}))),"CLOSED-CAPTIONS":[]};let id=0;for(MASTER_PLAYLIST_MEDIA_REGEX.lastIndex=0;null!==(result=MASTER_PLAYLIST_MEDIA_REGEX.exec(string));){const attrs=new AttrList(result[1]),type=attrs.TYPE;if(type){const groups=groupsByType[type],medias=results[type]||[];results[type]=medias,substituteVariablesInAttributes(parsed,attrs,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const lang=attrs.LANGUAGE,assocLang=attrs["ASSOC-LANGUAGE"],channels=attrs.CHANNELS,characteristics=attrs.CHARACTERISTICS,instreamId=attrs["INSTREAM-ID"],media={attrs,bitrate:0,id:id++,groupId:attrs["GROUP-ID"]||"",name:attrs.NAME||lang||"",type,default:attrs.bool("DEFAULT"),autoselect:attrs.bool("AUTOSELECT"),forced:attrs.bool("FORCED"),lang,url:attrs.URI?M3U8Parser.resolve(attrs.URI,baseurl):""};if(assocLang&&(media.assocLang=assocLang),channels&&(media.channels=channels),characteristics&&(media.characteristics=characteristics),instreamId&&(media.instreamId=instreamId),null!=groups&&groups.length){const groupCodec=M3U8Parser.findGroup(groups,media.groupId)||groups[0];assignCodec(media,groupCodec,"audioCodec"),assignCodec(media,groupCodec,"textCodec")}medias.push(media)}}return results}static parseLevelPlaylist(string,baseurl,id,type,levelUrlId,multivariantVariableList){const level=new LevelDetails(baseurl),fragments=level.fragments;let result,i,levelkeys,currentInitSegment=null,currentSN=0,currentPart=0,totalduration=0,discontinuityCounter=0,prevFrag=null,frag=new Fragment(type,baseurl),firstPdtIndex=-1,createNextFrag=!1,nextByteRange=null;for(LEVEL_PLAYLIST_REGEX_FAST.lastIndex=0,level.m3u8=string,level.hasVariableRefs=hasVariableReferences(string);null!==(result=LEVEL_PLAYLIST_REGEX_FAST.exec(string));){createNextFrag&&(createNextFrag=!1,frag=new Fragment(type,baseurl),frag.start=totalduration,frag.sn=currentSN,frag.cc=discontinuityCounter,frag.level=id,currentInitSegment&&(frag.initSegment=currentInitSegment,frag.rawProgramDateTime=currentInitSegment.rawProgramDateTime,currentInitSegment.rawProgramDateTime=null,nextByteRange&&(frag.setByteRange(nextByteRange),nextByteRange=null)));const duration=result[1];if(duration){frag.duration=parseFloat(duration);const title=(" "+result[2]).slice(1);frag.title=title||null,frag.tagList.push(title?["INF",duration,title]:["INF",duration])}else if(result[3]){if(isFiniteNumber(frag.duration)){frag.start=totalduration,levelkeys&&setFragLevelKeys(frag,levelkeys,level),frag.sn=currentSN,frag.level=id,frag.cc=discontinuityCounter,fragments.push(frag);const uri=(" "+result[3]).slice(1);frag.relurl=substituteVariables(level,uri),assignProgramDateTime(frag,prevFrag),prevFrag=frag,totalduration+=frag.duration,currentSN++,currentPart=0,createNextFrag=!0}}else if(result[4]){const data=(" "+result[4]).slice(1);prevFrag?frag.setByteRange(data,prevFrag):frag.setByteRange(data)}else if(result[5])frag.rawProgramDateTime=(" "+result[5]).slice(1),frag.tagList.push(["PROGRAM-DATE-TIME",frag.rawProgramDateTime]),-1===firstPdtIndex&&(firstPdtIndex=fragments.length);else{if(result=result[0].match(LEVEL_PLAYLIST_REGEX_SLOW),!result){logger.warn("No matches on slow regex match for level playlist!");continue}for(i=1;i<result.length&&void 0===result[i];i++);const tag=(" "+result[i]).slice(1),value1=(" "+result[i+1]).slice(1),value2=result[i+2]?(" "+result[i+2]).slice(1):"";switch(tag){case"PLAYLIST-TYPE":level.type=value1.toUpperCase();break;case"MEDIA-SEQUENCE":currentSN=level.startSN=parseInt(value1);break;case"SKIP":{const skipAttrs=new AttrList(value1);substituteVariablesInAttributes(level,skipAttrs,["RECENTLY-REMOVED-DATERANGES"]);const skippedSegments=skipAttrs.decimalInteger("SKIPPED-SEGMENTS");if(isFiniteNumber(skippedSegments)){level.skippedSegments=skippedSegments;for(let _i=skippedSegments;_i--;)fragments.unshift(null);currentSN+=skippedSegments}const recentlyRemovedDateranges=skipAttrs.enumeratedString("RECENTLY-REMOVED-DATERANGES");recentlyRemovedDateranges&&(level.recentlyRemovedDateranges=recentlyRemovedDateranges.split("\t"));break}case"TARGETDURATION":level.targetduration=Math.max(parseInt(value1),1);break;case"VERSION":level.version=parseInt(value1);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":level.live=!1;break;case"#":(value1||value2)&&frag.tagList.push(value2?[value1,value2]:[value1]);break;case"DISCONTINUITY":discontinuityCounter++,frag.tagList.push(["DIS"]);break;case"GAP":frag.gap=!0,frag.tagList.push([tag]);break;case"BITRATE":frag.tagList.push([tag,value1]);break;case"DATERANGE":{const dateRangeAttr=new AttrList(value1);substituteVariablesInAttributes(level,dateRangeAttr,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),substituteVariablesInAttributes(level,dateRangeAttr,dateRangeAttr.clientAttrs);const dateRange=new DateRange(dateRangeAttr,level.dateRanges[dateRangeAttr.ID]);dateRange.isValid||level.skippedSegments?level.dateRanges[dateRange.id]=dateRange:logger.warn(`Ignoring invalid DATERANGE tag: "${value1}"`),frag.tagList.push(["EXT-X-DATERANGE",value1]);break}case"DEFINE":{const variableAttributes=new AttrList(value1);substituteVariablesInAttributes(level,variableAttributes,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in variableAttributes?importVariableDefinition(level,variableAttributes,multivariantVariableList):addVariableDefinition(level,variableAttributes,baseurl)}break;case"DISCONTINUITY-SEQUENCE":discontinuityCounter=parseInt(value1);break;case"KEY":{const levelKey=parseKey(value1,baseurl,level);if(levelKey.isSupported()){if("NONE"===levelKey.method){levelkeys=void 0;break}levelkeys||(levelkeys={}),levelkeys[levelKey.keyFormat]&&(levelkeys=_extends({},levelkeys)),levelkeys[levelKey.keyFormat]=levelKey}else logger.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${value1}"`);break}case"START":level.startTimeOffset=parseStartTimeOffset(value1);break;case"MAP":{const mapAttrs=new AttrList(value1);if(substituteVariablesInAttributes(level,mapAttrs,["BYTERANGE","URI"]),frag.duration){const init=new Fragment(type,baseurl);setInitSegment(init,mapAttrs,id,levelkeys),currentInitSegment=init,frag.initSegment=currentInitSegment,currentInitSegment.rawProgramDateTime&&!frag.rawProgramDateTime&&(frag.rawProgramDateTime=currentInitSegment.rawProgramDateTime)}else{const end=frag.byteRangeEndOffset;if(end){const start=frag.byteRangeStartOffset;nextByteRange=`${end-start}@${start}`}else nextByteRange=null;setInitSegment(frag,mapAttrs,id,levelkeys),currentInitSegment=frag,createNextFrag=!0}break}case"SERVER-CONTROL":{const serverControlAttrs=new AttrList(value1);level.canBlockReload=serverControlAttrs.bool("CAN-BLOCK-RELOAD"),level.canSkipUntil=serverControlAttrs.optionalFloat("CAN-SKIP-UNTIL",0),level.canSkipDateRanges=level.canSkipUntil>0&&serverControlAttrs.bool("CAN-SKIP-DATERANGES"),level.partHoldBack=serverControlAttrs.optionalFloat("PART-HOLD-BACK",0),level.holdBack=serverControlAttrs.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const partInfAttrs=new AttrList(value1);level.partTarget=partInfAttrs.decimalFloatingPoint("PART-TARGET");break}case"PART":{let partList=level.partList;partList||(partList=level.partList=[]);const previousFragmentPart=currentPart>0?partList[partList.length-1]:void 0,index=currentPart++,partAttrs=new AttrList(value1);substituteVariablesInAttributes(level,partAttrs,["BYTERANGE","URI"]);const part=new Part(partAttrs,frag,baseurl,index,previousFragmentPart);partList.push(part),frag.duration+=part.duration;break}case"PRELOAD-HINT":{const preloadHintAttrs=new AttrList(value1);substituteVariablesInAttributes(level,preloadHintAttrs,["URI"]),level.preloadHint=preloadHintAttrs;break}case"RENDITION-REPORT":{const renditionReportAttrs=new AttrList(value1);substituteVariablesInAttributes(level,renditionReportAttrs,["URI"]),level.renditionReports=level.renditionReports||[],level.renditionReports.push(renditionReportAttrs);break}default:logger.warn(`line parsed but not handled: ${result}`)}}}prevFrag&&!prevFrag.relurl?(fragments.pop(),totalduration-=prevFrag.duration,level.partList&&(level.fragmentHint=prevFrag)):level.partList&&(assignProgramDateTime(frag,prevFrag),frag.cc=discontinuityCounter,level.fragmentHint=frag,levelkeys&&setFragLevelKeys(frag,levelkeys,level));const fragmentLength=fragments.length,firstFragment=fragments[0],lastFragment=fragments[fragmentLength-1];if(totalduration+=level.skippedSegments*level.targetduration,totalduration>0&&fragmentLength&&lastFragment){level.averagetargetduration=totalduration/fragmentLength;const lastSn=lastFragment.sn;level.endSN="initSegment"!==lastSn?lastSn:0,level.live||(lastFragment.endList=!0),firstFragment&&(level.startCC=firstFragment.cc)}else level.endSN=0,level.startCC=0;return level.fragmentHint&&(totalduration+=level.fragmentHint.duration),level.totalduration=totalduration,level.endCC=discontinuityCounter,firstPdtIndex>0&&function backfillProgramDateTimes(fragments,firstPdtIndex){let fragPrev=fragments[firstPdtIndex];for(let i=firstPdtIndex;i--;){const frag=fragments[i];if(!frag)return;frag.programDateTime=fragPrev.programDateTime-1e3*frag.duration,fragPrev=frag}}(fragments,firstPdtIndex),level}}function parseKey(keyTagAttributes,baseurl,parsed){var _keyAttrs$METHOD,_keyAttrs$KEYFORMAT;const keyAttrs=new AttrList(keyTagAttributes);substituteVariablesInAttributes(parsed,keyAttrs,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const decryptmethod=null!=(_keyAttrs$METHOD=keyAttrs.METHOD)?_keyAttrs$METHOD:"",decrypturi=keyAttrs.URI,decryptiv=keyAttrs.hexadecimalInteger("IV"),decryptkeyformatversions=keyAttrs.KEYFORMATVERSIONS,decryptkeyformat=null!=(_keyAttrs$KEYFORMAT=keyAttrs.KEYFORMAT)?_keyAttrs$KEYFORMAT:"identity";decrypturi&&keyAttrs.IV&&!decryptiv&&logger.error(`Invalid IV: ${keyAttrs.IV}`);const resolvedUri=decrypturi?M3U8Parser.resolve(decrypturi,baseurl):"",keyFormatVersions=(decryptkeyformatversions||"1").split("/").map(Number).filter(Number.isFinite);return new LevelKey(decryptmethod,resolvedUri,decryptkeyformat,keyFormatVersions,decryptiv)}function parseStartTimeOffset(startAttributes){const startTimeOffset=new AttrList(startAttributes).decimalFloatingPoint("TIME-OFFSET");return isFiniteNumber(startTimeOffset)?startTimeOffset:null}function setCodecs(codecsAttributeValue,level){let codecs=(codecsAttributeValue||"").split(/[ ,]+/).filter((c=>c));["video","audio","text"].forEach((type=>{const filtered=codecs.filter((codec=>function isCodecType(codec,type){const typeCodes=sampleEntryCodesISO[type];return!!typeCodes&&!!typeCodes[codec.slice(0,4)]}(codec,type)));filtered.length&&(level[`${type}Codec`]=filtered.join(","),codecs=codecs.filter((codec=>-1===filtered.indexOf(codec))))})),level.unknownCodecs=codecs}function assignCodec(media,groupItem,codecProperty){const codecValue=groupItem[codecProperty];codecValue&&(media[codecProperty]=codecValue)}function assignProgramDateTime(frag,prevFrag){frag.rawProgramDateTime?frag.programDateTime=Date.parse(frag.rawProgramDateTime):null!=prevFrag&&prevFrag.programDateTime&&(frag.programDateTime=prevFrag.endProgramDateTime),isFiniteNumber(frag.programDateTime)||(frag.programDateTime=null,frag.rawProgramDateTime=null)}function setInitSegment(frag,mapAttrs,id,levelkeys){frag.relurl=mapAttrs.URI,mapAttrs.BYTERANGE&&frag.setByteRange(mapAttrs.BYTERANGE),frag.level=id,frag.sn="initSegment",levelkeys&&(frag.levelkeys=levelkeys),frag.initSegment=null}function setFragLevelKeys(frag,levelkeys,level){frag.levelkeys=levelkeys;const{encryptedFragments}=level;encryptedFragments.length&&encryptedFragments[encryptedFragments.length-1].levelkeys===levelkeys||!Object.keys(levelkeys).some((format=>levelkeys[format].isCommonEncryption))||encryptedFragments.push(frag)}var PlaylistContextType_MANIFEST="manifest",PlaylistContextType_LEVEL="level",PlaylistContextType_AUDIO_TRACK="audioTrack",PlaylistContextType_SUBTITLE_TRACK="subtitleTrack",PlaylistLevelType_MAIN="main",PlaylistLevelType_AUDIO="audio",PlaylistLevelType_SUBTITLE="subtitle";function mapContextToLevelType(context){const{type}=context;switch(type){case PlaylistContextType_AUDIO_TRACK:return PlaylistLevelType_AUDIO;case PlaylistContextType_SUBTITLE_TRACK:return PlaylistLevelType_SUBTITLE;default:return PlaylistLevelType_MAIN}}function getResponseUrl(response,context){let url=response.url;return void 0!==url&&0!==url.indexOf("data:")||(url=context.url),url}class PlaylistLoader{constructor(hls){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=hls,this.registerListeners()}startLoad(startPosition){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls}=this;hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.LEVEL_LOADING,this.onLevelLoading,this),hls.on(Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),hls.on(Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls}=this;hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.LEVEL_LOADING,this.onLevelLoading,this),hls.off(Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),hls.off(Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(context){const config=this.hls.config,PLoader=config.pLoader,Loader=config.loader,loader=new(PLoader||Loader)(config);return this.loaders[context.type]=loader,loader}getInternalLoader(context){return this.loaders[context.type]}resetInternalLoader(contextType){this.loaders[contextType]&&delete this.loaders[contextType]}destroyInternalLoaders(){for(const contextType in this.loaders){const loader=this.loaders[contextType];loader&&loader.destroy(),this.resetInternalLoader(contextType)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(event,data){const{url}=data;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:PlaylistContextType_MANIFEST,url,deliveryDirectives:null})}onLevelLoading(event,data){const{id,level,pathwayId,url,deliveryDirectives}=data;this.load({id,level,pathwayId,responseType:"text",type:PlaylistContextType_LEVEL,url,deliveryDirectives})}onAudioTrackLoading(event,data){const{id,groupId,url,deliveryDirectives}=data;this.load({id,groupId,level:null,responseType:"text",type:PlaylistContextType_AUDIO_TRACK,url,deliveryDirectives})}onSubtitleTrackLoading(event,data){const{id,groupId,url,deliveryDirectives}=data;this.load({id,groupId,level:null,responseType:"text",type:PlaylistContextType_SUBTITLE_TRACK,url,deliveryDirectives})}load(context){var _context$deliveryDire;const config=this.hls.config;let loadPolicy,loader=this.getInternalLoader(context);if(loader){const loaderContext=loader.context;if(loaderContext&&loaderContext.url===context.url&&loaderContext.level===context.level)return void logger.trace("[playlist-loader]: playlist request ongoing");logger.log(`[playlist-loader]: aborting previous loader for type: ${context.type}`),loader.abort()}if(loadPolicy=context.type===PlaylistContextType_MANIFEST?config.manifestLoadPolicy.default:_extends({},config.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),loader=this.createInternalLoader(context),isFiniteNumber(null==(_context$deliveryDire=context.deliveryDirectives)?void 0:_context$deliveryDire.part)){let levelDetails;if(context.type===PlaylistContextType_LEVEL&&null!==context.level?levelDetails=this.hls.levels[context.level].details:context.type===PlaylistContextType_AUDIO_TRACK&&null!==context.id?levelDetails=this.hls.audioTracks[context.id].details:context.type===PlaylistContextType_SUBTITLE_TRACK&&null!==context.id&&(levelDetails=this.hls.subtitleTracks[context.id].details),levelDetails){const partTarget=levelDetails.partTarget,targetDuration=levelDetails.targetduration;if(partTarget&&targetDuration){const maxLowLatencyPlaylistRefresh=1e3*Math.max(3*partTarget,.8*targetDuration);loadPolicy=_extends({},loadPolicy,{maxTimeToFirstByteMs:Math.min(maxLowLatencyPlaylistRefresh,loadPolicy.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(maxLowLatencyPlaylistRefresh,loadPolicy.maxTimeToFirstByteMs)})}}}const legacyRetryCompatibility=loadPolicy.errorRetry||loadPolicy.timeoutRetry||{},loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:legacyRetryCompatibility.maxNumRetry||0,retryDelay:legacyRetryCompatibility.retryDelayMs||0,maxRetryDelay:legacyRetryCompatibility.maxRetryDelayMs||0},loaderCallbacks={onSuccess:(response,stats,context,networkDetails)=>{const loader=this.getInternalLoader(context);this.resetInternalLoader(context.type);const string=response.data;0===string.indexOf("#EXTM3U")?(stats.parsing.start=performance.now(),M3U8Parser.isMediaPlaylist(string)?this.handleTrackOrLevelPlaylist(response,stats,context,networkDetails||null,loader):this.handleMasterPlaylist(response,stats,context,networkDetails)):this.handleManifestParsingError(response,context,new Error("no EXTM3U delimiter"),networkDetails||null,stats)},onError:(response,context,networkDetails,stats)=>{this.handleNetworkError(context,networkDetails,!1,response,stats)},onTimeout:(stats,context,networkDetails)=>{this.handleNetworkError(context,networkDetails,!0,void 0,stats)}};loader.load(context,loaderConfig,loaderCallbacks)}handleMasterPlaylist(response,stats,context,networkDetails){const hls=this.hls,string=response.data,url=getResponseUrl(response,context),parsedResult=M3U8Parser.parseMasterPlaylist(string,url);if(parsedResult.playlistParsingError)return void this.handleManifestParsingError(response,context,parsedResult.playlistParsingError,networkDetails,stats);const{contentSteering,levels,sessionData,sessionKeys,startTimeOffset,variableList}=parsedResult;this.variableList=variableList;const{AUDIO:audioTracks=[],SUBTITLES:subtitles,"CLOSED-CAPTIONS":captions}=M3U8Parser.parseMasterPlaylistMedia(string,url,parsedResult);if(audioTracks.length){audioTracks.some((audioTrack=>!audioTrack.url))||!levels[0].audioCodec||levels[0].attrs.AUDIO||(logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),audioTracks.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new AttrList({}),bitrate:0,url:""}))}hls.trigger(Events.MANIFEST_LOADED,{levels,audioTracks,subtitles,captions,contentSteering,url,stats,networkDetails,sessionData,sessionKeys,startTimeOffset,variableList})}handleTrackOrLevelPlaylist(response,stats,context,networkDetails,loader){const hls=this.hls,{id,level,type}=context,url=getResponseUrl(response,context),levelId=isFiniteNumber(level)?level:isFiniteNumber(id)?id:0,levelType=mapContextToLevelType(context),levelDetails=M3U8Parser.parseLevelPlaylist(response.data,url,levelId,levelType,0,this.variableList);if(type===PlaylistContextType_MANIFEST){const singleLevel={attrs:new AttrList({}),bitrate:0,details:levelDetails,name:"",url};hls.trigger(Events.MANIFEST_LOADED,{levels:[singleLevel],audioTracks:[],url,stats,networkDetails,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}stats.parsing.end=performance.now(),context.levelDetails=levelDetails,this.handlePlaylistLoaded(levelDetails,response,stats,context,networkDetails,loader)}handleManifestParsingError(response,context,error,networkDetails,stats){this.hls.trigger(Events.ERROR,{type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.MANIFEST_PARSING_ERROR,fatal:context.type===PlaylistContextType_MANIFEST,url:response.url,err:error,error,reason:error.message,response,context,networkDetails,stats})}handleNetworkError(context,networkDetails,timeout=!1,response,stats){let message=`A network ${timeout?"timeout":"error"+(response?" (status "+response.code+")":"")} occurred while loading ${context.type}`;context.type===PlaylistContextType_LEVEL?message+=`: ${context.level} id: ${context.id}`:context.type!==PlaylistContextType_AUDIO_TRACK&&context.type!==PlaylistContextType_SUBTITLE_TRACK||(message+=` id: ${context.id} group-id: "${context.groupId}"`);const error=new Error(message);logger.warn(`[playlist-loader]: ${message}`);let details=ErrorDetails.UNKNOWN,fatal=!1;const loader=this.getInternalLoader(context);switch(context.type){case PlaylistContextType_MANIFEST:details=timeout?ErrorDetails.MANIFEST_LOAD_TIMEOUT:ErrorDetails.MANIFEST_LOAD_ERROR,fatal=!0;break;case PlaylistContextType_LEVEL:details=timeout?ErrorDetails.LEVEL_LOAD_TIMEOUT:ErrorDetails.LEVEL_LOAD_ERROR,fatal=!1;break;case PlaylistContextType_AUDIO_TRACK:details=timeout?ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal=!1;break;case PlaylistContextType_SUBTITLE_TRACK:details=timeout?ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:ErrorDetails.SUBTITLE_LOAD_ERROR,fatal=!1}loader&&this.resetInternalLoader(context.type);const errorData={type:ErrorTypes.NETWORK_ERROR,details,fatal,url:context.url,loader,context,error,networkDetails,stats};if(response){const url=(null==networkDetails?void 0:networkDetails.url)||context.url;errorData.response=_objectSpread2({url,data:void 0},response)}this.hls.trigger(Events.ERROR,errorData)}handlePlaylistLoaded(levelDetails,response,stats,context,networkDetails,loader){const hls=this.hls,{type,level,id,groupId,deliveryDirectives}=context,url=getResponseUrl(response,context),parent=mapContextToLevelType(context),levelIndex="number"==typeof context.level&&parent===PlaylistLevelType_MAIN?level:void 0;if(!levelDetails.fragments.length){const _error=new Error("No Segments found in Playlist");return void hls.trigger(Events.ERROR,{type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url,error:_error,reason:_error.message,response,context,level:levelIndex,parent,networkDetails,stats})}levelDetails.targetduration||(levelDetails.playlistParsingError=new Error("Missing Target Duration"));const error=levelDetails.playlistParsingError;if(error)hls.trigger(Events.ERROR,{type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.LEVEL_PARSING_ERROR,fatal:!1,url,error,reason:error.message,response,context,level:levelIndex,parent,networkDetails,stats});else switch(levelDetails.live&&loader&&(loader.getCacheAge&&(levelDetails.ageHeader=loader.getCacheAge()||0),loader.getCacheAge&&!isNaN(levelDetails.ageHeader)||(levelDetails.ageHeader=0)),type){case PlaylistContextType_MANIFEST:case PlaylistContextType_LEVEL:hls.trigger(Events.LEVEL_LOADED,{details:levelDetails,level:levelIndex||0,id:id||0,stats,networkDetails,deliveryDirectives});break;case PlaylistContextType_AUDIO_TRACK:hls.trigger(Events.AUDIO_TRACK_LOADED,{details:levelDetails,id:id||0,groupId:groupId||"",stats,networkDetails,deliveryDirectives});break;case PlaylistContextType_SUBTITLE_TRACK:hls.trigger(Events.SUBTITLE_TRACK_LOADED,{details:levelDetails,id:id||0,groupId:groupId||"",stats,networkDetails,deliveryDirectives})}}}function sendAddTrackEvent(track,videoEl){let event;try{event=new Event("addtrack")}catch(err){event=document.createEvent("Event"),event.initEvent("addtrack",!1,!1)}event.track=track,videoEl.dispatchEvent(event)}function addCueToTrack(track,cue){const mode=track.mode;if("disabled"===mode&&(track.mode="hidden"),track.cues&&!track.cues.getCueById(cue.id))try{if(track.addCue(cue),!track.cues.getCueById(cue.id))throw new Error(`addCue is failed for: ${cue}`)}catch(err){logger.debug(`[texttrack-utils]: ${err}`);try{const textTrackCue=new self.TextTrackCue(cue.startTime,cue.endTime,cue.text);textTrackCue.id=cue.id,track.addCue(textTrackCue)}catch(err2){logger.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${err2}`)}}"disabled"===mode&&(track.mode=mode)}function clearCurrentCues(track){const mode=track.mode;if("disabled"===mode&&(track.mode="hidden"),track.cues)for(let i=track.cues.length;i--;)track.removeCue(track.cues[i]);"disabled"===mode&&(track.mode=mode)}function removeCuesInRange(track,start,end,predicate){const mode=track.mode;if("disabled"===mode&&(track.mode="hidden"),track.cues&&track.cues.length>0){const cues=function getCuesInRange(cues,start,end){const cuesFound=[],firstCueInRange=function getFirstCueIndexAfterTime(cues,time){if(time<cues[0].startTime)return 0;const len=cues.length-1;if(time>cues[len].endTime)return-1;let left=0,right=len;for(;left<=right;){const mid=Math.floor((right+left)/2);if(time<cues[mid].startTime)right=mid-1;else{if(!(time>cues[mid].startTime&&left<len))return mid;left=mid+1}}return cues[left].startTime-time<time-cues[right].startTime?left:right}(cues,start);if(firstCueInRange>-1)for(let i=firstCueInRange,len=cues.length;i<len;i++){const cue=cues[i];if(cue.startTime>=start&&cue.endTime<=end)cuesFound.push(cue);else if(cue.startTime>end)return cuesFound}return cuesFound}(track.cues,start,end);for(let i=0;i<cues.length;i++)predicate&&!predicate(cues[i])||track.removeCue(cues[i])}"disabled"===mode&&(track.mode=mode)}function filterSubtitleTracks(textTrackList){const tracks=[];for(let i=0;i<textTrackList.length;i++){const track=textTrackList[i];"subtitles"!==track.kind&&"captions"!==track.kind||!track.label||tracks.push(textTrackList[i])}return tracks}var MetadataSchema_audioId3="org.id3",MetadataSchema_dateRange="com.apple.quicktime.HLS",MetadataSchema_emsg="https://aomedia.org/emsg/ID3";function getCueClass(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function createCueWithDataFields(Cue,startTime,endTime,data,type){let cue=new Cue(startTime,endTime,"");try{cue.value=data,type&&(cue.type=type)}catch(e){cue=new Cue(startTime,endTime,JSON.stringify(type?_objectSpread2({type},data):data))}return cue}const MAX_CUE_ENDTIME=(()=>{const Cue=getCueClass();try{Cue&&new Cue(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function dateRangeDateToTimelineSeconds(date,offset){return date.getTime()/1e3-offset}class ID3TrackController{constructor(hls){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=hls,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls}=this;hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),hls.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls}=this;hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),hls.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(event,data){this.media=data.media}onMediaDetaching(){this.id3Track&&(clearCurrentCues(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(media){const track=this.getID3Track(media.textTracks);return track.mode="hidden",track}getID3Track(textTracks){if(this.media){for(let i=0;i<textTracks.length;i++){const textTrack=textTracks[i];if("metadata"===textTrack.kind&&"id3"===textTrack.label)return sendAddTrackEvent(textTrack,this.media),textTrack}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(event,data){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues,enableID3MetadataCues}}}=this;if(!enableEmsgMetadataCues&&!enableID3MetadataCues)return;const{samples}=data;this.id3Track||(this.id3Track=this.createTrack(this.media));const Cue=getCueClass();if(Cue)for(let i=0;i<samples.length;i++){const type=samples[i].type;if(type===MetadataSchema_emsg&&!enableEmsgMetadataCues||!enableID3MetadataCues)continue;const frames=getID3Frames(samples[i].data);if(frames){const startTime=samples[i].pts;let endTime=startTime+samples[i].duration;endTime>MAX_CUE_ENDTIME&&(endTime=MAX_CUE_ENDTIME);endTime-startTime<=0&&(endTime=startTime+.25);for(let j=0;j<frames.length;j++){const frame=frames[j];if(!isTimeStampFrame(frame)){this.updateId3CueEnds(startTime,type);const cue=createCueWithDataFields(Cue,startTime,endTime,frame,type);cue&&this.id3Track.addCue(cue)}}}}}updateId3CueEnds(startTime,type){var _this$id3Track;const cues=null==(_this$id3Track=this.id3Track)?void 0:_this$id3Track.cues;if(cues)for(let i=cues.length;i--;){const cue=cues[i];cue.type===type&&cue.startTime<startTime&&cue.endTime===MAX_CUE_ENDTIME&&(cue.endTime=startTime)}}onBufferFlushing(event,{startOffset,endOffset,type}){const{id3Track,hls}=this;if(!hls)return;const{config:{enableEmsgMetadataCues,enableID3MetadataCues}}=hls;if(id3Track&&(enableEmsgMetadataCues||enableID3MetadataCues)){let predicate;predicate="audio"===type?cue=>cue.type===MetadataSchema_audioId3&&enableID3MetadataCues:"video"===type?cue=>cue.type===MetadataSchema_emsg&&enableEmsgMetadataCues:cue=>cue.type===MetadataSchema_audioId3&&enableID3MetadataCues||cue.type===MetadataSchema_emsg&&enableEmsgMetadataCues,removeCuesInRange(id3Track,startOffset,endOffset,predicate)}}onLevelUpdated(event,{details}){if(!this.media||!details.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended,id3Track}=this,{dateRanges}=details,ids=Object.keys(dateRanges);if(id3Track){const idsToRemove=Object.keys(dateRangeCuesAppended).filter((id=>!ids.includes(id)));for(let i=idsToRemove.length;i--;){const id=idsToRemove[i];Object.keys(dateRangeCuesAppended[id].cues).forEach((key=>{id3Track.removeCue(dateRangeCuesAppended[id].cues[key])})),delete dateRangeCuesAppended[id]}}const lastFragment=details.fragments[details.fragments.length-1];if(0===ids.length||!isFiniteNumber(null==lastFragment?void 0:lastFragment.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const dateTimeOffset=lastFragment.programDateTime/1e3-lastFragment.start,Cue=getCueClass();for(let i=0;i<ids.length;i++){const id=ids[i],dateRange=dateRanges[id],startTime=dateRangeDateToTimelineSeconds(dateRange.startDate,dateTimeOffset),appendedDateRangeCues=dateRangeCuesAppended[id],cues=(null==appendedDateRangeCues?void 0:appendedDateRangeCues.cues)||{};let durationKnown=(null==appendedDateRangeCues?void 0:appendedDateRangeCues.durationKnown)||!1,endTime=MAX_CUE_ENDTIME;const endDate=dateRange.endDate;if(endDate)endTime=dateRangeDateToTimelineSeconds(endDate,dateTimeOffset),durationKnown=!0;else if(dateRange.endOnNext&&!durationKnown){const nextDateRangeWithSameClass=ids.reduce(((candidateDateRange,id)=>{if(id!==dateRange.id){const otherDateRange=dateRanges[id];if(otherDateRange.class===dateRange.class&&otherDateRange.startDate>dateRange.startDate&&(!candidateDateRange||dateRange.startDate<candidateDateRange.startDate))return otherDateRange}return candidateDateRange}),null);nextDateRangeWithSameClass&&(endTime=dateRangeDateToTimelineSeconds(nextDateRangeWithSameClass.startDate,dateTimeOffset),durationKnown=!0)}const attributes=Object.keys(dateRange.attr);for(let j=0;j<attributes.length;j++){const key=attributes[j];if("ID"===(attrName=key)||"CLASS"===attrName||"START-DATE"===attrName||"DURATION"===attrName||"END-DATE"===attrName||"END-ON-NEXT"===attrName)continue;const cue=cues[key];if(cue)durationKnown&&!appendedDateRangeCues.durationKnown&&(cue.endTime=endTime);else if(Cue){let data=dateRange.attr[key];isSCTE35Attribute(key)&&(str=data,data=Uint8Array.from(str.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);const _cue=createCueWithDataFields(Cue,startTime,endTime,{key,data},MetadataSchema_dateRange);_cue&&(_cue.id=id,this.id3Track.addCue(_cue),cues[key]=_cue)}}dateRangeCuesAppended[id]={cues,dateRange,durationKnown}}var str,attrName}}class LatencyController{constructor(hls){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=hls,this.config=hls.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config,levelDetails}=this;return void 0!==config.liveMaxLatencyDuration?config.liveMaxLatencyDuration:levelDetails?config.liveMaxLatencyDurationCount*levelDetails.targetduration:0}get targetLatency(){const{levelDetails}=this;if(null===levelDetails)return null;const{holdBack,partHoldBack,targetduration}=levelDetails,{liveSyncDuration,liveSyncDurationCount,lowLatencyMode}=this.config,userConfig=this.hls.userConfig;let targetLatency=lowLatencyMode&&partHoldBack||holdBack;(userConfig.liveSyncDuration||userConfig.liveSyncDurationCount||0===targetLatency)&&(targetLatency=void 0!==liveSyncDuration?liveSyncDuration:liveSyncDurationCount*targetduration);const maxLiveSyncOnStallIncrease=targetduration;return targetLatency+Math.min(1*this.stallCount,maxLiveSyncOnStallIncrease)}get liveSyncPosition(){const liveEdge=this.estimateLiveEdge(),targetLatency=this.targetLatency,levelDetails=this.levelDetails;if(null===liveEdge||null===targetLatency||null===levelDetails)return null;const edge=levelDetails.edge,syncPosition=liveEdge-targetLatency-this.edgeStalled,min=edge-levelDetails.totalduration,max=edge-(this.config.lowLatencyMode&&levelDetails.partTarget||levelDetails.targetduration);return Math.min(Math.max(min,syncPosition),max)}get drift(){const{levelDetails}=this;return null===levelDetails?1:levelDetails.drift}get edgeStalled(){const{levelDetails}=this;if(null===levelDetails)return 0;const maxLevelUpdateAge=3*(this.config.lowLatencyMode&&levelDetails.partTarget||levelDetails.targetduration);return Math.max(levelDetails.age-maxLevelUpdateAge,0)}get forwardBufferLength(){const{media,levelDetails}=this;if(!media||!levelDetails)return 0;const bufferedRanges=media.buffered.length;return(bufferedRanges?media.buffered.end(bufferedRanges-1):levelDetails.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(Events.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(Events.ERROR,this.onError,this)}onMediaAttached(event,data){this.media=data.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(event,{details}){this.levelDetails=details,details.advanced&&this.timeupdate(),!details.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(event,data){var _this$levelDetails;data.details===ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(_this$levelDetails=this.levelDetails)&&_this$levelDetails.live&&logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media,levelDetails}=this;if(!media||!levelDetails)return;this.currentTime=media.currentTime;const latency=this.computeLatency();if(null===latency)return;this._latency=latency;const{lowLatencyMode,maxLiveSyncPlaybackRate}=this.config;if(!lowLatencyMode||1===maxLiveSyncPlaybackRate||!levelDetails.live)return;const targetLatency=this.targetLatency;if(null===targetLatency)return;const distanceFromTarget=latency-targetLatency;if(distanceFromTarget<Math.min(this.maxLatency,targetLatency+levelDetails.targetduration)&&distanceFromTarget>.05&&this.forwardBufferLength>1){const max=Math.min(2,Math.max(1,maxLiveSyncPlaybackRate)),rate=Math.round(2/(1+Math.exp(-.75*distanceFromTarget-this.edgeStalled))*20)/20;media.playbackRate=Math.min(max,Math.max(1,rate))}else 1!==media.playbackRate&&0!==media.playbackRate&&(media.playbackRate=1)}estimateLiveEdge(){const{levelDetails}=this;return null===levelDetails?null:levelDetails.edge+levelDetails.age}computeLatency(){const liveEdge=this.estimateLiveEdge();return null===liveEdge?null:liveEdge-this.currentTime}}const HdcpLevels=["NONE","TYPE-0","TYPE-1",null];const VideoRangeValues=["SDR","PQ","HLG"];var HlsSkip_No="",HlsSkip_Yes="YES",HlsSkip_v2="v2";class HlsUrlParameters{constructor(msn,part,skip){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=msn,this.part=part,this.skip=skip}addDirectives(uri){const url=new self.URL(uri);return void 0!==this.msn&&url.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&url.searchParams.set("_HLS_part",this.part.toString()),this.skip&&url.searchParams.set("_HLS_skip",this.skip),url.href}}class Level{constructor(data){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[data.url],this._attrs=[data.attrs],this.bitrate=data.bitrate,data.details&&(this.details=data.details),this.id=data.id||0,this.name=data.name,this.width=data.width||0,this.height=data.height||0,this.frameRate=data.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=data.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=data.audioCodec,this.videoCodec=data.videoCodec,this.codecSet=[data.videoCodec,data.audioCodec].filter((c=>!!c)).map((s=>s.substring(0,4))).join(","),this.addGroupId("audio",data.attrs.AUDIO),this.addGroupId("text",data.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(groupId){return hasGroup(this._audioGroups,groupId)}hasSubtitleGroup(groupId){return hasGroup(this._subtitleGroups,groupId)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(type,groupId){if(groupId)if("audio"===type){let audioGroups=this._audioGroups;audioGroups||(audioGroups=this._audioGroups=[]),-1===audioGroups.indexOf(groupId)&&audioGroups.push(groupId)}else if("text"===type){let subtitleGroups=this._subtitleGroups;subtitleGroups||(subtitleGroups=this._subtitleGroups=[]),-1===subtitleGroups.indexOf(groupId)&&subtitleGroups.push(groupId)}}get urlId(){return 0}set urlId(value){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var _this$audioGroups;return null==(_this$audioGroups=this.audioGroups)?void 0:_this$audioGroups[0]}get textGroupId(){var _this$subtitleGroups;return null==(_this$subtitleGroups=this.subtitleGroups)?void 0:_this$subtitleGroups[0]}addFallback(){}}function hasGroup(groups,groupId){return!(!groupId||!groups)&&-1!==groups.indexOf(groupId)}function updateFromToPTS(fragFrom,fragTo){const fragToPTS=fragTo.startPTS;if(isFiniteNumber(fragToPTS)){let frag,duration=0;fragTo.sn>fragFrom.sn?(duration=fragToPTS-fragFrom.start,frag=fragFrom):(duration=fragFrom.start-fragToPTS,frag=fragTo),frag.duration!==duration&&(frag.duration=duration)}else if(fragTo.sn>fragFrom.sn){fragFrom.cc===fragTo.cc&&fragFrom.minEndPTS?fragTo.start=fragFrom.start+(fragFrom.minEndPTS-fragFrom.start):fragTo.start=fragFrom.start+fragFrom.duration}else fragTo.start=Math.max(fragFrom.start-fragTo.duration,0)}function updateFragPTSDTS(details,frag,startPTS,endPTS,startDTS,endDTS){endPTS-startPTS<=0&&(logger.warn("Fragment should have a positive duration",frag),endPTS=startPTS+frag.duration,endDTS=startDTS+frag.duration);let maxStartPTS=startPTS,minEndPTS=endPTS;const fragStartPts=frag.startPTS,fragEndPts=frag.endPTS;if(isFiniteNumber(fragStartPts)){const deltaPTS=Math.abs(fragStartPts-startPTS);isFiniteNumber(frag.deltaPTS)?frag.deltaPTS=Math.max(deltaPTS,frag.deltaPTS):frag.deltaPTS=deltaPTS,maxStartPTS=Math.max(startPTS,fragStartPts),startPTS=Math.min(startPTS,fragStartPts),startDTS=Math.min(startDTS,frag.startDTS),minEndPTS=Math.min(endPTS,fragEndPts),endPTS=Math.max(endPTS,fragEndPts),endDTS=Math.max(endDTS,frag.endDTS)}const drift=startPTS-frag.start;0!==frag.start&&(frag.start=startPTS),frag.duration=endPTS-frag.start,frag.startPTS=startPTS,frag.maxStartPTS=maxStartPTS,frag.startDTS=startDTS,frag.endPTS=endPTS,frag.minEndPTS=minEndPTS,frag.endDTS=endDTS;const sn=frag.sn;if(!details||sn<details.startSN||sn>details.endSN)return 0;let i;const fragIdx=sn-details.startSN,fragments=details.fragments;for(fragments[fragIdx]=frag,i=fragIdx;i>0;i--)updateFromToPTS(fragments[i],fragments[i-1]);for(i=fragIdx;i<fragments.length-1;i++)updateFromToPTS(fragments[i],fragments[i+1]);return details.fragmentHint&&updateFromToPTS(fragments[fragments.length-1],details.fragmentHint),details.PTSKnown=details.alignedSliding=!0,drift}function mergeDetails(oldDetails,newDetails){let currentInitSegment=null;const oldFragments=oldDetails.fragments;for(let i=oldFragments.length-1;i>=0;i--){const oldInit=oldFragments[i].initSegment;if(oldInit){currentInitSegment=oldInit;break}}oldDetails.fragmentHint&&delete oldDetails.fragmentHint.endPTS;let PTSFrag,ccOffset=0;if(function mapFragmentIntersection(oldDetails,newDetails,intersectionFn){const skippedSegments=newDetails.skippedSegments,start=Math.max(oldDetails.startSN,newDetails.startSN)-newDetails.startSN,end=(oldDetails.fragmentHint?1:0)+(skippedSegments?newDetails.endSN:Math.min(oldDetails.endSN,newDetails.endSN))-newDetails.startSN,delta=newDetails.startSN-oldDetails.startSN,newFrags=newDetails.fragmentHint?newDetails.fragments.concat(newDetails.fragmentHint):newDetails.fragments,oldFrags=oldDetails.fragmentHint?oldDetails.fragments.concat(oldDetails.fragmentHint):oldDetails.fragments;for(let i=start;i<=end;i++){const oldFrag=oldFrags[delta+i];let newFrag=newFrags[i];skippedSegments&&!newFrag&&i<skippedSegments&&(newFrag=newDetails.fragments[i]=oldFrag),oldFrag&&newFrag&&intersectionFn(oldFrag,newFrag)}}(oldDetails,newDetails,((oldFrag,newFrag)=>{oldFrag.relurl&&(ccOffset=oldFrag.cc-newFrag.cc),isFiniteNumber(oldFrag.startPTS)&&isFiniteNumber(oldFrag.endPTS)&&(newFrag.start=newFrag.startPTS=oldFrag.startPTS,newFrag.startDTS=oldFrag.startDTS,newFrag.maxStartPTS=oldFrag.maxStartPTS,newFrag.endPTS=oldFrag.endPTS,newFrag.endDTS=oldFrag.endDTS,newFrag.minEndPTS=oldFrag.minEndPTS,newFrag.duration=oldFrag.endPTS-oldFrag.startPTS,newFrag.duration&&(PTSFrag=newFrag),newDetails.PTSKnown=newDetails.alignedSliding=!0),newFrag.elementaryStreams=oldFrag.elementaryStreams,newFrag.loader=oldFrag.loader,newFrag.stats=oldFrag.stats,oldFrag.initSegment&&(newFrag.initSegment=oldFrag.initSegment,currentInitSegment=oldFrag.initSegment)})),currentInitSegment){(newDetails.fragmentHint?newDetails.fragments.concat(newDetails.fragmentHint):newDetails.fragments).forEach((frag=>{var _currentInitSegment;!frag||frag.initSegment&&frag.initSegment.relurl!==(null==(_currentInitSegment=currentInitSegment)?void 0:_currentInitSegment.relurl)||(frag.initSegment=currentInitSegment)}))}if(newDetails.skippedSegments)if(newDetails.deltaUpdateFailed=newDetails.fragments.some((frag=>!frag)),newDetails.deltaUpdateFailed){logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let i=newDetails.skippedSegments;i--;)newDetails.fragments.shift();newDetails.startSN=newDetails.fragments[0].sn,newDetails.startCC=newDetails.fragments[0].cc}else newDetails.canSkipDateRanges&&(newDetails.dateRanges=function mergeDateRanges(oldDateRanges,deltaDateRanges,recentlyRemovedDateranges){const dateRanges=_extends({},oldDateRanges);recentlyRemovedDateranges&&recentlyRemovedDateranges.forEach((id=>{delete dateRanges[id]}));return Object.keys(deltaDateRanges).forEach((id=>{const dateRange=new DateRange(deltaDateRanges[id].attr,dateRanges[id]);dateRange.isValid?dateRanges[id]=dateRange:logger.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(deltaDateRanges[id].attr)}"`)})),dateRanges}(oldDetails.dateRanges,newDetails.dateRanges,newDetails.recentlyRemovedDateranges));const newFragments=newDetails.fragments;if(ccOffset){logger.warn("discontinuity sliding from playlist, take drift into account");for(let i=0;i<newFragments.length;i++)newFragments[i].cc+=ccOffset}newDetails.skippedSegments&&(newDetails.startCC=newDetails.fragments[0].cc),function mapPartIntersection(oldParts,newParts,intersectionFn){if(oldParts&&newParts){let delta=0;for(let i=0,len=oldParts.length;i<=len;i++){const oldPart=oldParts[i],newPart=newParts[i+delta];oldPart&&newPart&&oldPart.index===newPart.index&&oldPart.fragment.sn===newPart.fragment.sn?intersectionFn(oldPart,newPart):delta--}}}(oldDetails.partList,newDetails.partList,((oldPart,newPart)=>{newPart.elementaryStreams=oldPart.elementaryStreams,newPart.stats=oldPart.stats})),PTSFrag?updateFragPTSDTS(newDetails,PTSFrag,PTSFrag.startPTS,PTSFrag.endPTS,PTSFrag.startDTS,PTSFrag.endDTS):adjustSliding(oldDetails,newDetails),newFragments.length&&(newDetails.totalduration=newDetails.edge-newFragments[0].start),newDetails.driftStartTime=oldDetails.driftStartTime,newDetails.driftStart=oldDetails.driftStart;const advancedDateTime=newDetails.advancedDateTime;if(newDetails.advanced&&advancedDateTime){const edge=newDetails.edge;newDetails.driftStart||(newDetails.driftStartTime=advancedDateTime,newDetails.driftStart=edge),newDetails.driftEndTime=advancedDateTime,newDetails.driftEnd=edge}else newDetails.driftEndTime=oldDetails.driftEndTime,newDetails.driftEnd=oldDetails.driftEnd,newDetails.advancedDateTime=oldDetails.advancedDateTime}function adjustSliding(oldDetails,newDetails){const delta=newDetails.startSN+newDetails.skippedSegments-oldDetails.startSN,oldFragments=oldDetails.fragments;delta<0||delta>=oldFragments.length||addSliding(newDetails,oldFragments[delta].start)}function addSliding(details,start){if(start){const fragments=details.fragments;for(let i=details.skippedSegments;i<fragments.length;i++)fragments[i].start+=start;details.fragmentHint&&(details.fragmentHint.start+=start)}}function getPartWith(level,sn,partIndex){var _level$details;return null!=level&&level.details?findPart(null==(_level$details=level.details)?void 0:_level$details.partList,sn,partIndex):null}function findPart(partList,sn,partIndex){if(partList)for(let i=partList.length;i--;){const part=partList[i];if(part.index===partIndex&&part.fragment.sn===sn)return part}return null}function reassignFragmentLevelIndexes(levels){levels.forEach(((level,index)=>{const{details}=level;null!=details&&details.fragments&&details.fragments.forEach((fragment=>{fragment.level=index}))}))}function isTimeoutError(error){switch(error.details){case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_TIMEOUT:case ErrorDetails.LEVEL_LOAD_TIMEOUT:case ErrorDetails.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function getRetryConfig(loadPolicy,error){const isTimeout=isTimeoutError(error);return loadPolicy.default[(isTimeout?"timeout":"error")+"Retry"]}function getRetryDelay(retryConfig,retryCount){const backoffFactor="linear"===retryConfig.backoff?1:Math.pow(2,retryCount);return Math.min(backoffFactor*retryConfig.retryDelayMs,retryConfig.maxRetryDelayMs)}function getLoaderConfigWithoutReties(loderConfig){return _objectSpread2(_objectSpread2({},loderConfig),{errorRetry:null,timeoutRetry:null})}function shouldRetry(retryConfig,retryCount,isTimeout,loaderResponse){if(!retryConfig)return!1;const httpStatus=null==loaderResponse?void 0:loaderResponse.code,retry=retryCount<retryConfig.maxNumRetry&&(function retryForHttpStatus(httpStatus){return 0===httpStatus&&!1===navigator.onLine||!!httpStatus&&(httpStatus<400||httpStatus>499)}(httpStatus)||!!isTimeout);return retryConfig.shouldRetry?retryConfig.shouldRetry(retryConfig,retryCount,isTimeout,loaderResponse,retry):retry}const BinarySearch_search=function(list,comparisonFn){let minIndex=0,maxIndex=list.length-1,currentIndex=null,currentElement=null;for(;minIndex<=maxIndex;){currentIndex=(minIndex+maxIndex)/2|0,currentElement=list[currentIndex];const comparisonResult=comparisonFn(currentElement);if(comparisonResult>0)minIndex=currentIndex+1;else{if(!(comparisonResult<0))return currentElement;maxIndex=currentIndex-1}}return null};function findFragmentByPTS(fragPrevious,fragments,bufferEnd=0,maxFragLookUpTolerance=0){let fragNext=null;if(fragPrevious){fragNext=fragments[fragPrevious.sn-fragments[0].sn+1]||null;const bufferEdgeError=fragPrevious.endDTS-bufferEnd;bufferEdgeError>0&&bufferEdgeError<15e-7&&(bufferEnd+=15e-7)}else 0===bufferEnd&&0===fragments[0].start&&(fragNext=fragments[0]);if(fragNext&&(!fragPrevious||fragPrevious.level===fragNext.level)&&0===fragmentWithinToleranceTest(bufferEnd,maxFragLookUpTolerance,fragNext))return fragNext;const foundFragment=BinarySearch_search(fragments,fragmentWithinToleranceTest.bind(null,bufferEnd,maxFragLookUpTolerance));return!foundFragment||foundFragment===fragPrevious&&fragNext?fragNext:foundFragment}function fragmentWithinToleranceTest(bufferEnd=0,maxFragLookUpTolerance=0,candidate){if(candidate.start<=bufferEnd&&candidate.start+candidate.duration>bufferEnd)return 0;const candidateLookupTolerance=Math.min(maxFragLookUpTolerance,candidate.duration+(candidate.deltaPTS?candidate.deltaPTS:0));return candidate.start+candidate.duration-candidateLookupTolerance<=bufferEnd?1:candidate.start-candidateLookupTolerance>bufferEnd&&candidate.start?-1:0}function pdtWithinToleranceTest(pdtBufferEnd,maxFragLookUpTolerance,candidate){const candidateLookupTolerance=1e3*Math.min(maxFragLookUpTolerance,candidate.duration+(candidate.deltaPTS?candidate.deltaPTS:0));return(candidate.endProgramDateTime||0)-candidateLookupTolerance>pdtBufferEnd}var NetworkErrorAction_DoNothing=0,NetworkErrorAction_SendAlternateToPenaltyBox=2,NetworkErrorAction_RemoveAlternatePermanently=3,NetworkErrorAction_RetryRequest=5,ErrorActionFlags_None=0,ErrorActionFlags_MoveAllAlternatesMatchingHost=1,ErrorActionFlags_MoveAllAlternatesMatchingHDCP=2;class BasePlaylistController{constructor(hls,logPrefix){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=logger.log.bind(logger,`${logPrefix}:`),this.warn=logger.warn.bind(logger,`${logPrefix}:`),this.hls=hls}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(playlistUri,previous){const renditionReports=null==previous?void 0:previous.renditionReports;if(renditionReports){let foundIndex=-1;for(let i=0;i<renditionReports.length;i++){const attr=renditionReports[i];let uri;try{uri=new self.URL(attr.URI,previous.url).href}catch(error){logger.warn(`Could not construct new URL for Rendition Report: ${error}`),uri=attr.URI||""}if(uri===playlistUri){foundIndex=i;break}uri===playlistUri.substring(0,uri.length)&&(foundIndex=i)}if(-1!==foundIndex){const attr=renditionReports[foundIndex],msn=parseInt(attr["LAST-MSN"])||(null==previous?void 0:previous.lastPartSn);let part=parseInt(attr["LAST-PART"])||(null==previous?void 0:previous.lastPartIndex);if(this.hls.config.lowLatencyMode){const currentGoal=Math.min(previous.age-previous.partTarget,previous.targetduration);part>=0&&currentGoal>previous.partTarget&&(part+=1)}return new HlsUrlParameters(msn,part>=0?part:void 0,HlsSkip_No)}}}loadPlaylist(hlsUrlParameters){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(playlist){return this.canLoad&&!!playlist&&!!playlist.url&&(!playlist.details||playlist.details.live)}shouldReloadPlaylist(playlist){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(playlist)}playlistLoaded(index,data,previousDetails){const{details,stats}=data,now=self.performance.now(),elapsed=stats.loading.first?Math.max(0,now-stats.loading.first):0;if(details.advancedDateTime=Date.now()-elapsed,details.live||null!=previousDetails&&previousDetails.live){if(details.reloaded(previousDetails),previousDetails&&this.log(`live playlist ${index} ${details.advanced?"REFRESHED "+details.lastPartSn+"-"+details.lastPartIndex:details.updated?"UPDATED":"MISSED"}`),previousDetails&&details.fragments.length>0&&mergeDetails(previousDetails,details),!this.canLoad||!details.live)return;let deliveryDirectives,msn,part;if(details.canBlockReload&&details.endSN&&details.advanced){const lowLatencyMode=this.hls.config.lowLatencyMode,lastPartSn=details.lastPartSn,endSn=details.endSN,lastPartIndex=details.lastPartIndex,lastPart=lastPartSn===endSn;-1!==lastPartIndex?(msn=lastPart?endSn+1:lastPartSn,part=lastPart?lowLatencyMode?0:lastPartIndex:lastPartIndex+1):msn=endSn+1;const lastAdvanced=details.age,cdnAge=lastAdvanced+details.ageHeader;let currentGoal=Math.min(cdnAge-details.partTarget,1.5*details.targetduration);if(currentGoal>0){if(previousDetails&&currentGoal>previousDetails.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${previousDetails.tuneInGoal} to: ${currentGoal} with playlist age: ${details.age}`),currentGoal=0;else{const segments=Math.floor(currentGoal/details.targetduration);if(msn+=segments,void 0!==part){part+=Math.round(currentGoal%details.targetduration/details.partTarget)}this.log(`CDN Tune-in age: ${details.ageHeader}s last advanced ${lastAdvanced.toFixed(2)}s goal: ${currentGoal} skip sn ${segments} to part ${part}`)}details.tuneInGoal=currentGoal}if(deliveryDirectives=this.getDeliveryDirectives(details,data.deliveryDirectives,msn,part),lowLatencyMode||!lastPart)return void this.loadPlaylist(deliveryDirectives)}else(details.canBlockReload||details.canSkipUntil)&&(deliveryDirectives=this.getDeliveryDirectives(details,data.deliveryDirectives,msn,part));const bufferInfo=this.hls.mainForwardBufferInfo,position=bufferInfo?bufferInfo.end-bufferInfo.len:0,reloadInterval=function computeReloadInterval(newDetails,distanceToLiveEdgeMs=1/0){let reloadInterval=1e3*newDetails.targetduration;if(newDetails.updated){const fragments=newDetails.fragments,liveEdgeMaxTargetDurations=4;if(fragments.length&&reloadInterval*liveEdgeMaxTargetDurations>distanceToLiveEdgeMs){const lastSegmentDuration=1e3*fragments[fragments.length-1].duration;lastSegmentDuration<reloadInterval&&(reloadInterval=lastSegmentDuration)}}else reloadInterval/=2;return Math.round(reloadInterval)}(details,1e3*(details.edge-position));details.updated&&now>this.requestScheduled+reloadInterval&&(this.requestScheduled=stats.loading.start),void 0!==msn&&details.canBlockReload?this.requestScheduled=stats.loading.first+reloadInterval-(1e3*details.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+reloadInterval<now?this.requestScheduled=now:this.requestScheduled-now<=0&&(this.requestScheduled+=reloadInterval);let estimatedTimeUntilUpdate=this.requestScheduled-now;estimatedTimeUntilUpdate=Math.max(0,estimatedTimeUntilUpdate),this.log(`reload live playlist ${index} in ${Math.round(estimatedTimeUntilUpdate)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(deliveryDirectives)),estimatedTimeUntilUpdate)}else this.clearTimer()}getDeliveryDirectives(details,previousDeliveryDirectives,msn,part){let skip=function getSkipValue(details,msn){const{canSkipUntil,canSkipDateRanges,endSN}=details;return canSkipUntil&&(void 0!==msn?msn-endSN:0)<canSkipUntil?canSkipDateRanges?HlsSkip_v2:HlsSkip_Yes:HlsSkip_No}(details,msn);return null!=previousDeliveryDirectives&&previousDeliveryDirectives.skip&&details.deltaUpdateFailed&&(msn=previousDeliveryDirectives.msn,part=previousDeliveryDirectives.part,skip=HlsSkip_No),new HlsUrlParameters(msn,part,skip)}checkRetry(errorEvent){const errorDetails=errorEvent.details,isTimeout=isTimeoutError(errorEvent),errorAction=errorEvent.errorAction,{action,retryCount=0,retryConfig}=errorAction||{},retry=!!errorAction&&!!retryConfig&&(action===NetworkErrorAction_RetryRequest||!errorAction.resolved&&action===NetworkErrorAction_SendAlternateToPenaltyBox);if(retry){var _errorEvent$context;if(this.requestScheduled=-1,retryCount>=retryConfig.maxNumRetry)return!1;if(isTimeout&&null!=(_errorEvent$context=errorEvent.context)&&_errorEvent$context.deliveryDirectives)this.warn(`Retrying playlist loading ${retryCount+1}/${retryConfig.maxNumRetry} after "${errorDetails}" without delivery-directives`),this.loadPlaylist();else{const delay=getRetryDelay(retryConfig,retryCount);this.timer=self.setTimeout((()=>this.loadPlaylist()),delay),this.warn(`Retrying playlist loading ${retryCount+1}/${retryConfig.maxNumRetry} after "${errorDetails}" in ${delay}ms`)}errorEvent.levelRetry=!0,errorAction.resolved=!0}return retry}}class EWMA{constructor(halfLife,estimate=0,weight=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=halfLife,this.alpha_=halfLife?Math.exp(Math.log(.5)/halfLife):0,this.estimate_=estimate,this.totalWeight_=weight}sample(weight,value){const adjAlpha=Math.pow(this.alpha_,weight);this.estimate_=value*(1-adjAlpha)+adjAlpha*this.estimate_,this.totalWeight_+=weight}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const zeroFactor=1-Math.pow(this.alpha_,this.totalWeight_);if(zeroFactor)return this.estimate_/zeroFactor}return this.estimate_}}class EwmaBandWidthEstimator{constructor(slow,fast,defaultEstimate,defaultTTFB=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=defaultEstimate,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new EWMA(slow),this.fast_=new EWMA(fast),this.defaultTTFB_=defaultTTFB,this.ttfb_=new EWMA(slow)}update(slow,fast){const{slow_,fast_,ttfb_}=this;slow_.halfLife!==slow&&(this.slow_=new EWMA(slow,slow_.getEstimate(),slow_.getTotalWeight())),fast_.halfLife!==fast&&(this.fast_=new EWMA(fast,fast_.getEstimate(),fast_.getTotalWeight())),ttfb_.halfLife!==slow&&(this.ttfb_=new EWMA(slow,ttfb_.getEstimate(),ttfb_.getTotalWeight()))}sample(durationMs,numBytes){const durationS=(durationMs=Math.max(durationMs,this.minDelayMs_))/1e3,bandwidthInBps=8*numBytes/durationS;this.fast_.sample(durationS,bandwidthInBps),this.slow_.sample(durationS,bandwidthInBps)}sampleTTFB(ttfb){const seconds=ttfb/1e3,weight=Math.sqrt(2)*Math.exp(-Math.pow(seconds,2)/2);this.ttfb_.sample(weight,Math.max(ttfb,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const SUPPORTED_INFO_DEFAULT={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},SUPPORTED_INFO_CACHE={};function requiresMediaCapabilitiesDecodingInfo(level,audioTracksByGroup,currentVideoRange,currentFrameRate,currentBw,audioPreference){const audioGroups=level.audioCodec?level.audioGroups:null,audioCodecPreference=null==audioPreference?void 0:audioPreference.audioCodec,channelsPreference=null==audioPreference?void 0:audioPreference.channels,maxChannels=channelsPreference?parseInt(channelsPreference):audioCodecPreference?1/0:2;let audioChannels=null;if(null!=audioGroups&&audioGroups.length)try{audioChannels=1===audioGroups.length&&audioGroups[0]?audioTracksByGroup.groups[audioGroups[0]].channels:audioGroups.reduce(((acc,groupId)=>{if(groupId){const audioTrackGroup=audioTracksByGroup.groups[groupId];if(!audioTrackGroup)throw new Error(`Audio track group ${groupId} not found`);Object.keys(audioTrackGroup.channels).forEach((key=>{acc[key]=(acc[key]||0)+audioTrackGroup.channels[key]}))}return acc}),{2:0})}catch(error){return!0}return void 0!==level.videoCodec&&(level.width>1920&&level.height>1088||level.height>1920&&level.width>1088||level.frameRate>Math.max(currentFrameRate,30)||"SDR"!==level.videoRange&&level.videoRange!==currentVideoRange||level.bitrate>Math.max(currentBw,8e6))||!!audioChannels&&isFiniteNumber(maxChannels)&&Object.keys(audioChannels).some((channels=>parseInt(channels)>maxChannels))}function getMediaDecodingInfoPromise(level,audioTracksByGroup,mediaCapabilities){const videoCodecs=level.videoCodec,audioCodecs=level.audioCodec;if(!videoCodecs||!audioCodecs||!mediaCapabilities)return Promise.resolve(SUPPORTED_INFO_DEFAULT);const baseVideoConfiguration={width:level.width,height:level.height,bitrate:Math.ceil(Math.max(.9*level.bitrate,level.averageBitrate)),framerate:level.frameRate||30},videoRange=level.videoRange;"SDR"!==videoRange&&(baseVideoConfiguration.transferFunction=videoRange.toLowerCase());const configurations=videoCodecs.split(",").map((videoCodec=>({type:"media-source",video:_objectSpread2(_objectSpread2({},baseVideoConfiguration),{},{contentType:mimeTypeForCodec(videoCodec,"video")})})));return audioCodecs&&level.audioGroups&&level.audioGroups.forEach((audioGroupId=>{var _audioTracksByGroup$g;audioGroupId&&(null==(_audioTracksByGroup$g=audioTracksByGroup.groups[audioGroupId])||_audioTracksByGroup$g.tracks.forEach((audioTrack=>{if(audioTrack.groupId===audioGroupId){const channels=audioTrack.channels||"",channelsNumber=parseFloat(channels);isFiniteNumber(channelsNumber)&&channelsNumber>2&&configurations.push.apply(configurations,audioCodecs.split(",").map((audioCodec=>({type:"media-source",audio:{contentType:mimeTypeForCodec(audioCodec,"audio"),channels:""+channelsNumber}}))))}})))})),Promise.all(configurations.map((configuration=>{const decodingInfoKey=function getMediaDecodingInfoKey(config){const{audio,video}=config,mediaConfig=video||audio;if(mediaConfig){const codec=mediaConfig.contentType.split('"')[1];if(video)return`r${video.height}x${video.width}f${Math.ceil(video.framerate)}${video.transferFunction||"sd"}_${codec}_${Math.ceil(video.bitrate/1e5)}`;if(audio)return`c${audio.channels}${audio.spatialRendering?"s":"n"}_${codec}`}return""}(configuration);return SUPPORTED_INFO_CACHE[decodingInfoKey]||(SUPPORTED_INFO_CACHE[decodingInfoKey]=mediaCapabilities.decodingInfo(configuration))}))).then((decodingInfoResults=>({supported:!decodingInfoResults.some((info=>!info.supported)),configurations,decodingInfoResults}))).catch((error=>({supported:!1,configurations,decodingInfoResults:[],error})))}function getVideoSelectionOptions(currentVideoRange,videoPreference){let preferHDR=!1,allowedVideoRanges=[];return currentVideoRange&&(preferHDR="SDR"!==currentVideoRange,allowedVideoRanges=[currentVideoRange]),videoPreference&&(allowedVideoRanges=videoPreference.allowedVideoRanges||VideoRangeValues.slice(0),preferHDR=void 0!==videoPreference.preferHDR?videoPreference.preferHDR:function isHdrSupported(){if("function"==typeof matchMedia){const mediaQueryList=matchMedia("(dynamic-range: high)"),badQuery=matchMedia("bad query");if(mediaQueryList.media!==badQuery.media)return!0===mediaQueryList.matches}return!1}(),allowedVideoRanges=preferHDR?allowedVideoRanges.filter((range=>"SDR"!==range)):["SDR"]),{preferHDR,allowedVideoRanges}}function logStartCodecCandidateIgnored(codeSet,reason){logger.log(`[abr] start candidates with "${codeSet}" ignored because ${reason}`)}function findMatchingOption(option,tracks,matchPredicate){if("attrs"in option){const index=tracks.indexOf(option);if(-1!==index)return index}for(let i=0;i<tracks.length;i++){if(matchesOption(option,tracks[i],matchPredicate))return i}return-1}function matchesOption(option,track,matchPredicate){const{groupId,name,lang,assocLang,characteristics,default:isDefault}=option,forced=option.forced;return(void 0===groupId||track.groupId===groupId)&&(void 0===name||track.name===name)&&(void 0===lang||track.lang===lang)&&(void 0===lang||track.assocLang===assocLang)&&(void 0===isDefault||track.default===isDefault)&&(void 0===forced||track.forced===forced)&&(void 0===characteristics||function characteristicsMatch(characteristicsA,characteristicsB=""){const arrA=characteristicsA.split(","),arrB=characteristicsB.split(",");return arrA.length===arrB.length&&!arrA.some((el=>-1===arrB.indexOf(el)))}(characteristics,track.characteristics))&&(void 0===matchPredicate||matchPredicate(option,track))}function audioMatchPredicate(option,track){const{audioCodec,channels}=option;return!(void 0!==audioCodec&&(track.audioCodec||"").substring(0,4)!==audioCodec.substring(0,4)||void 0!==channels&&channels!==(track.channels||"2"))}function searchDownAndUpList(arr,searchIndex,predicate){for(let i=searchIndex;i;i--)if(predicate(arr[i]))return i;for(let i=searchIndex+1;i<arr.length;i++)if(predicate(arr[i]))return i;return-1}class TaskLoop{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(millis){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,millis),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var FragmentState_NOT_LOADED="NOT_LOADED",FragmentState_APPENDING="APPENDING",FragmentState_PARTIAL="PARTIAL",FragmentState_OK="OK";class FragmentTracker{constructor(hls){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=hls,this._registerListeners()}_registerListeners(){const{hls}=this;hls.on(Events.BUFFER_APPENDED,this.onBufferAppended,this),hls.on(Events.FRAG_BUFFERED,this.onFragBuffered,this),hls.on(Events.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls}=this;hls.off(Events.BUFFER_APPENDED,this.onBufferAppended,this),hls.off(Events.FRAG_BUFFERED,this.onFragBuffered,this),hls.off(Events.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(position,levelType){const activeParts=this.activePartLists[levelType];if(activeParts)for(let i=activeParts.length;i--;){const activePart=activeParts[i];if(!activePart)break;const appendedPTS=activePart.end;if(activePart.start<=position&&null!==appendedPTS&&position<=appendedPTS)return activePart}return this.getBufferedFrag(position,levelType)}getBufferedFrag(position,levelType){const{fragments}=this,keys=Object.keys(fragments);for(let i=keys.length;i--;){const fragmentEntity=fragments[keys[i]];if((null==fragmentEntity?void 0:fragmentEntity.body.type)===levelType&&fragmentEntity.buffered){const frag=fragmentEntity.body;if(frag.start<=position&&position<=frag.end)return frag}}return null}detectEvictedFragments(elementaryStream,timeRange,playlistType,appendedPart){this.timeRanges&&(this.timeRanges[elementaryStream]=timeRange);const appendedPartSn=(null==appendedPart?void 0:appendedPart.fragment.sn)||-1;Object.keys(this.fragments).forEach((key=>{const fragmentEntity=this.fragments[key];if(!fragmentEntity)return;if(appendedPartSn>=fragmentEntity.body.sn)return;if(!fragmentEntity.buffered&&!fragmentEntity.loaded)return void(fragmentEntity.body.type===playlistType&&this.removeFragment(fragmentEntity.body));const esData=fragmentEntity.range[elementaryStream];esData&&esData.time.some((time=>{const isNotBuffered=!this.isTimeBuffered(time.startPTS,time.endPTS,timeRange);return isNotBuffered&&this.removeFragment(fragmentEntity.body),isNotBuffered}))}))}detectPartialFragments(data){const timeRanges=this.timeRanges,{frag,part}=data;if(!timeRanges||"initSegment"===frag.sn)return;const fragKey=getFragmentKey(frag),fragmentEntity=this.fragments[fragKey];if(!fragmentEntity||fragmentEntity.buffered&&frag.gap)return;const isFragHint=!frag.relurl;if(Object.keys(timeRanges).forEach((elementaryStream=>{const streamInfo=frag.elementaryStreams[elementaryStream];if(!streamInfo)return;const timeRange=timeRanges[elementaryStream],partial=isFragHint||!0===streamInfo.partial;fragmentEntity.range[elementaryStream]=this.getBufferedTimes(frag,part,partial,timeRange)})),fragmentEntity.loaded=null,Object.keys(fragmentEntity.range).length){fragmentEntity.buffered=!0;(fragmentEntity.body.endList=frag.endList||fragmentEntity.body.endList)&&(this.endListFragments[fragmentEntity.body.type]=fragmentEntity),isPartial(fragmentEntity)||this.removeParts(frag.sn-1,frag.type)}else this.removeFragment(fragmentEntity.body)}removeParts(snToKeep,levelType){const activeParts=this.activePartLists[levelType];activeParts&&(this.activePartLists[levelType]=activeParts.filter((part=>part.fragment.sn>=snToKeep)))}fragBuffered(frag,force){const fragKey=getFragmentKey(frag);let fragmentEntity=this.fragments[fragKey];!fragmentEntity&&force&&(fragmentEntity=this.fragments[fragKey]={body:frag,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},frag.gap&&(this.hasGaps=!0)),fragmentEntity&&(fragmentEntity.loaded=null,fragmentEntity.buffered=!0)}getBufferedTimes(fragment,part,partial,timeRange){const buffered={time:[],partial},startPTS=fragment.start,endPTS=fragment.end,minEndPTS=fragment.minEndPTS||endPTS,maxStartPTS=fragment.maxStartPTS||startPTS;for(let i=0;i<timeRange.length;i++){const startTime=timeRange.start(i)-this.bufferPadding,endTime=timeRange.end(i)+this.bufferPadding;if(maxStartPTS>=startTime&&minEndPTS<=endTime){buffered.time.push({startPTS:Math.max(startPTS,timeRange.start(i)),endPTS:Math.min(endPTS,timeRange.end(i))});break}if(startPTS<endTime&&endPTS>startTime){const start=Math.max(startPTS,timeRange.start(i)),end=Math.min(endPTS,timeRange.end(i));end>start&&(buffered.partial=!0,buffered.time.push({startPTS:start,endPTS:end}))}else if(endPTS<=startTime)break}return buffered}getPartialFragment(time){let timePadding,startTime,endTime,bestFragment=null,bestOverlap=0;const{bufferPadding,fragments}=this;return Object.keys(fragments).forEach((key=>{const fragmentEntity=fragments[key];fragmentEntity&&isPartial(fragmentEntity)&&(startTime=fragmentEntity.body.start-bufferPadding,endTime=fragmentEntity.body.end+bufferPadding,time>=startTime&&time<=endTime&&(timePadding=Math.min(time-startTime,endTime-time),bestOverlap<=timePadding&&(bestFragment=fragmentEntity.body,bestOverlap=timePadding)))})),bestFragment}isEndListAppended(type){const lastFragmentEntity=this.endListFragments[type];return void 0!==lastFragmentEntity&&(lastFragmentEntity.buffered||isPartial(lastFragmentEntity))}getState(fragment){const fragKey=getFragmentKey(fragment),fragmentEntity=this.fragments[fragKey];return fragmentEntity?fragmentEntity.buffered?isPartial(fragmentEntity)?FragmentState_PARTIAL:FragmentState_OK:FragmentState_APPENDING:FragmentState_NOT_LOADED}isTimeBuffered(startPTS,endPTS,timeRange){let startTime,endTime;for(let i=0;i<timeRange.length;i++){if(startTime=timeRange.start(i)-this.bufferPadding,endTime=timeRange.end(i)+this.bufferPadding,startPTS>=startTime&&endPTS<=endTime)return!0;if(endPTS<=startTime)return!1}return!1}onFragLoaded(event,data){const{frag,part}=data;if("initSegment"===frag.sn||frag.bitrateTest)return;const loaded=part?null:data,fragKey=getFragmentKey(frag);this.fragments[fragKey]={body:frag,appendedPTS:null,loaded,buffered:!1,range:Object.create(null)}}onBufferAppended(event,data){const{frag,part,timeRanges}=data;if("initSegment"===frag.sn)return;const playlistType=frag.type;if(part){let activeParts=this.activePartLists[playlistType];activeParts||(this.activePartLists[playlistType]=activeParts=[]),activeParts.push(part)}this.timeRanges=timeRanges,Object.keys(timeRanges).forEach((elementaryStream=>{const timeRange=timeRanges[elementaryStream];this.detectEvictedFragments(elementaryStream,timeRange,playlistType,part)}))}onFragBuffered(event,data){this.detectPartialFragments(data)}hasFragment(fragment){const fragKey=getFragmentKey(fragment);return!!this.fragments[fragKey]}hasParts(type){var _this$activePartLists;return!(null==(_this$activePartLists=this.activePartLists[type])||!_this$activePartLists.length)}removeFragmentsInRange(start,end,playlistType,withGapOnly,unbufferedOnly){withGapOnly&&!this.hasGaps||Object.keys(this.fragments).forEach((key=>{const fragmentEntity=this.fragments[key];if(!fragmentEntity)return;const frag=fragmentEntity.body;frag.type!==playlistType||withGapOnly&&!frag.gap||frag.start<end&&frag.end>start&&(fragmentEntity.buffered||unbufferedOnly)&&this.removeFragment(frag)}))}removeFragment(fragment){const fragKey=getFragmentKey(fragment);fragment.stats.loaded=0,fragment.clearElementaryStreamInfo();const activeParts=this.activePartLists[fragment.type];if(activeParts){const snToRemove=fragment.sn;this.activePartLists[fragment.type]=activeParts.filter((part=>part.fragment.sn!==snToRemove))}delete this.fragments[fragKey],fragment.endList&&delete this.endListFragments[fragment.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function isPartial(fragmentEntity){var _fragmentEntity$range,_fragmentEntity$range2,_fragmentEntity$range3;return fragmentEntity.buffered&&(fragmentEntity.body.gap||(null==(_fragmentEntity$range=fragmentEntity.range.video)?void 0:_fragmentEntity$range.partial)||(null==(_fragmentEntity$range2=fragmentEntity.range.audio)?void 0:_fragmentEntity$range2.partial)||(null==(_fragmentEntity$range3=fragmentEntity.range.audiovideo)?void 0:_fragmentEntity$range3.partial))}function getFragmentKey(fragment){return`${fragment.type}_${fragment.level}_${fragment.sn}`}const noopBuffered={length:0,start:()=>0,end:()=>0};class BufferHelper{static isBuffered(media,position){try{if(media){const buffered=BufferHelper.getBuffered(media);for(let i=0;i<buffered.length;i++)if(position>=buffered.start(i)&&position<=buffered.end(i))return!0}}catch(error){}return!1}static bufferInfo(media,pos,maxHoleDuration){try{if(media){const vbuffered=BufferHelper.getBuffered(media),buffered=[];let i;for(i=0;i<vbuffered.length;i++)buffered.push({start:vbuffered.start(i),end:vbuffered.end(i)});return this.bufferedInfo(buffered,pos,maxHoleDuration)}}catch(error){}return{len:0,start:pos,end:pos,nextStart:void 0}}static bufferedInfo(buffered,pos,maxHoleDuration){pos=Math.max(0,pos),buffered.sort((function(a,b){const diff=a.start-b.start;return diff||b.end-a.end}));let buffered2=[];if(maxHoleDuration)for(let i=0;i<buffered.length;i++){const buf2len=buffered2.length;if(buf2len){const buf2end=buffered2[buf2len-1].end;buffered[i].start-buf2end<maxHoleDuration?buffered[i].end>buf2end&&(buffered2[buf2len-1].end=buffered[i].end):buffered2.push(buffered[i])}else buffered2.push(buffered[i])}else buffered2=buffered;let bufferStartNext,bufferLen=0,bufferStart=pos,bufferEnd=pos;for(let i=0;i<buffered2.length;i++){const start=buffered2[i].start,end=buffered2[i].end;if(pos+maxHoleDuration>=start&&pos<end)bufferStart=start,bufferEnd=end,bufferLen=bufferEnd-pos;else if(pos+maxHoleDuration<start){bufferStartNext=start;break}}return{len:bufferLen,start:bufferStart||0,end:bufferEnd||0,nextStart:bufferStartNext}}static getBuffered(media){try{return media.buffered}catch(e){return logger.log("failed to get media.buffered",e),noopBuffered}}}class ChunkMetadata{constructor(level,sn,id,size=0,part=-1,partial=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=level,this.sn=sn,this.id=id,this.size=size,this.part=part,this.partial=partial}}function findFirstFragWithCC(fragments,cc){for(let i=0,len=fragments.length;i<len;i++){var _fragments$i;if((null==(_fragments$i=fragments[i])?void 0:_fragments$i.cc)===cc)return fragments[i]}return null}function adjustFragmentStart(frag,sliding){if(frag){const start=frag.start+sliding;frag.start=frag.startPTS=start,frag.endPTS=start+frag.duration}}function adjustSlidingStart(sliding,details){const fragments=details.fragments;for(let i=0,len=fragments.length;i<len;i++)adjustFragmentStart(fragments[i],sliding);details.fragmentHint&&adjustFragmentStart(details.fragmentHint,sliding),details.alignedSliding=!0}function alignStream(lastFrag,switchDetails,details){switchDetails&&(!function alignDiscontinuities(lastFrag,details,switchDetails){if(function shouldAlignOnDiscontinuities(lastFrag,switchDetails,details){return!(!switchDetails||!(details.endCC>details.startCC||lastFrag&&lastFrag.cc<details.startCC))}(lastFrag,switchDetails,details)){const referenceFrag=function findDiscontinuousReferenceFrag(prevDetails,curDetails){const prevFrags=prevDetails.fragments,curFrags=curDetails.fragments;if(!curFrags.length||!prevFrags.length)return void logger.log("No fragments to align");const prevStartFrag=findFirstFragWithCC(prevFrags,curFrags[0].cc);if(prevStartFrag&&(!prevStartFrag||prevStartFrag.startPTS))return prevStartFrag;logger.log("No frag in previous level to align on")}(switchDetails,details);referenceFrag&&isFiniteNumber(referenceFrag.start)&&(logger.log(`Adjusting PTS using last level due to CC increase within current level ${details.url}`),adjustSlidingStart(referenceFrag.start,details))}}(lastFrag,details,switchDetails),!details.alignedSliding&&switchDetails&&alignMediaPlaylistByPDT(details,switchDetails),details.alignedSliding||!switchDetails||details.skippedSegments||adjustSliding(switchDetails,details))}function alignMediaPlaylistByPDT(details,refDetails){if(!details.hasProgramDateTime||!refDetails.hasProgramDateTime)return;const fragments=details.fragments,refFragments=refDetails.fragments;if(!fragments.length||!refFragments.length)return;let refFrag,frag;const targetCC=Math.min(refDetails.endCC,details.endCC);refDetails.startCC<targetCC&&details.startCC<targetCC&&(refFrag=findFirstFragWithCC(refFragments,targetCC),frag=findFirstFragWithCC(fragments,targetCC)),refFrag&&frag||(refFrag=refFragments[Math.floor(refFragments.length/2)],frag=findFirstFragWithCC(fragments,refFrag.cc)||fragments[Math.floor(fragments.length/2)]);const refPDT=refFrag.programDateTime,targetPDT=frag.programDateTime;if(!refPDT||!targetPDT)return;adjustSlidingStart((targetPDT-refPDT)/1e3-(frag.start-refFrag.start),details)}const MIN_CHUNK_SIZE=Math.pow(2,17);class FragmentLoader{constructor(config){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=config}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(frag,onProgress){const url=frag.url;if(!url)return Promise.reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag,error:new Error("Fragment does not have a "+(url?"part list":"url")),networkDetails:null}));this.abort();const config=this.config,FragmentILoader=config.fLoader,DefaultILoader=config.loader;return new Promise(((resolve,reject)=>{if(this.loader&&this.loader.destroy(),frag.gap){if(frag.tagList.some((tags=>"GAP"===tags[0])))return void reject(createGapLoadError(frag));frag.gap=!1}const loader=this.loader=frag.loader=FragmentILoader?new FragmentILoader(config):new DefaultILoader(config),loaderContext=createLoaderContext(frag),loadPolicy=getLoaderConfigWithoutReties(config.fragLoadPolicy.default),loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===frag.sn?1/0:MIN_CHUNK_SIZE};frag.stats=loader.stats,loader.load(loaderContext,loaderConfig,{onSuccess:(response,stats,context,networkDetails)=>{this.resetLoader(frag,loader);let payload=response.data;context.resetIV&&frag.decryptdata&&(frag.decryptdata.iv=new Uint8Array(payload.slice(0,16)),payload=payload.slice(16)),resolve({frag,part:null,payload,networkDetails})},onError:(response,context,networkDetails,stats)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag,response:_objectSpread2({url,data:void 0},response),error:new Error(`HTTP Error ${response.code} ${response.text}`),networkDetails,stats}))},onAbort:(stats,context,networkDetails)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag,error:new Error("Aborted"),networkDetails,stats}))},onTimeout:(stats,context,networkDetails)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag,error:new Error(`Timeout after ${loaderConfig.timeout}ms`),networkDetails,stats}))},onProgress:(stats,context,data,networkDetails)=>{onProgress&&onProgress({frag,part:null,payload:data,networkDetails})}})}))}loadPart(frag,part,onProgress){this.abort();const config=this.config,FragmentILoader=config.fLoader,DefaultILoader=config.loader;return new Promise(((resolve,reject)=>{if(this.loader&&this.loader.destroy(),frag.gap||part.gap)return void reject(createGapLoadError(frag,part));const loader=this.loader=frag.loader=FragmentILoader?new FragmentILoader(config):new DefaultILoader(config),loaderContext=createLoaderContext(frag,part),loadPolicy=getLoaderConfigWithoutReties(config.fragLoadPolicy.default),loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:MIN_CHUNK_SIZE};part.stats=loader.stats,loader.load(loaderContext,loaderConfig,{onSuccess:(response,stats,context,networkDetails)=>{this.resetLoader(frag,loader),this.updateStatsFromPart(frag,part);const partLoadedData={frag,part,payload:response.data,networkDetails};onProgress(partLoadedData),resolve(partLoadedData)},onError:(response,context,networkDetails,stats)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag,part,response:_objectSpread2({url:loaderContext.url,data:void 0},response),error:new Error(`HTTP Error ${response.code} ${response.text}`),networkDetails,stats}))},onAbort:(stats,context,networkDetails)=>{frag.stats.aborted=part.stats.aborted,this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag,part,error:new Error("Aborted"),networkDetails,stats}))},onTimeout:(stats,context,networkDetails)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes.NETWORK_ERROR,details:ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag,part,error:new Error(`Timeout after ${loaderConfig.timeout}ms`),networkDetails,stats}))}})}))}updateStatsFromPart(frag,part){const fragStats=frag.stats,partStats=part.stats,partTotal=partStats.total;if(fragStats.loaded+=partStats.loaded,partTotal){const estTotalParts=Math.round(frag.duration/part.duration),estLoadedParts=Math.min(Math.round(fragStats.loaded/partTotal),estTotalParts),estRemainingBytes=(estTotalParts-estLoadedParts)*Math.round(fragStats.loaded/estLoadedParts);fragStats.total=fragStats.loaded+estRemainingBytes}else fragStats.total=Math.max(fragStats.loaded,fragStats.total);const fragLoading=fragStats.loading,partLoading=partStats.loading;fragLoading.start?fragLoading.first+=partLoading.first-partLoading.start:(fragLoading.start=partLoading.start,fragLoading.first=partLoading.first),fragLoading.end=partLoading.end}resetLoader(frag,loader){frag.loader=null,this.loader===loader&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),loader.destroy()}}function createLoaderContext(frag,part=null){const segment=part||frag,loaderContext={frag,part,responseType:"arraybuffer",url:segment.url,headers:{},rangeStart:0,rangeEnd:0},start=segment.byteRangeStartOffset,end=segment.byteRangeEndOffset;if(isFiniteNumber(start)&&isFiniteNumber(end)){var _frag$decryptdata;let byteRangeStart=start,byteRangeEnd=end;if("initSegment"===frag.sn&&"AES-128"===(null==(_frag$decryptdata=frag.decryptdata)?void 0:_frag$decryptdata.method)){const fragmentLen=end-start;fragmentLen%16&&(byteRangeEnd=end+(16-fragmentLen%16)),0!==start&&(loaderContext.resetIV=!0,byteRangeStart=start-16)}loaderContext.rangeStart=byteRangeStart,loaderContext.rangeEnd=byteRangeEnd}return loaderContext}function createGapLoadError(frag,part){const error=new Error(`GAP ${frag.gap?"tag":"attribute"} found`),errorData={type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_GAP,fatal:!1,frag,error,networkDetails:null};return part&&(errorData.part=part),(part||frag).stats.aborted=!0,new LoadError(errorData)}class LoadError extends Error{constructor(data){super(data.error.message),this.data=void 0,this.data=data}}class AESCrypto{constructor(subtle,iv){this.subtle=void 0,this.aesIV=void 0,this.subtle=subtle,this.aesIV=iv}decrypt(data,key){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},key,data)}}class FastAESKey{constructor(subtle,key){this.subtle=void 0,this.key=void 0,this.subtle=subtle,this.key=key}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class AESDecryptor{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(arrayBuffer){const view=new DataView(arrayBuffer),newArray=new Uint32Array(4);for(let i=0;i<4;i++)newArray[i]=view.getUint32(4*i);return newArray}initTable(){const sBox=this.sBox,invSBox=this.invSBox,subMix=this.subMix,subMix0=subMix[0],subMix1=subMix[1],subMix2=subMix[2],subMix3=subMix[3],invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3],d=new Uint32Array(256);let x=0,xi=0,i=0;for(i=0;i<256;i++)d[i]=i<128?i<<1:i<<1^283;for(i=0;i<256;i++){let sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,sBox[x]=sx,invSBox[sx]=x;const x2=d[x],x4=d[x2],x8=d[x4];let t=257*d[sx]^16843008*sx;subMix0[x]=t<<24|t>>>8,subMix1[x]=t<<16|t>>>16,subMix2[x]=t<<8|t>>>24,subMix3[x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,invSubMix0[sx]=t<<24|t>>>8,invSubMix1[sx]=t<<16|t>>>16,invSubMix2[sx]=t<<8|t>>>24,invSubMix3[sx]=t,x?(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]]):x=xi=1}}expandKey(keyBuffer){const key=this.uint8ArrayToUint32Array_(keyBuffer);let sameKey=!0,offset=0;for(;offset<key.length&&sameKey;)sameKey=key[offset]===this.key[offset],offset++;if(sameKey)return;this.key=key;const keySize=this.keySize=key.length;if(4!==keySize&&6!==keySize&&8!==keySize)throw new Error("Invalid aes key size="+keySize);const ksRows=this.ksRows=4*(keySize+6+1);let ksRow,invKsRow;const keySchedule=this.keySchedule=new Uint32Array(ksRows),invKeySchedule=this.invKeySchedule=new Uint32Array(ksRows),sbox=this.sBox,rcon=this.rcon,invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3];let prev,t;for(ksRow=0;ksRow<ksRows;ksRow++)ksRow<keySize?prev=keySchedule[ksRow]=key[ksRow]:(t=prev,ksRow%keySize==0?(t=t<<8|t>>>24,t=sbox[t>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t],t^=rcon[ksRow/keySize|0]<<24):keySize>6&&ksRow%keySize==4&&(t=sbox[t>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t]),keySchedule[ksRow]=prev=(keySchedule[ksRow-keySize]^t)>>>0);for(invKsRow=0;invKsRow<ksRows;invKsRow++)ksRow=ksRows-invKsRow,t=3&invKsRow?keySchedule[ksRow]:keySchedule[ksRow-4],invKeySchedule[invKsRow]=invKsRow<4||ksRow<=4?t:invSubMix0[sbox[t>>>24]]^invSubMix1[sbox[t>>>16&255]]^invSubMix2[sbox[t>>>8&255]]^invSubMix3[sbox[255&t]],invKeySchedule[invKsRow]=invKeySchedule[invKsRow]>>>0}networkToHostOrderSwap(word){return word<<24|(65280&word)<<8|(16711680&word)>>8|word>>>24}decrypt(inputArrayBuffer,offset,aesIV){const nRounds=this.keySize+6,invKeySchedule=this.invKeySchedule,invSBOX=this.invSBox,invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3],initVector=this.uint8ArrayToUint32Array_(aesIV);let initVector0=initVector[0],initVector1=initVector[1],initVector2=initVector[2],initVector3=initVector[3];const inputInt32=new Int32Array(inputArrayBuffer),outputInt32=new Int32Array(inputInt32.length);let t0,t1,t2,t3,s0,s1,s2,s3,inputWords0,inputWords1,inputWords2,inputWords3,ksRow,i;const swapWord=this.networkToHostOrderSwap;for(;offset<inputInt32.length;){for(inputWords0=swapWord(inputInt32[offset]),inputWords1=swapWord(inputInt32[offset+1]),inputWords2=swapWord(inputInt32[offset+2]),inputWords3=swapWord(inputInt32[offset+3]),s0=inputWords0^invKeySchedule[0],s1=inputWords3^invKeySchedule[1],s2=inputWords2^invKeySchedule[2],s3=inputWords1^invKeySchedule[3],ksRow=4,i=1;i<nRounds;i++)t0=invSubMix0[s0>>>24]^invSubMix1[s1>>16&255]^invSubMix2[s2>>8&255]^invSubMix3[255&s3]^invKeySchedule[ksRow],t1=invSubMix0[s1>>>24]^invSubMix1[s2>>16&255]^invSubMix2[s3>>8&255]^invSubMix3[255&s0]^invKeySchedule[ksRow+1],t2=invSubMix0[s2>>>24]^invSubMix1[s3>>16&255]^invSubMix2[s0>>8&255]^invSubMix3[255&s1]^invKeySchedule[ksRow+2],t3=invSubMix0[s3>>>24]^invSubMix1[s0>>16&255]^invSubMix2[s1>>8&255]^invSubMix3[255&s2]^invKeySchedule[ksRow+3],s0=t0,s1=t1,s2=t2,s3=t3,ksRow+=4;t0=invSBOX[s0>>>24]<<24^invSBOX[s1>>16&255]<<16^invSBOX[s2>>8&255]<<8^invSBOX[255&s3]^invKeySchedule[ksRow],t1=invSBOX[s1>>>24]<<24^invSBOX[s2>>16&255]<<16^invSBOX[s3>>8&255]<<8^invSBOX[255&s0]^invKeySchedule[ksRow+1],t2=invSBOX[s2>>>24]<<24^invSBOX[s3>>16&255]<<16^invSBOX[s0>>8&255]<<8^invSBOX[255&s1]^invKeySchedule[ksRow+2],t3=invSBOX[s3>>>24]<<24^invSBOX[s0>>16&255]<<16^invSBOX[s1>>8&255]<<8^invSBOX[255&s2]^invKeySchedule[ksRow+3],outputInt32[offset]=swapWord(t0^initVector0),outputInt32[offset+1]=swapWord(t3^initVector1),outputInt32[offset+2]=swapWord(t2^initVector2),outputInt32[offset+3]=swapWord(t1^initVector3),initVector0=inputWords0,initVector1=inputWords1,initVector2=inputWords2,initVector3=inputWords3,offset+=4}return outputInt32.buffer}}class Decrypter{constructor(config,{removePKCS7Padding=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=config.enableSoftwareAES,this.removePKCS7Padding=removePKCS7Padding,removePKCS7Padding)try{const browserCrypto=self.crypto;browserCrypto&&(this.subtle=browserCrypto.subtle||browserCrypto.webkitSubtle)}catch(e){}null===this.subtle&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult,remainderData}=this;if(!currentResult||remainderData)return this.reset(),null;const data=new Uint8Array(currentResult);return this.reset(),this.removePKCS7Padding?function removePadding(array){const outputBytes=array.byteLength,paddingBytes=outputBytes&&new DataView(array.buffer).getUint8(outputBytes-1);return paddingBytes?sliceUint8(array,0,outputBytes-paddingBytes):array}(data):data}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(data,key,iv){return this.useSoftware?new Promise(((resolve,reject)=>{this.softwareDecrypt(new Uint8Array(data),key,iv);const decryptResult=this.flush();decryptResult?resolve(decryptResult.buffer):reject(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(data),key,iv)}softwareDecrypt(data,key,iv){const{currentIV,currentResult,remainderData}=this;this.logOnce("JS AES decrypt"),remainderData&&(data=appendUint8Array(remainderData,data),this.remainderData=null);const currentChunk=this.getValidChunk(data);if(!currentChunk.length)return null;currentIV&&(iv=currentIV);let softwareDecrypter=this.softwareDecrypter;softwareDecrypter||(softwareDecrypter=this.softwareDecrypter=new AESDecryptor),softwareDecrypter.expandKey(key);const result=currentResult;return this.currentResult=softwareDecrypter.decrypt(currentChunk.buffer,0,iv),this.currentIV=sliceUint8(currentChunk,-16).buffer,result||null}webCryptoDecrypt(data,key,iv){const subtle=this.subtle;return this.key===key&&this.fastAesKey||(this.key=key,this.fastAesKey=new FastAESKey(subtle,key)),this.fastAesKey.expandKey().then((aesKey=>{if(!subtle)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new AESCrypto(subtle,new Uint8Array(iv)).decrypt(data.buffer,aesKey)})).catch((err=>(logger.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${err.name}: ${err.message}`),this.onWebCryptoError(data,key,iv))))}onWebCryptoError(data,key,iv){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(data,key,iv);const decryptResult=this.flush();if(decryptResult)return decryptResult.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(data){let currentChunk=data;const splitPoint=data.length-data.length%16;return splitPoint!==data.length&&(currentChunk=sliceUint8(data,0,splitPoint),this.remainderData=sliceUint8(data,splitPoint)),currentChunk}logOnce(msg){this.logEnabled&&(logger.log(`[decrypter]: ${msg}`),this.logEnabled=!1)}}const TimeRanges_toString=function(r){let log="";const len=r.length;for(let i=0;i<len;i++)log+=`[${r.start(i).toFixed(3)}-${r.end(i).toFixed(3)}]`;return log},State_STOPPED="STOPPED",State_IDLE="IDLE",State_KEY_LOADING="KEY_LOADING",State_FRAG_LOADING="FRAG_LOADING",State_FRAG_LOADING_WAITING_RETRY="FRAG_LOADING_WAITING_RETRY",State_WAITING_TRACK="WAITING_TRACK",State_PARSING="PARSING",State_PARSED="PARSED",State_ENDED="ENDED",State_ERROR="ERROR",State_WAITING_INIT_PTS="WAITING_INIT_PTS",State_WAITING_LEVEL="WAITING_LEVEL";class BaseStreamController extends TaskLoop{constructor(hls,fragmentTracker,keyLoader,logPrefix,playlistType){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=State_STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=playlistType,this.logPrefix=logPrefix,this.log=logger.log.bind(logger,`${logPrefix}:`),this.warn=logger.warn.bind(logger,`${logPrefix}:`),this.hls=hls,this.fragmentLoader=new FragmentLoader(hls.config),this.keyLoader=keyLoader,this.fragmentTracker=fragmentTracker,this.config=hls.config,this.decrypter=new Decrypter(hls.config),hls.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(startPosition){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const frag=this.fragCurrent;null!=frag&&frag.loader&&(frag.abortRequests(),this.fragmentTracker.removeFragment(frag)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=State_STOPPED}_streamEnded(bufferInfo,levelDetails){if(levelDetails.live||bufferInfo.nextStart||!bufferInfo.end||!this.media)return!1;const partList=levelDetails.partList;if(null!=partList&&partList.length){const lastPart=partList[partList.length-1];return BufferHelper.isBuffered(this.media,lastPart.start+lastPart.duration/2)}const playlistType=levelDetails.fragments[levelDetails.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(playlistType)}getLevelDetails(){var _this$levelLastLoaded;if(this.levels&&null!==this.levelLastLoaded)return null==(_this$levelLastLoaded=this.levelLastLoaded)?void 0:_this$levelLastLoaded.details}onMediaAttached(event,data){const media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),media.addEventListener("seeking",this.onvseeking),media.addEventListener("ended",this.onvended);const config=this.config;this.levels&&config.autoStartLoad&&this.state===State_STOPPED&&this.startLoad(config.startPosition)}onMediaDetaching(){const media=this.media;null!=media&&media.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),media&&this.onvseeking&&this.onvended&&(media.removeEventListener("seeking",this.onvseeking),media.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config,fragCurrent,media,mediaBuffer,state}=this,currentTime=media?media.currentTime:0,bufferInfo=BufferHelper.bufferInfo(mediaBuffer||media,currentTime,config.maxBufferHole);if(this.log(`media seeking to ${isFiniteNumber(currentTime)?currentTime.toFixed(3):currentTime}, state: ${state}`),this.state===State_ENDED)this.resetLoadingState();else if(fragCurrent){const tolerance=config.maxFragLookUpTolerance,fragStartOffset=fragCurrent.start-tolerance,fragEndOffset=fragCurrent.start+fragCurrent.duration+tolerance;if(!bufferInfo.len||fragEndOffset<bufferInfo.start||fragStartOffset>bufferInfo.end){const pastFragment=currentTime>fragEndOffset;(currentTime<fragStartOffset||pastFragment)&&(pastFragment&&fragCurrent.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),fragCurrent.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}media&&(this.fragmentTracker.removeFragmentsInRange(currentTime,1/0,this.playlistType,!0),this.lastCurrentTime=currentTime),this.loadedmetadata||bufferInfo.len||(this.nextLoadPosition=this.startPosition=currentTime),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(event,data){this.startTimeOffset=data.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=State_STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(frag,level,targetBufferTime){this._loadFragForPlayback(frag,level,targetBufferTime)}_loadFragForPlayback(frag,level,targetBufferTime){this._doFragLoad(frag,level,targetBufferTime,(data=>{if(this.fragContextChanged(frag))return this.warn(`Fragment ${frag.sn}${data.part?" p: "+data.part.index:""} of level ${frag.level} was dropped during download.`),void this.fragmentTracker.removeFragment(frag);frag.stats.chunkCount++,this._handleFragmentLoadProgress(data)})).then((data=>{if(!data)return;const state=this.state;this.fragContextChanged(frag)?(state===State_FRAG_LOADING||!this.fragCurrent&&state===State_PARSING)&&(this.fragmentTracker.removeFragment(frag),this.state=State_IDLE):("payload"in data&&(this.log(`Loaded fragment ${frag.sn} of level ${frag.level}`),this.hls.trigger(Events.FRAG_LOADED,data)),this._handleFragmentLoadComplete(data))})).catch((reason=>{this.state!==State_STOPPED&&this.state!==State_ERROR&&(this.warn(reason),this.resetFragmentLoading(frag))}))}clearTrackerIfNeeded(frag){var _this$mediaBuffer;const{fragmentTracker}=this;if(fragmentTracker.getState(frag)===FragmentState_APPENDING){const playlistType=frag.type,bufferedInfo=this.getFwdBufferInfo(this.mediaBuffer,playlistType),minForwardBufferLength=Math.max(frag.duration,bufferedInfo?bufferedInfo.len:this.config.maxBufferLength);this.reduceMaxBufferLength(minForwardBufferLength)&&fragmentTracker.removeFragment(frag)}else 0===(null==(_this$mediaBuffer=this.mediaBuffer)?void 0:_this$mediaBuffer.buffered.length)?fragmentTracker.removeAllFragments():fragmentTracker.hasParts(frag.type)&&(fragmentTracker.detectPartialFragments({frag,part:null,stats:frag.stats,id:frag.type}),fragmentTracker.getState(frag)===FragmentState_PARTIAL&&fragmentTracker.removeFragment(frag))}checkLiveUpdate(details){if(details.updated&&!details.live){const lastFragment=details.fragments[details.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:lastFragment,part:null,stats:lastFragment.stats,id:lastFragment.type})}details.fragments[0]||(details.deltaUpdateFailed=!0)}flushMainBuffer(startOffset,endOffset,type=null){if(!(startOffset-endOffset))return;const flushScope={startOffset,endOffset,type};this.hls.trigger(Events.BUFFER_FLUSHING,flushScope)}_loadInitSegment(frag,level){this._doFragLoad(frag,level).then((data=>{if(!data||this.fragContextChanged(frag)||!this.levels)throw new Error("init load aborted");return data})).then((data=>{const{hls}=this,{payload}=data,decryptData=frag.decryptdata;if(payload&&payload.byteLength>0&&null!=decryptData&&decryptData.key&&decryptData.iv&&"AES-128"===decryptData.method){const startTime=self.performance.now();return this.decrypter.decrypt(new Uint8Array(payload),decryptData.key.buffer,decryptData.iv.buffer).catch((err=>{throw hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_DECRYPT_ERROR,fatal:!1,error:err,reason:err.message,frag}),err})).then((decryptedData=>{const endTime=self.performance.now();return hls.trigger(Events.FRAG_DECRYPTED,{frag,payload:decryptedData,stats:{tstart:startTime,tdecrypt:endTime}}),data.payload=decryptedData,this.completeInitSegmentLoad(data)}))}return this.completeInitSegmentLoad(data)})).catch((reason=>{this.state!==State_STOPPED&&this.state!==State_ERROR&&(this.warn(reason),this.resetFragmentLoading(frag))}))}completeInitSegmentLoad(data){const{levels}=this;if(!levels)throw new Error("init load aborted, missing levels");const stats=data.frag.stats;this.state=State_IDLE,data.frag.data=new Uint8Array(data.payload),stats.parsing.start=stats.buffering.start=self.performance.now(),stats.parsing.end=stats.buffering.end=self.performance.now(),this.tick()}fragContextChanged(frag){const{fragCurrent}=this;return!frag||!fragCurrent||frag.sn!==fragCurrent.sn||frag.level!==fragCurrent.level}fragBufferedComplete(frag,part){var _frag$startPTS,_frag$endPTS,_this$fragCurrent,_this$fragPrevious;const media=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${frag.type} sn: ${frag.sn}${part?" part: "+part.index:""} of ${this.playlistType===PlaylistLevelType_MAIN?"level":"track"} ${frag.level} (frag:[${(null!=(_frag$startPTS=frag.startPTS)?_frag$startPTS:NaN).toFixed(3)}-${(null!=(_frag$endPTS=frag.endPTS)?_frag$endPTS:NaN).toFixed(3)}] > buffer:${media?TimeRanges_toString(BufferHelper.getBuffered(media)):"(detached)"})`),"initSegment"!==frag.sn){var _this$levels;if(frag.type!==PlaylistLevelType_SUBTITLE){const el=frag.elementaryStreams;if(!Object.keys(el).some((type=>!!el[type])))return void(this.state=State_IDLE)}const level=null==(_this$levels=this.levels)?void 0:_this$levels[frag.level];null!=level&&level.fragmentError&&(this.log(`Resetting level fragment error count of ${level.fragmentError} on frag buffered`),level.fragmentError=0)}this.state=State_IDLE,media&&(!this.loadedmetadata&&frag.type==PlaylistLevelType_MAIN&&media.buffered.length&&(null==(_this$fragCurrent=this.fragCurrent)?void 0:_this$fragCurrent.sn)===(null==(_this$fragPrevious=this.fragPrevious)?void 0:_this$fragPrevious.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(fragLoadedEndData){const{transmuxer}=this;if(!transmuxer)return;const{frag,part,partsLoaded}=fragLoadedEndData,complete=!partsLoaded||0===partsLoaded.length||partsLoaded.some((fragLoaded=>!fragLoaded)),chunkMeta=new ChunkMetadata(frag.level,frag.sn,frag.stats.chunkCount+1,0,part?part.index:-1,!complete);transmuxer.flush(chunkMeta)}_handleFragmentLoadProgress(frag){}_doFragLoad(frag,level,targetBufferTime=null,progressCallback){var _frag$decryptdata;const details=null==level?void 0:level.details;if(!this.levels||!details)throw new Error(`frag load aborted, missing level${details?"":" detail"}s`);let keyLoadingPromise=null;if(!frag.encrypted||null!=(_frag$decryptdata=frag.decryptdata)&&_frag$decryptdata.key?!frag.encrypted&&details.encryptedFragments.length&&this.keyLoader.loadClear(frag,details.encryptedFragments):(this.log(`Loading key for ${frag.sn} of [${details.startSN}-${details.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${frag.level}`),this.state=State_KEY_LOADING,this.fragCurrent=frag,keyLoadingPromise=this.keyLoader.load(frag).then((keyLoadedData=>{if(!this.fragContextChanged(keyLoadedData.frag))return this.hls.trigger(Events.KEY_LOADED,keyLoadedData),this.state===State_KEY_LOADING&&(this.state=State_IDLE),keyLoadedData})),this.hls.trigger(Events.KEY_LOADING,{frag}),null===this.fragCurrent&&(keyLoadingPromise=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),targetBufferTime=Math.max(frag.start,targetBufferTime||0),this.config.lowLatencyMode&&"initSegment"!==frag.sn){const partList=details.partList;if(partList&&progressCallback){targetBufferTime>frag.end&&details.fragmentHint&&(frag=details.fragmentHint);const partIndex=this.getNextPart(partList,frag,targetBufferTime);if(partIndex>-1){const part=partList[partIndex];let _result;return this.log(`Loading part sn: ${frag.sn} p: ${part.index} cc: ${frag.cc} of playlist [${details.startSN}-${details.endSN}] parts [0-${partIndex}-${partList.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${frag.level}, target: ${parseFloat(targetBufferTime.toFixed(3))}`),this.nextLoadPosition=part.start+part.duration,this.state=State_FRAG_LOADING,_result=keyLoadingPromise?keyLoadingPromise.then((keyLoadedData=>!keyLoadedData||this.fragContextChanged(keyLoadedData.frag)?null:this.doFragPartsLoad(frag,part,level,progressCallback))).catch((error=>this.handleFragLoadError(error))):this.doFragPartsLoad(frag,part,level,progressCallback).catch((error=>this.handleFragLoadError(error))),this.hls.trigger(Events.FRAG_LOADING,{frag,part,targetBufferTime}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):_result}if(!frag.url||this.loadedEndOfParts(partList,targetBufferTime))return Promise.resolve(null)}}this.log(`Loading fragment ${frag.sn} cc: ${frag.cc} ${details?"of ["+details.startSN+"-"+details.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${frag.level}, target: ${parseFloat(targetBufferTime.toFixed(3))}`),isFiniteNumber(frag.sn)&&!this.bitrateTest&&(this.nextLoadPosition=frag.start+frag.duration),this.state=State_FRAG_LOADING;const dataOnProgress=this.config.progressive;let result;return result=dataOnProgress&&keyLoadingPromise?keyLoadingPromise.then((keyLoadedData=>!keyLoadedData||this.fragContextChanged(null==keyLoadedData?void 0:keyLoadedData.frag)?null:this.fragmentLoader.load(frag,progressCallback))).catch((error=>this.handleFragLoadError(error))):Promise.all([this.fragmentLoader.load(frag,dataOnProgress?progressCallback:void 0),keyLoadingPromise]).then((([fragLoadedData])=>(!dataOnProgress&&fragLoadedData&&progressCallback&&progressCallback(fragLoadedData),fragLoadedData))).catch((error=>this.handleFragLoadError(error))),this.hls.trigger(Events.FRAG_LOADING,{frag,targetBufferTime}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):result}doFragPartsLoad(frag,fromPart,level,progressCallback){return new Promise(((resolve,reject)=>{var _level$details;const partsLoaded=[],initialPartList=null==(_level$details=level.details)?void 0:_level$details.partList,loadPart=part=>{this.fragmentLoader.loadPart(frag,part,progressCallback).then((partLoadedData=>{partsLoaded[part.index]=partLoadedData;const loadedPart=partLoadedData.part;this.hls.trigger(Events.FRAG_LOADED,partLoadedData);const nextPart=getPartWith(level,frag.sn,part.index+1)||findPart(initialPartList,frag.sn,part.index+1);if(!nextPart)return resolve({frag,part:loadedPart,partsLoaded});loadPart(nextPart)})).catch(reject)};loadPart(fromPart)}))}handleFragLoadError(error){if("data"in error){const data=error.data;error.data&&data.details===ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(data.frag,data.part):this.hls.trigger(Events.ERROR,data)}else this.hls.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.INTERNAL_EXCEPTION,err:error,error,fatal:!0});return null}_handleTransmuxerFlush(chunkMeta){const context=this.getCurrentContext(chunkMeta);if(!context||this.state!==State_PARSING)return void(this.fragCurrent||this.state===State_STOPPED||this.state===State_ERROR||(this.state=State_IDLE));const{frag,part,level}=context,now=self.performance.now();frag.stats.parsing.end=now,part&&(part.stats.parsing.end=now),this.updateLevelTiming(frag,part,level,chunkMeta.partial)}getCurrentContext(chunkMeta){const{levels,fragCurrent}=this,{level:levelIndex,sn,part:partIndex}=chunkMeta;if(null==levels||!levels[levelIndex])return this.warn(`Levels object was unset while buffering fragment ${sn} of level ${levelIndex}. The current chunk will not be buffered.`),null;const level=levels[levelIndex],part=partIndex>-1?getPartWith(level,sn,partIndex):null,frag=part?part.fragment:function getFragmentWithSN(level,sn,fragCurrent){if(null==level||!level.details)return null;const levelDetails=level.details;let fragment=levelDetails.fragments[sn-levelDetails.startSN];return fragment||(fragment=levelDetails.fragmentHint,fragment&&fragment.sn===sn?fragment:sn<levelDetails.startSN&&fragCurrent&&fragCurrent.sn===sn?fragCurrent:null)}(level,sn,fragCurrent);return frag?(fragCurrent&&fragCurrent!==frag&&(frag.stats=fragCurrent.stats),{frag,part,level}):null}bufferFragmentData(data,frag,part,chunkMeta,noBacktracking){var _buffer;if(!data||this.state!==State_PARSING)return;const{data1,data2}=data;let buffer=data1;if(data1&&data2&&(buffer=appendUint8Array(data1,data2)),null==(_buffer=buffer)||!_buffer.length)return;const segment={type:data.type,frag,part,chunkMeta,parent:frag.type,data:buffer};if(this.hls.trigger(Events.BUFFER_APPENDING,segment),data.dropped&&data.independent&&!part){if(noBacktracking)return;this.flushBufferGap(frag)}}flushBufferGap(frag){const media=this.media;if(!media)return;if(!BufferHelper.isBuffered(media,media.currentTime))return void this.flushMainBuffer(0,frag.start);const currentTime=media.currentTime,bufferInfo=BufferHelper.bufferInfo(media,currentTime,0),fragDuration=frag.duration,segmentFraction=Math.min(2*this.config.maxFragLookUpTolerance,.25*fragDuration),start=Math.max(Math.min(frag.start-segmentFraction,bufferInfo.end-segmentFraction),currentTime+segmentFraction);frag.start-start>segmentFraction&&this.flushMainBuffer(start,frag.start)}getFwdBufferInfo(bufferable,type){const pos=this.getLoadPosition();return isFiniteNumber(pos)?this.getFwdBufferInfoAtPos(bufferable,pos,type):null}getFwdBufferInfoAtPos(bufferable,pos,type){const{config:{maxBufferHole}}=this,bufferInfo=BufferHelper.bufferInfo(bufferable,pos,maxBufferHole);if(0===bufferInfo.len&&void 0!==bufferInfo.nextStart){const bufferedFragAtPos=this.fragmentTracker.getBufferedFrag(pos,type);if(bufferedFragAtPos&&bufferInfo.nextStart<bufferedFragAtPos.end)return BufferHelper.bufferInfo(bufferable,pos,Math.max(bufferInfo.nextStart,maxBufferHole))}return bufferInfo}getMaxBufferLength(levelBitrate){const{config}=this;let maxBufLen;return maxBufLen=levelBitrate?Math.max(8*config.maxBufferSize/levelBitrate,config.maxBufferLength):config.maxBufferLength,Math.min(maxBufLen,config.maxMaxBufferLength)}reduceMaxBufferLength(threshold){const config=this.config,minLength=threshold||config.maxBufferLength;return config.maxMaxBufferLength>=minLength&&(config.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${config.maxMaxBufferLength}s`),!0)}getAppendedFrag(position,playlistType=PlaylistLevelType_MAIN){const fragOrPart=this.fragmentTracker.getAppendedFrag(position,PlaylistLevelType_MAIN);return fragOrPart&&"fragment"in fragOrPart?fragOrPart.fragment:fragOrPart}getNextFragment(pos,levelDetails){const fragments=levelDetails.fragments,fragLen=fragments.length;if(!fragLen)return null;const{config}=this,start=fragments[0].start;let frag;if(levelDetails.live){const initialLiveManifestSize=config.initialLiveManifestSize;if(fragLen<initialLiveManifestSize)return this.warn(`Not enough fragments to start playback (have: ${fragLen}, need: ${initialLiveManifestSize})`),null;(!levelDetails.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||pos<start)&&(frag=this.getInitialLiveFragment(levelDetails,fragments),this.startPosition=this.nextLoadPosition=frag?this.hls.liveSyncPosition||frag.start:pos)}else pos<=start&&(frag=fragments[0]);if(!frag){const end=config.lowLatencyMode?levelDetails.partEnd:levelDetails.fragmentEnd;frag=this.getFragmentAtPosition(pos,end,levelDetails)}return this.mapToInitFragWhenRequired(frag)}isLoopLoading(frag,targetBufferTime){const trackerState=this.fragmentTracker.getState(frag);return(trackerState===FragmentState_OK||trackerState===FragmentState_PARTIAL&&!!frag.gap)&&this.nextLoadPosition>targetBufferTime}getNextFragmentLoopLoading(frag,levelDetails,bufferInfo,playlistType,maxBufLen){const gapStart=frag.gap,nextFragment=this.getNextFragment(this.nextLoadPosition,levelDetails);if(null===nextFragment)return nextFragment;if(frag=nextFragment,gapStart&&frag&&!frag.gap&&bufferInfo.nextStart){const nextbufferInfo=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,bufferInfo.nextStart,playlistType);if(null!==nextbufferInfo&&bufferInfo.len+nextbufferInfo.len>=maxBufLen)return this.log(`buffer full after gaps in "${playlistType}" playlist starting at sn: ${frag.sn}`),null}return frag}mapToInitFragWhenRequired(frag){return null==frag||!frag.initSegment||null!=frag&&frag.initSegment.data||this.bitrateTest?frag:frag.initSegment}getNextPart(partList,frag,targetBufferTime){let nextPart=-1,contiguous=!1,independentAttrOmitted=!0;for(let i=0,len=partList.length;i<len;i++){const part=partList[i];if(independentAttrOmitted=independentAttrOmitted&&!part.independent,nextPart>-1&&targetBufferTime<part.start)break;const loaded=part.loaded;loaded?nextPart=-1:(contiguous||part.independent||independentAttrOmitted)&&part.fragment===frag&&(nextPart=i),contiguous=loaded}return nextPart}loadedEndOfParts(partList,targetBufferTime){const lastPart=partList[partList.length-1];return lastPart&&targetBufferTime>lastPart.start&&lastPart.loaded}getInitialLiveFragment(levelDetails,fragments){const fragPrevious=this.fragPrevious;let frag=null;if(fragPrevious){if(levelDetails.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${fragPrevious.programDateTime}`),frag=function findFragmentByPDT(fragments,PDTValue,maxFragLookUpTolerance){if(null===PDTValue||!Array.isArray(fragments)||!fragments.length||!isFiniteNumber(PDTValue))return null;if(PDTValue<(fragments[0].programDateTime||0))return null;if(PDTValue>=(fragments[fragments.length-1].endProgramDateTime||0))return null;maxFragLookUpTolerance=maxFragLookUpTolerance||0;for(let seg=0;seg<fragments.length;++seg){const frag=fragments[seg];if(pdtWithinToleranceTest(PDTValue,maxFragLookUpTolerance,frag))return frag}return null}(fragments,fragPrevious.endProgramDateTime,this.config.maxFragLookUpTolerance)),!frag){const targetSN=fragPrevious.sn+1;if(targetSN>=levelDetails.startSN&&targetSN<=levelDetails.endSN){const fragNext=fragments[targetSN-levelDetails.startSN];fragPrevious.cc===fragNext.cc&&(frag=fragNext,this.log(`Live playlist, switching playlist, load frag with next SN: ${frag.sn}`))}frag||(frag=function findFragWithCC(fragments,cc){return BinarySearch_search(fragments,(candidate=>candidate.cc<cc?1:candidate.cc>cc?-1:0))}(fragments,fragPrevious.cc),frag&&this.log(`Live playlist, switching playlist, load frag with same CC: ${frag.sn}`))}}else{const liveStart=this.hls.liveSyncPosition;null!==liveStart&&(frag=this.getFragmentAtPosition(liveStart,this.bitrateTest?levelDetails.fragmentEnd:levelDetails.edge,levelDetails))}return frag}getFragmentAtPosition(bufferEnd,end,levelDetails){const{config}=this;let{fragPrevious}=this,{fragments,endSN}=levelDetails;const{fragmentHint}=levelDetails,tolerance=config.maxFragLookUpTolerance,partList=levelDetails.partList,loadingParts=!!(config.lowLatencyMode&&null!=partList&&partList.length&&fragmentHint);let frag;if(loadingParts&&fragmentHint&&!this.bitrateTest&&(fragments=fragments.concat(fragmentHint),endSN=fragmentHint.sn),bufferEnd<end){frag=findFragmentByPTS(fragPrevious,fragments,bufferEnd,bufferEnd>end-tolerance?0:tolerance)}else frag=fragments[fragments.length-1];if(frag){const curSNIdx=frag.sn-levelDetails.startSN,fragState=this.fragmentTracker.getState(frag);if((fragState===FragmentState_OK||fragState===FragmentState_PARTIAL&&frag.gap)&&(fragPrevious=frag),fragPrevious&&frag.sn===fragPrevious.sn&&(!loadingParts||partList[0].fragment.sn>frag.sn)){if(fragPrevious&&frag.level===fragPrevious.level){const nextFrag=fragments[curSNIdx+1];frag=frag.sn<endSN&&this.fragmentTracker.getState(nextFrag)!==FragmentState_OK?nextFrag:null}}}return frag}synchronizeToLiveEdge(levelDetails){const{config,media}=this;if(!media)return;const liveSyncPosition=this.hls.liveSyncPosition,currentTime=media.currentTime,start=levelDetails.fragments[0].start,end=levelDetails.edge,withinSlidingWindow=currentTime>=start-config.maxFragLookUpTolerance&&currentTime<=end;if(null!==liveSyncPosition&&media.duration>liveSyncPosition&&(currentTime<liveSyncPosition||!withinSlidingWindow)){const maxLatency=void 0!==config.liveMaxLatencyDuration?config.liveMaxLatencyDuration:config.liveMaxLatencyDurationCount*levelDetails.targetduration;(!withinSlidingWindow&&media.readyState<4||currentTime<end-maxLatency)&&(this.loadedmetadata||(this.nextLoadPosition=liveSyncPosition),media.readyState&&(this.warn(`Playback: ${currentTime.toFixed(3)} is located too far from the end of live sliding playlist: ${end}, reset currentTime to : ${liveSyncPosition.toFixed(3)}`),media.currentTime=liveSyncPosition))}}alignPlaylists(details,previousDetails,switchDetails){const length=details.fragments.length;if(!length)return this.warn("No fragments in live playlist"),0;const slidingStart=details.fragments[0].start,firstLevelLoad=!previousDetails,aligned=details.alignedSliding&&isFiniteNumber(slidingStart);if(firstLevelLoad||!aligned&&!slidingStart){const{fragPrevious}=this;alignStream(fragPrevious,switchDetails,details);const alignedSlidingStart=details.fragments[0].start;return this.log(`Live playlist sliding: ${alignedSlidingStart.toFixed(2)} start-sn: ${previousDetails?previousDetails.startSN:"na"}->${details.startSN} prev-sn: ${fragPrevious?fragPrevious.sn:"na"} fragments: ${length}`),alignedSlidingStart}return slidingStart}waitForCdnTuneIn(details){return details.live&&details.canBlockReload&&details.partTarget&&details.tuneInGoal>Math.max(details.partHoldBack,3*details.partTarget)}setStartPosition(details,sliding){let startPosition=this.startPosition;if(startPosition<sliding&&(startPosition=-1),-1===startPosition||-1===this.lastCurrentTime){const offsetInMultivariantPlaylist=null!==this.startTimeOffset,startTimeOffset=offsetInMultivariantPlaylist?this.startTimeOffset:details.startTimeOffset;null!==startTimeOffset&&isFiniteNumber(startTimeOffset)?(startPosition=sliding+startTimeOffset,startTimeOffset<0&&(startPosition+=details.totalduration),startPosition=Math.min(Math.max(sliding,startPosition),sliding+details.totalduration),this.log(`Start time offset ${startTimeOffset} found in ${offsetInMultivariantPlaylist?"multivariant":"media"} playlist, adjust startPosition to ${startPosition}`),this.startPosition=startPosition):details.live?startPosition=this.hls.liveSyncPosition||sliding:this.startPosition=startPosition=0,this.lastCurrentTime=startPosition}this.nextLoadPosition=startPosition}getLoadPosition(){const{media}=this;let pos=0;return this.loadedmetadata&&media?pos=media.currentTime:this.nextLoadPosition&&(pos=this.nextLoadPosition),pos}handleFragLoadAborted(frag,part){this.transmuxer&&"initSegment"!==frag.sn&&frag.stats.aborted&&(this.warn(`Fragment ${frag.sn}${part?" part "+part.index:""} of level ${frag.level} was aborted`),this.resetFragmentLoading(frag))}resetFragmentLoading(frag){this.fragCurrent&&(this.fragContextChanged(frag)||this.state===State_FRAG_LOADING_WAITING_RETRY)||(this.state=State_IDLE)}onFragmentOrKeyLoadError(filterType,data){if(data.chunkMeta&&!data.frag){const context=this.getCurrentContext(data.chunkMeta);context&&(data.frag=context.frag)}const frag=data.frag;if(!frag||frag.type!==filterType||!this.levels)return;var _this$fragCurrent2;if(this.fragContextChanged(frag))return void this.warn(`Frag load error must match current frag to retry ${frag.url} > ${null==(_this$fragCurrent2=this.fragCurrent)?void 0:_this$fragCurrent2.url}`);const gapTagEncountered=data.details===ErrorDetails.FRAG_GAP;gapTagEncountered&&this.fragmentTracker.fragBuffered(frag,!0);const errorAction=data.errorAction,{action,retryCount=0,retryConfig}=errorAction||{};if(errorAction&&action===NetworkErrorAction_RetryRequest&&retryConfig){this.resetStartWhenNotLoaded(this.levelLastLoaded);const delay=getRetryDelay(retryConfig,retryCount);this.warn(`Fragment ${frag.sn} of ${filterType} ${frag.level} errored with ${data.details}, retrying loading ${retryCount+1}/${retryConfig.maxNumRetry} in ${delay}ms`),errorAction.resolved=!0,this.retryDate=self.performance.now()+delay,this.state=State_FRAG_LOADING_WAITING_RETRY}else if(retryConfig&&errorAction){if(this.resetFragmentErrors(filterType),!(retryCount<retryConfig.maxNumRetry))return void logger.warn(`${data.details} reached or exceeded max retry (${retryCount})`);gapTagEncountered||action===NetworkErrorAction_RemoveAlternatePermanently||(errorAction.resolved=!0)}else(null==errorAction?void 0:errorAction.action)===NetworkErrorAction_SendAlternateToPenaltyBox?this.state=State_WAITING_LEVEL:this.state=State_ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(data){if(this.state===State_PARSING||this.state===State_PARSED){const playlistType=data.parent,bufferedInfo=this.getFwdBufferInfo(this.mediaBuffer,playlistType),buffered=bufferedInfo&&bufferedInfo.len>.5;buffered&&this.reduceMaxBufferLength(bufferedInfo.len);const flushBuffer=!buffered;return flushBuffer&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${playlistType} buffer`),data.frag&&(this.fragmentTracker.removeFragment(data.frag),this.nextLoadPosition=data.frag.start),this.resetLoadingState(),flushBuffer}return!1}resetFragmentErrors(filterType){filterType===PlaylistLevelType_AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==State_STOPPED&&(this.state=State_IDLE)}afterBufferFlushed(media,bufferType,playlistType){if(!media)return;const bufferedTimeRanges=BufferHelper.getBuffered(media);this.fragmentTracker.detectEvictedFragments(bufferType,bufferedTimeRanges,playlistType),this.state===State_ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=State_IDLE}resetStartWhenNotLoaded(level){if(!this.loadedmetadata){this.startFragRequested=!1;const details=level?level.details:null;null!=details&&details.live?(this.startPosition=-1,this.setStartPosition(details,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(chunkMeta){this.warn(`The loading context changed while buffering fragment ${chunkMeta.sn} of level ${chunkMeta.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(start=0){this.fragmentTracker.removeFragmentsInRange(start,1/0,this.playlistType,!1,!0)}updateLevelTiming(frag,part,level,partial){var _this$transmuxer;const details=level.details;if(!details)return void this.warn("level.details undefined");if(!Object.keys(frag.elementaryStreams).reduce(((result,type)=>{const info=frag.elementaryStreams[type];if(info){const parsedDuration=info.endPTS-info.startPTS;if(parsedDuration<=0)return this.warn(`Could not parse fragment ${frag.sn} ${type} duration reliably (${parsedDuration})`),result||!1;const drift=partial?0:updateFragPTSDTS(details,frag,info.startPTS,info.endPTS,info.startDTS,info.endDTS);return this.hls.trigger(Events.LEVEL_PTS_UPDATED,{details,level,drift,type,frag,start:info.startPTS,end:info.endPTS}),!0}return result}),!1)&&null===(null==(_this$transmuxer=this.transmuxer)?void 0:_this$transmuxer.error)){const error=new Error(`Found no media in fragment ${frag.sn} of level ${frag.level} resetting transmuxer to fallback to playlist timing`);if(0===level.fragmentError&&(level.fragmentError++,frag.gap=!0,this.fragmentTracker.removeFragment(frag),this.fragmentTracker.fragBuffered(frag,!0)),this.warn(error.message),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,error,frag,reason:`Found no media in msn ${frag.sn} of level "${level.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=State_PARSED,this.hls.trigger(Events.FRAG_PARSED,{frag,part})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(data){"demuxerWorker"===data.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(nextState){const previousState=this._state;previousState!==nextState&&(this._state=nextState,this.log(`${previousState}->${nextState}`))}get state(){return this._state}}class ChunkCache{constructor(){this.chunks=[],this.dataLength=0}push(chunk){this.chunks.push(chunk),this.dataLength+=chunk.length}flush(){const{chunks,dataLength}=this;let result;return chunks.length?(result=1===chunks.length?chunks[0]:function concatUint8Arrays(chunks,dataLength){const result=new Uint8Array(dataLength);let offset=0;for(let i=0;i<chunks.length;i++){const chunk=chunks[i];result.set(chunk,offset),offset+=chunk.length}return result}(chunks,dataLength),this.reset(),result):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function dummyTrack(type="",inputTimeScale=9e4){return{type,id:-1,pid:-1,inputTimeScale,sequenceNumber:-1,samples:[],dropped:0}}class BaseAudioDemuxer{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(deaultTimestamp){this.initPTS=deaultTimestamp,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(data,offset){return!1}appendFrame(track,data,offset){}demux(data,timeOffset){this.cachedData&&(data=appendUint8Array(this.cachedData,data),this.cachedData=null);let lastDataIndex,id3Data=getID3Data(data,0),offset=id3Data?id3Data.length:0;const track=this._audioTrack,id3Track=this._id3Track,timestamp=id3Data?getTimeStamp(id3Data):void 0,length=data.length;for((null===this.basePTS||0===this.frameIndex&&isFiniteNumber(timestamp))&&(this.basePTS=initPTSFn(timestamp,timeOffset,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),id3Data&&id3Data.length>0&&id3Track.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:id3Data,type:MetadataSchema_audioId3,duration:Number.POSITIVE_INFINITY});offset<length;){if(this.canParse(data,offset)){const frame=this.appendFrame(track,data,offset);frame?(this.frameIndex++,this.lastPTS=frame.sample.pts,offset+=frame.length,lastDataIndex=offset):offset=length}else canParse$2(data,offset)?(id3Data=getID3Data(data,offset),id3Track.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:id3Data,type:MetadataSchema_audioId3,duration:Number.POSITIVE_INFINITY}),offset+=id3Data.length,lastDataIndex=offset):offset++;if(offset===length&&lastDataIndex!==length){const partialData=sliceUint8(data,lastDataIndex);this.cachedData?this.cachedData=appendUint8Array(this.cachedData,partialData):this.cachedData=partialData}}return{audioTrack:track,videoTrack:dummyTrack(),id3Track,textTrack:dummyTrack()}}demuxSampleAes(data,keyData,timeOffset){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(timeOffset){const cachedData=this.cachedData;return cachedData&&(this.cachedData=null,this.demux(cachedData,0)),{audioTrack:this._audioTrack,videoTrack:dummyTrack(),id3Track:this._id3Track,textTrack:dummyTrack()}}destroy(){}}const initPTSFn=(timestamp,timeOffset,initPTS)=>{if(isFiniteNumber(timestamp))return 90*timestamp;return 9e4*timeOffset+(initPTS?9e4*initPTS.baseTime/initPTS.timescale:0)};function isHeaderPattern$1(data,offset){return 255===data[offset]&&240==(246&data[offset+1])}function getHeaderLength(data,offset){return 1&data[offset+1]?7:9}function getFullFrameLength(data,offset){return(3&data[offset+3])<<11|data[offset+4]<<3|(224&data[offset+5])>>>5}function isHeader$1(data,offset){return offset+1<data.length&&isHeaderPattern$1(data,offset)}function probe$1(data,offset){if(isHeader$1(data,offset)){const headerLength=getHeaderLength(data,offset);if(offset+headerLength>=data.length)return!1;const frameLength=getFullFrameLength(data,offset);if(frameLength<=headerLength)return!1;const newOffset=offset+frameLength;return newOffset===data.length||isHeader$1(data,newOffset)}return!1}function initTrackConfig(track,observer,data,offset,audioCodec){if(!track.samplerate){const config=function getAudioConfig(observer,data,offset,audioCodec){let adtsObjectType,adtsExtensionSamplingIndex,adtsChannelConfig,config;const userAgent=navigator.userAgent.toLowerCase(),manifestCodec=audioCodec,adtsSamplingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];adtsObjectType=1+((192&data[offset+2])>>>6);const adtsSamplingIndex=(60&data[offset+2])>>>2;if(!(adtsSamplingIndex>adtsSamplingRates.length-1))return adtsChannelConfig=(1&data[offset+2])<<2,adtsChannelConfig|=(192&data[offset+3])>>>6,logger.log(`manifest codec:${audioCodec}, ADTS type:${adtsObjectType}, samplingIndex:${adtsSamplingIndex}`),/firefox/i.test(userAgent)?adtsSamplingIndex>=6?(adtsObjectType=5,config=new Array(4),adtsExtensionSamplingIndex=adtsSamplingIndex-3):(adtsObjectType=2,config=new Array(2),adtsExtensionSamplingIndex=adtsSamplingIndex):-1!==userAgent.indexOf("android")?(adtsObjectType=2,config=new Array(2),adtsExtensionSamplingIndex=adtsSamplingIndex):(adtsObjectType=5,config=new Array(4),audioCodec&&(-1!==audioCodec.indexOf("mp4a.40.29")||-1!==audioCodec.indexOf("mp4a.40.5"))||!audioCodec&&adtsSamplingIndex>=6?adtsExtensionSamplingIndex=adtsSamplingIndex-3:((audioCodec&&-1!==audioCodec.indexOf("mp4a.40.2")&&(adtsSamplingIndex>=6&&1===adtsChannelConfig||/vivaldi/i.test(userAgent))||!audioCodec&&1===adtsChannelConfig)&&(adtsObjectType=2,config=new Array(2)),adtsExtensionSamplingIndex=adtsSamplingIndex)),config[0]=adtsObjectType<<3,config[0]|=(14&adtsSamplingIndex)>>1,config[1]|=(1&adtsSamplingIndex)<<7,config[1]|=adtsChannelConfig<<3,5===adtsObjectType&&(config[1]|=(14&adtsExtensionSamplingIndex)>>1,config[2]=(1&adtsExtensionSamplingIndex)<<7,config[2]|=8,config[3]=0),{config,samplerate:adtsSamplingRates[adtsSamplingIndex],channelCount:adtsChannelConfig,codec:"mp4a.40."+adtsObjectType,manifestCodec};{const error=new Error(`invalid ADTS sampling index:${adtsSamplingIndex}`);observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,error,reason:error.message})}}(observer,data,offset,audioCodec);if(!config)return;track.config=config.config,track.samplerate=config.samplerate,track.channelCount=config.channelCount,track.codec=config.codec,track.manifestCodec=config.manifestCodec,logger.log(`parsed codec:${track.codec}, rate:${config.samplerate}, channels:${config.channelCount}`)}}function getFrameDuration(samplerate){return 9216e4/samplerate}function appendFrame$2(track,data,offset,pts,frameIndex){const stamp=pts+frameIndex*getFrameDuration(track.samplerate),header=function parseFrameHeader(data,offset){const headerLength=getHeaderLength(data,offset);if(offset+headerLength<=data.length){const frameLength=getFullFrameLength(data,offset)-headerLength;if(frameLength>0)return{headerLength,frameLength}}}(data,offset);let unit;if(header){const{frameLength,headerLength}=header,_length=headerLength+frameLength,missing=Math.max(0,offset+_length-data.length);missing?(unit=new Uint8Array(_length-headerLength),unit.set(data.subarray(offset+headerLength,data.length),0)):unit=data.subarray(offset+headerLength,offset+_length);const _sample={unit,pts:stamp};return missing||track.samples.push(_sample),{sample:_sample,length:_length,missing}}const length=data.length-offset;unit=new Uint8Array(length),unit.set(data.subarray(offset,data.length),0);return{sample:{unit,pts:stamp},length,missing:-1}}let chromeVersion$1=null;const BitratesMap=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot=[0,1,1,4];function appendFrame$1(track,data,offset,pts,frameIndex){if(offset+24>data.length)return;const header=parseHeader(data,offset);if(header&&offset+header.frameLength<=data.length){const stamp=pts+frameIndex*(9e4*header.samplesPerFrame/header.sampleRate),sample={unit:data.subarray(offset,offset+header.frameLength),pts:stamp,dts:stamp};return track.config=[],track.channelCount=header.channelCount,track.samplerate=header.sampleRate,track.samples.push(sample),{sample,length:header.frameLength,missing:0}}}function parseHeader(data,offset){const mpegVersion=data[offset+1]>>3&3,mpegLayer=data[offset+1]>>1&3,bitRateIndex=data[offset+2]>>4&15,sampleRateIndex=data[offset+2]>>2&3;if(1!==mpegVersion&&0!==bitRateIndex&&15!==bitRateIndex&&3!==sampleRateIndex){const paddingBit=data[offset+2]>>1&1,channelMode=data[offset+3]>>6,bitRate=1e3*BitratesMap[14*(3===mpegVersion?3-mpegLayer:3===mpegLayer?3:4)+bitRateIndex-1],sampleRate=SamplingRateMap[3*(3===mpegVersion?0:2===mpegVersion?1:2)+sampleRateIndex],channelCount=3===channelMode?1:2,sampleCoefficient=SamplesCoefficients[mpegVersion][mpegLayer],bytesInSlot=BytesInSlot[mpegLayer],samplesPerFrame=8*sampleCoefficient*bytesInSlot,frameLength=Math.floor(sampleCoefficient*bitRate/sampleRate+paddingBit)*bytesInSlot;if(null===chromeVersion$1){const result=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);chromeVersion$1=result?parseInt(result[1]):0}return!!chromeVersion$1&&chromeVersion$1<=87&&2===mpegLayer&&bitRate>=224e3&&0===channelMode&&(data[offset+3]=128|data[offset+3]),{sampleRate,channelCount,frameLength,samplesPerFrame}}}function isHeaderPattern(data,offset){return 255===data[offset]&&224==(224&data[offset+1])&&0!=(6&data[offset+1])}function isHeader(data,offset){return offset+1<data.length&&isHeaderPattern(data,offset)}function probe(data,offset){if(offset+1<data.length&&isHeaderPattern(data,offset)){const headerLength=4,header=parseHeader(data,offset);let frameLength=headerLength;null!=header&&header.frameLength&&(frameLength=header.frameLength);const newOffset=offset+frameLength;return newOffset===data.length||isHeader(data,newOffset)}return!1}const emsgSchemePattern=/\/emsg[-/]ID3/i;const getAudioBSID=(data,offset)=>{let bsid=0,numBits=5;offset+=numBits;const temp=new Uint32Array(1),mask=new Uint32Array(1),byte=new Uint8Array(1);for(;numBits>0;){byte[0]=data[offset];const bits=Math.min(numBits,8),shift=8-bits;mask[0]=4278190080>>>24+shift<<shift,temp[0]=(byte[0]&mask[0])>>shift,bsid=bsid?bsid<<bits|temp[0]:temp[0],offset+=1,numBits-=bits}return bsid};class AC3Demuxer extends BaseAudioDemuxer{constructor(observer){super(),this.observer=void 0,this.observer=observer}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){super.resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:audioCodec,duration:trackDuration,inputTimeScale:9e4,dropped:0}}canParse(data,offset){return offset+64<data.length}appendFrame(track,data,offset){const frameLength=appendFrame(track,data,offset,this.basePTS,this.frameIndex);if(-1!==frameLength){return{sample:track.samples[track.samples.length-1],length:frameLength,missing:0}}}static probe(data){if(!data)return!1;const id3Data=getID3Data(data,0);if(!id3Data)return!1;const offset=id3Data.length;return 11===data[offset]&&119===data[offset+1]&&void 0!==getTimeStamp(id3Data)&&getAudioBSID(data,offset)<16}}function appendFrame(track,data,start,pts,frameIndex){if(start+8>data.length)return-1;if(11!==data[start]||119!==data[start+1])return-1;const samplingRateCode=data[start+4]>>6;if(samplingRateCode>=3)return-1;const sampleRate=[48e3,44100,32e3][samplingRateCode],frameSizeCode=63&data[start+4],frameLength=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*frameSizeCode+samplingRateCode];if(start+frameLength>data.length)return-1;const channelMode=data[start+6]>>5;let skipCount=0;2===channelMode?skipCount+=2:(1&channelMode&&1!==channelMode&&(skipCount+=2),4&channelMode&&(skipCount+=2));const lfeon=(data[start+6]<<8|data[start+7])>>12-skipCount&1,channelCount=[2,1,2,3,3,4,4,5][channelMode]+lfeon,bsid=data[start+5]>>3,bsmod=7&data[start+5],config=new Uint8Array([samplingRateCode<<6|bsid<<1|bsmod>>2,(3&bsmod)<<6|channelMode<<3|lfeon<<2|frameSizeCode>>4,frameSizeCode<<4&224]),stamp=pts+frameIndex*(1536/sampleRate*9e4),unit=data.subarray(start,start+frameLength);return track.config=config,track.channelCount=channelCount,track.samplerate=sampleRate,track.samples.push({unit,pts:stamp}),frameLength}class BaseVideoParser{constructor(){this.VideoSample=null}createVideoSample(key,pts,dts,debug){return{key,frame:!1,pts,dts,units:[],debug,length:0}}getLastNalUnit(samples){var _VideoSample;let lastUnit,VideoSample=this.VideoSample;if(VideoSample&&0!==VideoSample.units.length||(VideoSample=samples[samples.length-1]),null!=(_VideoSample=VideoSample)&&_VideoSample.units){const units=VideoSample.units;lastUnit=units[units.length-1]}return lastUnit}pushAccessUnit(VideoSample,videoTrack){if(VideoSample.units.length&&VideoSample.frame){if(void 0===VideoSample.pts){const samples=videoTrack.samples,nbSamples=samples.length;if(!nbSamples)return void videoTrack.dropped++;{const lastSample=samples[nbSamples-1];VideoSample.pts=lastSample.pts,VideoSample.dts=lastSample.dts}}videoTrack.samples.push(VideoSample)}VideoSample.debug.length&&logger.log(VideoSample.pts+"/"+VideoSample.dts+":"+VideoSample.debug)}}class ExpGolomb{constructor(data){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=data,this.bytesAvailable=data.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const data=this.data,bytesAvailable=this.bytesAvailable,position=data.byteLength-bytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,bytesAvailable);if(0===availableBytes)throw new Error("no bytes available");workingBytes.set(data.subarray(position,position+availableBytes)),this.word=new DataView(workingBytes.buffer).getUint32(0),this.bitsAvailable=8*availableBytes,this.bytesAvailable-=availableBytes}skipBits(count){let skipBytes;count=Math.min(count,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>count?(this.word<<=count,this.bitsAvailable-=count):(skipBytes=(count-=this.bitsAvailable)>>3,count-=skipBytes<<3,this.bytesAvailable-=skipBytes,this.loadWord(),this.word<<=count,this.bitsAvailable-=count)}readBits(size){let bits=Math.min(this.bitsAvailable,size);const valu=this.word>>>32-bits;if(size>32&&logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=bits,this.bitsAvailable>0)this.word<<=bits;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return bits=size-bits,bits>0&&this.bitsAvailable?valu<<bits|this.readBits(bits):valu}skipLZ(){let leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<this.bitsAvailable;++leadingZeroCount)if(0!=(this.word&2147483648>>>leadingZeroCount))return this.word<<=leadingZeroCount,this.bitsAvailable-=leadingZeroCount,leadingZeroCount;return this.loadWord(),leadingZeroCount+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const clz=this.skipLZ();return this.readBits(clz+1)-1}readEG(){const valu=this.readUEG();return 1&valu?1+valu>>>1:-1*(valu>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(count){let deltaScale,lastScale=8,nextScale=8;for(let j=0;j<count;j++)0!==nextScale&&(deltaScale=this.readEG(),nextScale=(lastScale+deltaScale+256)%256),lastScale=0===nextScale?lastScale:nextScale}readSPS(){let numRefFramesInPicOrderCntCycle,scalingListCount,i,frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0;const readUByte=this.readUByte.bind(this),readBits=this.readBits.bind(this),readUEG=this.readUEG.bind(this),readBoolean=this.readBoolean.bind(this),skipBits=this.skipBits.bind(this),skipEG=this.skipEG.bind(this),skipUEG=this.skipUEG.bind(this),skipScalingList=this.skipScalingList.bind(this);readUByte();const profileIdc=readUByte();if(readBits(5),skipBits(3),readUByte(),skipUEG(),100===profileIdc||110===profileIdc||122===profileIdc||244===profileIdc||44===profileIdc||83===profileIdc||86===profileIdc||118===profileIdc||128===profileIdc){const chromaFormatIdc=readUEG();if(3===chromaFormatIdc&&skipBits(1),skipUEG(),skipUEG(),skipBits(1),readBoolean())for(scalingListCount=3!==chromaFormatIdc?8:12,i=0;i<scalingListCount;i++)readBoolean()&&skipScalingList(i<6?16:64)}skipUEG();const picOrderCntType=readUEG();if(0===picOrderCntType)readUEG();else if(1===picOrderCntType)for(skipBits(1),skipEG(),skipEG(),numRefFramesInPicOrderCntCycle=readUEG(),i=0;i<numRefFramesInPicOrderCntCycle;i++)skipEG();skipUEG(),skipBits(1);const picWidthInMbsMinus1=readUEG(),picHeightInMapUnitsMinus1=readUEG(),frameMbsOnlyFlag=readBits(1);0===frameMbsOnlyFlag&&skipBits(1),skipBits(1),readBoolean()&&(frameCropLeftOffset=readUEG(),frameCropRightOffset=readUEG(),frameCropTopOffset=readUEG(),frameCropBottomOffset=readUEG());let pixelRatio=[1,1];if(readBoolean()&&readBoolean()){switch(readUByte()){case 1:pixelRatio=[1,1];break;case 2:pixelRatio=[12,11];break;case 3:pixelRatio=[10,11];break;case 4:pixelRatio=[16,11];break;case 5:pixelRatio=[40,33];break;case 6:pixelRatio=[24,11];break;case 7:pixelRatio=[20,11];break;case 8:pixelRatio=[32,11];break;case 9:pixelRatio=[80,33];break;case 10:pixelRatio=[18,11];break;case 11:pixelRatio=[15,11];break;case 12:pixelRatio=[64,33];break;case 13:pixelRatio=[160,99];break;case 14:pixelRatio=[4,3];break;case 15:pixelRatio=[3,2];break;case 16:pixelRatio=[2,1];break;case 255:pixelRatio=[readUByte()<<8|readUByte(),readUByte()<<8|readUByte()]}}return{width:Math.ceil(16*(picWidthInMbsMinus1+1)-2*frameCropLeftOffset-2*frameCropRightOffset),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-(frameMbsOnlyFlag?2:4)*(frameCropTopOffset+frameCropBottomOffset),pixelRatio}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class AvcVideoParser extends BaseVideoParser{parseAVCPES(track,textTrack,pes,last,duration){const units=this.parseAVCNALu(track,pes.data);let push,VideoSample=this.VideoSample,spsfound=!1;pes.data=null,VideoSample&&units.length&&!track.audFound&&(this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=this.createVideoSample(!1,pes.pts,pes.dts,"")),units.forEach((unit=>{var _VideoSample2;switch(unit.type){case 1:{let iskey=!1;push=!0;const data=unit.data;if(spsfound&&data.length>4){const sliceType=new ExpGolomb(data).readSliceType();2!==sliceType&&4!==sliceType&&7!==sliceType&&9!==sliceType||(iskey=!0)}var _VideoSample;if(iskey)null!=(_VideoSample=VideoSample)&&_VideoSample.frame&&!VideoSample.key&&(this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=null);VideoSample||(VideoSample=this.VideoSample=this.createVideoSample(!0,pes.pts,pes.dts,"")),VideoSample.frame=!0,VideoSample.key=iskey;break}case 5:push=!0,null!=(_VideoSample2=VideoSample)&&_VideoSample2.frame&&!VideoSample.key&&(this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=null),VideoSample||(VideoSample=this.VideoSample=this.createVideoSample(!0,pes.pts,pes.dts,"")),VideoSample.key=!0,VideoSample.frame=!0;break;case 6:push=!0,parseSEIMessageFromNALu(unit.data,1,pes.pts,textTrack.samples);break;case 7:{var _track$pixelRatio,_track$pixelRatio2;push=!0,spsfound=!0;const sps=unit.data,config=new ExpGolomb(sps).readSPS();if(!track.sps||track.width!==config.width||track.height!==config.height||(null==(_track$pixelRatio=track.pixelRatio)?void 0:_track$pixelRatio[0])!==config.pixelRatio[0]||(null==(_track$pixelRatio2=track.pixelRatio)?void 0:_track$pixelRatio2[1])!==config.pixelRatio[1]){track.width=config.width,track.height=config.height,track.pixelRatio=config.pixelRatio,track.sps=[sps],track.duration=duration;const codecarray=sps.subarray(1,4);let codecstring="avc1.";for(let i=0;i<3;i++){let h=codecarray[i].toString(16);h.length<2&&(h="0"+h),codecstring+=h}track.codec=codecstring}break}case 8:push=!0,track.pps=[unit.data];break;case 9:push=!0,track.audFound=!0,VideoSample&&this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=this.createVideoSample(!1,pes.pts,pes.dts,"");break;case 12:push=!0;break;default:push=!1,VideoSample&&(VideoSample.debug+="unknown NAL "+unit.type+" ")}if(VideoSample&&push){VideoSample.units.push(unit)}})),last&&VideoSample&&(this.pushAccessUnit(VideoSample,track),this.VideoSample=null)}parseAVCNALu(track,array){const len=array.byteLength;let state=track.naluState||0;const lastState=state,units=[];let value,overflow,unitType,i=0,lastUnitStart=-1,lastUnitType=0;for(-1===state&&(lastUnitStart=0,lastUnitType=31&array[0],state=0,i=1);i<len;)if(value=array[i++],state)if(1!==state)if(value)if(1===value){if(overflow=i-state-1,lastUnitStart>=0){const unit={data:array.subarray(lastUnitStart,overflow),type:lastUnitType};units.push(unit)}else{const lastUnit=this.getLastNalUnit(track.samples);lastUnit&&(lastState&&i<=4-lastState&&lastUnit.state&&(lastUnit.data=lastUnit.data.subarray(0,lastUnit.data.byteLength-lastState)),overflow>0&&(lastUnit.data=appendUint8Array(lastUnit.data,array.subarray(0,overflow)),lastUnit.state=0))}i<len?(unitType=31&array[i],lastUnitStart=i,lastUnitType=unitType,state=0):state=-1}else state=0;else state=3;else state=value?0:2;else state=value?0:1;if(lastUnitStart>=0&&state>=0){const unit={data:array.subarray(lastUnitStart,len),type:lastUnitType,state};units.push(unit)}if(0===units.length){const lastUnit=this.getLastNalUnit(track.samples);lastUnit&&(lastUnit.data=appendUint8Array(lastUnit.data,array))}return track.naluState=state,units}}class SampleAesDecrypter{constructor(observer,config,keyData){this.keyData=void 0,this.decrypter=void 0,this.keyData=keyData,this.decrypter=new Decrypter(config,{removePKCS7Padding:!1})}decryptBuffer(encryptedData){return this.decrypter.decrypt(encryptedData,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(samples,sampleIndex,callback){const curUnit=samples[sampleIndex].unit;if(curUnit.length<=16)return;const encryptedData=curUnit.subarray(16,curUnit.length-curUnit.length%16),encryptedBuffer=encryptedData.buffer.slice(encryptedData.byteOffset,encryptedData.byteOffset+encryptedData.length);this.decryptBuffer(encryptedBuffer).then((decryptedBuffer=>{const decryptedData=new Uint8Array(decryptedBuffer);curUnit.set(decryptedData,16),this.decrypter.isSync()||this.decryptAacSamples(samples,sampleIndex+1,callback)}))}decryptAacSamples(samples,sampleIndex,callback){for(;;sampleIndex++){if(sampleIndex>=samples.length)return void callback();if(!(samples[sampleIndex].unit.length<32)&&(this.decryptAacSample(samples,sampleIndex,callback),!this.decrypter.isSync()))return}}getAvcEncryptedData(decodedData){const encryptedDataLen=16*Math.floor((decodedData.length-48)/160)+16,encryptedData=new Int8Array(encryptedDataLen);let outputPos=0;for(let inputPos=32;inputPos<decodedData.length-16;inputPos+=160,outputPos+=16)encryptedData.set(decodedData.subarray(inputPos,inputPos+16),outputPos);return encryptedData}getAvcDecryptedUnit(decodedData,decryptedData){const uint8DecryptedData=new Uint8Array(decryptedData);let inputPos=0;for(let outputPos=32;outputPos<decodedData.length-16;outputPos+=160,inputPos+=16)decodedData.set(uint8DecryptedData.subarray(inputPos,inputPos+16),outputPos);return decodedData}decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit){const decodedData=discardEPB(curUnit.data),encryptedData=this.getAvcEncryptedData(decodedData);this.decryptBuffer(encryptedData.buffer).then((decryptedBuffer=>{curUnit.data=this.getAvcDecryptedUnit(decodedData,decryptedBuffer),this.decrypter.isSync()||this.decryptAvcSamples(samples,sampleIndex,unitIndex+1,callback)}))}decryptAvcSamples(samples,sampleIndex,unitIndex,callback){if(samples instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;sampleIndex++,unitIndex=0){if(sampleIndex>=samples.length)return void callback();const curUnits=samples[sampleIndex].units;for(;!(unitIndex>=curUnits.length);unitIndex++){const curUnit=curUnits[unitIndex];if(!(curUnit.data.length<=48||1!==curUnit.type&&5!==curUnit.type||(this.decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit),this.decrypter.isSync())))return}}}}class TSDemuxer{constructor(observer,config,typeSupported){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=observer,this.config=config,this.typeSupported=typeSupported,this.videoParser=new AvcVideoParser}static probe(data){const syncOffset=TSDemuxer.syncOffset(data);return syncOffset>0&&logger.warn(`MPEG2-TS detected but first sync word found @ offset ${syncOffset}`),-1!==syncOffset}static syncOffset(data){const length=data.length;let scanwindow=Math.min(940,length-188)+1,i=0;for(;i<scanwindow;){let foundPat=!1,packetStart=-1,tsPackets=0;for(let j=i;j<length;j+=188){if(71!==data[j]||length-j!=188&&71!==data[j+188]){if(tsPackets)return-1;break}if(tsPackets++,-1===packetStart&&(packetStart=j,0!==packetStart&&(scanwindow=Math.min(packetStart+18612,data.length-188)+1)),foundPat||(foundPat=0===parsePID(data,j)),foundPat&&tsPackets>1&&(0===packetStart&&tsPackets>2||j+188>scanwindow))return packetStart}i++}return-1}static createTrack(type,duration){return{container:"video"===type||"audio"===type?"video/mp2t":void 0,type,id:RemuxerTrackIdConfig[type],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===type?duration:void 0}}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=TSDemuxer.createTrack("video"),this._audioTrack=TSDemuxer.createTrack("audio",trackDuration),this._id3Track=TSDemuxer.createTrack("id3"),this._txtTrack=TSDemuxer.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=audioCodec,this.videoCodec=videoCodec,this._duration=trackDuration}resetTimeStamp(){}resetContiguity(){const{_audioTrack,_videoTrack,_id3Track}=this;_audioTrack&&(_audioTrack.pesData=null),_videoTrack&&(_videoTrack.pesData=null),_id3Track&&(_id3Track.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(data,timeOffset,isSampleAes=!1,flush=!1){let pes;isSampleAes||(this.sampleAes=null);const videoTrack=this._videoTrack,audioTrack=this._audioTrack,id3Track=this._id3Track,textTrack=this._txtTrack;let videoPid=videoTrack.pid,videoData=videoTrack.pesData,audioPid=audioTrack.pid,id3Pid=id3Track.pid,audioData=audioTrack.pesData,id3Data=id3Track.pesData,unknownPID=null,pmtParsed=this.pmtParsed,pmtId=this._pmtId,len=data.length;if(this.remainderData&&(len=(data=appendUint8Array(this.remainderData,data)).length,this.remainderData=null),len<188&&!flush)return this.remainderData=data,{audioTrack,videoTrack,id3Track,textTrack};const syncOffset=Math.max(0,TSDemuxer.syncOffset(data));len-=(len-syncOffset)%188,len<data.byteLength&&!flush&&(this.remainderData=new Uint8Array(data.buffer,len,data.buffer.byteLength-len));let tsPacketErrors=0;for(let start=syncOffset;start<len;start+=188)if(71===data[start]){const stt=!!(64&data[start+1]),pid=parsePID(data,start);let offset;if((48&data[start+3])>>4>1){if(offset=start+5+data[start+4],offset===start+188)continue}else offset=start+4;switch(pid){case videoPid:stt&&(videoData&&(pes=parsePES(videoData))&&this.videoParser.parseAVCPES(videoTrack,textTrack,pes,!1,this._duration),videoData={data:[],size:0}),videoData&&(videoData.data.push(data.subarray(offset,start+188)),videoData.size+=start+188-offset);break;case audioPid:if(stt){if(audioData&&(pes=parsePES(audioData)))switch(audioTrack.segmentCodec){case"aac":this.parseAACPES(audioTrack,pes);break;case"mp3":this.parseMPEGPES(audioTrack,pes);break;case"ac3":this.parseAC3PES(audioTrack,pes)}audioData={data:[],size:0}}audioData&&(audioData.data.push(data.subarray(offset,start+188)),audioData.size+=start+188-offset);break;case id3Pid:stt&&(id3Data&&(pes=parsePES(id3Data))&&this.parseID3PES(id3Track,pes),id3Data={data:[],size:0}),id3Data&&(id3Data.data.push(data.subarray(offset,start+188)),id3Data.size+=start+188-offset);break;case 0:stt&&(offset+=data[offset]+1),pmtId=this._pmtId=parsePAT(data,offset);break;case pmtId:{stt&&(offset+=data[offset]+1);const parsedPIDs=parsePMT(data,offset,this.typeSupported,isSampleAes);videoPid=parsedPIDs.videoPid,videoPid>0&&(videoTrack.pid=videoPid,videoTrack.segmentCodec=parsedPIDs.segmentVideoCodec),audioPid=parsedPIDs.audioPid,audioPid>0&&(audioTrack.pid=audioPid,audioTrack.segmentCodec=parsedPIDs.segmentAudioCodec),id3Pid=parsedPIDs.id3Pid,id3Pid>0&&(id3Track.pid=id3Pid),null===unknownPID||pmtParsed||(logger.warn(`MPEG-TS PMT found at ${start} after unknown PID '${unknownPID}'. Backtracking to sync byte @${syncOffset} to parse all TS packets.`),unknownPID=null,start=syncOffset-188),pmtParsed=this.pmtParsed=!0;break}case 17:case 8191:break;default:unknownPID=pid}}else tsPacketErrors++;if(tsPacketErrors>0){const error=new Error(`Found ${tsPacketErrors} TS packet/s that do not start with 0x47`);this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,error,reason:error.message})}videoTrack.pesData=videoData,audioTrack.pesData=audioData,id3Track.pesData=id3Data;const demuxResult={audioTrack,videoTrack,id3Track,textTrack};return flush&&this.extractRemainingSamples(demuxResult),demuxResult}flush(){const{remainderData}=this;let result;return this.remainderData=null,result=remainderData?this.demux(remainderData,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(result),this.sampleAes?this.decrypt(result,this.sampleAes):result}extractRemainingSamples(demuxResult){const{audioTrack,videoTrack,id3Track,textTrack}=demuxResult,videoData=videoTrack.pesData,audioData=audioTrack.pesData,id3Data=id3Track.pesData;let pes;if(videoData&&(pes=parsePES(videoData))?(this.videoParser.parseAVCPES(videoTrack,textTrack,pes,!0,this._duration),videoTrack.pesData=null):videoTrack.pesData=videoData,audioData&&(pes=parsePES(audioData))){switch(audioTrack.segmentCodec){case"aac":this.parseAACPES(audioTrack,pes);break;case"mp3":this.parseMPEGPES(audioTrack,pes);break;case"ac3":this.parseAC3PES(audioTrack,pes)}audioTrack.pesData=null}else null!=audioData&&audioData.size&&logger.log("last AAC PES packet truncated,might overlap between fragments"),audioTrack.pesData=audioData;id3Data&&(pes=parsePES(id3Data))?(this.parseID3PES(id3Track,pes),id3Track.pesData=null):id3Track.pesData=id3Data}demuxSampleAes(data,keyData,timeOffset){const demuxResult=this.demux(data,timeOffset,!0,!this.config.progressive),sampleAes=this.sampleAes=new SampleAesDecrypter(this.observer,this.config,keyData);return this.decrypt(demuxResult,sampleAes)}decrypt(demuxResult,sampleAes){return new Promise((resolve=>{const{audioTrack,videoTrack}=demuxResult;audioTrack.samples&&"aac"===audioTrack.segmentCodec?sampleAes.decryptAacSamples(audioTrack.samples,0,(()=>{videoTrack.samples?sampleAes.decryptAvcSamples(videoTrack.samples,0,0,(()=>{resolve(demuxResult)})):resolve(demuxResult)})):videoTrack.samples&&sampleAes.decryptAvcSamples(videoTrack.samples,0,0,(()=>{resolve(demuxResult)}))}))}destroy(){this._duration=0}parseAACPES(track,pes){let startOffset=0;const aacOverFlow=this.aacOverFlow;let offset,len,pts,data=pes.data;if(aacOverFlow){this.aacOverFlow=null;const frameMissingBytes=aacOverFlow.missing,sampleLength=aacOverFlow.sample.unit.byteLength;if(-1===frameMissingBytes)data=appendUint8Array(aacOverFlow.sample.unit,data);else{const frameOverflowBytes=sampleLength-frameMissingBytes;aacOverFlow.sample.unit.set(data.subarray(0,frameMissingBytes),frameOverflowBytes),track.samples.push(aacOverFlow.sample),startOffset=aacOverFlow.missing}}for(offset=startOffset,len=data.length;offset<len-1&&!isHeader$1(data,offset);offset++);if(offset!==startOffset){let reason;const recoverable=offset<len-1;reason=recoverable?`AAC PES did not start with ADTS header,offset:${offset}`:"No ADTS header found in AAC PES";const error=new Error(reason);if(logger.warn(`parsing error: ${reason}`),this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,levelRetry:recoverable,error,reason}),!recoverable)return}if(initTrackConfig(track,this.observer,data,offset,this.audioCodec),void 0!==pes.pts)pts=pes.pts;else{if(!aacOverFlow)return void logger.warn("[tsdemuxer]: AAC PES unknown PTS");{const frameDuration=getFrameDuration(track.samplerate);pts=aacOverFlow.sample.pts+frameDuration}}let frame,frameIndex=0;for(;offset<len;){if(frame=appendFrame$2(track,data,offset,pts,frameIndex),offset+=frame.length,frame.missing){this.aacOverFlow=frame;break}for(frameIndex++;offset<len-1&&!isHeader$1(data,offset);offset++);}}parseMPEGPES(track,pes){const data=pes.data,length=data.length;let frameIndex=0,offset=0;const pts=pes.pts;if(void 0!==pts)for(;offset<length;)if(isHeader(data,offset)){const frame=appendFrame$1(track,data,offset,pts,frameIndex);if(!frame)break;offset+=frame.length,frameIndex++}else offset++;else logger.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(track,pes){{const data=pes.data,pts=pes.pts;if(void 0===pts)return void logger.warn("[tsdemuxer]: AC3 PES unknown PTS");const length=data.length;let parsed,frameIndex=0,offset=0;for(;offset<length&&(parsed=appendFrame(track,data,offset,pts,frameIndex++))>0;)offset+=parsed}}parseID3PES(id3Track,pes){if(void 0===pes.pts)return void logger.warn("[tsdemuxer]: ID3 PES unknown PTS");const id3Sample=_extends({},pes,{type:this._videoTrack?MetadataSchema_emsg:MetadataSchema_audioId3,duration:Number.POSITIVE_INFINITY});id3Track.samples.push(id3Sample)}}function parsePID(data,offset){return((31&data[offset+1])<<8)+data[offset+2]}function parsePAT(data,offset){return(31&data[offset+10])<<8|data[offset+11]}function parsePMT(data,offset,typeSupported,isSampleAes){const result={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},tableEnd=offset+3+((15&data[offset+1])<<8|data[offset+2])-4;for(offset+=12+((15&data[offset+10])<<8|data[offset+11]);offset<tableEnd;){const pid=parsePID(data,offset),esInfoLength=(15&data[offset+3])<<8|data[offset+4];switch(data[offset]){case 207:if(!isSampleAes){logEncryptedSamplesFoundInUnencryptedStream("ADTS AAC");break}case 15:-1===result.audioPid&&(result.audioPid=pid);break;case 21:-1===result.id3Pid&&(result.id3Pid=pid);break;case 219:if(!isSampleAes){logEncryptedSamplesFoundInUnencryptedStream("H.264");break}case 27:-1===result.videoPid&&(result.videoPid=pid,result.segmentVideoCodec="avc");break;case 3:case 4:typeSupported.mpeg||typeSupported.mp3?-1===result.audioPid&&(result.audioPid=pid,result.segmentAudioCodec="mp3"):logger.log("MPEG audio found, not supported in this browser");break;case 193:if(!isSampleAes){logEncryptedSamplesFoundInUnencryptedStream("AC-3");break}case 129:typeSupported.ac3?-1===result.audioPid&&(result.audioPid=pid,result.segmentAudioCodec="ac3"):logger.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===result.audioPid&&esInfoLength>0){let parsePos=offset+5,remaining=esInfoLength;for(;remaining>2;){if(106===data[parsePos])!0!==typeSupported.ac3?logger.log("AC-3 audio found, not supported in this browser for now"):(result.audioPid=pid,result.segmentAudioCodec="ac3");const descriptorLen=data[parsePos+1]+2;parsePos+=descriptorLen,remaining-=descriptorLen}}break;case 194:case 135:logger.warn("Unsupported EC-3 in M2TS found");break;case 36:logger.warn("Unsupported HEVC in M2TS found")}offset+=esInfoLength+5}return result}function logEncryptedSamplesFoundInUnencryptedStream(type){logger.log(`${type} with AES-128-CBC encryption found in unencrypted stream`)}function parsePES(stream){let frag,pesLen,pesHdrLen,pesPts,pesDts,i=0;const data=stream.data;if(!stream||0===stream.size)return null;for(;data[0].length<19&&data.length>1;)data[0]=appendUint8Array(data[0],data[1]),data.splice(1,1);frag=data[0];if(1===(frag[0]<<16)+(frag[1]<<8)+frag[2]){if(pesLen=(frag[4]<<8)+frag[5],pesLen&&pesLen>stream.size-6)return null;const pesFlags=frag[7];192&pesFlags&&(pesPts=536870912*(14&frag[9])+4194304*(255&frag[10])+16384*(254&frag[11])+128*(255&frag[12])+(254&frag[13])/2,64&pesFlags?(pesDts=536870912*(14&frag[14])+4194304*(255&frag[15])+16384*(254&frag[16])+128*(255&frag[17])+(254&frag[18])/2,pesPts-pesDts>54e5&&(logger.warn(`${Math.round((pesPts-pesDts)/9e4)}s delta between PTS and DTS, align them`),pesPts=pesDts)):pesDts=pesPts),pesHdrLen=frag[8];let payloadStartOffset=pesHdrLen+9;if(stream.size<=payloadStartOffset)return null;stream.size-=payloadStartOffset;const pesData=new Uint8Array(stream.size);for(let j=0,dataLen=data.length;j<dataLen;j++){frag=data[j];let len=frag.byteLength;if(payloadStartOffset){if(payloadStartOffset>len){payloadStartOffset-=len;continue}frag=frag.subarray(payloadStartOffset),len-=payloadStartOffset,payloadStartOffset=0}pesData.set(frag,i),i+=len}return pesLen&&(pesLen-=pesHdrLen+3),{data:pesData,pts:pesPts,dts:pesDts,len:pesLen}}return null}class AAC{static getSilentFrame(codec,channelCount){if("mp4a.40.2"===codec){if(1===channelCount)return new Uint8Array([0,200,0,128,35,128]);if(2===channelCount)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===channelCount)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===channelCount)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===channelCount)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const UINT32_MAX=Math.pow(2,32)-1;class MP4{static init(){let i;for(i in MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},MP4.types)MP4.types.hasOwnProperty(i)&&(MP4.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);const videoHdlr=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audioHdlr=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:videoHdlr,audio:audioHdlr};const dref=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),stco=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=stco,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const majorBrand=new Uint8Array([105,115,111,109]),avc1Brand=new Uint8Array([97,118,99,49]),minorVersion=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,majorBrand,minorVersion,majorBrand,avc1Brand),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,dref))}static box(type,...payload){let size=8,i=payload.length;const len=i;for(;i--;)size+=payload[i].byteLength;const result=new Uint8Array(size);for(result[0]=size>>24&255,result[1]=size>>16&255,result[2]=size>>8&255,result[3]=255&size,result.set(type,4),i=0,size=8;i<len;i++)result.set(payload[i],size),size+=payload[i].byteLength;return result}static hdlr(type){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[type])}static mdat(data){return MP4.box(MP4.types.mdat,data)}static mdhd(timescale,duration){duration*=timescale;const upperWordDuration=Math.floor(duration/(UINT32_MAX+1)),lowerWordDuration=Math.floor(duration%(UINT32_MAX+1));return MP4.box(MP4.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,85,196,0,0]))}static mdia(track){return MP4.box(MP4.types.mdia,MP4.mdhd(track.timescale,track.duration),MP4.hdlr(track.type),MP4.minf(track))}static mfhd(sequenceNumber){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,sequenceNumber>>24,sequenceNumber>>16&255,sequenceNumber>>8&255,255&sequenceNumber]))}static minf(track){return"audio"===track.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(track)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(track))}static moof(sn,baseMediaDecodeTime,track){return MP4.box(MP4.types.moof,MP4.mfhd(sn),MP4.traf(track,baseMediaDecodeTime))}static moov(tracks){let i=tracks.length;const boxes=[];for(;i--;)boxes[i]=MP4.trak(tracks[i]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(tracks[0].timescale,tracks[0].duration)].concat(boxes).concat(MP4.mvex(tracks)))}static mvex(tracks){let i=tracks.length;const boxes=[];for(;i--;)boxes[i]=MP4.trex(tracks[i]);return MP4.box.apply(null,[MP4.types.mvex,...boxes])}static mvhd(timescale,duration){duration*=timescale;const upperWordDuration=Math.floor(duration/(UINT32_MAX+1)),lowerWordDuration=Math.floor(duration%(UINT32_MAX+1)),bytes=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,bytes)}static sdtp(track){const samples=track.samples||[],bytes=new Uint8Array(4+samples.length);let i,flags;for(i=0;i<samples.length;i++)flags=samples[i].flags,bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;return MP4.box(MP4.types.sdtp,bytes)}static stbl(track){return MP4.box(MP4.types.stbl,MP4.stsd(track),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))}static avc1(track){let i,data,len,sps=[],pps=[];for(i=0;i<track.sps.length;i++)data=track.sps[i],len=data.byteLength,sps.push(len>>>8&255),sps.push(255&len),sps=sps.concat(Array.prototype.slice.call(data));for(i=0;i<track.pps.length;i++)data=track.pps[i],len=data.byteLength,pps.push(len>>>8&255),pps.push(255&len),pps=pps.concat(Array.prototype.slice.call(data));const avcc=MP4.box(MP4.types.avcC,new Uint8Array([1,sps[3],sps[4],sps[5],255,224|track.sps.length].concat(sps).concat([track.pps.length]).concat(pps))),width=track.width,height=track.height,hSpacing=track.pixelRatio[0],vSpacing=track.pixelRatio[1];return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,width>>8&255,255&width,height>>8&255,255&height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),avcc,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),MP4.box(MP4.types.pasp,new Uint8Array([hSpacing>>24,hSpacing>>16&255,hSpacing>>8&255,255&hSpacing,vSpacing>>24,vSpacing>>16&255,vSpacing>>8&255,255&vSpacing])))}static esds(track){const configlen=track.config.length;return new Uint8Array([0,0,0,0,3,23+configlen,0,1,0,4,15+configlen,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([configlen]).concat(track.config).concat([6,1,2]))}static audioStsd(track){const samplerate=track.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,samplerate>>8&255,255&samplerate,0,0])}static mp4a(track){return MP4.box(MP4.types.mp4a,MP4.audioStsd(track),MP4.box(MP4.types.esds,MP4.esds(track)))}static mp3(track){return MP4.box(MP4.types[".mp3"],MP4.audioStsd(track))}static ac3(track){return MP4.box(MP4.types["ac-3"],MP4.audioStsd(track),MP4.box(MP4.types.dac3,track.config))}static stsd(track){return"audio"===track.type?"mp3"===track.segmentCodec&&"mp3"===track.codec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp3(track)):"ac3"===track.segmentCodec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.ac3(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(track))}static tkhd(track){const id=track.id,duration=track.duration*track.timescale,width=track.width,height=track.height,upperWordDuration=Math.floor(duration/(UINT32_MAX+1)),lowerWordDuration=Math.floor(duration%(UINT32_MAX+1));return MP4.box(MP4.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,id>>24&255,id>>16&255,id>>8&255,255&id,0,0,0,0,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,width>>8&255,255&width,0,0,height>>8&255,255&height,0,0]))}static traf(track,baseMediaDecodeTime){const sampleDependencyTable=MP4.sdtp(track),id=track.id,upperWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime/(UINT32_MAX+1)),lowerWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime%(UINT32_MAX+1));return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id])),MP4.box(MP4.types.tfdt,new Uint8Array([1,0,0,0,upperWordBaseMediaDecodeTime>>24,upperWordBaseMediaDecodeTime>>16&255,upperWordBaseMediaDecodeTime>>8&255,255&upperWordBaseMediaDecodeTime,lowerWordBaseMediaDecodeTime>>24,lowerWordBaseMediaDecodeTime>>16&255,lowerWordBaseMediaDecodeTime>>8&255,255&lowerWordBaseMediaDecodeTime])),MP4.trun(track,sampleDependencyTable.length+16+20+8+16+8+8),sampleDependencyTable)}static trak(track){return track.duration=track.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(track),MP4.mdia(track))}static trex(track){const id=track.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(track,offset){const samples=track.samples||[],len=samples.length,arraylen=12+16*len,array=new Uint8Array(arraylen);let i,sample,duration,size,flags,cts;for(offset+=8+arraylen,array.set(["video"===track.type?1:0,0,15,1,len>>>24&255,len>>>16&255,len>>>8&255,255&len,offset>>>24&255,offset>>>16&255,offset>>>8&255,255&offset],0),i=0;i<len;i++)sample=samples[i],duration=sample.duration,size=sample.size,flags=sample.flags,cts=sample.cts,array.set([duration>>>24&255,duration>>>16&255,duration>>>8&255,255&duration,size>>>24&255,size>>>16&255,size>>>8&255,255&size,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.paddingValue<<1|flags.isNonSync,61440&flags.degradPrio,15&flags.degradPrio,cts>>>24&255,cts>>>16&255,cts>>>8&255,255&cts],12+16*i);return MP4.box(MP4.types.trun,array)}static initSegment(tracks){MP4.types||MP4.init();const movie=MP4.moov(tracks);return appendUint8Array(MP4.FTYP,movie)}}MP4.types=void 0,MP4.HDLR_TYPES=void 0,MP4.STTS=void 0,MP4.STSC=void 0,MP4.STCO=void 0,MP4.STSZ=void 0,MP4.VMHD=void 0,MP4.SMHD=void 0,MP4.STSD=void 0,MP4.FTYP=void 0,MP4.DINF=void 0;const MPEG_TS_CLOCK_FREQ_HZ=9e4;function toTimescaleFromBase(baseTime,destScale,srcBase=1,round=!1){const result=baseTime*destScale*srcBase;return round?Math.round(result):result}function toMsFromMpegTsClock(baseTime,round=!1){return toTimescaleFromBase(baseTime,1e3,1/MPEG_TS_CLOCK_FREQ_HZ,round)}let now,chromeVersion=null,safariWebkitVersion=null;class MP4Remuxer{constructor(observer,config,typeSupported,vendor=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=observer,this.config=config,this.typeSupported=typeSupported,this.ISGenerated=!1,null===chromeVersion){const result=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);chromeVersion=result?parseInt(result[1]):0}if(null===safariWebkitVersion){const result=navigator.userAgent.match(/Safari\/(\d+)/i);safariWebkitVersion=result?parseInt(result[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(defaultTimeStamp){logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=defaultTimeStamp}resetNextTimestamp(){logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(videoSamples){let rolloverDetected=!1;const startPTS=videoSamples.reduce(((minPTS,sample)=>{const delta=sample.pts-minPTS;return delta<-4294967296?(rolloverDetected=!0,normalizePts(minPTS,sample.pts)):delta>0?minPTS:sample.pts}),videoSamples[0].pts);return rolloverDetected&&logger.debug("PTS rollover detected"),startPTS}remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset,flush,playlistType){let video,audio,initSegment,text,id3,independent,audioTimeOffset=timeOffset,videoTimeOffset=timeOffset;const hasAudio=audioTrack.pid>-1,hasVideo=videoTrack.pid>-1,length=videoTrack.samples.length,enoughAudioSamples=audioTrack.samples.length>0,enoughVideoSamples=flush&&length>0||length>1;if((!hasAudio||enoughAudioSamples)&&(!hasVideo||enoughVideoSamples)||this.ISGenerated||flush){if(this.ISGenerated){var _videoTrack$pixelRati,_config$pixelRatio,_videoTrack$pixelRati2,_config$pixelRatio2;const config=this.videoTrackConfig;!config||videoTrack.width===config.width&&videoTrack.height===config.height&&(null==(_videoTrack$pixelRati=videoTrack.pixelRatio)?void 0:_videoTrack$pixelRati[0])===(null==(_config$pixelRatio=config.pixelRatio)?void 0:_config$pixelRatio[0])&&(null==(_videoTrack$pixelRati2=videoTrack.pixelRatio)?void 0:_videoTrack$pixelRati2[1])===(null==(_config$pixelRatio2=config.pixelRatio)?void 0:_config$pixelRatio2[1])||this.resetInitSegment()}else initSegment=this.generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset);const isVideoContiguous=this.isVideoContiguous;let firstKeyFramePTS,firstKeyFrameIndex=-1;if(enoughVideoSamples&&(firstKeyFrameIndex=function findKeyframeIndex(samples){for(let i=0;i<samples.length;i++)if(samples[i].key)return i;return-1}(videoTrack.samples),!isVideoContiguous&&this.config.forceKeyFrameOnDiscontinuity))if(independent=!0,firstKeyFrameIndex>0){logger.warn(`[mp4-remuxer]: Dropped ${firstKeyFrameIndex} out of ${length} video samples due to a missing keyframe`);const startPTS=this.getVideoStartPts(videoTrack.samples);videoTrack.samples=videoTrack.samples.slice(firstKeyFrameIndex),videoTrack.dropped+=firstKeyFrameIndex,videoTimeOffset+=(videoTrack.samples[0].pts-startPTS)/videoTrack.inputTimeScale,firstKeyFramePTS=videoTimeOffset}else-1===firstKeyFrameIndex&&(logger.warn(`[mp4-remuxer]: No keyframe found out of ${length} video samples`),independent=!1);if(this.ISGenerated){if(enoughAudioSamples&&enoughVideoSamples){const startPTS=this.getVideoStartPts(videoTrack.samples),audiovideoTimestampDelta=(normalizePts(audioTrack.samples[0].pts,startPTS)-startPTS)/videoTrack.inputTimeScale;audioTimeOffset+=Math.max(0,audiovideoTimestampDelta),videoTimeOffset+=Math.max(0,-audiovideoTimestampDelta)}if(enoughAudioSamples){if(audioTrack.samplerate||(logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),initSegment=this.generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset)),audio=this.remuxAudio(audioTrack,audioTimeOffset,this.isAudioContiguous,accurateTimeOffset,hasVideo||enoughVideoSamples||playlistType===PlaylistLevelType_AUDIO?videoTimeOffset:void 0),enoughVideoSamples){const audioTrackLength=audio?audio.endPTS-audio.startPTS:0;videoTrack.inputTimeScale||(logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),initSegment=this.generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset)),video=this.remuxVideo(videoTrack,videoTimeOffset,isVideoContiguous,audioTrackLength)}}else enoughVideoSamples&&(video=this.remuxVideo(videoTrack,videoTimeOffset,isVideoContiguous,0));video&&(video.firstKeyFrame=firstKeyFrameIndex,video.independent=-1!==firstKeyFrameIndex,video.firstKeyFramePTS=firstKeyFramePTS)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(id3Track.samples.length&&(id3=flushTextTrackMetadataCueSamples(id3Track,timeOffset,this._initPTS,this._initDTS)),textTrack.samples.length&&(text=flushTextTrackUserdataCueSamples(textTrack,timeOffset,this._initPTS))),{audio,video,initSegment,independent,text,id3}}generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset){const audioSamples=audioTrack.samples,videoSamples=videoTrack.samples,typeSupported=this.typeSupported,tracks={},_initPTS=this._initPTS;let initPTS,initDTS,timescale,computePTSDTS=!_initPTS||accurateTimeOffset,container="audio/mp4";if(computePTSDTS&&(initPTS=initDTS=1/0),audioTrack.config&&audioSamples.length){switch(audioTrack.timescale=audioTrack.samplerate,audioTrack.segmentCodec){case"mp3":typeSupported.mpeg?(container="audio/mpeg",audioTrack.codec=""):typeSupported.mp3&&(audioTrack.codec="mp3");break;case"ac3":audioTrack.codec="ac-3"}tracks.audio={id:"audio",container,codec:audioTrack.codec,initSegment:"mp3"===audioTrack.segmentCodec&&typeSupported.mpeg?new Uint8Array(0):MP4.initSegment([audioTrack]),metadata:{channelCount:audioTrack.channelCount}},computePTSDTS&&(timescale=audioTrack.inputTimeScale,_initPTS&&timescale===_initPTS.timescale?computePTSDTS=!1:initPTS=initDTS=audioSamples[0].pts-Math.round(timescale*timeOffset))}if(videoTrack.sps&&videoTrack.pps&&videoSamples.length){if(videoTrack.timescale=videoTrack.inputTimeScale,tracks.video={id:"main",container:"video/mp4",codec:videoTrack.codec,initSegment:MP4.initSegment([videoTrack]),metadata:{width:videoTrack.width,height:videoTrack.height}},computePTSDTS)if(timescale=videoTrack.inputTimeScale,_initPTS&&timescale===_initPTS.timescale)computePTSDTS=!1;else{const startPTS=this.getVideoStartPts(videoSamples),startOffset=Math.round(timescale*timeOffset);initDTS=Math.min(initDTS,normalizePts(videoSamples[0].dts,startPTS)-startOffset),initPTS=Math.min(initPTS,startPTS-startOffset)}this.videoTrackConfig={width:videoTrack.width,height:videoTrack.height,pixelRatio:videoTrack.pixelRatio}}if(Object.keys(tracks).length)return this.ISGenerated=!0,computePTSDTS?(this._initPTS={baseTime:initPTS,timescale},this._initDTS={baseTime:initDTS,timescale}):initPTS=timescale=void 0,{tracks,initPTS,timescale}}remuxVideo(track,timeOffset,contiguous,audioTrackLength){const timeScale=track.inputTimeScale,inputSamples=track.samples,outputSamples=[],nbSamples=inputSamples.length,initPTS=this._initPTS;let firstDTS,lastDTS,nextAvcDts=this.nextAvcDts,offset=8,mp4SampleDuration=this.videoSampleDuration,minPTS=Number.POSITIVE_INFINITY,maxPTS=Number.NEGATIVE_INFINITY,sortSamples=!1;if(!contiguous||null===nextAvcDts){const pts=timeOffset*timeScale,cts=inputSamples[0].pts-normalizePts(inputSamples[0].dts,inputSamples[0].pts);chromeVersion&&null!==nextAvcDts&&Math.abs(pts-cts-nextAvcDts)<15e3?contiguous=!0:nextAvcDts=pts-cts}const initTime=initPTS.baseTime*timeScale/initPTS.timescale;for(let i=0;i<nbSamples;i++){const sample=inputSamples[i];sample.pts=normalizePts(sample.pts-initTime,nextAvcDts),sample.dts=normalizePts(sample.dts-initTime,nextAvcDts),sample.dts<inputSamples[i>0?i-1:i].dts&&(sortSamples=!0)}sortSamples&&inputSamples.sort((function(a,b){const deltadts=a.dts-b.dts,deltapts=a.pts-b.pts;return deltadts||deltapts})),firstDTS=inputSamples[0].dts,lastDTS=inputSamples[inputSamples.length-1].dts;const inputDuration=lastDTS-firstDTS,averageSampleDuration=inputDuration?Math.round(inputDuration/(nbSamples-1)):mp4SampleDuration||track.inputTimeScale/30;if(contiguous){const delta=firstDTS-nextAvcDts,foundHole=delta>averageSampleDuration,foundOverlap=delta<-1;if((foundHole||foundOverlap)&&(foundHole?logger.warn(`AVC: ${toMsFromMpegTsClock(delta,!0)} ms (${delta}dts) hole between fragments detected at ${timeOffset.toFixed(3)}`):logger.warn(`AVC: ${toMsFromMpegTsClock(-delta,!0)} ms (${delta}dts) overlapping between fragments detected at ${timeOffset.toFixed(3)}`),!foundOverlap||nextAvcDts>=inputSamples[0].pts||chromeVersion)){firstDTS=nextAvcDts;const firstPTS=inputSamples[0].pts-delta;if(foundHole)inputSamples[0].dts=firstDTS,inputSamples[0].pts=firstPTS;else for(let i=0;i<inputSamples.length&&!(inputSamples[i].dts>firstPTS);i++)inputSamples[i].dts-=delta,inputSamples[i].pts-=delta;logger.log(`Video: Initial PTS/DTS adjusted: ${toMsFromMpegTsClock(firstPTS,!0)}/${toMsFromMpegTsClock(firstDTS,!0)}, delta: ${toMsFromMpegTsClock(delta,!0)} ms`)}}firstDTS=Math.max(0,firstDTS);let nbNalu=0,naluLen=0,dtsStep=firstDTS;for(let i=0;i<nbSamples;i++){const sample=inputSamples[i],units=sample.units,nbUnits=units.length;let sampleLen=0;for(let j=0;j<nbUnits;j++)sampleLen+=units[j].data.length;naluLen+=sampleLen,nbNalu+=nbUnits,sample.length=sampleLen,sample.dts<dtsStep?(sample.dts=dtsStep,dtsStep+=averageSampleDuration/4|0||1):dtsStep=sample.dts,minPTS=Math.min(sample.pts,minPTS),maxPTS=Math.max(sample.pts,maxPTS)}lastDTS=inputSamples[nbSamples-1].dts;const mdatSize=naluLen+4*nbNalu+8;let mdat;try{mdat=new Uint8Array(mdatSize)}catch(err){return void this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MUX_ERROR,details:ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,error:err,bytes:mdatSize,reason:`fail allocating video mdat ${mdatSize}`})}const view=new DataView(mdat.buffer);view.setUint32(0,mdatSize),mdat.set(MP4.types.mdat,4);let stretchedLastFrame=!1,minDtsDelta=Number.POSITIVE_INFINITY,minPtsDelta=Number.POSITIVE_INFINITY,maxDtsDelta=Number.NEGATIVE_INFINITY,maxPtsDelta=Number.NEGATIVE_INFINITY;for(let i=0;i<nbSamples;i++){const VideoSample=inputSamples[i],VideoSampleUnits=VideoSample.units;let ptsDelta,mp4SampleLength=0;for(let j=0,nbUnits=VideoSampleUnits.length;j<nbUnits;j++){const unit=VideoSampleUnits[j],unitData=unit.data,unitDataLen=unit.data.byteLength;view.setUint32(offset,unitDataLen),offset+=4,mdat.set(unitData,offset),offset+=unitDataLen,mp4SampleLength+=4+unitDataLen}if(i<nbSamples-1)mp4SampleDuration=inputSamples[i+1].dts-VideoSample.dts,ptsDelta=inputSamples[i+1].pts-VideoSample.pts;else{const config=this.config,lastFrameDuration=i>0?VideoSample.dts-inputSamples[i-1].dts:averageSampleDuration;if(ptsDelta=i>0?VideoSample.pts-inputSamples[i-1].pts:averageSampleDuration,config.stretchShortVideoTrack&&null!==this.nextAudioPts){const gapTolerance=Math.floor(config.maxBufferHole*timeScale),deltaToFrameEnd=(audioTrackLength?minPTS+audioTrackLength*timeScale:this.nextAudioPts)-VideoSample.pts;deltaToFrameEnd>gapTolerance?(mp4SampleDuration=deltaToFrameEnd-lastFrameDuration,mp4SampleDuration<0?mp4SampleDuration=lastFrameDuration:stretchedLastFrame=!0,logger.log(`[mp4-remuxer]: It is approximately ${deltaToFrameEnd/90} ms to the next segment; using duration ${mp4SampleDuration/90} ms for the last video frame.`)):mp4SampleDuration=lastFrameDuration}else mp4SampleDuration=lastFrameDuration}const compositionTimeOffset=Math.round(VideoSample.pts-VideoSample.dts);minDtsDelta=Math.min(minDtsDelta,mp4SampleDuration),maxDtsDelta=Math.max(maxDtsDelta,mp4SampleDuration),minPtsDelta=Math.min(minPtsDelta,ptsDelta),maxPtsDelta=Math.max(maxPtsDelta,ptsDelta),outputSamples.push(new Mp4Sample(VideoSample.key,mp4SampleDuration,mp4SampleLength,compositionTimeOffset))}if(outputSamples.length)if(chromeVersion){if(chromeVersion<70){const flags=outputSamples[0].flags;flags.dependsOn=2,flags.isNonSync=0}}else if(safariWebkitVersion&&maxPtsDelta-minPtsDelta<maxDtsDelta-minDtsDelta&&averageSampleDuration/maxDtsDelta<.025&&0===outputSamples[0].cts){logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let dts=firstDTS;for(let i=0,len=outputSamples.length;i<len;i++){const nextDts=dts+outputSamples[i].duration,pts=dts+outputSamples[i].cts;if(i<len-1){const nextPts=nextDts+outputSamples[i+1].cts;outputSamples[i].duration=nextPts-pts}else outputSamples[i].duration=i?outputSamples[i-1].duration:averageSampleDuration;outputSamples[i].cts=0,dts=nextDts}}mp4SampleDuration=stretchedLastFrame||!mp4SampleDuration?averageSampleDuration:mp4SampleDuration,this.nextAvcDts=nextAvcDts=lastDTS+mp4SampleDuration,this.videoSampleDuration=mp4SampleDuration,this.isVideoContiguous=!0;const data={data1:MP4.moof(track.sequenceNumber++,firstDTS,_extends({},track,{samples:outputSamples})),data2:mdat,startPTS:minPTS/timeScale,endPTS:(maxPTS+mp4SampleDuration)/timeScale,startDTS:firstDTS/timeScale,endDTS:nextAvcDts/timeScale,type:"video",hasAudio:!1,hasVideo:!0,nb:outputSamples.length,dropped:track.dropped};return track.samples=[],track.dropped=0,data}getSamplesPerFrame(track){switch(track.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(track,timeOffset,contiguous,accurateTimeOffset,videoTimeOffset){const inputTimeScale=track.inputTimeScale,scaleFactor=inputTimeScale/(track.samplerate?track.samplerate:inputTimeScale),mp4SampleDuration=this.getSamplesPerFrame(track),inputSampleDuration=mp4SampleDuration*scaleFactor,initPTS=this._initPTS,rawMPEG="mp3"===track.segmentCodec&&this.typeSupported.mpeg,outputSamples=[],alignedWithVideo=void 0!==videoTimeOffset;let inputSamples=track.samples,offset=rawMPEG?0:8,nextAudioPts=this.nextAudioPts||-1;const timeOffsetMpegTS=timeOffset*inputTimeScale,initTime=initPTS.baseTime*inputTimeScale/initPTS.timescale;if(this.isAudioContiguous=contiguous=contiguous||inputSamples.length&&nextAudioPts>0&&(accurateTimeOffset&&Math.abs(timeOffsetMpegTS-nextAudioPts)<9e3||Math.abs(normalizePts(inputSamples[0].pts-initTime,timeOffsetMpegTS)-nextAudioPts)<20*inputSampleDuration),inputSamples.forEach((function(sample){sample.pts=normalizePts(sample.pts-initTime,timeOffsetMpegTS)})),!contiguous||nextAudioPts<0){if(inputSamples=inputSamples.filter((sample=>sample.pts>=0)),!inputSamples.length)return;nextAudioPts=0===videoTimeOffset?0:accurateTimeOffset&&!alignedWithVideo?Math.max(0,timeOffsetMpegTS):inputSamples[0].pts}if("aac"===track.segmentCodec){const maxAudioFramesDrift=this.config.maxAudioFramesDrift;for(let i=0,nextPts=nextAudioPts;i<inputSamples.length;i++){const sample=inputSamples[i],pts=sample.pts,delta=pts-nextPts,duration=Math.abs(1e3*delta/inputTimeScale);if(delta<=-maxAudioFramesDrift*inputSampleDuration&&alignedWithVideo)0===i&&(logger.warn(`Audio frame @ ${(pts/inputTimeScale).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*delta/inputTimeScale)} ms.`),this.nextAudioPts=nextAudioPts=nextPts=pts);else if(delta>=maxAudioFramesDrift*inputSampleDuration&&duration<1e4&&alignedWithVideo){let missing=Math.round(delta/inputSampleDuration);nextPts=pts-missing*inputSampleDuration,nextPts<0&&(missing--,nextPts+=inputSampleDuration),0===i&&(this.nextAudioPts=nextAudioPts=nextPts),logger.warn(`[mp4-remuxer]: Injecting ${missing} audio frame @ ${(nextPts/inputTimeScale).toFixed(3)}s due to ${Math.round(1e3*delta/inputTimeScale)} ms gap.`);for(let j=0;j<missing;j++){const newStamp=Math.max(nextPts,0);let fillFrame=AAC.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);fillFrame||(logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),fillFrame=sample.unit.subarray()),inputSamples.splice(i,0,{unit:fillFrame,pts:newStamp}),nextPts+=inputSampleDuration,i++}}sample.pts=nextPts,nextPts+=inputSampleDuration}}let mdat,firstPTS=null,lastPTS=null,mdatSize=0,sampleLength=inputSamples.length;for(;sampleLength--;)mdatSize+=inputSamples[sampleLength].unit.byteLength;for(let j=0,_nbSamples=inputSamples.length;j<_nbSamples;j++){const audioSample=inputSamples[j],unit=audioSample.unit;let pts=audioSample.pts;if(null!==lastPTS){outputSamples[j-1].duration=Math.round((pts-lastPTS)/scaleFactor)}else{if(contiguous&&"aac"===track.segmentCodec&&(pts=nextAudioPts),firstPTS=pts,!(mdatSize>0))return;mdatSize+=offset;try{mdat=new Uint8Array(mdatSize)}catch(err){return void this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MUX_ERROR,details:ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,error:err,bytes:mdatSize,reason:`fail allocating audio mdat ${mdatSize}`})}if(!rawMPEG){new DataView(mdat.buffer).setUint32(0,mdatSize),mdat.set(MP4.types.mdat,4)}}mdat.set(unit,offset);const unitLen=unit.byteLength;offset+=unitLen,outputSamples.push(new Mp4Sample(!0,mp4SampleDuration,unitLen,0)),lastPTS=pts}const nbSamples=outputSamples.length;if(!nbSamples)return;const lastSample=outputSamples[outputSamples.length-1];this.nextAudioPts=nextAudioPts=lastPTS+scaleFactor*lastSample.duration;const moof=rawMPEG?new Uint8Array(0):MP4.moof(track.sequenceNumber++,firstPTS/scaleFactor,_extends({},track,{samples:outputSamples}));track.samples=[];const start=firstPTS/inputTimeScale,end=nextAudioPts/inputTimeScale,audioData={data1:moof,data2:mdat,startPTS:start,endPTS:end,startDTS:start,endDTS:end,type:"audio",hasAudio:!0,hasVideo:!1,nb:nbSamples};return this.isAudioContiguous=!0,audioData}remuxEmptyAudio(track,timeOffset,contiguous,videoData){const inputTimeScale=track.inputTimeScale,scaleFactor=inputTimeScale/(track.samplerate?track.samplerate:inputTimeScale),nextAudioPts=this.nextAudioPts,initDTS=this._initDTS,init90kHz=9e4*initDTS.baseTime/initDTS.timescale,startDTS=(null!==nextAudioPts?nextAudioPts:videoData.startDTS*inputTimeScale)+init90kHz,endDTS=videoData.endDTS*inputTimeScale+init90kHz,frameDuration=1024*scaleFactor,nbSamples=Math.ceil((endDTS-startDTS)/frameDuration),silentFrame=AAC.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if(logger.warn("[mp4-remuxer]: remux empty Audio"),!silentFrame)return void logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const samples=[];for(let i=0;i<nbSamples;i++){const stamp=startDTS+i*frameDuration;samples.push({unit:silentFrame,pts:stamp,dts:stamp})}return track.samples=samples,this.remuxAudio(track,timeOffset,contiguous,!1)}}function normalizePts(value,reference){let offset;if(null===reference)return value;for(offset=reference<value?-8589934592:8589934592;Math.abs(value-reference)>4294967296;)value+=offset;return value}function flushTextTrackMetadataCueSamples(track,timeOffset,initPTS,initDTS){const length=track.samples.length;if(!length)return;const inputTimeScale=track.inputTimeScale;for(let index=0;index<length;index++){const sample=track.samples[index];sample.pts=normalizePts(sample.pts-initPTS.baseTime*inputTimeScale/initPTS.timescale,timeOffset*inputTimeScale)/inputTimeScale,sample.dts=normalizePts(sample.dts-initDTS.baseTime*inputTimeScale/initDTS.timescale,timeOffset*inputTimeScale)/inputTimeScale}const samples=track.samples;return track.samples=[],{samples}}function flushTextTrackUserdataCueSamples(track,timeOffset,initPTS){const length=track.samples.length;if(!length)return;const inputTimeScale=track.inputTimeScale;for(let index=0;index<length;index++){const sample=track.samples[index];sample.pts=normalizePts(sample.pts-initPTS.baseTime*inputTimeScale/initPTS.timescale,timeOffset*inputTimeScale)/inputTimeScale}track.samples.sort(((a,b)=>a.pts-b.pts));const samples=track.samples;return track.samples=[],{samples}}class Mp4Sample{constructor(isKeyframe,duration,size,cts){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=duration,this.size=size,this.cts=cts,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:isKeyframe?2:1,isNonSync:isKeyframe?0:1}}}function getParsedTrackCodec(track,type){const parsedCodec=null==track?void 0:track.codec;if(parsedCodec&&parsedCodec.length>4)return parsedCodec;if(type===ElementaryStreamTypes_AUDIO){if("ec-3"===parsedCodec||"ac-3"===parsedCodec||"alac"===parsedCodec)return parsedCodec;if("fLaC"===parsedCodec||"Opus"===parsedCodec){return getCodecCompatibleName(parsedCodec,!1)}const result="mp4a.40.5";return logger.info(`Parsed audio codec "${parsedCodec}" or audio object type not handled. Using "${result}"`),result}return logger.warn(`Unhandled video codec "${parsedCodec}"`),"hvc1"===parsedCodec||"hev1"===parsedCodec?"hvc1.1.6.L120.90":"av01"===parsedCodec?"av01.0.04M.08":"avc1.42e01e"}try{now=self.performance.now.bind(self.performance)}catch(err){logger.debug("Unable to use Performance API on this environment"),now=null==optionalSelf?void 0:optionalSelf.Date.now}const muxConfig=[{demux:class MP4Demuxer{constructor(observer,config){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=config}resetTimeStamp(){}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){const videoTrack=this.videoTrack=dummyTrack("video",1),audioTrack=this.audioTrack=dummyTrack("audio",1),captionTrack=this.txtTrack=dummyTrack("text",1);if(this.id3Track=dummyTrack("id3",1),this.timeOffset=0,null==initSegment||!initSegment.byteLength)return;const initData=parseInitSegment(initSegment);if(initData.video){const{id,timescale,codec}=initData.video;videoTrack.id=id,videoTrack.timescale=captionTrack.timescale=timescale,videoTrack.codec=codec}if(initData.audio){const{id,timescale,codec}=initData.audio;audioTrack.id=id,audioTrack.timescale=timescale,audioTrack.codec=codec}captionTrack.id=RemuxerTrackIdConfig.text,videoTrack.sampleDuration=0,videoTrack.duration=audioTrack.duration=trackDuration}resetContiguity(){this.remainderData=null}static probe(data){return function hasMoofData(data){const end=data.byteLength;for(let i=0;i<end;){const size=readUint32(data,i);if(size>8&&109===data[i+4]&&111===data[i+5]&&111===data[i+6]&&102===data[i+7])return!0;i=size>1?i+size:end}return!1}(data)}demux(data,timeOffset){this.timeOffset=timeOffset;let videoSamples=data;const videoTrack=this.videoTrack,textTrack=this.txtTrack;if(this.config.progressive){this.remainderData&&(videoSamples=appendUint8Array(this.remainderData,data));const segmentedData=function segmentValidRange(data){const segmentedRange={valid:null,remainder:null},moofs=findBox(data,["moof"]);if(moofs.length<2)return segmentedRange.remainder=data,segmentedRange;const last=moofs[moofs.length-1];return segmentedRange.valid=sliceUint8(data,0,last.byteOffset-8),segmentedRange.remainder=sliceUint8(data,last.byteOffset-8),segmentedRange}(videoSamples);this.remainderData=segmentedData.remainder,videoTrack.samples=segmentedData.valid||new Uint8Array}else videoTrack.samples=videoSamples;const id3Track=this.extractID3Track(videoTrack,timeOffset);return textTrack.samples=parseSamples(timeOffset,videoTrack),{videoTrack,audioTrack:this.audioTrack,id3Track,textTrack:this.txtTrack}}flush(){const timeOffset=this.timeOffset,videoTrack=this.videoTrack,textTrack=this.txtTrack;videoTrack.samples=this.remainderData||new Uint8Array,this.remainderData=null;const id3Track=this.extractID3Track(videoTrack,this.timeOffset);return textTrack.samples=parseSamples(timeOffset,videoTrack),{videoTrack,audioTrack:dummyTrack(),id3Track,textTrack:dummyTrack()}}extractID3Track(videoTrack,timeOffset){const id3Track=this.id3Track;if(videoTrack.samples.length){const emsgs=findBox(videoTrack.samples,["emsg"]);emsgs&&emsgs.forEach((data=>{const emsgInfo=function parseEmsg(data){const version=data[0];let schemeIdUri="",value="",timeScale=0,presentationTimeDelta=0,presentationTime=0,eventDuration=0,id=0,offset=0;if(0===version){for(;"\0"!==bin2str(data.subarray(offset,offset+1));)schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;for(schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;"\0"!==bin2str(data.subarray(offset,offset+1));)value+=bin2str(data.subarray(offset,offset+1)),offset+=1;value+=bin2str(data.subarray(offset,offset+1)),offset+=1,timeScale=readUint32(data,12),presentationTimeDelta=readUint32(data,16),eventDuration=readUint32(data,20),id=readUint32(data,24),offset=28}else if(1===version){offset+=4,timeScale=readUint32(data,offset),offset+=4;const leftPresentationTime=readUint32(data,offset);offset+=4;const rightPresentationTime=readUint32(data,offset);for(offset+=4,presentationTime=2**32*leftPresentationTime+rightPresentationTime,isSafeInteger(presentationTime)||(presentationTime=Number.MAX_SAFE_INTEGER,logger.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),eventDuration=readUint32(data,offset),offset+=4,id=readUint32(data,offset),offset+=4;"\0"!==bin2str(data.subarray(offset,offset+1));)schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;for(schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;"\0"!==bin2str(data.subarray(offset,offset+1));)value+=bin2str(data.subarray(offset,offset+1)),offset+=1;value+=bin2str(data.subarray(offset,offset+1)),offset+=1}return{schemeIdUri,value,timeScale,presentationTime,presentationTimeDelta,eventDuration,id,payload:data.subarray(offset,data.byteLength)}}(data);if(emsgSchemePattern.test(emsgInfo.schemeIdUri)){const pts=isFiniteNumber(emsgInfo.presentationTime)?emsgInfo.presentationTime/emsgInfo.timeScale:timeOffset+emsgInfo.presentationTimeDelta/emsgInfo.timeScale;let duration=4294967295===emsgInfo.eventDuration?Number.POSITIVE_INFINITY:emsgInfo.eventDuration/emsgInfo.timeScale;duration<=.001&&(duration=Number.POSITIVE_INFINITY);const payload=emsgInfo.payload;id3Track.samples.push({data:payload,len:payload.byteLength,dts:pts,pts,type:MetadataSchema_emsg,duration})}}))}return id3Track}demuxSampleAes(data,keyData,timeOffset){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class PassThroughRemuxer{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(defaultInitPTS){this.initPTS=defaultInitPTS,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(initSegment,audioCodec,videoCodec,decryptdata){this.audioCodec=audioCodec,this.videoCodec=videoCodec,this.generateInitSegment(function patchEncyptionData(initSegment,decryptdata){if(!initSegment||!decryptdata)return initSegment;const keyId=decryptdata.keyId;keyId&&decryptdata.isCommonEncryption&&findBox(initSegment,["moov","trak"]).forEach((trak=>{const sampleEntries=findBox(trak,["mdia","minf","stbl","stsd"])[0].subarray(8);let encBoxes=findBox(sampleEntries,["enca"]);const isAudio=encBoxes.length>0;isAudio||(encBoxes=findBox(sampleEntries,["encv"])),encBoxes.forEach((enc=>{findBox(isAudio?enc.subarray(28):enc.subarray(78),["sinf"]).forEach((sinf=>{const tenc=parseSinf(sinf);if(tenc){const tencKeyId=tenc.subarray(8,24);tencKeyId.some((b=>0!==b))||(logger.log(`[eme] Patching keyId in 'enc${isAudio?"a":"v"}>sinf>>tenc' box: ${Hex_hexDump(tencKeyId)} -> ${Hex_hexDump(keyId)}`),tenc.set(keyId,8))}}))}))}));return initSegment}(initSegment,decryptdata)),this.emitInitSegment=!0}generateInitSegment(initSegment){let{audioCodec,videoCodec}=this;if(null==initSegment||!initSegment.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const initData=this.initData=parseInitSegment(initSegment);initData.audio&&(audioCodec=getParsedTrackCodec(initData.audio,ElementaryStreamTypes_AUDIO)),initData.video&&(videoCodec=getParsedTrackCodec(initData.video,ElementaryStreamTypes_VIDEO));const tracks={};initData.audio&&initData.video?tracks.audiovideo={container:"video/mp4",codec:audioCodec+","+videoCodec,initSegment,id:"main"}:initData.audio?tracks.audio={container:"audio/mp4",codec:audioCodec,initSegment,id:"audio"}:initData.video?tracks.video={container:"video/mp4",codec:videoCodec,initSegment,id:"main"}:logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=tracks}remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset){var _initData,_initData2;let{initPTS,lastEndTime}=this;const result={audio:void 0,video:void 0,text:textTrack,id3:id3Track,initSegment:void 0};isFiniteNumber(lastEndTime)||(lastEndTime=this.lastEndTime=timeOffset||0);const data=videoTrack.samples;if(null==data||!data.length)return result;const initSegment={initPTS:void 0,timescale:1};let initData=this.initData;if(null!=(_initData=initData)&&_initData.length||(this.generateInitSegment(data),initData=this.initData),null==(_initData2=initData)||!_initData2.length)return logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),result;this.emitInitSegment&&(initSegment.tracks=this.initTracks,this.emitInitSegment=!1);const duration=function getDuration(data,initData){let rawDuration=0,videoDuration=0,audioDuration=0;const trafs=findBox(data,["moof","traf"]);for(let i=0;i<trafs.length;i++){const traf=trafs[i],tfhd=findBox(traf,["tfhd"])[0],track=initData[readUint32(tfhd,4)];if(!track)continue;const trackDefault=track.default,tfhdFlags=readUint32(tfhd,0)|(null==trackDefault?void 0:trackDefault.flags);let sampleDuration=null==trackDefault?void 0:trackDefault.duration;8&tfhdFlags&&(sampleDuration=readUint32(tfhd,2&tfhdFlags?12:8));const timescale=track.timescale||9e4,truns=findBox(traf,["trun"]);for(let j=0;j<truns.length;j++)rawDuration=computeRawDurationFromSamples(truns[j]),!rawDuration&&sampleDuration&&(rawDuration=sampleDuration*readUint32(truns[j],4)),track.type===ElementaryStreamTypes_VIDEO?videoDuration+=rawDuration/timescale:track.type===ElementaryStreamTypes_AUDIO&&(audioDuration+=rawDuration/timescale)}if(0===videoDuration&&0===audioDuration){let sidxDuration=0;const sidxs=findBox(data,["sidx"]);for(let i=0;i<sidxs.length;i++){const sidx=parseSegmentIndex(sidxs[i]);null!=sidx&&sidx.references&&(sidxDuration+=sidx.references.reduce(((dur,ref)=>dur+ref.info.duration||0),0))}return sidxDuration}return videoDuration||audioDuration}(data,initData),startDTS=function getStartDTS(initData,fmp4){return findBox(fmp4,["moof","traf"]).reduce(((result,traf)=>{const tfdt=findBox(traf,["tfdt"])[0],version=tfdt[0],start=findBox(traf,["tfhd"]).reduce(((result,tfhd)=>{const id=readUint32(tfhd,4),track=initData[id];if(track){let baseTime=readUint32(tfdt,4);if(1===version){if(baseTime===UINT32_MAX$1)return logger.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),result;baseTime*=UINT32_MAX$1+1,baseTime+=readUint32(tfdt,8)}const startTime=baseTime/(track.timescale||9e4);if(isFiniteNumber(startTime)&&(null===result||startTime<result))return startTime}return result}),null);return null!==start&&isFiniteNumber(start)&&(null===result||start<result)?start:result}),null)}(initData,data),decodeTime=null===startDTS?timeOffset:startDTS;(function isInvalidInitPts(initPTS,startDTS,timeOffset,duration){if(null===initPTS)return!0;const minDuration=Math.max(duration,1),startTime=startDTS-initPTS.baseTime/initPTS.timescale;return Math.abs(startTime-timeOffset)>minDuration}(initPTS,decodeTime,timeOffset,duration)||initSegment.timescale!==initPTS.timescale&&accurateTimeOffset)&&(initSegment.initPTS=decodeTime-timeOffset,initPTS&&1===initPTS.timescale&&logger.warn("Adjusting initPTS by "+(initSegment.initPTS-initPTS.baseTime)),this.initPTS=initPTS={baseTime:initSegment.initPTS,timescale:1});const startTime=audioTrack?decodeTime-initPTS.baseTime/initPTS.timescale:lastEndTime,endTime=startTime+duration;!function offsetStartDTS(initData,fmp4,timeOffset){findBox(fmp4,["moof","traf"]).forEach((traf=>{findBox(traf,["tfhd"]).forEach((tfhd=>{const id=readUint32(tfhd,4),track=initData[id];if(!track)return;const timescale=track.timescale||9e4;findBox(traf,["tfdt"]).forEach((tfdt=>{const version=tfdt[0],offset=timeOffset*timescale;if(offset){let baseMediaDecodeTime=readUint32(tfdt,4);if(0===version)baseMediaDecodeTime-=offset,baseMediaDecodeTime=Math.max(baseMediaDecodeTime,0),writeUint32(tfdt,4,baseMediaDecodeTime);else{baseMediaDecodeTime*=Math.pow(2,32),baseMediaDecodeTime+=readUint32(tfdt,8),baseMediaDecodeTime-=offset,baseMediaDecodeTime=Math.max(baseMediaDecodeTime,0);const upper=Math.floor(baseMediaDecodeTime/(UINT32_MAX$1+1)),lower=Math.floor(baseMediaDecodeTime%(UINT32_MAX$1+1));writeUint32(tfdt,4,upper),writeUint32(tfdt,8,lower)}}}))}))}))}(initData,data,initPTS.baseTime/initPTS.timescale),duration>0?this.lastEndTime=endTime:(logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const hasAudio=!!initData.audio,hasVideo=!!initData.video;let type="";hasAudio&&(type+="audio"),hasVideo&&(type+="video");const track={data1:data,startPTS:startTime,startDTS:startTime,endPTS:endTime,endDTS:endTime,type,hasAudio,hasVideo,nb:1,dropped:0};return result.audio="audio"===track.type?track:void 0,result.video="audio"!==track.type?track:void 0,result.initSegment=initSegment,result.id3=flushTextTrackMetadataCueSamples(id3Track,timeOffset,initPTS,initPTS),textTrack.samples.length&&(result.text=flushTextTrackUserdataCueSamples(textTrack,timeOffset,initPTS)),result}}},{demux:TSDemuxer,remux:MP4Remuxer},{demux:class AACDemuxer extends BaseAudioDemuxer{constructor(observer,config){super(),this.observer=void 0,this.config=void 0,this.observer=observer,this.config=config}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){super.resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:audioCodec,duration:trackDuration,inputTimeScale:9e4,dropped:0}}static probe(data){if(!data)return!1;const id3Data=getID3Data(data,0);let offset=(null==id3Data?void 0:id3Data.length)||0;if(probe(data,offset))return!1;for(let length=data.length;offset<length;offset++)if(probe$1(data,offset))return logger.log("ADTS sync word found !"),!0;return!1}canParse(data,offset){return function canParse$1(data,offset){return function canGetFrameLength(data,offset){return offset+5<data.length}(data,offset)&&isHeaderPattern$1(data,offset)&&getFullFrameLength(data,offset)<=data.length-offset}(data,offset)}appendFrame(track,data,offset){initTrackConfig(track,this.observer,data,offset,track.manifestCodec);const frame=appendFrame$2(track,data,offset,this.basePTS,this.frameIndex);if(frame&&0===frame.missing)return frame}},remux:MP4Remuxer},{demux:class MP3Demuxer extends BaseAudioDemuxer{resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){super.resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:audioCodec,duration:trackDuration,inputTimeScale:9e4,dropped:0}}static probe(data){if(!data)return!1;const id3Data=getID3Data(data,0);let offset=(null==id3Data?void 0:id3Data.length)||0;if(id3Data&&11===data[offset]&&119===data[offset+1]&&void 0!==getTimeStamp(id3Data)&&getAudioBSID(data,offset)<=16)return!1;for(let length=data.length;offset<length;offset++)if(probe(data,offset))return logger.log("MPEG Audio sync word found !"),!0;return!1}canParse(data,offset){return function canParse(data,offset){return isHeaderPattern(data,offset)&&4<=data.length-offset}(data,offset)}appendFrame(track,data,offset){if(null!==this.basePTS)return appendFrame$1(track,data,offset,this.basePTS,this.frameIndex)}},remux:MP4Remuxer}];muxConfig.splice(2,0,{demux:AC3Demuxer,remux:MP4Remuxer});class Transmuxer{constructor(observer,typeSupported,config,vendor,id){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=observer,this.typeSupported=typeSupported,this.config=config,this.vendor=vendor,this.id=id}configure(transmuxConfig){this.transmuxConfig=transmuxConfig,this.decrypter&&this.decrypter.reset()}push(data,decryptdata,chunkMeta,state){const stats=chunkMeta.transmuxing;stats.executeStart=now();let uintData=new Uint8Array(data);const{currentTransmuxState,transmuxConfig}=this;state&&(this.currentTransmuxState=state);const{contiguous,discontinuity,trackSwitch,accurateTimeOffset,timeOffset,initSegmentChange}=state||currentTransmuxState,{audioCodec,videoCodec,defaultInitPts,duration,initSegmentData}=transmuxConfig,keyData=function getEncryptionType(data,decryptData){let encryptionType=null;data.byteLength>0&&null!=(null==decryptData?void 0:decryptData.key)&&null!==decryptData.iv&&null!=decryptData.method&&(encryptionType=decryptData);return encryptionType}(uintData,decryptdata);if(keyData&&"AES-128"===keyData.method){const decrypter=this.getDecrypter();if(!decrypter.isSync())return this.decryptionPromise=decrypter.webCryptoDecrypt(uintData,keyData.key.buffer,keyData.iv.buffer).then((decryptedData=>{const result=this.push(decryptedData,null,chunkMeta);return this.decryptionPromise=null,result})),this.decryptionPromise;{let decryptedData=decrypter.softwareDecrypt(uintData,keyData.key.buffer,keyData.iv.buffer);if(chunkMeta.part>-1&&(decryptedData=decrypter.flush()),!decryptedData)return stats.executeEnd=now(),emptyResult(chunkMeta);uintData=new Uint8Array(decryptedData)}}const resetMuxers=this.needsProbing(discontinuity,trackSwitch);if(resetMuxers){const error=this.configureTransmuxer(uintData);if(error)return logger.warn(`[transmuxer] ${error.message}`),this.observer.emit(Events.ERROR,Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,error,reason:error.message}),stats.executeEnd=now(),emptyResult(chunkMeta)}(discontinuity||trackSwitch||initSegmentChange||resetMuxers)&&this.resetInitSegment(initSegmentData,audioCodec,videoCodec,duration,decryptdata),(discontinuity||initSegmentChange||resetMuxers)&&this.resetInitialTimestamp(defaultInitPts),contiguous||this.resetContiguity();const result=this.transmux(uintData,keyData,timeOffset,accurateTimeOffset,chunkMeta),currentState=this.currentTransmuxState;return currentState.contiguous=!0,currentState.discontinuity=!1,currentState.trackSwitch=!1,stats.executeEnd=now(),result}flush(chunkMeta){const stats=chunkMeta.transmuxing;stats.executeStart=now();const{decrypter,currentTransmuxState,decryptionPromise}=this;if(decryptionPromise)return decryptionPromise.then((()=>this.flush(chunkMeta)));const transmuxResults=[],{timeOffset}=currentTransmuxState;if(decrypter){const decryptedData=decrypter.flush();decryptedData&&transmuxResults.push(this.push(decryptedData,null,chunkMeta))}const{demuxer,remuxer}=this;if(!demuxer||!remuxer)return stats.executeEnd=now(),[emptyResult(chunkMeta)];const demuxResultOrPromise=demuxer.flush(timeOffset);return isPromise(demuxResultOrPromise)?demuxResultOrPromise.then((demuxResult=>(this.flushRemux(transmuxResults,demuxResult,chunkMeta),transmuxResults))):(this.flushRemux(transmuxResults,demuxResultOrPromise,chunkMeta),transmuxResults)}flushRemux(transmuxResults,demuxResult,chunkMeta){const{audioTrack,videoTrack,id3Track,textTrack}=demuxResult,{accurateTimeOffset,timeOffset}=this.currentTransmuxState;logger.log(`[transmuxer.ts]: Flushed fragment ${chunkMeta.sn}${chunkMeta.part>-1?" p: "+chunkMeta.part:""} of level ${chunkMeta.level}`);const remuxResult=this.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset,!0,this.id);transmuxResults.push({remuxResult,chunkMeta}),chunkMeta.transmuxing.executeEnd=now()}resetInitialTimestamp(defaultInitPts){const{demuxer,remuxer}=this;demuxer&&remuxer&&(demuxer.resetTimeStamp(defaultInitPts),remuxer.resetTimeStamp(defaultInitPts))}resetContiguity(){const{demuxer,remuxer}=this;demuxer&&remuxer&&(demuxer.resetContiguity(),remuxer.resetNextTimestamp())}resetInitSegment(initSegmentData,audioCodec,videoCodec,trackDuration,decryptdata){const{demuxer,remuxer}=this;demuxer&&remuxer&&(demuxer.resetInitSegment(initSegmentData,audioCodec,videoCodec,trackDuration),remuxer.resetInitSegment(initSegmentData,audioCodec,videoCodec,decryptdata))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(data,keyData,timeOffset,accurateTimeOffset,chunkMeta){let result;return result=keyData&&"SAMPLE-AES"===keyData.method?this.transmuxSampleAes(data,keyData,timeOffset,accurateTimeOffset,chunkMeta):this.transmuxUnencrypted(data,timeOffset,accurateTimeOffset,chunkMeta),result}transmuxUnencrypted(data,timeOffset,accurateTimeOffset,chunkMeta){const{audioTrack,videoTrack,id3Track,textTrack}=this.demuxer.demux(data,timeOffset,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset,!1,this.id),chunkMeta}}transmuxSampleAes(data,decryptData,timeOffset,accurateTimeOffset,chunkMeta){return this.demuxer.demuxSampleAes(data,decryptData,timeOffset).then((demuxResult=>({remuxResult:this.remuxer.remux(demuxResult.audioTrack,demuxResult.videoTrack,demuxResult.id3Track,demuxResult.textTrack,timeOffset,accurateTimeOffset,!1,this.id),chunkMeta})))}configureTransmuxer(data){const{config,observer,typeSupported,vendor}=this;let mux;for(let i=0,len=muxConfig.length;i<len;i++){var _muxConfig$i$demux;if(null!=(_muxConfig$i$demux=muxConfig[i].demux)&&_muxConfig$i$demux.probe(data)){mux=muxConfig[i];break}}if(!mux)return new Error("Failed to find demuxer by probing fragment data");const demuxer=this.demuxer,remuxer=this.remuxer,Remuxer=mux.remux,Demuxer=mux.demux;remuxer&&remuxer instanceof Remuxer||(this.remuxer=new Remuxer(observer,config,typeSupported,vendor)),demuxer&&demuxer instanceof Demuxer||(this.demuxer=new Demuxer(observer,config,typeSupported),this.probe=Demuxer.probe)}needsProbing(discontinuity,trackSwitch){return!this.demuxer||!this.remuxer||discontinuity||trackSwitch}getDecrypter(){let decrypter=this.decrypter;return decrypter||(decrypter=this.decrypter=new Decrypter(this.config)),decrypter}}const emptyResult=chunkMeta=>({remuxResult:{},chunkMeta});function isPromise(p){return"then"in p&&p.then instanceof Function}class TransmuxConfig{constructor(audioCodec,videoCodec,initSegmentData,duration,defaultInitPts){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=audioCodec,this.videoCodec=videoCodec,this.initSegmentData=initSegmentData,this.duration=duration,this.defaultInitPts=defaultInitPts||null}}class TransmuxState{constructor(discontinuity,contiguous,accurateTimeOffset,trackSwitch,timeOffset,initSegmentChange){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=discontinuity,this.contiguous=contiguous,this.accurateTimeOffset=accurateTimeOffset,this.trackSwitch=trackSwitch,this.timeOffset=timeOffset,this.initSegmentChange=initSegmentChange}}var eventemitter3={exports:{}};!function(module){var has=Object.prototype.hasOwnProperty,prefix="~";function Events(){}function EE(fn,context,once){this.fn=fn,this.context=context,this.once=once||!1}function addListener(emitter,event,fn,context,once){if("function"!=typeof fn)throw new TypeError("The listener must be a function");var listener=new EE(fn,context||emitter,once),evt=prefix?prefix+event:event;return emitter._events[evt]?emitter._events[evt].fn?emitter._events[evt]=[emitter._events[evt],listener]:emitter._events[evt].push(listener):(emitter._events[evt]=listener,emitter._eventsCount++),emitter}function clearEvent(emitter,evt){0==--emitter._eventsCount?emitter._events=new Events:delete emitter._events[evt]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(prefix=!1)),EventEmitter.prototype.eventNames=function eventNames(){var events,name,names=[];if(0===this._eventsCount)return names;for(name in events=this._events)has.call(events,name)&&names.push(prefix?name.slice(1):name);return Object.getOwnPropertySymbols?names.concat(Object.getOwnPropertySymbols(events)):names},EventEmitter.prototype.listeners=function listeners(event){var evt=prefix?prefix+event:event,handlers=this._events[evt];if(!handlers)return[];if(handlers.fn)return[handlers.fn];for(var i=0,l=handlers.length,ee=new Array(l);i<l;i++)ee[i]=handlers[i].fn;return ee},EventEmitter.prototype.listenerCount=function listenerCount(event){var evt=prefix?prefix+event:event,listeners=this._events[evt];return listeners?listeners.fn?1:listeners.length:0},EventEmitter.prototype.emit=function emit(event,a1,a2,a3,a4,a5){var evt=prefix?prefix+event:event;if(!this._events[evt])return!1;var args,i,listeners=this._events[evt],len=arguments.length;if(listeners.fn){switch(listeners.once&&this.removeListener(event,listeners.fn,void 0,!0),len){case 1:return listeners.fn.call(listeners.context),!0;case 2:return listeners.fn.call(listeners.context,a1),!0;case 3:return listeners.fn.call(listeners.context,a1,a2),!0;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),!0;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),!0;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),!0}for(i=1,args=new Array(len-1);i<len;i++)args[i-1]=arguments[i];listeners.fn.apply(listeners.context,args)}else{var j,length=listeners.length;for(i=0;i<length;i++)switch(listeners[i].once&&this.removeListener(event,listeners[i].fn,void 0,!0),len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;case 4:listeners[i].fn.call(listeners[i].context,a1,a2,a3);break;default:if(!args)for(j=1,args=new Array(len-1);j<len;j++)args[j-1]=arguments[j];listeners[i].fn.apply(listeners[i].context,args)}}return!0},EventEmitter.prototype.on=function on(event,fn,context){return addListener(this,event,fn,context,!1)},EventEmitter.prototype.once=function once(event,fn,context){return addListener(this,event,fn,context,!0)},EventEmitter.prototype.removeListener=function removeListener(event,fn,context,once){var evt=prefix?prefix+event:event;if(!this._events[evt])return this;if(!fn)return clearEvent(this,evt),this;var listeners=this._events[evt];if(listeners.fn)listeners.fn!==fn||once&&!listeners.once||context&&listeners.context!==context||clearEvent(this,evt);else{for(var i=0,events=[],length=listeners.length;i<length;i++)(listeners[i].fn!==fn||once&&!listeners[i].once||context&&listeners[i].context!==context)&&events.push(listeners[i]);events.length?this._events[evt]=1===events.length?events[0]:events:clearEvent(this,evt)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(event){var evt;return event?(evt=prefix?prefix+event:event,this._events[evt]&&clearEvent(this,evt)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,module.exports=EventEmitter}(eventemitter3);var EventEmitter=getDefaultExportFromCjs(eventemitter3.exports);class TransmuxerInterface{constructor(hls,id,onTransmuxComplete,onFlush){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const config=hls.config;this.hls=hls,this.id=id,this.useWorker=!!config.enableWorker,this.onTransmuxComplete=onTransmuxComplete,this.onFlush=onFlush;const forwardMessage=(ev,data)=>{(data=data||{}).frag=this.frag,data.id=this.id,ev===Events.ERROR&&(this.error=data.error),this.hls.trigger(ev,data)};this.observer=new EventEmitter,this.observer.on(Events.FRAG_DECRYPTED,forwardMessage),this.observer.on(Events.ERROR,forwardMessage);const MediaSource=getMediaSource(config.preferManagedMediaSource)||{isTypeSupported:()=>!1},m2tsTypeSupported={mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:MediaSource.isTypeSupported('audio/mp4; codecs="ac-3"')},vendor=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker){if(config.workerPath||function hasUMDWorker(){return"function"==typeof __HLS_WORKER_BUNDLE__}()){try{config.workerPath?(logger.log(`loading Web Worker ${config.workerPath} for "${id}"`),this.workerContext=function loadWorker(path){const scriptURL=new self.URL(path,self.location.href).href;return{worker:new self.Worker(scriptURL),scriptURL}}(config.workerPath)):(logger.log(`injecting Web Worker for "${id}"`),this.workerContext=function injectWorker(){const blob=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),objectURL=self.URL.createObjectURL(blob);return{worker:new self.Worker(objectURL),objectURL}}()),this.onwmsg=ev=>this.onWorkerMessage(ev);const{worker}=this.workerContext;worker.addEventListener("message",this.onwmsg),worker.onerror=event=>{const error=new Error(`${event.message}  (${event.filename}:${event.lineno})`);config.enableWorker=!1,logger.warn(`Error in "${id}" Web Worker, fallback to inline`),this.hls.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error})},worker.postMessage({cmd:"init",typeSupported:m2tsTypeSupported,vendor,id,config:JSON.stringify(config)})}catch(err){logger.warn(`Error setting up "${id}" Web Worker, fallback to inline`,err),this.resetWorker(),this.error=null,this.transmuxer=new Transmuxer(this.observer,m2tsTypeSupported,config,vendor,id)}return}}this.transmuxer=new Transmuxer(this.observer,m2tsTypeSupported,config,vendor,id)}resetWorker(){if(this.workerContext){const{worker,objectURL}=this.workerContext;objectURL&&self.URL.revokeObjectURL(objectURL),worker.removeEventListener("message",this.onwmsg),worker.onerror=null,worker.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const transmuxer=this.transmuxer;transmuxer&&(transmuxer.destroy(),this.transmuxer=null)}const observer=this.observer;observer&&observer.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(data,initSegmentData,audioCodec,videoCodec,frag,part,duration,accurateTimeOffset,chunkMeta,defaultInitPTS){var _frag$initSegment,_lastFrag$initSegment;chunkMeta.transmuxing.start=self.performance.now();const{transmuxer}=this,timeOffset=part?part.start:frag.start,decryptdata=frag.decryptdata,lastFrag=this.frag,discontinuity=!(lastFrag&&frag.cc===lastFrag.cc),trackSwitch=!(lastFrag&&chunkMeta.level===lastFrag.level),snDiff=lastFrag?chunkMeta.sn-lastFrag.sn:-1,partDiff=this.part?chunkMeta.part-this.part.index:-1,progressive=0===snDiff&&chunkMeta.id>1&&chunkMeta.id===(null==lastFrag?void 0:lastFrag.stats.chunkCount),contiguous=!trackSwitch&&(1===snDiff||0===snDiff&&(1===partDiff||progressive&&partDiff<=0)),now=self.performance.now();(trackSwitch||snDiff||0===frag.stats.parsing.start)&&(frag.stats.parsing.start=now),!part||!partDiff&&contiguous||(part.stats.parsing.start=now);const initSegmentChange=!(lastFrag&&(null==(_frag$initSegment=frag.initSegment)?void 0:_frag$initSegment.url)===(null==(_lastFrag$initSegment=lastFrag.initSegment)?void 0:_lastFrag$initSegment.url)),state=new TransmuxState(discontinuity,contiguous,accurateTimeOffset,trackSwitch,timeOffset,initSegmentChange);if(!contiguous||discontinuity||initSegmentChange){logger.log(`[transmuxer-interface, ${frag.type}]: Starting new transmux session for sn: ${chunkMeta.sn} p: ${chunkMeta.part} level: ${chunkMeta.level} id: ${chunkMeta.id}\n        discontinuity: ${discontinuity}\n        trackSwitch: ${trackSwitch}\n        contiguous: ${contiguous}\n        accurateTimeOffset: ${accurateTimeOffset}\n        timeOffset: ${timeOffset}\n        initSegmentChange: ${initSegmentChange}`);const config=new TransmuxConfig(audioCodec,videoCodec,initSegmentData,duration,defaultInitPTS);this.configureTransmuxer(config)}if(this.frag=frag,this.part=part,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data,decryptdata,chunkMeta,state},data instanceof ArrayBuffer?[data]:[]);else if(transmuxer){const transmuxResult=transmuxer.push(data,decryptdata,chunkMeta,state);isPromise(transmuxResult)?(transmuxer.async=!0,transmuxResult.then((data=>{this.handleTransmuxComplete(data)})).catch((error=>{this.transmuxerError(error,chunkMeta,"transmuxer-interface push error")}))):(transmuxer.async=!1,this.handleTransmuxComplete(transmuxResult))}}flush(chunkMeta){chunkMeta.transmuxing.start=self.performance.now();const{transmuxer}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta});else if(transmuxer){let transmuxResult=transmuxer.flush(chunkMeta);isPromise(transmuxResult)||transmuxer.async?(isPromise(transmuxResult)||(transmuxResult=Promise.resolve(transmuxResult)),transmuxResult.then((data=>{this.handleFlushResult(data,chunkMeta)})).catch((error=>{this.transmuxerError(error,chunkMeta,"transmuxer-interface flush error")}))):this.handleFlushResult(transmuxResult,chunkMeta)}}transmuxerError(error,chunkMeta,reason){this.hls&&(this.error=error,this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_PARSING_ERROR,chunkMeta,fatal:!1,error,err:error,reason}))}handleFlushResult(results,chunkMeta){results.forEach((result=>{this.handleTransmuxComplete(result)})),this.onFlush(chunkMeta)}onWorkerMessage(ev){const data=ev.data,hls=this.hls;switch(data.event){case"init":{var _this$workerContext;const objectURL=null==(_this$workerContext=this.workerContext)?void 0:_this$workerContext.objectURL;objectURL&&self.URL.revokeObjectURL(objectURL);break}case"transmuxComplete":this.handleTransmuxComplete(data.data);break;case"flush":this.onFlush(data.data);break;case"workerLog":logger[data.data.logType]&&logger[data.data.logType](data.data.message);break;default:data.data=data.data||{},data.data.frag=this.frag,data.data.id=this.id,hls.trigger(data.event,data.data)}}configureTransmuxer(config){const{transmuxer}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config}):transmuxer&&transmuxer.configure(config)}handleTransmuxComplete(result){result.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(result)}}function subtitleOptionsIdentical(trackList1,trackList2){if(trackList1.length!==trackList2.length)return!1;for(let i=0;i<trackList1.length;i++)if(!mediaAttributesIdentical(trackList1[i].attrs,trackList2[i].attrs))return!1;return!0}function mediaAttributesIdentical(attrs1,attrs2,customAttributes){const stableRenditionId=attrs1["STABLE-RENDITION-ID"];return stableRenditionId&&!customAttributes?stableRenditionId===attrs2["STABLE-RENDITION-ID"]:!(customAttributes||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some((subtitleAttribute=>attrs1[subtitleAttribute]!==attrs2[subtitleAttribute]))}function subtitleTrackMatchesTextTrack(subtitleTrack,textTrack){return textTrack.label.toLowerCase()===subtitleTrack.name.toLowerCase()&&(!textTrack.language||textTrack.language.toLowerCase()===(subtitleTrack.lang||"").toLowerCase())}class BufferableInstance{constructor(timeranges){this.buffered=void 0;const getRange=(name,index,length)=>{if((index>>>=0)>length-1)throw new DOMException(`Failed to execute '${name}' on 'TimeRanges': The index provided (${index}) is greater than the maximum bound (${length})`);return timeranges[index][name]};this.buffered={get length(){return timeranges.length},end:index=>getRange("end",index,timeranges.length),start:index=>getRange("start",index,timeranges.length)}}}class BufferOperationQueue{constructor(sourceBufferReference){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=sourceBufferReference}append(operation,type,pending){const queue=this.queues[type];queue.push(operation),1!==queue.length||pending||this.executeNext(type)}insertAbort(operation,type){this.queues[type].unshift(operation),this.executeNext(type)}appendBlocker(type){let execute;const promise=new Promise((resolve=>{execute=resolve})),operation={execute,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(operation,type),promise}executeNext(type){const queue=this.queues[type];if(queue.length){const operation=queue[0];try{operation.execute()}catch(error){logger.warn(`[buffer-operation-queue]: Exception executing "${type}" SourceBuffer operation: ${error}`),operation.onError(error);const sb=this.buffers[type];null!=sb&&sb.updating||this.shiftAndExecuteNext(type)}}}shiftAndExecuteNext(type){this.queues[type].shift(),this.executeNext(type)}current(type){return this.queues[type][0]}}const VIDEO_CODEC_PROFILE_REPLACE=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;function removeSourceChildren(node){const sourceChildren=node.querySelectorAll("source");[].slice.call(sourceChildren).forEach((source=>{node.removeChild(source)}))}const specialCea608CharsCodes={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},getCharForByte=function getCharForByte(byte){let charCode=byte;return specialCea608CharsCodes.hasOwnProperty(byte)&&(charCode=specialCea608CharsCodes[byte]),String.fromCharCode(charCode)},rowsLowCh1={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},rowsHighCh1={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rowsLowCh2={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},rowsHighCh2={25:2,26:4,29:6,30:8,31:10,27:13,28:15},backgroundColors=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class CaptionsLogger{constructor(){this.time=null,this.verboseLevel=0}log(severity,msg){if(this.verboseLevel>=severity){const m="function"==typeof msg?msg():msg;logger.log(`${this.time} [${severity}] ${m}`)}}}const numArrayToHexArray=function numArrayToHexArray(numArray){const hexArray=[];for(let j=0;j<numArray.length;j++)hexArray.push(numArray[j].toString(16));return hexArray};class PenState{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(styles){const attribs=["foreground","underline","italics","background","flash"];for(let i=0;i<attribs.length;i++){const style=attribs[i];styles.hasOwnProperty(style)&&(this[style]=styles[style])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(other){return this.foreground===other.foreground&&this.underline===other.underline&&this.italics===other.italics&&this.background===other.background&&this.flash===other.flash}copy(newPenState){this.foreground=newPenState.foreground,this.underline=newPenState.underline,this.italics=newPenState.italics,this.background=newPenState.background,this.flash=newPenState.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class StyledUnicodeChar{constructor(){this.uchar=" ",this.penState=new PenState}reset(){this.uchar=" ",this.penState.reset()}setChar(uchar,newPenState){this.uchar=uchar,this.penState.copy(newPenState)}setPenState(newPenState){this.penState.copy(newPenState)}equals(other){return this.uchar===other.uchar&&this.penState.equals(other.penState)}copy(newChar){this.uchar=newChar.uchar,this.penState.copy(newChar.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class Row{constructor(logger){this.chars=[],this.pos=0,this.currPenState=new PenState,this.cueStartTime=null,this.logger=void 0;for(let i=0;i<100;i++)this.chars.push(new StyledUnicodeChar);this.logger=logger}equals(other){for(let i=0;i<100;i++)if(!this.chars[i].equals(other.chars[i]))return!1;return!0}copy(other){for(let i=0;i<100;i++)this.chars[i].copy(other.chars[i])}isEmpty(){let empty=!0;for(let i=0;i<100;i++)if(!this.chars[i].isEmpty()){empty=!1;break}return empty}setCursor(absPos){this.pos!==absPos&&(this.pos=absPos),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=100)}moveCursor(relPos){const newPos=this.pos+relPos;if(relPos>1)for(let i=this.pos+1;i<newPos+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(newPos)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(byte){byte>=144&&this.backSpace();const char=getCharForByte(byte);this.pos>=100?this.logger.log(0,(()=>"Cannot insert "+byte.toString(16)+" ("+char+") at position "+this.pos+". Skipping it!")):(this.chars[this.pos].setChar(char,this.currPenState),this.moveCursor(1))}clearFromPos(startPos){let i;for(i=startPos;i<100;i++)this.chars[i].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const chars=[];let empty=!0;for(let i=0;i<100;i++){const char=this.chars[i].uchar;" "!==char&&(empty=!1),chars.push(char)}return empty?"":chars.join("")}setPenStyles(styles){this.currPenState.setStyles(styles);this.chars[this.pos].setPenState(this.currPenState)}}class CaptionScreen{constructor(logger){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let i=0;i<15;i++)this.rows.push(new Row(logger));this.logger=logger}reset(){for(let i=0;i<15;i++)this.rows[i].clear();this.currRow=14}equals(other){let equal=!0;for(let i=0;i<15;i++)if(!this.rows[i].equals(other.rows[i])){equal=!1;break}return equal}copy(other){for(let i=0;i<15;i++)this.rows[i].copy(other.rows[i])}isEmpty(){let empty=!0;for(let i=0;i<15;i++)if(!this.rows[i].isEmpty()){empty=!1;break}return empty}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(char){this.rows[this.currRow].insertChar(char)}setPen(styles){this.rows[this.currRow].setPenStyles(styles)}moveCursor(relPos){this.rows[this.currRow].moveCursor(relPos)}setCursor(absPos){this.logger.log(2,"setCursor: "+absPos);this.rows[this.currRow].setCursor(absPos)}setPAC(pacData){this.logger.log(2,(()=>"pacData = "+JSON.stringify(pacData)));let newRow=pacData.row-1;if(this.nrRollUpRows&&newRow<this.nrRollUpRows-1&&(newRow=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==newRow){for(let i=0;i<15;i++)this.rows[i].clear();const topRowIndex=this.currRow+1-this.nrRollUpRows,lastOutputScreen=this.lastOutputScreen;if(lastOutputScreen){const prevLineTime=lastOutputScreen.rows[topRowIndex].cueStartTime,time=this.logger.time;if(null!==prevLineTime&&null!==time&&prevLineTime<time)for(let i=0;i<this.nrRollUpRows;i++)this.rows[newRow-this.nrRollUpRows+i+1].copy(lastOutputScreen.rows[topRowIndex+i])}}this.currRow=newRow;const row=this.rows[this.currRow];if(null!==pacData.indent){const indent=pacData.indent,prevPos=Math.max(indent-1,0);row.setCursor(pacData.indent),pacData.color=row.chars[prevPos].penState.foreground}const styles={foreground:pacData.color,underline:pacData.underline,italics:pacData.italics,background:"black",flash:!1};this.setPen(styles)}setBkgData(bkgData){this.logger.log(2,(()=>"bkgData = "+JSON.stringify(bkgData))),this.backSpace(),this.setPen(bkgData),this.insertChar(32)}setRollUpRows(nrRows){this.nrRollUpRows=nrRows}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,(()=>this.getDisplayText()));const topRowIndex=this.currRow+1-this.nrRollUpRows,topRow=this.rows.splice(topRowIndex,1)[0];topRow.clear(),this.rows.splice(this.currRow,0,topRow),this.logger.log(2,"Rolling up")}getDisplayText(asOneRow){asOneRow=asOneRow||!1;const displayText=[];let text="",rowNr=-1;for(let i=0;i<15;i++){const rowText=this.rows[i].getTextString();rowText&&(rowNr=i+1,asOneRow?displayText.push("Row "+rowNr+": '"+rowText+"'"):displayText.push(rowText.trim()))}return displayText.length>0&&(text=asOneRow?"["+displayText.join(" | ")+"]":displayText.join("\n")),text}getTextAndFormat(){return this.rows}}class Cea608Channel{constructor(channelNumber,outputFilter,logger){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=channelNumber,this.outputFilter=outputFilter,this.mode=null,this.verbose=0,this.displayedMemory=new CaptionScreen(logger),this.nonDisplayedMemory=new CaptionScreen(logger),this.lastOutputScreen=new CaptionScreen(logger),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=logger}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(newHandler){this.outputFilter=newHandler}setPAC(pacData){this.writeScreen.setPAC(pacData)}setBkgData(bkgData){this.writeScreen.setBkgData(bkgData)}setMode(newMode){newMode!==this.mode&&(this.mode=newMode,this.logger.log(2,(()=>"MODE="+newMode)),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=newMode)}insertChars(chars){for(let i=0;i<chars.length;i++)this.writeScreen.insertChar(chars[i]);const screen=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(()=>screen+": "+this.writeScreen.getDisplayText(!0))),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0))),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(nrRows){this.logger.log(2,"RU("+nrRows+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(nrRows)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const tmp=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=tmp,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(()=>"DISP: "+this.displayedMemory.getDisplayText()))}this.outputDataUpdate(!0)}ccTO(nrCols){this.logger.log(2,"TO("+nrCols+") - Tab Offset"),this.writeScreen.moveCursor(nrCols)}ccMIDROW(secondByte){const styles={flash:!1};if(styles.underline=secondByte%2==1,styles.italics=secondByte>=46,styles.italics)styles.foreground="white";else{const colorIndex=Math.floor(secondByte/2)-16,colors=["white","green","blue","cyan","red","yellow","magenta"];styles.foreground=colors[colorIndex]}this.logger.log(2,"MIDROW: "+JSON.stringify(styles)),this.writeScreen.setPen(styles)}outputDataUpdate(dispatch=!1){const time=this.logger.time;null!==time&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,time,this.lastOutputScreen),dispatch&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:time):this.cueStartTime=time,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))}}class Cea608Parser{constructor(field,out1,out2){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const logger=this.logger=new CaptionsLogger;this.channels=[null,new Cea608Channel(field,out1,logger),new Cea608Channel(field+1,out2,logger)]}getHandler(channel){return this.channels[channel].getHandler()}setHandler(channel,newHandler){this.channels[channel].setHandler(newHandler)}addData(time,byteList){let cmdFound,a,b,charsFound=!1;this.logger.time=time;for(let i=0;i<byteList.length;i+=2)if(a=127&byteList[i],b=127&byteList[i+1],0!==a||0!==b){if(this.logger.log(3,"["+numArrayToHexArray([byteList[i],byteList[i+1]])+"] -> ("+numArrayToHexArray([a,b])+")"),cmdFound=this.parseCmd(a,b),cmdFound||(cmdFound=this.parseMidrow(a,b)),cmdFound||(cmdFound=this.parsePAC(a,b)),cmdFound||(cmdFound=this.parseBackgroundAttributes(a,b)),!cmdFound&&(charsFound=this.parseChars(a,b),charsFound)){const currChNr=this.currentChannel;if(currChNr&&currChNr>0){this.channels[currChNr].insertChars(charsFound)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}cmdFound||charsFound||this.logger.log(2,"Couldn't parse cleaned data "+numArrayToHexArray([a,b])+" orig: "+numArrayToHexArray([byteList[i],byteList[i+1]]))}}parseCmd(a,b){const{cmdHistory}=this;if(!((20===a||28===a||21===a||29===a)&&b>=32&&b<=47)&&!((23===a||31===a)&&b>=33&&b<=35))return!1;if(hasCmdRepeated(a,b,cmdHistory))return setLastCmd(null,null,cmdHistory),this.logger.log(3,"Repeated command ("+numArrayToHexArray([a,b])+") is dropped"),!0;const chNr=20===a||21===a||23===a?1:2,channel=this.channels[chNr];return 20===a||21===a||28===a||29===a?32===b?channel.ccRCL():33===b?channel.ccBS():34===b?channel.ccAOF():35===b?channel.ccAON():36===b?channel.ccDER():37===b?channel.ccRU(2):38===b?channel.ccRU(3):39===b?channel.ccRU(4):40===b?channel.ccFON():41===b?channel.ccRDC():42===b?channel.ccTR():43===b?channel.ccRTD():44===b?channel.ccEDM():45===b?channel.ccCR():46===b?channel.ccENM():47===b&&channel.ccEOC():channel.ccTO(b-32),setLastCmd(a,b,cmdHistory),this.currentChannel=chNr,!0}parseMidrow(a,b){let chNr=0;if((17===a||25===a)&&b>=32&&b<=47){if(chNr=17===a?1:2,chNr!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const channel=this.channels[chNr];return!!channel&&(channel.ccMIDROW(b),this.logger.log(3,"MIDROW ("+numArrayToHexArray([a,b])+")"),!0)}return!1}parsePAC(a,b){let row;const cmdHistory=this.cmdHistory;if(!((a>=17&&a<=23||a>=25&&a<=31)&&b>=64&&b<=127)&&!((16===a||24===a)&&b>=64&&b<=95))return!1;if(hasCmdRepeated(a,b,cmdHistory))return setLastCmd(null,null,cmdHistory),!0;const chNr=a<=23?1:2;row=b>=64&&b<=95?1===chNr?rowsLowCh1[a]:rowsLowCh2[a]:1===chNr?rowsHighCh1[a]:rowsHighCh2[a];const channel=this.channels[chNr];return!!channel&&(channel.setPAC(this.interpretPAC(row,b)),setLastCmd(a,b,cmdHistory),this.currentChannel=chNr,!0)}interpretPAC(row,byte){let pacIndex;const pacData={color:null,italics:!1,indent:null,underline:!1,row};return pacIndex=byte>95?byte-96:byte-64,pacData.underline=1==(1&pacIndex),pacIndex<=13?pacData.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(pacIndex/2)]:pacIndex<=15?(pacData.italics=!0,pacData.color="white"):pacData.indent=4*Math.floor((pacIndex-16)/2),pacData}parseChars(a,b){let channelNr,charCodes=null,charCode1=null;if(a>=25?(channelNr=2,charCode1=a-8):(channelNr=1,charCode1=a),charCode1>=17&&charCode1<=19){let oneCode;oneCode=17===charCode1?b+80:18===charCode1?b+112:b+144,this.logger.log(2,"Special char '"+getCharForByte(oneCode)+"' in channel "+channelNr),charCodes=[oneCode]}else a>=32&&a<=127&&(charCodes=0===b?[a]:[a,b]);if(charCodes){const hexCodes=numArrayToHexArray(charCodes);this.logger.log(3,"Char codes =  "+hexCodes.join(",")),setLastCmd(a,b,this.cmdHistory)}return charCodes}parseBackgroundAttributes(a,b){if(!((16===a||24===a)&&b>=32&&b<=47)&&!((23===a||31===a)&&b>=45&&b<=47))return!1;let index;const bkgData={};16===a||24===a?(index=Math.floor((b-32)/2),bkgData.background=backgroundColors[index],b%2==1&&(bkgData.background=bkgData.background+"_semi")):45===b?bkgData.background="transparent":(bkgData.foreground="black",47===b&&(bkgData.underline=!0));const chNr=a<=23?1:2;return this.channels[chNr].setBkgData(bkgData),setLastCmd(a,b,this.cmdHistory),!0}reset(){for(let i=0;i<Object.keys(this.channels).length;i++){const channel=this.channels[i];channel&&channel.reset()}this.cmdHistory={a:null,b:null}}cueSplitAtTime(t){for(let i=0;i<this.channels.length;i++){const channel=this.channels[i];channel&&channel.cueSplitAtTime(t)}}}function setLastCmd(a,b,cmdHistory){cmdHistory.a=a,cmdHistory.b=b}function hasCmdRepeated(a,b,cmdHistory){return cmdHistory.a===a&&cmdHistory.b===b}class OutputFilter{constructor(timelineController,trackName){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=timelineController,this.trackName=trackName}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(startTime,endTime,screen){(null===this.startTime||this.startTime>startTime)&&(this.startTime=startTime),this.endTime=endTime,this.screen=screen,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var VTTCue=function(){if(null!=optionalSelf&&optionalSelf.VTTCue)return self.VTTCue;const AllowedDirections=["","lr","rl"],AllowedAlignments=["start","middle","end","left","right"];function isAllowedValue(allowed,value){if("string"!=typeof value)return!1;if(!Array.isArray(allowed))return!1;const lcValue=value.toLowerCase();return!!~allowed.indexOf(lcValue)&&lcValue}function findAlignSetting(value){return isAllowedValue(AllowedAlignments,value)}function extend(obj,...rest){let i=1;for(;i<arguments.length;i++){const cobj=arguments[i];for(const p in cobj)obj[p]=cobj[p]}return obj}function VTTCue(startTime,endTime,text){const cue=this,baseObj={enumerable:!0};cue.hasBeenReset=!1;let _id="",_pauseOnExit=!1,_startTime=startTime,_endTime=endTime,_text=text,_region=null,_vertical="",_snapToLines=!0,_line="auto",_lineAlign="start",_position=50,_positionAlign="middle",_size=50,_align="middle";Object.defineProperty(cue,"id",extend({},baseObj,{get:function(){return _id},set:function(value){_id=""+value}})),Object.defineProperty(cue,"pauseOnExit",extend({},baseObj,{get:function(){return _pauseOnExit},set:function(value){_pauseOnExit=!!value}})),Object.defineProperty(cue,"startTime",extend({},baseObj,{get:function(){return _startTime},set:function(value){if("number"!=typeof value)throw new TypeError("Start time must be set to a number.");_startTime=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"endTime",extend({},baseObj,{get:function(){return _endTime},set:function(value){if("number"!=typeof value)throw new TypeError("End time must be set to a number.");_endTime=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"text",extend({},baseObj,{get:function(){return _text},set:function(value){_text=""+value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"region",extend({},baseObj,{get:function(){return _region},set:function(value){_region=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"vertical",extend({},baseObj,{get:function(){return _vertical},set:function(value){const setting=function findDirectionSetting(value){return isAllowedValue(AllowedDirections,value)}(value);if(!1===setting)throw new SyntaxError("An invalid or illegal string was specified.");_vertical=setting,this.hasBeenReset=!0}})),Object.defineProperty(cue,"snapToLines",extend({},baseObj,{get:function(){return _snapToLines},set:function(value){_snapToLines=!!value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"line",extend({},baseObj,{get:function(){return _line},set:function(value){if("number"!=typeof value&&"auto"!==value)throw new SyntaxError("An invalid number or illegal string was specified.");_line=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"lineAlign",extend({},baseObj,{get:function(){return _lineAlign},set:function(value){const setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_lineAlign=setting,this.hasBeenReset=!0}})),Object.defineProperty(cue,"position",extend({},baseObj,{get:function(){return _position},set:function(value){if(value<0||value>100)throw new Error("Position must be between 0 and 100.");_position=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"positionAlign",extend({},baseObj,{get:function(){return _positionAlign},set:function(value){const setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_positionAlign=setting,this.hasBeenReset=!0}})),Object.defineProperty(cue,"size",extend({},baseObj,{get:function(){return _size},set:function(value){if(value<0||value>100)throw new Error("Size must be between 0 and 100.");_size=value,this.hasBeenReset=!0}})),Object.defineProperty(cue,"align",extend({},baseObj,{get:function(){return _align},set:function(value){const setting=findAlignSetting(value);if(!setting)throw new SyntaxError("An invalid or illegal string was specified.");_align=setting,this.hasBeenReset=!0}})),cue.displayState=void 0}return VTTCue.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},VTTCue}();class StringDecoder{decode(data,options){if(!data)return"";if("string"!=typeof data)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(data))}}function parseTimeStamp(input){function computeSeconds(h,m,s,f){return 3600*(0|h)+60*(0|m)+(0|s)+parseFloat(f||0)}const m=input.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return m?parseFloat(m[2])>59?computeSeconds(m[2],m[3],0,m[4]):computeSeconds(m[1],m[2],m[3],m[4]):null}class Settings{constructor(){this.values=Object.create(null)}set(k,v){this.get(k)||""===v||(this.values[k]=v)}get(k,dflt,defaultKey){return defaultKey?this.has(k)?this.values[k]:dflt[defaultKey]:this.has(k)?this.values[k]:dflt}has(k){return k in this.values}alt(k,v,a){for(let n=0;n<a.length;++n)if(v===a[n]){this.set(k,v);break}}integer(k,v){/^-?\d+$/.test(v)&&this.set(k,parseInt(v,10))}percent(k,v){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(v)){const percent=parseFloat(v);if(percent>=0&&percent<=100)return this.set(k,percent),!0}return!1}}function parseOptions(input,callback,keyValueDelim,groupDelim){const groups=groupDelim?input.split(groupDelim):[input];for(const i in groups){if("string"!=typeof groups[i])continue;const kv=groups[i].split(keyValueDelim);if(2!==kv.length)continue;callback(kv[0],kv[1])}}const defaults=new VTTCue(0,0,""),center="middle"===defaults.align?"middle":"center";function parseCue(input,cue,regionList){const oInput=input;function consumeTimeStamp(){const ts=parseTimeStamp(input);if(null===ts)throw new Error("Malformed timestamp: "+oInput);return input=input.replace(/^[^\sa-zA-Z-]+/,""),ts}function skipWhitespace(){input=input.replace(/^\s+/,"")}if(skipWhitespace(),cue.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==input.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+oInput);input=input.slice(3),skipWhitespace(),cue.endTime=consumeTimeStamp(),skipWhitespace(),function consumeCueSettings(input,cue){const settings=new Settings;parseOptions(input,(function(k,v){let vals;switch(k){case"region":for(let i=regionList.length-1;i>=0;i--)if(regionList[i].id===v){settings.set(k,regionList[i].region);break}break;case"vertical":settings.alt(k,v,["rl","lr"]);break;case"line":vals=v.split(","),settings.integer(k,vals[0]),settings.percent(k,vals[0])&&settings.set("snapToLines",!1),settings.alt(k,vals[0],["auto"]),2===vals.length&&settings.alt("lineAlign",vals[1],["start",center,"end"]);break;case"position":vals=v.split(","),settings.percent(k,vals[0]),2===vals.length&&settings.alt("positionAlign",vals[1],["start",center,"end","line-left","line-right","auto"]);break;case"size":settings.percent(k,v);break;case"align":settings.alt(k,v,["start",center,"end","left","right"])}}),/:/,/\s/),cue.region=settings.get("region",null),cue.vertical=settings.get("vertical","");let line=settings.get("line","auto");"auto"===line&&-1===defaults.line&&(line=-1),cue.line=line,cue.lineAlign=settings.get("lineAlign","start"),cue.snapToLines=settings.get("snapToLines",!0),cue.size=settings.get("size",100),cue.align=settings.get("align",center);let position=settings.get("position","auto");"auto"===position&&50===defaults.position&&(position="start"===cue.align||"left"===cue.align?0:"end"===cue.align||"right"===cue.align?100:50),cue.position=position}(input,cue)}function fixLineBreaks(input){return input.replace(/<br(?: \/)?>/gi,"\n")}class VTTParser{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new StringDecoder,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(data){const _this=this;function collectNextLine(){let buffer=_this.buffer,pos=0;for(buffer=fixLineBreaks(buffer);pos<buffer.length&&"\r"!==buffer[pos]&&"\n"!==buffer[pos];)++pos;const line=buffer.slice(0,pos);return"\r"===buffer[pos]&&++pos,"\n"===buffer[pos]&&++pos,_this.buffer=buffer.slice(pos),line}data&&(_this.buffer+=_this.decoder.decode(data,{stream:!0}));try{let line="";if("INITIAL"===_this.state){if(!/\r\n|\n/.test(_this.buffer))return this;line=collectNextLine();const m=line.match(/^()?WEBVTT([ \t].*)?$/);if(null==m||!m[0])throw new Error("Malformed WebVTT signature.");_this.state="HEADER"}let alreadyCollectedLine=!1;for(;_this.buffer;){if(!/\r\n|\n/.test(_this.buffer))return this;switch(alreadyCollectedLine?alreadyCollectedLine=!1:line=collectNextLine(),_this.state){case"HEADER":/:/.test(line)?parseOptions(line,(function(k,v){}),/:/):line||(_this.state="ID");continue;case"NOTE":line||(_this.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(line)){_this.state="NOTE";break}if(!line)continue;if(_this.cue=new VTTCue(0,0,""),_this.state="CUE",-1===line.indexOf("--\x3e")){_this.cue.id=line;continue}case"CUE":if(!_this.cue){_this.state="BADCUE";continue}try{parseCue(line,_this.cue,_this.regionList)}catch(e){_this.cue=null,_this.state="BADCUE";continue}_this.state="CUETEXT";continue;case"CUETEXT":{const hasSubstring=-1!==line.indexOf("--\x3e");if(!line||hasSubstring&&(alreadyCollectedLine=!0)){_this.oncue&&_this.cue&&_this.oncue(_this.cue),_this.cue=null,_this.state="ID";continue}if(null===_this.cue)continue;_this.cue.text&&(_this.cue.text+="\n"),_this.cue.text+=line}continue;case"BADCUE":line||(_this.state="ID")}}}catch(e){"CUETEXT"===_this.state&&_this.cue&&_this.oncue&&_this.oncue(_this.cue),_this.cue=null,_this.state="INITIAL"===_this.state?"BADWEBVTT":"BADCUE"}return this}flush(){const _this=this;try{if((_this.cue||"HEADER"===_this.state)&&(_this.buffer+="\n\n",_this.parse()),"INITIAL"===_this.state||"BADWEBVTT"===_this.state)throw new Error("Malformed WebVTT signature.")}catch(e){_this.onparsingerror&&_this.onparsingerror(e)}return _this.onflush&&_this.onflush(),this}}const LINEBREAKS=/\r\n|\n\r|\n|\r/g,startsWith=function startsWith(inputString,searchString,position=0){return inputString.slice(position,position+searchString.length)===searchString},hash=function hash(text){let _hash=5381,i=text.length;for(;i;)_hash=33*_hash^text.charCodeAt(--i);return(_hash>>>0).toString()};function generateCueId(startTime,endTime,text){return hash(startTime.toString())+hash(endTime.toString())+hash(text)}function parseWebVTT(vttByteArray,initPTS,vttCCs,cc,timeOffset,callBack,errorCallBack){const parser=new VTTParser,vttLines=utf8ArrayToStr(new Uint8Array(vttByteArray)).trim().replace(LINEBREAKS,"\n").split("\n"),cues=[],init90kHz=initPTS?function toMpegTsClockFromTimescale(baseTime,srcScale=1){return toTimescaleFromBase(baseTime,MPEG_TS_CLOCK_FREQ_HZ,1/srcScale)}(initPTS.baseTime,initPTS.timescale):0;let parsingError,cueTime="00:00.000",timestampMapMPEGTS=0,timestampMapLOCAL=0,inHeader=!0;parser.oncue=function(cue){const currCC=vttCCs[cc];let cueOffset=vttCCs.ccOffset;const webVttMpegTsMapOffset=(timestampMapMPEGTS-init90kHz)/9e4;if(null!=currCC&&currCC.new&&(void 0!==timestampMapLOCAL?cueOffset=vttCCs.ccOffset=currCC.start:function calculateOffset(vttCCs,cc,presentationTime){let currCC=vttCCs[cc],prevCC=vttCCs[currCC.prevCC];if(!prevCC||!prevCC.new&&currCC.new)return vttCCs.ccOffset=vttCCs.presentationOffset=currCC.start,void(currCC.new=!1);for(;null!=(_prevCC=prevCC)&&_prevCC.new;){var _prevCC;vttCCs.ccOffset+=currCC.start-prevCC.start,currCC.new=!1,currCC=prevCC,prevCC=vttCCs[currCC.prevCC]}vttCCs.presentationOffset=presentationTime}(vttCCs,cc,webVttMpegTsMapOffset)),webVttMpegTsMapOffset){if(!initPTS)return void(parsingError=new Error("Missing initPTS for VTT MPEGTS"));cueOffset=webVttMpegTsMapOffset-vttCCs.presentationOffset}const duration=cue.endTime-cue.startTime,startTime=normalizePts(9e4*(cue.startTime+cueOffset-timestampMapLOCAL),9e4*timeOffset)/9e4;cue.startTime=Math.max(startTime,0),cue.endTime=Math.max(startTime+duration,0);const text=cue.text.trim();cue.text=decodeURIComponent(encodeURIComponent(text)),cue.id||(cue.id=generateCueId(cue.startTime,cue.endTime,text)),cue.endTime>0&&cues.push(cue)},parser.onparsingerror=function(error){parsingError=error},parser.onflush=function(){parsingError?errorCallBack(parsingError):callBack(cues)},vttLines.forEach((line=>{if(inHeader){if(startsWith(line,"X-TIMESTAMP-MAP=")){inHeader=!1,line.slice(16).split(",").forEach((timestamp=>{startsWith(timestamp,"LOCAL:")?cueTime=timestamp.slice(6):startsWith(timestamp,"MPEGTS:")&&(timestampMapMPEGTS=parseInt(timestamp.slice(7)))}));try{timestampMapLOCAL=function cueString2millis(timeString){let ts=parseInt(timeString.slice(-3));const secs=parseInt(timeString.slice(-6,-4)),mins=parseInt(timeString.slice(-9,-7)),hours=timeString.length>9?parseInt(timeString.substring(0,timeString.indexOf(":"))):0;if(!(isFiniteNumber(ts)&&isFiniteNumber(secs)&&isFiniteNumber(mins)&&isFiniteNumber(hours)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${timeString}`);return ts+=1e3*secs,ts+=6e4*mins,ts+=36e5*hours,ts}(cueTime)/1e3}catch(error){parsingError=error}return}""===line&&(inHeader=!1)}parser.parse(line+"\n")})),parser.flush()}const HMSF_REGEX=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,TIME_UNIT_REGEX=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,textAlignToLineAlign={left:"start",center:"center",right:"end",start:"start",end:"end"};function parseIMSC1(payload,initPTS,callBack,errorCallBack){const results=findBox(new Uint8Array(payload),["mdat"]);if(0===results.length)return void errorCallBack(new Error("Could not parse IMSC1 mdat"));const ttmlList=results.map((mdat=>utf8ArrayToStr(mdat))),syncTime=function toTimescaleFromScale(baseTime,destScale,srcScale=1,round=!1){return toTimescaleFromBase(baseTime,destScale,1/srcScale,round)}(initPTS.baseTime,1,initPTS.timescale);try{ttmlList.forEach((ttml=>callBack(function parseTTML(ttml,syncTime){const xmlDoc=(new DOMParser).parseFromString(ttml,"text/xml"),tt=xmlDoc.getElementsByTagName("tt")[0];if(!tt)throw new Error("Invalid ttml");const defaultRateInfo={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},rateInfo=Object.keys(defaultRateInfo).reduce(((result,key)=>(result[key]=tt.getAttribute(`ttp:${key}`)||defaultRateInfo[key],result)),{}),trim="preserve"!==tt.getAttribute("xml:space"),styleElements=collectionToDictionary(getElementCollection(tt,"styling","style")),regionElements=collectionToDictionary(getElementCollection(tt,"layout","region")),cueElements=getElementCollection(tt,"body","[begin]");return[].map.call(cueElements,(cueElement=>{const cueText=getTextContent(cueElement,trim);if(!cueText||!cueElement.hasAttribute("begin"))return null;const startTime=parseTtmlTime(cueElement.getAttribute("begin"),rateInfo),duration=parseTtmlTime(cueElement.getAttribute("dur"),rateInfo);let endTime=parseTtmlTime(cueElement.getAttribute("end"),rateInfo);if(null===startTime)throw timestampParsingError(cueElement);if(null===endTime){if(null===duration)throw timestampParsingError(cueElement);endTime=startTime+duration}const cue=new VTTCue(startTime-syncTime,endTime-syncTime,cueText);cue.id=generateCueId(cue.startTime,cue.endTime,cue.text);const styles=function getTtmlStyles(region,style,styleElements){const ttsNs="http://www.w3.org/ns/ttml#styling";let regionStyle=null;const styleAttributes=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],regionStyleName=null!=region&&region.hasAttribute("style")?region.getAttribute("style"):null;regionStyleName&&styleElements.hasOwnProperty(regionStyleName)&&(regionStyle=styleElements[regionStyleName]);return styleAttributes.reduce(((styles,name)=>{const value=getAttributeNS(style,ttsNs,name)||getAttributeNS(region,ttsNs,name)||getAttributeNS(regionStyle,ttsNs,name);return value&&(styles[name]=value),styles}),{})}(regionElements[cueElement.getAttribute("region")],styleElements[cueElement.getAttribute("style")],styleElements),{textAlign}=styles;if(textAlign){const lineAlign=textAlignToLineAlign[textAlign];lineAlign&&(cue.lineAlign=lineAlign),cue.align=textAlign}return _extends(cue,styles),cue})).filter((cue=>null!==cue))}(ttml,syncTime))))}catch(error){errorCallBack(error)}}function getElementCollection(fromElement,parentName,childName){const parent=fromElement.getElementsByTagName(parentName)[0];return parent?[].slice.call(parent.querySelectorAll(childName)):[]}function collectionToDictionary(elementsWithId){return elementsWithId.reduce(((dict,element)=>{const id=element.getAttribute("xml:id");return id&&(dict[id]=element),dict}),{})}function getTextContent(element,trim){return[].slice.call(element.childNodes).reduce(((str,node,i)=>{var _node$childNodes;return"br"===node.nodeName&&i?str+"\n":null!=(_node$childNodes=node.childNodes)&&_node$childNodes.length?getTextContent(node,trim):trim?str+node.textContent.trim().replace(/\s+/g," "):str+node.textContent}),"")}function getAttributeNS(element,ns,name){return element&&element.hasAttributeNS(ns,name)?element.getAttributeNS(ns,name):null}function timestampParsingError(node){return new Error(`Could not parse ttml timestamp ${node}`)}function parseTtmlTime(timeAttributeValue,rateInfo){if(!timeAttributeValue)return null;let seconds=parseTimeStamp(timeAttributeValue);return null===seconds&&(HMSF_REGEX.test(timeAttributeValue)?seconds=function parseHoursMinutesSecondsFrames(timeAttributeValue,rateInfo){const m=HMSF_REGEX.exec(timeAttributeValue),frames=(0|m[4])+(0|m[5])/rateInfo.subFrameRate;return 3600*(0|m[1])+60*(0|m[2])+(0|m[3])+frames/rateInfo.frameRate}(timeAttributeValue,rateInfo):TIME_UNIT_REGEX.test(timeAttributeValue)&&(seconds=function parseTimeUnits(timeAttributeValue,rateInfo){const m=TIME_UNIT_REGEX.exec(timeAttributeValue),value=Number(m[1]);switch(m[2]){case"h":return 3600*value;case"m":return 60*value;case"ms":return 1e3*value;case"f":return value/rateInfo.frameRate;case"t":return value/rateInfo.tickRate}return value}(timeAttributeValue,rateInfo))),seconds}function captionsOrSubtitlesFromCharacteristics(track){return track.characteristics&&/transcribes-spoken-dialog/gi.test(track.characteristics)&&/describes-music-and-sound/gi.test(track.characteristics)?"captions":"subtitles"}function canReuseVttTextTrack(inUseTrack,manifestTrack){return!!inUseTrack&&inUseTrack.kind===captionsOrSubtitlesFromCharacteristics(manifestTrack)&&subtitleTrackMatchesTextTrack(manifestTrack,inUseTrack)}class CapLevelController{constructor(hls){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=hls,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(streamController){this.streamController=streamController}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls}=this;hls.on(Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),hls.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events.BUFFER_CODECS,this.onBufferCodecs,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls}=this;hls.off(Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),hls.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events.BUFFER_CODECS,this.onBufferCodecs,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(event,data){const level=this.hls.levels[data.droppedLevel];this.isLevelAllowed(level)&&this.restrictedLevels.push({bitrate:level.bitrate,height:level.height,width:level.width})}onMediaAttaching(event,data){this.media=data.media instanceof HTMLVideoElement?data.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(event,data){const hls=this.hls;this.restrictedLevels=[],this.firstLevel=data.firstLevel,hls.config.capLevelToPlayerSize&&data.video&&this.startCapping()}onLevelsUpdated(event,data){this.timer&&isFiniteNumber(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(event,data){this.hls.config.capLevelToPlayerSize&&data.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const levels=this.hls.levels;if(levels.length){const hls=this.hls,maxLevel=this.getMaxLevel(levels.length-1);maxLevel!==this.autoLevelCapping&&logger.log(`Setting autoLevelCapping to ${maxLevel}: ${levels[maxLevel].height}p@${levels[maxLevel].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),hls.autoLevelCapping=maxLevel,hls.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=hls.autoLevelCapping}}}getMaxLevel(capLevelIndex){const levels=this.hls.levels;if(!levels.length)return-1;const validLevels=levels.filter(((level,index)=>this.isLevelAllowed(level)&&index<=capLevelIndex));return this.clientRect=null,CapLevelController.getMaxLevelByMediaSize(validLevels,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const media=this.media,boundsRect={width:0,height:0};if(media){const clientRect=media.getBoundingClientRect();boundsRect.width=clientRect.width,boundsRect.height=clientRect.height,boundsRect.width||boundsRect.height||(boundsRect.width=clientRect.right-clientRect.left||media.width||0,boundsRect.height=clientRect.bottom-clientRect.top||media.height||0)}return this.clientRect=boundsRect,boundsRect}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let pixelRatio=1;if(!this.hls.config.ignoreDevicePixelRatio)try{pixelRatio=self.devicePixelRatio}catch(e){}return pixelRatio}isLevelAllowed(level){return!this.restrictedLevels.some((restrictedLevel=>level.bitrate===restrictedLevel.bitrate&&level.width===restrictedLevel.width&&level.height===restrictedLevel.height))}static getMaxLevelByMediaSize(levels,width,height){if(null==levels||!levels.length)return-1;let maxLevelIndex=levels.length-1;const squareSize=Math.max(width,height);for(let i=0;i<levels.length;i+=1){const level=levels[i];if((level.width>=squareSize||level.height>=squareSize)&&(curLevel=level,!(nextLevel=levels[i+1])||curLevel.width!==nextLevel.width||curLevel.height!==nextLevel.height)){maxLevelIndex=i;break}}var curLevel,nextLevel;return maxLevelIndex}}class EMEController{constructor(hls){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=EMEController.CDMCleanupPromise?[EMEController.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=logger.debug.bind(logger,"[eme]"),this.log=logger.log.bind(logger,"[eme]"),this.warn=logger.warn.bind(logger,"[eme]"),this.error=logger.error.bind(logger,"[eme]"),this.hls=hls,this.config=hls.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const config=this.config;config.requestMediaKeySystemAccessFunc=null,config.licenseXhrSetup=config.licenseResponseCallback=void 0,config.drmSystems=config.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Events.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(keySystem){const{drmSystems,widevineLicenseUrl}=this.config,keySystemConfiguration=drmSystems[keySystem];if(keySystemConfiguration)return keySystemConfiguration.licenseUrl;if(keySystem===KeySystems.WIDEVINE&&widevineLicenseUrl)return widevineLicenseUrl;throw new Error(`no license server URL configured for key-system "${keySystem}"`)}getServerCertificateUrl(keySystem){const{drmSystems}=this.config,keySystemConfiguration=drmSystems[keySystem];if(keySystemConfiguration)return keySystemConfiguration.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${keySystem}"]`)}attemptKeySystemAccess(keySystemsToAttempt){const levels=this.hls.levels,uniqueCodec=(value,i,a)=>!!value&&a.indexOf(value)===i,audioCodecs=levels.map((level=>level.audioCodec)).filter(uniqueCodec),videoCodecs=levels.map((level=>level.videoCodec)).filter(uniqueCodec);return audioCodecs.length+videoCodecs.length===0&&videoCodecs.push("avc1.42e01e"),new Promise(((resolve,reject)=>{const attempt=keySystems=>{const keySystem=keySystems.shift();this.getMediaKeysPromise(keySystem,audioCodecs,videoCodecs).then((mediaKeys=>resolve({keySystem,mediaKeys}))).catch((error=>{keySystems.length?attempt(keySystems):reject(error instanceof EMEKeyError?error:new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_ACCESS,error,fatal:!0},error.message))}))};attempt(keySystemsToAttempt)}))}requestMediaKeySystemAccess(keySystem,supportedConfigurations){const{requestMediaKeySystemAccessFunc}=this.config;if("function"!=typeof requestMediaKeySystemAccessFunc){let errMessage=`Configured requestMediaKeySystemAccess is not a function ${requestMediaKeySystemAccessFunc}`;return null===requestMediaKeySystemAccess&&"http:"===self.location.protocol&&(errMessage=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(errMessage))}return requestMediaKeySystemAccessFunc(keySystem,supportedConfigurations)}getMediaKeysPromise(keySystem,audioCodecs,videoCodecs){const mediaKeySystemConfigs=function getSupportedMediaKeySystemConfigurations(keySystem,audioCodecs,videoCodecs,drmSystemOptions){let initDataTypes;switch(keySystem){case KeySystems.FAIRPLAY:initDataTypes=["cenc","sinf"];break;case KeySystems.WIDEVINE:case KeySystems.PLAYREADY:initDataTypes=["cenc"];break;case KeySystems.CLEARKEY:initDataTypes=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${keySystem}`)}return function createMediaKeySystemConfigurations(initDataTypes,audioCodecs,videoCodecs,drmSystemOptions){return[{initDataTypes,persistentState:drmSystemOptions.persistentState||"optional",distinctiveIdentifier:drmSystemOptions.distinctiveIdentifier||"optional",sessionTypes:drmSystemOptions.sessionTypes||[drmSystemOptions.sessionType||"temporary"],audioCapabilities:audioCodecs.map((codec=>({contentType:`audio/mp4; codecs="${codec}"`,robustness:drmSystemOptions.audioRobustness||"",encryptionScheme:drmSystemOptions.audioEncryptionScheme||null}))),videoCapabilities:videoCodecs.map((codec=>({contentType:`video/mp4; codecs="${codec}"`,robustness:drmSystemOptions.videoRobustness||"",encryptionScheme:drmSystemOptions.videoEncryptionScheme||null})))}]}(initDataTypes,audioCodecs,videoCodecs,drmSystemOptions)}(keySystem,audioCodecs,videoCodecs,this.config.drmSystemOptions),keySystemAccessPromises=this.keySystemAccessPromises[keySystem];let keySystemAccess=null==keySystemAccessPromises?void 0:keySystemAccessPromises.keySystemAccess;if(!keySystemAccess){this.log(`Requesting encrypted media "${keySystem}" key-system access with config: ${JSON.stringify(mediaKeySystemConfigs)}`),keySystemAccess=this.requestMediaKeySystemAccess(keySystem,mediaKeySystemConfigs);const _keySystemAccessPromises=this.keySystemAccessPromises[keySystem]={keySystemAccess};return keySystemAccess.catch((error=>{this.log(`Failed to obtain access to key-system "${keySystem}": ${error}`)})),keySystemAccess.then((mediaKeySystemAccess=>{this.log(`Access for key-system "${mediaKeySystemAccess.keySystem}" obtained`);const certificateRequest=this.fetchServerCertificate(keySystem);return this.log(`Create media-keys for "${keySystem}"`),_keySystemAccessPromises.mediaKeys=mediaKeySystemAccess.createMediaKeys().then((mediaKeys=>(this.log(`Media-keys created for "${keySystem}"`),certificateRequest.then((certificate=>certificate?this.setMediaKeysServerCertificate(mediaKeys,keySystem,certificate):mediaKeys))))),_keySystemAccessPromises.mediaKeys.catch((error=>{this.error(`Failed to create media-keys for "${keySystem}"}: ${error}`)})),_keySystemAccessPromises.mediaKeys}))}return keySystemAccess.then((()=>keySystemAccessPromises.mediaKeys))}createMediaKeySessionContext({decryptdata,keySystem,mediaKeys}){this.log(`Creating key-system session "${keySystem}" keyId: ${Hex_hexDump(decryptdata.keyId||[])}`);const mediaKeysSession=mediaKeys.createSession(),mediaKeySessionContext={decryptdata,keySystem,mediaKeys,mediaKeysSession,keyStatus:"status-pending"};return this.mediaKeySessions.push(mediaKeySessionContext),mediaKeySessionContext}renewKeySession(mediaKeySessionContext){const decryptdata=mediaKeySessionContext.decryptdata;if(decryptdata.pssh){const keySessionContext=this.createMediaKeySessionContext(mediaKeySessionContext),keyId=this.getKeyIdString(decryptdata),scheme="cenc";this.keyIdToKeySessionPromise[keyId]=this.generateRequestWithPreferredKeySession(keySessionContext,scheme,decryptdata.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(mediaKeySessionContext)}getKeyIdString(decryptdata){if(!decryptdata)throw new Error("Could not read keyId of undefined decryptdata");if(null===decryptdata.keyId)throw new Error("keyId is null");return Hex_hexDump(decryptdata.keyId)}updateKeySession(mediaKeySessionContext,data){var _mediaKeySessionConte;const keySession=mediaKeySessionContext.mediaKeysSession;return this.log(`Updating key-session "${keySession.sessionId}" for keyID ${Hex_hexDump((null==(_mediaKeySessionConte=mediaKeySessionContext.decryptdata)?void 0:_mediaKeySessionConte.keyId)||[])}\n      } (data length: ${data?data.byteLength:data})`),keySession.update(data)}selectKeySystemFormat(frag){const keyFormats=Object.keys(frag.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${frag.sn} ${frag.type}: ${frag.level}) key formats ${keyFormats.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(keyFormats)),this.keyFormatPromise}getKeyFormatPromise(keyFormats){return new Promise(((resolve,reject)=>{const keySystemsInConfig=getKeySystemsForConfig(this.config),keySystemsToAttempt=keyFormats.map(keySystemFormatToKeySystemDomain).filter((value=>!!value&&-1!==keySystemsInConfig.indexOf(value)));return this.getKeySystemSelectionPromise(keySystemsToAttempt).then((({keySystem})=>{const keySystemFormat=keySystemDomainToKeySystemFormat(keySystem);keySystemFormat?resolve(keySystemFormat):reject(new Error(`Unable to find format for key-system "${keySystem}"`))})).catch(reject)}))}loadKey(data){const decryptdata=data.keyInfo.decryptdata,keyId=this.getKeyIdString(decryptdata),keyDetails=`(keyId: ${keyId} format: "${decryptdata.keyFormat}" method: ${decryptdata.method} uri: ${decryptdata.uri})`;this.log(`Starting session for key ${keyDetails}`);let keySessionContextPromise=this.keyIdToKeySessionPromise[keyId];return keySessionContextPromise||(keySessionContextPromise=this.keyIdToKeySessionPromise[keyId]=this.getKeySystemForKeyPromise(decryptdata).then((({keySystem,mediaKeys})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${data.frag.sn} ${data.frag.type}: ${data.frag.level} using key ${keyDetails}`),this.attemptSetMediaKeys(keySystem,mediaKeys).then((()=>{this.throwIfDestroyed();const keySessionContext=this.createMediaKeySessionContext({keySystem,mediaKeys,decryptdata});return this.generateRequestWithPreferredKeySession(keySessionContext,"cenc",decryptdata.pssh,"playlist-key")}))))),keySessionContextPromise.catch((error=>this.handleError(error)))),keySessionContextPromise}throwIfDestroyed(message="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(error){this.hls&&(this.error(error.message),error instanceof EMEKeyError?this.hls.trigger(Events.ERROR,error.data):this.hls.trigger(Events.ERROR,{type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_KEYS,error,fatal:!0}))}getKeySystemForKeyPromise(decryptdata){const keyId=this.getKeyIdString(decryptdata),mediaKeySessionContext=this.keyIdToKeySessionPromise[keyId];if(!mediaKeySessionContext){const keySystem=keySystemFormatToKeySystemDomain(decryptdata.keyFormat),keySystemsToAttempt=keySystem?[keySystem]:getKeySystemsForConfig(this.config);return this.attemptKeySystemAccess(keySystemsToAttempt)}return mediaKeySessionContext}getKeySystemSelectionPromise(keySystemsToAttempt){if(keySystemsToAttempt.length||(keySystemsToAttempt=getKeySystemsForConfig(this.config)),0===keySystemsToAttempt.length)throw new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(keySystemsToAttempt)}_onMediaEncrypted(event){const{initDataType,initData}=event;if(this.debug(`"${event.type}" event: init data type: "${initDataType}"`),null===initData)return;let keyId,keySystemDomain;if("sinf"===initDataType&&this.config.drmSystems[KeySystems.FAIRPLAY]){const json=bin2str(new Uint8Array(initData));try{const sinf=base64Decode(JSON.parse(json).sinf),tenc=parseSinf(new Uint8Array(sinf));if(!tenc)return;keyId=tenc.subarray(8,24),keySystemDomain=KeySystems.FAIRPLAY}catch(error){return void this.warn('Failed to parse sinf "encrypted" event message initData')}}else{const psshInfo=function parsePssh(initData){if(!(initData instanceof ArrayBuffer)||initData.byteLength<32)return null;const result={version:0,systemId:"",kids:null,data:null},view=new DataView(initData),boxSize=view.getUint32(0);if(initData.byteLength!==boxSize&&boxSize>44)return null;if(1886614376!==view.getUint32(4))return null;if(result.version=view.getUint32(8)>>>24,result.version>1)return null;result.systemId=Hex_hexDump(new Uint8Array(initData,12,16));const dataSizeOrKidCount=view.getUint32(28);if(0===result.version){if(boxSize-32<dataSizeOrKidCount)return null;result.data=new Uint8Array(initData,32,dataSizeOrKidCount)}else if(1===result.version){result.kids=[];for(let i=0;i<dataSizeOrKidCount;i++)result.kids.push(new Uint8Array(initData,32+16*i,16))}return result}(initData);if(null===psshInfo)return;0===psshInfo.version&&psshInfo.systemId===KeySystemIds_WIDEVINE&&psshInfo.data&&(keyId=psshInfo.data.subarray(8,24)),keySystemDomain=function keySystemIdToKeySystemDomain(systemId){if(systemId===KeySystemIds_WIDEVINE)return KeySystems.WIDEVINE}(psshInfo.systemId)}if(!keySystemDomain||!keyId)return;const keyIdHex=Hex_hexDump(keyId),{keyIdToKeySessionPromise,mediaKeySessions}=this;let keySessionContextPromise=keyIdToKeySessionPromise[keyIdHex];for(let i=0;i<mediaKeySessions.length;i++){const keyContext=mediaKeySessions[i],decryptdata=keyContext.decryptdata;if(decryptdata.pssh||!decryptdata.keyId)continue;const oldKeyIdHex=Hex_hexDump(decryptdata.keyId);if(keyIdHex===oldKeyIdHex||-1!==decryptdata.uri.replace(/-/g,"").indexOf(keyIdHex)){keySessionContextPromise=keyIdToKeySessionPromise[oldKeyIdHex],delete keyIdToKeySessionPromise[oldKeyIdHex],decryptdata.pssh=new Uint8Array(initData),decryptdata.keyId=keyId,keySessionContextPromise=keyIdToKeySessionPromise[keyIdHex]=keySessionContextPromise.then((()=>this.generateRequestWithPreferredKeySession(keyContext,initDataType,initData,"encrypted-event-key-match")));break}}keySessionContextPromise||(keySessionContextPromise=keyIdToKeySessionPromise[keyIdHex]=this.getKeySystemSelectionPromise([keySystemDomain]).then((({keySystem,mediaKeys})=>{var _keySystemToKeySystem;this.throwIfDestroyed();const decryptdata=new LevelKey("ISO-23001-7",keyIdHex,null!=(_keySystemToKeySystem=keySystemDomainToKeySystemFormat(keySystem))?_keySystemToKeySystem:"");return decryptdata.pssh=new Uint8Array(initData),decryptdata.keyId=keyId,this.attemptSetMediaKeys(keySystem,mediaKeys).then((()=>{this.throwIfDestroyed();const keySessionContext=this.createMediaKeySessionContext({decryptdata,keySystem,mediaKeys});return this.generateRequestWithPreferredKeySession(keySessionContext,initDataType,initData,"encrypted-event-no-match")}))}))),keySessionContextPromise.catch((error=>this.handleError(error)))}_onWaitingForKey(event){this.log(`"${event.type}" event`)}attemptSetMediaKeys(keySystem,mediaKeys){const queue=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${keySystem}"`);const setMediaKeysPromise=Promise.all(queue).then((()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(mediaKeys)}));return this.setMediaKeysQueue.push(setMediaKeysPromise),setMediaKeysPromise.then((()=>{this.log(`Media-keys set for "${keySystem}"`),queue.push(setMediaKeysPromise),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((p=>-1===queue.indexOf(p)))}))}generateRequestWithPreferredKeySession(context,initDataType,initData,reason){var _this$config$drmSyste,_this$config$drmSyste2;const generateRequestFilter=null==(_this$config$drmSyste=this.config.drmSystems)||null==(_this$config$drmSyste2=_this$config$drmSyste[context.keySystem])?void 0:_this$config$drmSyste2.generateRequest;if(generateRequestFilter)try{const mappedInitData=generateRequestFilter.call(this.hls,initDataType,initData,context);if(!mappedInitData)throw new Error("Invalid response from configured generateRequest filter");initDataType=mappedInitData.initDataType,initData=context.decryptdata.pssh=mappedInitData.initData?new Uint8Array(mappedInitData.initData):null}catch(error){var _this$hls;if(this.warn(error.message),null!=(_this$hls=this.hls)&&_this$hls.config.debug)throw error}if(null===initData)return this.log(`Skipping key-session request for "${reason}" (no initData)`),Promise.resolve(context);const keyId=this.getKeyIdString(context.decryptdata);this.log(`Generating key-session request for "${reason}": ${keyId} (init data type: ${initDataType} length: ${initData?initData.byteLength:null})`);const licenseStatus=new EventEmitter,onmessage=context._onmessage=event=>{const keySession=context.mediaKeysSession;if(!keySession)return void licenseStatus.emit("error",new Error("invalid state"));const{messageType,message}=event;this.log(`"${messageType}" message event for session "${keySession.sessionId}" message size: ${message.byteLength}`),"license-request"===messageType||"license-renewal"===messageType?this.renewLicense(context,message).catch((error=>{this.handleError(error),licenseStatus.emit("error",error)})):"license-release"===messageType?context.keySystem===KeySystems.FAIRPLAY&&(this.updateKeySession(context,strToUtf8array("acknowledged")),this.removeSession(context)):this.warn(`unhandled media key message type "${messageType}"`)},onkeystatuseschange=context._onkeystatuseschange=event=>{if(!context.mediaKeysSession)return void licenseStatus.emit("error",new Error("invalid state"));this.onKeyStatusChange(context);const keyStatus=context.keyStatus;licenseStatus.emit("keyStatus",keyStatus),"expired"===keyStatus&&(this.warn(`${context.keySystem} expired for key ${keyId}`),this.renewKeySession(context))};context.mediaKeysSession.addEventListener("message",onmessage),context.mediaKeysSession.addEventListener("keystatuseschange",onkeystatuseschange);const keyUsablePromise=new Promise(((resolve,reject)=>{licenseStatus.on("error",reject),licenseStatus.on("keyStatus",(keyStatus=>{keyStatus.startsWith("usable")?resolve():"output-restricted"===keyStatus?reject(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===keyStatus?reject(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${keyStatus}"`)):"expired"===keyStatus?reject(new Error("key expired while generating request")):this.warn(`unhandled key status change "${keyStatus}"`)}))}));return context.mediaKeysSession.generateRequest(initDataType,initData).then((()=>{var _context$mediaKeysSes;this.log(`Request generated for key-session "${null==(_context$mediaKeysSes=context.mediaKeysSession)?void 0:_context$mediaKeysSes.sessionId}" keyId: ${keyId}`)})).catch((error=>{throw new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_NO_SESSION,error,fatal:!1},`Error generating key-session request: ${error}`)})).then((()=>keyUsablePromise)).catch((error=>{throw licenseStatus.removeAllListeners(),this.removeSession(context),error})).then((()=>(licenseStatus.removeAllListeners(),context)))}onKeyStatusChange(mediaKeySessionContext){mediaKeySessionContext.mediaKeysSession.keyStatuses.forEach(((status,keyId)=>{this.log(`key status change "${status}" for keyStatuses keyId: ${Hex_hexDump("buffer"in keyId?new Uint8Array(keyId.buffer,keyId.byteOffset,keyId.byteLength):new Uint8Array(keyId))} session keyId: ${Hex_hexDump(new Uint8Array(mediaKeySessionContext.decryptdata.keyId||[]))} uri: ${mediaKeySessionContext.decryptdata.uri}`),mediaKeySessionContext.keyStatus=status}))}fetchServerCertificate(keySystem){const config=this.config,certLoader=new(0,config.loader)(config),url=this.getServerCertificateUrl(keySystem);return url?(this.log(`Fetching server certificate for "${keySystem}"`),new Promise(((resolve,reject)=>{const loaderContext={responseType:"arraybuffer",url},loadPolicy=config.certLoadPolicy.default,loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},loaderCallbacks={onSuccess:(response,stats,context,networkDetails)=>{resolve(response.data)},onError:(response,contex,networkDetails,stats)=>{reject(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails,response:_objectSpread2({url:loaderContext.url,data:void 0},response)},`"${keySystem}" certificate request failed (${url}). Status: ${response.code} (${response.text})`))},onTimeout:(stats,context,networkDetails)=>{reject(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails,response:{url:loaderContext.url,data:void 0}},`"${keySystem}" certificate request timed out (${url})`))},onAbort:(stats,context,networkDetails)=>{reject(new Error("aborted"))}};certLoader.load(loaderContext,loaderConfig,loaderCallbacks)}))):Promise.resolve()}setMediaKeysServerCertificate(mediaKeys,keySystem,cert){return new Promise(((resolve,reject)=>{mediaKeys.setServerCertificate(cert).then((success=>{this.log(`setServerCertificate ${success?"success":"not supported by CDM"} (${null==cert?void 0:cert.byteLength}) on "${keySystem}"`),resolve(mediaKeys)})).catch((error=>{reject(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error,fatal:!0},error.message))}))}))}renewLicense(context,keyMessage){return this.requestLicense(context,new Uint8Array(keyMessage)).then((data=>this.updateKeySession(context,new Uint8Array(data)).catch((error=>{throw new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_SESSION_UPDATE_FAILED,error,fatal:!0},error.message)}))))}unpackPlayReadyKeyMessage(xhr,licenseChallenge){const xmlString=String.fromCharCode.apply(null,new Uint16Array(licenseChallenge.buffer));if(!xmlString.includes("PlayReadyKeyMessage"))return xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8"),licenseChallenge;const keyMessageXml=(new DOMParser).parseFromString(xmlString,"application/xml"),headers=keyMessageXml.querySelectorAll("HttpHeader");if(headers.length>0){let header;for(let i=0,len=headers.length;i<len;i++){var _header$querySelector,_header$querySelector2;header=headers[i];const name=null==(_header$querySelector=header.querySelector("name"))?void 0:_header$querySelector.textContent,value=null==(_header$querySelector2=header.querySelector("value"))?void 0:_header$querySelector2.textContent;name&&value&&xhr.setRequestHeader(name,value)}}const challengeElement=keyMessageXml.querySelector("Challenge"),challengeText=null==challengeElement?void 0:challengeElement.textContent;if(!challengeText)throw new Error("Cannot find <Challenge> in key message");return strToUtf8array(atob(challengeText))}setupLicenseXHR(xhr,url,keysListItem,licenseChallenge){const licenseXhrSetup=this.config.licenseXhrSetup;return licenseXhrSetup?Promise.resolve().then((()=>{if(!keysListItem.decryptdata)throw new Error("Key removed");return licenseXhrSetup.call(this.hls,xhr,url,keysListItem,licenseChallenge)})).catch((error=>{if(!keysListItem.decryptdata)throw error;return xhr.open("POST",url,!0),licenseXhrSetup.call(this.hls,xhr,url,keysListItem,licenseChallenge)})).then((licenseXhrSetupResult=>{xhr.readyState||xhr.open("POST",url,!0);return{xhr,licenseChallenge:licenseXhrSetupResult||licenseChallenge}})):(xhr.open("POST",url,!0),Promise.resolve({xhr,licenseChallenge}))}requestLicense(keySessionContext,licenseChallenge){const keyLoadPolicy=this.config.keyLoadPolicy.default;return new Promise(((resolve,reject)=>{const url=this.getLicenseServerUrl(keySessionContext.keySystem);this.log(`Sending license request to URL: ${url}`);const xhr=new XMLHttpRequest;xhr.responseType="arraybuffer",xhr.onreadystatechange=()=>{if(!this.hls||!keySessionContext.mediaKeysSession)return reject(new Error("invalid state"));if(4===xhr.readyState)if(200===xhr.status){this._requestLicenseFailureCount=0;let data=xhr.response;this.log(`License received ${data instanceof ArrayBuffer?data.byteLength:data}`);const licenseResponseCallback=this.config.licenseResponseCallback;if(licenseResponseCallback)try{data=licenseResponseCallback.call(this.hls,xhr,url,keySessionContext)}catch(error){this.error(error)}resolve(data)}else{const retryConfig=keyLoadPolicy.errorRetry,maxNumRetry=retryConfig?retryConfig.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>maxNumRetry||xhr.status>=400&&xhr.status<500)reject(new EMEKeyError({type:ErrorTypes.KEY_SYSTEM_ERROR,details:ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:xhr,response:{url,data:void 0,code:xhr.status,text:xhr.statusText}},`License Request XHR failed (${url}). Status: ${xhr.status} (${xhr.statusText})`));else{const attemptsLeft=maxNumRetry-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${attemptsLeft} attempts left`),this.requestLicense(keySessionContext,licenseChallenge).then(resolve,reject)}}},keySessionContext.licenseXhr&&keySessionContext.licenseXhr.readyState!==XMLHttpRequest.DONE&&keySessionContext.licenseXhr.abort(),keySessionContext.licenseXhr=xhr,this.setupLicenseXHR(xhr,url,keySessionContext,licenseChallenge).then((({xhr,licenseChallenge})=>{keySessionContext.keySystem==KeySystems.PLAYREADY&&(licenseChallenge=this.unpackPlayReadyKeyMessage(xhr,licenseChallenge)),xhr.send(licenseChallenge)}))}))}onMediaAttached(event,data){if(!this.config.emeEnabled)return;const media=data.media;this.media=media,media.addEventListener("encrypted",this.onMediaEncrypted),media.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const media=this.media,mediaKeysList=this.mediaKeySessions;media&&(media.removeEventListener("encrypted",this.onMediaEncrypted),media.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},LevelKey.clearKeyUriToKeyIdMap();const keySessionCount=mediaKeysList.length;EMEController.CDMCleanupPromise=Promise.all(mediaKeysList.map((mediaKeySessionContext=>this.removeSession(mediaKeySessionContext))).concat(null==media?void 0:media.setMediaKeys(null).catch((error=>{this.log(`Could not clear media keys: ${error}`)})))).then((()=>{keySessionCount&&(this.log("finished closing key sessions and clearing media keys"),mediaKeysList.length=0)})).catch((error=>{this.log(`Could not close sessions and clear media keys: ${error}`)}))}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(event,{sessionKeys}){if(sessionKeys&&this.config.emeEnabled&&!this.keyFormatPromise){const keyFormats=sessionKeys.reduce(((formats,sessionKey)=>(-1===formats.indexOf(sessionKey.keyFormat)&&formats.push(sessionKey.keyFormat),formats)),[]);this.log(`Selecting key-system from session-keys ${keyFormats.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(keyFormats)}}removeSession(mediaKeySessionContext){const{mediaKeysSession,licenseXhr}=mediaKeySessionContext;if(mediaKeysSession){this.log(`Remove licenses and keys and close session ${mediaKeysSession.sessionId}`),mediaKeySessionContext._onmessage&&(mediaKeysSession.removeEventListener("message",mediaKeySessionContext._onmessage),mediaKeySessionContext._onmessage=void 0),mediaKeySessionContext._onkeystatuseschange&&(mediaKeysSession.removeEventListener("keystatuseschange",mediaKeySessionContext._onkeystatuseschange),mediaKeySessionContext._onkeystatuseschange=void 0),licenseXhr&&licenseXhr.readyState!==XMLHttpRequest.DONE&&licenseXhr.abort(),mediaKeySessionContext.mediaKeysSession=mediaKeySessionContext.decryptdata=mediaKeySessionContext.licenseXhr=void 0;const index=this.mediaKeySessions.indexOf(mediaKeySessionContext);return index>-1&&this.mediaKeySessions.splice(index,1),mediaKeysSession.remove().catch((error=>{this.log(`Could not remove session: ${error}`)})).then((()=>mediaKeysSession.close())).catch((error=>{this.log(`Could not close session: ${error}`)}))}}}EMEController.CDMCleanupPromise=void 0;class EMEKeyError extends Error{constructor(data,message){super(message),this.data=void 0,data.error||(data.error=new Error(message)),this.data=data,data.err=data.error}}var CmObjectType,CmStreamingFormat,CmcdHeaderField;!function(CmObjectType){CmObjectType.MANIFEST="m",CmObjectType.AUDIO="a",CmObjectType.VIDEO="v",CmObjectType.MUXED="av",CmObjectType.INIT="i",CmObjectType.CAPTION="c",CmObjectType.TIMED_TEXT="tt",CmObjectType.KEY="k",CmObjectType.OTHER="o"}(CmObjectType||(CmObjectType={})),function(CmStreamingFormat){CmStreamingFormat.DASH="d",CmStreamingFormat.HLS="h",CmStreamingFormat.SMOOTH="s",CmStreamingFormat.OTHER="o"}(CmStreamingFormat||(CmStreamingFormat={})),function(CmcdHeaderField){CmcdHeaderField.OBJECT="CMCD-Object",CmcdHeaderField.REQUEST="CMCD-Request",CmcdHeaderField.SESSION="CMCD-Session",CmcdHeaderField.STATUS="CMCD-Status"}(CmcdHeaderField||(CmcdHeaderField={}));const CmcdHeaderMap={[CmcdHeaderField.OBJECT]:["br","d","ot","tb"],[CmcdHeaderField.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[CmcdHeaderField.SESSION]:["cid","pr","sf","sid","st","v"],[CmcdHeaderField.STATUS]:["bs","rtp"]};class SfItem{constructor(value,params){this.value=void 0,this.params=void 0,Array.isArray(value)&&(value=value.map((v=>v instanceof SfItem?v:new SfItem(v)))),this.value=value,this.params=params}}class SfToken{constructor(description){this.description=void 0,this.description=description}}const DICT="Dict";function throwError(action,src,type,cause){return new Error(`failed to ${action} "${function format(value){return Array.isArray(value)?JSON.stringify(value):value instanceof Map?"Map{}":value instanceof Set?"Set{}":"object"==typeof value?JSON.stringify(value):String(value)}(src)}" as ${type}`,{cause})}const BARE_ITEM="Bare Item",BOOLEAN="Boolean",BYTES="Byte Sequence",DECIMAL="Decimal",INTEGER="Integer";const STRING_REGEX=/[\x00-\x1f\x7f]+/,TOKEN="Token",KEY="Key";function serializeError(src,type,cause){return throwError("serialize",src,type,cause)}function serializeByteSequence(value){if(!1===ArrayBuffer.isView(value))throw serializeError(value,BYTES);return`:${function base64encode(binary){return btoa(String.fromCharCode(...binary))}(value)}:`}function serializeInteger(value){if(function isInvalidInt(value){return value<-999999999999999||999999999999999<value}(value))throw serializeError(value,INTEGER);return value.toString()}function roundToEven(value,precision){if(value<0)return-roundToEven(-value,precision);const decimalShift=Math.pow(10,precision);if(Math.abs(value*decimalShift%1-.5)<Number.EPSILON){const flooredValue=Math.floor(value*decimalShift);return(flooredValue%2==0?flooredValue:flooredValue+1)/decimalShift}return Math.round(value*decimalShift)/decimalShift}function serializeDecimal(value){const roundedValue=roundToEven(value,3);if(Math.floor(Math.abs(roundedValue)).toString().length>12)throw serializeError(value,DECIMAL);const stringValue=roundedValue.toString();return stringValue.includes(".")?stringValue:`${stringValue}.0`}const STRING="String";function serializeToken(token){const value=function symbolToStr(symbol){return symbol.description||symbol.toString().slice(7,-1)}(token);if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(value))throw serializeError(value,TOKEN);return value}function serializeBareItem(value){switch(typeof value){case"number":if(!isFiniteNumber(value))throw serializeError(value,BARE_ITEM);return Number.isInteger(value)?serializeInteger(value):serializeDecimal(value);case"string":return function serializeString(value){if(STRING_REGEX.test(value))throw serializeError(value,STRING);return`"${value.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(value);case"symbol":return serializeToken(value);case"boolean":return function serializeBoolean(value){if("boolean"!=typeof value)throw serializeError(value,BOOLEAN);return value?"?1":"?0"}(value);case"object":if(value instanceof Date)return function serializeDate(value){return`@${serializeInteger(value.getTime()/1e3)}`}(value);if(value instanceof Uint8Array)return serializeByteSequence(value);if(value instanceof SfToken)return serializeToken(value);default:throw serializeError(value,BARE_ITEM)}}function serializeKey(value){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(value))throw serializeError(value,KEY);return value}function serializeParams(params){return null==params?"":Object.entries(params).map((([key,value])=>!0===value?`;${serializeKey(key)}`:`;${serializeKey(key)}=${serializeBareItem(value)}`)).join("")}function serializeItem(value){return value instanceof SfItem?`${serializeBareItem(value.value)}${serializeParams(value.params)}`:serializeBareItem(value)}function serializeDict(dict,options={whitespace:!0}){if("object"!=typeof dict)throw serializeError(dict,DICT);const entries=dict instanceof Map?dict.entries():Object.entries(dict),optionalWhiteSpace=null!=options&&options.whitespace?" ":"";return Array.from(entries).map((([key,item])=>{item instanceof SfItem==!1&&(item=new SfItem(item));let output=serializeKey(key);return!0===item.value?output+=serializeParams(item.params):(output+="=",Array.isArray(item.value)?output+=function serializeInnerList(value){return`(${value.value.map(serializeItem).join(" ")})${serializeParams(value.params)}`}(item):output+=serializeItem(item)),output})).join(`,${optionalWhiteSpace}`)}const isTokenField=key=>"ot"===key||"sf"===key||"st"===key,isValid=value=>"number"==typeof value?isFiniteNumber(value):null!=value&&""!==value&&!1!==value;const toRounded=value=>Math.round(value),toHundred=value=>100*toRounded(value/100),CmcdFormatters={br:toRounded,d:toRounded,bl:toHundred,dl:toHundred,mtp:toHundred,nor:(value,options)=>(null!=options&&options.baseUrl&&(value=function urlToRelativePath(url,base){const to=new URL(url),from=new URL(base);if(to.origin!==from.origin)return url;const toPath=to.pathname.split("/").slice(1),fromPath=from.pathname.split("/").slice(1,-1);for(;toPath[0]===fromPath[0];)toPath.shift(),fromPath.shift();for(;fromPath.length;)fromPath.shift(),toPath.unshift("..");return toPath.join("/")}(value,options.baseUrl)),encodeURIComponent(value)),rtp:toHundred,tb:toRounded};function encodeCmcd(cmcd,options={}){return cmcd?function encodeSfDict(value,options){return serializeDict(value,options)}(function processCmcd(obj,options){const results={};if(null==obj||"object"!=typeof obj)return results;const keys=Object.keys(obj).sort(),formatters=_extends({},CmcdFormatters,null==options?void 0:options.formatters),filter=null==options?void 0:options.filter;return keys.forEach((key=>{if(null!=filter&&filter(key))return;let value=obj[key];const formatter=formatters[key];formatter&&(value=formatter(value,options)),"v"===key&&1===value||"pr"==key&&1===value||isValid(value)&&(isTokenField(key)&&"string"==typeof value&&(value=new SfToken(value)),results[key]=value)})),results}(cmcd,options),_extends({whitespace:!1},options)):""}function appendCmcdHeaders(headers,cmcd,options){return _extends(headers,function toCmcdHeaders(cmcd,options={}){if(!cmcd)return{};const entries=Object.entries(cmcd),headerMap=Object.entries(CmcdHeaderMap).concat(Object.entries((null==options?void 0:options.customHeaderMap)||{})),shards=entries.reduce(((acc,entry)=>{var _headerMap$find;const[key,value]=entry,field=(null==(_headerMap$find=headerMap.find((entry=>entry[1].includes(key))))?void 0:_headerMap$find[0])||CmcdHeaderField.REQUEST;return null!=acc[field]||(acc[field]={}),acc[field][key]=value,acc}),{});return Object.entries(shards).reduce(((acc,[field,value])=>(acc[field]=encodeCmcd(value,options),acc)),{})}(cmcd,options))}const CMCD_PARAM="CMCD";const REGEX=/CMCD=[^&#]+/;function appendCmcdQuery(url,cmcd,options){const query=function toCmcdQuery(cmcd,options={}){if(!cmcd)return"";const params=encodeCmcd(cmcd,options);return`${CMCD_PARAM}=${encodeURIComponent(params)}`}(cmcd,options);if(!query)return url;if(REGEX.test(url))return url.replace(REGEX,query);const separator=url.includes("?")?"&":"?";return`${url}${separator}${query}`}function cloneRenditionGroups(tracks,groupCloneMap,uriReplacement,cloneId){tracks&&Object.keys(groupCloneMap).forEach((audioGroupId=>{const clonedTracks=tracks.filter((track=>track.groupId===audioGroupId)).map((track=>{const clonedTrack=_extends({},track);return clonedTrack.details=void 0,clonedTrack.attrs=new AttrList(clonedTrack.attrs),clonedTrack.url=clonedTrack.attrs.URI=performUriReplacement(track.url,track.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",uriReplacement),clonedTrack.groupId=clonedTrack.attrs["GROUP-ID"]=groupCloneMap[audioGroupId],clonedTrack.attrs["PATHWAY-ID"]=cloneId,clonedTrack}));tracks.push(...clonedTracks)}))}function performUriReplacement(uri,stableId,perOptionKey,uriReplacement){const{HOST:host,PARAMS:params,[perOptionKey]:perOptionUris}=uriReplacement;let perVariantUri;stableId&&(perVariantUri=null==perOptionUris?void 0:perOptionUris[stableId],perVariantUri&&(uri=perVariantUri));const url=new self.URL(uri);return host&&!perVariantUri&&(url.host=host),params&&Object.keys(params).sort().forEach((key=>{key&&url.searchParams.set(key,params[key])})),url.href}const AGE_HEADER_LINE_REGEX=/^age:\s*[\d.]+\s*$/im;class XhrLoader{constructor(config){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=config&&config.xhrSetup||null,this.stats=new LoadStats,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null,this.stats=null}abortInternal(){const loader=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),loader&&(loader.onreadystatechange=null,loader.onprogress=null,4!==loader.readyState&&(this.stats.aborted=!0,loader.abort()))}abort(){var _this$callbacks;this.abortInternal(),null!=(_this$callbacks=this.callbacks)&&_this$callbacks.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(context,config,callbacks){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=context,this.config=config,this.callbacks=callbacks,this.loadInternal()}loadInternal(){const{config,context}=this;if(!config||!context)return;const xhr=this.loader=new self.XMLHttpRequest,stats=this.stats;stats.loading.first=0,stats.loaded=0,stats.aborted=!1;const xhrSetup=this.xhrSetup;xhrSetup?Promise.resolve().then((()=>{if(!this.stats.aborted)return xhrSetup(xhr,context.url)})).catch((error=>(xhr.open("GET",context.url,!0),xhrSetup(xhr,context.url)))).then((()=>{this.stats.aborted||this.openAndSendXhr(xhr,context,config)})).catch((error=>{this.callbacks.onError({code:xhr.status,text:error.message},context,xhr,stats)})):this.openAndSendXhr(xhr,context,config)}openAndSendXhr(xhr,context,config){xhr.readyState||xhr.open("GET",context.url,!0);const headers=context.headers,{maxTimeToFirstByteMs,maxLoadTimeMs}=config.loadPolicy;if(headers)for(const header in headers)xhr.setRequestHeader(header,headers[header]);context.rangeEnd&&xhr.setRequestHeader("Range","bytes="+context.rangeStart+"-"+(context.rangeEnd-1)),xhr.onreadystatechange=this.readystatechange.bind(this),xhr.onprogress=this.loadprogress.bind(this),xhr.responseType=context.responseType,self.clearTimeout(this.requestTimeout),config.timeout=maxTimeToFirstByteMs&&isFiniteNumber(maxTimeToFirstByteMs)?maxTimeToFirstByteMs:maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),config.timeout),xhr.send()}readystatechange(){const{context,loader:xhr,stats}=this;if(!context||!xhr)return;const readyState=xhr.readyState,config=this.config;if(!stats.aborted&&readyState>=2&&(0===stats.loading.first&&(stats.loading.first=Math.max(self.performance.now(),stats.loading.start),config.timeout!==config.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),config.timeout=config.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),config.loadPolicy.maxLoadTimeMs-(stats.loading.first-stats.loading.start)))),4===readyState)){self.clearTimeout(this.requestTimeout),xhr.onreadystatechange=null,xhr.onprogress=null;const status=xhr.status,useResponse="text"!==xhr.responseType;if(status>=200&&status<300&&(useResponse&&xhr.response||null!==xhr.responseText)){stats.loading.end=Math.max(self.performance.now(),stats.loading.first);const data=useResponse?xhr.response:xhr.responseText,len="arraybuffer"===xhr.responseType?data.byteLength:data.length;if(stats.loaded=stats.total=len,stats.bwEstimate=8e3*stats.total/(stats.loading.end-stats.loading.first),!this.callbacks)return;const onProgress=this.callbacks.onProgress;if(onProgress&&onProgress(stats,context,data,xhr),!this.callbacks)return;const response={url:xhr.responseURL,data,code:status};this.callbacks.onSuccess(response,stats,context,xhr)}else{const retryConfig=config.loadPolicy.errorRetry;shouldRetry(retryConfig,stats.retry,!1,{url:context.url,data:void 0,code:status})?this.retry(retryConfig):(logger.error(`${status} while loading ${context.url}`),this.callbacks.onError({code:status,text:xhr.statusText},context,xhr,stats))}}}loadtimeout(){var _this$config;const retryConfig=null==(_this$config=this.config)?void 0:_this$config.loadPolicy.timeoutRetry;if(shouldRetry(retryConfig,this.stats.retry,!0))this.retry(retryConfig);else{var _this$context;logger.warn(`timeout while loading ${null==(_this$context=this.context)?void 0:_this$context.url}`);const callbacks=this.callbacks;callbacks&&(this.abortInternal(),callbacks.onTimeout(this.stats,this.context,this.loader))}}retry(retryConfig){const{context,stats}=this;this.retryDelay=getRetryDelay(retryConfig,stats.retry),stats.retry++,logger.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==context?void 0:context.url}, retrying ${stats.retry}/${retryConfig.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(event){const stats=this.stats;stats.loaded=event.loaded,event.lengthComputable&&(stats.total=event.total)}getCacheAge(){let result=null;if(this.loader&&AGE_HEADER_LINE_REGEX.test(this.loader.getAllResponseHeaders())){const ageHeader=this.loader.getResponseHeader("age");result=ageHeader?parseFloat(ageHeader):null}return result}getResponseHeader(name){return this.loader&&new RegExp(`^${name}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(name):null}}const BYTERANGE=/(\d+)-(\d+)\/(\d+)/;class FetchLoader{constructor(config){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=config.fetchSetup||getRequest,this.controller=new self.AbortController,this.stats=new LoadStats}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var _this$callbacks;this.abortInternal(),null!=(_this$callbacks=this.callbacks)&&_this$callbacks.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(context,config,callbacks){const stats=this.stats;if(stats.loading.start)throw new Error("Loader can only be used once.");stats.loading.start=self.performance.now();const initParams=function getRequestParameters(context,signal){const initParams={method:"GET",mode:"cors",credentials:"same-origin",signal,headers:new self.Headers(_extends({},context.headers))};context.rangeEnd&&initParams.headers.set("Range","bytes="+context.rangeStart+"-"+String(context.rangeEnd-1));return initParams}(context,this.controller.signal),onProgress=callbacks.onProgress,isArrayBuffer="arraybuffer"===context.responseType,LENGTH=isArrayBuffer?"byteLength":"length",{maxTimeToFirstByteMs,maxLoadTimeMs}=config.loadPolicy;this.context=context,this.config=config,this.callbacks=callbacks,this.request=this.fetchSetup(context,initParams),self.clearTimeout(this.requestTimeout),config.timeout=maxTimeToFirstByteMs&&isFiniteNumber(maxTimeToFirstByteMs)?maxTimeToFirstByteMs:maxLoadTimeMs,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),callbacks.onTimeout(stats,context,this.response)}),config.timeout),self.fetch(this.request).then((response=>{this.response=this.loader=response;const first=Math.max(self.performance.now(),stats.loading.start);if(self.clearTimeout(this.requestTimeout),config.timeout=maxLoadTimeMs,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),callbacks.onTimeout(stats,context,this.response)}),maxLoadTimeMs-(first-stats.loading.start)),!response.ok){const{status,statusText}=response;throw new FetchError(statusText||"fetch, bad network response",status,response)}return stats.loading.first=first,stats.total=function getContentLength(headers){const contentRange=headers.get("Content-Range");if(contentRange){const byteRangeLength=function getByteRangeLength(byteRangeHeader){const result=BYTERANGE.exec(byteRangeHeader);if(result)return parseInt(result[2])-parseInt(result[1])+1}(contentRange);if(isFiniteNumber(byteRangeLength))return byteRangeLength}const contentLength=headers.get("Content-Length");if(contentLength)return parseInt(contentLength)}(response.headers)||stats.total,onProgress&&isFiniteNumber(config.highWaterMark)?this.loadProgressively(response,stats,context,config.highWaterMark,onProgress):isArrayBuffer?response.arrayBuffer():"json"===context.responseType?response.json():response.text()})).then((responseData=>{const response=this.response;if(!response)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),stats.loading.end=Math.max(self.performance.now(),stats.loading.first);const total=responseData[LENGTH];total&&(stats.loaded=stats.total=total);const loaderResponse={url:response.url,data:responseData,code:response.status};onProgress&&!isFiniteNumber(config.highWaterMark)&&onProgress(stats,context,responseData,response),callbacks.onSuccess(loaderResponse,stats,context,response)})).catch((error=>{if(self.clearTimeout(this.requestTimeout),stats.aborted)return;const code=error&&error.code||0,text=error?error.message:null;callbacks.onError({code,text},context,error?error.details:null,stats)}))}getCacheAge(){let result=null;if(this.response){const ageHeader=this.response.headers.get("age");result=ageHeader?parseFloat(ageHeader):null}return result}getResponseHeader(name){return this.response?this.response.headers.get(name):null}loadProgressively(response,stats,context,highWaterMark=0,onProgress){const chunkCache=new ChunkCache,reader=response.body.getReader(),pump=()=>reader.read().then((data=>{if(data.done)return chunkCache.dataLength&&onProgress(stats,context,chunkCache.flush(),response),Promise.resolve(new ArrayBuffer(0));const chunk=data.value,len=chunk.length;return stats.loaded+=len,len<highWaterMark||chunkCache.dataLength?(chunkCache.push(chunk),chunkCache.dataLength>=highWaterMark&&onProgress(stats,context,chunkCache.flush(),response)):onProgress(stats,context,chunk,response),pump()})).catch((()=>Promise.reject()));return pump()}}function getRequest(context,initParams){return new self.Request(context.url,initParams)}class FetchError extends Error{constructor(message,code,details){super(message),this.code=void 0,this.details=void 0,this.code=code,this.details=details}}const WHITESPACE_CHAR=/\s/,Cues={newCue(track,startTime,endTime,captionScreen){const result=[];let row,cue,indenting,indent,text;const Cue=self.VTTCue||self.TextTrackCue;for(let r=0;r<captionScreen.rows.length;r++)if(row=captionScreen.rows[r],indenting=!0,indent=0,text="",!row.isEmpty()){var _track$cues;for(let c=0;c<row.chars.length;c++)WHITESPACE_CHAR.test(row.chars[c].uchar)&&indenting?indent++:(text+=row.chars[c].uchar,indenting=!1);row.cueStartTime=startTime,startTime===endTime&&(endTime+=1e-4),indent>=16?indent--:indent++;const cueText=fixLineBreaks(text.trim()),id=generateCueId(startTime,endTime,cueText);null!=track&&null!=(_track$cues=track.cues)&&_track$cues.getCueById(id)||(cue=new Cue(startTime,endTime,cueText),cue.id=id,cue.line=r+1,cue.align="left",cue.position=10+Math.min(80,10*Math.floor(8*indent/32)),result.push(cue))}return track&&result.length&&(result.sort(((cueA,cueB)=>"auto"===cueA.line||"auto"===cueB.line?0:cueA.line>8&&cueB.line>8?cueB.line-cueA.line:cueA.line-cueB.line)),result.forEach((cue=>addCueToTrack(track,cue)))),result}},hlsDefaultConfig=_objectSpread2(_objectSpread2({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:XhrLoader,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class AbrController{constructor(_hls){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:frag,partCurrent:part,hls}=this,{autoLevelEnabled,media}=hls;if(!frag||!media)return;const now=performance.now(),stats=part?part.stats:frag.stats,duration=part?part.duration:frag.duration,timeLoading=now-stats.loading.start,minAutoLevel=hls.minAutoLevel;if(stats.aborted||stats.loaded&&stats.loaded===stats.total||frag.level<=minAutoLevel)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!autoLevelEnabled||media.paused||!media.playbackRate||!media.readyState)return;const bufferInfo=hls.mainForwardBufferInfo;if(null===bufferInfo)return;const ttfbEstimate=this.bwEstimator.getEstimateTTFB(),playbackRate=Math.abs(media.playbackRate);if(timeLoading<=Math.max(ttfbEstimate,duration/(2*playbackRate)*1e3))return;const bufferStarvationDelay=bufferInfo.len/playbackRate,ttfb=stats.loading.first?stats.loading.first-stats.loading.start:-1,loadedFirstByte=stats.loaded&&ttfb>-1,bwEstimate=this.getBwEstimate(),levels=hls.levels,level=levels[frag.level],expectedLen=stats.total||Math.max(stats.loaded,Math.round(duration*level.averageBitrate/8));let timeStreaming=loadedFirstByte?timeLoading-ttfb:timeLoading;timeStreaming<1&&loadedFirstByte&&(timeStreaming=Math.min(timeLoading,8*stats.loaded/bwEstimate));const loadRate=loadedFirstByte?1e3*stats.loaded/timeStreaming:0,fragLoadedDelay=loadRate?(expectedLen-stats.loaded)/loadRate:8*expectedLen/bwEstimate+ttfbEstimate/1e3;if(fragLoadedDelay<=bufferStarvationDelay)return;const bwe=loadRate?8*loadRate:bwEstimate;let nextLoadLevel,fragLevelNextLoadedDelay=Number.POSITIVE_INFINITY;for(nextLoadLevel=frag.level-1;nextLoadLevel>minAutoLevel;nextLoadLevel--){const levelNextBitrate=levels[nextLoadLevel].maxBitrate;if(fragLevelNextLoadedDelay=this.getTimeToLoadFrag(ttfbEstimate/1e3,bwe,duration*levelNextBitrate,!levels[nextLoadLevel].details),fragLevelNextLoadedDelay<bufferStarvationDelay)break}if(fragLevelNextLoadedDelay>=fragLoadedDelay)return;if(fragLevelNextLoadedDelay>10*duration)return;hls.nextLoadLevel=hls.nextAutoLevel=nextLoadLevel,loadedFirstByte?this.bwEstimator.sample(timeLoading-Math.min(ttfbEstimate,ttfb),stats.loaded):this.bwEstimator.sampleTTFB(timeLoading);const nextLoadLevelBitrate=levels[nextLoadLevel].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>nextLoadLevelBitrate&&this.resetEstimator(nextLoadLevelBitrate),this.clearTimer(),logger.warn(`[abr] Fragment ${frag.sn}${part?" part "+part.index:""} of level ${frag.level} is loading too slowly;\n      Time to underbuffer: ${bufferStarvationDelay.toFixed(3)} s\n      Estimated load time for current fragment: ${fragLoadedDelay.toFixed(3)} s\n      Estimated load time for down switch fragment: ${fragLevelNextLoadedDelay.toFixed(3)} s\n      TTFB estimate: ${0|ttfb} ms\n      Current BW estimate: ${isFiniteNumber(bwEstimate)?0|bwEstimate:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${nextLoadLevel} @ ${0|nextLoadLevelBitrate} bps`),hls.trigger(Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag,part,stats})},this.hls=_hls,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(abrEwmaDefaultEstimate){abrEwmaDefaultEstimate&&(logger.log(`setting initial bwe to ${abrEwmaDefaultEstimate}`),this.hls.config.abrEwmaDefaultEstimate=abrEwmaDefaultEstimate),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const config=this.hls.config;return new EwmaBandWidthEstimator(config.abrEwmaSlowVoD,config.abrEwmaFastVoD,config.abrEwmaDefaultEstimate)}registerListeners(){const{hls}=this;hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.FRAG_LOADING,this.onFragLoading,this),hls.on(Events.FRAG_LOADED,this.onFragLoaded,this),hls.on(Events.FRAG_BUFFERED,this.onFragBuffered,this),hls.on(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),hls.on(Events.ERROR,this.onError,this)}unregisterListeners(){const{hls}=this;hls&&(hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.FRAG_LOADING,this.onFragLoading,this),hls.off(Events.FRAG_LOADED,this.onFragLoaded,this),hls.off(Events.FRAG_BUFFERED,this.onFragBuffered,this),hls.off(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),hls.off(Events.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(event,data){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(event,data){const frag=data.frag;if(!this.ignoreFragment(frag)){var _data$part;if(!frag.bitrateTest)this.fragCurrent=frag,this.partCurrent=null!=(_data$part=data.part)?_data$part:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(event,data){this.clearTimer()}onError(event,data){if(!data.fatal)switch(data.details){case ErrorDetails.BUFFER_ADD_CODEC_ERROR:case ErrorDetails.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case ErrorDetails.FRAG_LOAD_TIMEOUT:{const frag=data.frag,{fragCurrent,partCurrent:part}=this;if(frag&&fragCurrent&&frag.sn===fragCurrent.sn&&frag.level===fragCurrent.level){const now=performance.now(),stats=part?part.stats:frag.stats,timeLoading=now-stats.loading.start,ttfb=stats.loading.first?stats.loading.first-stats.loading.start:-1;if(stats.loaded&&ttfb>-1){const ttfbEstimate=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(timeLoading-Math.min(ttfbEstimate,ttfb),stats.loaded)}else this.bwEstimator.sampleTTFB(timeLoading)}break}}}getTimeToLoadFrag(timeToFirstByteSec,bandwidth,fragSizeBits,isSwitch){return timeToFirstByteSec+fragSizeBits/bandwidth+(isSwitch?this.lastLevelLoadSec:0)}onLevelLoaded(event,data){const config=this.hls.config,{loading}=data.stats,timeLoadingMs=loading.end-loading.start;isFiniteNumber(timeLoadingMs)&&(this.lastLevelLoadSec=timeLoadingMs/1e3),data.details.live?this.bwEstimator.update(config.abrEwmaSlowLive,config.abrEwmaFastLive):this.bwEstimator.update(config.abrEwmaSlowVoD,config.abrEwmaFastVoD)}onFragLoaded(event,{frag,part}){const stats=part?part.stats:frag.stats;if(frag.type===PlaylistLevelType_MAIN&&this.bwEstimator.sampleTTFB(stats.loading.first-stats.loading.start),!this.ignoreFragment(frag)){if(this.clearTimer(),frag.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const duration=part?part.duration:frag.duration,level=this.hls.levels[frag.level],loadedBytes=(level.loaded?level.loaded.bytes:0)+stats.loaded,loadedDuration=(level.loaded?level.loaded.duration:0)+duration;level.loaded={bytes:loadedBytes,duration:loadedDuration},level.realBitrate=Math.round(8*loadedBytes/loadedDuration)}if(frag.bitrateTest){const fragBufferedData={stats,frag,part,id:frag.type};this.onFragBuffered(Events.FRAG_BUFFERED,fragBufferedData),frag.bitrateTest=!1}else this.lastLoadedFragLevel=frag.level}}onFragBuffered(event,data){const{frag,part}=data,stats=null!=part&&part.stats.loaded?part.stats:frag.stats;if(stats.aborted)return;if(this.ignoreFragment(frag))return;const processingMs=stats.parsing.end-stats.loading.start-Math.min(stats.loading.first-stats.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(processingMs,stats.loaded),stats.bwEstimate=this.getBwEstimate(),frag.bitrateTest?this.bitrateTestDelay=processingMs/1e3:this.bitrateTestDelay=0}ignoreFragment(frag){return frag.type!==PlaylistLevelType_MAIN||"initSegment"===frag.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel,minAutoLevel}=this.hls,bwEstimate=this.getBwEstimate(),maxStartDelay=this.hls.config.maxStarvationDelay,abrAutoLevel=this.findBestLevel(bwEstimate,minAutoLevel,maxAutoLevel,0,maxStartDelay,1,1);if(abrAutoLevel>-1)return abrAutoLevel;const firstLevel=this.hls.firstLevel,clamped=Math.min(Math.max(firstLevel,minAutoLevel),maxAutoLevel);return logger.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${firstLevel} clamped to ${clamped}`),clamped}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const forcedAutoLevel=this.forcedAutoLevel,useEstimate=this.bwEstimator.canEstimate(),loadedFirstFrag=this.lastLoadedFragLevel>-1;if(!(-1===forcedAutoLevel||useEstimate&&loadedFirstFrag&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return forcedAutoLevel;const nextABRAutoLevel=useEstimate&&loadedFirstFrag?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==forcedAutoLevel){const levels=this.hls.levels;if(levels.length>Math.max(forcedAutoLevel,nextABRAutoLevel)&&levels[forcedAutoLevel].loadError<=levels[nextABRAutoLevel].loadError)return forcedAutoLevel}return this._nextAutoLevel=nextABRAutoLevel,this.nextAutoLevelKey=this.getAutoLevelKey(),nextABRAutoLevel}getAutoLevelKey(){var _this$hls$mainForward;return`${this.getBwEstimate()}_${null==(_this$hls$mainForward=this.hls.mainForwardBufferInfo)?void 0:_this$hls$mainForward.len}`}getNextABRAutoLevel(){const{fragCurrent,partCurrent,hls}=this,{maxAutoLevel,config,minAutoLevel,media}=hls,currentFragDuration=partCurrent?partCurrent.duration:fragCurrent?fragCurrent.duration:0,playbackRate=media&&0!==media.playbackRate?Math.abs(media.playbackRate):1,avgbw=this.getBwEstimate(),bufferInfo=hls.mainForwardBufferInfo,bufferStarvationDelay=(bufferInfo?bufferInfo.len:0)/playbackRate;let bwFactor=config.abrBandWidthFactor,bwUpFactor=config.abrBandWidthUpFactor;if(bufferStarvationDelay){const _bestLevel=this.findBestLevel(avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,0,bwFactor,bwUpFactor);if(_bestLevel>=0)return _bestLevel}let maxStarvationDelay=currentFragDuration?Math.min(currentFragDuration,config.maxStarvationDelay):config.maxStarvationDelay;if(!bufferStarvationDelay){const bitrateTestDelay=this.bitrateTestDelay;if(bitrateTestDelay){maxStarvationDelay=(currentFragDuration?Math.min(currentFragDuration,config.maxLoadingDelay):config.maxLoadingDelay)-bitrateTestDelay,logger.info(`[abr] bitrate test took ${Math.round(1e3*bitrateTestDelay)}ms, set first fragment max fetchDuration to ${Math.round(1e3*maxStarvationDelay)} ms`),bwFactor=bwUpFactor=1}}const bestLevel=this.findBestLevel(avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,maxStarvationDelay,bwFactor,bwUpFactor);if(logger.info(`[abr] ${bufferStarvationDelay?"rebuffering expected":"buffer is empty"}, optimal quality level ${bestLevel}`),bestLevel>-1)return bestLevel;const minLevel=hls.levels[minAutoLevel],autoLevel=hls.levels[hls.loadLevel];return(null==minLevel?void 0:minLevel.bitrate)<(null==autoLevel?void 0:autoLevel.bitrate)?minAutoLevel:hls.loadLevel}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(currentBw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,maxStarvationDelay,bwFactor,bwUpFactor){var _level$details;const maxFetchDuration=bufferStarvationDelay+maxStarvationDelay,lastLoadedFragLevel=this.lastLoadedFragLevel,selectionBaseLevel=-1===lastLoadedFragLevel?this.hls.firstLevel:lastLoadedFragLevel,{fragCurrent,partCurrent}=this,{levels,allAudioTracks,loadLevel,config}=this.hls;if(1===levels.length)return 0;const level=levels[selectionBaseLevel],live=!(null==level||null==(_level$details=level.details)||!_level$details.live),firstSelection=-1===loadLevel||-1===lastLoadedFragLevel;let currentCodecSet,currentVideoRange="SDR",currentFrameRate=(null==level?void 0:level.frameRate)||0;const{audioPreference,videoPreference}=config,audioTracksByGroup=this.audioTracksByGroup||(this.audioTracksByGroup=function getAudioTracksByGroup(allAudioTracks){return allAudioTracks.reduce(((audioTracksByGroup,track)=>{let trackGroup=audioTracksByGroup.groups[track.groupId];trackGroup||(trackGroup=audioTracksByGroup.groups[track.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),trackGroup.tracks.push(track);const channelsKey=track.channels||"2";return trackGroup.channels[channelsKey]=(trackGroup.channels[channelsKey]||0)+1,trackGroup.hasDefault=trackGroup.hasDefault||track.default,trackGroup.hasAutoSelect=trackGroup.hasAutoSelect||track.autoselect,trackGroup.hasDefault&&(audioTracksByGroup.hasDefaultAudio=!0),trackGroup.hasAutoSelect&&(audioTracksByGroup.hasAutoSelectAudio=!0),audioTracksByGroup}),{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}(allAudioTracks));if(firstSelection){if(-1!==this.firstSelection)return this.firstSelection;const codecTiers=this.codecTiers||(this.codecTiers=function getCodecTiers(levels,audioTracksByGroup,minAutoLevel,maxAutoLevel){return levels.slice(minAutoLevel,maxAutoLevel+1).reduce(((tiers,level)=>{if(!level.codecSet)return tiers;const audioGroups=level.audioGroups;let tier=tiers[level.codecSet];tier||(tiers[level.codecSet]=tier={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!audioGroups,fragmentError:0}),tier.minBitrate=Math.min(tier.minBitrate,level.bitrate);const lesserWidthOrHeight=Math.min(level.height,level.width);return tier.minHeight=Math.min(tier.minHeight,lesserWidthOrHeight),tier.minFramerate=Math.min(tier.minFramerate,level.frameRate),tier.maxScore=Math.max(tier.maxScore,level.score),tier.fragmentError+=level.fragmentError,tier.videoRanges[level.videoRange]=(tier.videoRanges[level.videoRange]||0)+1,audioGroups&&audioGroups.forEach((audioGroupId=>{if(!audioGroupId)return;const audioGroup=audioTracksByGroup.groups[audioGroupId];tier.hasDefaultAudio=tier.hasDefaultAudio||audioTracksByGroup.hasDefaultAudio?audioGroup.hasDefault:audioGroup.hasAutoSelect||!audioTracksByGroup.hasDefaultAudio&&!audioTracksByGroup.hasAutoSelectAudio,Object.keys(audioGroup.channels).forEach((channels=>{tier.channels[channels]=(tier.channels[channels]||0)+audioGroup.channels[channels]}))})),tiers}),{})}(levels,audioTracksByGroup,minAutoLevel,maxAutoLevel)),startTier=function getStartCodecTier(codecTiers,currentVideoRange,currentBw,audioPreference,videoPreference){const codecSets=Object.keys(codecTiers),channelsPreference=null==audioPreference?void 0:audioPreference.channels,audioCodecPreference=null==audioPreference?void 0:audioPreference.audioCodec,preferStereo=channelsPreference&&2===parseInt(channelsPreference);let hasStereo=!0,hasCurrentVideoRange=!1,minHeight=1/0,minFramerate=1/0,minBitrate=1/0,selectedScore=0,videoRanges=[];const{preferHDR,allowedVideoRanges}=getVideoSelectionOptions(currentVideoRange,videoPreference);for(let i=codecSets.length;i--;){const tier=codecTiers[codecSets[i]];hasStereo=tier.channels[2]>0,minHeight=Math.min(minHeight,tier.minHeight),minFramerate=Math.min(minFramerate,tier.minFramerate),minBitrate=Math.min(minBitrate,tier.minBitrate);const matchingVideoRanges=allowedVideoRanges.filter((range=>tier.videoRanges[range]>0));matchingVideoRanges.length>0&&(hasCurrentVideoRange=!0,videoRanges=matchingVideoRanges)}minHeight=isFiniteNumber(minHeight)?minHeight:0,minFramerate=isFiniteNumber(minFramerate)?minFramerate:0;const maxHeight=Math.max(1080,minHeight),maxFramerate=Math.max(30,minFramerate);return minBitrate=isFiniteNumber(minBitrate)?minBitrate:currentBw,currentBw=Math.max(minBitrate,currentBw),hasCurrentVideoRange||(currentVideoRange=void 0,videoRanges=[]),{codecSet:codecSets.reduce(((selected,candidate)=>{const candidateTier=codecTiers[candidate];if(candidate===selected)return selected;if(candidateTier.minBitrate>currentBw)return logStartCodecCandidateIgnored(candidate,`min bitrate of ${candidateTier.minBitrate} > current estimate of ${currentBw}`),selected;if(!candidateTier.hasDefaultAudio)return logStartCodecCandidateIgnored(candidate,"no renditions with default or auto-select sound found"),selected;if(audioCodecPreference&&candidate.indexOf(audioCodecPreference.substring(0,4))%5!=0)return logStartCodecCandidateIgnored(candidate,`audio codec preference "${audioCodecPreference}" not found`),selected;if(channelsPreference&&!preferStereo){if(!candidateTier.channels[channelsPreference])return logStartCodecCandidateIgnored(candidate,`no renditions with ${channelsPreference} channel sound found (channels options: ${Object.keys(candidateTier.channels)})`),selected}else if((!audioCodecPreference||preferStereo)&&hasStereo&&0===candidateTier.channels[2])return logStartCodecCandidateIgnored(candidate,"no renditions with stereo sound found"),selected;return candidateTier.minHeight>maxHeight?(logStartCodecCandidateIgnored(candidate,`min resolution of ${candidateTier.minHeight} > maximum of ${maxHeight}`),selected):candidateTier.minFramerate>maxFramerate?(logStartCodecCandidateIgnored(candidate,`min framerate of ${candidateTier.minFramerate} > maximum of ${maxFramerate}`),selected):videoRanges.some((range=>candidateTier.videoRanges[range]>0))?candidateTier.maxScore<selectedScore?(logStartCodecCandidateIgnored(candidate,`max score of ${candidateTier.maxScore} < selected max of ${selectedScore}`),selected):selected&&(codecsSetSelectionPreferenceValue(candidate)>=codecsSetSelectionPreferenceValue(selected)||candidateTier.fragmentError>codecTiers[selected].fragmentError)?selected:(selectedScore=candidateTier.maxScore,candidate):(logStartCodecCandidateIgnored(candidate,`no variants with VIDEO-RANGE of ${JSON.stringify(videoRanges)} found`),selected)}),void 0),videoRanges,preferHDR,minFramerate,minBitrate}}(codecTiers,currentVideoRange,currentBw,audioPreference,videoPreference),{codecSet,videoRanges,minFramerate,minBitrate,preferHDR}=startTier;currentCodecSet=codecSet,currentVideoRange=preferHDR?videoRanges[videoRanges.length-1]:videoRanges[0],currentFrameRate=minFramerate,currentBw=Math.max(currentBw,minBitrate),logger.log(`[abr] picked start tier ${JSON.stringify(startTier)}`)}else currentCodecSet=null==level?void 0:level.codecSet,currentVideoRange=null==level?void 0:level.videoRange;const currentFragDuration=partCurrent?partCurrent.duration:fragCurrent?fragCurrent.duration:0,ttfbEstimateSec=this.bwEstimator.getEstimateTTFB()/1e3,levelsSkipped=[];for(let i=maxAutoLevel;i>=minAutoLevel;i--){var _levelInfo$supportedR;const levelInfo=levels[i],upSwitch=i>selectionBaseLevel;if(!levelInfo)continue;if(config.useMediaCapabilities&&!levelInfo.supportedResult&&!levelInfo.supportedPromise){const mediaCapabilities=navigator.mediaCapabilities;"function"==typeof(null==mediaCapabilities?void 0:mediaCapabilities.decodingInfo)&&requiresMediaCapabilitiesDecodingInfo(levelInfo,audioTracksByGroup,currentVideoRange,currentFrameRate,currentBw,audioPreference)?(levelInfo.supportedPromise=getMediaDecodingInfoPromise(levelInfo,audioTracksByGroup,mediaCapabilities),levelInfo.supportedPromise.then((decodingInfo=>{levelInfo.supportedResult=decodingInfo;const levels=this.hls.levels,index=levels.indexOf(levelInfo);decodingInfo.error?logger.warn(`[abr] MediaCapabilities decodingInfo error: "${decodingInfo.error}" for level ${index} ${JSON.stringify(decodingInfo)}`):decodingInfo.supported||(logger.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${index} ${JSON.stringify(decodingInfo)}`),index>-1&&levels.length>1&&(logger.log(`[abr] Removing unsupported level ${index}`),this.hls.removeLevel(index)))}))):levelInfo.supportedResult=SUPPORTED_INFO_DEFAULT}if(currentCodecSet&&levelInfo.codecSet!==currentCodecSet||currentVideoRange&&levelInfo.videoRange!==currentVideoRange||upSwitch&&currentFrameRate>levelInfo.frameRate||!upSwitch&&currentFrameRate>0&&currentFrameRate<levelInfo.frameRate||levelInfo.supportedResult&&(null==(_levelInfo$supportedR=levelInfo.supportedResult.decodingInfoResults)||!_levelInfo$supportedR[0].smooth)){levelsSkipped.push(i);continue}const levelDetails=levelInfo.details,avgDuration=(partCurrent?null==levelDetails?void 0:levelDetails.partTarget:null==levelDetails?void 0:levelDetails.averagetargetduration)||currentFragDuration;let adjustedbw;adjustedbw=upSwitch?bwUpFactor*currentBw:bwFactor*currentBw;const bitrate=currentFragDuration&&bufferStarvationDelay>=2*currentFragDuration&&0===maxStarvationDelay?levels[i].averageBitrate:levels[i].maxBitrate,fetchDuration=this.getTimeToLoadFrag(ttfbEstimateSec,adjustedbw,bitrate*avgDuration,void 0===levelDetails);if(adjustedbw>=bitrate&&(i===lastLoadedFragLevel||0===levelInfo.loadError&&0===levelInfo.fragmentError)&&(fetchDuration<=ttfbEstimateSec||!isFiniteNumber(fetchDuration)||live&&!this.bitrateTestDelay||fetchDuration<maxFetchDuration)){const forcedAutoLevel=this.forcedAutoLevel;return i===loadLevel||-1!==forcedAutoLevel&&forcedAutoLevel===loadLevel||(levelsSkipped.length&&logger.trace(`[abr] Skipped level(s) ${levelsSkipped.join(",")} of ${maxAutoLevel} max with CODECS and VIDEO-RANGE:"${levels[levelsSkipped[0]].codecs}" ${levels[levelsSkipped[0]].videoRange}; not compatible with "${level.codecs}" ${currentVideoRange}`),logger.info(`[abr] switch candidate:${selectionBaseLevel}->${i} adjustedbw(${Math.round(adjustedbw)})-bitrate=${Math.round(adjustedbw-bitrate)} ttfb:${ttfbEstimateSec.toFixed(1)} avgDuration:${avgDuration.toFixed(1)} maxFetchDuration:${maxFetchDuration.toFixed(1)} fetchDuration:${fetchDuration.toFixed(1)} firstSelection:${firstSelection} codecSet:${currentCodecSet} videoRange:${currentVideoRange} hls.loadLevel:${loadLevel}`)),firstSelection&&(this.firstSelection=i),i}}return-1}set nextAutoLevel(nextLevel){const value=Math.max(this.hls.minAutoLevel,nextLevel);this._nextAutoLevel!=value&&(this.nextAutoLevelKey="",this._nextAutoLevel=value)}},bufferController:class BufferController{constructor(hls){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=event=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=event=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media,mediaSource}=this;this.log("Media source opened"),media&&(media.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(Events.MEDIA_ATTACHED,{media,mediaSource})),mediaSource&&mediaSource.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc,_objectUrl}=this;mediaSrc!==_objectUrl&&logger.error(`Media element src was set while attaching MediaSource (${_objectUrl} > ${mediaSrc})`)},this.hls=hls;const logPrefix="[buffer-controller]";this.appendSource=hls.config.preferManagedMediaSource,this.log=logger.log.bind(logger,logPrefix),this.warn=logger.warn.bind(logger,logPrefix),this.error=logger.error.bind(logger,logPrefix),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls}=this;hls.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events.BUFFER_RESET,this.onBufferReset,this),hls.on(Events.BUFFER_APPENDING,this.onBufferAppending,this),hls.on(Events.BUFFER_CODECS,this.onBufferCodecs,this),hls.on(Events.BUFFER_EOS,this.onBufferEos,this),hls.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this),hls.on(Events.FRAG_PARSED,this.onFragParsed,this),hls.on(Events.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls}=this;hls.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events.BUFFER_RESET,this.onBufferReset,this),hls.off(Events.BUFFER_APPENDING,this.onBufferAppending,this),hls.off(Events.BUFFER_CODECS,this.onBufferCodecs,this),hls.off(Events.BUFFER_EOS,this.onBufferEos,this),hls.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this),hls.off(Events.FRAG_PARSED,this.onFragParsed,this),hls.off(Events.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new BufferOperationQueue(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(event,data){let codecEvents=2;(data.audio&&!data.video||!data.altAudio)&&(codecEvents=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=codecEvents,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(event,data){const media=this.media=data.media,MediaSource=getMediaSource(this.appendSource);if(media&&MediaSource){var _ms$constructor;const ms=this.mediaSource=new MediaSource;this.log(`created media source: ${null==(_ms$constructor=ms.constructor)?void 0:_ms$constructor.name}`),ms.addEventListener("sourceopen",this._onMediaSourceOpen),ms.addEventListener("sourceended",this._onMediaSourceEnded),ms.addEventListener("sourceclose",this._onMediaSourceClose),ms.addEventListener("startstreaming",this._onStartStreaming),ms.addEventListener("endstreaming",this._onEndStreaming);const objectUrl=this._objectUrl=self.URL.createObjectURL(ms);if(this.appendSource)try{media.removeAttribute("src");const MMS=self.ManagedMediaSource;media.disableRemotePlayback=media.disableRemotePlayback||MMS&&ms instanceof MMS,removeSourceChildren(media),function addSource(media,url){const source=self.document.createElement("source");source.type="video/mp4",source.src=url,media.appendChild(source)}(media,objectUrl),media.load()}catch(error){media.src=objectUrl}else media.src=objectUrl;media.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media,mediaSource,_objectUrl}=this;if(mediaSource){if(this.log("media source detaching"),"open"===mediaSource.readyState)try{mediaSource.endOfStream()}catch(err){this.warn(`onMediaDetaching: ${err.message} while calling endOfStream`)}this.onBufferReset(),mediaSource.removeEventListener("sourceopen",this._onMediaSourceOpen),mediaSource.removeEventListener("sourceended",this._onMediaSourceEnded),mediaSource.removeEventListener("sourceclose",this._onMediaSourceClose),mediaSource.removeEventListener("startstreaming",this._onStartStreaming),mediaSource.removeEventListener("endstreaming",this._onEndStreaming),media&&(media.removeEventListener("emptied",this._onMediaEmptied),_objectUrl&&self.URL.revokeObjectURL(_objectUrl),this.mediaSrc===_objectUrl?(media.removeAttribute("src"),this.appendSource&&removeSourceChildren(media),media.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(Events.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((type=>{this.resetBuffer(type)})),this._initSourceBuffer()}resetBuffer(type){const sb=this.sourceBuffer[type];try{var _this$mediaSource;if(sb)this.removeBufferListeners(type),this.sourceBuffer[type]=void 0,null!=(_this$mediaSource=this.mediaSource)&&_this$mediaSource.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(sb)}catch(err){this.warn(`onBufferReset ${type}`,err)}}onBufferCodecs(event,data){const sourceBufferCount=this.getSourceBufferTypes().length,trackNames=Object.keys(data);if(trackNames.forEach((trackName=>{if(sourceBufferCount){const track=this.tracks[trackName];if(track&&"function"==typeof track.buffer.changeType){var _trackCodec;const{id,codec,levelCodec,container,metadata}=data[trackName],currentCodecFull=pickMostCompleteCodecName(track.codec,track.levelCodec),currentCodec=null==currentCodecFull?void 0:currentCodecFull.replace(VIDEO_CODEC_PROFILE_REPLACE,"$1");let trackCodec=pickMostCompleteCodecName(codec,levelCodec);const nextCodec=null==(_trackCodec=trackCodec)?void 0:_trackCodec.replace(VIDEO_CODEC_PROFILE_REPLACE,"$1");if(trackCodec&&currentCodec!==nextCodec){"audio"===trackName.slice(0,5)&&(trackCodec=getCodecCompatibleName(trackCodec,this.hls.config.preferManagedMediaSource));const mimeType=`${container};codecs=${trackCodec}`;this.appendChangeType(trackName,mimeType),this.log(`switching codec ${currentCodecFull} to ${trackCodec}`),this.tracks[trackName]={buffer:track.buffer,codec,container,levelCodec,metadata,id}}}}else this.pendingTracks[trackName]=data[trackName]})),sourceBufferCount)return;const bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==bufferCodecEventsExpected&&(this.log(`${bufferCodecEventsExpected} bufferCodec event(s) expected ${trackNames.join(",")}`),this.bufferCodecEventsExpected=bufferCodecEventsExpected),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(type,mimeType){const{operationQueue}=this,operation={execute:()=>{const sb=this.sourceBuffer[type];sb&&(this.log(`changing ${type} sourceBuffer type to ${mimeType}`),sb.changeType(mimeType)),operationQueue.shiftAndExecuteNext(type)},onStart:()=>{},onComplete:()=>{},onError:error=>{this.warn(`Failed to change ${type} SourceBuffer type`,error)}};operationQueue.append(operation,type,!!this.pendingTracks[type])}onBufferAppending(event,eventData){const{hls,operationQueue,tracks}=this,{data,type,frag,part,chunkMeta}=eventData,chunkStats=chunkMeta.buffering[type],bufferAppendingStart=self.performance.now();chunkStats.start=bufferAppendingStart;const fragBuffering=frag.stats.buffering,partBuffering=part?part.stats.buffering:null;0===fragBuffering.start&&(fragBuffering.start=bufferAppendingStart),partBuffering&&0===partBuffering.start&&(partBuffering.start=bufferAppendingStart);const audioTrack=tracks.audio;let checkTimestampOffset=!1;"audio"===type&&"audio/mpeg"===(null==audioTrack?void 0:audioTrack.container)&&(checkTimestampOffset=!this.lastMpegAudioChunk||1===chunkMeta.id||this.lastMpegAudioChunk.sn!==chunkMeta.sn,this.lastMpegAudioChunk=chunkMeta);const fragStart=frag.start,operation={execute:()=>{if(chunkStats.executeStart=self.performance.now(),checkTimestampOffset){const sb=this.sourceBuffer[type];if(sb){const delta=fragStart-sb.timestampOffset;Math.abs(delta)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${fragStart} (delta: ${delta}) sn: ${frag.sn})`),sb.timestampOffset=fragStart)}}this.appendExecutor(data,type)},onStart:()=>{},onComplete:()=>{const end=self.performance.now();chunkStats.executeEnd=chunkStats.end=end,0===fragBuffering.first&&(fragBuffering.first=end),partBuffering&&0===partBuffering.first&&(partBuffering.first=end);const{sourceBuffer}=this,timeRanges={};for(const type in sourceBuffer)timeRanges[type]=BufferHelper.getBuffered(sourceBuffer[type]);this.appendErrors[type]=0,"audio"===type||"video"===type?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(Events.BUFFER_APPENDED,{type,frag,part,chunkMeta,parent:frag.type,timeRanges})},onError:error=>{const event={type:ErrorTypes.MEDIA_ERROR,parent:frag.type,details:ErrorDetails.BUFFER_APPEND_ERROR,sourceBufferName:type,frag,part,chunkMeta,error,err:error,fatal:!1};if(error.code===DOMException.QUOTA_EXCEEDED_ERR)event.details=ErrorDetails.BUFFER_FULL_ERROR;else{const appendErrorCount=++this.appendErrors[type];event.details=ErrorDetails.BUFFER_APPEND_ERROR,this.warn(`Failed ${appendErrorCount}/${hls.config.appendErrorMaxRetry} times to append segment in "${type}" sourceBuffer`),appendErrorCount>=hls.config.appendErrorMaxRetry&&(event.fatal=!0)}hls.trigger(Events.ERROR,event)}};operationQueue.append(operation,type,!!this.pendingTracks[type])}onBufferFlushing(event,data){const{operationQueue}=this,flushOperation=type=>({execute:this.removeExecutor.bind(this,type,data.startOffset,data.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(Events.BUFFER_FLUSHED,{type})},onError:error=>{this.warn(`Failed to remove from ${type} SourceBuffer`,error)}});data.type?operationQueue.append(flushOperation(data.type),data.type):this.getSourceBufferTypes().forEach((type=>{operationQueue.append(flushOperation(type),type)}))}onFragParsed(event,data){const{frag,part}=data,buffersAppendedTo=[],elementaryStreams=part?part.elementaryStreams:frag.elementaryStreams;elementaryStreams[ElementaryStreamTypes_AUDIOVIDEO]?buffersAppendedTo.push("audiovideo"):(elementaryStreams[ElementaryStreamTypes_AUDIO]&&buffersAppendedTo.push("audio"),elementaryStreams[ElementaryStreamTypes_VIDEO]&&buffersAppendedTo.push("video"));0===buffersAppendedTo.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${frag.type} level: ${frag.level} sn: ${frag.sn}`),this.blockBuffers((()=>{const now=self.performance.now();frag.stats.buffering.end=now,part&&(part.stats.buffering.end=now);const stats=part?part.stats:frag.stats;this.hls.trigger(Events.FRAG_BUFFERED,{frag,part,stats,id:frag.type})}),buffersAppendedTo)}onFragChanged(event,data){this.trimBuffers()}onBufferEos(event,data){this.getSourceBufferTypes().reduce(((acc,type)=>{const sb=this.sourceBuffer[type];return!sb||data.type&&data.type!==type||(sb.ending=!0,sb.ended||(sb.ended=!0,this.log(`${type} sourceBuffer now EOS`))),acc&&!(sb&&!sb.ended)}),!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers((()=>{this.getSourceBufferTypes().forEach((type=>{const sb=this.sourceBuffer[type];sb&&(sb.ending=!1)}));const{mediaSource}=this;mediaSource&&"open"===mediaSource.readyState?(this.log("Calling mediaSource.endOfStream()"),mediaSource.endOfStream()):mediaSource&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${mediaSource.readyState}`)})))}onLevelUpdated(event,{details}){details.fragments.length&&(this.details=details,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls,details,media}=this;if(!media||null===details)return;if(!this.getSourceBufferTypes().length)return;const config=hls.config,currentTime=media.currentTime,targetDuration=details.levelTargetDuration,backBufferLength=details.live&&null!==config.liveBackBufferLength?config.liveBackBufferLength:config.backBufferLength;if(isFiniteNumber(backBufferLength)&&backBufferLength>0){const maxBackBufferLength=Math.max(backBufferLength,targetDuration),targetBackBufferPosition=Math.floor(currentTime/targetDuration)*targetDuration-maxBackBufferLength;this.flushBackBuffer(currentTime,targetDuration,targetBackBufferPosition)}if(isFiniteNumber(config.frontBufferFlushThreshold)&&config.frontBufferFlushThreshold>0){const frontBufferLength=Math.max(config.maxBufferLength,config.frontBufferFlushThreshold),maxFrontBufferLength=Math.max(frontBufferLength,targetDuration),targetFrontBufferPosition=Math.floor(currentTime/targetDuration)*targetDuration+maxFrontBufferLength;this.flushFrontBuffer(currentTime,targetDuration,targetFrontBufferPosition)}}flushBackBuffer(currentTime,targetDuration,targetBackBufferPosition){const{details,sourceBuffer}=this;this.getSourceBufferTypes().forEach((type=>{const sb=sourceBuffer[type];if(sb){const buffered=BufferHelper.getBuffered(sb);if(buffered.length>0&&targetBackBufferPosition>buffered.start(0)){if(this.hls.trigger(Events.BACK_BUFFER_REACHED,{bufferEnd:targetBackBufferPosition}),null!=details&&details.live)this.hls.trigger(Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:targetBackBufferPosition});else if(sb.ended&&buffered.end(buffered.length-1)-currentTime<2*targetDuration)return void this.log(`Cannot flush ${type} back buffer while SourceBuffer is in ended state`);this.hls.trigger(Events.BUFFER_FLUSHING,{startOffset:0,endOffset:targetBackBufferPosition,type})}}}))}flushFrontBuffer(currentTime,targetDuration,targetFrontBufferPosition){const{sourceBuffer}=this;this.getSourceBufferTypes().forEach((type=>{const sb=sourceBuffer[type];if(sb){const buffered=BufferHelper.getBuffered(sb),numBufferedRanges=buffered.length;if(numBufferedRanges<2)return;const bufferStart=buffered.start(numBufferedRanges-1),bufferEnd=buffered.end(numBufferedRanges-1);if(targetFrontBufferPosition>bufferStart||currentTime>=bufferStart&&currentTime<=bufferEnd)return;if(sb.ended&&currentTime-bufferEnd<2*targetDuration)return void this.log(`Cannot flush ${type} front buffer while SourceBuffer is in ended state`);this.hls.trigger(Events.BUFFER_FLUSHING,{startOffset:bufferStart,endOffset:1/0,type})}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details,hls,media,mediaSource}=this,levelDuration=details.fragments[0].start+details.totalduration,mediaDuration=media.duration,msDuration=isFiniteNumber(mediaSource.duration)?mediaSource.duration:0;details.live&&hls.config.liveDurationInfinity?(mediaSource.duration=1/0,this.updateSeekableRange(details)):(levelDuration>msDuration&&levelDuration>mediaDuration||!isFiniteNumber(mediaDuration))&&(this.log(`Updating Media Source duration to ${levelDuration.toFixed(3)}`),mediaSource.duration=levelDuration)}updateSeekableRange(levelDetails){const mediaSource=this.mediaSource,fragments=levelDetails.fragments;if(fragments.length&&levelDetails.live&&null!=mediaSource&&mediaSource.setLiveSeekableRange){const start=Math.max(0,fragments[0].start),end=Math.max(start,start+levelDetails.totalduration);this.log(`Media Source duration is set to ${mediaSource.duration}. Setting seekable range to ${start}-${end}.`),mediaSource.setLiveSeekableRange(start,end)}}checkPendingTracks(){const{bufferCodecEventsExpected,operationQueue,pendingTracks}=this,pendingTracksCount=Object.keys(pendingTracks).length;if(pendingTracksCount&&(!bufferCodecEventsExpected||2===pendingTracksCount||"audiovideo"in pendingTracks)){this.createSourceBuffers(pendingTracks),this.pendingTracks={};const buffers=this.getSourceBufferTypes();if(buffers.length)this.hls.trigger(Events.BUFFER_CREATED,{tracks:this.tracks}),buffers.forEach((type=>{operationQueue.executeNext(type)}));else{const error=new Error("could not create source buffer for media codec(s)");this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error,reason:error.message})}}}createSourceBuffers(tracks){const{sourceBuffer,mediaSource}=this;if(!mediaSource)throw Error("createSourceBuffers called when mediaSource was null");for(const trackName in tracks)if(!sourceBuffer[trackName]){const track=tracks[trackName];if(!track)throw Error(`source buffer exists for track ${trackName}, however track does not`);let codec=track.levelCodec||track.codec;codec&&"audio"===trackName.slice(0,5)&&(codec=getCodecCompatibleName(codec,this.hls.config.preferManagedMediaSource));const mimeType=`${track.container};codecs=${codec}`;this.log(`creating sourceBuffer(${mimeType})`);try{const sb=sourceBuffer[trackName]=mediaSource.addSourceBuffer(mimeType),sbName=trackName;this.addBufferListener(sbName,"updatestart",this._onSBUpdateStart),this.addBufferListener(sbName,"updateend",this._onSBUpdateEnd),this.addBufferListener(sbName,"error",this._onSBUpdateError),this.addBufferListener(sbName,"bufferedchange",((type,event)=>{const removedRanges=event.removedRanges;null!=removedRanges&&removedRanges.length&&this.hls.trigger(Events.BUFFER_FLUSHED,{type:trackName})})),this.tracks[trackName]={buffer:sb,codec,container:track.container,levelCodec:track.levelCodec,metadata:track.metadata,id:track.id}}catch(err){this.error(`error while trying to add sourceBuffer: ${err.message}`),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:err,sourceBufferName:trackName,mimeType})}}}get mediaSrc(){var _this$media;const media=(null==(_this$media=this.media)?void 0:_this$media.firstChild)||this.media;return null==media?void 0:media.src}_onSBUpdateStart(type){const{operationQueue}=this;operationQueue.current(type).onStart()}_onSBUpdateEnd(type){var _this$mediaSource2;if("closed"===(null==(_this$mediaSource2=this.mediaSource)?void 0:_this$mediaSource2.readyState))return void this.resetBuffer(type);const{operationQueue}=this;operationQueue.current(type).onComplete(),operationQueue.shiftAndExecuteNext(type)}_onSBUpdateError(type,event){var _this$mediaSource3;const error=new Error(`${type} SourceBuffer error. MediaSource readyState: ${null==(_this$mediaSource3=this.mediaSource)?void 0:_this$mediaSource3.readyState}`);this.error(`${error}`,event),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_APPENDING_ERROR,sourceBufferName:type,error,fatal:!1});const operation=this.operationQueue.current(type);operation&&operation.onError(error)}removeExecutor(type,startOffset,endOffset){const{media,mediaSource,operationQueue,sourceBuffer}=this,sb=sourceBuffer[type];if(!media||!mediaSource||!sb)return this.warn(`Attempting to remove from the ${type} SourceBuffer, but it does not exist`),void operationQueue.shiftAndExecuteNext(type);const mediaDuration=isFiniteNumber(media.duration)?media.duration:1/0,msDuration=isFiniteNumber(mediaSource.duration)?mediaSource.duration:1/0,removeStart=Math.max(0,startOffset),removeEnd=Math.min(endOffset,mediaDuration,msDuration);removeEnd>removeStart&&(!sb.ending||sb.ended)?(sb.ended=!1,this.log(`Removing [${removeStart},${removeEnd}] from the ${type} SourceBuffer`),sb.remove(removeStart,removeEnd)):operationQueue.shiftAndExecuteNext(type)}appendExecutor(data,type){const sb=this.sourceBuffer[type];if(sb)sb.ended=!1,sb.appendBuffer(data);else if(!this.pendingTracks[type])throw new Error(`Attempting to append to the ${type} SourceBuffer, but it does not exist`)}blockBuffers(onUnblocked,buffers=this.getSourceBufferTypes()){if(!buffers.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(onUnblocked);const{operationQueue}=this,blockingOperations=buffers.map((type=>operationQueue.appendBlocker(type)));Promise.all(blockingOperations).then((()=>{onUnblocked(),buffers.forEach((type=>{const sb=this.sourceBuffer[type];null!=sb&&sb.updating||operationQueue.shiftAndExecuteNext(type)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(type,event,fn){const buffer=this.sourceBuffer[type];if(!buffer)return;const listener=fn.bind(this,type);this.listeners[type].push({event,listener}),buffer.addEventListener(event,listener)}removeBufferListeners(type){const buffer=this.sourceBuffer[type];buffer&&this.listeners[type].forEach((l=>{buffer.removeEventListener(l.event,l.listener)}))}},capLevelController:CapLevelController,errorController:class ErrorController{constructor(hls){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=hls,this.log=logger.log.bind(logger,"[info]:"),this.warn=logger.warn.bind(logger,"[warning]:"),this.error=logger.error.bind(logger,"[error]:"),this.registerListeners()}registerListeners(){const hls=this.hls;hls.on(Events.ERROR,this.onError,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const hls=this.hls;hls&&(hls.off(Events.ERROR,this.onError,this),hls.off(Events.ERROR,this.onErrorOut,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(startPosition){}stopLoad(){this.playlistError=0}getVariantLevelIndex(frag){return(null==frag?void 0:frag.type)===PlaylistLevelType_MAIN?frag.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(event,data){var _data$frag,_data$level;if(data.fatal)return;const hls=this.hls,context=data.context;switch(data.details){case ErrorDetails.FRAG_LOAD_ERROR:case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_ERROR:case ErrorDetails.KEY_LOAD_TIMEOUT:return void(data.errorAction=this.getFragRetryOrSwitchAction(data));case ErrorDetails.FRAG_PARSING_ERROR:if(null!=(_data$frag=data.frag)&&_data$frag.gap)return void(data.errorAction={action:NetworkErrorAction_DoNothing,flags:ErrorActionFlags_None});case ErrorDetails.FRAG_GAP:case ErrorDetails.FRAG_DECRYPT_ERROR:return data.errorAction=this.getFragRetryOrSwitchAction(data),void(data.errorAction.action=NetworkErrorAction_SendAlternateToPenaltyBox);case ErrorDetails.LEVEL_EMPTY_ERROR:case ErrorDetails.LEVEL_PARSING_ERROR:{var _data$context,_data$context$levelDe;const levelIndex=data.parent===PlaylistLevelType_MAIN?data.level:hls.loadLevel;data.details===ErrorDetails.LEVEL_EMPTY_ERROR&&null!=(_data$context=data.context)&&null!=(_data$context$levelDe=_data$context.levelDetails)&&_data$context$levelDe.live?data.errorAction=this.getPlaylistRetryOrSwitchAction(data,levelIndex):(data.levelRetry=!1,data.errorAction=this.getLevelSwitchAction(data,levelIndex))}return;case ErrorDetails.LEVEL_LOAD_ERROR:case ErrorDetails.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==context?void 0:context.level)&&(data.errorAction=this.getPlaylistRetryOrSwitchAction(data,context.level)));case ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:case ErrorDetails.SUBTITLE_LOAD_ERROR:case ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:if(context){const level=hls.levels[hls.loadLevel];if(level&&(context.type===PlaylistContextType_AUDIO_TRACK&&level.hasAudioGroup(context.groupId)||context.type===PlaylistContextType_SUBTITLE_TRACK&&level.hasSubtitleGroup(context.groupId)))return data.errorAction=this.getPlaylistRetryOrSwitchAction(data,hls.loadLevel),data.errorAction.action=NetworkErrorAction_SendAlternateToPenaltyBox,void(data.errorAction.flags=ErrorActionFlags_MoveAllAlternatesMatchingHost)}return;case ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const level=hls.levels[hls.loadLevel],restrictedHdcpLevel=null==level?void 0:level.attrs["HDCP-LEVEL"];restrictedHdcpLevel?data.errorAction={action:NetworkErrorAction_SendAlternateToPenaltyBox,flags:ErrorActionFlags_MoveAllAlternatesMatchingHDCP,hdcpLevel:restrictedHdcpLevel}:this.keySystemError(data)}return;case ErrorDetails.BUFFER_ADD_CODEC_ERROR:case ErrorDetails.REMUX_ALLOC_ERROR:case ErrorDetails.BUFFER_APPEND_ERROR:return void(data.errorAction=this.getLevelSwitchAction(data,null!=(_data$level=data.level)?_data$level:hls.loadLevel));case ErrorDetails.INTERNAL_EXCEPTION:case ErrorDetails.BUFFER_APPENDING_ERROR:case ErrorDetails.BUFFER_FULL_ERROR:case ErrorDetails.LEVEL_SWITCH_ERROR:case ErrorDetails.BUFFER_STALLED_ERROR:case ErrorDetails.BUFFER_SEEK_OVER_HOLE:case ErrorDetails.BUFFER_NUDGE_ON_STALL:return void(data.errorAction={action:NetworkErrorAction_DoNothing,flags:ErrorActionFlags_None})}data.type===ErrorTypes.KEY_SYSTEM_ERROR&&this.keySystemError(data)}keySystemError(data){const levelIndex=this.getVariantLevelIndex(data.frag);data.levelRetry=!1,data.errorAction=this.getLevelSwitchAction(data,levelIndex)}getPlaylistRetryOrSwitchAction(data,levelIndex){const retryConfig=getRetryConfig(this.hls.config.playlistLoadPolicy,data),retryCount=this.playlistError++;if(shouldRetry(retryConfig,retryCount,isTimeoutError(data),data.response))return{action:NetworkErrorAction_RetryRequest,flags:ErrorActionFlags_None,retryConfig,retryCount};const errorAction=this.getLevelSwitchAction(data,levelIndex);return retryConfig&&(errorAction.retryConfig=retryConfig,errorAction.retryCount=retryCount),errorAction}getFragRetryOrSwitchAction(data){const hls=this.hls,variantLevelIndex=this.getVariantLevelIndex(data.frag),level=hls.levels[variantLevelIndex],{fragLoadPolicy,keyLoadPolicy}=hls.config,retryConfig=getRetryConfig(data.details.startsWith("key")?keyLoadPolicy:fragLoadPolicy,data),fragmentErrors=hls.levels.reduce(((acc,level)=>acc+level.fragmentError),0);if(level){data.details!==ErrorDetails.FRAG_GAP&&level.fragmentError++;if(shouldRetry(retryConfig,fragmentErrors,isTimeoutError(data),data.response))return{action:NetworkErrorAction_RetryRequest,flags:ErrorActionFlags_None,retryConfig,retryCount:fragmentErrors}}const errorAction=this.getLevelSwitchAction(data,variantLevelIndex);return retryConfig&&(errorAction.retryConfig=retryConfig,errorAction.retryCount=fragmentErrors),errorAction}getLevelSwitchAction(data,levelIndex){const hls=this.hls;null==levelIndex&&(levelIndex=hls.loadLevel);const level=this.hls.levels[levelIndex];if(level){var _data$frag2,_data$context2;const errorDetails=data.details;level.loadError++,errorDetails===ErrorDetails.BUFFER_APPEND_ERROR&&level.fragmentError++;let nextLevel=-1;const{levels,loadLevel,minAutoLevel,maxAutoLevel}=hls;hls.autoLevelEnabled||(hls.loadLevel=-1);const fragErrorType=null==(_data$frag2=data.frag)?void 0:_data$frag2.type,findAudioCodecAlternate=(fragErrorType===PlaylistLevelType_AUDIO&&errorDetails===ErrorDetails.FRAG_PARSING_ERROR||"audio"===data.sourceBufferName&&(errorDetails===ErrorDetails.BUFFER_ADD_CODEC_ERROR||errorDetails===ErrorDetails.BUFFER_APPEND_ERROR))&&levels.some((({audioCodec})=>level.audioCodec!==audioCodec)),findVideoCodecAlternate="video"===data.sourceBufferName&&(errorDetails===ErrorDetails.BUFFER_ADD_CODEC_ERROR||errorDetails===ErrorDetails.BUFFER_APPEND_ERROR)&&levels.some((({codecSet,audioCodec})=>level.codecSet!==codecSet&&level.audioCodec===audioCodec)),{type:playlistErrorType,groupId:playlistErrorGroupId}=null!=(_data$context2=data.context)?_data$context2:{};for(let i=levels.length;i--;){const candidate=(i+loadLevel)%levels.length;if(candidate!==loadLevel&&candidate>=minAutoLevel&&candidate<=maxAutoLevel&&0===levels[candidate].loadError){var _level$audioGroups,_level$subtitleGroups;const levelCandidate=levels[candidate];if(errorDetails===ErrorDetails.FRAG_GAP&&data.frag){const levelDetails=levels[candidate].details;if(levelDetails){const fragCandidate=findFragmentByPTS(data.frag,levelDetails.fragments,data.frag.start);if(null!=fragCandidate&&fragCandidate.gap)continue}}else{if(playlistErrorType===PlaylistContextType_AUDIO_TRACK&&levelCandidate.hasAudioGroup(playlistErrorGroupId)||playlistErrorType===PlaylistContextType_SUBTITLE_TRACK&&levelCandidate.hasSubtitleGroup(playlistErrorGroupId))continue;if(fragErrorType===PlaylistLevelType_AUDIO&&null!=(_level$audioGroups=level.audioGroups)&&_level$audioGroups.some((groupId=>levelCandidate.hasAudioGroup(groupId)))||fragErrorType===PlaylistLevelType_SUBTITLE&&null!=(_level$subtitleGroups=level.subtitleGroups)&&_level$subtitleGroups.some((groupId=>levelCandidate.hasSubtitleGroup(groupId)))||findAudioCodecAlternate&&level.audioCodec===levelCandidate.audioCodec||!findAudioCodecAlternate&&level.audioCodec!==levelCandidate.audioCodec||findVideoCodecAlternate&&level.codecSet===levelCandidate.codecSet)continue}nextLevel=candidate;break}}if(nextLevel>-1&&hls.loadLevel!==nextLevel)return data.levelRetry=!0,this.playlistError=0,{action:NetworkErrorAction_SendAlternateToPenaltyBox,flags:ErrorActionFlags_None,nextAutoLevel:nextLevel}}return{action:NetworkErrorAction_SendAlternateToPenaltyBox,flags:ErrorActionFlags_MoveAllAlternatesMatchingHost}}onErrorOut(event,data){var _data$errorAction;switch(null==(_data$errorAction=data.errorAction)?void 0:_data$errorAction.action){case NetworkErrorAction_DoNothing:break;case NetworkErrorAction_SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(data),data.errorAction.resolved||data.details===ErrorDetails.FRAG_GAP?/MediaSource readyState: ended/.test(data.error.message)&&(this.warn(`MediaSource ended after "${data.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):data.fatal=!0}data.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(data){const hls=this.hls,errorAction=data.errorAction;if(!errorAction)return;const{flags,hdcpLevel,nextAutoLevel}=errorAction;switch(flags){case ErrorActionFlags_None:this.switchLevel(data,nextAutoLevel);break;case ErrorActionFlags_MoveAllAlternatesMatchingHDCP:hdcpLevel&&(hls.maxHdcpLevel=HdcpLevels[HdcpLevels.indexOf(hdcpLevel)-1],errorAction.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${hls.maxHdcpLevel}" or lower`)}errorAction.resolved||this.switchLevel(data,nextAutoLevel)}switchLevel(data,levelIndex){void 0!==levelIndex&&data.errorAction&&(this.warn(`switching to level ${levelIndex} after ${data.details}`),this.hls.nextAutoLevel=levelIndex,data.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}},fpsController:class FPSController{constructor(hls){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=hls,this.registerListeners()}setStreamController(streamController){this.streamController=streamController}registerListeners(){this.hls.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(event,data){const config=this.hls.config;if(config.capLevelOnFPSDrop){const media=data.media instanceof self.HTMLVideoElement?data.media:null;this.media=media,media&&"function"==typeof media.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),config.fpsDroppedMonitoringPeriod)}}checkFPS(video,decodedFrames,droppedFrames){const currentTime=performance.now();if(decodedFrames){if(this.lastTime){const currentPeriod=currentTime-this.lastTime,currentDropped=droppedFrames-this.lastDroppedFrames,currentDecoded=decodedFrames-this.lastDecodedFrames,droppedFPS=1e3*currentDropped/currentPeriod,hls=this.hls;if(hls.trigger(Events.FPS_DROP,{currentDropped,currentDecoded,totalDroppedFrames:droppedFrames}),droppedFPS>0&&currentDropped>hls.config.fpsDroppedMonitoringThreshold*currentDecoded){let currentLevel=hls.currentLevel;logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+currentLevel),currentLevel>0&&(-1===hls.autoLevelCapping||hls.autoLevelCapping>=currentLevel)&&(currentLevel-=1,hls.trigger(Events.FPS_DROP_LEVEL_CAPPING,{level:currentLevel,droppedLevel:hls.currentLevel}),hls.autoLevelCapping=currentLevel,this.streamController.nextLevelSwitch())}}this.lastTime=currentTime,this.lastDroppedFrames=droppedFrames,this.lastDecodedFrames=decodedFrames}}checkFPSInterval(){const video=this.media;if(video)if(this.isVideoPlaybackQualityAvailable){const videoPlaybackQuality=video.getVideoPlaybackQuality();this.checkFPS(video,videoPlaybackQuality.totalVideoFrames,videoPlaybackQuality.droppedVideoFrames)}else this.checkFPS(video,video.webkitDecodedFrameCount,video.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:requestMediaKeySystemAccess,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},function timelineConfig(){return{cueHandler:Cues,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}()),{},{subtitleStreamController:class SubtitleStreamController extends BaseStreamController{constructor(hls,fragmentTracker,keyLoader){super(hls,fragmentTracker,keyLoader,"[subtitle-stream-controller]",PlaylistLevelType_SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls}=this;hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events.ERROR,this.onError,this),hls.on(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),hls.on(Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),hls.on(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),hls.on(Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),hls.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.on(Events.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls}=this;hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events.ERROR,this.onError,this),hls.off(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),hls.off(Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),hls.off(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),hls.off(Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),hls.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.off(Events.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(startPosition){this.stopLoad(),this.state=State_IDLE,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=startPosition,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(event,data){this.mainDetails=data.details}onSubtitleFragProcessed(event,data){const{frag,success}=data;if(this.fragPrevious=frag,this.state=State_IDLE,!success)return;const buffered=this.tracksBuffered[this.currentTrackId];if(!buffered)return;let timeRange;const fragStart=frag.start;for(let i=0;i<buffered.length;i++)if(fragStart>=buffered[i].start&&fragStart<=buffered[i].end){timeRange=buffered[i];break}const fragEnd=frag.start+frag.duration;timeRange?timeRange.end=fragEnd:(timeRange={start:fragStart,end:fragEnd},buffered.push(timeRange)),this.fragmentTracker.fragBuffered(frag),this.fragBufferedComplete(frag,null)}onBufferFlushing(event,data){const{startOffset,endOffset}=data;if(0===startOffset&&endOffset!==Number.POSITIVE_INFINITY){const endOffsetSubtitles=endOffset-1;if(endOffsetSubtitles<=0)return;data.endOffsetSubtitles=Math.max(0,endOffsetSubtitles),this.tracksBuffered.forEach((buffered=>{for(let i=0;i<buffered.length;)if(buffered[i].end<=endOffsetSubtitles)buffered.shift();else{if(!(buffered[i].start<endOffsetSubtitles))break;buffered[i].start=endOffsetSubtitles,i++}})),this.fragmentTracker.removeFragmentsInRange(startOffset,endOffsetSubtitles,PlaylistLevelType_SUBTITLE)}}onFragBuffered(event,data){var _this$media;this.loadedmetadata||data.frag.type!==PlaylistLevelType_MAIN||null!=(_this$media=this.media)&&_this$media.buffered.length&&(this.loadedmetadata=!0)}onError(event,data){const frag=data.frag;(null==frag?void 0:frag.type)===PlaylistLevelType_SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==State_STOPPED&&(this.state=State_IDLE))}onSubtitleTracksUpdated(event,{subtitleTracks}){this.levels&&!subtitleOptionsIdentical(this.levels,subtitleTracks)?(this.tracksBuffered=[],this.levels=subtitleTracks.map((mediaPlaylist=>{const level=new Level(mediaPlaylist);return this.tracksBuffered[level.id]=[],level})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,PlaylistLevelType_SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null):this.levels=subtitleTracks.map((mediaPlaylist=>new Level(mediaPlaylist)))}onSubtitleTrackSwitch(event,data){var _this$levels;if(this.currentTrackId=data.id,null==(_this$levels=this.levels)||!_this$levels.length||-1===this.currentTrackId)return void this.clearInterval();const currentTrack=this.levels[this.currentTrackId];null!=currentTrack&&currentTrack.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,currentTrack&&this.setInterval(500)}onSubtitleTrackLoaded(event,data){var _track$details;const{currentTrackId,levels}=this,{details:newDetails,id:trackId}=data;if(!levels)return void this.warn(`Subtitle tracks were reset while loading level ${trackId}`);const track=levels[currentTrackId];if(trackId>=levels.length||trackId!==currentTrackId||!track)return;this.log(`Subtitle track ${trackId} loaded [${newDetails.startSN},${newDetails.endSN}]${newDetails.lastPartSn?`[part-${newDetails.lastPartSn}-${newDetails.lastPartIndex}]`:""},duration:${newDetails.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let sliding=0;if(newDetails.live||null!=(_track$details=track.details)&&_track$details.live){const mainDetails=this.mainDetails;if(newDetails.deltaUpdateFailed||!mainDetails)return;const mainSlidingStartFragment=mainDetails.fragments[0];var _this$levelLastLoaded;if(track.details)sliding=this.alignPlaylists(newDetails,track.details,null==(_this$levelLastLoaded=this.levelLastLoaded)?void 0:_this$levelLastLoaded.details),0===sliding&&mainSlidingStartFragment&&(sliding=mainSlidingStartFragment.start,addSliding(newDetails,sliding));else newDetails.hasProgramDateTime&&mainDetails.hasProgramDateTime?(alignMediaPlaylistByPDT(newDetails,mainDetails),sliding=newDetails.fragments[0].start):mainSlidingStartFragment&&(sliding=mainSlidingStartFragment.start,addSliding(newDetails,sliding))}if(track.details=newDetails,this.levelLastLoaded=track,this.startFragRequested||!this.mainDetails&&newDetails.live||this.setStartPosition(track.details,sliding),this.tick(),newDetails.live&&!this.fragCurrent&&this.media&&this.state===State_IDLE){findFragmentByPTS(null,newDetails.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),track.details=void 0)}}_handleFragmentLoadComplete(fragLoadedData){const{frag,payload}=fragLoadedData,decryptData=frag.decryptdata,hls=this.hls;if(!this.fragContextChanged(frag)&&payload&&payload.byteLength>0&&null!=decryptData&&decryptData.key&&decryptData.iv&&"AES-128"===decryptData.method){const startTime=performance.now();this.decrypter.decrypt(new Uint8Array(payload),decryptData.key.buffer,decryptData.iv.buffer).catch((err=>{throw hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.FRAG_DECRYPT_ERROR,fatal:!1,error:err,reason:err.message,frag}),err})).then((decryptedData=>{const endTime=performance.now();hls.trigger(Events.FRAG_DECRYPTED,{frag,payload:decryptedData,stats:{tstart:startTime,tdecrypt:endTime}})})).catch((err=>{this.warn(`${err.name}: ${err.message}`),this.state=State_IDLE}))}}doTick(){if(this.media){if(this.state===State_IDLE){const{currentTrackId,levels}=this,track=null==levels?void 0:levels[currentTrackId];if(!track||!levels.length||!track.details)return;const{config}=this,currentTime=this.getLoadPosition(),bufferedInfo=BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],currentTime,config.maxBufferHole),{end:targetBufferTime,len:bufferLen}=bufferedInfo,mainBufferInfo=this.getFwdBufferInfo(this.media,PlaylistLevelType_MAIN),trackDetails=track.details;if(bufferLen>this.getMaxBufferLength(null==mainBufferInfo?void 0:mainBufferInfo.len)+trackDetails.levelTargetDuration)return;const fragments=trackDetails.fragments,fragLen=fragments.length,end=trackDetails.edge;let foundFrag=null;const fragPrevious=this.fragPrevious;if(targetBufferTime<end){const tolerance=config.maxFragLookUpTolerance,lookupTolerance=targetBufferTime>end-tolerance?0:tolerance;foundFrag=findFragmentByPTS(fragPrevious,fragments,Math.max(fragments[0].start,targetBufferTime),lookupTolerance),!foundFrag&&fragPrevious&&fragPrevious.start<fragments[0].start&&(foundFrag=fragments[0])}else foundFrag=fragments[fragLen-1];if(!foundFrag)return;if(foundFrag=this.mapToInitFragWhenRequired(foundFrag),"initSegment"!==foundFrag.sn){const prevFrag=fragments[foundFrag.sn-trackDetails.startSN-1];prevFrag&&prevFrag.cc===foundFrag.cc&&this.fragmentTracker.getState(prevFrag)===FragmentState_NOT_LOADED&&(foundFrag=prevFrag)}this.fragmentTracker.getState(foundFrag)===FragmentState_NOT_LOADED&&this.loadFragment(foundFrag,track,targetBufferTime)}}else this.state=State_IDLE}getMaxBufferLength(mainBufferLength){const maxConfigBuffer=super.getMaxBufferLength();return mainBufferLength?Math.max(maxConfigBuffer,mainBufferLength):maxConfigBuffer}loadFragment(frag,level,targetBufferTime){this.fragCurrent=frag,"initSegment"===frag.sn?this._loadInitSegment(frag,level):(this.startFragRequested=!0,super.loadFragment(frag,level,targetBufferTime))}get mediaBufferTimeRanges(){return new BufferableInstance(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class SubtitleTrackController extends BasePlaylistController{constructor(hls){super(hls,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let textTrack=null;const tracks=filterSubtitleTracks(this.media.textTracks);for(let i=0;i<tracks.length;i++)if("hidden"===tracks[i].mode)textTrack=tracks[i];else if("showing"===tracks[i].mode){textTrack=tracks[i];break}const trackId=this.findTrackForTextTrack(textTrack);this.subtitleTrack!==trackId&&this.setSubtitleTrack(trackId)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(value){this._subtitleDisplay=value,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls}=this;hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events.LEVEL_LOADING,this.onLevelLoading,this),hls.on(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.on(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),hls.on(Events.ERROR,this.onError,this)}unregisterListeners(){const{hls}=this;hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events.LEVEL_LOADING,this.onLevelLoading,this),hls.off(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.off(Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),hls.off(Events.ERROR,this.onError,this)}onMediaAttached(event,data){this.media=data.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(timeout){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,timeout)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);filterSubtitleTracks(this.media.textTracks).forEach((track=>{clearCurrentCues(track)})),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(event,data){this.tracks=data.subtitleTracks}onSubtitleTrackLoaded(event,data){const{id,groupId,details}=data,trackInActiveGroup=this.tracksInGroup[id];if(!trackInActiveGroup||trackInActiveGroup.groupId!==groupId)return void this.warn(`Subtitle track with id:${id} and group:${groupId} not found in active group ${null==trackInActiveGroup?void 0:trackInActiveGroup.groupId}`);const curDetails=trackInActiveGroup.details;trackInActiveGroup.details=data.details,this.log(`Subtitle track ${id} "${trackInActiveGroup.name}" lang:${trackInActiveGroup.lang} group:${groupId} loaded [${details.startSN}-${details.endSN}]`),id===this.trackId&&this.playlistLoaded(id,data,curDetails)}onLevelLoading(event,data){this.switchLevel(data.level)}onLevelSwitching(event,data){this.switchLevel(data.level)}switchLevel(levelIndex){const levelInfo=this.hls.levels[levelIndex];if(!levelInfo)return;const subtitleGroups=levelInfo.subtitleGroups||null,currentGroups=this.groupIds;let currentTrack=this.currentTrack;if(!subtitleGroups||(null==currentGroups?void 0:currentGroups.length)!==(null==subtitleGroups?void 0:subtitleGroups.length)||null!=subtitleGroups&&subtitleGroups.some((groupId=>-1===(null==currentGroups?void 0:currentGroups.indexOf(groupId))))){this.groupIds=subtitleGroups,this.trackId=-1,this.currentTrack=null;const subtitleTracks=this.tracks.filter((track=>!subtitleGroups||-1!==subtitleGroups.indexOf(track.groupId)));if(subtitleTracks.length)this.selectDefaultTrack&&!subtitleTracks.some((track=>track.default))&&(this.selectDefaultTrack=!1),subtitleTracks.forEach(((track,i)=>{track.id=i}));else if(!currentTrack&&!this.tracksInGroup.length)return;this.tracksInGroup=subtitleTracks;const subtitlePreference=this.hls.config.subtitlePreference;if(!currentTrack&&subtitlePreference){this.selectDefaultTrack=!1;const groupIndex=findMatchingOption(subtitlePreference,subtitleTracks);if(groupIndex>-1)currentTrack=subtitleTracks[groupIndex];else{const allIndex=findMatchingOption(subtitlePreference,this.tracks);currentTrack=this.tracks[allIndex]}}let trackId=this.findTrackId(currentTrack);-1===trackId&&currentTrack&&(trackId=this.findTrackId(null));const subtitleTracksUpdated={subtitleTracks};this.log(`Updating subtitle tracks, ${subtitleTracks.length} track(s) found in "${null==subtitleGroups?void 0:subtitleGroups.join(",")}" group-id`),this.hls.trigger(Events.SUBTITLE_TRACKS_UPDATED,subtitleTracksUpdated),-1!==trackId&&-1===this.trackId&&this.setSubtitleTrack(trackId)}else this.shouldReloadPlaylist(currentTrack)&&this.setSubtitleTrack(this.trackId)}findTrackId(currentTrack){const tracks=this.tracksInGroup,selectDefault=this.selectDefaultTrack;for(let i=0;i<tracks.length;i++){const track=tracks[i];if((!selectDefault||track.default)&&(selectDefault||currentTrack)&&(!currentTrack||matchesOption(track,currentTrack)))return i}if(currentTrack){for(let i=0;i<tracks.length;i++){const track=tracks[i];if(mediaAttributesIdentical(currentTrack.attrs,track.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<tracks.length;i++){const track=tracks[i];if(mediaAttributesIdentical(currentTrack.attrs,track.attrs,["LANGUAGE"]))return i}}return-1}findTrackForTextTrack(textTrack){if(textTrack){const tracks=this.tracksInGroup;for(let i=0;i<tracks.length;i++){if(subtitleTrackMatchesTextTrack(tracks[i],textTrack))return i}}return-1}onError(event,data){!data.fatal&&data.context&&(data.context.type!==PlaylistContextType_SUBTITLE_TRACK||data.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(data.context.groupId)||this.checkRetry(data))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(newId){this.selectDefaultTrack=!1,this.setSubtitleTrack(newId)}setSubtitleOption(subtitleOption){if(this.hls.config.subtitlePreference=subtitleOption,subtitleOption){const allSubtitleTracks=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,allSubtitleTracks.length){const currentTrack=this.currentTrack;if(currentTrack&&matchesOption(subtitleOption,currentTrack))return currentTrack;const groupIndex=findMatchingOption(subtitleOption,this.tracksInGroup);if(groupIndex>-1){const track=this.tracksInGroup[groupIndex];return this.setSubtitleTrack(groupIndex),track}if(currentTrack)return null;{const allIndex=findMatchingOption(subtitleOption,allSubtitleTracks);if(allIndex>-1)return allSubtitleTracks[allIndex]}}}return null}loadPlaylist(hlsUrlParameters){super.loadPlaylist();const currentTrack=this.currentTrack;if(this.shouldLoadPlaylist(currentTrack)&&currentTrack){const id=currentTrack.id,groupId=currentTrack.groupId;let url=currentTrack.url;if(hlsUrlParameters)try{url=hlsUrlParameters.addDirectives(url)}catch(error){this.warn(`Could not construct new URL with HLS Delivery Directives: ${error}`)}this.log(`Loading subtitle playlist for id ${id}`),this.hls.trigger(Events.SUBTITLE_TRACK_LOADING,{url,id,groupId,deliveryDirectives:hlsUrlParameters||null})}}toggleTrackModes(){const{media}=this;if(!media)return;const textTracks=filterSubtitleTracks(media.textTracks),currentTrack=this.currentTrack;let nextTrack;if(currentTrack&&(nextTrack=textTracks.filter((textTrack=>subtitleTrackMatchesTextTrack(currentTrack,textTrack)))[0],nextTrack||this.warn(`Unable to find subtitle TextTrack with name "${currentTrack.name}" and language "${currentTrack.lang}"`)),[].slice.call(textTracks).forEach((track=>{"disabled"!==track.mode&&track!==nextTrack&&(track.mode="disabled")})),nextTrack){const mode=this.subtitleDisplay?"showing":"hidden";nextTrack.mode!==mode&&(nextTrack.mode=mode)}}setSubtitleTrack(newId){const tracks=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=newId);if(newId<-1||newId>=tracks.length||!isFiniteNumber(newId))return void this.warn(`Invalid subtitle track id: ${newId}`);this.clearTimer(),this.selectDefaultTrack=!1;const lastTrack=this.currentTrack,track=tracks[newId]||null;if(this.trackId=newId,this.currentTrack=track,this.toggleTrackModes(),!track)return void this.hls.trigger(Events.SUBTITLE_TRACK_SWITCH,{id:newId});const trackLoaded=!!track.details&&!track.details.live;if(newId===this.trackId&&track===lastTrack&&trackLoaded)return;this.log(`Switching to subtitle-track ${newId}`+(track?` "${track.name}" lang:${track.lang} group:${track.groupId}`:""));const{id,groupId="",name,type,url}=track;this.hls.trigger(Events.SUBTITLE_TRACK_SWITCH,{id,groupId,name,type,url});const hlsUrlParameters=this.switchParams(track.url,null==lastTrack?void 0:lastTrack.details);this.loadPlaylist(hlsUrlParameters)}},timelineController:class TimelineController{constructor(hls){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=hls,this.config=hls.config,this.Cues=hls.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},hls.on(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this),hls.on(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),hls.on(Events.FRAG_LOADING,this.onFragLoading,this),hls.on(Events.FRAG_LOADED,this.onFragLoaded,this),hls.on(Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),hls.on(Events.FRAG_DECRYPTED,this.onFragDecrypted,this),hls.on(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),hls.on(Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),hls.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls}=this;hls.off(Events.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),hls.off(Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),hls.off(Events.FRAG_LOADING,this.onFragLoading,this),hls.off(Events.FRAG_LOADED,this.onFragLoaded,this),hls.off(Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),hls.off(Events.FRAG_DECRYPTED,this.onFragDecrypted,this),hls.off(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),hls.off(Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),hls.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const channel1=new OutputFilter(this,"textTrack1"),channel2=new OutputFilter(this,"textTrack2"),channel3=new OutputFilter(this,"textTrack3"),channel4=new OutputFilter(this,"textTrack4");this.cea608Parser1=new Cea608Parser(1,channel1,channel2),this.cea608Parser2=new Cea608Parser(3,channel3,channel4)}}addCues(trackName,startTime,endTime,screen,cueRanges){let merged=!1;for(let i=cueRanges.length;i--;){const cueRange=cueRanges[i],overlap=(x1=cueRange[0],x2=cueRange[1],y1=startTime,y2=endTime,Math.min(x2,y2)-Math.max(x1,y1));if(overlap>=0&&(cueRange[0]=Math.min(cueRange[0],startTime),cueRange[1]=Math.max(cueRange[1],endTime),merged=!0,overlap/(endTime-startTime)>.5))return}var x1,x2,y1,y2;if(merged||cueRanges.push([startTime,endTime]),this.config.renderTextTracksNatively){const track=this.captionsTracks[trackName];this.Cues.newCue(track,startTime,endTime,screen)}else{const cues=this.Cues.newCue(null,startTime,endTime,screen);this.hls.trigger(Events.CUES_PARSED,{type:"captions",cues,track:trackName})}}onInitPtsFound(event,{frag,id,initPTS,timescale}){const{unparsedVttFrags}=this;"main"===id&&(this.initPTS[frag.cc]={baseTime:initPTS,timescale}),unparsedVttFrags.length&&(this.unparsedVttFrags=[],unparsedVttFrags.forEach((frag=>{this.onFragLoaded(Events.FRAG_LOADED,frag)})))}getExistingTrack(label,language){const{media}=this;if(media)for(let i=0;i<media.textTracks.length;i++){const textTrack=media.textTracks[i];if(canReuseVttTextTrack(textTrack,{name:label,lang:language,attrs:{}}))return textTrack}return null}createCaptionsTrack(trackName){this.config.renderTextTracksNatively?this.createNativeTrack(trackName):this.createNonNativeTrack(trackName)}createNativeTrack(trackName){if(this.captionsTracks[trackName])return;const{captionsProperties,captionsTracks,media}=this,{label,languageCode}=captionsProperties[trackName],existingTrack=this.getExistingTrack(label,languageCode);if(existingTrack)captionsTracks[trackName]=existingTrack,clearCurrentCues(captionsTracks[trackName]),sendAddTrackEvent(captionsTracks[trackName],media);else{const textTrack=this.createTextTrack("captions",label,languageCode);textTrack&&(textTrack[trackName]=!0,captionsTracks[trackName]=textTrack)}}createNonNativeTrack(trackName){if(this.nonNativeCaptionsTracks[trackName])return;const trackProperties=this.captionsProperties[trackName];if(!trackProperties)return;const track={_id:trackName,label:trackProperties.label,kind:"captions",default:!!trackProperties.media&&!!trackProperties.media.default,closedCaptions:trackProperties.media};this.nonNativeCaptionsTracks[trackName]=track,this.hls.trigger(Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[track]})}createTextTrack(kind,label,lang){const media=this.media;if(media)return media.addTextTrack(kind,label,lang)}onMediaAttaching(event,data){this.media=data.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks}=this;Object.keys(captionsTracks).forEach((trackName=>{clearCurrentCues(captionsTracks[trackName]),delete captionsTracks[trackName]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media}=this;if(!media)return;const textTracks=media.textTracks;if(textTracks)for(let i=0;i<textTracks.length;i++)clearCurrentCues(textTracks[i])}onSubtitleTracksUpdated(event,data){const tracks=data.subtitleTracks||[],hasIMSC1=tracks.some((track=>"stpp.ttml.im1t"===track.textCodec));if(this.config.enableWebVTT||hasIMSC1&&this.config.enableIMSC1){if(subtitleOptionsIdentical(this.tracks,tracks))return void(this.tracks=tracks);if(this.textTracks=[],this.tracks=tracks,this.config.renderTextTracksNatively){const media=this.media,inUseTracks=media?filterSubtitleTracks(media.textTracks):null;if(this.tracks.forEach(((track,index)=>{let textTrack;if(inUseTracks){let inUseTrack=null;for(let i=0;i<inUseTracks.length;i++)if(inUseTracks[i]&&canReuseVttTextTrack(inUseTracks[i],track)){inUseTrack=inUseTracks[i],inUseTracks[i]=null;break}inUseTrack&&(textTrack=inUseTrack)}if(textTrack)clearCurrentCues(textTrack);else{const textTrackKind=captionsOrSubtitlesFromCharacteristics(track);textTrack=this.createTextTrack(textTrackKind,track.name,track.lang),textTrack&&(textTrack.mode="disabled")}textTrack&&this.textTracks.push(textTrack)})),null!=inUseTracks&&inUseTracks.length){const unusedTextTracks=inUseTracks.filter((t=>null!==t)).map((t=>t.label));unusedTextTracks.length&&logger.warn(`Media element contains unused subtitle tracks: ${unusedTextTracks.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const tracksList=this.tracks.map((track=>({label:track.name,kind:track.type.toLowerCase(),default:track.default,subtitleTrack:track})));this.hls.trigger(Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:tracksList})}}}onManifestLoaded(event,data){this.config.enableCEA708Captions&&data.captions&&data.captions.forEach((captionsTrack=>{const instreamIdMatch=/(?:CC|SERVICE)([1-4])/.exec(captionsTrack.instreamId);if(!instreamIdMatch)return;const trackName=`textTrack${instreamIdMatch[1]}`,trackProperties=this.captionsProperties[trackName];trackProperties&&(trackProperties.label=captionsTrack.name,captionsTrack.lang&&(trackProperties.languageCode=captionsTrack.lang),trackProperties.media=captionsTrack)}))}closedCaptionsForLevel(frag){const level=this.hls.levels[frag.level];return null==level?void 0:level.attrs["CLOSED-CAPTIONS"]}onFragLoading(event,data){this.initCea608Parsers();const{cea608Parser1,cea608Parser2,lastCc,lastSn,lastPartIndex}=this;if(this.enabled&&cea608Parser1&&cea608Parser2&&data.frag.type===PlaylistLevelType_MAIN){var _data$part$index,_data$part;const{cc,sn}=data.frag,partIndex=null!=(_data$part$index=null==data||null==(_data$part=data.part)?void 0:_data$part.index)?_data$part$index:-1;sn===lastSn+1||sn===lastSn&&partIndex===lastPartIndex+1||cc===lastCc||(cea608Parser1.reset(),cea608Parser2.reset()),this.lastCc=cc,this.lastSn=sn,this.lastPartIndex=partIndex}}onFragLoaded(event,data){const{frag,payload}=data;if(frag.type===PlaylistLevelType_SUBTITLE)if(payload.byteLength){const decryptData=frag.decryptdata,decrypted="stats"in data;if(null==decryptData||!decryptData.encrypted||decrypted){const trackPlaylistMedia=this.tracks[frag.level],vttCCs=this.vttCCs;vttCCs[frag.cc]||(vttCCs[frag.cc]={start:frag.start,prevCC:this.prevCC,new:!0},this.prevCC=frag.cc),trackPlaylistMedia&&"stpp.ttml.im1t"===trackPlaylistMedia.textCodec?this._parseIMSC1(frag,payload):this._parseVTTs(data)}}else this.hls.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag,error:new Error("Empty subtitle payload")})}_parseIMSC1(frag,payload){const hls=this.hls;parseIMSC1(payload,this.initPTS[frag.cc],(cues=>{this._appendCues(cues,frag.level),hls.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag})}),(error=>{logger.log(`Failed to parse IMSC1: ${error}`),hls.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag,error})}))}_parseVTTs(data){var _frag$initSegment;const{frag,payload}=data,{initPTS,unparsedVttFrags}=this,maxAvCC=initPTS.length-1;if(!initPTS[frag.cc]&&-1===maxAvCC)return void unparsedVttFrags.push(data);const hls=this.hls;parseWebVTT(null!=(_frag$initSegment=frag.initSegment)&&_frag$initSegment.data?appendUint8Array(frag.initSegment.data,new Uint8Array(payload)):payload,this.initPTS[frag.cc],this.vttCCs,frag.cc,frag.start,(cues=>{this._appendCues(cues,frag.level),hls.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag})}),(error=>{const missingInitPTS="Missing initPTS for VTT MPEGTS"===error.message;missingInitPTS?unparsedVttFrags.push(data):this._fallbackToIMSC1(frag,payload),logger.log(`Failed to parse VTT cue: ${error}`),missingInitPTS&&maxAvCC>frag.cc||hls.trigger(Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag,error})}))}_fallbackToIMSC1(frag,payload){const trackPlaylistMedia=this.tracks[frag.level];trackPlaylistMedia.textCodec||parseIMSC1(payload,this.initPTS[frag.cc],(()=>{trackPlaylistMedia.textCodec="stpp.ttml.im1t",this._parseIMSC1(frag,payload)}),(()=>{trackPlaylistMedia.textCodec="wvtt"}))}_appendCues(cues,fragLevel){const hls=this.hls;if(this.config.renderTextTracksNatively){const textTrack=this.textTracks[fragLevel];if(!textTrack||"disabled"===textTrack.mode)return;cues.forEach((cue=>addCueToTrack(textTrack,cue)))}else{const currentTrack=this.tracks[fragLevel];if(!currentTrack)return;const track=currentTrack.default?"default":"subtitles"+fragLevel;hls.trigger(Events.CUES_PARSED,{type:"subtitles",cues,track})}}onFragDecrypted(event,data){const{frag}=data;frag.type===PlaylistLevelType_SUBTITLE&&this.onFragLoaded(Events.FRAG_LOADED,data)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(event,data){this.initCea608Parsers();const{cea608Parser1,cea608Parser2}=this;if(!this.enabled||!cea608Parser1||!cea608Parser2)return;const{frag,samples}=data;if(frag.type!==PlaylistLevelType_MAIN||"NONE"!==this.closedCaptionsForLevel(frag))for(let i=0;i<samples.length;i++){const ccBytes=samples[i].bytes;if(ccBytes){const ccdatas=this.extractCea608Data(ccBytes);cea608Parser1.addData(samples[i].pts,ccdatas[0]),cea608Parser2.addData(samples[i].pts,ccdatas[1])}}}onBufferFlushing(event,{startOffset,endOffset,endOffsetSubtitles,type}){const{media}=this;if(media&&!(media.currentTime<endOffset)){if(!type||"video"===type){const{captionsTracks}=this;Object.keys(captionsTracks).forEach((trackName=>removeCuesInRange(captionsTracks[trackName],startOffset,endOffset)))}if(this.config.renderTextTracksNatively&&0===startOffset&&void 0!==endOffsetSubtitles){const{textTracks}=this;Object.keys(textTracks).forEach((trackName=>removeCuesInRange(textTracks[trackName],startOffset,endOffsetSubtitles)))}}}extractCea608Data(byteArray){const actualCCBytes=[[],[]],count=31&byteArray[0];let position=2;for(let j=0;j<count;j++){const tmpByte=byteArray[position++],ccbyte1=127&byteArray[position++],ccbyte2=127&byteArray[position++];if(0===ccbyte1&&0===ccbyte2)continue;if(0!=(4&tmpByte)){const ccType=3&tmpByte;0!==ccType&&1!==ccType||(actualCCBytes[ccType].push(ccbyte1),actualCCBytes[ccType].push(ccbyte2))}}return actualCCBytes}},audioStreamController:class AudioStreamController extends BaseStreamController{constructor(hls,fragmentTracker,keyLoader){super(hls,fragmentTracker,keyLoader,"[audio-stream-controller]",PlaylistLevelType_AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls}=this;hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),hls.on(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),hls.on(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),hls.on(Events.ERROR,this.onError,this),hls.on(Events.BUFFER_RESET,this.onBufferReset,this),hls.on(Events.BUFFER_CREATED,this.onBufferCreated,this),hls.on(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.on(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),hls.on(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),hls.on(Events.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls}=this;hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),hls.off(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),hls.off(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),hls.off(Events.ERROR,this.onError,this),hls.off(Events.BUFFER_RESET,this.onBufferReset,this),hls.off(Events.BUFFER_CREATED,this.onBufferCreated,this),hls.off(Events.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.off(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),hls.off(Events.INIT_PTS_FOUND,this.onInitPtsFound,this),hls.off(Events.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(event,{frag,id,initPTS,timescale}){if("main"===id){const cc=frag.cc;this.initPTS[frag.cc]={baseTime:initPTS,timescale},this.log(`InitPTS for cc: ${cc} found from main: ${initPTS}`),this.videoTrackCC=cc,this.state===State_WAITING_INIT_PTS&&this.tick()}}startLoad(startPosition){if(!this.levels)return this.startPosition=startPosition,void(this.state=State_STOPPED);const lastCurrentTime=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),lastCurrentTime>0&&-1===startPosition?(this.log(`Override startPosition with lastCurrentTime @${lastCurrentTime.toFixed(3)}`),startPosition=lastCurrentTime,this.state=State_IDLE):(this.loadedmetadata=!1,this.state=State_WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=startPosition,this.tick()}doTick(){switch(this.state){case State_IDLE:this.doTickIdle();break;case State_WAITING_TRACK:{var _levels$trackId;const{levels,trackId}=this,details=null==levels||null==(_levels$trackId=levels[trackId])?void 0:_levels$trackId.details;if(details){if(this.waitForCdnTuneIn(details))break;this.state=State_WAITING_INIT_PTS}break}case State_FRAG_LOADING_WAITING_RETRY:{var _this$media;const now=performance.now(),retryDate=this.retryDate;if(!retryDate||now>=retryDate||null!=(_this$media=this.media)&&_this$media.seeking){const{levels,trackId}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==levels?void 0:levels[trackId])||null),this.state=State_IDLE}break}case State_WAITING_INIT_PTS:{const waitingData=this.waitingData;if(waitingData){const{frag,part,cache,complete}=waitingData;if(void 0!==this.initPTS[frag.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=State_FRAG_LOADING;const data={frag,part,payload:cache.flush(),networkDetails:null};this._handleFragmentLoadProgress(data),complete&&super._handleFragmentLoadComplete(data)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${frag.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const pos=this.getLoadPosition(),bufferInfo=BufferHelper.bufferInfo(this.mediaBuffer,pos,this.config.maxBufferHole);fragmentWithinToleranceTest(bufferInfo.end,this.config.maxFragLookUpTolerance,frag)<0&&(this.log(`Waiting fragment cc (${frag.cc}) @ ${frag.start} cancelled because another fragment at ${bufferInfo.end} is needed`),this.clearWaitingFragment())}}else this.state=State_IDLE}}this.onTickEnd()}clearWaitingFragment(){const waitingData=this.waitingData;waitingData&&(this.fragmentTracker.removeFragment(waitingData.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=State_IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media}=this;null!=media&&media.readyState&&(this.lastCurrentTime=media.currentTime)}doTickIdle(){const{hls,levels,media,trackId}=this,config=hls.config;if(!media&&(this.startFragRequested||!config.startFragPrefetch)||null==levels||!levels[trackId])return;const levelInfo=levels[trackId],trackDetails=levelInfo.details;if(!trackDetails||trackDetails.live&&this.levelLastLoaded!==levelInfo||this.waitForCdnTuneIn(trackDetails))return void(this.state=State_WAITING_TRACK);const bufferable=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&bufferable&&(this.bufferFlushed=!1,this.afterBufferFlushed(bufferable,ElementaryStreamTypes_AUDIO,PlaylistLevelType_AUDIO));const bufferInfo=this.getFwdBufferInfo(bufferable,PlaylistLevelType_AUDIO);if(null===bufferInfo)return;const{bufferedTrack,switchingTrack}=this;if(!switchingTrack&&this._streamEnded(bufferInfo,trackDetails))return hls.trigger(Events.BUFFER_EOS,{type:"audio"}),void(this.state=State_ENDED);const mainBufferInfo=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,PlaylistLevelType_MAIN),bufferLen=bufferInfo.len,maxBufLen=this.getMaxBufferLength(null==mainBufferInfo?void 0:mainBufferInfo.len),fragments=trackDetails.fragments,start=fragments[0].start;let targetBufferTime=this.flushing?this.getLoadPosition():bufferInfo.end;if(switchingTrack&&media){const pos=this.getLoadPosition();bufferedTrack&&!mediaAttributesIdentical(switchingTrack.attrs,bufferedTrack.attrs)&&(targetBufferTime=pos),trackDetails.PTSKnown&&pos<start&&(bufferInfo.end>start||bufferInfo.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),media.currentTime=start+.05)}if(bufferLen>=maxBufLen&&!switchingTrack&&targetBufferTime<fragments[fragments.length-1].start)return;let frag=this.getNextFragment(targetBufferTime,trackDetails),atGap=!1;if(frag&&this.isLoopLoading(frag,targetBufferTime)&&(atGap=!!frag.gap,frag=this.getNextFragmentLoopLoading(frag,trackDetails,bufferInfo,PlaylistLevelType_MAIN,maxBufLen)),!frag)return void(this.bufferFlushed=!0);const atBufferSyncLimit=mainBufferInfo&&frag.start>mainBufferInfo.end+trackDetails.targetduration;if(atBufferSyncLimit||(null==mainBufferInfo||!mainBufferInfo.len)&&bufferInfo.len){const mainFrag=this.getAppendedFrag(frag.start,PlaylistLevelType_MAIN);if(null===mainFrag)return;if(atGap||(atGap=!!mainFrag.gap||!!atBufferSyncLimit&&0===mainBufferInfo.len),atBufferSyncLimit&&!atGap||atGap&&bufferInfo.nextStart&&bufferInfo.nextStart<mainFrag.end)return}this.loadFragment(frag,levelInfo,targetBufferTime)}getMaxBufferLength(mainBufferLength){const maxConfigBuffer=super.getMaxBufferLength();return mainBufferLength?Math.min(Math.max(maxConfigBuffer,mainBufferLength),this.config.maxMaxBufferLength):maxConfigBuffer}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(event,{audioTracks}){this.resetTransmuxer(),this.levels=audioTracks.map((mediaPlaylist=>new Level(mediaPlaylist)))}onAudioTrackSwitching(event,data){const altAudio=!!data.url;this.trackId=data.id;const{fragCurrent}=this;fragCurrent&&(fragCurrent.abortRequests(),this.removeUnbufferedFrags(fragCurrent.start)),this.resetLoadingState(),altAudio?this.setInterval(100):this.resetTransmuxer(),altAudio?(this.switchingTrack=data,this.state=State_IDLE,this.flushAudioIfNeeded(data)):(this.switchingTrack=null,this.bufferedTrack=data,this.state=State_STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(event,data){this.mainDetails=data.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(Events.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(event,data){var _track$details;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=data);const{levels}=this,{details:newDetails,id:trackId}=data;if(!levels)return void this.warn(`Audio tracks were reset while loading level ${trackId}`);this.log(`Audio track ${trackId} loaded [${newDetails.startSN},${newDetails.endSN}]${newDetails.lastPartSn?`[part-${newDetails.lastPartSn}-${newDetails.lastPartIndex}]`:""},duration:${newDetails.totalduration}`);const track=levels[trackId];let sliding=0;if(newDetails.live||null!=(_track$details=track.details)&&_track$details.live){this.checkLiveUpdate(newDetails);const mainDetails=this.mainDetails;if(newDetails.deltaUpdateFailed||!mainDetails)return;var _this$levelLastLoaded;if(!track.details&&newDetails.hasProgramDateTime&&mainDetails.hasProgramDateTime)alignMediaPlaylistByPDT(newDetails,mainDetails),sliding=newDetails.fragments[0].start;else sliding=this.alignPlaylists(newDetails,track.details,null==(_this$levelLastLoaded=this.levelLastLoaded)?void 0:_this$levelLastLoaded.details)}track.details=newDetails,this.levelLastLoaded=track,this.startFragRequested||!this.mainDetails&&newDetails.live||this.setStartPosition(track.details,sliding),this.state!==State_WAITING_TRACK||this.waitForCdnTuneIn(newDetails)||(this.state=State_IDLE),this.tick()}_handleFragmentLoadProgress(data){var _frag$initSegment;const{frag,part,payload}=data,{config,trackId,levels}=this;if(!levels)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${frag.sn} of level ${frag.level} will not be buffered`);const track=levels[trackId];if(!track)return void this.warn("Audio track is undefined on fragment load progress");const details=track.details;if(!details)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(frag.start);const audioCodec=config.defaultAudioCodec||track.audioCodec||"mp4a.40.2";let transmuxer=this.transmuxer;transmuxer||(transmuxer=this.transmuxer=new TransmuxerInterface(this.hls,PlaylistLevelType_AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const initPTS=this.initPTS[frag.cc],initSegmentData=null==(_frag$initSegment=frag.initSegment)?void 0:_frag$initSegment.data;if(void 0!==initPTS){const accurateTimeOffset=!1,partIndex=part?part.index:-1,partial=-1!==partIndex,chunkMeta=new ChunkMetadata(frag.level,frag.sn,frag.stats.chunkCount,payload.byteLength,partIndex,partial);transmuxer.push(payload,initSegmentData,audioCodec,"",frag,part,details.totalduration,accurateTimeOffset,chunkMeta,initPTS)}else{this.log(`Unknown video PTS for cc ${frag.cc}, waiting for video PTS before demuxing audio frag ${frag.sn} of [${details.startSN} ,${details.endSN}],track ${trackId}`);const{cache}=this.waitingData=this.waitingData||{frag,part,cache:new ChunkCache,complete:!1};cache.push(new Uint8Array(payload)),this.waitingVideoCC=this.videoTrackCC,this.state=State_WAITING_INIT_PTS}}_handleFragmentLoadComplete(fragLoadedData){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(fragLoadedData)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(event,data){const audioTrack=data.tracks.audio;audioTrack&&(this.mediaBuffer=audioTrack.buffer||null),data.tracks.video&&(this.videoBuffer=data.tracks.video.buffer||null)}onFragBuffered(event,data){const{frag,part}=data;if(frag.type===PlaylistLevelType_AUDIO)if(this.fragContextChanged(frag))this.warn(`Fragment ${frag.sn}${part?" p: "+part.index:""} of level ${frag.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==frag.sn){this.fragPrevious=frag;const track=this.switchingTrack;track&&(this.bufferedTrack=track,this.switchingTrack=null,this.hls.trigger(Events.AUDIO_TRACK_SWITCHED,_objectSpread2({},track)))}this.fragBufferedComplete(frag,part)}else if(!this.loadedmetadata&&frag.type===PlaylistLevelType_MAIN){const bufferable=this.videoBuffer||this.media;if(bufferable){BufferHelper.getBuffered(bufferable).length&&(this.loadedmetadata=!0)}}}onError(event,data){var _data$context;if(data.fatal)this.state=State_ERROR;else switch(data.details){case ErrorDetails.FRAG_GAP:case ErrorDetails.FRAG_PARSING_ERROR:case ErrorDetails.FRAG_DECRYPT_ERROR:case ErrorDetails.FRAG_LOAD_ERROR:case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_ERROR:case ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(PlaylistLevelType_AUDIO,data);break;case ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:case ErrorDetails.LEVEL_PARSING_ERROR:data.levelRetry||this.state!==State_WAITING_TRACK||(null==(_data$context=data.context)?void 0:_data$context.type)!==PlaylistContextType_AUDIO_TRACK||(this.state=State_IDLE);break;case ErrorDetails.BUFFER_APPEND_ERROR:case ErrorDetails.BUFFER_FULL_ERROR:if(!data.parent||"audio"!==data.parent)return;if(data.details===ErrorDetails.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(data)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case ErrorDetails.INTERNAL_EXCEPTION:this.recoverWorkerError(data)}}onBufferFlushing(event,{type}){type!==ElementaryStreamTypes_VIDEO&&(this.flushing=!0)}onBufferFlushed(event,{type}){if(type!==ElementaryStreamTypes_VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===State_ENDED&&(this.state=State_IDLE);const mediaBuffer=this.mediaBuffer||this.media;mediaBuffer&&(this.afterBufferFlushed(mediaBuffer,type,PlaylistLevelType_AUDIO),this.tick())}}_handleTransmuxComplete(transmuxResult){var _id3$samples;const id="audio",{hls}=this,{remuxResult,chunkMeta}=transmuxResult,context=this.getCurrentContext(chunkMeta);if(!context)return void this.resetWhenMissingContext(chunkMeta);const{frag,part,level}=context,{details}=level,{audio,text,id3,initSegment}=remuxResult;if(!this.fragContextChanged(frag)&&details){if(this.state=State_PARSING,this.switchingTrack&&audio&&this.completeAudioSwitch(this.switchingTrack),null!=initSegment&&initSegment.tracks){const mapFragment=frag.initSegment||frag;this._bufferInitSegment(level,initSegment.tracks,mapFragment,chunkMeta),hls.trigger(Events.FRAG_PARSING_INIT_SEGMENT,{frag:mapFragment,id,tracks:initSegment.tracks})}if(audio){const{startPTS,endPTS,startDTS,endDTS}=audio;part&&(part.elementaryStreams[ElementaryStreamTypes_AUDIO]={startPTS,endPTS,startDTS,endDTS}),frag.setElementaryStreamInfo(ElementaryStreamTypes_AUDIO,startPTS,endPTS,startDTS,endDTS),this.bufferFragmentData(audio,frag,part,chunkMeta)}if(null!=id3&&null!=(_id3$samples=id3.samples)&&_id3$samples.length){const emittedID3=_extends({id,frag,details},id3);hls.trigger(Events.FRAG_PARSING_METADATA,emittedID3)}if(text){const emittedText=_extends({id,frag,details},text);hls.trigger(Events.FRAG_PARSING_USERDATA,emittedText)}}else this.fragmentTracker.removeFragment(frag)}_bufferInitSegment(currentLevel,tracks,frag,chunkMeta){if(this.state!==State_PARSING)return;tracks.video&&delete tracks.video;const track=tracks.audio;if(!track)return;track.id="audio";const variantAudioCodecs=currentLevel.audioCodec;this.log(`Init audio buffer, container:${track.container}, codecs[level/parsed]=[${variantAudioCodecs}/${track.codec}]`),variantAudioCodecs&&1===variantAudioCodecs.split(",").length&&(track.levelCodec=variantAudioCodecs),this.hls.trigger(Events.BUFFER_CODECS,tracks);const initSegment=track.initSegment;if(null!=initSegment&&initSegment.byteLength){const segment={type:"audio",frag,part:null,chunkMeta,parent:frag.type,data:initSegment};this.hls.trigger(Events.BUFFER_APPENDING,segment)}this.tickImmediate()}loadFragment(frag,track,targetBufferTime){const fragState=this.fragmentTracker.getState(frag);var _track$details2;if(this.fragCurrent=frag,this.switchingTrack||fragState===FragmentState_NOT_LOADED||fragState===FragmentState_PARTIAL)if("initSegment"===frag.sn)this._loadInitSegment(frag,track);else if(null!=(_track$details2=track.details)&&_track$details2.live&&!this.initPTS[frag.cc]){this.log(`Waiting for video PTS in continuity counter ${frag.cc} of live stream before loading audio fragment ${frag.sn} of level ${this.trackId}`),this.state=State_WAITING_INIT_PTS;const mainDetails=this.mainDetails;mainDetails&&mainDetails.fragments[0].start!==track.details.fragments[0].start&&alignMediaPlaylistByPDT(track.details,mainDetails)}else this.startFragRequested=!0,super.loadFragment(frag,track,targetBufferTime);else this.clearTrackerIfNeeded(frag)}flushAudioIfNeeded(switchingTrack){const{media,bufferedTrack}=this,bufferedAttributes=null==bufferedTrack?void 0:bufferedTrack.attrs,switchAttributes=switchingTrack.attrs;media&&bufferedAttributes&&(bufferedAttributes.CHANNELS!==switchAttributes.CHANNELS||bufferedTrack.name!==switchingTrack.name||bufferedTrack.lang!==switchingTrack.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(switchingTrack){const{hls}=this;this.flushAudioIfNeeded(switchingTrack),this.bufferedTrack=switchingTrack,this.switchingTrack=null,hls.trigger(Events.AUDIO_TRACK_SWITCHED,_objectSpread2({},switchingTrack))}},audioTrackController:class AudioTrackController extends BasePlaylistController{constructor(hls){super(hls,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls}=this;hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events.LEVEL_LOADING,this.onLevelLoading,this),hls.on(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.on(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),hls.on(Events.ERROR,this.onError,this)}unregisterListeners(){const{hls}=this;hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events.LEVEL_LOADING,this.onLevelLoading,this),hls.off(Events.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.off(Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),hls.off(Events.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(event,data){this.tracks=data.audioTracks||[]}onAudioTrackLoaded(event,data){const{id,groupId,details}=data,trackInActiveGroup=this.tracksInGroup[id];if(!trackInActiveGroup||trackInActiveGroup.groupId!==groupId)return void this.warn(`Audio track with id:${id} and group:${groupId} not found in active group ${null==trackInActiveGroup?void 0:trackInActiveGroup.groupId}`);const curDetails=trackInActiveGroup.details;trackInActiveGroup.details=data.details,this.log(`Audio track ${id} "${trackInActiveGroup.name}" lang:${trackInActiveGroup.lang} group:${groupId} loaded [${details.startSN}-${details.endSN}]`),id===this.trackId&&this.playlistLoaded(id,data,curDetails)}onLevelLoading(event,data){this.switchLevel(data.level)}onLevelSwitching(event,data){this.switchLevel(data.level)}switchLevel(levelIndex){const levelInfo=this.hls.levels[levelIndex];if(!levelInfo)return;const audioGroups=levelInfo.audioGroups||null,currentGroups=this.groupIds;let currentTrack=this.currentTrack;if(!audioGroups||(null==currentGroups?void 0:currentGroups.length)!==(null==audioGroups?void 0:audioGroups.length)||null!=audioGroups&&audioGroups.some((groupId=>-1===(null==currentGroups?void 0:currentGroups.indexOf(groupId))))){this.groupIds=audioGroups,this.trackId=-1,this.currentTrack=null;const audioTracks=this.tracks.filter((track=>!audioGroups||-1!==audioGroups.indexOf(track.groupId)));if(audioTracks.length)this.selectDefaultTrack&&!audioTracks.some((track=>track.default))&&(this.selectDefaultTrack=!1),audioTracks.forEach(((track,i)=>{track.id=i}));else if(!currentTrack&&!this.tracksInGroup.length)return;this.tracksInGroup=audioTracks;const audioPreference=this.hls.config.audioPreference;if(!currentTrack&&audioPreference){const groupIndex=findMatchingOption(audioPreference,audioTracks,audioMatchPredicate);if(groupIndex>-1)currentTrack=audioTracks[groupIndex];else{const allIndex=findMatchingOption(audioPreference,this.tracks);currentTrack=this.tracks[allIndex]}}let trackId=this.findTrackId(currentTrack);-1===trackId&&currentTrack&&(trackId=this.findTrackId(null));const audioTracksUpdated={audioTracks};this.log(`Updating audio tracks, ${audioTracks.length} track(s) found in group(s): ${null==audioGroups?void 0:audioGroups.join(",")}`),this.hls.trigger(Events.AUDIO_TRACKS_UPDATED,audioTracksUpdated);const selectedTrackId=this.trackId;if(-1!==trackId&&-1===selectedTrackId)this.setAudioTrack(trackId);else if(audioTracks.length&&-1===selectedTrackId){var _this$groupIds;const error=new Error(`No audio track selected for current audio group-ID(s): ${null==(_this$groupIds=this.groupIds)?void 0:_this$groupIds.join(",")} track count: ${audioTracks.length}`);this.warn(error.message),this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error})}}else this.shouldReloadPlaylist(currentTrack)&&this.setAudioTrack(this.trackId)}onError(event,data){!data.fatal&&data.context&&(data.context.type!==PlaylistContextType_AUDIO_TRACK||data.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(data.context.groupId)||(this.requestScheduled=-1,this.checkRetry(data)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(newId){this.selectDefaultTrack=!1,this.setAudioTrack(newId)}setAudioOption(audioOption){const hls=this.hls;if(hls.config.audioPreference=audioOption,audioOption){const allAudioTracks=this.allAudioTracks;if(this.selectDefaultTrack=!1,allAudioTracks.length){const currentTrack=this.currentTrack;if(currentTrack&&matchesOption(audioOption,currentTrack,audioMatchPredicate))return currentTrack;const groupIndex=findMatchingOption(audioOption,this.tracksInGroup,audioMatchPredicate);if(groupIndex>-1){const track=this.tracksInGroup[groupIndex];return this.setAudioTrack(groupIndex),track}if(currentTrack){let searchIndex=hls.loadLevel;-1===searchIndex&&(searchIndex=hls.firstAutoLevel);const switchIndex=function findClosestLevelWithAudioGroup(option,levels,allAudioTracks,searchIndex,matchPredicate){const currentLevel=levels[searchIndex],renditions=levels.reduce(((variantMap,level,index)=>{const uri=level.uri;return(variantMap[uri]||(variantMap[uri]=[])).push(index),variantMap}),{})[currentLevel.uri];renditions.length>1&&(searchIndex=Math.max.apply(Math,renditions));const currentVideoRange=currentLevel.videoRange,currentFrameRate=currentLevel.frameRate,currentVideoCodec=currentLevel.codecSet.substring(0,4),matchingVideo=searchDownAndUpList(levels,searchIndex,(level=>{if(level.videoRange!==currentVideoRange||level.frameRate!==currentFrameRate||level.codecSet.substring(0,4)!==currentVideoCodec)return!1;const audioGroups=level.audioGroups,tracks=allAudioTracks.filter((track=>!audioGroups||-1!==audioGroups.indexOf(track.groupId)));return findMatchingOption(option,tracks,matchPredicate)>-1}));return matchingVideo>-1?matchingVideo:searchDownAndUpList(levels,searchIndex,(level=>{const audioGroups=level.audioGroups,tracks=allAudioTracks.filter((track=>!audioGroups||-1!==audioGroups.indexOf(track.groupId)));return findMatchingOption(option,tracks,matchPredicate)>-1}))}(audioOption,hls.levels,allAudioTracks,searchIndex,audioMatchPredicate);if(-1===switchIndex)return null;hls.nextLoadLevel=switchIndex}if(audioOption.channels||audioOption.audioCodec){const withoutCodecAndChannelsMatch=findMatchingOption(audioOption,allAudioTracks);if(withoutCodecAndChannelsMatch>-1)return allAudioTracks[withoutCodecAndChannelsMatch]}}}return null}setAudioTrack(newId){const tracks=this.tracksInGroup;if(newId<0||newId>=tracks.length)return void this.warn(`Invalid audio track id: ${newId}`);this.clearTimer(),this.selectDefaultTrack=!1;const lastTrack=this.currentTrack,track=tracks[newId],trackLoaded=track.details&&!track.details.live;if(newId===this.trackId&&track===lastTrack&&trackLoaded)return;if(this.log(`Switching to audio-track ${newId} "${track.name}" lang:${track.lang} group:${track.groupId} channels:${track.channels}`),this.trackId=newId,this.currentTrack=track,this.hls.trigger(Events.AUDIO_TRACK_SWITCHING,_objectSpread2({},track)),trackLoaded)return;const hlsUrlParameters=this.switchParams(track.url,null==lastTrack?void 0:lastTrack.details);this.loadPlaylist(hlsUrlParameters)}findTrackId(currentTrack){const audioTracks=this.tracksInGroup;for(let i=0;i<audioTracks.length;i++){const track=audioTracks[i];if((!this.selectDefaultTrack||track.default)&&(!currentTrack||matchesOption(currentTrack,track,audioMatchPredicate)))return i}if(currentTrack){const{name,lang,assocLang,characteristics,audioCodec,channels}=currentTrack;for(let i=0;i<audioTracks.length;i++){if(matchesOption({name,lang,assocLang,characteristics,audioCodec,channels},audioTracks[i],audioMatchPredicate))return i}for(let i=0;i<audioTracks.length;i++){const track=audioTracks[i];if(mediaAttributesIdentical(currentTrack.attrs,track.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<audioTracks.length;i++){const track=audioTracks[i];if(mediaAttributesIdentical(currentTrack.attrs,track.attrs,["LANGUAGE"]))return i}}return-1}loadPlaylist(hlsUrlParameters){const audioTrack=this.currentTrack;if(this.shouldLoadPlaylist(audioTrack)&&audioTrack){super.loadPlaylist();const id=audioTrack.id,groupId=audioTrack.groupId;let url=audioTrack.url;if(hlsUrlParameters)try{url=hlsUrlParameters.addDirectives(url)}catch(error){this.warn(`Could not construct new URL with HLS Delivery Directives: ${error}`)}this.log(`loading audio-track playlist ${id} "${audioTrack.name}" lang:${audioTrack.lang} group:${groupId}`),this.clearTimer(),this.hls.trigger(Events.AUDIO_TRACK_LOADING,{url,id,groupId,deliveryDirectives:hlsUrlParameters||null})}}},emeController:EMEController,cmcdController:class CMCDController{constructor(hls){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=context=>{try{this.apply(context,{ot:CmObjectType.MANIFEST,su:!this.initialized})}catch(error){logger.warn("Could not generate manifest CMCD data.",error)}},this.applyFragmentData=context=>{try{const fragment=context.frag,level=this.hls.levels[fragment.level],ot=this.getObjectType(fragment),data={d:1e3*fragment.duration,ot};ot!==CmObjectType.VIDEO&&ot!==CmObjectType.AUDIO&&ot!=CmObjectType.MUXED||(data.br=level.bitrate/1e3,data.tb=this.getTopBandwidth(ot)/1e3,data.bl=this.getBufferLength(ot)),this.apply(context,data)}catch(error){logger.warn("Could not generate segment CMCD data.",error)}},this.hls=hls;const config=this.config=hls.config,{cmcd}=config;null!=cmcd&&(config.pLoader=this.createPlaylistLoader(),config.fLoader=this.createFragmentLoader(),this.sid=cmcd.sessionId||function uuid(){try{return crypto.randomUUID()}catch(error){try{const url=URL.createObjectURL(new Blob),uuid=url.toString();return URL.revokeObjectURL(url),uuid.slice(uuid.lastIndexOf("/")+1)}catch(error){let dt=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(c=>{const r=(dt+16*Math.random())%16|0;return dt=Math.floor(dt/16),("x"==c?r:3&r|8).toString(16)}))}}}(),this.cid=cmcd.contentId,this.useHeaders=!0===cmcd.useHeaders,this.includeKeys=cmcd.includeKeys,this.registerListeners())}registerListeners(){const hls=this.hls;hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events.MEDIA_DETACHED,this.onMediaDetached,this),hls.on(Events.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const hls=this.hls;hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events.MEDIA_DETACHED,this.onMediaDetached,this),hls.off(Events.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(event,data){this.media=data.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(event,data){var _data$tracks$audio,_data$tracks$video;this.audioBuffer=null==(_data$tracks$audio=data.tracks.audio)?void 0:_data$tracks$audio.buffer,this.videoBuffer=null==(_data$tracks$video=data.tracks.video)?void 0:_data$tracks$video.buffer}createData(){var _this$media;return{v:1,sf:CmStreamingFormat.HLS,sid:this.sid,cid:this.cid,pr:null==(_this$media=this.media)?void 0:_this$media.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(context,data={}){_extends(data,this.createData());const isVideo=data.ot===CmObjectType.INIT||data.ot===CmObjectType.VIDEO||data.ot===CmObjectType.MUXED;this.starved&&isVideo&&(data.bs=!0,data.su=!0,this.starved=!1),null==data.su&&(data.su=this.buffering);const{includeKeys}=this;includeKeys&&(data=Object.keys(data).reduce(((acc,key)=>(includeKeys.includes(key)&&(acc[key]=data[key]),acc)),{})),this.useHeaders?(context.headers||(context.headers={}),appendCmcdHeaders(context.headers,data)):context.url=appendCmcdQuery(context.url,data)}getObjectType(fragment){const{type}=fragment;return"subtitle"===type?CmObjectType.TIMED_TEXT:"initSegment"===fragment.sn?CmObjectType.INIT:"audio"===type?CmObjectType.AUDIO:"main"===type?this.hls.audioTracks.length?CmObjectType.VIDEO:CmObjectType.MUXED:void 0}getTopBandwidth(type){let levels,bitrate=0;const hls=this.hls;if(type===CmObjectType.AUDIO)levels=hls.audioTracks;else{const max=hls.maxAutoLevel,len=max>-1?max+1:hls.levels.length;levels=hls.levels.slice(0,len)}for(const level of levels)level.bitrate>bitrate&&(bitrate=level.bitrate);return bitrate>0?bitrate:NaN}getBufferLength(type){const media=this.hls.media,buffer=type===CmObjectType.AUDIO?this.audioBuffer:this.videoBuffer;if(!buffer||!media)return NaN;return 1e3*BufferHelper.bufferInfo(buffer,media.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader}=this.config,apply=this.applyPlaylistData,Ctor=pLoader||this.config.loader;return class CmcdPlaylistLoader{constructor(config){this.loader=void 0,this.loader=new Ctor(config)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(context,config,callbacks){apply(context),this.loader.load(context,config,callbacks)}}}createFragmentLoader(){const{fLoader}=this.config,apply=this.applyFragmentData,Ctor=fLoader||this.config.loader;return class CmcdFragmentLoader{constructor(config){this.loader=void 0,this.loader=new Ctor(config)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(context,config,callbacks){apply(context),this.loader.load(context,config,callbacks)}}}},contentSteeringController:class ContentSteeringController{constructor(hls){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=hls,this.log=logger.log.bind(logger,"[content-steering]:"),this.registerListeners()}registerListeners(){const hls=this.hls;hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this),hls.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events.ERROR,this.onError,this)}unregisterListeners(){const hls=this.hls;hls&&(hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),hls.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const ttl=1e3*this.timeToLoad-(performance.now()-this.updated);if(ttl>0)return void this.scheduleRefresh(this.uri,ttl)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(levelToRemove){const levels=this.levels;levels&&(this.levels=levels.filter((level=>level!==levelToRemove)))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(event,data){const{contentSteering}=data;null!==contentSteering&&(this.pathwayId=contentSteering.pathwayId,this.uri=contentSteering.uri,this.started&&this.startLoad())}onManifestParsed(event,data){this.audioTracks=data.audioTracks,this.subtitleTracks=data.subtitleTracks}onError(event,data){const{errorAction}=data;if((null==errorAction?void 0:errorAction.action)===NetworkErrorAction_SendAlternateToPenaltyBox&&errorAction.flags===ErrorActionFlags_MoveAllAlternatesMatchingHost){const levels=this.levels;let pathwayPriority=this.pathwayPriority,errorPathway=this.pathwayId;if(data.context){const{groupId,pathwayId,type}=data.context;groupId&&levels?errorPathway=this.getPathwayForGroupId(groupId,type,errorPathway):pathwayId&&(errorPathway=pathwayId)}errorPathway in this.penalizedPathways||(this.penalizedPathways[errorPathway]=performance.now()),!pathwayPriority&&levels&&(pathwayPriority=levels.reduce(((pathways,level)=>(-1===pathways.indexOf(level.pathwayId)&&pathways.push(level.pathwayId),pathways)),[])),pathwayPriority&&pathwayPriority.length>1&&(this.updatePathwayPriority(pathwayPriority),errorAction.resolved=this.pathwayId!==errorPathway),errorAction.resolved||logger.warn(`Could not resolve ${data.details} ("${data.error.message}") with content-steering for Pathway: ${errorPathway} levels: ${levels?levels.length:levels} priorities: ${JSON.stringify(pathwayPriority)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(levels){this.levels=levels;let pathwayLevels=this.getLevelsForPathway(this.pathwayId);if(0===pathwayLevels.length){const pathwayId=levels[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${pathwayId}"`),pathwayLevels=this.getLevelsForPathway(pathwayId),this.pathwayId=pathwayId}return pathwayLevels.length!==levels.length?(this.log(`Found ${pathwayLevels.length}/${levels.length} levels in Pathway "${this.pathwayId}"`),pathwayLevels):levels}getLevelsForPathway(pathwayId){return null===this.levels?[]:this.levels.filter((level=>pathwayId===level.pathwayId))}updatePathwayPriority(pathwayPriority){let levels;this.pathwayPriority=pathwayPriority;const penalizedPathways=this.penalizedPathways,now=performance.now();Object.keys(penalizedPathways).forEach((pathwayId=>{now-penalizedPathways[pathwayId]>3e5&&delete penalizedPathways[pathwayId]}));for(let i=0;i<pathwayPriority.length;i++){const pathwayId=pathwayPriority[i];if(pathwayId in penalizedPathways)continue;if(pathwayId===this.pathwayId)return;const selectedIndex=this.hls.nextLoadLevel,selectedLevel=this.hls.levels[selectedIndex];if(levels=this.getLevelsForPathway(pathwayId),levels.length>0){this.log(`Setting Pathway to "${pathwayId}"`),this.pathwayId=pathwayId,reassignFragmentLevelIndexes(levels),this.hls.trigger(Events.LEVELS_UPDATED,{levels});const levelAfterChange=this.hls.levels[selectedIndex];selectedLevel&&levelAfterChange&&this.levels&&(levelAfterChange.attrs["STABLE-VARIANT-ID"]!==selectedLevel.attrs["STABLE-VARIANT-ID"]&&levelAfterChange.bitrate!==selectedLevel.bitrate&&this.log(`Unstable Pathways change from bitrate ${selectedLevel.bitrate} to ${levelAfterChange.bitrate}`),this.hls.nextLoadLevel=selectedIndex);break}}}getPathwayForGroupId(groupId,type,defaultPathway){const levels=this.getLevelsForPathway(defaultPathway).concat(this.levels||[]);for(let i=0;i<levels.length;i++)if(type===PlaylistContextType_AUDIO_TRACK&&levels[i].hasAudioGroup(groupId)||type===PlaylistContextType_SUBTITLE_TRACK&&levels[i].hasSubtitleGroup(groupId))return levels[i].pathwayId;return defaultPathway}clonePathways(pathwayClones){const levels=this.levels;if(!levels)return;const audioGroupCloneMap={},subtitleGroupCloneMap={};pathwayClones.forEach((pathwayClone=>{const{ID:cloneId,"BASE-ID":baseId,"URI-REPLACEMENT":uriReplacement}=pathwayClone;if(levels.some((level=>level.pathwayId===cloneId)))return;const clonedVariants=this.getLevelsForPathway(baseId).map((baseLevel=>{const attributes=new AttrList(baseLevel.attrs);attributes["PATHWAY-ID"]=cloneId;const clonedAudioGroupId=attributes.AUDIO&&`${attributes.AUDIO}_clone_${cloneId}`,clonedSubtitleGroupId=attributes.SUBTITLES&&`${attributes.SUBTITLES}_clone_${cloneId}`;clonedAudioGroupId&&(audioGroupCloneMap[attributes.AUDIO]=clonedAudioGroupId,attributes.AUDIO=clonedAudioGroupId),clonedSubtitleGroupId&&(subtitleGroupCloneMap[attributes.SUBTITLES]=clonedSubtitleGroupId,attributes.SUBTITLES=clonedSubtitleGroupId);const url=performUriReplacement(baseLevel.uri,attributes["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",uriReplacement),clonedLevel=new Level({attrs:attributes,audioCodec:baseLevel.audioCodec,bitrate:baseLevel.bitrate,height:baseLevel.height,name:baseLevel.name,url,videoCodec:baseLevel.videoCodec,width:baseLevel.width});if(baseLevel.audioGroups)for(let i=1;i<baseLevel.audioGroups.length;i++)clonedLevel.addGroupId("audio",`${baseLevel.audioGroups[i]}_clone_${cloneId}`);if(baseLevel.subtitleGroups)for(let i=1;i<baseLevel.subtitleGroups.length;i++)clonedLevel.addGroupId("text",`${baseLevel.subtitleGroups[i]}_clone_${cloneId}`);return clonedLevel}));levels.push(...clonedVariants),cloneRenditionGroups(this.audioTracks,audioGroupCloneMap,uriReplacement,cloneId),cloneRenditionGroups(this.subtitleTracks,subtitleGroupCloneMap,uriReplacement,cloneId)}))}loadSteeringManifest(uri){const config=this.hls.config,Loader=config.loader;let url;this.loader&&this.loader.destroy(),this.loader=new Loader(config);try{url=new self.URL(uri)}catch(error){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${uri}`)}if("data:"!==url.protocol){const throughput=0|(this.hls.bandwidthEstimate||config.abrEwmaDefaultEstimate);url.searchParams.set("_HLS_pathway",this.pathwayId),url.searchParams.set("_HLS_throughput",""+throughput)}const context={responseType:"json",url:url.href},loadPolicy=config.steeringManifestLoadPolicy.default,legacyRetryCompatibility=loadPolicy.errorRetry||loadPolicy.timeoutRetry||{},loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:legacyRetryCompatibility.maxNumRetry||0,retryDelay:legacyRetryCompatibility.retryDelayMs||0,maxRetryDelay:legacyRetryCompatibility.maxRetryDelayMs||0},callbacks={onSuccess:(response,stats,context,networkDetails)=>{this.log(`Loaded steering manifest: "${url}"`);const steeringData=response.data;if(1!==steeringData.VERSION)return void this.log(`Steering VERSION ${steeringData.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=steeringData.TTL;const{"RELOAD-URI":reloadUri,"PATHWAY-CLONES":pathwayClones,"PATHWAY-PRIORITY":pathwayPriority}=steeringData;if(reloadUri)try{this.uri=new self.URL(reloadUri,url).href}catch(error){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${reloadUri}`)}this.scheduleRefresh(this.uri||context.url),pathwayClones&&this.clonePathways(pathwayClones);const loadedSteeringData={steeringManifest:steeringData,url:url.toString()};this.hls.trigger(Events.STEERING_MANIFEST_LOADED,loadedSteeringData),pathwayPriority&&this.updatePathwayPriority(pathwayPriority)},onError:(error,context,networkDetails,stats)=>{if(this.log(`Error loading steering manifest: ${error.code} ${error.text} (${context.url})`),this.stopLoad(),410===error.code)return this.enabled=!1,void this.log(`Steering manifest ${context.url} no longer available`);let ttl=1e3*this.timeToLoad;if(429!==error.code)this.scheduleRefresh(this.uri||context.url,ttl);else{const loader=this.loader;if("function"==typeof(null==loader?void 0:loader.getResponseHeader)){const retryAfter=loader.getResponseHeader("Retry-After");retryAfter&&(ttl=1e3*parseFloat(retryAfter))}this.log(`Steering manifest ${context.url} rate limited`)}},onTimeout:(stats,context,networkDetails)=>{this.log(`Timeout loading steering manifest (${context.url})`),this.scheduleRefresh(this.uri||context.url)}};this.log(`Requesting steering manifest: ${url}`),this.loader.load(context,loaderConfig,callbacks)}scheduleRefresh(uri,ttlMs=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout((()=>{var _this$hls;const media=null==(_this$hls=this.hls)?void 0:_this$hls.media;!media||media.ended?this.scheduleRefresh(uri,1e3*this.timeToLoad):this.loadSteeringManifest(uri)}),ttlMs)}}});function deepCpy(obj){return obj&&"object"==typeof obj?Array.isArray(obj)?obj.map(deepCpy):Object.keys(obj).reduce(((result,key)=>(result[key]=deepCpy(obj[key]),result)),{}):obj}function enableStreamingMode(config){const currentLoader=config.loader;if(currentLoader!==FetchLoader&&currentLoader!==XhrLoader)logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),config.progressive=!1;else{(function fetchSupported(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1})()&&(config.loader=FetchLoader,config.progressive=!0,config.enableSoftwareAES=!0,logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}}let chromeOrFirefox;class LevelController extends BasePlaylistController{constructor(hls,contentSteeringController){super(hls,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=contentSteeringController,this._registerListeners()}_registerListeners(){const{hls}=this;hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.MANIFEST_LOADED,this.onManifestLoaded,this),hls.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events.FRAG_BUFFERED,this.onFragBuffered,this),hls.on(Events.ERROR,this.onError,this)}_unregisterListeners(){const{hls}=this;hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.MANIFEST_LOADED,this.onManifestLoaded,this),hls.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events.FRAG_BUFFERED,this.onFragBuffered,this),hls.off(Events.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach((level=>{level.loadError=0,level.fragmentError=0})),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(event,data){this.resetLevels()}onManifestLoaded(event,data){const preferManagedMediaSource=this.hls.config.preferManagedMediaSource,levels=[],redundantSet={},generatePathwaySet={};let resolutionFound=!1,videoCodecFound=!1,audioCodecFound=!1;data.levels.forEach((levelParsed=>{var _audioCodec,_videoCodec;const attributes=levelParsed.attrs;let{audioCodec,videoCodec}=levelParsed;-1!==(null==(_audioCodec=audioCodec)?void 0:_audioCodec.indexOf("mp4a.40.34"))&&(chromeOrFirefox||(chromeOrFirefox=/chrome|firefox/i.test(navigator.userAgent)),chromeOrFirefox&&(levelParsed.audioCodec=audioCodec=void 0)),audioCodec&&(levelParsed.audioCodec=audioCodec=getCodecCompatibleName(audioCodec,preferManagedMediaSource)),0===(null==(_videoCodec=videoCodec)?void 0:_videoCodec.indexOf("avc1"))&&(videoCodec=levelParsed.videoCodec=function convertAVC1ToAVCOTI(codec){const avcdata=codec.split(".");if(avcdata.length>2){let result=avcdata.shift()+".";return result+=parseInt(avcdata.shift()).toString(16),result+=("000"+parseInt(avcdata.shift()).toString(16)).slice(-4),result}return codec}(videoCodec));const{width,height,unknownCodecs}=levelParsed;if(resolutionFound||(resolutionFound=!(!width||!height)),videoCodecFound||(videoCodecFound=!!videoCodec),audioCodecFound||(audioCodecFound=!!audioCodec),null!=unknownCodecs&&unknownCodecs.length||audioCodec&&!areCodecsMediaSourceSupported(audioCodec,"audio",preferManagedMediaSource)||videoCodec&&!areCodecsMediaSourceSupported(videoCodec,"video",preferManagedMediaSource))return;const{CODECS,"FRAME-RATE":FRAMERATE,"HDCP-LEVEL":HDCP,"PATHWAY-ID":PATHWAY,RESOLUTION,"VIDEO-RANGE":VIDEO_RANGE}=attributes,levelKey=`${`${PATHWAY||"."}-`}${levelParsed.bitrate}-${RESOLUTION}-${FRAMERATE}-${CODECS}-${VIDEO_RANGE}-${HDCP}`;if(redundantSet[levelKey])if(redundantSet[levelKey].uri===levelParsed.url||levelParsed.attrs["PATHWAY-ID"])redundantSet[levelKey].addGroupId("audio",attributes.AUDIO),redundantSet[levelKey].addGroupId("text",attributes.SUBTITLES);else{const pathwayCount=generatePathwaySet[levelKey]+=1;levelParsed.attrs["PATHWAY-ID"]=new Array(pathwayCount+1).join(".");const level=new Level(levelParsed);redundantSet[levelKey]=level,levels.push(level)}else{const level=new Level(levelParsed);redundantSet[levelKey]=level,generatePathwaySet[levelKey]=1,levels.push(level)}})),this.filterAndSortMediaOptions(levels,data,resolutionFound,videoCodecFound,audioCodecFound)}filterAndSortMediaOptions(filteredLevels,data,resolutionFound,videoCodecFound,audioCodecFound){let audioTracks=[],subtitleTracks=[],levels=filteredLevels;if((resolutionFound||videoCodecFound)&&audioCodecFound&&(levels=levels.filter((({videoCodec,videoRange,width,height})=>(!!videoCodec||!(!width||!height))&&function isVideoRange(value){return!!value&&VideoRangeValues.indexOf(value)>-1}(videoRange)))),0===levels.length)return void Promise.resolve().then((()=>{if(this.hls){data.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(data.levels[0].attrs)}`);const error=new Error("no level with compatible codecs found in manifest");this.hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:data.url,error,reason:error.message})}}));if(data.audioTracks){const{preferManagedMediaSource}=this.hls.config;audioTracks=data.audioTracks.filter((track=>!track.audioCodec||areCodecsMediaSourceSupported(track.audioCodec,"audio",preferManagedMediaSource))),assignTrackIdsByGroup(audioTracks)}data.subtitles&&(subtitleTracks=data.subtitles,assignTrackIdsByGroup(subtitleTracks));const unsortedLevels=levels.slice(0);levels.sort(((a,b)=>{if(a.attrs["HDCP-LEVEL"]!==b.attrs["HDCP-LEVEL"])return(a.attrs["HDCP-LEVEL"]||"")>(b.attrs["HDCP-LEVEL"]||"")?1:-1;if(resolutionFound&&a.height!==b.height)return a.height-b.height;if(a.frameRate!==b.frameRate)return a.frameRate-b.frameRate;if(a.videoRange!==b.videoRange)return VideoRangeValues.indexOf(a.videoRange)-VideoRangeValues.indexOf(b.videoRange);if(a.videoCodec!==b.videoCodec){const valueA=videoCodecPreferenceValue(a.videoCodec),valueB=videoCodecPreferenceValue(b.videoCodec);if(valueA!==valueB)return valueB-valueA}if(a.uri===b.uri&&a.codecSet!==b.codecSet){const valueA=codecsSetSelectionPreferenceValue(a.codecSet),valueB=codecsSetSelectionPreferenceValue(b.codecSet);if(valueA!==valueB)return valueB-valueA}return a.averageBitrate!==b.averageBitrate?a.averageBitrate-b.averageBitrate:0}));let firstLevelInPlaylist=unsortedLevels[0];if(this.steering&&(levels=this.steering.filterParsedLevels(levels),levels.length!==unsortedLevels.length))for(let i=0;i<unsortedLevels.length;i++)if(unsortedLevels[i].pathwayId===levels[0].pathwayId){firstLevelInPlaylist=unsortedLevels[i];break}this._levels=levels;for(let i=0;i<levels.length;i++)if(levels[i]===firstLevelInPlaylist){var _this$hls$userConfig;this._firstLevel=i;const firstLevelBitrate=firstLevelInPlaylist.bitrate,bandwidthEstimate=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${levels.length} level(s) found, first bitrate: ${firstLevelBitrate}`),void 0===(null==(_this$hls$userConfig=this.hls.userConfig)?void 0:_this$hls$userConfig.abrEwmaDefaultEstimate)){const startingBwEstimate=Math.min(firstLevelBitrate,this.hls.config.abrEwmaDefaultEstimateMax);startingBwEstimate>bandwidthEstimate&&bandwidthEstimate===hlsDefaultConfig.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=startingBwEstimate)}break}const audioOnly=audioCodecFound&&!videoCodecFound,edata={levels,audioTracks,subtitleTracks,sessionData:data.sessionData,sessionKeys:data.sessionKeys,firstLevel:this._firstLevel,stats:data.stats,audio:audioCodecFound,video:videoCodecFound,altAudio:!audioOnly&&audioTracks.some((t=>!!t.url))};this.hls.trigger(Events.MANIFEST_PARSED,edata),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(newLevel){const levels=this._levels;if(0===levels.length)return;if(newLevel<0||newLevel>=levels.length){const error=new Error("invalid level idx"),fatal=newLevel<0;if(this.hls.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.LEVEL_SWITCH_ERROR,level:newLevel,fatal,error,reason:error.message}),fatal)return;newLevel=Math.min(newLevel,levels.length-1)}const lastLevelIndex=this.currentLevelIndex,lastLevel=this.currentLevel,lastPathwayId=lastLevel?lastLevel.attrs["PATHWAY-ID"]:void 0,level=levels[newLevel],pathwayId=level.attrs["PATHWAY-ID"];if(this.currentLevelIndex=newLevel,this.currentLevel=level,lastLevelIndex===newLevel&&level.details&&lastLevel&&lastPathwayId===pathwayId)return;this.log(`Switching to level ${newLevel} (${level.height?level.height+"p ":""}${level.videoRange?level.videoRange+" ":""}${level.codecSet?level.codecSet+" ":""}@${level.bitrate})${pathwayId?" with Pathway "+pathwayId:""} from level ${lastLevelIndex}${lastPathwayId?" with Pathway "+lastPathwayId:""}`);const levelSwitchingData={level:newLevel,attrs:level.attrs,details:level.details,bitrate:level.bitrate,averageBitrate:level.averageBitrate,maxBitrate:level.maxBitrate,realBitrate:level.realBitrate,width:level.width,height:level.height,codecSet:level.codecSet,audioCodec:level.audioCodec,videoCodec:level.videoCodec,audioGroups:level.audioGroups,subtitleGroups:level.subtitleGroups,loaded:level.loaded,loadError:level.loadError,fragmentError:level.fragmentError,name:level.name,id:level.id,uri:level.uri,url:level.url,urlId:0,audioGroupIds:level.audioGroupIds,textGroupIds:level.textGroupIds};this.hls.trigger(Events.LEVEL_SWITCHING,levelSwitchingData);const levelDetails=level.details;if(!levelDetails||levelDetails.live){const hlsUrlParameters=this.switchParams(level.uri,null==lastLevel?void 0:lastLevel.details);this.loadPlaylist(hlsUrlParameters)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(newLevel){this.manualLevelIndex=newLevel,void 0===this._startLevel&&(this._startLevel=newLevel),-1!==newLevel&&(this.level=newLevel)}get firstLevel(){return this._firstLevel}set firstLevel(newLevel){this._firstLevel=newLevel}get startLevel(){if(void 0===this._startLevel){const configStartLevel=this.hls.config.startLevel;return void 0!==configStartLevel?configStartLevel:this.hls.firstAutoLevel}return this._startLevel}set startLevel(newLevel){this._startLevel=newLevel}onError(event,data){!data.fatal&&data.context&&data.context.type===PlaylistContextType_LEVEL&&data.context.level===this.level&&this.checkRetry(data)}onFragBuffered(event,{frag}){if(void 0!==frag&&frag.type===PlaylistLevelType_MAIN){const el=frag.elementaryStreams;if(!Object.keys(el).some((type=>!!el[type])))return;const level=this._levels[frag.level];null!=level&&level.loadError&&(this.log(`Resetting level error count of ${level.loadError} on frag buffered`),level.loadError=0)}}onLevelLoaded(event,data){var _data$deliveryDirecti2;const{level,details}=data,curLevel=this._levels[level];var _data$deliveryDirecti;if(!curLevel)return this.warn(`Invalid level index ${level}`),void(null!=(_data$deliveryDirecti=data.deliveryDirectives)&&_data$deliveryDirecti.skip&&(details.deltaUpdateFailed=!0));level===this.currentLevelIndex?(0===curLevel.fragmentError&&(curLevel.loadError=0),this.playlistLoaded(level,data,curLevel.details)):null!=(_data$deliveryDirecti2=data.deliveryDirectives)&&_data$deliveryDirecti2.skip&&(details.deltaUpdateFailed=!0)}loadPlaylist(hlsUrlParameters){super.loadPlaylist();const currentLevelIndex=this.currentLevelIndex,currentLevel=this.currentLevel;if(currentLevel&&this.shouldLoadPlaylist(currentLevel)){let url=currentLevel.uri;if(hlsUrlParameters)try{url=hlsUrlParameters.addDirectives(url)}catch(error){this.warn(`Could not construct new URL with HLS Delivery Directives: ${error}`)}const pathwayId=currentLevel.attrs["PATHWAY-ID"];this.log(`Loading level index ${currentLevelIndex}${void 0!==(null==hlsUrlParameters?void 0:hlsUrlParameters.msn)?" at sn "+hlsUrlParameters.msn+" part "+hlsUrlParameters.part:""} with${pathwayId?" Pathway "+pathwayId:""} ${url}`),this.clearTimer(),this.hls.trigger(Events.LEVEL_LOADING,{url,level:currentLevelIndex,pathwayId:currentLevel.attrs["PATHWAY-ID"],id:0,deliveryDirectives:hlsUrlParameters||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(nextLevel){this.level=nextLevel,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=nextLevel)}removeLevel(levelIndex){var _this$currentLevel;const levels=this._levels.filter(((level,index)=>index!==levelIndex||(this.steering&&this.steering.removeLevel(level),level===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,level.details&&level.details.fragments.forEach((f=>f.level=-1))),!1)));reassignFragmentLevelIndexes(levels),this._levels=levels,this.currentLevelIndex>-1&&null!=(_this$currentLevel=this.currentLevel)&&_this$currentLevel.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(Events.LEVELS_UPDATED,{levels})}onLevelsUpdated(event,{levels}){this._levels=levels}checkMaxAutoUpdated(){const{autoLevelCapping,maxAutoLevel,maxHdcpLevel}=this.hls;this._maxAutoLevel!==maxAutoLevel&&(this._maxAutoLevel=maxAutoLevel,this.hls.trigger(Events.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping,levels:this.levels,maxAutoLevel,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel}))}}function assignTrackIdsByGroup(tracks){const groups={};tracks.forEach((track=>{const groupId=track.groupId||"";track.id=groups[groupId]=groups[groupId]||0,groups[groupId]++}))}class KeyLoader{constructor(config){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=config}abort(type){for(const uri in this.keyUriToKeyInfo){const loader=this.keyUriToKeyInfo[uri].loader;if(loader){var _loader$context;if(type&&type!==(null==(_loader$context=loader.context)?void 0:_loader$context.frag.type))return;loader.abort()}}}detach(){for(const uri in this.keyUriToKeyInfo){const keyInfo=this.keyUriToKeyInfo[uri];(keyInfo.mediaKeySessionContext||keyInfo.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[uri]}}destroy(){this.detach();for(const uri in this.keyUriToKeyInfo){const loader=this.keyUriToKeyInfo[uri].loader;loader&&loader.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(frag,details=ErrorDetails.KEY_LOAD_ERROR,error,networkDetails,response){return new LoadError({type:ErrorTypes.NETWORK_ERROR,details,fatal:!1,frag,response,error,networkDetails})}loadClear(loadingFrag,encryptedFragments){if(this.emeController&&this.config.emeEnabled){const{sn,cc}=loadingFrag;for(let i=0;i<encryptedFragments.length;i++){const frag=encryptedFragments[i];if(cc<=frag.cc&&("initSegment"===sn||"initSegment"===frag.sn||sn<frag.sn)){this.emeController.selectKeySystemFormat(frag).then((keySystemFormat=>{frag.setKeyFormat(keySystemFormat)}));break}}}}load(frag){return!frag.decryptdata&&frag.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(frag).then((keySystemFormat=>this.loadInternal(frag,keySystemFormat))):this.loadInternal(frag)}loadInternal(frag,keySystemFormat){var _keyInfo,_keyInfo2;keySystemFormat&&frag.setKeyFormat(keySystemFormat);const decryptdata=frag.decryptdata;if(!decryptdata){const error=new Error(keySystemFormat?`Expected frag.decryptdata to be defined after setting format ${keySystemFormat}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(frag,ErrorDetails.KEY_LOAD_ERROR,error))}const uri=decryptdata.uri;if(!uri)return Promise.reject(this.createKeyLoadError(frag,ErrorDetails.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${uri}"`)));let keyInfo=this.keyUriToKeyInfo[uri];if(null!=(_keyInfo=keyInfo)&&_keyInfo.decryptdata.key)return decryptdata.key=keyInfo.decryptdata.key,Promise.resolve({frag,keyInfo});var _keyInfo$mediaKeySess;if(null!=(_keyInfo2=keyInfo)&&_keyInfo2.keyLoadPromise)switch(null==(_keyInfo$mediaKeySess=keyInfo.mediaKeySessionContext)?void 0:_keyInfo$mediaKeySess.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return keyInfo.keyLoadPromise.then((keyLoadedData=>(decryptdata.key=keyLoadedData.keyInfo.decryptdata.key,{frag,keyInfo})))}switch(keyInfo=this.keyUriToKeyInfo[uri]={decryptdata,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},decryptdata.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===decryptdata.keyFormat?this.loadKeyHTTP(keyInfo,frag):this.loadKeyEME(keyInfo,frag);case"AES-128":return this.loadKeyHTTP(keyInfo,frag);default:return Promise.reject(this.createKeyLoadError(frag,ErrorDetails.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${decryptdata.method}"`)))}}loadKeyEME(keyInfo,frag){const keyLoadedData={frag,keyInfo};if(this.emeController&&this.config.emeEnabled){const keySessionContextPromise=this.emeController.loadKey(keyLoadedData);if(keySessionContextPromise)return(keyInfo.keyLoadPromise=keySessionContextPromise.then((keySessionContext=>(keyInfo.mediaKeySessionContext=keySessionContext,keyLoadedData)))).catch((error=>{throw keyInfo.keyLoadPromise=null,error}))}return Promise.resolve(keyLoadedData)}loadKeyHTTP(keyInfo,frag){const config=this.config,keyLoader=new(0,config.loader)(config);return frag.keyLoader=keyInfo.loader=keyLoader,keyInfo.keyLoadPromise=new Promise(((resolve,reject)=>{const loaderContext={keyInfo,frag,responseType:"arraybuffer",url:keyInfo.decryptdata.uri},loadPolicy=config.keyLoadPolicy.default,loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},loaderCallbacks={onSuccess:(response,stats,context,networkDetails)=>{const{frag,keyInfo,url:uri}=context;if(!frag.decryptdata||keyInfo!==this.keyUriToKeyInfo[uri])return reject(this.createKeyLoadError(frag,ErrorDetails.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),networkDetails));keyInfo.decryptdata.key=frag.decryptdata.key=new Uint8Array(response.data),frag.keyLoader=null,keyInfo.loader=null,resolve({frag,keyInfo})},onError:(response,context,networkDetails,stats)=>{this.resetLoader(context),reject(this.createKeyLoadError(frag,ErrorDetails.KEY_LOAD_ERROR,new Error(`HTTP Error ${response.code} loading key ${response.text}`),networkDetails,_objectSpread2({url:loaderContext.url,data:void 0},response)))},onTimeout:(stats,context,networkDetails)=>{this.resetLoader(context),reject(this.createKeyLoadError(frag,ErrorDetails.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),networkDetails))},onAbort:(stats,context,networkDetails)=>{this.resetLoader(context),reject(this.createKeyLoadError(frag,ErrorDetails.INTERNAL_ABORTED,new Error("key loading aborted"),networkDetails))}};keyLoader.load(loaderContext,loaderConfig,loaderCallbacks)}))}resetLoader(context){const{frag,keyInfo,url:uri}=context,loader=keyInfo.loader;frag.keyLoader===loader&&(frag.keyLoader=null,keyInfo.loader=null),delete this.keyUriToKeyInfo[uri],loader&&loader.destroy()}}function getSourceBuffer(){return self.SourceBuffer||self.WebKitSourceBuffer}function isMSESupported(){if(!getMediaSource())return!1;const sourceBuffer=getSourceBuffer();return!sourceBuffer||sourceBuffer.prototype&&"function"==typeof sourceBuffer.prototype.appendBuffer&&"function"==typeof sourceBuffer.prototype.remove}class GapController{constructor(config,media,fragmentTracker,hls){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=config,this.media=media,this.fragmentTracker=fragmentTracker,this.hls=hls}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(lastCurrentTime,activeFrag){const{config,media,stalled}=this;if(null===media)return;const{currentTime,seeking}=media,seeked=this.seeking&&!seeking,beginSeek=!this.seeking&&seeking;if(this.seeking=seeking,currentTime!==lastCurrentTime){if(this.moved=!0,seeking||(this.nudgeRetry=0),null!==stalled){if(this.stallReported){const _stalledDuration=self.performance.now()-stalled;logger.warn(`playback not stuck anymore @${currentTime}, after ${Math.round(_stalledDuration)}ms`),this.stallReported=!1}this.stalled=null}return}if(beginSeek||seeked)return void(this.stalled=null);if(media.paused&&!seeking||media.ended||0===media.playbackRate||!BufferHelper.getBuffered(media).length)return void(this.nudgeRetry=0);const bufferInfo=BufferHelper.bufferInfo(media,currentTime,0),nextStart=bufferInfo.nextStart||0;if(seeking){const hasEnoughBuffer=bufferInfo.len>2,noBufferGap=!nextStart||activeFrag&&activeFrag.start<=currentTime||nextStart-currentTime>2&&!this.fragmentTracker.getPartialFragment(currentTime);if(hasEnoughBuffer||noBufferGap)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var _level$details;if(!(bufferInfo.len>0)&&!nextStart)return;const startJump=Math.max(nextStart,bufferInfo.start||0)-currentTime,level=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,maxStartGapJump=(null==level||null==(_level$details=level.details)?void 0:_level$details.live)?2*level.details.targetduration:2,partialOrGap=this.fragmentTracker.getPartialFragment(currentTime);if(startJump>0&&(startJump<=maxStartGapJump||partialOrGap))return void(media.paused||this._trySkipBufferHole(partialOrGap))}const tnow=self.performance.now();if(null===stalled)return void(this.stalled=tnow);const stalledDuration=tnow-stalled;if(!seeking&&stalledDuration>=250&&(this._reportStall(bufferInfo),!this.media))return;const bufferedWithHoles=BufferHelper.bufferInfo(media,currentTime,config.maxBufferHole);this._tryFixBufferStall(bufferedWithHoles,stalledDuration)}_tryFixBufferStall(bufferInfo,stalledDurationMs){const{config,fragmentTracker,media}=this;if(null===media)return;const currentTime=media.currentTime,partial=fragmentTracker.getPartialFragment(currentTime);if(partial){if(this._trySkipBufferHole(partial)||!this.media)return}(bufferInfo.len>config.maxBufferHole||bufferInfo.nextStart&&bufferInfo.nextStart-currentTime<config.maxBufferHole)&&stalledDurationMs>1e3*config.highBufferWatchdogPeriod&&(logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(bufferInfo){const{hls,media,stallReported}=this;if(!stallReported&&media){this.stallReported=!0;const error=new Error(`Playback stalling at @${media.currentTime} due to low buffer (${JSON.stringify(bufferInfo)})`);logger.warn(error.message),hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,error,buffer:bufferInfo.len})}}_trySkipBufferHole(partial){const{config,hls,media}=this;if(null===media)return 0;const currentTime=media.currentTime,bufferInfo=BufferHelper.bufferInfo(media,currentTime,0),startTime=currentTime<bufferInfo.start?bufferInfo.start:bufferInfo.nextStart;if(startTime){const bufferStarved=bufferInfo.len<=config.maxBufferHole,waiting=bufferInfo.len>0&&bufferInfo.len<1&&media.readyState<3,gapLength=startTime-currentTime;if(gapLength>0&&(bufferStarved||waiting)){if(gapLength>config.maxBufferHole){const{fragmentTracker}=this;let startGap=!1;if(0===currentTime){const startFrag=fragmentTracker.getAppendedFrag(0,PlaylistLevelType_MAIN);startFrag&&startTime<startFrag.end&&(startGap=!0)}if(!startGap){const startProvisioned=partial||fragmentTracker.getAppendedFrag(currentTime,PlaylistLevelType_MAIN);if(startProvisioned){let moreToLoad=!1,pos=startProvisioned.end;for(;pos<startTime;){const provisioned=fragmentTracker.getPartialFragment(pos);if(!provisioned){moreToLoad=!0;break}pos+=provisioned.duration}if(moreToLoad)return 0}}}const targetTime=Math.max(startTime+.05,currentTime+.1);if(logger.warn(`skipping hole, adjusting currentTime from ${currentTime} to ${targetTime}`),this.moved=!0,this.stalled=null,media.currentTime=targetTime,partial&&!partial.gap){const error=new Error(`fragment loaded with buffer holes, seeking from ${currentTime} to ${targetTime}`);hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,error,reason:error.message,frag:partial})}return targetTime}}return 0}_tryNudgeBuffer(){const{config,hls,media,nudgeRetry}=this;if(null===media)return;const currentTime=media.currentTime;if(this.nudgeRetry++,nudgeRetry<config.nudgeMaxRetry){const targetTime=currentTime+(nudgeRetry+1)*config.nudgeOffset,error=new Error(`Nudging 'currentTime' from ${currentTime} to ${targetTime}`);logger.warn(error.message),media.currentTime=targetTime,hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_NUDGE_ON_STALL,error,fatal:!1})}else{const error=new Error(`Playhead still not moving while enough data buffered @${currentTime} after ${config.nudgeMaxRetry} nudges`);logger.error(error.message),hls.trigger(Events.ERROR,{type:ErrorTypes.MEDIA_ERROR,details:ErrorDetails.BUFFER_STALLED_ERROR,error,fatal:!0})}}}class StreamController extends BaseStreamController{constructor(hls,fragmentTracker,keyLoader){super(hls,fragmentTracker,keyLoader,"[stream-controller]",PlaylistLevelType_MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls}=this;hls.on(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events.LEVEL_LOADING,this.onLevelLoading,this),hls.on(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),hls.on(Events.ERROR,this.onError,this),hls.on(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),hls.on(Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),hls.on(Events.BUFFER_CREATED,this.onBufferCreated,this),hls.on(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),hls.on(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls}=this;hls.off(Events.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),hls.off(Events.ERROR,this.onError,this),hls.off(Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),hls.off(Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),hls.off(Events.BUFFER_CREATED,this.onBufferCreated,this),hls.off(Events.BUFFER_FLUSHED,this.onBufferFlushed,this),hls.off(Events.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(startPosition){if(this.levels){const{lastCurrentTime,hls}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let startLevel=hls.startLevel;-1===startLevel&&(hls.config.testBandwidth&&this.levels.length>1?(startLevel=0,this.bitrateTest=!0):startLevel=hls.firstAutoLevel),this.level=hls.nextLoadLevel=startLevel,this.loadedmetadata=!1}lastCurrentTime>0&&-1===startPosition&&(this.log(`Override startPosition with lastCurrentTime @${lastCurrentTime.toFixed(3)}`),startPosition=lastCurrentTime),this.state=State_IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=startPosition,this.tick()}else this._forceStartLoad=!0,this.state=State_STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case State_WAITING_LEVEL:{const{levels,level}=this,currentLevel=null==levels?void 0:levels[level],details=null==currentLevel?void 0:currentLevel.details;if(details&&(!details.live||this.levelLastLoaded===currentLevel)){if(this.waitForCdnTuneIn(details))break;this.state=State_IDLE;break}if(this.hls.nextLoadLevel!==this.level){this.state=State_IDLE;break}break}case State_FRAG_LOADING_WAITING_RETRY:{var _this$media;const now=self.performance.now(),retryDate=this.retryDate;if(!retryDate||now>=retryDate||null!=(_this$media=this.media)&&_this$media.seeking){const{levels,level}=this,currentLevel=null==levels?void 0:levels[level];this.resetStartWhenNotLoaded(currentLevel||null),this.state=State_IDLE}}}this.state===State_IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls,levelLastLoaded,levels,media}=this,{config,nextLoadLevel:level}=hls;if(null===levelLastLoaded||!media&&(this.startFragRequested||!config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;if(null==levels||!levels[level])return;const levelInfo=levels[level],bufferInfo=this.getMainFwdBufferInfo();if(null===bufferInfo)return;const lastDetails=this.getLevelDetails();if(lastDetails&&this._streamEnded(bufferInfo,lastDetails)){const data={};return this.altAudio&&(data.type="video"),this.hls.trigger(Events.BUFFER_EOS,data),void(this.state=State_ENDED)}hls.loadLevel!==level&&-1===hls.manualLevel&&this.log(`Adapting to level ${level} from level ${this.level}`),this.level=hls.nextLoadLevel=level;const levelDetails=levelInfo.details;if(!levelDetails||this.state===State_WAITING_LEVEL||levelDetails.live&&this.levelLastLoaded!==levelInfo)return this.level=level,void(this.state=State_WAITING_LEVEL);const bufferLen=bufferInfo.len,maxBufLen=this.getMaxBufferLength(levelInfo.maxBitrate);if(bufferLen>=maxBufLen)return;this.backtrackFragment&&this.backtrackFragment.start>bufferInfo.end&&(this.backtrackFragment=null);const targetBufferTime=this.backtrackFragment?this.backtrackFragment.start:bufferInfo.end;let frag=this.getNextFragment(targetBufferTime,levelDetails);if(this.couldBacktrack&&!this.fragPrevious&&frag&&"initSegment"!==frag.sn&&this.fragmentTracker.getState(frag)!==FragmentState_OK){var _this$backtrackFragme;const fragIdx=(null!=(_this$backtrackFragme=this.backtrackFragment)?_this$backtrackFragme:frag).sn-levelDetails.startSN,backtrackFrag=levelDetails.fragments[fragIdx-1];backtrackFrag&&frag.cc===backtrackFrag.cc&&(frag=backtrackFrag,this.fragmentTracker.removeFragment(backtrackFrag))}else this.backtrackFragment&&bufferInfo.len&&(this.backtrackFragment=null);if(frag&&this.isLoopLoading(frag,targetBufferTime)){if(!frag.gap){const type=this.audioOnly&&!this.altAudio?ElementaryStreamTypes_AUDIO:ElementaryStreamTypes_VIDEO,mediaBuffer=(type===ElementaryStreamTypes_VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;mediaBuffer&&this.afterBufferFlushed(mediaBuffer,type,PlaylistLevelType_MAIN)}frag=this.getNextFragmentLoopLoading(frag,levelDetails,bufferInfo,PlaylistLevelType_MAIN,maxBufLen)}frag&&(!frag.initSegment||frag.initSegment.data||this.bitrateTest||(frag=frag.initSegment),this.loadFragment(frag,levelInfo,targetBufferTime))}loadFragment(frag,level,targetBufferTime){const fragState=this.fragmentTracker.getState(frag);this.fragCurrent=frag,fragState===FragmentState_NOT_LOADED||fragState===FragmentState_PARTIAL?"initSegment"===frag.sn?this._loadInitSegment(frag,level):this.bitrateTest?(this.log(`Fragment ${frag.sn} of level ${frag.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(frag,level)):(this.startFragRequested=!0,super.loadFragment(frag,level,targetBufferTime)):this.clearTrackerIfNeeded(frag)}getBufferedFrag(position){return this.fragmentTracker.getBufferedFrag(position,PlaylistLevelType_MAIN)}followingBufferedFrag(frag){return frag?this.getBufferedFrag(frag.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels,media}=this;if(null!=media&&media.readyState){let fetchdelay;const fragPlayingCurrent=this.getAppendedFrag(media.currentTime);fragPlayingCurrent&&fragPlayingCurrent.start>1&&this.flushMainBuffer(0,fragPlayingCurrent.start-1);const levelDetails=this.getLevelDetails();if(null!=levelDetails&&levelDetails.live){const bufferInfo=this.getMainFwdBufferInfo();if(!bufferInfo||bufferInfo.len<2*levelDetails.targetduration)return}if(!media.paused&&levels){const nextLevel=levels[this.hls.nextLoadLevel],fragLastKbps=this.fragLastKbps;fetchdelay=fragLastKbps&&this.fragCurrent?this.fragCurrent.duration*nextLevel.maxBitrate/(1e3*fragLastKbps)+1:0}else fetchdelay=0;const bufferedFrag=this.getBufferedFrag(media.currentTime+fetchdelay);if(bufferedFrag){const nextBufferedFrag=this.followingBufferedFrag(bufferedFrag);if(nextBufferedFrag){this.abortCurrentFrag();const maxStart=nextBufferedFrag.maxStartPTS?nextBufferedFrag.maxStartPTS:nextBufferedFrag.start,fragDuration=nextBufferedFrag.duration,startPts=Math.max(bufferedFrag.end,maxStart+Math.min(Math.max(fragDuration-this.config.maxFragLookUpTolerance,fragDuration*(this.couldBacktrack?.5:.125)),fragDuration*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(startPts,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const fragCurrent=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,fragCurrent&&(fragCurrent.abortRequests(),this.fragmentTracker.removeFragment(fragCurrent)),this.state){case State_KEY_LOADING:case State_FRAG_LOADING:case State_FRAG_LOADING_WAITING_RETRY:case State_PARSING:case State_PARSED:this.state=State_IDLE}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(startOffset,endOffset){super.flushMainBuffer(startOffset,endOffset,this.altAudio?"video":null)}onMediaAttached(event,data){super.onMediaAttached(event,data);const media=data.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),media.addEventListener("playing",this.onvplaying),media.addEventListener("seeked",this.onvseeked),this.gapController=new GapController(this.config,media,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media}=this;media&&this.onvplaying&&this.onvseeked&&(media.removeEventListener("playing",this.onvplaying),media.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const media=this.media,currentTime=media?media.currentTime:null;isFiniteNumber(currentTime)&&this.log(`Media seeked to ${currentTime.toFixed(3)}`);const bufferInfo=this.getMainFwdBufferInfo();null!==bufferInfo&&0!==bufferInfo.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${bufferInfo?bufferInfo.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(event,data){let aac=!1,heaac=!1;data.levels.forEach((level=>{const codec=level.audioCodec;codec&&(aac=aac||-1!==codec.indexOf("mp4a.40.2"),heaac=heaac||-1!==codec.indexOf("mp4a.40.5"))})),this.audioCodecSwitch=aac&&heaac&&!function changeTypeSupported(){var _sourceBuffer$prototy;const sourceBuffer=getSourceBuffer();return"function"==typeof(null==sourceBuffer||null==(_sourceBuffer$prototy=sourceBuffer.prototype)?void 0:_sourceBuffer$prototy.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=data.levels,this.startFragRequested=!1}onLevelLoading(event,data){const{levels}=this;if(!levels||this.state!==State_IDLE)return;const level=levels[data.level];(!level.details||level.details.live&&this.levelLastLoaded!==level||this.waitForCdnTuneIn(level.details))&&(this.state=State_WAITING_LEVEL)}onLevelLoaded(event,data){var _curLevel$details;const{levels}=this,newLevelId=data.level,newDetails=data.details,duration=newDetails.totalduration;if(!levels)return void this.warn(`Levels were reset while loading level ${newLevelId}`);this.log(`Level ${newLevelId} loaded [${newDetails.startSN},${newDetails.endSN}]${newDetails.lastPartSn?`[part-${newDetails.lastPartSn}-${newDetails.lastPartIndex}]`:""}, cc [${newDetails.startCC}, ${newDetails.endCC}] duration:${duration}`);const curLevel=levels[newLevelId],fragCurrent=this.fragCurrent;!fragCurrent||this.state!==State_FRAG_LOADING&&this.state!==State_FRAG_LOADING_WAITING_RETRY||fragCurrent.level!==data.level&&fragCurrent.loader&&this.abortCurrentFrag();let sliding=0;if(newDetails.live||null!=(_curLevel$details=curLevel.details)&&_curLevel$details.live){var _this$levelLastLoaded;if(this.checkLiveUpdate(newDetails),newDetails.deltaUpdateFailed)return;sliding=this.alignPlaylists(newDetails,curLevel.details,null==(_this$levelLastLoaded=this.levelLastLoaded)?void 0:_this$levelLastLoaded.details)}if(curLevel.details=newDetails,this.levelLastLoaded=curLevel,this.hls.trigger(Events.LEVEL_UPDATED,{details:newDetails,level:newLevelId}),this.state===State_WAITING_LEVEL){if(this.waitForCdnTuneIn(newDetails))return;this.state=State_IDLE}this.startFragRequested?newDetails.live&&this.synchronizeToLiveEdge(newDetails):this.setStartPosition(newDetails,sliding),this.tick()}_handleFragmentLoadProgress(data){var _frag$initSegment;const{frag,part,payload}=data,{levels}=this;if(!levels)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${frag.sn} of level ${frag.level} will not be buffered`);const currentLevel=levels[frag.level],details=currentLevel.details;if(!details)return this.warn(`Dropping fragment ${frag.sn} of level ${frag.level} after level details were reset`),void this.fragmentTracker.removeFragment(frag);const videoCodec=currentLevel.videoCodec,accurateTimeOffset=details.PTSKnown||!details.live,initSegmentData=null==(_frag$initSegment=frag.initSegment)?void 0:_frag$initSegment.data,audioCodec=this._getAudioCodec(currentLevel),transmuxer=this.transmuxer=this.transmuxer||new TransmuxerInterface(this.hls,PlaylistLevelType_MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),partIndex=part?part.index:-1,partial=-1!==partIndex,chunkMeta=new ChunkMetadata(frag.level,frag.sn,frag.stats.chunkCount,payload.byteLength,partIndex,partial),initPTS=this.initPTS[frag.cc];transmuxer.push(payload,initSegmentData,audioCodec,videoCodec,frag,part,details.totalduration,accurateTimeOffset,chunkMeta,initPTS)}onAudioTrackSwitching(event,data){const fromAltAudio=this.altAudio;if(!!!data.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const fragCurrent=this.fragCurrent;fragCurrent&&(this.log("Switching to main audio track, cancel main fragment load"),fragCurrent.abortRequests(),this.fragmentTracker.removeFragment(fragCurrent)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const hls=this.hls;fromAltAudio&&(hls.trigger(Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),hls.trigger(Events.AUDIO_TRACK_SWITCHED,data)}}onAudioTrackSwitched(event,data){const trackId=data.id,altAudio=!!this.hls.audioTracks[trackId].url;if(altAudio){const videoBuffer=this.videoBuffer;videoBuffer&&this.mediaBuffer!==videoBuffer&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=videoBuffer)}this.altAudio=altAudio,this.tick()}onBufferCreated(event,data){const tracks=data.tracks;let mediaTrack,name,alternate=!1;for(const type in tracks){const track=tracks[type];if("main"===track.id){if(name=type,mediaTrack=track,"video"===type){const videoTrack=tracks[type];videoTrack&&(this.videoBuffer=videoTrack.buffer)}}else alternate=!0}alternate&&mediaTrack?(this.log(`Alternate track found, use ${name}.buffered to schedule main fragment loading`),this.mediaBuffer=mediaTrack.buffer):this.mediaBuffer=this.media}onFragBuffered(event,data){const{frag,part}=data;if(frag&&frag.type!==PlaylistLevelType_MAIN)return;if(this.fragContextChanged(frag))return this.warn(`Fragment ${frag.sn}${part?" p: "+part.index:""} of level ${frag.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===State_PARSED&&(this.state=State_IDLE));const stats=part?part.stats:frag.stats;this.fragLastKbps=Math.round(8*stats.total/(stats.buffering.end-stats.loading.first)),"initSegment"!==frag.sn&&(this.fragPrevious=frag),this.fragBufferedComplete(frag,part)}onError(event,data){var _data$context;if(data.fatal)this.state=State_ERROR;else switch(data.details){case ErrorDetails.FRAG_GAP:case ErrorDetails.FRAG_PARSING_ERROR:case ErrorDetails.FRAG_DECRYPT_ERROR:case ErrorDetails.FRAG_LOAD_ERROR:case ErrorDetails.FRAG_LOAD_TIMEOUT:case ErrorDetails.KEY_LOAD_ERROR:case ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(PlaylistLevelType_MAIN,data);break;case ErrorDetails.LEVEL_LOAD_ERROR:case ErrorDetails.LEVEL_LOAD_TIMEOUT:case ErrorDetails.LEVEL_PARSING_ERROR:data.levelRetry||this.state!==State_WAITING_LEVEL||(null==(_data$context=data.context)?void 0:_data$context.type)!==PlaylistContextType_LEVEL||(this.state=State_IDLE);break;case ErrorDetails.BUFFER_APPEND_ERROR:case ErrorDetails.BUFFER_FULL_ERROR:if(!data.parent||"main"!==data.parent)return;if(data.details===ErrorDetails.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(data)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case ErrorDetails.INTERNAL_EXCEPTION:this.recoverWorkerError(data)}}checkBuffer(){const{media,gapController}=this;if(media&&gapController&&media.readyState){if(this.loadedmetadata||!BufferHelper.getBuffered(media).length){const activeFrag=this.state!==State_IDLE?this.fragCurrent:null;gapController.poll(this.lastCurrentTime,activeFrag)}this.lastCurrentTime=media.currentTime}}onFragLoadEmergencyAborted(){this.state=State_IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(event,{type}){if(type!==ElementaryStreamTypes_AUDIO||this.audioOnly&&!this.altAudio){const mediaBuffer=(type===ElementaryStreamTypes_VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(mediaBuffer,type,PlaylistLevelType_MAIN),this.tick()}}onLevelsUpdated(event,data){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=data.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media}=this;if(!media)return;const currentTime=media.currentTime;let startPosition=this.startPosition;if(startPosition>=0&&currentTime<startPosition){if(media.seeking)return void this.log(`could not seek to ${startPosition}, already seeking at ${currentTime}`);const buffered=BufferHelper.getBuffered(media),delta=(buffered.length?buffered.start(0):0)-startPosition;delta>0&&(delta<this.config.maxBufferHole||delta<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${delta} to match buffer start`),startPosition+=delta,this.startPosition=startPosition),this.log(`seek to target start position ${startPosition} from current time ${currentTime}`),media.currentTime=startPosition}}_getAudioCodec(currentLevel){let audioCodec=this.config.defaultAudioCodec||currentLevel.audioCodec;return this.audioCodecSwap&&audioCodec&&(this.log("Swapping audio codec"),audioCodec=-1!==audioCodec.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),audioCodec}_loadBitrateTestFrag(frag,level){frag.bitrateTest=!0,this._doFragLoad(frag,level).then((data=>{const{hls}=this;if(!data||this.fragContextChanged(frag))return;level.fragmentError=0,this.state=State_IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const stats=frag.stats;stats.parsing.start=stats.parsing.end=stats.buffering.start=stats.buffering.end=self.performance.now(),hls.trigger(Events.FRAG_LOADED,data),frag.bitrateTest=!1}))}_handleTransmuxComplete(transmuxResult){var _id3$samples;const id="main",{hls}=this,{remuxResult,chunkMeta}=transmuxResult,context=this.getCurrentContext(chunkMeta);if(!context)return void this.resetWhenMissingContext(chunkMeta);const{frag,part,level}=context,{video,text,id3,initSegment}=remuxResult,{details}=level,audio=this.altAudio?void 0:remuxResult.audio;if(this.fragContextChanged(frag))this.fragmentTracker.removeFragment(frag);else{if(this.state=State_PARSING,initSegment){if(null!=initSegment&&initSegment.tracks){const mapFragment=frag.initSegment||frag;this._bufferInitSegment(level,initSegment.tracks,mapFragment,chunkMeta),hls.trigger(Events.FRAG_PARSING_INIT_SEGMENT,{frag:mapFragment,id,tracks:initSegment.tracks})}const initPTS=initSegment.initPTS,timescale=initSegment.timescale;isFiniteNumber(initPTS)&&(this.initPTS[frag.cc]={baseTime:initPTS,timescale},hls.trigger(Events.INIT_PTS_FOUND,{frag,id,initPTS,timescale}))}if(video&&details&&"initSegment"!==frag.sn){const prevFrag=details.fragments[frag.sn-1-details.startSN],isFirstFragment=frag.sn===details.startSN,isFirstInDiscontinuity=!prevFrag||frag.cc>prevFrag.cc;if(!1!==remuxResult.independent){const{startPTS,endPTS,startDTS,endDTS}=video;if(part)part.elementaryStreams[video.type]={startPTS,endPTS,startDTS,endDTS};else if(video.firstKeyFrame&&video.independent&&1===chunkMeta.id&&!isFirstInDiscontinuity&&(this.couldBacktrack=!0),video.dropped&&video.independent){const bufferInfo=this.getMainFwdBufferInfo(),targetBufferTime=(bufferInfo?bufferInfo.end:this.getLoadPosition())+this.config.maxBufferHole,startTime=video.firstKeyFramePTS?video.firstKeyFramePTS:startPTS;if(!isFirstFragment&&targetBufferTime<startTime-this.config.maxBufferHole&&!isFirstInDiscontinuity)return void this.backtrack(frag);isFirstInDiscontinuity&&(frag.gap=!0),frag.setElementaryStreamInfo(video.type,frag.start,endPTS,frag.start,endDTS,!0)}else isFirstFragment&&startPTS>2&&(frag.gap=!0);frag.setElementaryStreamInfo(video.type,startPTS,endPTS,startDTS,endDTS),this.backtrackFragment&&(this.backtrackFragment=frag),this.bufferFragmentData(video,frag,part,chunkMeta,isFirstFragment||isFirstInDiscontinuity)}else{if(!isFirstFragment&&!isFirstInDiscontinuity)return void this.backtrack(frag);frag.gap=!0}}if(audio){const{startPTS,endPTS,startDTS,endDTS}=audio;part&&(part.elementaryStreams[ElementaryStreamTypes_AUDIO]={startPTS,endPTS,startDTS,endDTS}),frag.setElementaryStreamInfo(ElementaryStreamTypes_AUDIO,startPTS,endPTS,startDTS,endDTS),this.bufferFragmentData(audio,frag,part,chunkMeta)}if(details&&null!=id3&&null!=(_id3$samples=id3.samples)&&_id3$samples.length){const emittedID3={id,frag,details,samples:id3.samples};hls.trigger(Events.FRAG_PARSING_METADATA,emittedID3)}if(details&&text){const emittedText={id,frag,details,samples:text.samples};hls.trigger(Events.FRAG_PARSING_USERDATA,emittedText)}}}_bufferInitSegment(currentLevel,tracks,frag,chunkMeta){if(this.state!==State_PARSING)return;this.audioOnly=!!tracks.audio&&!tracks.video,this.altAudio&&!this.audioOnly&&delete tracks.audio;const{audio,video,audiovideo}=tracks;if(audio){let audioCodec=currentLevel.audioCodec;const ua=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(audioCodec&&(audioCodec=-1!==audioCodec.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==audio.metadata.channelCount&&-1===ua.indexOf("firefox")&&(audioCodec="mp4a.40.5")),audioCodec&&-1!==audioCodec.indexOf("mp4a.40.5")&&-1!==ua.indexOf("android")&&"audio/mpeg"!==audio.container&&(audioCodec="mp4a.40.2",this.log(`Android: force audio codec to ${audioCodec}`)),currentLevel.audioCodec&&currentLevel.audioCodec!==audioCodec&&this.log(`Swapping manifest audio codec "${currentLevel.audioCodec}" for "${audioCodec}"`),audio.levelCodec=audioCodec,audio.id="main",this.log(`Init audio buffer, container:${audio.container}, codecs[selected/level/parsed]=[${audioCodec||""}/${currentLevel.audioCodec||""}/${audio.codec}]`)}video&&(video.levelCodec=currentLevel.videoCodec,video.id="main",this.log(`Init video buffer, container:${video.container}, codecs[level/parsed]=[${currentLevel.videoCodec||""}/${video.codec}]`)),audiovideo&&this.log(`Init audiovideo buffer, container:${audiovideo.container}, codecs[level/parsed]=[${currentLevel.codecs}/${audiovideo.codec}]`),this.hls.trigger(Events.BUFFER_CODECS,tracks),Object.keys(tracks).forEach((trackName=>{const initSegment=tracks[trackName].initSegment;null!=initSegment&&initSegment.byteLength&&this.hls.trigger(Events.BUFFER_APPENDING,{type:trackName,data:initSegment,frag,part:null,chunkMeta,parent:frag.type})})),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,PlaylistLevelType_MAIN)}backtrack(frag){this.couldBacktrack=!0,this.backtrackFragment=frag,this.resetTransmuxer(),this.flushBufferGap(frag),this.fragmentTracker.removeFragment(frag),this.fragPrevious=null,this.nextLoadPosition=frag.start,this.state=State_IDLE}checkFragmentChanged(){const video=this.media;let fragPlayingCurrent=null;if(video&&video.readyState>1&&!1===video.seeking){const currentTime=video.currentTime;if(BufferHelper.isBuffered(video,currentTime)?fragPlayingCurrent=this.getAppendedFrag(currentTime):BufferHelper.isBuffered(video,currentTime+.1)&&(fragPlayingCurrent=this.getAppendedFrag(currentTime+.1)),fragPlayingCurrent){this.backtrackFragment=null;const fragPlaying=this.fragPlaying,fragCurrentLevel=fragPlayingCurrent.level;fragPlaying&&fragPlayingCurrent.sn===fragPlaying.sn&&fragPlaying.level===fragCurrentLevel||(this.fragPlaying=fragPlayingCurrent,this.hls.trigger(Events.FRAG_CHANGED,{frag:fragPlayingCurrent}),fragPlaying&&fragPlaying.level===fragCurrentLevel||this.hls.trigger(Events.LEVEL_SWITCHED,{level:fragCurrentLevel}))}}}get nextLevel(){const frag=this.nextBufferedFrag;return frag?frag.level:-1}get currentFrag(){const media=this.media;return media?this.fragPlaying||this.getAppendedFrag(media.currentTime):null}get currentProgramDateTime(){const media=this.media;if(media){const currentTime=media.currentTime,frag=this.currentFrag;if(frag&&isFiniteNumber(currentTime)&&isFiniteNumber(frag.programDateTime)){const epocMs=frag.programDateTime+1e3*(currentTime-frag.start);return new Date(epocMs)}}return null}get currentLevel(){const frag=this.currentFrag;return frag?frag.level:-1}get nextBufferedFrag(){const frag=this.currentFrag;return frag?this.followingBufferedFrag(frag):null}get forceStartLoad(){return this._forceStartLoad}}class Hls{static get version(){return"1.5.3"}static isMSESupported(){return isMSESupported()}static isSupported(){return function isSupported(){if(!isMSESupported())return!1;const mediaSource=getMediaSource();return"function"==typeof(null==mediaSource?void 0:mediaSource.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some((codecsForVideoContainer=>mediaSource.isTypeSupported(mimeTypeForCodec(codecsForVideoContainer,"video"))))||["mp4a.40.2","fLaC"].some((codecForAudioContainer=>mediaSource.isTypeSupported(mimeTypeForCodec(codecForAudioContainer,"audio")))))}()}static getMediaSource(){return getMediaSource()}static get Events(){return Events}static get ErrorTypes(){return ErrorTypes}static get ErrorDetails(){return ErrorDetails}static get DefaultConfig(){return Hls.defaultConfig?Hls.defaultConfig:hlsDefaultConfig}static set DefaultConfig(defaultConfig){Hls.defaultConfig=defaultConfig}constructor(userConfig={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new EventEmitter,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,function enableLogs(debugConfig,id){if("object"==typeof console&&!0===debugConfig||"object"==typeof debugConfig){exportLoggerFunctions(debugConfig,"debug","log","info","warn","error");try{exportedLogger.log(`Debug logs enabled for "${id}" in hls.js version 1.5.3`)}catch(e){exportedLogger=fakeLogger}}else exportedLogger=fakeLogger}(userConfig.debug||!1,"Hls instance");const config=this.config=function mergeConfig(defaultConfig,userConfig){if((userConfig.liveSyncDurationCount||userConfig.liveMaxLatencyDurationCount)&&(userConfig.liveSyncDuration||userConfig.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==userConfig.liveMaxLatencyDurationCount&&(void 0===userConfig.liveSyncDurationCount||userConfig.liveMaxLatencyDurationCount<=userConfig.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==userConfig.liveMaxLatencyDuration&&(void 0===userConfig.liveSyncDuration||userConfig.liveMaxLatencyDuration<=userConfig.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const defaultsCopy=deepCpy(defaultConfig),deprecatedSettings=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((type=>{const policyName=`${"level"===type?"playlist":type}LoadPolicy`,policyNotSet=void 0===userConfig[policyName],report=[];deprecatedSettings.forEach((setting=>{const deprecatedSetting=`${type}Loading${setting}`,value=userConfig[deprecatedSetting];if(void 0!==value&&policyNotSet){report.push(deprecatedSetting);const settings=defaultsCopy[policyName].default;switch(userConfig[policyName]={default:settings},setting){case"TimeOut":settings.maxLoadTimeMs=value,settings.maxTimeToFirstByteMs=value;break;case"MaxRetry":settings.errorRetry.maxNumRetry=value,settings.timeoutRetry.maxNumRetry=value;break;case"RetryDelay":settings.errorRetry.retryDelayMs=value,settings.timeoutRetry.retryDelayMs=value;break;case"MaxRetryTimeout":settings.errorRetry.maxRetryDelayMs=value,settings.timeoutRetry.maxRetryDelayMs=value}}})),report.length&&logger.warn(`hls.js config: "${report.join('", "')}" setting(s) are deprecated, use "${policyName}": ${JSON.stringify(userConfig[policyName])}`)})),_objectSpread2(_objectSpread2({},defaultsCopy),userConfig)}(Hls.DefaultConfig,userConfig);this.userConfig=userConfig,config.progressive&&enableStreamingMode(config);const{abrController:ConfigAbrController,bufferController:ConfigBufferController,capLevelController:ConfigCapLevelController,errorController:ConfigErrorController,fpsController:ConfigFpsController}=config,errorController=new ConfigErrorController(this),abrController=this.abrController=new ConfigAbrController(this),bufferController=this.bufferController=new ConfigBufferController(this),capLevelController=this.capLevelController=new ConfigCapLevelController(this),fpsController=new ConfigFpsController(this),playListLoader=new PlaylistLoader(this),id3TrackController=new ID3TrackController(this),ConfigContentSteeringController=config.contentSteeringController,contentSteering=ConfigContentSteeringController?new ConfigContentSteeringController(this):null,levelController=this.levelController=new LevelController(this,contentSteering),fragmentTracker=new FragmentTracker(this),keyLoader=new KeyLoader(this.config),streamController=this.streamController=new StreamController(this,fragmentTracker,keyLoader);capLevelController.setStreamController(streamController),fpsController.setStreamController(streamController);const networkControllers=[playListLoader,levelController,streamController];contentSteering&&networkControllers.splice(1,0,contentSteering),this.networkControllers=networkControllers;const coreComponents=[abrController,bufferController,capLevelController,fpsController,id3TrackController,fragmentTracker];this.audioTrackController=this.createController(config.audioTrackController,networkControllers);const AudioStreamControllerClass=config.audioStreamController;AudioStreamControllerClass&&networkControllers.push(new AudioStreamControllerClass(this,fragmentTracker,keyLoader)),this.subtitleTrackController=this.createController(config.subtitleTrackController,networkControllers);const SubtitleStreamControllerClass=config.subtitleStreamController;SubtitleStreamControllerClass&&networkControllers.push(new SubtitleStreamControllerClass(this,fragmentTracker,keyLoader)),this.createController(config.timelineController,coreComponents),keyLoader.emeController=this.emeController=this.createController(config.emeController,coreComponents),this.cmcdController=this.createController(config.cmcdController,coreComponents),this.latencyController=this.createController(LatencyController,coreComponents),this.coreComponents=coreComponents,networkControllers.push(errorController);const onErrorOut=errorController.onErrorOut;"function"==typeof onErrorOut&&this.on(Events.ERROR,onErrorOut,errorController)}createController(ControllerClass,components){if(ControllerClass){const controllerInstance=new ControllerClass(this);return components&&components.push(controllerInstance),controllerInstance}return null}on(event,listener,context=this){this._emitter.on(event,listener,context)}once(event,listener,context=this){this._emitter.once(event,listener,context)}removeAllListeners(event){this._emitter.removeAllListeners(event)}off(event,listener,context=this,once){this._emitter.off(event,listener,context,once)}listeners(event){return this._emitter.listeners(event)}emit(event,name,eventObject){return this._emitter.emit(event,name,eventObject)}trigger(event,eventObject){if(this.config.debug)return this.emit(event,event,eventObject);try{return this.emit(event,event,eventObject)}catch(error){if(logger.error("An internal error happened while handling event "+event+'. Error message: "'+error.message+'". Here is a stacktrace:',error),!this.triggeringException){this.triggeringException=!0;const fatal=event===Events.ERROR;this.trigger(Events.ERROR,{type:ErrorTypes.OTHER_ERROR,details:ErrorDetails.INTERNAL_EXCEPTION,fatal,event,error}),this.triggeringException=!1}}return!1}listenerCount(event){return this._emitter.listenerCount(event)}destroy(){logger.log("destroy"),this.trigger(Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((component=>component.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((component=>component.destroy())),this.coreComponents.length=0;const config=this.config;config.xhrSetup=config.fetchSetup=void 0,this.userConfig=null}attachMedia(media){logger.log("attachMedia"),this._media=media,this.trigger(Events.MEDIA_ATTACHING,{media})}detachMedia(){logger.log("detachMedia"),this.trigger(Events.MEDIA_DETACHING,void 0),this._media=null}loadSource(url){this.stopLoad();const media=this.media,loadedSource=this.url,loadingSource=this.url=urlToolkitExports.buildAbsoluteURL(self.location.href,url,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,logger.log(`loadSource:${loadingSource}`),media&&loadedSource&&(loadedSource!==loadingSource||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(media)),this.trigger(Events.MANIFEST_LOADING,{url})}startLoad(startPosition=-1){logger.log(`startLoad(${startPosition})`),this.started=!0,this.networkControllers.forEach((controller=>{controller.startLoad(startPosition)}))}stopLoad(){logger.log("stopLoad"),this.started=!1,this.networkControllers.forEach((controller=>{controller.stopLoad()}))}resumeBuffering(){this.started&&this.networkControllers.forEach((controller=>{"fragmentLoader"in controller&&controller.startLoad(-1)}))}pauseBuffering(){this.networkControllers.forEach((controller=>{"fragmentLoader"in controller&&controller.stopLoad()}))}swapAudioCodec(){logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){logger.log("recoverMediaError");const media=this._media;this.detachMedia(),media&&this.attachMedia(media)}removeLevel(levelIndex){this.levelController.removeLevel(levelIndex)}get levels(){const levels=this.levelController.levels;return levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(newLevel){logger.log(`set currentLevel:${newLevel}`),this.levelController.manualLevel=newLevel,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(newLevel){logger.log(`set nextLevel:${newLevel}`),this.levelController.manualLevel=newLevel,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(newLevel){logger.log(`set loadLevel:${newLevel}`),this.levelController.manualLevel=newLevel}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(level){this.levelController.nextLoadLevel=level}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(newLevel){logger.log(`set firstLevel:${newLevel}`),this.levelController.firstLevel=newLevel}get startLevel(){const startLevel=this.levelController.startLevel;return-1===startLevel&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:startLevel}set startLevel(newLevel){logger.log(`set startLevel:${newLevel}`),-1!==newLevel&&(newLevel=Math.max(newLevel,this.minAutoLevel)),this.levelController.startLevel=newLevel}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(shouldStartCapping){const newCapLevelToPlayerSize=!!shouldStartCapping;newCapLevelToPlayerSize!==this.config.capLevelToPlayerSize&&(newCapLevelToPlayerSize?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=newCapLevelToPlayerSize)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator}=this.abrController;return bwEstimator?bwEstimator.getEstimate():NaN}set bandwidthEstimate(abrEwmaDefaultEstimate){this.abrController.resetEstimator(abrEwmaDefaultEstimate)}get ttfbEstimate(){const{bwEstimator}=this.abrController;return bwEstimator?bwEstimator.getEstimateTTFB():NaN}set autoLevelCapping(newLevel){this._autoLevelCapping!==newLevel&&(logger.log(`set autoLevelCapping:${newLevel}`),this._autoLevelCapping=newLevel,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(value){(function isHdcpLevel(value){return HdcpLevels.indexOf(value)>-1})(value)&&this._maxHdcpLevel!==value&&(this._maxHdcpLevel=value,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels,config:{minAutoBitrate}}=this;if(!levels)return 0;const len=levels.length;for(let i=0;i<len;i++)if(levels[i].maxBitrate>=minAutoBitrate)return i;return 0}get maxAutoLevel(){const{levels,autoLevelCapping,maxHdcpLevel}=this;let maxAutoLevel;if(maxAutoLevel=-1===autoLevelCapping&&null!=levels&&levels.length?levels.length-1:autoLevelCapping,maxHdcpLevel)for(let i=maxAutoLevel;i--;){const hdcpLevel=levels[i].attrs["HDCP-LEVEL"];if(hdcpLevel&&hdcpLevel<=maxHdcpLevel)return i}return maxAutoLevel}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(nextLevel){this.abrController.nextAutoLevel=nextLevel}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(audioOption){var _this$audioTrackContr;return null==(_this$audioTrackContr=this.audioTrackController)?void 0:_this$audioTrackContr.setAudioOption(audioOption)}setSubtitleOption(subtitleOption){var _this$subtitleTrackCo;return null==(_this$subtitleTrackCo=this.subtitleTrackController)||_this$subtitleTrackCo.setSubtitleOption(subtitleOption),null}get allAudioTracks(){const audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.allAudioTracks:[]}get audioTracks(){const audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTracks:[]}get audioTrack(){const audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTrack:-1}set audioTrack(audioTrackId){const audioTrackController=this.audioTrackController;audioTrackController&&(audioTrackController.audioTrack=audioTrackId)}get allSubtitleTracks(){const subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.allSubtitleTracks:[]}get subtitleTracks(){const subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTracks:[]}get subtitleTrack(){const subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(subtitleTrackId){const subtitleTrackController=this.subtitleTrackController;subtitleTrackController&&(subtitleTrackController.subtitleTrack=subtitleTrackId)}get subtitleDisplay(){const subtitleTrackController=this.subtitleTrackController;return!!subtitleTrackController&&subtitleTrackController.subtitleDisplay}set subtitleDisplay(value){const subtitleTrackController=this.subtitleTrackController;subtitleTrackController&&(subtitleTrackController.subtitleDisplay=value)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(mode){this.config.lowLatencyMode=mode}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}Hls.defaultConfig=void 0},"../../node_modules/htmlparser2/lib/esm/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{DefaultHandler:()=>DomHandler,DomHandler:()=>DomHandler,DomUtils:()=>domutils_lib_esm_namespaceObject,ElementType:()=>esm_namespaceObject,Parser:()=>Parser,Tokenizer:()=>Tokenizer,createDomStream:()=>createDomStream,getFeed:()=>getFeed,parseDOM:()=>parseDOM,parseDocument:()=>parseDocument,parseFeed:()=>parseFeed});var esm_namespaceObject={};__webpack_require__.r(esm_namespaceObject),__webpack_require__.d(esm_namespaceObject,{CDATA:()=>CDATA,Comment:()=>Comment,Directive:()=>Directive,Doctype:()=>Doctype,ElementType:()=>ElementType,Root:()=>Root,Script:()=>Script,Style:()=>Style,Tag:()=>Tag,Text:()=>Text,isTag:()=>isTag});var domutils_lib_esm_namespaceObject={};__webpack_require__.r(domutils_lib_esm_namespaceObject),__webpack_require__.d(domutils_lib_esm_namespaceObject,{DocumentPosition:()=>DocumentPosition,append:()=>append,appendChild:()=>appendChild,compareDocumentPosition:()=>compareDocumentPosition,existsOne:()=>existsOne,filter:()=>filter,find:()=>find,findAll:()=>findAll,findOne:()=>findOne,findOneChild:()=>findOneChild,getAttributeValue:()=>getAttributeValue,getChildren:()=>getChildren,getElementById:()=>getElementById,getElements:()=>getElements,getElementsByTagName:()=>getElementsByTagName,getElementsByTagType:()=>getElementsByTagType,getFeed:()=>getFeed,getInnerHTML:()=>getInnerHTML,getName:()=>getName,getOuterHTML:()=>getOuterHTML,getParent:()=>getParent,getSiblings:()=>getSiblings,getText:()=>getText,hasAttrib:()=>hasAttrib,hasChildren:()=>hasChildren,innerText:()=>innerText,isCDATA:()=>isCDATA,isComment:()=>isComment,isDocument:()=>isDocument,isTag:()=>node_isTag,isText:()=>isText,nextElementSibling:()=>nextElementSibling,prepend:()=>prepend,prependChild:()=>prependChild,prevElementSibling:()=>prevElementSibling,removeElement:()=>removeElement,removeSubsets:()=>removeSubsets,replaceElement:()=>replaceElement,testElement:()=>testElement,textContent:()=>textContent,uniqueSort:()=>uniqueSort});const decode_data_html=new Uint16Array('<\0\0\0\0\0\0EMabcfglmnoprstu\\bfmsligP&cutereve;iyx}rc;r;ravepha;acr;d;gpon;f;plyFunction;ingcsr;ign;ildemlaceforsucrkslash;;ed;y;crtause;noullis;a;r;pf;eve;cmpeq;HOacdefhilorsucy;PYcpyute;;italDifferentialD;leys;aeioron;dilrc;nint;ot;dnilla;terDot;i;rcleDMPTot;inus;lus;imes;ocskwiseContourIntegral;eCurlyDQoubleQuote;uote;lnpuon;e;gitruent;nt;ourIntegral;fr;oduct;nterClockwiseContourIntegral;oss;cr;p;Cap;DJSZacefios;otrahd;cy;cy;cy;grsger;r;hv;ayron;;l;ta;r;afcmriticalADGTcute;o;bleAcute;rave;ilde;ond;ferentialD;\0\0\0\0f;;DEot;qual;bleCDLRUVontourIntegrao\0\0nArrow;eoftARTrrow;ightArrow;engLReftARrrow;ightArrow;ightArrow;ightATrrow;ee;p\0\0rrow;ownArrow;erticalBar;nABLRTarrow;BUar;pArrow;reve;eft\0\0ightVector;eeVector;ector;Bar;ight\0eeVector;ector;Bar;ee;Arrow;ctr;rok;NTacdfglmopqstuxG;Hcuteaiyron;rc;ot;r;raveement;apcr;ty\0\0mallSquare;erySmallSquare;gpon;f;silon;uail;Tilde;librium;cir;m;a;mlipsts;onentialE;cfiosy;r;lled\0\0mallSquare;erySmallSquare;\0\0\0f;All;riertrf;cJTabcdfgorstcy;>mma;d;reve;eiydil;rc;;ot;r;;pf;eaterEFGLSTqual;Less;ullEqual;reater;ess;lantEqual;ilde;cr;;AacfiosuRDcy;ctek;;irc;r;lbertSpace;\0f;izontalLine;ctrok;mpownHumqual;EJOacdfgmnostucy;lig;cy;cuteiyrc;ot;r;rave;apcgr;inaryI;lie\0;egrral;section;isibleCTomma;imes;gpton;f;a;cr;ilde;\0cy;lcfosuiyrc;;r;pf;\0r;rcy;kcy;HJacfoscy;cy;ppa;eydil;;r;pf;cr;JTaceflmostcy;<cmnprute;bda;g;lacetrf;r;aeyron;dil;;fstACDFRTUVarnrgleBracket;row;BRar;ightArrow;eiling;o\0bleBracket;n\0eeVector;ector;Bar;loor;ightAVrrow;ector;ere;AVrrow;ector;iangle;BEar;qual;pDTVownVector;eeVector;ector;Bar;ector;Bar;ightsEFGLSTqualGreater;ullEqual;reater;ess;lantEqual;ilde;r;;eftarrow;idot;npwgLRlreftARrrow;ightArrow;ightArrow;eftarightightf;erLReftArrow;ightArrow;cht;rok;;acefiosup;y;dliumSpace;lintrf;r;nusPlus;pf;c;Jacefostucy;cute;aeyron;dil;;gswativeMTVediumSpace;hicneryThitedGLreaterGreateessLesLine;r;Bnptreak;BreakingSpace;f;;CDEGHLNPRSTVoungruent;pCap;oubleVerticalBar;lqxement;ual;Tilde;ists;reater;EFGLSTqual;ullEqual;reater;ess;lantEqual;ilde;umpownHump;qual;efstTriangle;BEar;qual;s;EGLSTqual;reater;ess;lantEqual;ilde;estedGLreaterGreater;essLess;recedes;ESqual;lantEqual;eiverseElement;ghtTriangle;BEar;qual;quuareSubpset;Equal;erset;Equal;bcpset;Equal;ceeds;ESTqual;lantEqual;ilde;erset;Equal;ilde;EFTqual;ullEqual;ilde;erticalBar;cr;ilde;Eacdfgmoprstuvlig;cuteiyrc;blac;r;raveaeicr;ga;cron;pf;enCurlyDQoubleQuote;uote;;clr;ashidees;mlerBParr;acek;et;arenthesis;acfhilorsrtialD;y;r;i;;usMinus;ipncareplanf;;eiocedes;ESTqual;lantEqual;ilde;me;dpuct;ortion;al;cir;;UfosOT"r;pf;cr;BEacefhiorsuarr;Gcnrute;g;r;tl;aeyron;dil;;;verseEUlqement;uilibrium;pEquilibrium;ro;ghtACDFTUVanrgleBracket;row;BLar;eftArrow;eiling;o\0bleBracket;n\0eeVector;ector;Bar;loor;ere;AVrrow;ector;iangle;BEar;qual;pDTVownVector;eeVector;ector;Bar;ector;Bar;puf;ndImplies;ightarrow;chr;;leDelayed;HOacfhimoqstuCcHcy;y;FTcy;cute;;aeiyron;dil;rc;;r;ortDLRUownArroweftArrowightArrowpArrow;gma;allCircle;pf;\0\0t;are;ISUntersection;ubpset;Equal;erset;Equal;nion;cr;ar;bcmp;set;Equal;cheeds;ESTqual;lantEqual;ilde;Th;;esrset;Equal;etHRSacfhiorsORNADE;Hccy;y;bu;;aeyron;dil;;r;ei\0efore;a;cnkSpace;Space;lde;EFTqual;ullEqual;ilde;pf;ipleDot;ctr;rok;\0\0\0\0\0\0\0cruter;ocir;r\0y;ve;iyrc;blac;r;raveacr;dierBParr;acek;et;arenthesis;on;Plus;gpon;f;ADETadpsrrow;BDar;ownArrow;ownArrow;quilibrium;ee;Arrow;ownerLReftArrow;ightArrow;i;lon;ing;cr;ilde;mlDbcdefosvash;ar;y;ash;l;er;btyar;;icalBLSTar;ine;eparator;ilde;ThinSpace;r;pf;cr;dash;cefosirc;dge;r;pf;cr;fiosr;;pf;cr;AIUacfosucy;cy;cy;cuteiyrc;;r;pf;cr;ml;Hacdefoscy;cute;ayron;;ot;\0oWidta;r;pf;cr;\0\0\0\0\0\0\0cutereve;;Ediuy;;rcte;lig;r;raveepfpsym;ha;apcclr;g;\0\0;adsvnd;;lope;;;elmrsz;esd;a;;;;;;;;t;vb;d;pth;arr;gpon;f;;Eaeiop;cir;;d;s;rox;eingctyr;;mp;eildemlcioninnt;Nabcdefiklnoprsuot;crkcepsong;psilon;rime;im;eq;ee;ed;gerk;tbrk;oy;quo;cmprtaus;eptyv;snoahw;;een;r;gcostuvwaiurc;pdptot;lus;imes;\0\0cup;ar;riangleduown;p;plus;earow;akocnklstozenge;riangle;dlrown;eft;ight;k;\0\0;;4;ck;eo;q=uiv;t;ptwxf;;tomtie;DHUVbdhmptuvLRlr;;;;;DUdu;;;;LRlr;;;;;HLRhlr;;;;;;ox;LRlr;;;;;DUdu;;;;inus;lus;imes;LRlr;;;;;HLRhlr;;;;;;evbarceior;mi;m;el;bh;sub;l;etp;Ee;;q\0\0\0\0\0\0\0\0\0\0cprute;;abcdsnd;rcup;aup;p;ot;;eot;aeiu\0s;on;dilrc;ps;sm;ot;dmnilptyv;t;err;ceiy;ck;mark;r;Ecefms;;elq;e\0\0rrowlreft;ight;RSacd;st;irc;ash;nint;id;cir;ubs;uit\0on;e;q\0\0a;t;;flemxente\0;dot;nfry;o;sr;aorr;ss;cur;bp;e;;e;dot;delprvwarrlr;;\0\0r;c;arr;p;;bcdosrcap;aup;p;ot;r;;alrvrr;m;yevwq\0\0reuee;edge;enearrowlreftightecioninnt;lcty;AHabcdefhijlorstuwzrar;glrsger;eth;h;varow;aayron;;;aogrr;tseq;glmta;ptyv;irsht;;arlraegsvm;osnd;suit;amma;in;;iode;ontimes;ncy;c\0\0rn;op;lptuwlar;f;;empsq;dot;inus;lus;quare;blebarwedgnadhownarrowarpoonlrefighkaro\0\0rn;op;cotry;;l;rok;drot;i;fahraangle;ciy;grarr;DacdefglmnopqrstuxDoocsuteter;aioyron;r;clon;;ot;Drot;;;rsave;dot;;ilsnters;;;dot;apscr;ty;svetp1;;;gs;p;gpon;f;alsr;sl;us;i;lvon;csuviorc\0\0antgltressaeils;st;v;DD;parsl;Daot;rr;cdir;oah;mrlo;cipl;seoctationential\0\0\0\0\0\0\0llingdotsey;male;ilrlig;\0\0g;ig;;lig;lig;fjaltt;ig;ns;of;\0f;ak;v;artint;aocs\0\0;;;;\0;;\0\0;;5;\0;;8;l;wn;cr;Eabcdefgijlnorstv;l;cmpute;ma;d;reve;iyrc;;ot;;lqs;qslan;cdlc;ot;o;l;;es;r;;gmel;cy;;Eaj;;;Eaes;p;prox;q;qim;pf;cir;m;el;;>;cdlqrci;r;ot;Par;uest;adels\0pror;qlqlesienrtneqq;Aabcefkosyrilmrrsfildrcy;;cwir;;ar;irc;alrrts;uitlip;con;r;sewarow;arow;amoprrr;tht;klreftarrow;ightarrow;f;bar;cltr;asrok;bpull;hen\0\0\0\0\0\0cute;iyrc;cxy;clfr;rave;inoinnt;t;fin;ta;lig;aopcgtr;elpinarh;f;ed;;cfotare;in;tie;do;celpal;grerarhk;rod;cgpty;on;f;a;uestcir;n;Edsv;ot;;v;;ilde;\0cy;lcfmosuiyrc;;r;ath;pf;\0r;rcy;kcy;acfghjosppa;v;eydil;;r;reen;cy;cy;pf;cr;ABEHabcdefghjlmnoprstuvartrail;arr;;g;ar;\0\0\0\0\0\0\0\0\0ute;mptyv;rabda;g;dl;;uor;bfhlpst;fs;s;p;l;im;l;;aeil;;s;abrrr;rk;akcek;;es;ldu;;aeuyron;diil;;cqrsa;uo;rduhar;shar;h;;fgqstahlrtrrow;taarpoonduownpeftarrows;ightahsrrow;sarpoonquigarrohreetimes;;qslan;cdgsc;ot;o;r;;es;adegspproot;qgqgtiilrsht;;;E;rdu;l;lk;cy;;achtrorneard;ri;iodot;ust;acheEaes;p;prox;q;qim;abnoptwznrg;r;rglmreftarightapsto;ightparrowlrefight;aflr;;us;imes;st;;efngear;lt;achmtrornear;d;;ri;achiqtquo;r;m;eg;;buo;r;rok;<;cdhilqrci;r;remes;arr;uest;Piar;;efrdushar;har;enrtneqq;DacdefhilnopsuDot;clprret;;ese;sto;dluowefker;oymma;;ash;asuredangler;o;cdnro;acdsir;otus;bd;u;p;dpels;f;ctr;pos;lmtimap;GLRVabcdefghijlmoprstuvwgt;;veltftarrrow;ightarrow;;;vightarrow;Ddash;ash;bcnptlaute;g;;Eiop;d;s;rour;al;s\0pmp;eaeouy\0;on;dil;ng;dot;p;;ash;;Aadqsxrr;rhrk;;oot;uieiar;ist;sr;Eest;qs;qslani;rAaprrr;ar;;sv;d;cy;AEadestr;rr;r;;fqstarrroightarro;qslan;si;ri;eiptf;;inn;Edv;ot;;;i;v;;aorr;astllel;;lint;;ceu;c;eAaitrrr;cw;;ghtarrowri;echimpqu;ceru;ort\0\0arm;e;qsubpbcp;Ees;et;eq;qc;e;Ees;et;eq;qgilrldeianglelreft;eight;e;m;esro;p;DHadgilrsash;arr;p;ash;et;;>nfin;Aetrr;;;r<ie;Atrr;rie;im;Aanrr;rhrk;;oear;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0csuteiyr;c;abioslac;v;old;lig;crir;;\0\0\0n;ave;bmar;acitrirr;oss;n;aeicr;ga;cdnron;;pf;aelr;rp;;adiosvr;efmr;ofgof;r;lope;;cloashl;idees;as;mlbar;\0\0\0\0\0\0\0\0\0r;ast;lle\0\0m;;y;rcimptnt;od;il;enk;r;imo;v;mane;;tvchfork;aunckk;h;s;abcdemstcir;ir;ou;;nim;wo;ipuntint;f;nd;Eaceinosu;p;u;c;acenspprourlyeaespprox;qq;im;ime;sEasdfpalslar;ine;urf;;trel;cir;;ncsp;fiopsur;pf;rime;cr;aeoteirnionnt;st;eABHabcdefhilmnoprstuxartrail;arar;cdenqrteu;te;imptyv;g;del;;uor;abcfhlpstwp;;fs;;s;l;im;l;;aiil;o;nalabrrrk;akcek;;es;ldu;;aeuyron;diil;;clqsa;dhar;uo;rh;acgl;ipsnart;ilrsht;;aordu;l;;v;gnshtahlrstrrow;taarpoonduowpeftahrrowarpoonightarrows;quigarrohreetimes;g;ingdotseahmra;oust;achemid;abptnrg;r;raflr;;us;imes;apr;gt;olint;arachqquo;r;buo;rhirremes;i;efltri;luhar;;\0\0\0\0\0\0\0cute;qu;Eaceinpsy;\0;on;u;dil;rc;Eas;p;im;olint;i;ot;be;Aacmstxrr;rhr;oti;war;minnut;r;oacoyrp;hycy;;rt\0\0iaragmma;fv;;deglnprot;;q;E;;E;e;lus;arr;araeitlslsetmhp;parsl;dle;;e;s;flptcy;;b;ar;f;adres;uitcsuaup;s;p;s;ubp;eset;e;eset;e;afrarcemtr;tmiararr;fanighteppsilohsbcmnp;Edemnprs;ot;;dot;ult;Ee;;lus;arr;eiut;enq;qeq;qm;bp;;c;acenspprourlyeaespproqg;123;Edehlmnps;ost;ub;;dot;soul;b;arr;ult;Ee;;lus;eiut;enq;qeq;qm;bp;;Aanrr;rhr;owar;lig\0\0\0\0\0\0\0\0\0\0\0\0get;;raeyron;dil;;lrec;r;eiko\0e4fa;svym;cnkaspproimsasrnes;bd;ar;;eps;bcfot;ir;;ork;rime;aipdadempstngle;dlqrowneft;e;ight;eot;inus;lus;b;ime;ezium;chtry;;cy;rok;ioxheadlreftarroightarrowAHabcdfghlmoprstuwrar;cruter\0y;ve;iyrc;abhrlac;airsht;;raverlrlk;ct\0\0rn;erop;ri;alcr;gpon;f;adhlsuownarpoonlrefighi;hlonparrows;cit\0\0rn;erop;ng;ri;cr;dirot;lde;i;famrlangle;ABDacdeflnoprszrar;v;asnrgrt;eknprstappothinhirop;hiugmbpsetneq;q;setneq;q;hretianglelreftighty;ashelr;bear;q;lip;btar;trsubppf;rotrcur;bpnEenEeigzag;cefoprsirc;dibgar;e;q;erp;r;pf;;eatcr;\0\0\0\0\0\0\0trr;Aarr;Aarrais;dptfl;imAarrcqr;ptracefiosucuyte;iyrc;;nr;cy;pf;cr;cmy;lacdefhioswcute;ayron;;ot;ettra;r;cy;grarr;pf;cr;jn;j;'.split("").map((c=>c.charCodeAt(0)))),decode_data_xml=new Uint16Array("aglq\t\0\0p;os;t;t;uot;".split("").map((c=>c.charCodeAt(0))));var _a;const decodeMap=new Map([[0,65533],[128,8364],[130,8218],[131,402],[132,8222],[133,8230],[134,8224],[135,8225],[136,710],[137,8240],[138,352],[139,8249],[140,338],[142,381],[145,8216],[146,8217],[147,8220],[148,8221],[149,8226],[150,8211],[151,8212],[152,732],[153,8482],[154,353],[155,8250],[156,339],[158,382],[159,376]]),fromCodePoint=null!==(_a=String.fromCodePoint)&&void 0!==_a?_a:function(codePoint){let output="";return codePoint>65535&&(codePoint-=65536,output+=String.fromCharCode(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),output+=String.fromCharCode(codePoint),output};function replaceCodePoint(codePoint){var _a;return codePoint>=55296&&codePoint<=57343||codePoint>1114111?65533:null!==(_a=decodeMap.get(codePoint))&&void 0!==_a?_a:codePoint}var CharCodes;!function(CharCodes){CharCodes[CharCodes.NUM=35]="NUM",CharCodes[CharCodes.SEMI=59]="SEMI",CharCodes[CharCodes.EQUALS=61]="EQUALS",CharCodes[CharCodes.ZERO=48]="ZERO",CharCodes[CharCodes.NINE=57]="NINE",CharCodes[CharCodes.LOWER_A=97]="LOWER_A",CharCodes[CharCodes.LOWER_F=102]="LOWER_F",CharCodes[CharCodes.LOWER_X=120]="LOWER_X",CharCodes[CharCodes.LOWER_Z=122]="LOWER_Z",CharCodes[CharCodes.UPPER_A=65]="UPPER_A",CharCodes[CharCodes.UPPER_F=70]="UPPER_F",CharCodes[CharCodes.UPPER_Z=90]="UPPER_Z"}(CharCodes||(CharCodes={}));var BinTrieFlags,EntityDecoderState,decode_DecodingMode;function isNumber(code){return code>=CharCodes.ZERO&&code<=CharCodes.NINE}function isEntityInAttributeInvalidEnd(code){return code===CharCodes.EQUALS||function isAsciiAlphaNumeric(code){return code>=CharCodes.UPPER_A&&code<=CharCodes.UPPER_Z||code>=CharCodes.LOWER_A&&code<=CharCodes.LOWER_Z||isNumber(code)}(code)}!function(BinTrieFlags){BinTrieFlags[BinTrieFlags.VALUE_LENGTH=49152]="VALUE_LENGTH",BinTrieFlags[BinTrieFlags.BRANCH_LENGTH=16256]="BRANCH_LENGTH",BinTrieFlags[BinTrieFlags.JUMP_TABLE=127]="JUMP_TABLE"}(BinTrieFlags||(BinTrieFlags={})),function(EntityDecoderState){EntityDecoderState[EntityDecoderState.EntityStart=0]="EntityStart",EntityDecoderState[EntityDecoderState.NumericStart=1]="NumericStart",EntityDecoderState[EntityDecoderState.NumericDecimal=2]="NumericDecimal",EntityDecoderState[EntityDecoderState.NumericHex=3]="NumericHex",EntityDecoderState[EntityDecoderState.NamedEntity=4]="NamedEntity"}(EntityDecoderState||(EntityDecoderState={})),function(DecodingMode){DecodingMode[DecodingMode.Legacy=0]="Legacy",DecodingMode[DecodingMode.Strict=1]="Strict",DecodingMode[DecodingMode.Attribute=2]="Attribute"}(decode_DecodingMode||(decode_DecodingMode={}));class EntityDecoder{constructor(decodeTree,emitCodePoint,errors){this.decodeTree=decodeTree,this.emitCodePoint=emitCodePoint,this.errors=errors,this.state=EntityDecoderState.EntityStart,this.consumed=1,this.result=0,this.treeIndex=0,this.excess=1,this.decodeMode=decode_DecodingMode.Strict}startEntity(decodeMode){this.decodeMode=decodeMode,this.state=EntityDecoderState.EntityStart,this.result=0,this.treeIndex=0,this.excess=1,this.consumed=1}write(str,offset){switch(this.state){case EntityDecoderState.EntityStart:return str.charCodeAt(offset)===CharCodes.NUM?(this.state=EntityDecoderState.NumericStart,this.consumed+=1,this.stateNumericStart(str,offset+1)):(this.state=EntityDecoderState.NamedEntity,this.stateNamedEntity(str,offset));case EntityDecoderState.NumericStart:return this.stateNumericStart(str,offset);case EntityDecoderState.NumericDecimal:return this.stateNumericDecimal(str,offset);case EntityDecoderState.NumericHex:return this.stateNumericHex(str,offset);case EntityDecoderState.NamedEntity:return this.stateNamedEntity(str,offset)}}stateNumericStart(str,offset){return offset>=str.length?-1:(32|str.charCodeAt(offset))===CharCodes.LOWER_X?(this.state=EntityDecoderState.NumericHex,this.consumed+=1,this.stateNumericHex(str,offset+1)):(this.state=EntityDecoderState.NumericDecimal,this.stateNumericDecimal(str,offset))}addToNumericResult(str,start,end,base){if(start!==end){const digitCount=end-start;this.result=this.result*Math.pow(base,digitCount)+parseInt(str.substr(start,digitCount),base),this.consumed+=digitCount}}stateNumericHex(str,offset){const startIdx=offset;for(;offset<str.length;){const char=str.charCodeAt(offset);if(!(isNumber(char)||(code=char,code>=CharCodes.UPPER_A&&code<=CharCodes.UPPER_F||code>=CharCodes.LOWER_A&&code<=CharCodes.LOWER_F)))return this.addToNumericResult(str,startIdx,offset,16),this.emitNumericEntity(char,3);offset+=1}var code;return this.addToNumericResult(str,startIdx,offset,16),-1}stateNumericDecimal(str,offset){const startIdx=offset;for(;offset<str.length;){const char=str.charCodeAt(offset);if(!isNumber(char))return this.addToNumericResult(str,startIdx,offset,10),this.emitNumericEntity(char,2);offset+=1}return this.addToNumericResult(str,startIdx,offset,10),-1}emitNumericEntity(lastCp,expectedLength){var _a;if(this.consumed<=expectedLength)return null===(_a=this.errors)||void 0===_a||_a.absenceOfDigitsInNumericCharacterReference(this.consumed),0;if(lastCp===CharCodes.SEMI)this.consumed+=1;else if(this.decodeMode===decode_DecodingMode.Strict)return 0;return this.emitCodePoint(replaceCodePoint(this.result),this.consumed),this.errors&&(lastCp!==CharCodes.SEMI&&this.errors.missingSemicolonAfterCharacterReference(),this.errors.validateNumericCharacterReference(this.result)),this.consumed}stateNamedEntity(str,offset){const{decodeTree}=this;let current=decodeTree[this.treeIndex],valueLength=(current&BinTrieFlags.VALUE_LENGTH)>>14;for(;offset<str.length;offset++,this.excess++){const char=str.charCodeAt(offset);if(this.treeIndex=determineBranch(decodeTree,current,this.treeIndex+Math.max(1,valueLength),char),this.treeIndex<0)return 0===this.result||this.decodeMode===decode_DecodingMode.Attribute&&(0===valueLength||isEntityInAttributeInvalidEnd(char))?0:this.emitNotTerminatedNamedEntity();if(current=decodeTree[this.treeIndex],valueLength=(current&BinTrieFlags.VALUE_LENGTH)>>14,0!==valueLength){if(char===CharCodes.SEMI)return this.emitNamedEntityData(this.treeIndex,valueLength,this.consumed+this.excess);this.decodeMode!==decode_DecodingMode.Strict&&(this.result=this.treeIndex,this.consumed+=this.excess,this.excess=0)}}return-1}emitNotTerminatedNamedEntity(){var _a;const{result,decodeTree}=this,valueLength=(decodeTree[result]&BinTrieFlags.VALUE_LENGTH)>>14;return this.emitNamedEntityData(result,valueLength,this.consumed),null===(_a=this.errors)||void 0===_a||_a.missingSemicolonAfterCharacterReference(),this.consumed}emitNamedEntityData(result,valueLength,consumed){const{decodeTree}=this;return this.emitCodePoint(1===valueLength?decodeTree[result]&~BinTrieFlags.VALUE_LENGTH:decodeTree[result+1],consumed),3===valueLength&&this.emitCodePoint(decodeTree[result+2],consumed),consumed}end(){var _a;switch(this.state){case EntityDecoderState.NamedEntity:return 0===this.result||this.decodeMode===decode_DecodingMode.Attribute&&this.result!==this.treeIndex?0:this.emitNotTerminatedNamedEntity();case EntityDecoderState.NumericDecimal:return this.emitNumericEntity(0,2);case EntityDecoderState.NumericHex:return this.emitNumericEntity(0,3);case EntityDecoderState.NumericStart:return null===(_a=this.errors)||void 0===_a||_a.absenceOfDigitsInNumericCharacterReference(this.consumed),0;case EntityDecoderState.EntityStart:return 0}}}function getDecoder(decodeTree){let ret="";const decoder=new EntityDecoder(decodeTree,(str=>ret+=fromCodePoint(str)));return function decodeWithTrie(str,decodeMode){let lastIndex=0,offset=0;for(;(offset=str.indexOf("&",offset))>=0;){ret+=str.slice(lastIndex,offset),decoder.startEntity(decodeMode);const len=decoder.write(str,offset+1);if(len<0){lastIndex=offset+decoder.end();break}lastIndex=offset+len,offset=0===len?lastIndex+1:lastIndex}const result=ret+str.slice(lastIndex);return ret="",result}}function determineBranch(decodeTree,current,nodeIdx,char){const branchCount=(current&BinTrieFlags.BRANCH_LENGTH)>>7,jumpOffset=current&BinTrieFlags.JUMP_TABLE;if(0===branchCount)return 0!==jumpOffset&&char===jumpOffset?nodeIdx:-1;if(jumpOffset){const value=char-jumpOffset;return value<0||value>=branchCount?-1:decodeTree[nodeIdx+value]-1}let lo=nodeIdx,hi=lo+branchCount-1;for(;lo<=hi;){const mid=lo+hi>>>1,midVal=decodeTree[mid];if(midVal<char)lo=mid+1;else{if(!(midVal>char))return decodeTree[mid+branchCount];hi=mid-1}}return-1}getDecoder(decode_data_html),getDecoder(decode_data_xml);var Tokenizer_CharCodes,State,QuoteType;function isWhitespace(c){return c===Tokenizer_CharCodes.Space||c===Tokenizer_CharCodes.NewLine||c===Tokenizer_CharCodes.Tab||c===Tokenizer_CharCodes.FormFeed||c===Tokenizer_CharCodes.CarriageReturn}function isEndOfTagSection(c){return c===Tokenizer_CharCodes.Slash||c===Tokenizer_CharCodes.Gt||isWhitespace(c)}function Tokenizer_isNumber(c){return c>=Tokenizer_CharCodes.Zero&&c<=Tokenizer_CharCodes.Nine}!function(CharCodes){CharCodes[CharCodes.Tab=9]="Tab",CharCodes[CharCodes.NewLine=10]="NewLine",CharCodes[CharCodes.FormFeed=12]="FormFeed",CharCodes[CharCodes.CarriageReturn=13]="CarriageReturn",CharCodes[CharCodes.Space=32]="Space",CharCodes[CharCodes.ExclamationMark=33]="ExclamationMark",CharCodes[CharCodes.Number=35]="Number",CharCodes[CharCodes.Amp=38]="Amp",CharCodes[CharCodes.SingleQuote=39]="SingleQuote",CharCodes[CharCodes.DoubleQuote=34]="DoubleQuote",CharCodes[CharCodes.Dash=45]="Dash",CharCodes[CharCodes.Slash=47]="Slash",CharCodes[CharCodes.Zero=48]="Zero",CharCodes[CharCodes.Nine=57]="Nine",CharCodes[CharCodes.Semi=59]="Semi",CharCodes[CharCodes.Lt=60]="Lt",CharCodes[CharCodes.Eq=61]="Eq",CharCodes[CharCodes.Gt=62]="Gt",CharCodes[CharCodes.Questionmark=63]="Questionmark",CharCodes[CharCodes.UpperA=65]="UpperA",CharCodes[CharCodes.LowerA=97]="LowerA",CharCodes[CharCodes.UpperF=70]="UpperF",CharCodes[CharCodes.LowerF=102]="LowerF",CharCodes[CharCodes.UpperZ=90]="UpperZ",CharCodes[CharCodes.LowerZ=122]="LowerZ",CharCodes[CharCodes.LowerX=120]="LowerX",CharCodes[CharCodes.OpeningSquareBracket=91]="OpeningSquareBracket"}(Tokenizer_CharCodes||(Tokenizer_CharCodes={})),function(State){State[State.Text=1]="Text",State[State.BeforeTagName=2]="BeforeTagName",State[State.InTagName=3]="InTagName",State[State.InSelfClosingTag=4]="InSelfClosingTag",State[State.BeforeClosingTagName=5]="BeforeClosingTagName",State[State.InClosingTagName=6]="InClosingTagName",State[State.AfterClosingTagName=7]="AfterClosingTagName",State[State.BeforeAttributeName=8]="BeforeAttributeName",State[State.InAttributeName=9]="InAttributeName",State[State.AfterAttributeName=10]="AfterAttributeName",State[State.BeforeAttributeValue=11]="BeforeAttributeValue",State[State.InAttributeValueDq=12]="InAttributeValueDq",State[State.InAttributeValueSq=13]="InAttributeValueSq",State[State.InAttributeValueNq=14]="InAttributeValueNq",State[State.BeforeDeclaration=15]="BeforeDeclaration",State[State.InDeclaration=16]="InDeclaration",State[State.InProcessingInstruction=17]="InProcessingInstruction",State[State.BeforeComment=18]="BeforeComment",State[State.CDATASequence=19]="CDATASequence",State[State.InSpecialComment=20]="InSpecialComment",State[State.InCommentLike=21]="InCommentLike",State[State.BeforeSpecialS=22]="BeforeSpecialS",State[State.SpecialStartSequence=23]="SpecialStartSequence",State[State.InSpecialTag=24]="InSpecialTag",State[State.BeforeEntity=25]="BeforeEntity",State[State.BeforeNumericEntity=26]="BeforeNumericEntity",State[State.InNamedEntity=27]="InNamedEntity",State[State.InNumericEntity=28]="InNumericEntity",State[State.InHexEntity=29]="InHexEntity"}(State||(State={})),function(QuoteType){QuoteType[QuoteType.NoValue=0]="NoValue",QuoteType[QuoteType.Unquoted=1]="Unquoted",QuoteType[QuoteType.Single=2]="Single",QuoteType[QuoteType.Double=3]="Double"}(QuoteType||(QuoteType={}));const Sequences={Cdata:new Uint8Array([67,68,65,84,65,91]),CdataEnd:new Uint8Array([93,93,62]),CommentEnd:new Uint8Array([45,45,62]),ScriptEnd:new Uint8Array([60,47,115,99,114,105,112,116]),StyleEnd:new Uint8Array([60,47,115,116,121,108,101]),TitleEnd:new Uint8Array([60,47,116,105,116,108,101])};class Tokenizer{constructor({xmlMode=!1,decodeEntities=!0},cbs){this.cbs=cbs,this.state=State.Text,this.buffer="",this.sectionStart=0,this.index=0,this.baseState=State.Text,this.isSpecial=!1,this.running=!0,this.offset=0,this.currentSequence=void 0,this.sequenceIndex=0,this.trieIndex=0,this.trieCurrent=0,this.entityResult=0,this.entityExcess=0,this.xmlMode=xmlMode,this.decodeEntities=decodeEntities,this.entityTrie=xmlMode?decode_data_xml:decode_data_html}reset(){this.state=State.Text,this.buffer="",this.sectionStart=0,this.index=0,this.baseState=State.Text,this.currentSequence=void 0,this.running=!0,this.offset=0}write(chunk){this.offset+=this.buffer.length,this.buffer=chunk,this.parse()}end(){this.running&&this.finish()}pause(){this.running=!1}resume(){this.running=!0,this.index<this.buffer.length+this.offset&&this.parse()}getIndex(){return this.index}getSectionStart(){return this.sectionStart}stateText(c){c===Tokenizer_CharCodes.Lt||!this.decodeEntities&&this.fastForwardTo(Tokenizer_CharCodes.Lt)?(this.index>this.sectionStart&&this.cbs.ontext(this.sectionStart,this.index),this.state=State.BeforeTagName,this.sectionStart=this.index):this.decodeEntities&&c===Tokenizer_CharCodes.Amp&&(this.state=State.BeforeEntity)}stateSpecialStartSequence(c){const isEnd=this.sequenceIndex===this.currentSequence.length;if(isEnd?isEndOfTagSection(c):(32|c)===this.currentSequence[this.sequenceIndex]){if(!isEnd)return void this.sequenceIndex++}else this.isSpecial=!1;this.sequenceIndex=0,this.state=State.InTagName,this.stateInTagName(c)}stateInSpecialTag(c){if(this.sequenceIndex===this.currentSequence.length){if(c===Tokenizer_CharCodes.Gt||isWhitespace(c)){const endOfText=this.index-this.currentSequence.length;if(this.sectionStart<endOfText){const actualIndex=this.index;this.index=endOfText,this.cbs.ontext(this.sectionStart,endOfText),this.index=actualIndex}return this.isSpecial=!1,this.sectionStart=endOfText+2,void this.stateInClosingTagName(c)}this.sequenceIndex=0}(32|c)===this.currentSequence[this.sequenceIndex]?this.sequenceIndex+=1:0===this.sequenceIndex?this.currentSequence===Sequences.TitleEnd?this.decodeEntities&&c===Tokenizer_CharCodes.Amp&&(this.state=State.BeforeEntity):this.fastForwardTo(Tokenizer_CharCodes.Lt)&&(this.sequenceIndex=1):this.sequenceIndex=Number(c===Tokenizer_CharCodes.Lt)}stateCDATASequence(c){c===Sequences.Cdata[this.sequenceIndex]?++this.sequenceIndex===Sequences.Cdata.length&&(this.state=State.InCommentLike,this.currentSequence=Sequences.CdataEnd,this.sequenceIndex=0,this.sectionStart=this.index+1):(this.sequenceIndex=0,this.state=State.InDeclaration,this.stateInDeclaration(c))}fastForwardTo(c){for(;++this.index<this.buffer.length+this.offset;)if(this.buffer.charCodeAt(this.index-this.offset)===c)return!0;return this.index=this.buffer.length+this.offset-1,!1}stateInCommentLike(c){c===this.currentSequence[this.sequenceIndex]?++this.sequenceIndex===this.currentSequence.length&&(this.currentSequence===Sequences.CdataEnd?this.cbs.oncdata(this.sectionStart,this.index,2):this.cbs.oncomment(this.sectionStart,this.index,2),this.sequenceIndex=0,this.sectionStart=this.index+1,this.state=State.Text):0===this.sequenceIndex?this.fastForwardTo(this.currentSequence[0])&&(this.sequenceIndex=1):c!==this.currentSequence[this.sequenceIndex-1]&&(this.sequenceIndex=0)}isTagStartChar(c){return this.xmlMode?!isEndOfTagSection(c):function isASCIIAlpha(c){return c>=Tokenizer_CharCodes.LowerA&&c<=Tokenizer_CharCodes.LowerZ||c>=Tokenizer_CharCodes.UpperA&&c<=Tokenizer_CharCodes.UpperZ}(c)}startSpecial(sequence,offset){this.isSpecial=!0,this.currentSequence=sequence,this.sequenceIndex=offset,this.state=State.SpecialStartSequence}stateBeforeTagName(c){if(c===Tokenizer_CharCodes.ExclamationMark)this.state=State.BeforeDeclaration,this.sectionStart=this.index+1;else if(c===Tokenizer_CharCodes.Questionmark)this.state=State.InProcessingInstruction,this.sectionStart=this.index+1;else if(this.isTagStartChar(c)){const lower=32|c;this.sectionStart=this.index,this.xmlMode||lower!==Sequences.TitleEnd[2]?this.state=this.xmlMode||lower!==Sequences.ScriptEnd[2]?State.InTagName:State.BeforeSpecialS:this.startSpecial(Sequences.TitleEnd,3)}else c===Tokenizer_CharCodes.Slash?this.state=State.BeforeClosingTagName:(this.state=State.Text,this.stateText(c))}stateInTagName(c){isEndOfTagSection(c)&&(this.cbs.onopentagname(this.sectionStart,this.index),this.sectionStart=-1,this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(c))}stateBeforeClosingTagName(c){isWhitespace(c)||(c===Tokenizer_CharCodes.Gt?this.state=State.Text:(this.state=this.isTagStartChar(c)?State.InClosingTagName:State.InSpecialComment,this.sectionStart=this.index))}stateInClosingTagName(c){(c===Tokenizer_CharCodes.Gt||isWhitespace(c))&&(this.cbs.onclosetag(this.sectionStart,this.index),this.sectionStart=-1,this.state=State.AfterClosingTagName,this.stateAfterClosingTagName(c))}stateAfterClosingTagName(c){(c===Tokenizer_CharCodes.Gt||this.fastForwardTo(Tokenizer_CharCodes.Gt))&&(this.state=State.Text,this.baseState=State.Text,this.sectionStart=this.index+1)}stateBeforeAttributeName(c){c===Tokenizer_CharCodes.Gt?(this.cbs.onopentagend(this.index),this.isSpecial?(this.state=State.InSpecialTag,this.sequenceIndex=0):this.state=State.Text,this.baseState=this.state,this.sectionStart=this.index+1):c===Tokenizer_CharCodes.Slash?this.state=State.InSelfClosingTag:isWhitespace(c)||(this.state=State.InAttributeName,this.sectionStart=this.index)}stateInSelfClosingTag(c){c===Tokenizer_CharCodes.Gt?(this.cbs.onselfclosingtag(this.index),this.state=State.Text,this.baseState=State.Text,this.sectionStart=this.index+1,this.isSpecial=!1):isWhitespace(c)||(this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(c))}stateInAttributeName(c){(c===Tokenizer_CharCodes.Eq||isEndOfTagSection(c))&&(this.cbs.onattribname(this.sectionStart,this.index),this.sectionStart=-1,this.state=State.AfterAttributeName,this.stateAfterAttributeName(c))}stateAfterAttributeName(c){c===Tokenizer_CharCodes.Eq?this.state=State.BeforeAttributeValue:c===Tokenizer_CharCodes.Slash||c===Tokenizer_CharCodes.Gt?(this.cbs.onattribend(QuoteType.NoValue,this.index),this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(c)):isWhitespace(c)||(this.cbs.onattribend(QuoteType.NoValue,this.index),this.state=State.InAttributeName,this.sectionStart=this.index)}stateBeforeAttributeValue(c){c===Tokenizer_CharCodes.DoubleQuote?(this.state=State.InAttributeValueDq,this.sectionStart=this.index+1):c===Tokenizer_CharCodes.SingleQuote?(this.state=State.InAttributeValueSq,this.sectionStart=this.index+1):isWhitespace(c)||(this.sectionStart=this.index,this.state=State.InAttributeValueNq,this.stateInAttributeValueNoQuotes(c))}handleInAttributeValue(c,quote){c===quote||!this.decodeEntities&&this.fastForwardTo(quote)?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(quote===Tokenizer_CharCodes.DoubleQuote?QuoteType.Double:QuoteType.Single,this.index),this.state=State.BeforeAttributeName):this.decodeEntities&&c===Tokenizer_CharCodes.Amp&&(this.baseState=this.state,this.state=State.BeforeEntity)}stateInAttributeValueDoubleQuotes(c){this.handleInAttributeValue(c,Tokenizer_CharCodes.DoubleQuote)}stateInAttributeValueSingleQuotes(c){this.handleInAttributeValue(c,Tokenizer_CharCodes.SingleQuote)}stateInAttributeValueNoQuotes(c){isWhitespace(c)||c===Tokenizer_CharCodes.Gt?(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=-1,this.cbs.onattribend(QuoteType.Unquoted,this.index),this.state=State.BeforeAttributeName,this.stateBeforeAttributeName(c)):this.decodeEntities&&c===Tokenizer_CharCodes.Amp&&(this.baseState=this.state,this.state=State.BeforeEntity)}stateBeforeDeclaration(c){c===Tokenizer_CharCodes.OpeningSquareBracket?(this.state=State.CDATASequence,this.sequenceIndex=0):this.state=c===Tokenizer_CharCodes.Dash?State.BeforeComment:State.InDeclaration}stateInDeclaration(c){(c===Tokenizer_CharCodes.Gt||this.fastForwardTo(Tokenizer_CharCodes.Gt))&&(this.cbs.ondeclaration(this.sectionStart,this.index),this.state=State.Text,this.sectionStart=this.index+1)}stateInProcessingInstruction(c){(c===Tokenizer_CharCodes.Gt||this.fastForwardTo(Tokenizer_CharCodes.Gt))&&(this.cbs.onprocessinginstruction(this.sectionStart,this.index),this.state=State.Text,this.sectionStart=this.index+1)}stateBeforeComment(c){c===Tokenizer_CharCodes.Dash?(this.state=State.InCommentLike,this.currentSequence=Sequences.CommentEnd,this.sequenceIndex=2,this.sectionStart=this.index+1):this.state=State.InDeclaration}stateInSpecialComment(c){(c===Tokenizer_CharCodes.Gt||this.fastForwardTo(Tokenizer_CharCodes.Gt))&&(this.cbs.oncomment(this.sectionStart,this.index,0),this.state=State.Text,this.sectionStart=this.index+1)}stateBeforeSpecialS(c){const lower=32|c;lower===Sequences.ScriptEnd[3]?this.startSpecial(Sequences.ScriptEnd,4):lower===Sequences.StyleEnd[3]?this.startSpecial(Sequences.StyleEnd,4):(this.state=State.InTagName,this.stateInTagName(c))}stateBeforeEntity(c){this.entityExcess=1,this.entityResult=0,c===Tokenizer_CharCodes.Number?this.state=State.BeforeNumericEntity:c===Tokenizer_CharCodes.Amp||(this.trieIndex=0,this.trieCurrent=this.entityTrie[0],this.state=State.InNamedEntity,this.stateInNamedEntity(c))}stateInNamedEntity(c){if(this.entityExcess+=1,this.trieIndex=determineBranch(this.entityTrie,this.trieCurrent,this.trieIndex+1,c),this.trieIndex<0)return this.emitNamedEntity(),void this.index--;this.trieCurrent=this.entityTrie[this.trieIndex];const masked=this.trieCurrent&BinTrieFlags.VALUE_LENGTH;if(masked){const valueLength=(masked>>14)-1;if(this.allowLegacyEntity()||c===Tokenizer_CharCodes.Semi){const entityStart=this.index-this.entityExcess+1;entityStart>this.sectionStart&&this.emitPartial(this.sectionStart,entityStart),this.entityResult=this.trieIndex,this.trieIndex+=valueLength,this.entityExcess=0,this.sectionStart=this.index+1,0===valueLength&&this.emitNamedEntity()}else this.trieIndex+=valueLength}}emitNamedEntity(){if(this.state=this.baseState,0===this.entityResult)return;switch((this.entityTrie[this.entityResult]&BinTrieFlags.VALUE_LENGTH)>>14){case 1:this.emitCodePoint(this.entityTrie[this.entityResult]&~BinTrieFlags.VALUE_LENGTH);break;case 2:this.emitCodePoint(this.entityTrie[this.entityResult+1]);break;case 3:this.emitCodePoint(this.entityTrie[this.entityResult+1]),this.emitCodePoint(this.entityTrie[this.entityResult+2])}}stateBeforeNumericEntity(c){(32|c)===Tokenizer_CharCodes.LowerX?(this.entityExcess++,this.state=State.InHexEntity):(this.state=State.InNumericEntity,this.stateInNumericEntity(c))}emitNumericEntity(strict){const entityStart=this.index-this.entityExcess-1;entityStart+2+Number(this.state===State.InHexEntity)!==this.index&&(entityStart>this.sectionStart&&this.emitPartial(this.sectionStart,entityStart),this.sectionStart=this.index+Number(strict),this.emitCodePoint(replaceCodePoint(this.entityResult))),this.state=this.baseState}stateInNumericEntity(c){c===Tokenizer_CharCodes.Semi?this.emitNumericEntity(!0):Tokenizer_isNumber(c)?(this.entityResult=10*this.entityResult+(c-Tokenizer_CharCodes.Zero),this.entityExcess++):(this.allowLegacyEntity()?this.emitNumericEntity(!1):this.state=this.baseState,this.index--)}stateInHexEntity(c){c===Tokenizer_CharCodes.Semi?this.emitNumericEntity(!0):Tokenizer_isNumber(c)?(this.entityResult=16*this.entityResult+(c-Tokenizer_CharCodes.Zero),this.entityExcess++):!function isHexDigit(c){return c>=Tokenizer_CharCodes.UpperA&&c<=Tokenizer_CharCodes.UpperF||c>=Tokenizer_CharCodes.LowerA&&c<=Tokenizer_CharCodes.LowerF}(c)?(this.allowLegacyEntity()?this.emitNumericEntity(!1):this.state=this.baseState,this.index--):(this.entityResult=16*this.entityResult+((32|c)-Tokenizer_CharCodes.LowerA+10),this.entityExcess++)}allowLegacyEntity(){return!this.xmlMode&&(this.baseState===State.Text||this.baseState===State.InSpecialTag)}cleanup(){this.running&&this.sectionStart!==this.index&&(this.state===State.Text||this.state===State.InSpecialTag&&0===this.sequenceIndex?(this.cbs.ontext(this.sectionStart,this.index),this.sectionStart=this.index):this.state!==State.InAttributeValueDq&&this.state!==State.InAttributeValueSq&&this.state!==State.InAttributeValueNq||(this.cbs.onattribdata(this.sectionStart,this.index),this.sectionStart=this.index))}shouldContinue(){return this.index<this.buffer.length+this.offset&&this.running}parse(){for(;this.shouldContinue();){const c=this.buffer.charCodeAt(this.index-this.offset);switch(this.state){case State.Text:this.stateText(c);break;case State.SpecialStartSequence:this.stateSpecialStartSequence(c);break;case State.InSpecialTag:this.stateInSpecialTag(c);break;case State.CDATASequence:this.stateCDATASequence(c);break;case State.InAttributeValueDq:this.stateInAttributeValueDoubleQuotes(c);break;case State.InAttributeName:this.stateInAttributeName(c);break;case State.InCommentLike:this.stateInCommentLike(c);break;case State.InSpecialComment:this.stateInSpecialComment(c);break;case State.BeforeAttributeName:this.stateBeforeAttributeName(c);break;case State.InTagName:this.stateInTagName(c);break;case State.InClosingTagName:this.stateInClosingTagName(c);break;case State.BeforeTagName:this.stateBeforeTagName(c);break;case State.AfterAttributeName:this.stateAfterAttributeName(c);break;case State.InAttributeValueSq:this.stateInAttributeValueSingleQuotes(c);break;case State.BeforeAttributeValue:this.stateBeforeAttributeValue(c);break;case State.BeforeClosingTagName:this.stateBeforeClosingTagName(c);break;case State.AfterClosingTagName:this.stateAfterClosingTagName(c);break;case State.BeforeSpecialS:this.stateBeforeSpecialS(c);break;case State.InAttributeValueNq:this.stateInAttributeValueNoQuotes(c);break;case State.InSelfClosingTag:this.stateInSelfClosingTag(c);break;case State.InDeclaration:this.stateInDeclaration(c);break;case State.BeforeDeclaration:this.stateBeforeDeclaration(c);break;case State.BeforeComment:this.stateBeforeComment(c);break;case State.InProcessingInstruction:this.stateInProcessingInstruction(c);break;case State.InNamedEntity:this.stateInNamedEntity(c);break;case State.BeforeEntity:this.stateBeforeEntity(c);break;case State.InHexEntity:this.stateInHexEntity(c);break;case State.InNumericEntity:this.stateInNumericEntity(c);break;default:this.stateBeforeNumericEntity(c)}this.index++}this.cleanup()}finish(){this.state===State.InNamedEntity&&this.emitNamedEntity(),this.sectionStart<this.index&&this.handleTrailingData(),this.cbs.onend()}handleTrailingData(){const endIndex=this.buffer.length+this.offset;this.state===State.InCommentLike?this.currentSequence===Sequences.CdataEnd?this.cbs.oncdata(this.sectionStart,endIndex,0):this.cbs.oncomment(this.sectionStart,endIndex,0):this.state===State.InNumericEntity&&this.allowLegacyEntity()||this.state===State.InHexEntity&&this.allowLegacyEntity()?this.emitNumericEntity(!1):this.state===State.InTagName||this.state===State.BeforeAttributeName||this.state===State.BeforeAttributeValue||this.state===State.AfterAttributeName||this.state===State.InAttributeName||this.state===State.InAttributeValueSq||this.state===State.InAttributeValueDq||this.state===State.InAttributeValueNq||this.state===State.InClosingTagName||this.cbs.ontext(this.sectionStart,endIndex)}emitPartial(start,endIndex){this.baseState!==State.Text&&this.baseState!==State.InSpecialTag?this.cbs.onattribdata(start,endIndex):this.cbs.ontext(start,endIndex)}emitCodePoint(cp){this.baseState!==State.Text&&this.baseState!==State.InSpecialTag?this.cbs.onattribentity(cp):this.cbs.ontextentity(cp)}}const formTags=new Set(["input","option","optgroup","select","button","datalist","textarea"]),pTag=new Set(["p"]),tableSectionTags=new Set(["thead","tbody"]),ddtTags=new Set(["dd","dt"]),rtpTags=new Set(["rt","rp"]),openImpliesClose=new Map([["tr",new Set(["tr","th","td"])],["th",new Set(["th"])],["td",new Set(["thead","th","td"])],["body",new Set(["head","link","script"])],["li",new Set(["li"])],["p",pTag],["h1",pTag],["h2",pTag],["h3",pTag],["h4",pTag],["h5",pTag],["h6",pTag],["select",formTags],["input",formTags],["output",formTags],["button",formTags],["datalist",formTags],["textarea",formTags],["option",new Set(["option"])],["optgroup",new Set(["optgroup","option"])],["dd",ddtTags],["dt",ddtTags],["address",pTag],["article",pTag],["aside",pTag],["blockquote",pTag],["details",pTag],["div",pTag],["dl",pTag],["fieldset",pTag],["figcaption",pTag],["figure",pTag],["footer",pTag],["form",pTag],["header",pTag],["hr",pTag],["main",pTag],["nav",pTag],["ol",pTag],["pre",pTag],["section",pTag],["table",pTag],["ul",pTag],["rt",rtpTags],["rp",rtpTags],["tbody",tableSectionTags],["tfoot",tableSectionTags]]),voidElements=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]),foreignContextElements=new Set(["math","svg"]),htmlIntegrationElements=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignobject","desc","title"]),reNameEnd=/\s|\//;class Parser{constructor(cbs,options={}){var _a,_b,_c,_d,_e;this.options=options,this.startIndex=0,this.endIndex=0,this.openTagStart=0,this.tagname="",this.attribname="",this.attribvalue="",this.attribs=null,this.stack=[],this.foreignContext=[],this.buffers=[],this.bufferOffset=0,this.writeIndex=0,this.ended=!1,this.cbs=null!=cbs?cbs:{},this.lowerCaseTagNames=null!==(_a=options.lowerCaseTags)&&void 0!==_a?_a:!options.xmlMode,this.lowerCaseAttributeNames=null!==(_b=options.lowerCaseAttributeNames)&&void 0!==_b?_b:!options.xmlMode,this.tokenizer=new(null!==(_c=options.Tokenizer)&&void 0!==_c?_c:Tokenizer)(this.options,this),null===(_e=(_d=this.cbs).onparserinit)||void 0===_e||_e.call(_d,this)}ontext(start,endIndex){var _a,_b;const data=this.getSlice(start,endIndex);this.endIndex=endIndex-1,null===(_b=(_a=this.cbs).ontext)||void 0===_b||_b.call(_a,data),this.startIndex=endIndex}ontextentity(cp){var _a,_b;const index=this.tokenizer.getSectionStart();this.endIndex=index-1,null===(_b=(_a=this.cbs).ontext)||void 0===_b||_b.call(_a,fromCodePoint(cp)),this.startIndex=index}isVoidElement(name){return!this.options.xmlMode&&voidElements.has(name)}onopentagname(start,endIndex){this.endIndex=endIndex;let name=this.getSlice(start,endIndex);this.lowerCaseTagNames&&(name=name.toLowerCase()),this.emitOpenTag(name)}emitOpenTag(name){var _a,_b,_c,_d;this.openTagStart=this.startIndex,this.tagname=name;const impliesClose=!this.options.xmlMode&&openImpliesClose.get(name);if(impliesClose)for(;this.stack.length>0&&impliesClose.has(this.stack[this.stack.length-1]);){const element=this.stack.pop();null===(_b=(_a=this.cbs).onclosetag)||void 0===_b||_b.call(_a,element,!0)}this.isVoidElement(name)||(this.stack.push(name),foreignContextElements.has(name)?this.foreignContext.push(!0):htmlIntegrationElements.has(name)&&this.foreignContext.push(!1)),null===(_d=(_c=this.cbs).onopentagname)||void 0===_d||_d.call(_c,name),this.cbs.onopentag&&(this.attribs={})}endOpenTag(isImplied){var _a,_b;this.startIndex=this.openTagStart,this.attribs&&(null===(_b=(_a=this.cbs).onopentag)||void 0===_b||_b.call(_a,this.tagname,this.attribs,isImplied),this.attribs=null),this.cbs.onclosetag&&this.isVoidElement(this.tagname)&&this.cbs.onclosetag(this.tagname,!0),this.tagname=""}onopentagend(endIndex){this.endIndex=endIndex,this.endOpenTag(!1),this.startIndex=endIndex+1}onclosetag(start,endIndex){var _a,_b,_c,_d,_e,_f;this.endIndex=endIndex;let name=this.getSlice(start,endIndex);if(this.lowerCaseTagNames&&(name=name.toLowerCase()),(foreignContextElements.has(name)||htmlIntegrationElements.has(name))&&this.foreignContext.pop(),this.isVoidElement(name))this.options.xmlMode||"br"!==name||(null===(_b=(_a=this.cbs).onopentagname)||void 0===_b||_b.call(_a,"br"),null===(_d=(_c=this.cbs).onopentag)||void 0===_d||_d.call(_c,"br",{},!0),null===(_f=(_e=this.cbs).onclosetag)||void 0===_f||_f.call(_e,"br",!1));else{const pos=this.stack.lastIndexOf(name);if(-1!==pos)if(this.cbs.onclosetag){let count=this.stack.length-pos;for(;count--;)this.cbs.onclosetag(this.stack.pop(),0!==count)}else this.stack.length=pos;else this.options.xmlMode||"p"!==name||(this.emitOpenTag("p"),this.closeCurrentTag(!0))}this.startIndex=endIndex+1}onselfclosingtag(endIndex){this.endIndex=endIndex,this.options.xmlMode||this.options.recognizeSelfClosing||this.foreignContext[this.foreignContext.length-1]?(this.closeCurrentTag(!1),this.startIndex=endIndex+1):this.onopentagend(endIndex)}closeCurrentTag(isOpenImplied){var _a,_b;const name=this.tagname;this.endOpenTag(isOpenImplied),this.stack[this.stack.length-1]===name&&(null===(_b=(_a=this.cbs).onclosetag)||void 0===_b||_b.call(_a,name,!isOpenImplied),this.stack.pop())}onattribname(start,endIndex){this.startIndex=start;const name=this.getSlice(start,endIndex);this.attribname=this.lowerCaseAttributeNames?name.toLowerCase():name}onattribdata(start,endIndex){this.attribvalue+=this.getSlice(start,endIndex)}onattribentity(cp){this.attribvalue+=fromCodePoint(cp)}onattribend(quote,endIndex){var _a,_b;this.endIndex=endIndex,null===(_b=(_a=this.cbs).onattribute)||void 0===_b||_b.call(_a,this.attribname,this.attribvalue,quote===QuoteType.Double?'"':quote===QuoteType.Single?"'":quote===QuoteType.NoValue?void 0:null),this.attribs&&!Object.prototype.hasOwnProperty.call(this.attribs,this.attribname)&&(this.attribs[this.attribname]=this.attribvalue),this.attribvalue=""}getInstructionName(value){const index=value.search(reNameEnd);let name=index<0?value:value.substr(0,index);return this.lowerCaseTagNames&&(name=name.toLowerCase()),name}ondeclaration(start,endIndex){this.endIndex=endIndex;const value=this.getSlice(start,endIndex);if(this.cbs.onprocessinginstruction){const name=this.getInstructionName(value);this.cbs.onprocessinginstruction(`!${name}`,`!${value}`)}this.startIndex=endIndex+1}onprocessinginstruction(start,endIndex){this.endIndex=endIndex;const value=this.getSlice(start,endIndex);if(this.cbs.onprocessinginstruction){const name=this.getInstructionName(value);this.cbs.onprocessinginstruction(`?${name}`,`?${value}`)}this.startIndex=endIndex+1}oncomment(start,endIndex,offset){var _a,_b,_c,_d;this.endIndex=endIndex,null===(_b=(_a=this.cbs).oncomment)||void 0===_b||_b.call(_a,this.getSlice(start,endIndex-offset)),null===(_d=(_c=this.cbs).oncommentend)||void 0===_d||_d.call(_c),this.startIndex=endIndex+1}oncdata(start,endIndex,offset){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k;this.endIndex=endIndex;const value=this.getSlice(start,endIndex-offset);this.options.xmlMode||this.options.recognizeCDATA?(null===(_b=(_a=this.cbs).oncdatastart)||void 0===_b||_b.call(_a),null===(_d=(_c=this.cbs).ontext)||void 0===_d||_d.call(_c,value),null===(_f=(_e=this.cbs).oncdataend)||void 0===_f||_f.call(_e)):(null===(_h=(_g=this.cbs).oncomment)||void 0===_h||_h.call(_g,`[CDATA[${value}]]`),null===(_k=(_j=this.cbs).oncommentend)||void 0===_k||_k.call(_j)),this.startIndex=endIndex+1}onend(){var _a,_b;if(this.cbs.onclosetag){this.endIndex=this.startIndex;for(let index=this.stack.length;index>0;this.cbs.onclosetag(this.stack[--index],!0));}null===(_b=(_a=this.cbs).onend)||void 0===_b||_b.call(_a)}reset(){var _a,_b,_c,_d;null===(_b=(_a=this.cbs).onreset)||void 0===_b||_b.call(_a),this.tokenizer.reset(),this.tagname="",this.attribname="",this.attribs=null,this.stack.length=0,this.startIndex=0,this.endIndex=0,null===(_d=(_c=this.cbs).onparserinit)||void 0===_d||_d.call(_c,this),this.buffers.length=0,this.bufferOffset=0,this.writeIndex=0,this.ended=!1}parseComplete(data){this.reset(),this.end(data)}getSlice(start,end){for(;start-this.bufferOffset>=this.buffers[0].length;)this.shiftBuffer();let slice=this.buffers[0].slice(start-this.bufferOffset,end-this.bufferOffset);for(;end-this.bufferOffset>this.buffers[0].length;)this.shiftBuffer(),slice+=this.buffers[0].slice(0,end-this.bufferOffset);return slice}shiftBuffer(){this.bufferOffset+=this.buffers[0].length,this.writeIndex--,this.buffers.shift()}write(chunk){var _a,_b;this.ended?null===(_b=(_a=this.cbs).onerror)||void 0===_b||_b.call(_a,new Error(".write() after done!")):(this.buffers.push(chunk),this.tokenizer.running&&(this.tokenizer.write(chunk),this.writeIndex++))}end(chunk){var _a,_b;this.ended?null===(_b=(_a=this.cbs).onerror)||void 0===_b||_b.call(_a,new Error(".end() after done!")):(chunk&&this.write(chunk),this.ended=!0,this.tokenizer.end())}pause(){this.tokenizer.pause()}resume(){for(this.tokenizer.resume();this.tokenizer.running&&this.writeIndex<this.buffers.length;)this.tokenizer.write(this.buffers[this.writeIndex++]);this.ended&&this.tokenizer.end()}parseChunk(chunk){this.write(chunk)}done(chunk){this.end(chunk)}}var ElementType;function isTag(elem){return elem.type===ElementType.Tag||elem.type===ElementType.Script||elem.type===ElementType.Style}!function(ElementType){ElementType.Root="root",ElementType.Text="text",ElementType.Directive="directive",ElementType.Comment="comment",ElementType.Script="script",ElementType.Style="style",ElementType.Tag="tag",ElementType.CDATA="cdata",ElementType.Doctype="doctype"}(ElementType||(ElementType={}));const Root=ElementType.Root,Text=ElementType.Text,Directive=ElementType.Directive,Comment=ElementType.Comment,Script=ElementType.Script,Style=ElementType.Style,Tag=ElementType.Tag,CDATA=ElementType.CDATA,Doctype=ElementType.Doctype;class Node{constructor(){this.parent=null,this.prev=null,this.next=null,this.startIndex=null,this.endIndex=null}get parentNode(){return this.parent}set parentNode(parent){this.parent=parent}get previousSibling(){return this.prev}set previousSibling(prev){this.prev=prev}get nextSibling(){return this.next}set nextSibling(next){this.next=next}cloneNode(recursive=!1){return cloneNode(this,recursive)}}class DataNode extends Node{constructor(data){super(),this.data=data}get nodeValue(){return this.data}set nodeValue(data){this.data=data}}class node_Text extends DataNode{constructor(){super(...arguments),this.type=ElementType.Text}get nodeType(){return 3}}class node_Comment extends DataNode{constructor(){super(...arguments),this.type=ElementType.Comment}get nodeType(){return 8}}class ProcessingInstruction extends DataNode{constructor(name,data){super(data),this.name=name,this.type=ElementType.Directive}get nodeType(){return 1}}class NodeWithChildren extends Node{constructor(children){super(),this.children=children}get firstChild(){var _a;return null!==(_a=this.children[0])&&void 0!==_a?_a:null}get lastChild(){return this.children.length>0?this.children[this.children.length-1]:null}get childNodes(){return this.children}set childNodes(children){this.children=children}}class node_CDATA extends NodeWithChildren{constructor(){super(...arguments),this.type=ElementType.CDATA}get nodeType(){return 4}}class Document extends NodeWithChildren{constructor(){super(...arguments),this.type=ElementType.Root}get nodeType(){return 9}}class Element extends NodeWithChildren{constructor(name,attribs,children=[],type=("script"===name?ElementType.Script:"style"===name?ElementType.Style:ElementType.Tag)){super(children),this.name=name,this.attribs=attribs,this.type=type}get nodeType(){return 1}get tagName(){return this.name}set tagName(name){this.name=name}get attributes(){return Object.keys(this.attribs).map((name=>{var _a,_b;return{name,value:this.attribs[name],namespace:null===(_a=this["x-attribsNamespace"])||void 0===_a?void 0:_a[name],prefix:null===(_b=this["x-attribsPrefix"])||void 0===_b?void 0:_b[name]}}))}}function node_isTag(node){return isTag(node)}function isCDATA(node){return node.type===ElementType.CDATA}function isText(node){return node.type===ElementType.Text}function isComment(node){return node.type===ElementType.Comment}function isDocument(node){return node.type===ElementType.Root}function hasChildren(node){return Object.prototype.hasOwnProperty.call(node,"children")}function cloneNode(node,recursive=!1){let result;if(isText(node))result=new node_Text(node.data);else if(isComment(node))result=new node_Comment(node.data);else if(node_isTag(node)){const children=recursive?cloneChildren(node.children):[],clone=new Element(node.name,{...node.attribs},children);children.forEach((child=>child.parent=clone)),null!=node.namespace&&(clone.namespace=node.namespace),node["x-attribsNamespace"]&&(clone["x-attribsNamespace"]={...node["x-attribsNamespace"]}),node["x-attribsPrefix"]&&(clone["x-attribsPrefix"]={...node["x-attribsPrefix"]}),result=clone}else if(isCDATA(node)){const children=recursive?cloneChildren(node.children):[],clone=new node_CDATA(children);children.forEach((child=>child.parent=clone)),result=clone}else if(isDocument(node)){const children=recursive?cloneChildren(node.children):[],clone=new Document(children);children.forEach((child=>child.parent=clone)),node["x-mode"]&&(clone["x-mode"]=node["x-mode"]),result=clone}else{if(!function isDirective(node){return node.type===ElementType.Directive}(node))throw new Error(`Not implemented yet: ${node.type}`);{const instruction=new ProcessingInstruction(node.name,node.data);null!=node["x-name"]&&(instruction["x-name"]=node["x-name"],instruction["x-publicId"]=node["x-publicId"],instruction["x-systemId"]=node["x-systemId"]),result=instruction}}return result.startIndex=node.startIndex,result.endIndex=node.endIndex,null!=node.sourceCodeLocation&&(result.sourceCodeLocation=node.sourceCodeLocation),result}function cloneChildren(childs){const children=childs.map((child=>cloneNode(child,!0)));for(let i=1;i<children.length;i++)children[i].prev=children[i-1],children[i-1].next=children[i];return children}const defaultOpts={withStartIndices:!1,withEndIndices:!1,xmlMode:!1};class DomHandler{constructor(callback,options,elementCB){this.dom=[],this.root=new Document(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null,"function"==typeof options&&(elementCB=options,options=defaultOpts),"object"==typeof callback&&(options=callback,callback=void 0),this.callback=null!=callback?callback:null,this.options=null!=options?options:defaultOpts,this.elementCB=null!=elementCB?elementCB:null}onparserinit(parser){this.parser=parser}onreset(){this.dom=[],this.root=new Document(this.dom),this.done=!1,this.tagStack=[this.root],this.lastNode=null,this.parser=null}onend(){this.done||(this.done=!0,this.parser=null,this.handleCallback(null))}onerror(error){this.handleCallback(error)}onclosetag(){this.lastNode=null;const elem=this.tagStack.pop();this.options.withEndIndices&&(elem.endIndex=this.parser.endIndex),this.elementCB&&this.elementCB(elem)}onopentag(name,attribs){const type=this.options.xmlMode?ElementType.Tag:void 0,element=new Element(name,attribs,void 0,type);this.addNode(element),this.tagStack.push(element)}ontext(data){const{lastNode}=this;if(lastNode&&lastNode.type===ElementType.Text)lastNode.data+=data,this.options.withEndIndices&&(lastNode.endIndex=this.parser.endIndex);else{const node=new node_Text(data);this.addNode(node),this.lastNode=node}}oncomment(data){if(this.lastNode&&this.lastNode.type===ElementType.Comment)return void(this.lastNode.data+=data);const node=new node_Comment(data);this.addNode(node),this.lastNode=node}oncommentend(){this.lastNode=null}oncdatastart(){const text=new node_Text(""),node=new node_CDATA([text]);this.addNode(node),text.parent=node,this.lastNode=text}oncdataend(){this.lastNode=null}onprocessinginstruction(name,data){const node=new ProcessingInstruction(name,data);this.addNode(node)}handleCallback(error){if("function"==typeof this.callback)this.callback(error,this.dom);else if(error)throw error}addNode(node){const parent=this.tagStack[this.tagStack.length-1],previousSibling=parent.children[parent.children.length-1];this.options.withStartIndices&&(node.startIndex=this.parser.startIndex),this.options.withEndIndices&&(node.endIndex=this.parser.endIndex),parent.children.push(node),previousSibling&&(node.prev=previousSibling,previousSibling.next=node),node.parent=parent,this.lastNode=null}}function restoreDiff(arr){for(let i=1;i<arr.length;i++)arr[i][0]+=arr[i-1][0]+1;return arr}new Map(restoreDiff([[9,"&Tab;"],[0,"&NewLine;"],[22,"&excl;"],[0,"&quot;"],[0,"&num;"],[0,"&dollar;"],[0,"&percnt;"],[0,"&amp;"],[0,"&apos;"],[0,"&lpar;"],[0,"&rpar;"],[0,"&ast;"],[0,"&plus;"],[0,"&comma;"],[1,"&period;"],[0,"&sol;"],[10,"&colon;"],[0,"&semi;"],[0,{v:"&lt;",n:8402,o:"&nvlt;"}],[0,{v:"&equals;",n:8421,o:"&bne;"}],[0,{v:"&gt;",n:8402,o:"&nvgt;"}],[0,"&quest;"],[0,"&commat;"],[26,"&lbrack;"],[0,"&bsol;"],[0,"&rbrack;"],[0,"&Hat;"],[0,"&lowbar;"],[0,"&DiacriticalGrave;"],[5,{n:106,o:"&fjlig;"}],[20,"&lbrace;"],[0,"&verbar;"],[0,"&rbrace;"],[34,"&nbsp;"],[0,"&iexcl;"],[0,"&cent;"],[0,"&pound;"],[0,"&curren;"],[0,"&yen;"],[0,"&brvbar;"],[0,"&sect;"],[0,"&die;"],[0,"&copy;"],[0,"&ordf;"],[0,"&laquo;"],[0,"&not;"],[0,"&shy;"],[0,"&circledR;"],[0,"&macr;"],[0,"&deg;"],[0,"&PlusMinus;"],[0,"&sup2;"],[0,"&sup3;"],[0,"&acute;"],[0,"&micro;"],[0,"&para;"],[0,"&centerdot;"],[0,"&cedil;"],[0,"&sup1;"],[0,"&ordm;"],[0,"&raquo;"],[0,"&frac14;"],[0,"&frac12;"],[0,"&frac34;"],[0,"&iquest;"],[0,"&Agrave;"],[0,"&Aacute;"],[0,"&Acirc;"],[0,"&Atilde;"],[0,"&Auml;"],[0,"&angst;"],[0,"&AElig;"],[0,"&Ccedil;"],[0,"&Egrave;"],[0,"&Eacute;"],[0,"&Ecirc;"],[0,"&Euml;"],[0,"&Igrave;"],[0,"&Iacute;"],[0,"&Icirc;"],[0,"&Iuml;"],[0,"&ETH;"],[0,"&Ntilde;"],[0,"&Ograve;"],[0,"&Oacute;"],[0,"&Ocirc;"],[0,"&Otilde;"],[0,"&Ouml;"],[0,"&times;"],[0,"&Oslash;"],[0,"&Ugrave;"],[0,"&Uacute;"],[0,"&Ucirc;"],[0,"&Uuml;"],[0,"&Yacute;"],[0,"&THORN;"],[0,"&szlig;"],[0,"&agrave;"],[0,"&aacute;"],[0,"&acirc;"],[0,"&atilde;"],[0,"&auml;"],[0,"&aring;"],[0,"&aelig;"],[0,"&ccedil;"],[0,"&egrave;"],[0,"&eacute;"],[0,"&ecirc;"],[0,"&euml;"],[0,"&igrave;"],[0,"&iacute;"],[0,"&icirc;"],[0,"&iuml;"],[0,"&eth;"],[0,"&ntilde;"],[0,"&ograve;"],[0,"&oacute;"],[0,"&ocirc;"],[0,"&otilde;"],[0,"&ouml;"],[0,"&div;"],[0,"&oslash;"],[0,"&ugrave;"],[0,"&uacute;"],[0,"&ucirc;"],[0,"&uuml;"],[0,"&yacute;"],[0,"&thorn;"],[0,"&yuml;"],[0,"&Amacr;"],[0,"&amacr;"],[0,"&Abreve;"],[0,"&abreve;"],[0,"&Aogon;"],[0,"&aogon;"],[0,"&Cacute;"],[0,"&cacute;"],[0,"&Ccirc;"],[0,"&ccirc;"],[0,"&Cdot;"],[0,"&cdot;"],[0,"&Ccaron;"],[0,"&ccaron;"],[0,"&Dcaron;"],[0,"&dcaron;"],[0,"&Dstrok;"],[0,"&dstrok;"],[0,"&Emacr;"],[0,"&emacr;"],[2,"&Edot;"],[0,"&edot;"],[0,"&Eogon;"],[0,"&eogon;"],[0,"&Ecaron;"],[0,"&ecaron;"],[0,"&Gcirc;"],[0,"&gcirc;"],[0,"&Gbreve;"],[0,"&gbreve;"],[0,"&Gdot;"],[0,"&gdot;"],[0,"&Gcedil;"],[1,"&Hcirc;"],[0,"&hcirc;"],[0,"&Hstrok;"],[0,"&hstrok;"],[0,"&Itilde;"],[0,"&itilde;"],[0,"&Imacr;"],[0,"&imacr;"],[2,"&Iogon;"],[0,"&iogon;"],[0,"&Idot;"],[0,"&imath;"],[0,"&IJlig;"],[0,"&ijlig;"],[0,"&Jcirc;"],[0,"&jcirc;"],[0,"&Kcedil;"],[0,"&kcedil;"],[0,"&kgreen;"],[0,"&Lacute;"],[0,"&lacute;"],[0,"&Lcedil;"],[0,"&lcedil;"],[0,"&Lcaron;"],[0,"&lcaron;"],[0,"&Lmidot;"],[0,"&lmidot;"],[0,"&Lstrok;"],[0,"&lstrok;"],[0,"&Nacute;"],[0,"&nacute;"],[0,"&Ncedil;"],[0,"&ncedil;"],[0,"&Ncaron;"],[0,"&ncaron;"],[0,"&napos;"],[0,"&ENG;"],[0,"&eng;"],[0,"&Omacr;"],[0,"&omacr;"],[2,"&Odblac;"],[0,"&odblac;"],[0,"&OElig;"],[0,"&oelig;"],[0,"&Racute;"],[0,"&racute;"],[0,"&Rcedil;"],[0,"&rcedil;"],[0,"&Rcaron;"],[0,"&rcaron;"],[0,"&Sacute;"],[0,"&sacute;"],[0,"&Scirc;"],[0,"&scirc;"],[0,"&Scedil;"],[0,"&scedil;"],[0,"&Scaron;"],[0,"&scaron;"],[0,"&Tcedil;"],[0,"&tcedil;"],[0,"&Tcaron;"],[0,"&tcaron;"],[0,"&Tstrok;"],[0,"&tstrok;"],[0,"&Utilde;"],[0,"&utilde;"],[0,"&Umacr;"],[0,"&umacr;"],[0,"&Ubreve;"],[0,"&ubreve;"],[0,"&Uring;"],[0,"&uring;"],[0,"&Udblac;"],[0,"&udblac;"],[0,"&Uogon;"],[0,"&uogon;"],[0,"&Wcirc;"],[0,"&wcirc;"],[0,"&Ycirc;"],[0,"&ycirc;"],[0,"&Yuml;"],[0,"&Zacute;"],[0,"&zacute;"],[0,"&Zdot;"],[0,"&zdot;"],[0,"&Zcaron;"],[0,"&zcaron;"],[19,"&fnof;"],[34,"&imped;"],[63,"&gacute;"],[65,"&jmath;"],[142,"&circ;"],[0,"&caron;"],[16,"&breve;"],[0,"&DiacriticalDot;"],[0,"&ring;"],[0,"&ogon;"],[0,"&DiacriticalTilde;"],[0,"&dblac;"],[51,"&DownBreve;"],[127,"&Alpha;"],[0,"&Beta;"],[0,"&Gamma;"],[0,"&Delta;"],[0,"&Epsilon;"],[0,"&Zeta;"],[0,"&Eta;"],[0,"&Theta;"],[0,"&Iota;"],[0,"&Kappa;"],[0,"&Lambda;"],[0,"&Mu;"],[0,"&Nu;"],[0,"&Xi;"],[0,"&Omicron;"],[0,"&Pi;"],[0,"&Rho;"],[1,"&Sigma;"],[0,"&Tau;"],[0,"&Upsilon;"],[0,"&Phi;"],[0,"&Chi;"],[0,"&Psi;"],[0,"&ohm;"],[7,"&alpha;"],[0,"&beta;"],[0,"&gamma;"],[0,"&delta;"],[0,"&epsi;"],[0,"&zeta;"],[0,"&eta;"],[0,"&theta;"],[0,"&iota;"],[0,"&kappa;"],[0,"&lambda;"],[0,"&mu;"],[0,"&nu;"],[0,"&xi;"],[0,"&omicron;"],[0,"&pi;"],[0,"&rho;"],[0,"&sigmaf;"],[0,"&sigma;"],[0,"&tau;"],[0,"&upsi;"],[0,"&phi;"],[0,"&chi;"],[0,"&psi;"],[0,"&omega;"],[7,"&thetasym;"],[0,"&Upsi;"],[2,"&phiv;"],[0,"&piv;"],[5,"&Gammad;"],[0,"&digamma;"],[18,"&kappav;"],[0,"&rhov;"],[3,"&epsiv;"],[0,"&backepsilon;"],[10,"&IOcy;"],[0,"&DJcy;"],[0,"&GJcy;"],[0,"&Jukcy;"],[0,"&DScy;"],[0,"&Iukcy;"],[0,"&YIcy;"],[0,"&Jsercy;"],[0,"&LJcy;"],[0,"&NJcy;"],[0,"&TSHcy;"],[0,"&KJcy;"],[1,"&Ubrcy;"],[0,"&DZcy;"],[0,"&Acy;"],[0,"&Bcy;"],[0,"&Vcy;"],[0,"&Gcy;"],[0,"&Dcy;"],[0,"&IEcy;"],[0,"&ZHcy;"],[0,"&Zcy;"],[0,"&Icy;"],[0,"&Jcy;"],[0,"&Kcy;"],[0,"&Lcy;"],[0,"&Mcy;"],[0,"&Ncy;"],[0,"&Ocy;"],[0,"&Pcy;"],[0,"&Rcy;"],[0,"&Scy;"],[0,"&Tcy;"],[0,"&Ucy;"],[0,"&Fcy;"],[0,"&KHcy;"],[0,"&TScy;"],[0,"&CHcy;"],[0,"&SHcy;"],[0,"&SHCHcy;"],[0,"&HARDcy;"],[0,"&Ycy;"],[0,"&SOFTcy;"],[0,"&Ecy;"],[0,"&YUcy;"],[0,"&YAcy;"],[0,"&acy;"],[0,"&bcy;"],[0,"&vcy;"],[0,"&gcy;"],[0,"&dcy;"],[0,"&iecy;"],[0,"&zhcy;"],[0,"&zcy;"],[0,"&icy;"],[0,"&jcy;"],[0,"&kcy;"],[0,"&lcy;"],[0,"&mcy;"],[0,"&ncy;"],[0,"&ocy;"],[0,"&pcy;"],[0,"&rcy;"],[0,"&scy;"],[0,"&tcy;"],[0,"&ucy;"],[0,"&fcy;"],[0,"&khcy;"],[0,"&tscy;"],[0,"&chcy;"],[0,"&shcy;"],[0,"&shchcy;"],[0,"&hardcy;"],[0,"&ycy;"],[0,"&softcy;"],[0,"&ecy;"],[0,"&yucy;"],[0,"&yacy;"],[1,"&iocy;"],[0,"&djcy;"],[0,"&gjcy;"],[0,"&jukcy;"],[0,"&dscy;"],[0,"&iukcy;"],[0,"&yicy;"],[0,"&jsercy;"],[0,"&ljcy;"],[0,"&njcy;"],[0,"&tshcy;"],[0,"&kjcy;"],[1,"&ubrcy;"],[0,"&dzcy;"],[7074,"&ensp;"],[0,"&emsp;"],[0,"&emsp13;"],[0,"&emsp14;"],[1,"&numsp;"],[0,"&puncsp;"],[0,"&ThinSpace;"],[0,"&hairsp;"],[0,"&NegativeMediumSpace;"],[0,"&zwnj;"],[0,"&zwj;"],[0,"&lrm;"],[0,"&rlm;"],[0,"&dash;"],[2,"&ndash;"],[0,"&mdash;"],[0,"&horbar;"],[0,"&Verbar;"],[1,"&lsquo;"],[0,"&CloseCurlyQuote;"],[0,"&lsquor;"],[1,"&ldquo;"],[0,"&CloseCurlyDoubleQuote;"],[0,"&bdquo;"],[1,"&dagger;"],[0,"&Dagger;"],[0,"&bull;"],[2,"&nldr;"],[0,"&hellip;"],[9,"&permil;"],[0,"&pertenk;"],[0,"&prime;"],[0,"&Prime;"],[0,"&tprime;"],[0,"&backprime;"],[3,"&lsaquo;"],[0,"&rsaquo;"],[3,"&oline;"],[2,"&caret;"],[1,"&hybull;"],[0,"&frasl;"],[10,"&bsemi;"],[7,"&qprime;"],[7,{v:"&MediumSpace;",n:8202,o:"&ThickSpace;"}],[0,"&NoBreak;"],[0,"&af;"],[0,"&InvisibleTimes;"],[0,"&ic;"],[72,"&euro;"],[46,"&tdot;"],[0,"&DotDot;"],[37,"&complexes;"],[2,"&incare;"],[4,"&gscr;"],[0,"&hamilt;"],[0,"&Hfr;"],[0,"&Hopf;"],[0,"&planckh;"],[0,"&hbar;"],[0,"&imagline;"],[0,"&Ifr;"],[0,"&lagran;"],[0,"&ell;"],[1,"&naturals;"],[0,"&numero;"],[0,"&copysr;"],[0,"&weierp;"],[0,"&Popf;"],[0,"&Qopf;"],[0,"&realine;"],[0,"&real;"],[0,"&reals;"],[0,"&rx;"],[3,"&trade;"],[1,"&integers;"],[2,"&mho;"],[0,"&zeetrf;"],[0,"&iiota;"],[2,"&bernou;"],[0,"&Cayleys;"],[1,"&escr;"],[0,"&Escr;"],[0,"&Fouriertrf;"],[1,"&Mellintrf;"],[0,"&order;"],[0,"&alefsym;"],[0,"&beth;"],[0,"&gimel;"],[0,"&daleth;"],[12,"&CapitalDifferentialD;"],[0,"&dd;"],[0,"&ee;"],[0,"&ii;"],[10,"&frac13;"],[0,"&frac23;"],[0,"&frac15;"],[0,"&frac25;"],[0,"&frac35;"],[0,"&frac45;"],[0,"&frac16;"],[0,"&frac56;"],[0,"&frac18;"],[0,"&frac38;"],[0,"&frac58;"],[0,"&frac78;"],[49,"&larr;"],[0,"&ShortUpArrow;"],[0,"&rarr;"],[0,"&darr;"],[0,"&harr;"],[0,"&updownarrow;"],[0,"&nwarr;"],[0,"&nearr;"],[0,"&LowerRightArrow;"],[0,"&LowerLeftArrow;"],[0,"&nlarr;"],[0,"&nrarr;"],[1,{v:"&rarrw;",n:824,o:"&nrarrw;"}],[0,"&Larr;"],[0,"&Uarr;"],[0,"&Rarr;"],[0,"&Darr;"],[0,"&larrtl;"],[0,"&rarrtl;"],[0,"&LeftTeeArrow;"],[0,"&mapstoup;"],[0,"&map;"],[0,"&DownTeeArrow;"],[1,"&hookleftarrow;"],[0,"&hookrightarrow;"],[0,"&larrlp;"],[0,"&looparrowright;"],[0,"&harrw;"],[0,"&nharr;"],[1,"&lsh;"],[0,"&rsh;"],[0,"&ldsh;"],[0,"&rdsh;"],[1,"&crarr;"],[0,"&cularr;"],[0,"&curarr;"],[2,"&circlearrowleft;"],[0,"&circlearrowright;"],[0,"&leftharpoonup;"],[0,"&DownLeftVector;"],[0,"&RightUpVector;"],[0,"&LeftUpVector;"],[0,"&rharu;"],[0,"&DownRightVector;"],[0,"&dharr;"],[0,"&dharl;"],[0,"&RightArrowLeftArrow;"],[0,"&udarr;"],[0,"&LeftArrowRightArrow;"],[0,"&leftleftarrows;"],[0,"&upuparrows;"],[0,"&rightrightarrows;"],[0,"&ddarr;"],[0,"&leftrightharpoons;"],[0,"&Equilibrium;"],[0,"&nlArr;"],[0,"&nhArr;"],[0,"&nrArr;"],[0,"&DoubleLeftArrow;"],[0,"&DoubleUpArrow;"],[0,"&DoubleRightArrow;"],[0,"&dArr;"],[0,"&DoubleLeftRightArrow;"],[0,"&DoubleUpDownArrow;"],[0,"&nwArr;"],[0,"&neArr;"],[0,"&seArr;"],[0,"&swArr;"],[0,"&lAarr;"],[0,"&rAarr;"],[1,"&zigrarr;"],[6,"&larrb;"],[0,"&rarrb;"],[15,"&DownArrowUpArrow;"],[7,"&loarr;"],[0,"&roarr;"],[0,"&hoarr;"],[0,"&forall;"],[0,"&comp;"],[0,{v:"&part;",n:824,o:"&npart;"}],[0,"&exist;"],[0,"&nexist;"],[0,"&empty;"],[1,"&Del;"],[0,"&Element;"],[0,"&NotElement;"],[1,"&ni;"],[0,"&notni;"],[2,"&prod;"],[0,"&coprod;"],[0,"&sum;"],[0,"&minus;"],[0,"&MinusPlus;"],[0,"&dotplus;"],[1,"&Backslash;"],[0,"&lowast;"],[0,"&compfn;"],[1,"&radic;"],[2,"&prop;"],[0,"&infin;"],[0,"&angrt;"],[0,{v:"&ang;",n:8402,o:"&nang;"}],[0,"&angmsd;"],[0,"&angsph;"],[0,"&mid;"],[0,"&nmid;"],[0,"&DoubleVerticalBar;"],[0,"&NotDoubleVerticalBar;"],[0,"&and;"],[0,"&or;"],[0,{v:"&cap;",n:65024,o:"&caps;"}],[0,{v:"&cup;",n:65024,o:"&cups;"}],[0,"&int;"],[0,"&Int;"],[0,"&iiint;"],[0,"&conint;"],[0,"&Conint;"],[0,"&Cconint;"],[0,"&cwint;"],[0,"&ClockwiseContourIntegral;"],[0,"&awconint;"],[0,"&there4;"],[0,"&becaus;"],[0,"&ratio;"],[0,"&Colon;"],[0,"&dotminus;"],[1,"&mDDot;"],[0,"&homtht;"],[0,{v:"&sim;",n:8402,o:"&nvsim;"}],[0,{v:"&backsim;",n:817,o:"&race;"}],[0,{v:"&ac;",n:819,o:"&acE;"}],[0,"&acd;"],[0,"&VerticalTilde;"],[0,"&NotTilde;"],[0,{v:"&eqsim;",n:824,o:"&nesim;"}],[0,"&sime;"],[0,"&NotTildeEqual;"],[0,"&cong;"],[0,"&simne;"],[0,"&ncong;"],[0,"&ap;"],[0,"&nap;"],[0,"&ape;"],[0,{v:"&apid;",n:824,o:"&napid;"}],[0,"&backcong;"],[0,{v:"&asympeq;",n:8402,o:"&nvap;"}],[0,{v:"&bump;",n:824,o:"&nbump;"}],[0,{v:"&bumpe;",n:824,o:"&nbumpe;"}],[0,{v:"&doteq;",n:824,o:"&nedot;"}],[0,"&doteqdot;"],[0,"&efDot;"],[0,"&erDot;"],[0,"&Assign;"],[0,"&ecolon;"],[0,"&ecir;"],[0,"&circeq;"],[1,"&wedgeq;"],[0,"&veeeq;"],[1,"&triangleq;"],[2,"&equest;"],[0,"&ne;"],[0,{v:"&Congruent;",n:8421,o:"&bnequiv;"}],[0,"&nequiv;"],[1,{v:"&le;",n:8402,o:"&nvle;"}],[0,{v:"&ge;",n:8402,o:"&nvge;"}],[0,{v:"&lE;",n:824,o:"&nlE;"}],[0,{v:"&gE;",n:824,o:"&ngE;"}],[0,{v:"&lnE;",n:65024,o:"&lvertneqq;"}],[0,{v:"&gnE;",n:65024,o:"&gvertneqq;"}],[0,{v:"&ll;",n:new Map(restoreDiff([[824,"&nLtv;"],[7577,"&nLt;"]]))}],[0,{v:"&gg;",n:new Map(restoreDiff([[824,"&nGtv;"],[7577,"&nGt;"]]))}],[0,"&between;"],[0,"&NotCupCap;"],[0,"&nless;"],[0,"&ngt;"],[0,"&nle;"],[0,"&nge;"],[0,"&lesssim;"],[0,"&GreaterTilde;"],[0,"&nlsim;"],[0,"&ngsim;"],[0,"&LessGreater;"],[0,"&gl;"],[0,"&NotLessGreater;"],[0,"&NotGreaterLess;"],[0,"&pr;"],[0,"&sc;"],[0,"&prcue;"],[0,"&sccue;"],[0,"&PrecedesTilde;"],[0,{v:"&scsim;",n:824,o:"&NotSucceedsTilde;"}],[0,"&NotPrecedes;"],[0,"&NotSucceeds;"],[0,{v:"&sub;",n:8402,o:"&NotSubset;"}],[0,{v:"&sup;",n:8402,o:"&NotSuperset;"}],[0,"&nsub;"],[0,"&nsup;"],[0,"&sube;"],[0,"&supe;"],[0,"&NotSubsetEqual;"],[0,"&NotSupersetEqual;"],[0,{v:"&subne;",n:65024,o:"&varsubsetneq;"}],[0,{v:"&supne;",n:65024,o:"&varsupsetneq;"}],[1,"&cupdot;"],[0,"&UnionPlus;"],[0,{v:"&sqsub;",n:824,o:"&NotSquareSubset;"}],[0,{v:"&sqsup;",n:824,o:"&NotSquareSuperset;"}],[0,"&sqsube;"],[0,"&sqsupe;"],[0,{v:"&sqcap;",n:65024,o:"&sqcaps;"}],[0,{v:"&sqcup;",n:65024,o:"&sqcups;"}],[0,"&CirclePlus;"],[0,"&CircleMinus;"],[0,"&CircleTimes;"],[0,"&osol;"],[0,"&CircleDot;"],[0,"&circledcirc;"],[0,"&circledast;"],[1,"&circleddash;"],[0,"&boxplus;"],[0,"&boxminus;"],[0,"&boxtimes;"],[0,"&dotsquare;"],[0,"&RightTee;"],[0,"&dashv;"],[0,"&DownTee;"],[0,"&bot;"],[1,"&models;"],[0,"&DoubleRightTee;"],[0,"&Vdash;"],[0,"&Vvdash;"],[0,"&VDash;"],[0,"&nvdash;"],[0,"&nvDash;"],[0,"&nVdash;"],[0,"&nVDash;"],[0,"&prurel;"],[1,"&LeftTriangle;"],[0,"&RightTriangle;"],[0,{v:"&LeftTriangleEqual;",n:8402,o:"&nvltrie;"}],[0,{v:"&RightTriangleEqual;",n:8402,o:"&nvrtrie;"}],[0,"&origof;"],[0,"&imof;"],[0,"&multimap;"],[0,"&hercon;"],[0,"&intcal;"],[0,"&veebar;"],[1,"&barvee;"],[0,"&angrtvb;"],[0,"&lrtri;"],[0,"&bigwedge;"],[0,"&bigvee;"],[0,"&bigcap;"],[0,"&bigcup;"],[0,"&diam;"],[0,"&sdot;"],[0,"&sstarf;"],[0,"&divideontimes;"],[0,"&bowtie;"],[0,"&ltimes;"],[0,"&rtimes;"],[0,"&leftthreetimes;"],[0,"&rightthreetimes;"],[0,"&backsimeq;"],[0,"&curlyvee;"],[0,"&curlywedge;"],[0,"&Sub;"],[0,"&Sup;"],[0,"&Cap;"],[0,"&Cup;"],[0,"&fork;"],[0,"&epar;"],[0,"&lessdot;"],[0,"&gtdot;"],[0,{v:"&Ll;",n:824,o:"&nLl;"}],[0,{v:"&Gg;",n:824,o:"&nGg;"}],[0,{v:"&leg;",n:65024,o:"&lesg;"}],[0,{v:"&gel;",n:65024,o:"&gesl;"}],[2,"&cuepr;"],[0,"&cuesc;"],[0,"&NotPrecedesSlantEqual;"],[0,"&NotSucceedsSlantEqual;"],[0,"&NotSquareSubsetEqual;"],[0,"&NotSquareSupersetEqual;"],[2,"&lnsim;"],[0,"&gnsim;"],[0,"&precnsim;"],[0,"&scnsim;"],[0,"&nltri;"],[0,"&NotRightTriangle;"],[0,"&nltrie;"],[0,"&NotRightTriangleEqual;"],[0,"&vellip;"],[0,"&ctdot;"],[0,"&utdot;"],[0,"&dtdot;"],[0,"&disin;"],[0,"&isinsv;"],[0,"&isins;"],[0,{v:"&isindot;",n:824,o:"&notindot;"}],[0,"&notinvc;"],[0,"&notinvb;"],[1,{v:"&isinE;",n:824,o:"&notinE;"}],[0,"&nisd;"],[0,"&xnis;"],[0,"&nis;"],[0,"&notnivc;"],[0,"&notnivb;"],[6,"&barwed;"],[0,"&Barwed;"],[1,"&lceil;"],[0,"&rceil;"],[0,"&LeftFloor;"],[0,"&rfloor;"],[0,"&drcrop;"],[0,"&dlcrop;"],[0,"&urcrop;"],[0,"&ulcrop;"],[0,"&bnot;"],[1,"&profline;"],[0,"&profsurf;"],[1,"&telrec;"],[0,"&target;"],[5,"&ulcorn;"],[0,"&urcorn;"],[0,"&dlcorn;"],[0,"&drcorn;"],[2,"&frown;"],[0,"&smile;"],[9,"&cylcty;"],[0,"&profalar;"],[7,"&topbot;"],[6,"&ovbar;"],[1,"&solbar;"],[60,"&angzarr;"],[51,"&lmoustache;"],[0,"&rmoustache;"],[2,"&OverBracket;"],[0,"&bbrk;"],[0,"&bbrktbrk;"],[37,"&OverParenthesis;"],[0,"&UnderParenthesis;"],[0,"&OverBrace;"],[0,"&UnderBrace;"],[2,"&trpezium;"],[4,"&elinters;"],[59,"&blank;"],[164,"&circledS;"],[55,"&boxh;"],[1,"&boxv;"],[9,"&boxdr;"],[3,"&boxdl;"],[3,"&boxur;"],[3,"&boxul;"],[3,"&boxvr;"],[7,"&boxvl;"],[7,"&boxhd;"],[7,"&boxhu;"],[7,"&boxvh;"],[19,"&boxH;"],[0,"&boxV;"],[0,"&boxdR;"],[0,"&boxDr;"],[0,"&boxDR;"],[0,"&boxdL;"],[0,"&boxDl;"],[0,"&boxDL;"],[0,"&boxuR;"],[0,"&boxUr;"],[0,"&boxUR;"],[0,"&boxuL;"],[0,"&boxUl;"],[0,"&boxUL;"],[0,"&boxvR;"],[0,"&boxVr;"],[0,"&boxVR;"],[0,"&boxvL;"],[0,"&boxVl;"],[0,"&boxVL;"],[0,"&boxHd;"],[0,"&boxhD;"],[0,"&boxHD;"],[0,"&boxHu;"],[0,"&boxhU;"],[0,"&boxHU;"],[0,"&boxvH;"],[0,"&boxVh;"],[0,"&boxVH;"],[19,"&uhblk;"],[3,"&lhblk;"],[3,"&block;"],[8,"&blk14;"],[0,"&blk12;"],[0,"&blk34;"],[13,"&square;"],[8,"&blacksquare;"],[0,"&EmptyVerySmallSquare;"],[1,"&rect;"],[0,"&marker;"],[2,"&fltns;"],[1,"&bigtriangleup;"],[0,"&blacktriangle;"],[0,"&triangle;"],[2,"&blacktriangleright;"],[0,"&rtri;"],[3,"&bigtriangledown;"],[0,"&blacktriangledown;"],[0,"&dtri;"],[2,"&blacktriangleleft;"],[0,"&ltri;"],[6,"&loz;"],[0,"&cir;"],[32,"&tridot;"],[2,"&bigcirc;"],[8,"&ultri;"],[0,"&urtri;"],[0,"&lltri;"],[0,"&EmptySmallSquare;"],[0,"&FilledSmallSquare;"],[8,"&bigstar;"],[0,"&star;"],[7,"&phone;"],[49,"&female;"],[1,"&male;"],[29,"&spades;"],[2,"&clubs;"],[1,"&hearts;"],[0,"&diamondsuit;"],[3,"&sung;"],[2,"&flat;"],[0,"&natural;"],[0,"&sharp;"],[163,"&check;"],[3,"&cross;"],[8,"&malt;"],[21,"&sext;"],[33,"&VerticalSeparator;"],[25,"&lbbrk;"],[0,"&rbbrk;"],[84,"&bsolhsub;"],[0,"&suphsol;"],[28,"&LeftDoubleBracket;"],[0,"&RightDoubleBracket;"],[0,"&lang;"],[0,"&rang;"],[0,"&Lang;"],[0,"&Rang;"],[0,"&loang;"],[0,"&roang;"],[7,"&longleftarrow;"],[0,"&longrightarrow;"],[0,"&longleftrightarrow;"],[0,"&DoubleLongLeftArrow;"],[0,"&DoubleLongRightArrow;"],[0,"&DoubleLongLeftRightArrow;"],[1,"&longmapsto;"],[2,"&dzigrarr;"],[258,"&nvlArr;"],[0,"&nvrArr;"],[0,"&nvHarr;"],[0,"&Map;"],[6,"&lbarr;"],[0,"&bkarow;"],[0,"&lBarr;"],[0,"&dbkarow;"],[0,"&drbkarow;"],[0,"&DDotrahd;"],[0,"&UpArrowBar;"],[0,"&DownArrowBar;"],[2,"&Rarrtl;"],[2,"&latail;"],[0,"&ratail;"],[0,"&lAtail;"],[0,"&rAtail;"],[0,"&larrfs;"],[0,"&rarrfs;"],[0,"&larrbfs;"],[0,"&rarrbfs;"],[2,"&nwarhk;"],[0,"&nearhk;"],[0,"&hksearow;"],[0,"&hkswarow;"],[0,"&nwnear;"],[0,"&nesear;"],[0,"&seswar;"],[0,"&swnwar;"],[8,{v:"&rarrc;",n:824,o:"&nrarrc;"}],[1,"&cudarrr;"],[0,"&ldca;"],[0,"&rdca;"],[0,"&cudarrl;"],[0,"&larrpl;"],[2,"&curarrm;"],[0,"&cularrp;"],[7,"&rarrpl;"],[2,"&harrcir;"],[0,"&Uarrocir;"],[0,"&lurdshar;"],[0,"&ldrushar;"],[2,"&LeftRightVector;"],[0,"&RightUpDownVector;"],[0,"&DownLeftRightVector;"],[0,"&LeftUpDownVector;"],[0,"&LeftVectorBar;"],[0,"&RightVectorBar;"],[0,"&RightUpVectorBar;"],[0,"&RightDownVectorBar;"],[0,"&DownLeftVectorBar;"],[0,"&DownRightVectorBar;"],[0,"&LeftUpVectorBar;"],[0,"&LeftDownVectorBar;"],[0,"&LeftTeeVector;"],[0,"&RightTeeVector;"],[0,"&RightUpTeeVector;"],[0,"&RightDownTeeVector;"],[0,"&DownLeftTeeVector;"],[0,"&DownRightTeeVector;"],[0,"&LeftUpTeeVector;"],[0,"&LeftDownTeeVector;"],[0,"&lHar;"],[0,"&uHar;"],[0,"&rHar;"],[0,"&dHar;"],[0,"&luruhar;"],[0,"&ldrdhar;"],[0,"&ruluhar;"],[0,"&rdldhar;"],[0,"&lharul;"],[0,"&llhard;"],[0,"&rharul;"],[0,"&lrhard;"],[0,"&udhar;"],[0,"&duhar;"],[0,"&RoundImplies;"],[0,"&erarr;"],[0,"&simrarr;"],[0,"&larrsim;"],[0,"&rarrsim;"],[0,"&rarrap;"],[0,"&ltlarr;"],[1,"&gtrarr;"],[0,"&subrarr;"],[1,"&suplarr;"],[0,"&lfisht;"],[0,"&rfisht;"],[0,"&ufisht;"],[0,"&dfisht;"],[5,"&lopar;"],[0,"&ropar;"],[4,"&lbrke;"],[0,"&rbrke;"],[0,"&lbrkslu;"],[0,"&rbrksld;"],[0,"&lbrksld;"],[0,"&rbrkslu;"],[0,"&langd;"],[0,"&rangd;"],[0,"&lparlt;"],[0,"&rpargt;"],[0,"&gtlPar;"],[0,"&ltrPar;"],[3,"&vzigzag;"],[1,"&vangrt;"],[0,"&angrtvbd;"],[6,"&ange;"],[0,"&range;"],[0,"&dwangle;"],[0,"&uwangle;"],[0,"&angmsdaa;"],[0,"&angmsdab;"],[0,"&angmsdac;"],[0,"&angmsdad;"],[0,"&angmsdae;"],[0,"&angmsdaf;"],[0,"&angmsdag;"],[0,"&angmsdah;"],[0,"&bemptyv;"],[0,"&demptyv;"],[0,"&cemptyv;"],[0,"&raemptyv;"],[0,"&laemptyv;"],[0,"&ohbar;"],[0,"&omid;"],[0,"&opar;"],[1,"&operp;"],[1,"&olcross;"],[0,"&odsold;"],[1,"&olcir;"],[0,"&ofcir;"],[0,"&olt;"],[0,"&ogt;"],[0,"&cirscir;"],[0,"&cirE;"],[0,"&solb;"],[0,"&bsolb;"],[3,"&boxbox;"],[3,"&trisb;"],[0,"&rtriltri;"],[0,{v:"&LeftTriangleBar;",n:824,o:"&NotLeftTriangleBar;"}],[0,{v:"&RightTriangleBar;",n:824,o:"&NotRightTriangleBar;"}],[11,"&iinfin;"],[0,"&infintie;"],[0,"&nvinfin;"],[4,"&eparsl;"],[0,"&smeparsl;"],[0,"&eqvparsl;"],[5,"&blacklozenge;"],[8,"&RuleDelayed;"],[1,"&dsol;"],[9,"&bigodot;"],[0,"&bigoplus;"],[0,"&bigotimes;"],[1,"&biguplus;"],[1,"&bigsqcup;"],[5,"&iiiint;"],[0,"&fpartint;"],[2,"&cirfnint;"],[0,"&awint;"],[0,"&rppolint;"],[0,"&scpolint;"],[0,"&npolint;"],[0,"&pointint;"],[0,"&quatint;"],[0,"&intlarhk;"],[10,"&pluscir;"],[0,"&plusacir;"],[0,"&simplus;"],[0,"&plusdu;"],[0,"&plussim;"],[0,"&plustwo;"],[1,"&mcomma;"],[0,"&minusdu;"],[2,"&loplus;"],[0,"&roplus;"],[0,"&Cross;"],[0,"&timesd;"],[0,"&timesbar;"],[1,"&smashp;"],[0,"&lotimes;"],[0,"&rotimes;"],[0,"&otimesas;"],[0,"&Otimes;"],[0,"&odiv;"],[0,"&triplus;"],[0,"&triminus;"],[0,"&tritime;"],[0,"&intprod;"],[2,"&amalg;"],[0,"&capdot;"],[1,"&ncup;"],[0,"&ncap;"],[0,"&capand;"],[0,"&cupor;"],[0,"&cupcap;"],[0,"&capcup;"],[0,"&cupbrcap;"],[0,"&capbrcup;"],[0,"&cupcup;"],[0,"&capcap;"],[0,"&ccups;"],[0,"&ccaps;"],[2,"&ccupssm;"],[2,"&And;"],[0,"&Or;"],[0,"&andand;"],[0,"&oror;"],[0,"&orslope;"],[0,"&andslope;"],[1,"&andv;"],[0,"&orv;"],[0,"&andd;"],[0,"&ord;"],[1,"&wedbar;"],[6,"&sdote;"],[3,"&simdot;"],[2,{v:"&congdot;",n:824,o:"&ncongdot;"}],[0,"&easter;"],[0,"&apacir;"],[0,{v:"&apE;",n:824,o:"&napE;"}],[0,"&eplus;"],[0,"&pluse;"],[0,"&Esim;"],[0,"&Colone;"],[0,"&Equal;"],[1,"&ddotseq;"],[0,"&equivDD;"],[0,"&ltcir;"],[0,"&gtcir;"],[0,"&ltquest;"],[0,"&gtquest;"],[0,{v:"&leqslant;",n:824,o:"&nleqslant;"}],[0,{v:"&geqslant;",n:824,o:"&ngeqslant;"}],[0,"&lesdot;"],[0,"&gesdot;"],[0,"&lesdoto;"],[0,"&gesdoto;"],[0,"&lesdotor;"],[0,"&gesdotol;"],[0,"&lap;"],[0,"&gap;"],[0,"&lne;"],[0,"&gne;"],[0,"&lnap;"],[0,"&gnap;"],[0,"&lEg;"],[0,"&gEl;"],[0,"&lsime;"],[0,"&gsime;"],[0,"&lsimg;"],[0,"&gsiml;"],[0,"&lgE;"],[0,"&glE;"],[0,"&lesges;"],[0,"&gesles;"],[0,"&els;"],[0,"&egs;"],[0,"&elsdot;"],[0,"&egsdot;"],[0,"&el;"],[0,"&eg;"],[2,"&siml;"],[0,"&simg;"],[0,"&simlE;"],[0,"&simgE;"],[0,{v:"&LessLess;",n:824,o:"&NotNestedLessLess;"}],[0,{v:"&GreaterGreater;",n:824,o:"&NotNestedGreaterGreater;"}],[1,"&glj;"],[0,"&gla;"],[0,"&ltcc;"],[0,"&gtcc;"],[0,"&lescc;"],[0,"&gescc;"],[0,"&smt;"],[0,"&lat;"],[0,{v:"&smte;",n:65024,o:"&smtes;"}],[0,{v:"&late;",n:65024,o:"&lates;"}],[0,"&bumpE;"],[0,{v:"&PrecedesEqual;",n:824,o:"&NotPrecedesEqual;"}],[0,{v:"&sce;",n:824,o:"&NotSucceedsEqual;"}],[2,"&prE;"],[0,"&scE;"],[0,"&precneqq;"],[0,"&scnE;"],[0,"&prap;"],[0,"&scap;"],[0,"&precnapprox;"],[0,"&scnap;"],[0,"&Pr;"],[0,"&Sc;"],[0,"&subdot;"],[0,"&supdot;"],[0,"&subplus;"],[0,"&supplus;"],[0,"&submult;"],[0,"&supmult;"],[0,"&subedot;"],[0,"&supedot;"],[0,{v:"&subE;",n:824,o:"&nsubE;"}],[0,{v:"&supE;",n:824,o:"&nsupE;"}],[0,"&subsim;"],[0,"&supsim;"],[2,{v:"&subnE;",n:65024,o:"&varsubsetneqq;"}],[0,{v:"&supnE;",n:65024,o:"&varsupsetneqq;"}],[2,"&csub;"],[0,"&csup;"],[0,"&csube;"],[0,"&csupe;"],[0,"&subsup;"],[0,"&supsub;"],[0,"&subsub;"],[0,"&supsup;"],[0,"&suphsub;"],[0,"&supdsub;"],[0,"&forkv;"],[0,"&topfork;"],[0,"&mlcp;"],[8,"&Dashv;"],[1,"&Vdashl;"],[0,"&Barv;"],[0,"&vBar;"],[0,"&vBarv;"],[1,"&Vbar;"],[0,"&Not;"],[0,"&bNot;"],[0,"&rnmid;"],[0,"&cirmid;"],[0,"&midcir;"],[0,"&topcir;"],[0,"&nhpar;"],[0,"&parsim;"],[9,{v:"&parsl;",n:8421,o:"&nparsl;"}],[44343,{n:new Map(restoreDiff([[56476,"&Ascr;"],[1,"&Cscr;"],[0,"&Dscr;"],[2,"&Gscr;"],[2,"&Jscr;"],[0,"&Kscr;"],[2,"&Nscr;"],[0,"&Oscr;"],[0,"&Pscr;"],[0,"&Qscr;"],[1,"&Sscr;"],[0,"&Tscr;"],[0,"&Uscr;"],[0,"&Vscr;"],[0,"&Wscr;"],[0,"&Xscr;"],[0,"&Yscr;"],[0,"&Zscr;"],[0,"&ascr;"],[0,"&bscr;"],[0,"&cscr;"],[0,"&dscr;"],[1,"&fscr;"],[1,"&hscr;"],[0,"&iscr;"],[0,"&jscr;"],[0,"&kscr;"],[0,"&lscr;"],[0,"&mscr;"],[0,"&nscr;"],[1,"&pscr;"],[0,"&qscr;"],[0,"&rscr;"],[0,"&sscr;"],[0,"&tscr;"],[0,"&uscr;"],[0,"&vscr;"],[0,"&wscr;"],[0,"&xscr;"],[0,"&yscr;"],[0,"&zscr;"],[52,"&Afr;"],[0,"&Bfr;"],[1,"&Dfr;"],[0,"&Efr;"],[0,"&Ffr;"],[0,"&Gfr;"],[2,"&Jfr;"],[0,"&Kfr;"],[0,"&Lfr;"],[0,"&Mfr;"],[0,"&Nfr;"],[0,"&Ofr;"],[0,"&Pfr;"],[0,"&Qfr;"],[1,"&Sfr;"],[0,"&Tfr;"],[0,"&Ufr;"],[0,"&Vfr;"],[0,"&Wfr;"],[0,"&Xfr;"],[0,"&Yfr;"],[1,"&afr;"],[0,"&bfr;"],[0,"&cfr;"],[0,"&dfr;"],[0,"&efr;"],[0,"&ffr;"],[0,"&gfr;"],[0,"&hfr;"],[0,"&ifr;"],[0,"&jfr;"],[0,"&kfr;"],[0,"&lfr;"],[0,"&mfr;"],[0,"&nfr;"],[0,"&ofr;"],[0,"&pfr;"],[0,"&qfr;"],[0,"&rfr;"],[0,"&sfr;"],[0,"&tfr;"],[0,"&ufr;"],[0,"&vfr;"],[0,"&wfr;"],[0,"&xfr;"],[0,"&yfr;"],[0,"&zfr;"],[0,"&Aopf;"],[0,"&Bopf;"],[1,"&Dopf;"],[0,"&Eopf;"],[0,"&Fopf;"],[0,"&Gopf;"],[1,"&Iopf;"],[0,"&Jopf;"],[0,"&Kopf;"],[0,"&Lopf;"],[0,"&Mopf;"],[1,"&Oopf;"],[3,"&Sopf;"],[0,"&Topf;"],[0,"&Uopf;"],[0,"&Vopf;"],[0,"&Wopf;"],[0,"&Xopf;"],[0,"&Yopf;"],[1,"&aopf;"],[0,"&bopf;"],[0,"&copf;"],[0,"&dopf;"],[0,"&eopf;"],[0,"&fopf;"],[0,"&gopf;"],[0,"&hopf;"],[0,"&iopf;"],[0,"&jopf;"],[0,"&kopf;"],[0,"&lopf;"],[0,"&mopf;"],[0,"&nopf;"],[0,"&oopf;"],[0,"&popf;"],[0,"&qopf;"],[0,"&ropf;"],[0,"&sopf;"],[0,"&topf;"],[0,"&uopf;"],[0,"&vopf;"],[0,"&wopf;"],[0,"&xopf;"],[0,"&yopf;"],[0,"&zopf;"]]))}],[8906,"&fflig;"],[0,"&filig;"],[0,"&fllig;"],[0,"&ffilig;"],[0,"&ffllig;"]]));const escape_xmlReplacer=/["&'<>$\x80-\uFFFF]/g,xmlCodeMap=new Map([[34,"&quot;"],[38,"&amp;"],[39,"&apos;"],[60,"&lt;"],[62,"&gt;"]]),escape_getCodePoint=null!=String.prototype.codePointAt?(str,index)=>str.codePointAt(index):(c,index)=>55296==(64512&c.charCodeAt(index))?1024*(c.charCodeAt(index)-55296)+c.charCodeAt(index+1)-56320+65536:c.charCodeAt(index);function escape_encodeXML(str){let match,ret="",lastIdx=0;for(;null!==(match=escape_xmlReplacer.exec(str));){const i=match.index,char=str.charCodeAt(i),next=xmlCodeMap.get(char);void 0!==next?(ret+=str.substring(lastIdx,i)+next,lastIdx=i+1):(ret+=`${str.substring(lastIdx,i)}&#x${escape_getCodePoint(str,i).toString(16)};`,lastIdx=escape_xmlReplacer.lastIndex+=Number(55296==(64512&char)))}return ret+str.substr(lastIdx)}function getEscaper(regex,map){return function escape(data){let match,lastIdx=0,result="";for(;match=regex.exec(data);)lastIdx!==match.index&&(result+=data.substring(lastIdx,match.index)),result+=map.get(match[0].charCodeAt(0)),lastIdx=match.index+1;return result+data.substring(lastIdx)}}getEscaper(/[&<>'"]/g,xmlCodeMap);const escape_escapeAttribute=getEscaper(/["&\u00A0]/g,new Map([[34,"&quot;"],[38,"&amp;"],[160,"&nbsp;"]])),escape_escapeText=getEscaper(/[&<>\u00A0]/g,new Map([[38,"&amp;"],[60,"&lt;"],[62,"&gt;"],[160,"&nbsp;"]]));var EntityLevel,EncodingMode;!function(EntityLevel){EntityLevel[EntityLevel.XML=0]="XML",EntityLevel[EntityLevel.HTML=1]="HTML"}(EntityLevel||(EntityLevel={})),function(EncodingMode){EncodingMode[EncodingMode.UTF8=0]="UTF8",EncodingMode[EncodingMode.ASCII=1]="ASCII",EncodingMode[EncodingMode.Extensive=2]="Extensive",EncodingMode[EncodingMode.Attribute=3]="Attribute",EncodingMode[EncodingMode.Text=4]="Text"}(EncodingMode||(EncodingMode={}));const elementNames=new Map(["altGlyph","altGlyphDef","altGlyphItem","animateColor","animateMotion","animateTransform","clipPath","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","foreignObject","glyphRef","linearGradient","radialGradient","textPath"].map((val=>[val.toLowerCase(),val]))),attributeNames=new Map(["definitionURL","attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","diffuseConstant","edgeMode","filterUnits","glyphRef","gradientTransform","gradientUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].map((val=>[val.toLowerCase(),val]))),unencodedElements=new Set(["style","script","xmp","iframe","noembed","noframes","plaintext","noscript"]);function replaceQuotes(value){return value.replace(/"/g,"&quot;")}const singleTag=new Set(["area","base","basefont","br","col","command","embed","frame","hr","img","input","isindex","keygen","link","meta","param","source","track","wbr"]);function render(node,options={}){const nodes="length"in node?node:[node];let output="";for(let i=0;i<nodes.length;i++)output+=renderNode(nodes[i],options);return output}const lib_esm=render;function renderNode(node,options){switch(node.type){case Root:return render(node.children,options);case Doctype:case Directive:return function renderDirective(elem){return`<${elem.data}>`}(node);case Comment:return function renderComment(elem){return`\x3c!--${elem.data}--\x3e`}(node);case CDATA:return function renderCdata(elem){return`<![CDATA[${elem.children[0].data}]]>`}(node);case Script:case Style:case Tag:return function renderTag(elem,opts){var _a;"foreign"===opts.xmlMode&&(elem.name=null!==(_a=elementNames.get(elem.name))&&void 0!==_a?_a:elem.name,elem.parent&&foreignModeIntegrationPoints.has(elem.parent.name)&&(opts={...opts,xmlMode:!1}));!opts.xmlMode&&foreignElements.has(elem.name)&&(opts={...opts,xmlMode:"foreign"});let tag=`<${elem.name}`;const attribs=function formatAttributes(attributes,opts){var _a;if(!attributes)return;const encode=!1===(null!==(_a=opts.encodeEntities)&&void 0!==_a?_a:opts.decodeEntities)?replaceQuotes:opts.xmlMode||"utf8"!==opts.encodeEntities?escape_encodeXML:escape_escapeAttribute;return Object.keys(attributes).map((key=>{var _a,_b;const value=null!==(_a=attributes[key])&&void 0!==_a?_a:"";return"foreign"===opts.xmlMode&&(key=null!==(_b=attributeNames.get(key))&&void 0!==_b?_b:key),opts.emptyAttrs||opts.xmlMode||""!==value?`${key}="${encode(value)}"`:key})).join(" ")}(elem.attribs,opts);attribs&&(tag+=` ${attribs}`);0===elem.children.length&&(opts.xmlMode?!1!==opts.selfClosingTags:opts.selfClosingTags&&singleTag.has(elem.name))?(opts.xmlMode||(tag+=" "),tag+="/>"):(tag+=">",elem.children.length>0&&(tag+=render(elem.children,opts)),!opts.xmlMode&&singleTag.has(elem.name)||(tag+=`</${elem.name}>`));return tag}(node,options);case Text:return function renderText(elem,opts){var _a;let data=elem.data||"";!1===(null!==(_a=opts.encodeEntities)&&void 0!==_a?_a:opts.decodeEntities)||!opts.xmlMode&&elem.parent&&unencodedElements.has(elem.parent.name)||(data=opts.xmlMode||"utf8"!==opts.encodeEntities?escape_encodeXML(data):escape_escapeText(data));return data}(node,options)}}const foreignModeIntegrationPoints=new Set(["mi","mo","mn","ms","mtext","annotation-xml","foreignObject","desc","title"]),foreignElements=new Set(["svg","math"]);function getOuterHTML(node,options){return lib_esm(node,options)}function getInnerHTML(node,options){return hasChildren(node)?node.children.map((node=>getOuterHTML(node,options))).join(""):""}function getText(node){return Array.isArray(node)?node.map(getText).join(""):node_isTag(node)?"br"===node.name?"\n":getText(node.children):isCDATA(node)?getText(node.children):isText(node)?node.data:""}function textContent(node){return Array.isArray(node)?node.map(textContent).join(""):hasChildren(node)&&!isComment(node)?textContent(node.children):isText(node)?node.data:""}function innerText(node){return Array.isArray(node)?node.map(innerText).join(""):hasChildren(node)&&(node.type===ElementType.Tag||isCDATA(node))?innerText(node.children):isText(node)?node.data:""}function getChildren(elem){return hasChildren(elem)?elem.children:[]}function getParent(elem){return elem.parent||null}function getSiblings(elem){const parent=getParent(elem);if(null!=parent)return getChildren(parent);const siblings=[elem];let{prev,next}=elem;for(;null!=prev;)siblings.unshift(prev),({prev}=prev);for(;null!=next;)siblings.push(next),({next}=next);return siblings}function getAttributeValue(elem,name){var _a;return null===(_a=elem.attribs)||void 0===_a?void 0:_a[name]}function hasAttrib(elem,name){return null!=elem.attribs&&Object.prototype.hasOwnProperty.call(elem.attribs,name)&&null!=elem.attribs[name]}function getName(elem){return elem.name}function nextElementSibling(elem){let{next}=elem;for(;null!==next&&!node_isTag(next);)({next}=next);return next}function prevElementSibling(elem){let{prev}=elem;for(;null!==prev&&!node_isTag(prev);)({prev}=prev);return prev}function removeElement(elem){if(elem.prev&&(elem.prev.next=elem.next),elem.next&&(elem.next.prev=elem.prev),elem.parent){const childs=elem.parent.children,childsIndex=childs.lastIndexOf(elem);childsIndex>=0&&childs.splice(childsIndex,1)}elem.next=null,elem.prev=null,elem.parent=null}function replaceElement(elem,replacement){const prev=replacement.prev=elem.prev;prev&&(prev.next=replacement);const next=replacement.next=elem.next;next&&(next.prev=replacement);const parent=replacement.parent=elem.parent;if(parent){const childs=parent.children;childs[childs.lastIndexOf(elem)]=replacement,elem.parent=null}}function appendChild(parent,child){if(removeElement(child),child.next=null,child.parent=parent,parent.children.push(child)>1){const sibling=parent.children[parent.children.length-2];sibling.next=child,child.prev=sibling}else child.prev=null}function append(elem,next){removeElement(next);const{parent}=elem,currNext=elem.next;if(next.next=currNext,next.prev=elem,elem.next=next,next.parent=parent,currNext){if(currNext.prev=next,parent){const childs=parent.children;childs.splice(childs.lastIndexOf(currNext),0,next)}}else parent&&parent.children.push(next)}function prependChild(parent,child){if(removeElement(child),child.parent=parent,child.prev=null,1!==parent.children.unshift(child)){const sibling=parent.children[1];sibling.prev=child,child.next=sibling}else child.next=null}function prepend(elem,prev){removeElement(prev);const{parent}=elem;if(parent){const childs=parent.children;childs.splice(childs.indexOf(elem),0,prev)}elem.prev&&(elem.prev.next=prev),prev.parent=parent,prev.prev=elem.prev,prev.next=elem,elem.prev=prev}function filter(test,node,recurse=!0,limit=1/0){return find(test,Array.isArray(node)?node:[node],recurse,limit)}function find(test,nodes,recurse,limit){const result=[],nodeStack=[nodes],indexStack=[0];for(;;){if(indexStack[0]>=nodeStack[0].length){if(1===indexStack.length)return result;nodeStack.shift(),indexStack.shift();continue}const elem=nodeStack[0][indexStack[0]++];if(test(elem)&&(result.push(elem),--limit<=0))return result;recurse&&hasChildren(elem)&&elem.children.length>0&&(indexStack.unshift(0),nodeStack.unshift(elem.children))}}function findOneChild(test,nodes){return nodes.find(test)}function findOne(test,nodes,recurse=!0){let elem=null;for(let i=0;i<nodes.length&&!elem;i++){const node=nodes[i];node_isTag(node)&&(test(node)?elem=node:recurse&&node.children.length>0&&(elem=findOne(test,node.children,!0)))}return elem}function existsOne(test,nodes){return nodes.some((checked=>node_isTag(checked)&&(test(checked)||existsOne(test,checked.children))))}function findAll(test,nodes){const result=[],nodeStack=[nodes],indexStack=[0];for(;;){if(indexStack[0]>=nodeStack[0].length){if(1===nodeStack.length)return result;nodeStack.shift(),indexStack.shift();continue}const elem=nodeStack[0][indexStack[0]++];node_isTag(elem)&&(test(elem)&&result.push(elem),elem.children.length>0&&(indexStack.unshift(0),nodeStack.unshift(elem.children)))}}const Checks={tag_name:name=>"function"==typeof name?elem=>node_isTag(elem)&&name(elem.name):"*"===name?node_isTag:elem=>node_isTag(elem)&&elem.name===name,tag_type:type=>"function"==typeof type?elem=>type(elem.type):elem=>elem.type===type,tag_contains:data=>"function"==typeof data?elem=>isText(elem)&&data(elem.data):elem=>isText(elem)&&elem.data===data};function getAttribCheck(attrib,value){return"function"==typeof value?elem=>node_isTag(elem)&&value(elem.attribs[attrib]):elem=>node_isTag(elem)&&elem.attribs[attrib]===value}function combineFuncs(a,b){return elem=>a(elem)||b(elem)}function compileTest(options){const funcs=Object.keys(options).map((key=>{const value=options[key];return Object.prototype.hasOwnProperty.call(Checks,key)?Checks[key](value):getAttribCheck(key,value)}));return 0===funcs.length?null:funcs.reduce(combineFuncs)}function testElement(options,node){const test=compileTest(options);return!test||test(node)}function getElements(options,nodes,recurse,limit=1/0){const test=compileTest(options);return test?filter(test,nodes,recurse,limit):[]}function getElementById(id,nodes,recurse=!0){return Array.isArray(nodes)||(nodes=[nodes]),findOne(getAttribCheck("id",id),nodes,recurse)}function getElementsByTagName(tagName,nodes,recurse=!0,limit=1/0){return filter(Checks.tag_name(tagName),nodes,recurse,limit)}function getElementsByTagType(type,nodes,recurse=!0,limit=1/0){return filter(Checks.tag_type(type),nodes,recurse,limit)}function removeSubsets(nodes){let idx=nodes.length;for(;--idx>=0;){const node=nodes[idx];if(idx>0&&nodes.lastIndexOf(node,idx-1)>=0)nodes.splice(idx,1);else for(let ancestor=node.parent;ancestor;ancestor=ancestor.parent)if(nodes.includes(ancestor)){nodes.splice(idx,1);break}}return nodes}var DocumentPosition;function compareDocumentPosition(nodeA,nodeB){const aParents=[],bParents=[];if(nodeA===nodeB)return 0;let current=hasChildren(nodeA)?nodeA:nodeA.parent;for(;current;)aParents.unshift(current),current=current.parent;for(current=hasChildren(nodeB)?nodeB:nodeB.parent;current;)bParents.unshift(current),current=current.parent;const maxIdx=Math.min(aParents.length,bParents.length);let idx=0;for(;idx<maxIdx&&aParents[idx]===bParents[idx];)idx++;if(0===idx)return DocumentPosition.DISCONNECTED;const sharedParent=aParents[idx-1],siblings=sharedParent.children,aSibling=aParents[idx],bSibling=bParents[idx];return siblings.indexOf(aSibling)>siblings.indexOf(bSibling)?sharedParent===nodeB?DocumentPosition.FOLLOWING|DocumentPosition.CONTAINED_BY:DocumentPosition.FOLLOWING:sharedParent===nodeA?DocumentPosition.PRECEDING|DocumentPosition.CONTAINS:DocumentPosition.PRECEDING}function uniqueSort(nodes){return(nodes=nodes.filter(((node,i,arr)=>!arr.includes(node,i+1)))).sort(((a,b)=>{const relative=compareDocumentPosition(a,b);return relative&DocumentPosition.PRECEDING?-1:relative&DocumentPosition.FOLLOWING?1:0})),nodes}function getFeed(doc){const feedRoot=getOneElement(isValidFeed,doc);return feedRoot?"feed"===feedRoot.name?function getAtomFeed(feedRoot){var _a;const childs=feedRoot.children,feed={type:"atom",items:getElementsByTagName("entry",childs).map((item=>{var _a;const{children}=item,entry={media:getMediaElements(children)};addConditionally(entry,"id","id",children),addConditionally(entry,"title","title",children);const href=null===(_a=getOneElement("link",children))||void 0===_a?void 0:_a.attribs.href;href&&(entry.link=href);const description=fetch("summary",children)||fetch("content",children);description&&(entry.description=description);const pubDate=fetch("updated",children);return pubDate&&(entry.pubDate=new Date(pubDate)),entry}))};addConditionally(feed,"id","id",childs),addConditionally(feed,"title","title",childs);const href=null===(_a=getOneElement("link",childs))||void 0===_a?void 0:_a.attribs.href;href&&(feed.link=href);addConditionally(feed,"description","subtitle",childs);const updated=fetch("updated",childs);updated&&(feed.updated=new Date(updated));return addConditionally(feed,"author","email",childs,!0),feed}(feedRoot):function getRssFeed(feedRoot){var _a,_b;const childs=null!==(_b=null===(_a=getOneElement("channel",feedRoot.children))||void 0===_a?void 0:_a.children)&&void 0!==_b?_b:[],feed={type:feedRoot.name.substr(0,3),id:"",items:getElementsByTagName("item",feedRoot.children).map((item=>{const{children}=item,entry={media:getMediaElements(children)};addConditionally(entry,"id","guid",children),addConditionally(entry,"title","title",children),addConditionally(entry,"link","link",children),addConditionally(entry,"description","description",children);const pubDate=fetch("pubDate",children)||fetch("dc:date",children);return pubDate&&(entry.pubDate=new Date(pubDate)),entry}))};addConditionally(feed,"title","title",childs),addConditionally(feed,"link","link",childs),addConditionally(feed,"description","description",childs);const updated=fetch("lastBuildDate",childs);updated&&(feed.updated=new Date(updated));return addConditionally(feed,"author","managingEditor",childs,!0),feed}(feedRoot):null}!function(DocumentPosition){DocumentPosition[DocumentPosition.DISCONNECTED=1]="DISCONNECTED",DocumentPosition[DocumentPosition.PRECEDING=2]="PRECEDING",DocumentPosition[DocumentPosition.FOLLOWING=4]="FOLLOWING",DocumentPosition[DocumentPosition.CONTAINS=8]="CONTAINS",DocumentPosition[DocumentPosition.CONTAINED_BY=16]="CONTAINED_BY"}(DocumentPosition||(DocumentPosition={}));const MEDIA_KEYS_STRING=["url","type","lang"],MEDIA_KEYS_INT=["fileSize","bitrate","framerate","samplingrate","channels","duration","height","width"];function getMediaElements(where){return getElementsByTagName("media:content",where).map((elem=>{const{attribs}=elem,media={medium:attribs.medium,isDefault:!!attribs.isDefault};for(const attrib of MEDIA_KEYS_STRING)attribs[attrib]&&(media[attrib]=attribs[attrib]);for(const attrib of MEDIA_KEYS_INT)attribs[attrib]&&(media[attrib]=parseInt(attribs[attrib],10));return attribs.expression&&(media.expression=attribs.expression),media}))}function getOneElement(tagName,node){return getElementsByTagName(tagName,node,!0,1)[0]}function fetch(tagName,where,recurse=!1){return textContent(getElementsByTagName(tagName,where,recurse,1)).trim()}function addConditionally(obj,prop,tagName,where,recurse=!1){const val=fetch(tagName,where,recurse);val&&(obj[prop]=val)}function isValidFeed(value){return"rss"===value||"feed"===value||"rdf:RDF"===value}function parseDocument(data,options){const handler=new DomHandler(void 0,options);return new Parser(handler,options).end(data),handler.root}function parseDOM(data,options){return parseDocument(data,options).children}function createDomStream(callback,options,elementCallback){const handler=new DomHandler(callback,options,elementCallback);return new Parser(handler,options)}const parseFeedDefaultOptions={xmlMode:!0};function parseFeed(feed,options=parseFeedDefaultOptions){return getFeed(parseDOM(feed,options))}},"../../node_modules/nanoid/non-secure/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{customAlphabet:()=>customAlphabet,nanoid:()=>nanoid});let customAlphabet=(alphabet,defaultSize=21)=>(size=defaultSize)=>{let id="",i=size;for(;i--;)id+=alphabet[Math.random()*alphabet.length|0];return id},nanoid=(size=21)=>{let id="",i=size;for(;i--;)id+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return id}},"../../node_modules/node-webvtt/index.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";const parse=__webpack_require__("../../node_modules/node-webvtt/lib/parser.js").parse,compile=__webpack_require__("../../node_modules/node-webvtt/lib/compiler.js").compile,segment=__webpack_require__("../../node_modules/node-webvtt/lib/segmenter.js").segment,hls=__webpack_require__("../../node_modules/node-webvtt/lib/hls.js");module.exports={parse,compile,segment,hls}},"../../node_modules/node-webvtt/lib/compiler.js":module=>{"use strict";function CompilerError(message,error){this.message=message,this.error=error}function convertTimestamp(time){const hours=pad(function calculateHours(time){return Math.floor(time/60/60)}(time),2),minutes=pad(function calculateMinutes(time){return Math.floor(time/60)%60}(time),2),seconds=pad(function calculateSeconds(time){return Math.floor(time%60)}(time),2),milliseconds=pad(function calculateMs(time){return Math.floor(1e3*(time%1).toFixed(4))}(time),3);return`${hours}:${minutes}:${seconds}.${milliseconds}`}function pad(num,zeroes){let output=`${num}`;for(;output.length<zeroes;)output=`0${output}`;return output}CompilerError.prototype=Object.create(Error.prototype),module.exports={CompilerError,compile:function compile(input){if(!input)throw new CompilerError("Input must be non-null");if("object"!=typeof input)throw new CompilerError("Input must be an object");if(Array.isArray(input))throw new CompilerError("Input cannot be array");if(!input.valid)throw new CompilerError("Input must be valid");let output="WEBVTT\n";if(input.meta){if("object"!=typeof input.meta||Array.isArray(input.meta))throw new CompilerError("Metadata must be an object");Object.entries(input.meta).forEach((i=>{if("string"!=typeof i[1])throw new CompilerError(`Metadata value for "${i[0]}" must be string`);output+=`${i[0]}: ${i[1]}\n`}))}let lastTime=null;return input.cues.forEach(((cue,index)=>{if(lastTime&&lastTime>cue.start)throw new CompilerError(`Cue number ${index} is not in chronological order`);lastTime=cue.start,output+="\n",output+=function compileCue(cue){if("object"!=typeof cue)throw new CompilerError("Cue malformed: not of type object");if("string"!=typeof cue.identifier&&"number"!=typeof cue.identifier&&null!==cue.identifier)throw new CompilerError(`Cue malformed: identifier value is not a string.\n    ${JSON.stringify(cue)}`);if(isNaN(cue.start))throw new CompilerError(`Cue malformed: null start value.\n    ${JSON.stringify(cue)}`);if(isNaN(cue.end))throw new CompilerError(`Cue malformed: null end value.\n    ${JSON.stringify(cue)}`);if(cue.start>=cue.end)throw new CompilerError(`Cue malformed: start timestamp greater than end\n    ${JSON.stringify(cue)}`);if("string"!=typeof cue.text)throw new CompilerError(`Cue malformed: null text value.\n    ${JSON.stringify(cue)}`);if("string"!=typeof cue.styles)throw new CompilerError(`Cue malformed: null styles value.\n    ${JSON.stringify(cue)}`);let output="";cue.identifier.length>0&&(output+=`${cue.identifier}\n`);const startTimestamp=convertTimestamp(cue.start),endTimestamp=convertTimestamp(cue.end);return output+=`${startTimestamp} --\x3e ${endTimestamp}`,output+=cue.styles?` ${cue.styles}`:"",output+=`\n${cue.text}`,output}(cue),output+="\n"})),output}}},"../../node_modules/node-webvtt/lib/hls.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";const segment=__webpack_require__("../../node_modules/node-webvtt/lib/segmenter.js").segment;function pad(num,n){return`${"0".repeat(Math.max(0,n-num.toString().length))}${num}`}function generateSegmentFilename(index){return`${index}.vtt`}function printableTimestamp(timestamp){const ms=(timestamp%1).toFixed(3);timestamp=Math.round(timestamp-ms);const hours=Math.floor(timestamp/3600),mins=Math.floor((timestamp-3600*hours)/60),secs=timestamp-3600*hours-60*mins;return`${`${pad(hours,2)}:`}${pad(mins,2)}:${pad(secs,2)}.${pad(1e3*ms,3)}`}module.exports={hlsSegment:function hlsSegment(input,segmentLength,startOffset){void 0===startOffset&&(startOffset="900000");const segments=segment(input,segmentLength),result=[];return segments.forEach(((seg,i)=>{const content=`WEBVTT\nX-TIMESTAMP-MAP=MPEGTS:${startOffset},LOCAL:00:00:00.000\n\n${function printableCues(cues){const result=[];return cues.forEach((cue=>{result.push(function printableCue(cue){const printable=[];cue.identifier&&printable.push(cue.identifier);const start=printableTimestamp(cue.start),end=printableTimestamp(cue.end),styles=cue.styles?`${cue.styles}`:"";return printable.push(`${start} --\x3e ${end} ${styles}`),printable.push(cue.text),printable.join("\n")}(cue))})),result.join("\n\n")}(seg.cues)}\n`,filename=generateSegmentFilename(i);result.push({filename,content})})),result},hlsSegmentPlaylist:function hlsSegmentPlaylist(input,segmentLength){const segmented=segment(input,segmentLength),printable=function printableSegments(segments){const result=[];return segments.forEach(((seg,i)=>{result.push(`#EXTINF:${seg.duration.toFixed(5)},\n${generateSegmentFilename(i)}`)})),result.join("\n")}(segmented);return`#EXTM3U\n#EXT-X-TARGETDURATION:${Math.round(function findLongestSegment(segments){let max=0;return segments.forEach((seg=>{seg.duration>max&&(max=seg.duration)})),max}(segmented))}\n#EXT-X-VERSION:3\n#EXT-X-MEDIA-SEQUENCE:0\n#EXT-X-PLAYLIST-TYPE:VOD\n${printable}\n#EXT-X-ENDLIST\n`}}},"../../node_modules/node-webvtt/lib/parser.js":module=>{"use strict";function ParserError(message,error){this.message=message,this.error=error}ParserError.prototype=Object.create(Error.prototype);const TIMESTAMP_REGEXP=/([0-9]+)?:?([0-9]{2}):([0-9]{2}\.[0-9]{2,3})/;function validTimestamp(timestamp){return TIMESTAMP_REGEXP.test(timestamp)}function parseTimestamp(timestamp){const matches=timestamp.match(TIMESTAMP_REGEXP);let secs=60*parseFloat(matches[1]||0)*60;return secs+=60*parseFloat(matches[2]),secs+=parseFloat(matches[3]),secs}module.exports={ParserError,parse:function parse(input,options){options||(options={});const{meta=!1,strict=!0}=options;if("string"!=typeof input)throw new ParserError("Input must be a string");const parts=(input=(input=(input=input.trim()).replace(/\r\n/g,"\n")).replace(/\r/g,"\n")).split("\n\n"),header=parts.shift();if(!header.startsWith("WEBVTT"))throw new ParserError('Must start with "WEBVTT"');const headerParts=header.split("\n"),headerComments=headerParts[0].replace("WEBVTT","");if(headerComments.length>0&&" "!==headerComments[0]&&"\t"!==headerComments[0])throw new ParserError("Header comment must start with space or tab");if(0===parts.length&&1===headerParts.length)return{valid:!0,strict,cues:[],errors:[]};if(!meta&&headerParts.length>1&&""!==headerParts[1])throw new ParserError("Missing blank line after signature");const{cues,errors}=function parseCues(cues,strict){const errors=[],parsedCues=cues.map(((cue,i)=>{try{return function parseCue(cue,i,strict){let identifier="",start=0,end=.01,text="",styles="";const lines=cue.split("\n").filter(Boolean);if(lines.length>0&&lines[0].trim().startsWith("NOTE"))return null;if(1===lines.length&&!lines[0].includes("--\x3e"))throw new ParserError(`Cue identifier cannot be standalone (cue #${i})`);if(lines.length>1&&!lines[0].includes("--\x3e")&&!lines[1].includes("--\x3e")){throw new ParserError(`Cue identifier needs to be followed by timestamp (cue #${i})`)}lines.length>1&&lines[1].includes("--\x3e")&&(identifier=lines.shift());const times="string"==typeof lines[0]&&lines[0].split(" --\x3e ");if(2!==times.length||!validTimestamp(times[0])||!validTimestamp(times[1]))throw new ParserError(`Invalid cue timestamp (cue #${i})`);if(start=parseTimestamp(times[0]),end=parseTimestamp(times[1]),strict){if(start>end)throw new ParserError(`Start timestamp greater than end (cue #${i})`);if(end<=start)throw new ParserError(`End must be greater than start (cue #${i})`)}if(!strict&&end<start)throw new ParserError(`End must be greater or equal to start when not strict (cue #${i})`);if(styles=times[1].replace(TIMESTAMP_REGEXP,"").trim(),lines.shift(),text=lines.join("\n"),!text)return!1;return{identifier,start,end,text,styles}}(cue,i,strict)}catch(e){return errors.push(e),null}})).filter(Boolean);return{cues:parsedCues,errors}}(parts,strict);if(strict&&errors.length>0)throw errors[0];const headerMeta=meta?function parseMeta(headerParts){const meta={};return headerParts.slice(1).forEach((header=>{const splitIdx=header.indexOf(":"),key=header.slice(0,splitIdx).trim(),value=header.slice(splitIdx+1).trim();meta[key]=value})),Object.keys(meta).length>0?meta:null}(headerParts):null,result={valid:0===errors.length,strict,cues,errors};return meta&&(result.meta=headerMeta),result}}},"../../node_modules/node-webvtt/lib/segmenter.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";const parse=__webpack_require__("../../node_modules/node-webvtt/lib/parser.js").parse;function alignToSegmentLength(n,segmentLength){return n+=segmentLength-n%segmentLength}const debugging=!1;function debug(m){debugging&&console.log(m)}module.exports={segment:function segment(input,segmentLength){segmentLength=segmentLength||10;const parsed=parse(input),segments=[];let cues=[],queuedCue=null,currentSegmentDuration=0,totalSegmentsDuration=0;return parsed.cues.forEach(((cue,i)=>{const firstCue=0===i,lastCue=i===parsed.cues.length-1,start=cue.start,end=cue.end,nextStart=lastCue?1/0:parsed.cues[i+1].start,cueLength=firstCue?end:end-start,silence=firstCue?0:start-parsed.cues[i-1].end;currentSegmentDuration=currentSegmentDuration+cueLength+silence,debug("------------"),debug(`Cue #${i}, segment #${segments.length+1}`),debug(`Start ${start}`),debug(`End ${end}`),debug(`Length ${cueLength}`),debug(`Total segment duration = ${totalSegmentsDuration}`),debug(`Current segment duration = ${currentSegmentDuration}`),debug(`Start of next = ${nextStart}`),queuedCue&&(cues.push(queuedCue),currentSegmentDuration+=queuedCue.end-totalSegmentsDuration,queuedCue=null),cues.push(cue);let shouldQueue=nextStart-end<segmentLength&&silence<segmentLength&&currentSegmentDuration>segmentLength;if(function shouldSegment(total,length,nextStart,silence){const x=alignToSegmentLength(silence,length),nextCueIsInNextSegment=silence<=length||x+total<nextStart;return nextCueIsInNextSegment&&nextStart-total>=length}(totalSegmentsDuration,segmentLength,nextStart,silence)){const duration=function segmentDuration(lastCue,end,length,currentSegment,totalSegments){let duration=length;currentSegment>length&&(duration=alignToSegmentLength(currentSegment-length,length));duration=lastCue?parseFloat((end-totalSegments).toFixed(2)):Math.round(duration);return duration}(lastCue,end,segmentLength,currentSegmentDuration,totalSegmentsDuration);segments.push({duration,cues}),totalSegmentsDuration+=duration,currentSegmentDuration=0,cues=[]}else shouldQueue=!1;shouldQueue&&(queuedCue=cue)})),segments}}},"../../node_modules/openseadragon/build/openseadragon/openseadragon.js":function(module,exports){var __WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__,$,fullScreenApi;function OpenSeadragon(options){return new OpenSeadragon.Viewer(options)}!function($){$.version={versionStr:"2.4.2",major:parseInt("2",10),minor:parseInt("4",10),revision:parseInt("2",10)};var canvasElement,class2type={"[object Boolean]":"boolean","[object Number]":"number","[object String]":"string","[object Function]":"function","[object Array]":"array","[object Date]":"date","[object RegExp]":"regexp","[object Object]":"object"},toString=Object.prototype.toString,hasOwn=Object.prototype.hasOwnProperty;$.isFunction=function(obj){return"function"===$.type(obj)},$.isArray=Array.isArray||function(obj){return"array"===$.type(obj)},$.isWindow=function(obj){return obj&&"object"==typeof obj&&"setInterval"in obj},$.type=function(obj){return null==obj?String(obj):class2type[toString.call(obj)]||"object"},$.isPlainObject=function(obj){if(!obj||"object"!==OpenSeadragon.type(obj)||obj.nodeType||$.isWindow(obj))return!1;if(obj.constructor&&!hasOwn.call(obj,"constructor")&&!hasOwn.call(obj.constructor.prototype,"isPrototypeOf"))return!1;var lastKey;for(var key in obj)lastKey=key;return void 0===lastKey||hasOwn.call(obj,lastKey)},$.isEmptyObject=function(obj){for(var name in obj)return!1;return!0},$.freezeObject=function(obj){return Object.freeze?$.freezeObject=Object.freeze:$.freezeObject=function(obj){return obj},$.freezeObject(obj)},$.supportsCanvas=(canvasElement=document.createElement("canvas"),!(!$.isFunction(canvasElement.getContext)||!canvasElement.getContext("2d"))),$.isCanvasTainted=function(canvas){var isTainted=!1;try{canvas.getContext("2d").getImageData(0,0,1,1)}catch(e){isTainted=!0}return isTainted},$.pixelDensityRatio=function(){if($.supportsCanvas){var context=document.createElement("canvas").getContext("2d"),devicePixelRatio=window.devicePixelRatio||1,backingStoreRatio=context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1;return Math.max(devicePixelRatio,1)/backingStoreRatio}return 1}()}(OpenSeadragon),function($){$.extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},length=arguments.length,deep=!1,i=1;for("boolean"==typeof target&&(deep=target,target=arguments[1]||{},i=2),"object"==typeof target||OpenSeadragon.isFunction(target)||(target={}),length===i&&(target=this,--i);i<length;i++)if(null!==(options=arguments[i])||void 0!==options)for(name in options)src=target[name],target!==(copy=options[name])&&(deep&&copy&&(OpenSeadragon.isPlainObject(copy)||(copyIsArray=OpenSeadragon.isArray(copy)))?(copyIsArray?(copyIsArray=!1,clone=src&&OpenSeadragon.isArray(src)?src:[]):clone=src&&OpenSeadragon.isPlainObject(src)?src:{},target[name]=OpenSeadragon.extend(deep,clone,copy)):void 0!==copy&&(target[name]=copy));return target};var isIOSDevice=function(){if("object"!=typeof navigator)return!1;var userAgent=navigator.userAgent;return"string"==typeof userAgent&&(-1!==userAgent.indexOf("iPhone")||-1!==userAgent.indexOf("iPad")||-1!==userAgent.indexOf("iPod"))};$.extend($,{DEFAULT_SETTINGS:{xmlPath:null,tileSources:null,tileHost:null,initialPage:0,crossOriginPolicy:!1,ajaxWithCredentials:!1,loadTilesWithAjax:!1,ajaxHeaders:{},panHorizontal:!0,panVertical:!0,constrainDuringPan:!1,wrapHorizontal:!1,wrapVertical:!1,visibilityRatio:.5,minPixelRatio:.5,defaultZoomLevel:0,minZoomLevel:null,maxZoomLevel:null,homeFillsViewer:!1,clickTimeThreshold:300,clickDistThreshold:5,dblClickTimeThreshold:300,dblClickDistThreshold:20,springStiffness:6.5,animationTime:1.2,gestureSettingsMouse:{scrollToZoom:!0,clickToZoom:!0,dblClickToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsTouch:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsPen:{scrollToZoom:!1,clickToZoom:!0,dblClickToZoom:!1,pinchToZoom:!1,zoomToRefPoint:!0,flickEnabled:!1,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},gestureSettingsUnknown:{scrollToZoom:!1,clickToZoom:!1,dblClickToZoom:!0,pinchToZoom:!0,zoomToRefPoint:!0,flickEnabled:!0,flickMinSpeed:120,flickMomentum:.25,pinchRotate:!1},zoomPerClick:2,zoomPerScroll:1.2,zoomPerSecond:1,blendTime:0,alwaysBlend:!1,autoHideControls:!0,immediateRender:!1,minZoomImageRatio:.9,maxZoomPixelRatio:1.1,smoothTileEdgesMinZoom:1.1,iOSDevice:isIOSDevice(),pixelsPerWheelLine:40,pixelsPerArrowPress:40,autoResize:!0,preserveImageSizeOnResize:!1,minScrollDeltaTime:50,rotationIncrement:90,showSequenceControl:!0,sequenceControlAnchor:null,preserveViewport:!1,preserveOverlays:!1,navPrevNextWrap:!1,showNavigationControl:!0,navigationControlAnchor:null,showZoomControl:!0,showHomeControl:!0,showFullPageControl:!0,showRotationControl:!1,showFlipControl:!1,controlsFadeDelay:2e3,controlsFadeLength:1500,mouseNavEnabled:!0,showNavigator:!1,navigatorId:null,navigatorPosition:null,navigatorSizeRatio:.2,navigatorMaintainSizeRatio:!1,navigatorTop:null,navigatorLeft:null,navigatorHeight:null,navigatorWidth:null,navigatorAutoResize:!0,navigatorAutoFade:!0,navigatorRotate:!0,navigatorBackground:"#000",navigatorOpacity:.8,navigatorBorderColor:"#555",navigatorDisplayRegionColor:"#900",degrees:0,flipped:!1,opacity:1,preload:!1,compositeOperation:null,imageSmoothingEnabled:!0,placeholderFillStyle:null,showReferenceStrip:!1,referenceStripScroll:"horizontal",referenceStripElement:null,referenceStripHeight:null,referenceStripWidth:null,referenceStripPosition:"BOTTOM_LEFT",referenceStripSizeRatio:.2,collectionRows:3,collectionColumns:0,collectionLayout:"horizontal",collectionMode:!1,collectionTileSize:800,collectionTileMargin:80,imageLoaderLimit:0,maxImageCacheCount:200,timeout:3e4,useCanvas:!0,prefixUrl:"/images/",navImages:{zoomIn:{REST:"zoomin_rest.png",GROUP:"zoomin_grouphover.png",HOVER:"zoomin_hover.png",DOWN:"zoomin_pressed.png"},zoomOut:{REST:"zoomout_rest.png",GROUP:"zoomout_grouphover.png",HOVER:"zoomout_hover.png",DOWN:"zoomout_pressed.png"},home:{REST:"home_rest.png",GROUP:"home_grouphover.png",HOVER:"home_hover.png",DOWN:"home_pressed.png"},fullpage:{REST:"fullpage_rest.png",GROUP:"fullpage_grouphover.png",HOVER:"fullpage_hover.png",DOWN:"fullpage_pressed.png"},rotateleft:{REST:"rotateleft_rest.png",GROUP:"rotateleft_grouphover.png",HOVER:"rotateleft_hover.png",DOWN:"rotateleft_pressed.png"},rotateright:{REST:"rotateright_rest.png",GROUP:"rotateright_grouphover.png",HOVER:"rotateright_hover.png",DOWN:"rotateright_pressed.png"},flip:{REST:"flip_rest.png",GROUP:"flip_grouphover.png",HOVER:"flip_hover.png",DOWN:"flip_pressed.png"},previous:{REST:"previous_rest.png",GROUP:"previous_grouphover.png",HOVER:"previous_hover.png",DOWN:"previous_pressed.png"},next:{REST:"next_rest.png",GROUP:"next_grouphover.png",HOVER:"next_hover.png",DOWN:"next_pressed.png"}},debugMode:!1,debugGridColor:["#437AB2","#1B9E77","#D95F02","#7570B3","#E7298A","#66A61E","#E6AB02","#A6761D","#666666"]},SIGNAL:"----seadragon----",delegate:function(object,method){return function(){var args=arguments;return void 0===args&&(args=[]),method.apply(object,args)}},BROWSERS:{UNKNOWN:0,IE:1,FIREFOX:2,SAFARI:3,CHROME:4,OPERA:5},getElement:function(element){return"string"==typeof element&&(element=document.getElementById(element)),element},getElementPosition:function(element){var isFixed,offsetParent,result=new $.Point;for(offsetParent=getOffsetParent(element=$.getElement(element),isFixed="fixed"==$.getElementStyle(element).position);offsetParent;)result.x+=element.offsetLeft,result.y+=element.offsetTop,isFixed&&(result=result.plus($.getPageScroll())),offsetParent=getOffsetParent(element=offsetParent,isFixed="fixed"==$.getElementStyle(element).position);return result},getElementOffset:function(element){var docElement,win,doc=(element=$.getElement(element))&&element.ownerDocument,boundingRect={top:0,left:0};return doc?(docElement=doc.documentElement,void 0!==element.getBoundingClientRect&&(boundingRect=element.getBoundingClientRect()),win=doc==doc.window?doc:9===doc.nodeType&&(doc.defaultView||doc.parentWindow),new $.Point(boundingRect.left+(win.pageXOffset||docElement.scrollLeft)-(docElement.clientLeft||0),boundingRect.top+(win.pageYOffset||docElement.scrollTop)-(docElement.clientTop||0))):new $.Point},getElementSize:function(element){return element=$.getElement(element),new $.Point(element.clientWidth,element.clientHeight)},getElementStyle:document.documentElement.currentStyle?function(element){return(element=$.getElement(element)).currentStyle}:function(element){return element=$.getElement(element),window.getComputedStyle(element,"")},getCssPropertyWithVendorPrefix:function(property){var memo={};return $.getCssPropertyWithVendorPrefix=function(property){if(void 0!==memo[property])return memo[property];var style=document.createElement("div").style,result=null;if(void 0!==style[property])result=property;else for(var prefixes=["Webkit","Moz","MS","O","webkit","moz","ms","o"],suffix=$.capitalizeFirstLetter(property),i=0;i<prefixes.length;i++){var prop=prefixes[i]+suffix;if(void 0!==style[prop]){result=prop;break}}return memo[property]=result,result},$.getCssPropertyWithVendorPrefix(property)},capitalizeFirstLetter:function(string){return string.charAt(0).toUpperCase()+string.slice(1)},positiveModulo:function(number,modulo){var result=number%modulo;return result<0&&(result+=modulo),result},pointInElement:function(element,point){element=$.getElement(element);var offset=$.getElementOffset(element),size=$.getElementSize(element);return point.x>=offset.x&&point.x<offset.x+size.x&&point.y<offset.y+size.y&&point.y>=offset.y},getEvent:function(event){return $.getEvent=event?function(event){return event}:function(){return window.event},$.getEvent(event)},getMousePosition:function(event){if("number"==typeof event.pageX)$.getMousePosition=function(event){var result=new $.Point;return event=$.getEvent(event),result.x=event.pageX,result.y=event.pageY,result};else{if("number"!=typeof event.clientX)throw new Error("Unknown event mouse position, no known technique.");$.getMousePosition=function(event){var result=new $.Point;return event=$.getEvent(event),result.x=event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,result.y=event.clientY+document.body.scrollTop+document.documentElement.scrollTop,result}}return $.getMousePosition(event)},getPageScroll:function(){var docElement=document.documentElement||{},body=document.body||{};if("number"==typeof window.pageXOffset)$.getPageScroll=function(){return new $.Point(window.pageXOffset,window.pageYOffset)};else if(body.scrollLeft||body.scrollTop)$.getPageScroll=function(){return new $.Point(document.body.scrollLeft,document.body.scrollTop)};else{if(!docElement.scrollLeft&&!docElement.scrollTop)return new $.Point(0,0);$.getPageScroll=function(){return new $.Point(document.documentElement.scrollLeft,document.documentElement.scrollTop)}}return $.getPageScroll()},setPageScroll:function(scroll){if(void 0!==window.scrollTo)$.setPageScroll=function(scroll){window.scrollTo(scroll.x,scroll.y)};else{var originalScroll=$.getPageScroll();if(originalScroll.x===scroll.x&&originalScroll.y===scroll.y)return;document.body.scrollLeft=scroll.x,document.body.scrollTop=scroll.y;var currentScroll=$.getPageScroll();if(currentScroll.x!==originalScroll.x&&currentScroll.y!==originalScroll.y)return void($.setPageScroll=function(scroll){document.body.scrollLeft=scroll.x,document.body.scrollTop=scroll.y});if(document.documentElement.scrollLeft=scroll.x,document.documentElement.scrollTop=scroll.y,(currentScroll=$.getPageScroll()).x!==originalScroll.x&&currentScroll.y!==originalScroll.y)return void($.setPageScroll=function(scroll){document.documentElement.scrollLeft=scroll.x,document.documentElement.scrollTop=scroll.y});$.setPageScroll=function(scroll){}}return $.setPageScroll(scroll)},getWindowSize:function(){var docElement=document.documentElement||{},body=document.body||{};if("number"==typeof window.innerWidth)$.getWindowSize=function(){return new $.Point(window.innerWidth,window.innerHeight)};else if(docElement.clientWidth||docElement.clientHeight)$.getWindowSize=function(){return new $.Point(document.documentElement.clientWidth,document.documentElement.clientHeight)};else{if(!body.clientWidth&&!body.clientHeight)throw new Error("Unknown window size, no known technique.");$.getWindowSize=function(){return new $.Point(document.body.clientWidth,document.body.clientHeight)}}return $.getWindowSize()},makeCenteredNode:function(element){element=$.getElement(element);var wrappers=[$.makeNeutralElement("div"),$.makeNeutralElement("div"),$.makeNeutralElement("div")];return $.extend(wrappers[0].style,{display:"table",height:"100%",width:"100%"}),$.extend(wrappers[1].style,{display:"table-row"}),$.extend(wrappers[2].style,{display:"table-cell",verticalAlign:"middle",textAlign:"center"}),wrappers[0].appendChild(wrappers[1]),wrappers[1].appendChild(wrappers[2]),wrappers[2].appendChild(element),wrappers[0]},makeNeutralElement:function(tagName){var element=document.createElement(tagName),style=element.style;return style.background="transparent none",style.border="none",style.margin="0px",style.padding="0px",style.position="static",element},now:function(){return Date.now?$.now=Date.now:$.now=function(){return(new Date).getTime()},$.now()},makeTransparentImage:function(src){return $.makeTransparentImage=function(src){var img=$.makeNeutralElement("img");return img.src=src,img},$.Browser.vendor==$.BROWSERS.IE&&$.Browser.version<7&&($.makeTransparentImage=function(src){var img=$.makeNeutralElement("img"),element=null;return(element=$.makeNeutralElement("span")).style.display="inline-block",img.onload=function(){element.style.width=element.style.width||img.width+"px",element.style.height=element.style.height||img.height+"px",img.onload=null,img=null},img.src=src,element.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+src+"', sizingMethod='scale')",element}),$.makeTransparentImage(src)},setElementOpacity:function(element,opacity,usesAlpha){var ieFilter;element=$.getElement(element),usesAlpha&&!$.Browser.alpha&&(opacity=Math.round(opacity)),$.Browser.opacity?element.style.opacity=opacity<1?opacity:"":opacity<1?(ieFilter="alpha(opacity="+Math.round(100*opacity)+")",element.style.filter=ieFilter):element.style.filter=""},setElementTouchActionNone:function(element){void 0!==(element=$.getElement(element)).style.touchAction?element.style.touchAction="none":void 0!==element.style.msTouchAction&&(element.style.msTouchAction="none")},addClass:function(element,className){(element=$.getElement(element)).className?-1===(" "+element.className+" ").indexOf(" "+className+" ")&&(element.className+=" "+className):element.className=className},indexOf:function(array,searchElement,fromIndex){return Array.prototype.indexOf?this.indexOf=function(array,searchElement,fromIndex){return array.indexOf(searchElement,fromIndex)}:this.indexOf=function(array,searchElement,fromIndex){var i,length,pivot=fromIndex||0;if(!array)throw new TypeError;if(0===(length=array.length)||pivot>=length)return-1;for(pivot<0&&(pivot=length-Math.abs(pivot)),i=pivot;i<length;i++)if(array[i]===searchElement)return i;return-1},this.indexOf(array,searchElement,fromIndex)},removeClass:function(element,className){var oldClasses,i,newClasses=[];for(oldClasses=(element=$.getElement(element)).className.split(/\s+/),i=0;i<oldClasses.length;i++)oldClasses[i]&&oldClasses[i]!==className&&newClasses.push(oldClasses[i]);element.className=newClasses.join(" ")},addEvent:function(){if(window.addEventListener)return function(element,eventName,handler,useCapture){(element=$.getElement(element)).addEventListener(eventName,handler,useCapture)};if(window.attachEvent)return function(element,eventName,handler,useCapture){(element=$.getElement(element)).attachEvent("on"+eventName,handler)};throw new Error("No known event model.")}(),removeEvent:function(){if(window.removeEventListener)return function(element,eventName,handler,useCapture){(element=$.getElement(element)).removeEventListener(eventName,handler,useCapture)};if(window.detachEvent)return function(element,eventName,handler,useCapture){(element=$.getElement(element)).detachEvent("on"+eventName,handler)};throw new Error("No known event model.")}(),cancelEvent:function(event){(event=$.getEvent(event)).preventDefault?$.cancelEvent=function(event){event.preventDefault()}:$.cancelEvent=function(event){(event=$.getEvent(event)).cancel=!0,event.returnValue=!1},$.cancelEvent(event)},stopEvent:function(event){(event=$.getEvent(event)).stopPropagation?$.stopEvent=function(event){event.stopPropagation()}:$.stopEvent=function(event){(event=$.getEvent(event)).cancelBubble=!0},$.stopEvent(event)},createCallback:function(object,method){var i,initialArgs=[];for(i=2;i<arguments.length;i++)initialArgs.push(arguments[i]);return function(){var i,args=initialArgs.concat([]);for(i=0;i<arguments.length;i++)args.push(arguments[i]);return method.apply(object,args)}},getUrlParameter:function(key){var value=URLPARAMS[key];return value||null},getUrlProtocol:function(url){var match=url.match(/^([a-z]+:)\/\//i);return null===match?window.location.protocol:match[1].toLowerCase()},createAjaxRequest:function(local){var supportActiveX;try{supportActiveX=!!new ActiveXObject("Microsoft.XMLHTTP")}catch(e){supportActiveX=!1}if(supportActiveX)window.XMLHttpRequest?$.createAjaxRequest=function(local){return local?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}:$.createAjaxRequest=function(){return new ActiveXObject("Microsoft.XMLHTTP")};else{if(!window.XMLHttpRequest)throw new Error("Browser doesn't support XMLHttpRequest.");$.createAjaxRequest=function(){return new XMLHttpRequest}}return $.createAjaxRequest(local)},makeAjaxRequest:function(url,onSuccess,onError){var withCredentials,headers,responseType;$.isPlainObject(url)&&(onSuccess=url.success,onError=url.error,withCredentials=url.withCredentials,headers=url.headers,responseType=url.responseType||null,url=url.url);var protocol=$.getUrlProtocol(url),request=$.createAjaxRequest("file:"===protocol);if(!$.isFunction(onSuccess))throw new Error("makeAjaxRequest requires a success callback");request.onreadystatechange=function(){4==request.readyState&&(request.onreadystatechange=function(){},request.status>=200&&request.status<300||0===request.status&&"http:"!==protocol&&"https:"!==protocol?onSuccess(request):($.console.log("AJAX request returned %d: %s",request.status,url),$.isFunction(onError)&&onError(request)))};try{if(request.open("GET",url,!0),responseType&&(request.responseType=responseType),headers)for(var headerName in headers)Object.prototype.hasOwnProperty.call(headers,headerName)&&headers[headerName]&&request.setRequestHeader(headerName,headers[headerName]);withCredentials&&(request.withCredentials=!0),request.send(null)}catch(e){var msg=e.message;if($.Browser.vendor==$.BROWSERS.IE&&$.Browser.version<10&&void 0!==e.number&&-2147024891==e.number&&(msg+="\nSee http://msdn.microsoft.com/en-us/library/ms537505(v=vs.85).aspx#xdomain"),$.console.log("%s while making AJAX request: %s",e.name,msg),request.onreadystatechange=function(){},window.XDomainRequest){var xdr=new window.XDomainRequest;if(xdr){xdr.onload=function(e){$.isFunction(onSuccess)&&onSuccess({responseText:xdr.responseText,status:200,statusText:"OK"})},xdr.onerror=function(e){$.isFunction(onError)&&onError({responseText:xdr.responseText,status:444,statusText:"An error happened. Due to an XDomainRequest deficiency we can not extract any information about this error. Upgrade your browser."})};try{xdr.open("GET",url),xdr.send()}catch(e2){$.isFunction(onError)&&onError(request,e)}}}else $.isFunction(onError)&&onError(request,e)}return request},jsonp:function(options){var script,url=options.url,head=document.head||document.getElementsByTagName("head")[0]||document.documentElement,jsonpCallback=options.callbackName||"openseadragon"+$.now(),previous=window[jsonpCallback],replace="$1"+jsonpCallback+"$2",callbackParam=options.param||"callback",callback=options.callback;url=url.replace(/(\=)\?(&|$)|\?\?/i,replace),url+=(/\?/.test(url)?"&":"?")+callbackParam+"="+jsonpCallback,window[jsonpCallback]=function(response){if(previous)window[jsonpCallback]=previous;else try{delete window[jsonpCallback]}catch(e){}callback&&$.isFunction(callback)&&callback(response)},script=document.createElement("script"),void 0===options.async&&!1===options.async||(script.async="async"),options.scriptCharset&&(script.charset=options.scriptCharset),script.src=url,script.onload=script.onreadystatechange=function(_,isAbort){(isAbort||!script.readyState||/loaded|complete/.test(script.readyState))&&(script.onload=script.onreadystatechange=null,head&&script.parentNode&&head.removeChild(script),script=void 0)},head.insertBefore(script,head.firstChild)},createFromDZI:function(){throw"OpenSeadragon.createFromDZI is deprecated, use Viewer.open."},parseXml:function(string){if(window.DOMParser)$.parseXml=function(string){return(new DOMParser).parseFromString(string,"text/xml")};else{if(!window.ActiveXObject)throw new Error("Browser doesn't support XML DOM.");$.parseXml=function(string){var xmlDoc=null;return(xmlDoc=new ActiveXObject("Microsoft.XMLDOM")).async=!1,xmlDoc.loadXML(string),xmlDoc}}return $.parseXml(string)},parseJSON:function(string){return window.JSON&&window.JSON.parse?$.parseJSON=window.JSON.parse:$.parseJSON=function(string){return eval("("+string+")")},$.parseJSON(string)},imageFormatSupported:function(extension){return!!FILEFORMATS[(extension=extension||"").toLowerCase()]}});var nullfunction=function(msg){};$.console=window.console||{log:nullfunction,debug:nullfunction,info:nullfunction,warn:nullfunction,error:nullfunction,assert:nullfunction},$.Browser={vendor:$.BROWSERS.UNKNOWN,version:0,alpha:!0};var FILEFORMATS={bmp:!1,jpeg:!0,jpg:!0,png:!0,tif:!1,wdp:!1},URLPARAMS={};function getOffsetParent(element,isFixed){return isFixed&&element!=document.body?document.body:element.offsetParent}!function(){var ver=navigator.appVersion,ua=navigator.userAgent;switch(navigator.appName){case"Microsoft Internet Explorer":window.attachEvent&&window.ActiveXObject&&($.Browser.vendor=$.BROWSERS.IE,$.Browser.version=parseFloat(ua.substring(ua.indexOf("MSIE")+5,ua.indexOf(";",ua.indexOf("MSIE")))));break;case"Netscape":window.addEventListener&&(ua.indexOf("Firefox")>=0?($.Browser.vendor=$.BROWSERS.FIREFOX,$.Browser.version=parseFloat(ua.substring(ua.indexOf("Firefox")+8))):ua.indexOf("Safari")>=0?($.Browser.vendor=ua.indexOf("Chrome")>=0?$.BROWSERS.CHROME:$.BROWSERS.SAFARI,$.Browser.version=parseFloat(ua.substring(ua.substring(0,ua.indexOf("Safari")).lastIndexOf("/")+1,ua.indexOf("Safari")))):null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(ua)&&($.Browser.vendor=$.BROWSERS.IE,$.Browser.version=parseFloat(RegExp.$1)));break;case"Opera":$.Browser.vendor=$.BROWSERS.OPERA,$.Browser.version=parseFloat(ver)}var part,sep,i,parts=window.location.search.substring(1).split("&");for(i=0;i<parts.length;i++)if((sep=(part=parts[i]).indexOf("="))>0){var key=part.substring(0,sep),value=part.substring(sep+1);try{URLPARAMS[key]=decodeURIComponent(value)}catch(e){$.console.error("Ignoring malformed URL parameter: %s=%s",key,value)}}$.Browser.alpha=!($.Browser.vendor==$.BROWSERS.IE&&$.Browser.version<9||$.Browser.vendor==$.BROWSERS.CHROME&&$.Browser.version<2),$.Browser.opacity=!($.Browser.vendor==$.BROWSERS.IE&&$.Browser.version<9)}(),function(w){var requestAnimationFrame=w.requestAnimationFrame||w.mozRequestAnimationFrame||w.webkitRequestAnimationFrame||w.msRequestAnimationFrame,cancelAnimationFrame=w.cancelAnimationFrame||w.mozCancelAnimationFrame||w.webkitCancelAnimationFrame||w.msCancelAnimationFrame;if(requestAnimationFrame&&cancelAnimationFrame)$.requestAnimationFrame=function(){return requestAnimationFrame.apply(w,arguments)},$.cancelAnimationFrame=function(){return cancelAnimationFrame.apply(w,arguments)};else{var iIntervalId,aAnimQueue=[],processing=[],iRequestId=0;$.requestAnimationFrame=function(callback){return aAnimQueue.push([++iRequestId,callback]),iIntervalId||(iIntervalId=setInterval((function(){if(aAnimQueue.length){var time=$.now(),temp=processing;for(processing=aAnimQueue,aAnimQueue=temp;processing.length;)processing.shift()[1](time)}else clearInterval(iIntervalId),iIntervalId=void 0}),20)),iRequestId},$.cancelAnimationFrame=function(requestId){var i,j;for(i=0,j=aAnimQueue.length;i<j;i+=1)if(aAnimQueue[i][0]===requestId)return void aAnimQueue.splice(i,1);for(i=0,j=processing.length;i<j;i+=1)if(processing[i][0]===requestId)return void processing.splice(i,1)}}}(window)}(OpenSeadragon),__WEBPACK_AMD_DEFINE_ARRAY__=[],void 0===(__WEBPACK_AMD_DEFINE_RESULT__="function"==typeof(__WEBPACK_AMD_DEFINE_FACTORY__=function(){return OpenSeadragon})?__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__):__WEBPACK_AMD_DEFINE_FACTORY__)||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__),$=OpenSeadragon,fullScreenApi={supportsFullScreen:!1,isFullScreen:function(){return!1},getFullScreenElement:function(){return null},requestFullScreen:function(){},exitFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",fullScreenErrorEventName:""},document.exitFullscreen?(fullScreenApi.supportsFullScreen=!0,fullScreenApi.getFullScreenElement=function(){return document.fullscreenElement},fullScreenApi.requestFullScreen=function(element){return element.requestFullscreen()},fullScreenApi.exitFullScreen=function(){document.exitFullscreen()},fullScreenApi.fullScreenEventName="fullscreenchange",fullScreenApi.fullScreenErrorEventName="fullscreenerror"):document.msExitFullscreen?(fullScreenApi.supportsFullScreen=!0,fullScreenApi.getFullScreenElement=function(){return document.msFullscreenElement},fullScreenApi.requestFullScreen=function(element){return element.msRequestFullscreen()},fullScreenApi.exitFullScreen=function(){document.msExitFullscreen()},fullScreenApi.fullScreenEventName="MSFullscreenChange",fullScreenApi.fullScreenErrorEventName="MSFullscreenError"):document.webkitExitFullscreen?(fullScreenApi.supportsFullScreen=!0,fullScreenApi.getFullScreenElement=function(){return document.webkitFullscreenElement},fullScreenApi.requestFullScreen=function(element){return element.webkitRequestFullscreen()},fullScreenApi.exitFullScreen=function(){document.webkitExitFullscreen()},fullScreenApi.fullScreenEventName="webkitfullscreenchange",fullScreenApi.fullScreenErrorEventName="webkitfullscreenerror"):document.webkitCancelFullScreen?(fullScreenApi.supportsFullScreen=!0,fullScreenApi.getFullScreenElement=function(){return document.webkitCurrentFullScreenElement},fullScreenApi.requestFullScreen=function(element){return element.webkitRequestFullScreen()},fullScreenApi.exitFullScreen=function(){document.webkitCancelFullScreen()},fullScreenApi.fullScreenEventName="webkitfullscreenchange",fullScreenApi.fullScreenErrorEventName="webkitfullscreenerror"):document.mozCancelFullScreen&&(fullScreenApi.supportsFullScreen=!0,fullScreenApi.getFullScreenElement=function(){return document.mozFullScreenElement},fullScreenApi.requestFullScreen=function(element){return element.mozRequestFullScreen()},fullScreenApi.exitFullScreen=function(){document.mozCancelFullScreen()},fullScreenApi.fullScreenEventName="mozfullscreenchange",fullScreenApi.fullScreenErrorEventName="mozfullscreenerror"),fullScreenApi.isFullScreen=function(){return null!==fullScreenApi.getFullScreenElement()},fullScreenApi.cancelFullScreen=function(){$.console.error("cancelFullScreen is deprecated. Use exitFullScreen instead."),fullScreenApi.exitFullScreen()},$.extend($,fullScreenApi),function($){$.EventSource=function(){this.events={}},$.EventSource.prototype={addOnceHandler:function(eventName,handler,userData,times){var self=this;times=times||1;var count=0,onceHandler=function(event){++count===times&&self.removeHandler(eventName,onceHandler),handler(event)};this.addHandler(eventName,onceHandler,userData)},addHandler:function(eventName,handler,userData){var events=this.events[eventName];events||(this.events[eventName]=events=[]),handler&&$.isFunction(handler)&&(events[events.length]={handler,userData:userData||null})},removeHandler:function(eventName,handler){var i,events=this.events[eventName],handlers=[];if(events&&$.isArray(events)){for(i=0;i<events.length;i++)events[i].handler!==handler&&handlers.push(events[i]);this.events[eventName]=handlers}},removeAllHandlers:function(eventName){if(eventName)this.events[eventName]=[];else for(var eventType in this.events)this.events[eventType]=[]},getHandler:function(eventName){var events=this.events[eventName];return events&&events.length?(events=1===events.length?[events[0]]:Array.apply(null,events),function(source,args){var i,length=events.length;for(i=0;i<length;i++)events[i]&&(args.eventSource=source,args.userData=events[i].userData,events[i].handler(args))}):null},raiseEvent:function(eventName,eventArgs){var handler=this.getHandler(eventName);handler&&(eventArgs||(eventArgs={}),handler(this,eventArgs))}}}(OpenSeadragon),function($){var trackerPoints,intervalId,lastTime,_generateGuid,_doTracking,divElement,MOUSETRACKERS=[],THIS={};function clearTrackedPointers(tracker){var i,delegate=THIS[tracker.hash],pointerListCount=delegate.activePointersLists.length;for(i=0;i<pointerListCount;i++)delegate.activePointersLists[i].captureCount>0&&($.removeEvent($.MouseTracker.captureElement,"mousemove",delegate.mousemovecaptured,!0),$.removeEvent($.MouseTracker.captureElement,"mouseup",delegate.mouseupcaptured,!0),$.removeEvent($.MouseTracker.captureElement,$.MouseTracker.unprefixedPointerEvents?"pointermove":"MSPointerMove",delegate.pointermovecaptured,!0),$.removeEvent($.MouseTracker.captureElement,$.MouseTracker.unprefixedPointerEvents?"pointerup":"MSPointerUp",delegate.pointerupcaptured,!0),$.removeEvent($.MouseTracker.captureElement,"touchmove",delegate.touchmovecaptured,!0),$.removeEvent($.MouseTracker.captureElement,"touchend",delegate.touchendcaptured,!0),delegate.activePointersLists[i].captureCount=0);for(i=0;i<pointerListCount;i++)delegate.activePointersLists.pop()}function stopTracking(tracker){var event,i,delegate=THIS[tracker.hash];if(delegate.tracking){for(i=0;i<$.MouseTracker.subscribeEvents.length;i++)event=$.MouseTracker.subscribeEvents[i],$.removeEvent(tracker.element,event,delegate[event],!1);clearTrackedPointers(tracker),delegate.tracking=!1}}function getCaptureEventParams(tracker,pointerType){var delegate=THIS[tracker.hash];if("pointerevent"===pointerType)return{upName:$.MouseTracker.unprefixedPointerEvents?"pointerup":"MSPointerUp",upHandler:delegate.pointerupcaptured,moveName:$.MouseTracker.unprefixedPointerEvents?"pointermove":"MSPointerMove",moveHandler:delegate.pointermovecaptured};if("mouse"===pointerType)return{upName:"mouseup",upHandler:delegate.mouseupcaptured,moveName:"mousemove",moveHandler:delegate.mousemovecaptured};if("touch"===pointerType)return{upName:"touchend",upHandler:delegate.touchendcaptured,moveName:"touchmove",moveHandler:delegate.touchmovecaptured};throw new Error("MouseTracker.getCaptureEventParams: Unknown pointer type.")}function capturePointer(tracker,pointerType,pointerCount){var eventParams,pointsList=tracker.getActivePointersListByType(pointerType);pointsList.captureCount+=pointerCount||1,1===pointsList.captureCount&&($.Browser.vendor===$.BROWSERS.IE&&$.Browser.version<9?tracker.element.setCapture(!0):(eventParams=getCaptureEventParams(tracker,$.MouseTracker.havePointerEvents?"pointerevent":pointerType),isInIframe&&canAccessEvents(window.top)&&$.addEvent(window.top,eventParams.upName,eventParams.upHandler,!0),$.addEvent($.MouseTracker.captureElement,eventParams.upName,eventParams.upHandler,!0),$.addEvent($.MouseTracker.captureElement,eventParams.moveName,eventParams.moveHandler,!0)))}function releasePointer(tracker,pointerType,pointerCount){var eventParams,pointsList=tracker.getActivePointersListByType(pointerType);pointsList.captureCount-=pointerCount||1,0===pointsList.captureCount&&($.Browser.vendor===$.BROWSERS.IE&&$.Browser.version<9?tracker.element.releaseCapture():(eventParams=getCaptureEventParams(tracker,$.MouseTracker.havePointerEvents?"pointerevent":pointerType),isInIframe&&canAccessEvents(window.top)&&$.removeEvent(window.top,eventParams.upName,eventParams.upHandler,!0),$.removeEvent($.MouseTracker.captureElement,eventParams.moveName,eventParams.moveHandler,!0),$.removeEvent($.MouseTracker.captureElement,eventParams.upName,eventParams.upHandler,!0)))}function getPointerType(event){var pointerTypeStr;if($.MouseTracker.unprefixedPointerEvents)pointerTypeStr=event.pointerType;else switch(event.pointerType){case 2:pointerTypeStr="touch";break;case 3:pointerTypeStr="pen";break;case 4:pointerTypeStr="mouse";break;default:pointerTypeStr=""}return pointerTypeStr}function getMouseAbsolute(event){return $.getMousePosition(event)}function getMouseRelative(event,element){return getPointRelativeToAbsolute(getMouseAbsolute(event),element)}function getPointRelativeToAbsolute(point,element){var offset=$.getElementOffset(element);return point.minus(offset)}function getCenterPoint(point1,point2){return new $.Point((point1.x+point2.x)/2,(point1.y+point2.y)/2)}function onMouseWheel(tracker,event){var simulatedEvent={target:(event=$.getEvent(event)).target||event.srcElement,type:"wheel",shiftKey:event.shiftKey||!1,clientX:event.clientX,clientY:event.clientY,pageX:event.pageX?event.pageX:event.clientX,pageY:event.pageY?event.pageY:event.clientY,deltaMode:"MozMousePixelScroll"==event.type?0:1,deltaX:0,deltaZ:0};"mousewheel"==$.MouseTracker.wheelEventName?simulatedEvent.deltaY=-event.wheelDelta/$.DEFAULT_SETTINGS.pixelsPerWheelLine:simulatedEvent.deltaY=event.detail,handleWheelEvent(tracker,simulatedEvent,event)}function handleWheelEvent(tracker,event,originalEvent){var nDelta;nDelta=event.deltaY<0?1:-1,tracker.scrollHandler&&!1===tracker.scrollHandler({eventSource:tracker,pointerType:"mouse",position:getMouseRelative(event,tracker.element),scroll:nDelta,shift:event.shiftKey,isTouchEvent:!1,originalEvent,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(originalEvent)}function isParentChild(parent,child){if(parent===child)return!1;for(;child&&child!==parent;)child=child.parentNode;return child===parent}function handleMouseEnter(tracker,event){updatePointersEnter(tracker,event,[{id:$.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:getMouseAbsolute(event),currentTime:$.now()}])}function handleMouseExit(tracker,event){updatePointersExit(tracker,event,[{id:$.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:getMouseAbsolute(event),currentTime:$.now()}])}function getStandardizedButton(button){return $.Browser.vendor===$.BROWSERS.IE&&$.Browser.version<9?1===button?0:2===button?2:4===button?1:-1:button}function handleMouseUp(tracker,event){updatePointersUp(tracker,event=$.getEvent(event),[{id:$.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:getMouseAbsolute(event),currentTime:$.now()}],getStandardizedButton(event.button))&&releasePointer(tracker,"mouse")}function handleMouseMove(tracker,event){updatePointersMove(tracker,event=$.getEvent(event),[{id:$.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:getMouseAbsolute(event),currentTime:$.now()}])}function abortContacts(tracker,event,pointsList){var i,gPointCount=pointsList.getLength(),abortGPoints=[];if("touch"===pointsList.type||pointsList.contacts>0){for(i=0;i<gPointCount;i++)abortGPoints.push(pointsList.getByIndex(i));abortGPoints.length>0&&(updatePointersUp(tracker,event,abortGPoints,0),pointsList.captureCount=1,releasePointer(tracker,pointsList.type),updatePointersExit(tracker,event,abortGPoints))}}function handleTouchEnd(tracker,event){var time,i,j,parentGPoints,touchCount=event.changedTouches.length,gPoints=[];for(time=$.now(),i=0;i<touchCount;i++)gPoints.push({id:event.changedTouches[i].identifier,type:"touch",currentPos:getMouseAbsolute(event.changedTouches[i]),currentTime:time});for(updatePointersUp(tracker,event,gPoints,0)&&releasePointer(tracker,"touch",touchCount),updatePointersExit(tracker,event,gPoints),i=0;i<MOUSETRACKERS.length;i++)if(MOUSETRACKERS[i]!==tracker&&MOUSETRACKERS[i].isTracking()&&isParentChild(MOUSETRACKERS[i].element,tracker.element)){for(parentGPoints=[],j=0;j<touchCount;j++)parentGPoints.push({id:event.changedTouches[j].identifier,type:"touch",currentPos:getMouseAbsolute(event.changedTouches[j]),currentTime:time});updatePointersExit(MOUSETRACKERS[i],event,parentGPoints)}$.cancelEvent(event)}function handleTouchMove(tracker,event){var i,touchCount=event.changedTouches.length,gPoints=[];for(i=0;i<touchCount;i++)gPoints.push({id:event.changedTouches[i].identifier,type:"touch",currentPos:getMouseAbsolute(event.changedTouches[i]),currentTime:$.now()});updatePointersMove(tracker,event,gPoints),$.cancelEvent(event)}function onPointerOver(tracker,event){event.currentTarget===event.relatedTarget||isParentChild(event.currentTarget,event.relatedTarget)||updatePointersEnter(tracker,event,[{id:event.pointerId,type:getPointerType(event),isPrimary:event.isPrimary,currentPos:getMouseAbsolute(event),currentTime:$.now()}])}function onPointerOut(tracker,event){event.currentTarget===event.relatedTarget||isParentChild(event.currentTarget,event.relatedTarget)||updatePointersExit(tracker,event,[{id:event.pointerId,type:getPointerType(event),isPrimary:event.isPrimary,currentPos:getMouseAbsolute(event),currentTime:$.now()}])}function onPointerDown(tracker,event){var gPoint;updatePointersDown(tracker,event,[gPoint={id:event.pointerId,type:getPointerType(event),isPrimary:event.isPrimary,currentPos:getMouseAbsolute(event),currentTime:$.now()}],event.button)&&($.stopEvent(event),capturePointer(tracker,gPoint.type)),(tracker.clickHandler||tracker.dblClickHandler||tracker.pressHandler||tracker.dragHandler||tracker.dragEndHandler||tracker.pinchHandler)&&$.cancelEvent(event)}function onPointerUp(tracker,event){handlePointerUp(tracker,event)}function handlePointerUp(tracker,event){var gPoint;updatePointersUp(tracker,event,[gPoint={id:event.pointerId,type:getPointerType(event),isPrimary:event.isPrimary,currentPos:getMouseAbsolute(event),currentTime:$.now()}],event.button)&&releasePointer(tracker,gPoint.type)}function onPointerMove(tracker,event){handlePointerMove(tracker,event)}function handlePointerMove(tracker,event){updatePointersMove(tracker,event,[{id:event.pointerId,type:getPointerType(event),isPrimary:event.isPrimary,currentPos:getMouseAbsolute(event),currentTime:$.now()}])}function onPointerCancel(tracker,event){(function updatePointersCancel(tracker,event,gPoints){updatePointersUp(tracker,event,gPoints,0),updatePointersExit(tracker,event,gPoints)})(tracker,event,[{id:event.pointerId,type:getPointerType(event)}])}function startTrackingPointer(pointsList,gPoint){return Object.prototype.hasOwnProperty.call(gPoint,"isPrimary")||(0===pointsList.getLength()?gPoint.isPrimary=!0:gPoint.isPrimary=!1),gPoint.speed=0,gPoint.direction=0,gPoint.contactPos=gPoint.currentPos,gPoint.contactTime=gPoint.currentTime,gPoint.lastPos=gPoint.currentPos,gPoint.lastTime=gPoint.currentTime,pointsList.add(gPoint)}function stopTrackingPointer(pointsList,gPoint){var listLength,primaryPoint;return pointsList.getById(gPoint.id)?(listLength=pointsList.removeById(gPoint.id),Object.prototype.hasOwnProperty.call(gPoint,"isPrimary")||(primaryPoint=pointsList.getPrimary())||(primaryPoint=pointsList.getByIndex(0))&&(primaryPoint.isPrimary=!0)):listLength=pointsList.getLength(),listLength}function updatePointersEnter(tracker,event,gPoints){var i,curGPoint,updateGPoint,pointsList=tracker.getActivePointersListByType(gPoints[0].type),gPointCount=gPoints.length;for(i=0;i<gPointCount;i++)curGPoint=gPoints[i],(updateGPoint=pointsList.getById(curGPoint.id))?(updateGPoint.insideElement=!0,updateGPoint.lastPos=updateGPoint.currentPos,updateGPoint.lastTime=updateGPoint.currentTime,updateGPoint.currentPos=curGPoint.currentPos,updateGPoint.currentTime=curGPoint.currentTime,curGPoint=updateGPoint):(curGPoint.captured=!1,curGPoint.insideElementPressed=!1,curGPoint.insideElement=!0,startTrackingPointer(pointsList,curGPoint)),tracker.enterHandler&&!1===tracker.enterHandler({eventSource:tracker,pointerType:curGPoint.type,position:getPointRelativeToAbsolute(curGPoint.currentPos,tracker.element),buttons:pointsList.buttons,pointers:tracker.getActivePointerCount(),insideElementPressed:curGPoint.insideElementPressed,buttonDownAny:0!==pointsList.buttons,isTouchEvent:"touch"===curGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event)}function updatePointersExit(tracker,event,gPoints){var i,curGPoint,updateGPoint,pointsList=tracker.getActivePointersListByType(gPoints[0].type),gPointCount=gPoints.length;for(i=0;i<gPointCount;i++)curGPoint=gPoints[i],(updateGPoint=pointsList.getById(curGPoint.id))&&(updateGPoint.captured?(updateGPoint.insideElement=!1,updateGPoint.lastPos=updateGPoint.currentPos,updateGPoint.lastTime=updateGPoint.currentTime,updateGPoint.currentPos=curGPoint.currentPos,updateGPoint.currentTime=curGPoint.currentTime):stopTrackingPointer(pointsList,updateGPoint),curGPoint=updateGPoint),tracker.exitHandler&&!1===tracker.exitHandler({eventSource:tracker,pointerType:curGPoint.type,position:curGPoint.currentPos&&getPointRelativeToAbsolute(curGPoint.currentPos,tracker.element),buttons:pointsList.buttons,pointers:tracker.getActivePointerCount(),insideElementPressed:!!updateGPoint&&updateGPoint.insideElementPressed,buttonDownAny:0!==pointsList.buttons,isTouchEvent:"touch"===curGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event)}function updatePointersDown(tracker,event,gPoints,buttonChanged){var i,curGPoint,updateGPoint,delegate=THIS[tracker.hash],pointsList=tracker.getActivePointersListByType(gPoints[0].type),gPointCount=gPoints.length;void 0!==event.buttons?pointsList.buttons=event.buttons:$.Browser.vendor===$.BROWSERS.IE&&$.Browser.version<9?0===buttonChanged?pointsList.buttons+=1:1===buttonChanged?pointsList.buttons+=4:2===buttonChanged?pointsList.buttons+=2:3===buttonChanged?pointsList.buttons+=8:4===buttonChanged?pointsList.buttons+=16:5===buttonChanged&&(pointsList.buttons+=32):0===buttonChanged?pointsList.buttons|=1:1===buttonChanged?pointsList.buttons|=4:2===buttonChanged?pointsList.buttons|=2:3===buttonChanged?pointsList.buttons|=8:4===buttonChanged?pointsList.buttons|=16:5===buttonChanged&&(pointsList.buttons|=32);var otherPointsLists=tracker.getActivePointersListsExceptType(gPoints[0].type);for(i=0;i<otherPointsLists.length;i++)abortContacts(tracker,event,otherPointsLists[i]);if(0!==buttonChanged)return tracker.nonPrimaryPressHandler&&!1===tracker.nonPrimaryPressHandler({eventSource:tracker,pointerType:gPoints[0].type,position:getPointRelativeToAbsolute(gPoints[0].currentPos,tracker.element),button:buttonChanged,buttons:pointsList.buttons,isTouchEvent:"touch"===gPoints[0].type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event),!1;for(i=0;i<gPointCount;i++)curGPoint=gPoints[i],(updateGPoint=pointsList.getById(curGPoint.id))?(updateGPoint.captured=!0,updateGPoint.insideElementPressed=!0,updateGPoint.insideElement=!0,updateGPoint.contactPos=curGPoint.currentPos,updateGPoint.contactTime=curGPoint.currentTime,updateGPoint.lastPos=updateGPoint.currentPos,updateGPoint.lastTime=updateGPoint.currentTime,updateGPoint.currentPos=curGPoint.currentPos,updateGPoint.currentTime=curGPoint.currentTime,curGPoint=updateGPoint):(curGPoint.captured=!0,curGPoint.insideElementPressed=!0,curGPoint.insideElement=!0,startTrackingPointer(pointsList,curGPoint)),pointsList.addContact(),(tracker.dragHandler||tracker.dragEndHandler||tracker.pinchHandler)&&$.MouseTracker.gesturePointVelocityTracker.addPoint(tracker,curGPoint),1===pointsList.contacts?tracker.pressHandler&&!1===tracker.pressHandler({eventSource:tracker,pointerType:curGPoint.type,position:getPointRelativeToAbsolute(curGPoint.contactPos,tracker.element),buttons:pointsList.buttons,isTouchEvent:"touch"===curGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event):2===pointsList.contacts&&tracker.pinchHandler&&"touch"===curGPoint.type&&(delegate.pinchGPoints=pointsList.asArray(),delegate.lastPinchDist=delegate.currentPinchDist=delegate.pinchGPoints[0].currentPos.distanceTo(delegate.pinchGPoints[1].currentPos),delegate.lastPinchCenter=delegate.currentPinchCenter=getCenterPoint(delegate.pinchGPoints[0].currentPos,delegate.pinchGPoints[1].currentPos));return!0}function updatePointersUp(tracker,event,gPoints,buttonChanged){var releasePoint,releaseTime,i,curGPoint,updateGPoint,quick,delegate=THIS[tracker.hash],pointsList=tracker.getActivePointersListByType(gPoints[0].type),gPointCount=gPoints.length,releaseCapture=!1,wasCaptured=!1;if(void 0!==event.buttons?pointsList.buttons=event.buttons:$.Browser.vendor===$.BROWSERS.IE&&$.Browser.version<9?0===buttonChanged?pointsList.buttons-=1:1===buttonChanged?pointsList.buttons-=4:2===buttonChanged?pointsList.buttons-=2:3===buttonChanged?pointsList.buttons-=8:4===buttonChanged?pointsList.buttons-=16:5===buttonChanged&&(pointsList.buttons-=32):0===buttonChanged?pointsList.buttons^=-2:1===buttonChanged?pointsList.buttons^=-5:2===buttonChanged?pointsList.buttons^=-3:3===buttonChanged?pointsList.buttons^=-9:4===buttonChanged?pointsList.buttons^=-17:5===buttonChanged&&(pointsList.buttons^=-33),0!==buttonChanged){tracker.nonPrimaryReleaseHandler&&!1===tracker.nonPrimaryReleaseHandler({eventSource:tracker,pointerType:gPoints[0].type,position:getPointRelativeToAbsolute(gPoints[0].currentPos,tracker.element),button:buttonChanged,buttons:pointsList.buttons,isTouchEvent:"touch"===gPoints[0].type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event);var otherPointsList=tracker.getActivePointersListByType("mouse");return abortContacts(tracker,event,otherPointsList),!1}if(void 0===gPoints[0].currentPos)return abortContacts(tracker,event,pointsList),!1;for(i=0;i<gPointCount;i++)curGPoint=gPoints[i],(updateGPoint=pointsList.getById(curGPoint.id))&&(updateGPoint.captured&&(updateGPoint.captured=!1,releaseCapture=!0,wasCaptured=!0),updateGPoint.lastPos=updateGPoint.currentPos,updateGPoint.lastTime=updateGPoint.currentTime,updateGPoint.currentPos=curGPoint.currentPos,updateGPoint.currentTime=curGPoint.currentTime,updateGPoint.insideElement||stopTrackingPointer(pointsList,updateGPoint),releasePoint=updateGPoint.currentPos,releaseTime=updateGPoint.currentTime,wasCaptured?(pointsList.removeContact(),(tracker.dragHandler||tracker.dragEndHandler||tracker.pinchHandler)&&$.MouseTracker.gesturePointVelocityTracker.removePoint(tracker,updateGPoint),0===pointsList.contacts?(tracker.releaseHandler&&!1===tracker.releaseHandler({eventSource:tracker,pointerType:updateGPoint.type,position:getPointRelativeToAbsolute(releasePoint,tracker.element),buttons:pointsList.buttons,insideElementPressed:updateGPoint.insideElementPressed,insideElementReleased:updateGPoint.insideElement,isTouchEvent:"touch"===updateGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event),tracker.dragEndHandler&&!updateGPoint.currentPos.equals(updateGPoint.contactPos)&&!1===tracker.dragEndHandler({eventSource:tracker,pointerType:updateGPoint.type,position:getPointRelativeToAbsolute(updateGPoint.currentPos,tracker.element),speed:updateGPoint.speed,direction:updateGPoint.direction,shift:event.shiftKey,isTouchEvent:"touch"===updateGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event),(tracker.clickHandler||tracker.dblClickHandler)&&updateGPoint.insideElement&&(quick=releaseTime-updateGPoint.contactTime<=tracker.clickTimeThreshold&&updateGPoint.contactPos.distanceTo(releasePoint)<=tracker.clickDistThreshold,tracker.clickHandler&&!1===tracker.clickHandler({eventSource:tracker,pointerType:updateGPoint.type,position:getPointRelativeToAbsolute(updateGPoint.currentPos,tracker.element),quick,shift:event.shiftKey,isTouchEvent:"touch"===updateGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event),tracker.dblClickHandler&&quick&&(pointsList.clicks++,1===pointsList.clicks?(delegate.lastClickPos=releasePoint,delegate.dblClickTimeOut=setTimeout((function(){pointsList.clicks=0}),tracker.dblClickTimeThreshold)):2===pointsList.clicks&&(clearTimeout(delegate.dblClickTimeOut),pointsList.clicks=0,delegate.lastClickPos.distanceTo(releasePoint)<=tracker.dblClickDistThreshold&&!1===tracker.dblClickHandler({eventSource:tracker,pointerType:updateGPoint.type,position:getPointRelativeToAbsolute(updateGPoint.currentPos,tracker.element),shift:event.shiftKey,isTouchEvent:"touch"===updateGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event),delegate.lastClickPos=null)))):2===pointsList.contacts&&tracker.pinchHandler&&"touch"===updateGPoint.type&&(delegate.pinchGPoints=pointsList.asArray(),delegate.lastPinchDist=delegate.currentPinchDist=delegate.pinchGPoints[0].currentPos.distanceTo(delegate.pinchGPoints[1].currentPos),delegate.lastPinchCenter=delegate.currentPinchCenter=getCenterPoint(delegate.pinchGPoints[0].currentPos,delegate.pinchGPoints[1].currentPos))):tracker.releaseHandler&&!1===tracker.releaseHandler({eventSource:tracker,pointerType:updateGPoint.type,position:getPointRelativeToAbsolute(releasePoint,tracker.element),buttons:pointsList.buttons,insideElementPressed:updateGPoint.insideElementPressed,insideElementReleased:updateGPoint.insideElement,isTouchEvent:"touch"===updateGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event));return releaseCapture}function updatePointersMove(tracker,event,gPoints){var i,curGPoint,updateGPoint,gPointArray,delta,delegate=THIS[tracker.hash],pointsList=tracker.getActivePointersListByType(gPoints[0].type),gPointCount=gPoints.length;for(void 0!==event.buttons&&(pointsList.buttons=event.buttons),i=0;i<gPointCount;i++)curGPoint=gPoints[i],(updateGPoint=pointsList.getById(curGPoint.id))?(Object.prototype.hasOwnProperty.call(curGPoint,"isPrimary")&&(updateGPoint.isPrimary=curGPoint.isPrimary),updateGPoint.lastPos=updateGPoint.currentPos,updateGPoint.lastTime=updateGPoint.currentTime,updateGPoint.currentPos=curGPoint.currentPos,updateGPoint.currentTime=curGPoint.currentTime):(curGPoint.captured=!1,curGPoint.insideElementPressed=!1,curGPoint.insideElement=!0,startTrackingPointer(pointsList,curGPoint));tracker.stopHandler&&"mouse"===gPoints[0].type&&(clearTimeout(tracker.stopTimeOut),tracker.stopTimeOut=setTimeout((function(){!function handlePointerStop(tracker,originalMoveEvent,pointerType){tracker.stopHandler&&tracker.stopHandler({eventSource:tracker,pointerType,position:getMouseRelative(originalMoveEvent,tracker.element),buttons:tracker.getActivePointersListByType(pointerType).buttons,isTouchEvent:"touch"===pointerType,originalEvent:originalMoveEvent,preventDefaultAction:!1,userData:tracker.userData})}(tracker,event,gPoints[0].type)}),tracker.stopDelay)),0===pointsList.contacts?tracker.moveHandler&&!1===tracker.moveHandler({eventSource:tracker,pointerType:gPoints[0].type,position:getPointRelativeToAbsolute(gPoints[0].currentPos,tracker.element),buttons:pointsList.buttons,isTouchEvent:"touch"===gPoints[0].type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event):1===pointsList.contacts?(tracker.moveHandler&&(updateGPoint=pointsList.asArray()[0],!1===tracker.moveHandler({eventSource:tracker,pointerType:updateGPoint.type,position:getPointRelativeToAbsolute(updateGPoint.currentPos,tracker.element),buttons:pointsList.buttons,isTouchEvent:"touch"===updateGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event)),tracker.dragHandler&&(delta=(updateGPoint=pointsList.asArray()[0]).currentPos.minus(updateGPoint.lastPos),!1===tracker.dragHandler({eventSource:tracker,pointerType:updateGPoint.type,position:getPointRelativeToAbsolute(updateGPoint.currentPos,tracker.element),buttons:pointsList.buttons,delta,speed:updateGPoint.speed,direction:updateGPoint.direction,shift:event.shiftKey,isTouchEvent:"touch"===updateGPoint.type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event))):2===pointsList.contacts&&(tracker.moveHandler&&(gPointArray=pointsList.asArray(),!1===tracker.moveHandler({eventSource:tracker,pointerType:gPointArray[0].type,position:getPointRelativeToAbsolute(getCenterPoint(gPointArray[0].currentPos,gPointArray[1].currentPos),tracker.element),buttons:pointsList.buttons,isTouchEvent:"touch"===gPointArray[0].type,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event)),tracker.pinchHandler&&"touch"===gPoints[0].type&&(delta=delegate.pinchGPoints[0].currentPos.distanceTo(delegate.pinchGPoints[1].currentPos))!=delegate.currentPinchDist&&(delegate.lastPinchDist=delegate.currentPinchDist,delegate.currentPinchDist=delta,delegate.lastPinchCenter=delegate.currentPinchCenter,delegate.currentPinchCenter=getCenterPoint(delegate.pinchGPoints[0].currentPos,delegate.pinchGPoints[1].currentPos),!1===tracker.pinchHandler({eventSource:tracker,pointerType:"touch",gesturePoints:delegate.pinchGPoints,lastCenter:getPointRelativeToAbsolute(delegate.lastPinchCenter,tracker.element),center:getPointRelativeToAbsolute(delegate.currentPinchCenter,tracker.element),lastDistance:delegate.lastPinchDist,distance:delegate.currentPinchDist,shift:event.shiftKey,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event)))}$.MouseTracker=function(options){MOUSETRACKERS.push(this);var args=arguments;$.isPlainObject(options)||(options={element:args[0],clickTimeThreshold:args[1],clickDistThreshold:args[2]}),this.hash=Math.random(),this.element=$.getElement(options.element),this.clickTimeThreshold=options.clickTimeThreshold||$.DEFAULT_SETTINGS.clickTimeThreshold,this.clickDistThreshold=options.clickDistThreshold||$.DEFAULT_SETTINGS.clickDistThreshold,this.dblClickTimeThreshold=options.dblClickTimeThreshold||$.DEFAULT_SETTINGS.dblClickTimeThreshold,this.dblClickDistThreshold=options.dblClickDistThreshold||$.DEFAULT_SETTINGS.dblClickDistThreshold,this.userData=options.userData||null,this.stopDelay=options.stopDelay||50,this.enterHandler=options.enterHandler||null,this.exitHandler=options.exitHandler||null,this.pressHandler=options.pressHandler||null,this.nonPrimaryPressHandler=options.nonPrimaryPressHandler||null,this.releaseHandler=options.releaseHandler||null,this.nonPrimaryReleaseHandler=options.nonPrimaryReleaseHandler||null,this.moveHandler=options.moveHandler||null,this.scrollHandler=options.scrollHandler||null,this.clickHandler=options.clickHandler||null,this.dblClickHandler=options.dblClickHandler||null,this.dragHandler=options.dragHandler||null,this.dragEndHandler=options.dragEndHandler||null,this.pinchHandler=options.pinchHandler||null,this.stopHandler=options.stopHandler||null,this.keyDownHandler=options.keyDownHandler||null,this.keyUpHandler=options.keyUpHandler||null,this.keyHandler=options.keyHandler||null,this.focusHandler=options.focusHandler||null,this.blurHandler=options.blurHandler||null;var _this=this;THIS[this.hash]={click:function(event){!function onClick(tracker,event){tracker.clickHandler&&$.cancelEvent(event)}(_this,event)},dblclick:function(event){!function onDblClick(tracker,event){tracker.dblClickHandler&&$.cancelEvent(event)}(_this,event)},keydown:function(event){!function onKeyDown(tracker,event){tracker.keyDownHandler&&(event=$.getEvent(event),tracker.keyDownHandler({eventSource:tracker,keyCode:event.keyCode?event.keyCode:event.charCode,ctrl:event.ctrlKey,shift:event.shiftKey,alt:event.altKey,meta:event.metaKey,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})||$.cancelEvent(event))}(_this,event)},keyup:function(event){!function onKeyUp(tracker,event){tracker.keyUpHandler&&(event=$.getEvent(event),tracker.keyUpHandler({eventSource:tracker,keyCode:event.keyCode?event.keyCode:event.charCode,ctrl:event.ctrlKey,shift:event.shiftKey,alt:event.altKey,meta:event.metaKey,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})||$.cancelEvent(event))}(_this,event)},keypress:function(event){!function onKeyPress(tracker,event){tracker.keyHandler&&(event=$.getEvent(event),tracker.keyHandler({eventSource:tracker,keyCode:event.keyCode?event.keyCode:event.charCode,ctrl:event.ctrlKey,shift:event.shiftKey,alt:event.altKey,meta:event.metaKey,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})||$.cancelEvent(event))}(_this,event)},focus:function(event){!function onFocus(tracker,event){tracker.focusHandler&&(event=$.getEvent(event),!1===tracker.focusHandler({eventSource:tracker,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event))}(_this,event)},blur:function(event){!function onBlur(tracker,event){tracker.blurHandler&&(event=$.getEvent(event),!1===tracker.blurHandler({eventSource:tracker,originalEvent:event,preventDefaultAction:!1,userData:tracker.userData})&&$.cancelEvent(event))}(_this,event)},wheel:function(event){!function onWheel(tracker,event){handleWheelEvent(tracker,event,event)}(_this,event)},mousewheel:function(event){onMouseWheel(_this,event)},DOMMouseScroll:function(event){onMouseWheel(_this,event)},MozMousePixelScroll:function(event){onMouseWheel(_this,event)},mouseenter:function(event){!function onMouseEnter(tracker,event){event=$.getEvent(event),handleMouseEnter(tracker,event)}(_this,event)},mouseleave:function(event){!function onMouseLeave(tracker,event){event=$.getEvent(event),handleMouseExit(tracker,event)}(_this,event)},mouseover:function(event){!function onMouseOver(tracker,event){if(event=$.getEvent(event),event.currentTarget===event.relatedTarget||isParentChild(event.currentTarget,event.relatedTarget))return;handleMouseEnter(tracker,event)}(_this,event)},mouseout:function(event){!function onMouseOut(tracker,event){if(event=$.getEvent(event),event.currentTarget===event.relatedTarget||isParentChild(event.currentTarget,event.relatedTarget))return;handleMouseExit(tracker,event)}(_this,event)},mousedown:function(event){!function onMouseDown(tracker,event){var gPoint;event=$.getEvent(event),gPoint={id:$.MouseTracker.mousePointerId,type:"mouse",isPrimary:!0,currentPos:getMouseAbsolute(event),currentTime:$.now()},updatePointersDown(tracker,event,[gPoint],getStandardizedButton(event.button))&&($.stopEvent(event),capturePointer(tracker,"mouse"));(tracker.clickHandler||tracker.dblClickHandler||tracker.pressHandler||tracker.dragHandler||tracker.dragEndHandler)&&$.cancelEvent(event)}(_this,event)},mouseup:function(event){!function onMouseUp(tracker,event){handleMouseUp(tracker,event)}(_this,event)},mouseupcaptured:function(event){!function onMouseUpCaptured(tracker,event){handleMouseUp(tracker,event),$.stopEvent(event)}(_this,event)},mousemove:function(event){!function onMouseMove(tracker,event){handleMouseMove(tracker,event)}(_this,event)},mousemovecaptured:function(event){!function onMouseMoveCaptured(tracker,event){handleMouseMove(tracker,event),$.stopEvent(event)}(_this,event)},touchstart:function(event){!function onTouchStart(tracker,event){var time,i,j,parentGPoints,touchCount=event.changedTouches.length,gPoints=[],pointsList=tracker.getActivePointersListByType("touch");time=$.now(),pointsList.getLength()>event.touches.length-touchCount&&($.console.warn("Tracked touch contact count doesn't match event.touches.length. Removing all tracked touch pointers."),abortContacts(tracker,event,pointsList));for(i=0;i<touchCount;i++)gPoints.push({id:event.changedTouches[i].identifier,type:"touch",currentPos:getMouseAbsolute(event.changedTouches[i]),currentTime:time});for(updatePointersEnter(tracker,event,gPoints),i=0;i<MOUSETRACKERS.length;i++)if(MOUSETRACKERS[i]!==tracker&&MOUSETRACKERS[i].isTracking()&&isParentChild(MOUSETRACKERS[i].element,tracker.element)){for(parentGPoints=[],j=0;j<touchCount;j++)parentGPoints.push({id:event.changedTouches[j].identifier,type:"touch",currentPos:getMouseAbsolute(event.changedTouches[j]),currentTime:time});updatePointersEnter(MOUSETRACKERS[i],event,parentGPoints)}updatePointersDown(tracker,event,gPoints,0)&&($.stopEvent(event),capturePointer(tracker,"touch",touchCount));$.cancelEvent(event)}(_this,event)},touchend:function(event){!function onTouchEnd(tracker,event){handleTouchEnd(tracker,event)}(_this,event)},touchendcaptured:function(event){!function onTouchEndCaptured(tracker,event){handleTouchEnd(tracker,event),$.stopEvent(event)}(_this,event)},touchmove:function(event){!function onTouchMove(tracker,event){handleTouchMove(tracker,event)}(_this,event)},touchmovecaptured:function(event){!function onTouchMoveCaptured(tracker,event){handleTouchMove(tracker,event),$.stopEvent(event)}(_this,event)},touchcancel:function(event){!function onTouchCancel(tracker,event){var pointsList=tracker.getActivePointersListByType("touch");abortContacts(tracker,event,pointsList)}(_this,event)},gesturestart:function(event){!function onGestureStart(tracker,event){return event.stopPropagation(),event.preventDefault(),!1}(0,event)},gesturechange:function(event){!function onGestureChange(tracker,event){return event.stopPropagation(),event.preventDefault(),!1}(0,event)},pointerover:function(event){onPointerOver(_this,event)},MSPointerOver:function(event){onPointerOver(_this,event)},pointerout:function(event){onPointerOut(_this,event)},MSPointerOut:function(event){onPointerOut(_this,event)},pointerdown:function(event){onPointerDown(_this,event)},MSPointerDown:function(event){onPointerDown(_this,event)},pointerup:function(event){onPointerUp(_this,event)},MSPointerUp:function(event){onPointerUp(_this,event)},pointermove:function(event){onPointerMove(_this,event)},MSPointerMove:function(event){onPointerMove(_this,event)},pointercancel:function(event){onPointerCancel(_this,event)},MSPointerCancel:function(event){onPointerCancel(_this,event)},pointerupcaptured:function(event){!function onPointerUpCaptured(tracker,event){var pointsList=tracker.getActivePointersListByType(getPointerType(event));pointsList.getById(event.pointerId)&&handlePointerUp(tracker,event);$.stopEvent(event)}(_this,event)},pointermovecaptured:function(event){!function onPointerMoveCaptured(tracker,event){var pointsList=tracker.getActivePointersListByType(getPointerType(event));pointsList.getById(event.pointerId)&&handlePointerMove(tracker,event);$.stopEvent(event)}(_this,event)},tracking:!1,activePointersLists:[],lastClickPos:null,dblClickTimeOut:null,pinchGPoints:[],lastPinchDist:0,currentPinchDist:0,lastPinchCenter:null,currentPinchCenter:null},options.startDisabled||this.setTracking(!0)},$.MouseTracker.prototype={destroy:function(){var i;for(stopTracking(this),this.element=null,i=0;i<MOUSETRACKERS.length;i++)if(MOUSETRACKERS[i]===this){MOUSETRACKERS.splice(i,1);break}THIS[this.hash]=null,delete THIS[this.hash]},isTracking:function(){return THIS[this.hash].tracking},setTracking:function(track){return track?function startTracking(tracker){var event,i,delegate=THIS[tracker.hash];if(!delegate.tracking){for(i=0;i<$.MouseTracker.subscribeEvents.length;i++)event=$.MouseTracker.subscribeEvents[i],$.addEvent(tracker.element,event,delegate[event],!1);clearTrackedPointers(tracker),delegate.tracking=!0}}(this):stopTracking(this),this},getActivePointersListsExceptType:function(type){for(var delegate=THIS[this.hash],listArray=[],i=0;i<delegate.activePointersLists.length;++i)delegate.activePointersLists[i].type!==type&&listArray.push(delegate.activePointersLists[i]);return listArray},getActivePointersListByType:function(type){var i,list,delegate=THIS[this.hash],len=delegate.activePointersLists.length;for(i=0;i<len;i++)if(delegate.activePointersLists[i].type===type)return delegate.activePointersLists[i];return list=new $.MouseTracker.GesturePointList(type),delegate.activePointersLists.push(list),list},getActivePointerCount:function(){var i,delegate=THIS[this.hash],len=delegate.activePointersLists.length,count=0;for(i=0;i<len;i++)count+=delegate.activePointersLists[i].getLength();return count},enterHandler:function(){},exitHandler:function(){},pressHandler:function(){},nonPrimaryPressHandler:function(){},releaseHandler:function(){},nonPrimaryReleaseHandler:function(){},moveHandler:function(){},scrollHandler:function(){},clickHandler:function(){},dblClickHandler:function(){},dragHandler:function(){},dragEndHandler:function(){},pinchHandler:function(){},stopHandler:function(){},keyDownHandler:function(){},keyUpHandler:function(){},keyHandler:function(){},focusHandler:function(){},blurHandler:function(){}},$.MouseTracker.resetAllMouseTrackers=function(){for(var i=0;i<MOUSETRACKERS.length;i++)MOUSETRACKERS[i].isTracking()&&(MOUSETRACKERS[i].setTracking(!1),MOUSETRACKERS[i].setTracking(!0))},$.MouseTracker.gesturePointVelocityTracker=(trackerPoints=[],intervalId=0,lastTime=0,_generateGuid=function(tracker,gPoint){return tracker.hash.toString()+gPoint.type+gPoint.id.toString()},_doTracking=function(){var i,trackPoint,gPoint,elapsedTime,distance,speed,len=trackerPoints.length,now=$.now();for(elapsedTime=now-lastTime,lastTime=now,i=0;i<len;i++)(gPoint=(trackPoint=trackerPoints[i]).gPoint).direction=Math.atan2(gPoint.currentPos.y-trackPoint.lastPos.y,gPoint.currentPos.x-trackPoint.lastPos.x),distance=trackPoint.lastPos.distanceTo(gPoint.currentPos),trackPoint.lastPos=gPoint.currentPos,speed=1e3*distance/(elapsedTime+1),gPoint.speed=.75*speed+.25*gPoint.speed},{addPoint:function(tracker,gPoint){var guid=_generateGuid(tracker,gPoint);trackerPoints.push({guid,gPoint,lastPos:gPoint.currentPos}),1===trackerPoints.length&&(lastTime=$.now(),intervalId=window.setInterval(_doTracking,50))},removePoint:function(tracker,gPoint){var i,guid=_generateGuid(tracker,gPoint),len=trackerPoints.length;for(i=0;i<len;i++)if(trackerPoints[i].guid===guid){trackerPoints.splice(i,1),0==--len&&window.clearInterval(intervalId);break}}}),$.MouseTracker.captureElement=document,$.MouseTracker.wheelEventName=$.Browser.vendor==$.BROWSERS.IE&&$.Browser.version>8||"onwheel"in document.createElement("div")?"wheel":void 0!==document.onmousewheel?"mousewheel":"DOMMouseScroll",$.MouseTracker.supportsMouseCapture=(divElement=document.createElement("div"),$.isFunction(divElement.setCapture)&&$.isFunction(divElement.releaseCapture)),$.MouseTracker.subscribeEvents=["click","dblclick","keydown","keyup","keypress","focus","blur",$.MouseTracker.wheelEventName],"DOMMouseScroll"==$.MouseTracker.wheelEventName&&$.MouseTracker.subscribeEvents.push("MozMousePixelScroll"),window.PointerEvent&&(window.navigator.pointerEnabled||$.Browser.vendor!==$.BROWSERS.IE)?($.MouseTracker.havePointerEvents=!0,$.MouseTracker.subscribeEvents.push("pointerover","pointerout","pointerdown","pointerup","pointermove","pointercancel"),$.MouseTracker.unprefixedPointerEvents=!0,navigator.maxTouchPoints?$.MouseTracker.maxTouchPoints=navigator.maxTouchPoints:$.MouseTracker.maxTouchPoints=0,$.MouseTracker.haveMouseEnter=!1):window.MSPointerEvent&&window.navigator.msPointerEnabled?($.MouseTracker.havePointerEvents=!0,$.MouseTracker.subscribeEvents.push("MSPointerOver","MSPointerOut","MSPointerDown","MSPointerUp","MSPointerMove","MSPointerCancel"),$.MouseTracker.unprefixedPointerEvents=!1,navigator.msMaxTouchPoints?$.MouseTracker.maxTouchPoints=navigator.msMaxTouchPoints:$.MouseTracker.maxTouchPoints=0,$.MouseTracker.haveMouseEnter=!1):($.MouseTracker.havePointerEvents=!1,$.Browser.vendor===$.BROWSERS.IE&&$.Browser.version<9?($.MouseTracker.subscribeEvents.push("mouseenter","mouseleave"),$.MouseTracker.haveMouseEnter=!0):($.MouseTracker.subscribeEvents.push("mouseover","mouseout"),$.MouseTracker.haveMouseEnter=!1),$.MouseTracker.subscribeEvents.push("mousedown","mouseup","mousemove"),"ontouchstart"in window&&$.MouseTracker.subscribeEvents.push("touchstart","touchend","touchmove","touchcancel"),"ongesturestart"in window&&$.MouseTracker.subscribeEvents.push("gesturestart","gesturechange"),$.MouseTracker.mousePointerId="legacy-mouse",$.MouseTracker.maxTouchPoints=10),$.MouseTracker.GesturePointList=function(type){this._gPoints=[],this.type=type,this.buttons=0,this.contacts=0,this.clicks=0,this.captureCount=0},$.MouseTracker.GesturePointList.prototype={getLength:function(){return this._gPoints.length},asArray:function(){return this._gPoints},add:function(gp){return this._gPoints.push(gp)},removeById:function(id){var i,len=this._gPoints.length;for(i=0;i<len;i++)if(this._gPoints[i].id===id){this._gPoints.splice(i,1);break}return this._gPoints.length},getByIndex:function(index){return index<this._gPoints.length?this._gPoints[index]:null},getById:function(id){var i,len=this._gPoints.length;for(i=0;i<len;i++)if(this._gPoints[i].id===id)return this._gPoints[i];return null},getPrimary:function(id){var i,len=this._gPoints.length;for(i=0;i<len;i++)if(this._gPoints[i].isPrimary)return this._gPoints[i];return null},addContact:function(){++this.contacts,this.contacts>1&&("mouse"===this.type||"pen"===this.type)&&(this.contacts=1)},removeContact:function(){--this.contacts,this.contacts<0&&(this.contacts=0)}};var isInIframe=function(){try{return window.self!==window.top}catch(e){return!0}}();function canAccessEvents(target){try{return target.addEventListener&&target.removeEventListener}catch(e){return!1}}}(OpenSeadragon),function($){$.ControlAnchor={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4,ABSOLUTE:5},$.Control=function(element,options,container){var parent=element.parentNode;"number"==typeof options&&($.console.error("Passing an anchor directly into the OpenSeadragon.Control constructor is deprecated; please use an options object instead.  Support for this deprecated variant is scheduled for removal in December 2013"),options={anchor:options}),options.attachToViewer=void 0===options.attachToViewer||options.attachToViewer,this.autoFade=void 0===options.autoFade||options.autoFade,this.element=element,this.anchor=options.anchor,this.container=container,this.anchor==$.ControlAnchor.ABSOLUTE?(this.wrapper=$.makeNeutralElement("div"),this.wrapper.style.position="absolute",this.wrapper.style.top="number"==typeof options.top?options.top+"px":options.top,this.wrapper.style.left="number"==typeof options.left?options.left+"px":options.left,this.wrapper.style.height="number"==typeof options.height?options.height+"px":options.height,this.wrapper.style.width="number"==typeof options.width?options.width+"px":options.width,this.wrapper.style.margin="0px",this.wrapper.style.padding="0px",this.element.style.position="relative",this.element.style.top="0px",this.element.style.left="0px",this.element.style.height="100%",this.element.style.width="100%"):(this.wrapper=$.makeNeutralElement("div"),this.wrapper.style.display="inline-block",this.anchor==$.ControlAnchor.NONE&&(this.wrapper.style.width=this.wrapper.style.height="100%")),this.wrapper.appendChild(this.element),options.attachToViewer?this.anchor==$.ControlAnchor.TOP_RIGHT||this.anchor==$.ControlAnchor.BOTTOM_RIGHT?this.container.insertBefore(this.wrapper,this.container.firstChild):this.container.appendChild(this.wrapper):parent.appendChild(this.wrapper)},$.Control.prototype={destroy:function(){this.wrapper.removeChild(this.element),this.container.removeChild(this.wrapper)},isVisible:function(){return"none"!=this.wrapper.style.display},setVisible:function(visible){this.wrapper.style.display=visible?this.anchor==$.ControlAnchor.ABSOLUTE?"block":"inline-block":"none"},setOpacity:function(opacity){this.element[$.SIGNAL]&&$.Browser.vendor==$.BROWSERS.IE?$.setElementOpacity(this.element,opacity,!0):$.setElementOpacity(this.wrapper,opacity,!0)}}}(OpenSeadragon),function($){function getControlIndex(dock,element){var i,controls=dock.controls;for(i=controls.length-1;i>=0;i--)if(controls[i].element==element)return i;return-1}$.ControlDock=function(options){var layout,i,layouts=["topleft","topright","bottomright","bottomleft"];for($.extend(!0,this,{id:"controldock-"+$.now()+"-"+Math.floor(1e6*Math.random()),container:$.makeNeutralElement("div"),controls:[]},options),this.container.onsubmit=function(){return!1},this.element&&(this.element=$.getElement(this.element),this.element.appendChild(this.container),this.element.style.position="relative",this.container.style.width="100%",this.container.style.height="100%"),i=0;i<layouts.length;i++)layout=layouts[i],this.controls[layout]=$.makeNeutralElement("div"),this.controls[layout].style.position="absolute",layout.match("left")&&(this.controls[layout].style.left="0px"),layout.match("right")&&(this.controls[layout].style.right="0px"),layout.match("top")&&(this.controls[layout].style.top="0px"),layout.match("bottom")&&(this.controls[layout].style.bottom="0px");this.container.appendChild(this.controls.topleft),this.container.appendChild(this.controls.topright),this.container.appendChild(this.controls.bottomright),this.container.appendChild(this.controls.bottomleft)},$.ControlDock.prototype={addControl:function(element,controlOptions){var div=null;if(!(getControlIndex(this,element=$.getElement(element))>=0)){switch(controlOptions.anchor){case $.ControlAnchor.TOP_RIGHT:div=this.controls.topright,element.style.position="relative",element.style.paddingRight="0px",element.style.paddingTop="0px";break;case $.ControlAnchor.BOTTOM_RIGHT:div=this.controls.bottomright,element.style.position="relative",element.style.paddingRight="0px",element.style.paddingBottom="0px";break;case $.ControlAnchor.BOTTOM_LEFT:div=this.controls.bottomleft,element.style.position="relative",element.style.paddingLeft="0px",element.style.paddingBottom="0px";break;case $.ControlAnchor.TOP_LEFT:div=this.controls.topleft,element.style.position="relative",element.style.paddingLeft="0px",element.style.paddingTop="0px";break;case $.ControlAnchor.ABSOLUTE:default:case $.ControlAnchor.NONE:div=this.container,element.style.margin="0px",element.style.padding="0px"}this.controls.push(new $.Control(element,controlOptions,div)),element.style.display="inline-block"}},removeControl:function(element){var i=getControlIndex(this,element=$.getElement(element));return i>=0&&(this.controls[i].destroy(),this.controls.splice(i,1)),this},clearControls:function(){for(;this.controls.length>0;)this.controls.pop().destroy();return this},areControlsEnabled:function(){var i;for(i=this.controls.length-1;i>=0;i--)if(this.controls[i].isVisible())return!0;return!1},setControlsEnabled:function(enabled){var i;for(i=this.controls.length-1;i>=0;i--)this.controls[i].setVisible(enabled);return this}}}(OpenSeadragon),function($){$.Placement=$.freezeObject({CENTER:0,TOP_LEFT:1,TOP:2,TOP_RIGHT:3,RIGHT:4,BOTTOM_RIGHT:5,BOTTOM:6,BOTTOM_LEFT:7,LEFT:8,properties:{0:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1},1:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},2:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!0,isVerticallyCentered:!1,isBottom:!1},3:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!0,isVerticallyCentered:!1,isBottom:!1},4:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!0,isBottom:!1},5:{isLeft:!1,isHorizontallyCentered:!1,isRight:!0,isTop:!1,isVerticallyCentered:!1,isBottom:!0},6:{isLeft:!1,isHorizontallyCentered:!0,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},7:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!1,isBottom:!0},8:{isLeft:!0,isHorizontallyCentered:!1,isRight:!1,isTop:!1,isVerticallyCentered:!0,isBottom:!1}}})}(OpenSeadragon),function($){var THIS={},nextHash=1;function _getSafeElemSize(oElement){return oElement=$.getElement(oElement),new $.Point(0===oElement.clientWidth?1:oElement.clientWidth,0===oElement.clientHeight?1:oElement.clientHeight)}function getOverlayObject(viewer,overlay){if(overlay instanceof $.Overlay)return overlay;var element=null;if(overlay.element)element=$.getElement(overlay.element);else{var id=overlay.id?overlay.id:"openseadragon-overlay-"+Math.floor(1e7*Math.random());(element=$.getElement(overlay.id))||((element=document.createElement("a")).href="#/overlay/"+id),element.id=id,$.addClass(element,overlay.className?overlay.className:"openseadragon-overlay")}var location=overlay.location,width=overlay.width,height=overlay.height;if(!location){var x=overlay.x,y=overlay.y;if(void 0!==overlay.px){var rect=viewer.viewport.imageToViewportRectangle(new $.Rect(overlay.px,overlay.py,width||0,height||0));x=rect.x,y=rect.y,width=void 0!==width?rect.width:void 0,height=void 0!==height?rect.height:void 0}location=new $.Point(x,y)}var placement=overlay.placement;return placement&&"string"===$.type(placement)&&(placement=$.Placement[overlay.placement.toUpperCase()]),new $.Overlay({element,location,placement,onDraw:overlay.onDraw,checkResize:overlay.checkResize,width,height,rotationMode:overlay.rotationMode})}function getOverlayIndex(overlays,element){var i;for(i=overlays.length-1;i>=0;i--)if(overlays[i].element===element)return i;return-1}function scheduleUpdate(viewer,updateFunc){return $.requestAnimationFrame((function(){updateFunc(viewer)}))}function scheduleControlsFade(viewer){$.requestAnimationFrame((function(){!function updateControlsFade(viewer){var opacity,i;if(viewer.controlsShouldFade){for(opacity=1-($.now()-viewer.controlsFadeBeginTime)/viewer.controlsFadeLength,opacity=Math.min(1,opacity),opacity=Math.max(0,opacity),i=viewer.controls.length-1;i>=0;i--)viewer.controls[i].autoFade&&viewer.controls[i].setOpacity(opacity);opacity>0&&scheduleControlsFade(viewer)}}(viewer)}))}function beginControlsAutoHide(viewer){viewer.autoHideControls&&(viewer.controlsShouldFade=!0,viewer.controlsFadeBeginTime=$.now()+viewer.controlsFadeDelay,window.setTimeout((function(){scheduleControlsFade(viewer)}),viewer.controlsFadeDelay))}function abortControlsAutoHide(viewer){var i;for(viewer.controlsShouldFade=!1,i=viewer.controls.length-1;i>=0;i--)viewer.controls[i].setOpacity(1)}function onFocus(){abortControlsAutoHide(this)}function onBlur(){beginControlsAutoHide(this)}function onCanvasKeyDown(event){var canvasKeyDownEventArgs={originalEvent:event.originalEvent,preventDefaultAction:event.preventDefaultAction,preventVerticalPan:event.preventVerticalPan,preventHorizontalPan:event.preventHorizontalPan};if(this.raiseEvent("canvas-key",canvasKeyDownEventArgs),canvasKeyDownEventArgs.preventDefaultAction||event.ctrl||event.alt||event.meta)return!0;switch(event.keyCode){case 38:return canvasKeyDownEventArgs.preventVerticalPan||(event.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(0,-this.pixelsPerArrowPress))),this.viewport.applyConstraints()),!1;case 40:return canvasKeyDownEventArgs.preventVerticalPan||(event.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(0,this.pixelsPerArrowPress))),this.viewport.applyConstraints()),!1;case 37:return canvasKeyDownEventArgs.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(-this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),!1;case 39:return canvasKeyDownEventArgs.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(this.pixelsPerArrowPress,0))),this.viewport.applyConstraints()),!1;default:return!0}}function onCanvasKeyPress(event){var canvasKeyPressEventArgs={originalEvent:event.originalEvent,preventDefaultAction:event.preventDefaultAction,preventVerticalPan:event.preventVerticalPan,preventHorizontalPan:event.preventHorizontalPan};if(this.raiseEvent("canvas-key",canvasKeyPressEventArgs),canvasKeyPressEventArgs.preventDefaultAction||event.ctrl||event.alt||event.meta)return!0;switch(event.keyCode){case 43:case 61:return this.viewport.zoomBy(1.1),this.viewport.applyConstraints(),!1;case 45:return this.viewport.zoomBy(.9),this.viewport.applyConstraints(),!1;case 48:return this.viewport.goHome(),this.viewport.applyConstraints(),!1;case 119:case 87:return canvasKeyPressEventArgs.preventVerticalPan||(event.shift?this.viewport.zoomBy(1.1):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(0,-40))),this.viewport.applyConstraints()),!1;case 115:case 83:return canvasKeyPressEventArgs.preventVerticalPan||(event.shift?this.viewport.zoomBy(.9):this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(0,40))),this.viewport.applyConstraints()),!1;case 97:return canvasKeyPressEventArgs.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(-40,0))),this.viewport.applyConstraints()),!1;case 100:return canvasKeyPressEventArgs.preventHorizontalPan||(this.viewport.panBy(this.viewport.deltaPointsFromPixels(new $.Point(40,0))),this.viewport.applyConstraints()),!1;case 114:return this.viewport.flipped?this.viewport.setRotation($.positiveModulo(this.viewport.degrees-this.rotationIncrement,360)):this.viewport.setRotation($.positiveModulo(this.viewport.degrees+this.rotationIncrement,360)),this.viewport.applyConstraints(),!1;case 82:return this.viewport.flipped?this.viewport.setRotation($.positiveModulo(this.viewport.degrees+this.rotationIncrement,360)):this.viewport.setRotation($.positiveModulo(this.viewport.degrees-this.rotationIncrement,360)),this.viewport.applyConstraints(),!1;case 102:return this.viewport.toggleFlip(),!1;default:return!0}}function onCanvasClick(event){var gestureSettings;document.activeElement==this.canvas||this.canvas.focus(),this.viewport.flipped&&(event.position.x=this.viewport.getContainerSize().x-event.position.x);var canvasClickEventArgs={tracker:event.eventSource,position:event.position,quick:event.quick,shift:event.shift,originalEvent:event.originalEvent,preventDefaultAction:event.preventDefaultAction};this.raiseEvent("canvas-click",canvasClickEventArgs),!canvasClickEventArgs.preventDefaultAction&&this.viewport&&event.quick&&(gestureSettings=this.gestureSettingsByDeviceType(event.pointerType)).clickToZoom&&(this.viewport.zoomBy(event.shift?1/this.zoomPerClick:this.zoomPerClick,gestureSettings.zoomToRefPoint?this.viewport.pointFromPixel(event.position,!0):null),this.viewport.applyConstraints())}function onCanvasDblClick(event){var gestureSettings,canvasDblClickEventArgs={tracker:event.eventSource,position:event.position,shift:event.shift,originalEvent:event.originalEvent,preventDefaultAction:event.preventDefaultAction};this.raiseEvent("canvas-double-click",canvasDblClickEventArgs),!canvasDblClickEventArgs.preventDefaultAction&&this.viewport&&(gestureSettings=this.gestureSettingsByDeviceType(event.pointerType)).dblClickToZoom&&(this.viewport.zoomBy(event.shift?1/this.zoomPerClick:this.zoomPerClick,gestureSettings.zoomToRefPoint?this.viewport.pointFromPixel(event.position,!0):null),this.viewport.applyConstraints())}function onCanvasDrag(event){var gestureSettings,canvasDragEventArgs={tracker:event.eventSource,position:event.position,delta:event.delta,speed:event.speed,direction:event.direction,shift:event.shift,originalEvent:event.originalEvent,preventDefaultAction:event.preventDefaultAction};if(this.raiseEvent("canvas-drag",canvasDragEventArgs),!canvasDragEventArgs.preventDefaultAction&&this.viewport){if(gestureSettings=this.gestureSettingsByDeviceType(event.pointerType),this.panHorizontal||(event.delta.x=0),this.panVertical||(event.delta.y=0),this.viewport.flipped&&(event.delta.x=-event.delta.x),this.constrainDuringPan){var delta=this.viewport.deltaPointsFromPixels(event.delta.negate());this.viewport.centerSpringX.target.value+=delta.x,this.viewport.centerSpringY.target.value+=delta.y;var bounds=this.viewport.getBounds(),constrainedBounds=this.viewport.getConstrainedBounds();this.viewport.centerSpringX.target.value-=delta.x,this.viewport.centerSpringY.target.value-=delta.y,bounds.x!=constrainedBounds.x&&(event.delta.x=0),bounds.y!=constrainedBounds.y&&(event.delta.y=0)}this.viewport.panBy(this.viewport.deltaPointsFromPixels(event.delta.negate()),gestureSettings.flickEnabled&&!this.constrainDuringPan)}}function onCanvasDragEnd(event){if(!event.preventDefaultAction&&this.viewport){var gestureSettings=this.gestureSettingsByDeviceType(event.pointerType);if(gestureSettings.flickEnabled&&event.speed>=gestureSettings.flickMinSpeed){var amplitudeX=0;this.panHorizontal&&(amplitudeX=gestureSettings.flickMomentum*event.speed*Math.cos(event.direction));var amplitudeY=0;this.panVertical&&(amplitudeY=gestureSettings.flickMomentum*event.speed*Math.sin(event.direction));var center=this.viewport.pixelFromPoint(this.viewport.getCenter(!0)),target=this.viewport.pointFromPixel(new $.Point(center.x-amplitudeX,center.y-amplitudeY));this.viewport.panTo(target,!1)}this.viewport.applyConstraints()}this.raiseEvent("canvas-drag-end",{tracker:event.eventSource,position:event.position,speed:event.speed,direction:event.direction,shift:event.shift,originalEvent:event.originalEvent})}function onCanvasEnter(event){this.raiseEvent("canvas-enter",{tracker:event.eventSource,pointerType:event.pointerType,position:event.position,buttons:event.buttons,pointers:event.pointers,insideElementPressed:event.insideElementPressed,buttonDownAny:event.buttonDownAny,originalEvent:event.originalEvent})}function onCanvasExit(event){window.location!=window.parent.location&&$.MouseTracker.resetAllMouseTrackers(),this.raiseEvent("canvas-exit",{tracker:event.eventSource,pointerType:event.pointerType,position:event.position,buttons:event.buttons,pointers:event.pointers,insideElementPressed:event.insideElementPressed,buttonDownAny:event.buttonDownAny,originalEvent:event.originalEvent})}function onCanvasPress(event){this.raiseEvent("canvas-press",{tracker:event.eventSource,pointerType:event.pointerType,position:event.position,insideElementPressed:event.insideElementPressed,insideElementReleased:event.insideElementReleased,originalEvent:event.originalEvent})}function onCanvasRelease(event){this.raiseEvent("canvas-release",{tracker:event.eventSource,pointerType:event.pointerType,position:event.position,insideElementPressed:event.insideElementPressed,insideElementReleased:event.insideElementReleased,originalEvent:event.originalEvent})}function onCanvasNonPrimaryPress(event){this.raiseEvent("canvas-nonprimary-press",{tracker:event.eventSource,position:event.position,pointerType:event.pointerType,button:event.button,buttons:event.buttons,originalEvent:event.originalEvent})}function onCanvasNonPrimaryRelease(event){this.raiseEvent("canvas-nonprimary-release",{tracker:event.eventSource,position:event.position,pointerType:event.pointerType,button:event.button,buttons:event.buttons,originalEvent:event.originalEvent})}function onCanvasPinch(event){var gestureSettings,centerPt,panByPt;if(!event.preventDefaultAction&&this.viewport&&((gestureSettings=this.gestureSettingsByDeviceType(event.pointerType)).pinchToZoom&&(centerPt=this.viewport.pointFromPixel(event.center,!0),panByPt=this.viewport.pointFromPixel(event.lastCenter,!0).minus(centerPt),this.panHorizontal||(panByPt.x=0),this.panVertical||(panByPt.y=0),this.viewport.zoomBy(event.distance/event.lastDistance,centerPt,!0),gestureSettings.zoomToRefPoint&&this.viewport.panBy(panByPt,!0),this.viewport.applyConstraints()),gestureSettings.pinchRotate)){var angle1=Math.atan2(event.gesturePoints[0].currentPos.y-event.gesturePoints[1].currentPos.y,event.gesturePoints[0].currentPos.x-event.gesturePoints[1].currentPos.x),angle2=Math.atan2(event.gesturePoints[0].lastPos.y-event.gesturePoints[1].lastPos.y,event.gesturePoints[0].lastPos.x-event.gesturePoints[1].lastPos.x);this.viewport.setRotation(this.viewport.getRotation()+(angle1-angle2)*(180/Math.PI))}return this.raiseEvent("canvas-pinch",{tracker:event.eventSource,gesturePoints:event.gesturePoints,lastCenter:event.lastCenter,center:event.center,lastDistance:event.lastDistance,distance:event.distance,shift:event.shift,originalEvent:event.originalEvent}),!1}function onCanvasScroll(event){var gestureSettings,factor,thisScrollTime;if((thisScrollTime=$.now())-this._lastScrollTime>this.minScrollDeltaTime){if(this._lastScrollTime=thisScrollTime,this.viewport.flipped&&(event.position.x=this.viewport.getContainerSize().x-event.position.x),!event.preventDefaultAction&&this.viewport&&(gestureSettings=this.gestureSettingsByDeviceType(event.pointerType)).scrollToZoom&&(factor=Math.pow(this.zoomPerScroll,event.scroll),this.viewport.zoomBy(factor,gestureSettings.zoomToRefPoint?this.viewport.pointFromPixel(event.position,!0):null),this.viewport.applyConstraints()),this.raiseEvent("canvas-scroll",{tracker:event.eventSource,position:event.position,scroll:event.scroll,shift:event.shift,originalEvent:event.originalEvent}),gestureSettings&&gestureSettings.scrollToZoom)return!1}else if((gestureSettings=this.gestureSettingsByDeviceType(event.pointerType))&&gestureSettings.scrollToZoom)return!1}function onContainerEnter(event){THIS[this.hash].mouseInside=!0,abortControlsAutoHide(this),this.raiseEvent("container-enter",{tracker:event.eventSource,position:event.position,buttons:event.buttons,pointers:event.pointers,insideElementPressed:event.insideElementPressed,buttonDownAny:event.buttonDownAny,originalEvent:event.originalEvent})}function onContainerExit(event){event.pointers<1&&(THIS[this.hash].mouseInside=!1,THIS[this.hash].animating||beginControlsAutoHide(this)),this.raiseEvent("container-exit",{tracker:event.eventSource,position:event.position,buttons:event.buttons,pointers:event.pointers,insideElementPressed:event.insideElementPressed,buttonDownAny:event.buttonDownAny,originalEvent:event.originalEvent})}function updateMulti(viewer){!function updateOnce(viewer){if(viewer._opening)return;if(viewer.autoResize){var containerSize=_getSafeElemSize(viewer.container),prevContainerSize=THIS[viewer.hash].prevContainerSize;if(!containerSize.equals(prevContainerSize)){var viewport=viewer.viewport;if(viewer.preserveImageSizeOnResize){var resizeRatio=prevContainerSize.x/containerSize.x,zoom=viewport.getZoom()*resizeRatio,center=viewport.getCenter();viewport.resize(containerSize,!1),viewport.zoomTo(zoom,null,!0),viewport.panTo(center,!0)}else{var oldBounds=viewport.getBounds();viewport.resize(containerSize,!0),viewport.fitBoundsWithConstraints(oldBounds,!0)}THIS[viewer.hash].prevContainerSize=containerSize,THIS[viewer.hash].forceRedraw=!0}}var viewportChange=viewer.viewport.update(),animated=viewer.world.update()||viewportChange;viewportChange&&viewer.raiseEvent("viewport-change");viewer.referenceStrip&&(animated=viewer.referenceStrip.update(viewer.viewport)||animated);!THIS[viewer.hash].animating&&animated&&(viewer.raiseEvent("animation-start"),abortControlsAutoHide(viewer));(animated||THIS[viewer.hash].forceRedraw||viewer.world.needsDraw())&&(!function drawWorld(viewer){viewer.imageLoader.clear(),viewer.drawer.clear(),viewer.world.draw(),viewer.raiseEvent("update-viewport",{})}(viewer),viewer._drawOverlays(),viewer.navigator&&viewer.navigator.update(viewer.viewport),THIS[viewer.hash].forceRedraw=!1,animated&&viewer.raiseEvent("animation"));THIS[viewer.hash].animating&&!animated&&(viewer.raiseEvent("animation-finish"),THIS[viewer.hash].mouseInside||beginControlsAutoHide(viewer));THIS[viewer.hash].animating=animated}(viewer),viewer.isOpen()?viewer._updateRequestId=scheduleUpdate(viewer,updateMulti):viewer._updateRequestId=!1}function resolveUrl(prefix,url){return prefix?prefix+url:url}function beginZoomingIn(){THIS[this.hash].lastZoomTime=$.now(),THIS[this.hash].zoomFactor=this.zoomPerSecond,THIS[this.hash].zooming=!0,scheduleZoom(this)}function beginZoomingOut(){THIS[this.hash].lastZoomTime=$.now(),THIS[this.hash].zoomFactor=1/this.zoomPerSecond,THIS[this.hash].zooming=!0,scheduleZoom(this)}function endZooming(){THIS[this.hash].zooming=!1}function scheduleZoom(viewer){$.requestAnimationFrame($.delegate(viewer,doZoom))}function doZoom(){var currentTime,deltaTime,adjustedFactor;THIS[this.hash].zooming&&this.viewport&&(deltaTime=(currentTime=$.now())-THIS[this.hash].lastZoomTime,adjustedFactor=Math.pow(THIS[this.hash].zoomFactor,deltaTime/1e3),this.viewport.zoomBy(adjustedFactor),this.viewport.applyConstraints(),THIS[this.hash].lastZoomTime=currentTime,scheduleZoom(this))}function doSingleZoomIn(){this.viewport&&(THIS[this.hash].zooming=!1,this.viewport.zoomBy(this.zoomPerClick/1),this.viewport.applyConstraints())}function doSingleZoomOut(){this.viewport&&(THIS[this.hash].zooming=!1,this.viewport.zoomBy(1/this.zoomPerClick),this.viewport.applyConstraints())}function lightUp(){this.buttons.emulateEnter(),this.buttons.emulateExit()}function onHome(){this.viewport&&this.viewport.goHome()}function onFullScreen(){this.isFullPage()&&!$.isFullScreen()?this.setFullPage(!1):this.setFullScreen(!this.isFullPage()),this.buttons&&this.buttons.emulateExit(),this.fullPageButton.element.focus(),this.viewport&&this.viewport.applyConstraints()}function onRotateLeft(){if(this.viewport){var currRotation=this.viewport.getRotation();currRotation=this.viewport.flipped?$.positiveModulo(currRotation+this.rotationIncrement,360):$.positiveModulo(currRotation-this.rotationIncrement,360),this.viewport.setRotation(currRotation)}}function onRotateRight(){if(this.viewport){var currRotation=this.viewport.getRotation();currRotation=this.viewport.flipped?$.positiveModulo(currRotation-this.rotationIncrement,360):$.positiveModulo(currRotation+this.rotationIncrement,360),this.viewport.setRotation(currRotation)}}function onFlip(){this.viewport.toggleFlip()}function onPrevious(){var previous=this._sequenceIndex-1;this.navPrevNextWrap&&previous<0&&(previous+=this.tileSources.length),this.goToPage(previous)}function onNext(){var next=this._sequenceIndex+1;this.navPrevNextWrap&&next>=this.tileSources.length&&(next=0),this.goToPage(next)}$.Viewer=function(options){var i,style,args=arguments,_this=this;if($.isPlainObject(options)||(options={id:args[0],xmlPath:args.length>1?args[1]:void 0,prefixUrl:args.length>2?args[2]:void 0,controls:args.length>3?args[3]:void 0,overlays:args.length>4?args[4]:void 0}),options.config&&($.extend(!0,options,options.config),delete options.config),$.extend(!0,this,{id:options.id,hash:options.hash||nextHash++,initialPage:0,element:null,container:null,canvas:null,overlays:[],overlaysContainer:null,previousBody:[],customControls:[],source:null,drawer:null,world:null,viewport:null,navigator:null,collectionViewport:null,collectionDrawer:null,navImages:null,buttons:null,profiler:null},$.DEFAULT_SETTINGS,options),void 0===this.hash)throw new Error("A hash must be defined, either by specifying options.id or options.hash.");for(void 0!==THIS[this.hash]&&$.console.warn("Hash "+this.hash+" has already been used."),THIS[this.hash]={fsBoundsDelta:new $.Point(1,1),prevContainerSize:null,animating:!1,forceRedraw:!1,mouseInside:!1,group:null,zooming:!1,zoomFactor:null,lastZoomTime:null,fullPage:!1,onfullscreenchange:null},this._sequenceIndex=0,this._firstOpen=!0,this._updateRequestId=null,this._loadQueue=[],this.currentOverlays=[],this._lastScrollTime=$.now(),$.EventSource.call(this),this.addHandler("open-failed",(function(event){var msg=$.getString("Errors.OpenFailed",event.eventSource,event.message);_this._showMessage(msg)})),$.ControlDock.call(this,options),this.xmlPath&&(this.tileSources=[this.xmlPath]),this.element=this.element||document.getElementById(this.id),this.canvas=$.makeNeutralElement("div"),this.canvas.className="openseadragon-canvas",(style=this.canvas.style).width="100%",style.height="100%",style.overflow="hidden",style.position="absolute",style.top="0px",style.left="0px",$.setElementTouchActionNone(this.canvas),""!==options.tabIndex&&(this.canvas.tabIndex=void 0===options.tabIndex?0:options.tabIndex),this.container.className="openseadragon-container",function(style){style.width="100%",style.height="100%",style.position="relative",style.overflow="hidden",style.left="0px",style.top="0px",style.textAlign="left"}(this.container.style),this.container.insertBefore(this.canvas,this.container.firstChild),this.element.appendChild(this.container),this.bodyWidth=document.body.style.width,this.bodyHeight=document.body.style.height,this.bodyOverflow=document.body.style.overflow,this.docOverflow=document.documentElement.style.overflow,this.innerTracker=new $.MouseTracker({element:this.canvas,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,keyDownHandler:$.delegate(this,onCanvasKeyDown),keyHandler:$.delegate(this,onCanvasKeyPress),clickHandler:$.delegate(this,onCanvasClick),dblClickHandler:$.delegate(this,onCanvasDblClick),dragHandler:$.delegate(this,onCanvasDrag),dragEndHandler:$.delegate(this,onCanvasDragEnd),enterHandler:$.delegate(this,onCanvasEnter),exitHandler:$.delegate(this,onCanvasExit),pressHandler:$.delegate(this,onCanvasPress),releaseHandler:$.delegate(this,onCanvasRelease),nonPrimaryPressHandler:$.delegate(this,onCanvasNonPrimaryPress),nonPrimaryReleaseHandler:$.delegate(this,onCanvasNonPrimaryRelease),scrollHandler:$.delegate(this,onCanvasScroll),pinchHandler:$.delegate(this,onCanvasPinch)}),this.outerTracker=new $.MouseTracker({element:this.container,startDisabled:!this.mouseNavEnabled,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,dblClickTimeThreshold:this.dblClickTimeThreshold,dblClickDistThreshold:this.dblClickDistThreshold,enterHandler:$.delegate(this,onContainerEnter),exitHandler:$.delegate(this,onContainerExit)}),this.toolbar&&(this.toolbar=new $.ControlDock({element:this.toolbar})),this.bindStandardControls(),THIS[this.hash].prevContainerSize=_getSafeElemSize(this.container),this.world=new $.World({viewer:this}),this.world.addHandler("add-item",(function(event){_this.source=_this.world.getItemAt(0).source,THIS[_this.hash].forceRedraw=!0,_this._updateRequestId||(_this._updateRequestId=scheduleUpdate(_this,updateMulti))})),this.world.addHandler("remove-item",(function(event){_this.world.getItemCount()?_this.source=_this.world.getItemAt(0).source:_this.source=null,THIS[_this.hash].forceRedraw=!0})),this.world.addHandler("metrics-change",(function(event){_this.viewport&&_this.viewport._setContentBounds(_this.world.getHomeBounds(),_this.world.getContentFactor())})),this.world.addHandler("item-index-change",(function(event){_this.source=_this.world.getItemAt(0).source})),this.viewport=new $.Viewport({containerSize:THIS[this.hash].prevContainerSize,springStiffness:this.springStiffness,animationTime:this.animationTime,minZoomImageRatio:this.minZoomImageRatio,maxZoomPixelRatio:this.maxZoomPixelRatio,visibilityRatio:this.visibilityRatio,wrapHorizontal:this.wrapHorizontal,wrapVertical:this.wrapVertical,defaultZoomLevel:this.defaultZoomLevel,minZoomLevel:this.minZoomLevel,maxZoomLevel:this.maxZoomLevel,viewer:this,degrees:this.degrees,flipped:this.flipped,navigatorRotate:this.navigatorRotate,homeFillsViewer:this.homeFillsViewer,margins:this.viewportMargins}),this.viewport._setContentBounds(this.world.getHomeBounds(),this.world.getContentFactor()),this.imageLoader=new $.ImageLoader({jobLimit:this.imageLoaderLimit,timeout:options.timeout}),this.tileCache=new $.TileCache({maxImageCacheCount:this.maxImageCacheCount}),this.drawer=new $.Drawer({viewer:this,viewport:this.viewport,element:this.canvas,debugGridColor:this.debugGridColor}),this.overlaysContainer=$.makeNeutralElement("div"),this.canvas.appendChild(this.overlaysContainer),this.drawer.canRotate()||(this.rotateLeft&&(i=this.buttons.buttons.indexOf(this.rotateLeft),this.buttons.buttons.splice(i,1),this.buttons.element.removeChild(this.rotateLeft.element)),this.rotateRight&&(i=this.buttons.buttons.indexOf(this.rotateRight),this.buttons.buttons.splice(i,1),this.buttons.element.removeChild(this.rotateRight.element))),this.showNavigator&&(this.navigator=new $.Navigator({id:this.navigatorId,position:this.navigatorPosition,sizeRatio:this.navigatorSizeRatio,maintainSizeRatio:this.navigatorMaintainSizeRatio,top:this.navigatorTop,left:this.navigatorLeft,width:this.navigatorWidth,height:this.navigatorHeight,autoResize:this.navigatorAutoResize,autoFade:this.navigatorAutoFade,prefixUrl:this.prefixUrl,viewer:this,navigatorRotate:this.navigatorRotate,background:this.navigatorBackground,opacity:this.navigatorOpacity,borderColor:this.navigatorBorderColor,displayRegionColor:this.navigatorDisplayRegionColor,crossOriginPolicy:this.crossOriginPolicy})),this.sequenceMode&&this.bindSequenceControls(),this.tileSources&&this.open(this.tileSources),i=0;i<this.customControls.length;i++)this.addControl(this.customControls[i].id,{anchor:this.customControls[i].anchor});$.requestAnimationFrame((function(){beginControlsAutoHide(_this)})),void 0===this.imageSmoothingEnabled||this.imageSmoothingEnabled||this.drawer.setImageSmoothingEnabled(this.imageSmoothingEnabled)},$.extend($.Viewer.prototype,$.EventSource.prototype,$.ControlDock.prototype,{isOpen:function(){return!!this.world.getItemCount()},openDzi:function(dzi){return $.console.error("[Viewer.openDzi] this function is deprecated; use Viewer.open() instead."),this.open(dzi)},openTileSource:function(tileSource){return $.console.error("[Viewer.openTileSource] this function is deprecated; use Viewer.open() instead."),this.open(tileSource)},open:function(tileSources,initialPage){var _this=this;if(this.close(),tileSources){if(this.sequenceMode&&$.isArray(tileSources))return this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),void 0===initialPage||isNaN(initialPage)||(this.initialPage=initialPage),this.tileSources=tileSources,this._sequenceIndex=Math.max(0,Math.min(this.tileSources.length-1,this.initialPage)),this.tileSources.length&&(this.open(this.tileSources[this._sequenceIndex]),this.showReferenceStrip&&this.addReferenceStrip()),void this._updateSequenceButtons(this._sequenceIndex);if($.isArray(tileSources)||(tileSources=[tileSources]),tileSources.length){this._opening=!0;for(var failEvent,expected=tileSources.length,successes=0,failures=0,checkCompletion=function(){if(successes+failures===expected)if(successes){!_this._firstOpen&&_this.preserveViewport||(_this.viewport.goHome(!0),_this.viewport.update()),_this._firstOpen=!1;var source=tileSources[0];if(source.tileSource&&(source=source.tileSource),_this.overlays&&!_this.preserveOverlays)for(var i=0;i<_this.overlays.length;i++)_this.currentOverlays[i]=getOverlayObject(_this,_this.overlays[i]);_this._drawOverlays(),_this._opening=!1,_this.raiseEvent("open",{source})}else _this._opening=!1,_this.raiseEvent("open-failed",failEvent)},doOne=function(options){$.isPlainObject(options)&&options.tileSource||(options={tileSource:options}),void 0!==options.index&&($.console.error("[Viewer.open] setting indexes here is not supported; use addTiledImage instead"),delete options.index),void 0===options.collectionImmediately&&(options.collectionImmediately=!0);var originalSuccess=options.success;options.success=function(event){if(successes++,options.tileSource.overlays)for(var i=0;i<options.tileSource.overlays.length;i++)_this.addOverlay(options.tileSource.overlays[i]);originalSuccess&&originalSuccess(event),checkCompletion()};var originalError=options.error;options.error=function(event){failures++,failEvent||(failEvent=event),originalError&&originalError(event),checkCompletion()},_this.addTiledImage(options)},i=0;i<tileSources.length;i++)doOne(tileSources[i]);return this}}},close:function(){return THIS[this.hash]?(this._opening=!1,this.navigator&&this.navigator.close(),this.preserveOverlays||(this.clearOverlays(),this.overlaysContainer.innerHTML=""),THIS[this.hash].animating=!1,this.world.removeAll(),this.imageLoader.clear(),this.raiseEvent("close"),this):this},destroy:function(){if(THIS[this.hash]){if(this.close(),this.clearOverlays(),this.overlaysContainer.innerHTML="",this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null),null!==this._updateRequestId&&($.cancelAnimationFrame(this._updateRequestId),this._updateRequestId=null),this.drawer&&this.drawer.destroy(),this.removeAllHandlers(),this.element)for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this.innerTracker&&this.innerTracker.destroy(),this.outerTracker&&this.outerTracker.destroy(),THIS[this.hash]=null,delete THIS[this.hash],this.canvas=null,this.container=null,this.element=null}},isMouseNavEnabled:function(){return this.innerTracker.isTracking()},setMouseNavEnabled:function(enabled){return this.innerTracker.setTracking(enabled),this.outerTracker.setTracking(enabled),this.raiseEvent("mouse-enabled",{enabled}),this},areControlsEnabled:function(){var i,enabled=this.controls.length;for(i=0;i<this.controls.length;i++)enabled=enabled&&this.controls[i].isVisible();return enabled},setControlsEnabled:function(enabled){return enabled?abortControlsAutoHide(this):beginControlsAutoHide(this),this.raiseEvent("controls-enabled",{enabled}),this},setDebugMode:function(debugMode){for(var i=0;i<this.world.getItemCount();i++)this.world.getItemAt(i).debugMode=debugMode;this.debugMode=debugMode,this.forceRedraw()},isFullPage:function(){return THIS[this.hash].fullPage},setFullPage:function(fullPage){var nodes,i,body=document.body,bodyStyle=body.style,docStyle=document.documentElement.style,_this=this;if(fullPage==this.isFullPage())return this;var fullPageEventArgs={fullPage,preventDefaultAction:!1};if(this.raiseEvent("pre-full-page",fullPageEventArgs),fullPageEventArgs.preventDefaultAction)return this;if(fullPage){for(this.elementSize=$.getElementSize(this.element),this.pageScroll=$.getPageScroll(),this.elementMargin=this.element.style.margin,this.element.style.margin="0",this.elementPadding=this.element.style.padding,this.element.style.padding="0",this.bodyMargin=bodyStyle.margin,this.docMargin=docStyle.margin,bodyStyle.margin="0",docStyle.margin="0",this.bodyPadding=bodyStyle.padding,this.docPadding=docStyle.padding,bodyStyle.padding="0",docStyle.padding="0",this.bodyWidth=bodyStyle.width,this.docWidth=docStyle.width,bodyStyle.width="100%",docStyle.width="100%",this.bodyHeight=bodyStyle.height,this.docHeight=docStyle.height,bodyStyle.height="100%",docStyle.height="100%",this.previousBody=[],THIS[this.hash].prevElementParent=this.element.parentNode,THIS[this.hash].prevNextSibling=this.element.nextSibling,THIS[this.hash].prevElementWidth=this.element.style.width,THIS[this.hash].prevElementHeight=this.element.style.height,nodes=body.childNodes.length,i=0;i<nodes;i++)this.previousBody.push(body.childNodes[0]),body.removeChild(body.childNodes[0]);this.toolbar&&this.toolbar.element&&(this.toolbar.parentNode=this.toolbar.element.parentNode,this.toolbar.nextSibling=this.toolbar.element.nextSibling,body.appendChild(this.toolbar.element),$.addClass(this.toolbar.element,"fullpage")),$.addClass(this.element,"fullpage"),body.appendChild(this.element),this.element.style.height=$.getWindowSize().y+"px",this.element.style.width=$.getWindowSize().x+"px",this.toolbar&&this.toolbar.element&&(this.element.style.height=$.getElementSize(this.element).y-$.getElementSize(this.toolbar.element).y+"px"),THIS[this.hash].fullPage=!0,$.delegate(this,onContainerEnter)({})}else{for(this.element.style.margin=this.elementMargin,this.element.style.padding=this.elementPadding,bodyStyle.margin=this.bodyMargin,docStyle.margin=this.docMargin,bodyStyle.padding=this.bodyPadding,docStyle.padding=this.docPadding,bodyStyle.width=this.bodyWidth,docStyle.width=this.docWidth,bodyStyle.height=this.bodyHeight,docStyle.height=this.docHeight,body.removeChild(this.element),nodes=this.previousBody.length,i=0;i<nodes;i++)body.appendChild(this.previousBody.shift());$.removeClass(this.element,"fullpage"),THIS[this.hash].prevElementParent.insertBefore(this.element,THIS[this.hash].prevNextSibling),this.toolbar&&this.toolbar.element&&(body.removeChild(this.toolbar.element),$.removeClass(this.toolbar.element,"fullpage"),this.toolbar.parentNode.insertBefore(this.toolbar.element,this.toolbar.nextSibling),delete this.toolbar.parentNode,delete this.toolbar.nextSibling),this.element.style.width=THIS[this.hash].prevElementWidth,this.element.style.height=THIS[this.hash].prevElementHeight;var restoreScrollCounter=0,restoreScroll=function(){$.setPageScroll(_this.pageScroll);var pageScroll=$.getPageScroll();++restoreScrollCounter<10&&(pageScroll.x!==_this.pageScroll.x||pageScroll.y!==_this.pageScroll.y)&&$.requestAnimationFrame(restoreScroll)};$.requestAnimationFrame(restoreScroll),THIS[this.hash].fullPage=!1,$.delegate(this,onContainerExit)({})}return this.navigator&&this.viewport&&this.navigator.update(this.viewport),this.raiseEvent("full-page",{fullPage}),this},setFullScreen:function(fullScreen){var _this=this;if(!$.supportsFullScreen)return this.setFullPage(fullScreen);if($.isFullScreen()===fullScreen)return this;var fullScreeEventArgs={fullScreen,preventDefaultAction:!1};if(this.raiseEvent("pre-full-screen",fullScreeEventArgs),fullScreeEventArgs.preventDefaultAction)return this;if(fullScreen){if(this.setFullPage(!0),!this.isFullPage())return this;this.fullPageStyleWidth=this.element.style.width,this.fullPageStyleHeight=this.element.style.height,this.element.style.width="100%",this.element.style.height="100%";var onFullScreenChange=function(){var isFullScreen=$.isFullScreen();isFullScreen||($.removeEvent(document,$.fullScreenEventName,onFullScreenChange),$.removeEvent(document,$.fullScreenErrorEventName,onFullScreenChange),_this.setFullPage(!1),_this.isFullPage()&&(_this.element.style.width=_this.fullPageStyleWidth,_this.element.style.height=_this.fullPageStyleHeight)),_this.navigator&&_this.viewport&&setTimeout((function(){_this.navigator.update(_this.viewport)})),_this.raiseEvent("full-screen",{fullScreen:isFullScreen})};$.addEvent(document,$.fullScreenEventName,onFullScreenChange),$.addEvent(document,$.fullScreenErrorEventName,onFullScreenChange),$.requestFullScreen(document.body)}else $.exitFullScreen();return this},isVisible:function(){return"hidden"!=this.container.style.visibility},setVisible:function(visible){return this.container.style.visibility=visible?"":"hidden",this.raiseEvent("visible",{visible}),this},addTiledImage:function(options){$.console.assert(options,"[Viewer.addTiledImage] options is required"),$.console.assert(options.tileSource,"[Viewer.addTiledImage] options.tileSource is required"),$.console.assert(!options.replace||options.index>-1&&options.index<this.world.getItemCount(),"[Viewer.addTiledImage] if options.replace is used, options.index must be a valid index in Viewer.world");var _this=this;options.replace&&(options.replaceItem=_this.world.getItemAt(options.index)),this._hideMessage(),void 0===options.placeholderFillStyle&&(options.placeholderFillStyle=this.placeholderFillStyle),void 0===options.opacity&&(options.opacity=this.opacity),void 0===options.preload&&(options.preload=this.preload),void 0===options.compositeOperation&&(options.compositeOperation=this.compositeOperation),void 0===options.crossOriginPolicy&&(options.crossOriginPolicy=void 0!==options.tileSource.crossOriginPolicy?options.tileSource.crossOriginPolicy:this.crossOriginPolicy),void 0===options.ajaxWithCredentials&&(options.ajaxWithCredentials=this.ajaxWithCredentials),void 0===options.loadTilesWithAjax&&(options.loadTilesWithAjax=this.loadTilesWithAjax),void 0===options.ajaxHeaders||null===options.ajaxHeaders?options.ajaxHeaders=this.ajaxHeaders:$.isPlainObject(options.ajaxHeaders)&&$.isPlainObject(this.ajaxHeaders)&&(options.ajaxHeaders=$.extend({},this.ajaxHeaders,options.ajaxHeaders));var myQueueItem={options};function raiseAddItemFailed(event){for(var i=0;i<_this._loadQueue.length;i++)if(_this._loadQueue[i]===myQueueItem){_this._loadQueue.splice(i,1);break}0===_this._loadQueue.length&&refreshWorld(myQueueItem),_this.raiseEvent("add-item-failed",event),options.error&&options.error(event)}function refreshWorld(theItem){_this.collectionMode&&(_this.world.arrange({immediately:theItem.options.collectionImmediately,rows:_this.collectionRows,columns:_this.collectionColumns,layout:_this.collectionLayout,tileSize:_this.collectionTileSize,tileMargin:_this.collectionTileMargin}),_this.world.setAutoRefigureSizes(!0))}function processReadyItems(){for(var queueItem,tiledImage,optionsClone;_this._loadQueue.length&&(queueItem=_this._loadQueue[0]).tileSource;){if(_this._loadQueue.splice(0,1),queueItem.options.replace){var newIndex=_this.world.getIndexOfItem(queueItem.options.replaceItem);-1!=newIndex&&(queueItem.options.index=newIndex),_this.world.removeItem(queueItem.options.replaceItem)}tiledImage=new $.TiledImage({viewer:_this,source:queueItem.tileSource,viewport:_this.viewport,drawer:_this.drawer,tileCache:_this.tileCache,imageLoader:_this.imageLoader,x:queueItem.options.x,y:queueItem.options.y,width:queueItem.options.width,height:queueItem.options.height,fitBounds:queueItem.options.fitBounds,fitBoundsPlacement:queueItem.options.fitBoundsPlacement,clip:queueItem.options.clip,placeholderFillStyle:queueItem.options.placeholderFillStyle,opacity:queueItem.options.opacity,preload:queueItem.options.preload,degrees:queueItem.options.degrees,compositeOperation:queueItem.options.compositeOperation,springStiffness:_this.springStiffness,animationTime:_this.animationTime,minZoomImageRatio:_this.minZoomImageRatio,wrapHorizontal:_this.wrapHorizontal,wrapVertical:_this.wrapVertical,immediateRender:_this.immediateRender,blendTime:_this.blendTime,alwaysBlend:_this.alwaysBlend,minPixelRatio:_this.minPixelRatio,smoothTileEdgesMinZoom:_this.smoothTileEdgesMinZoom,iOSDevice:_this.iOSDevice,crossOriginPolicy:queueItem.options.crossOriginPolicy,ajaxWithCredentials:queueItem.options.ajaxWithCredentials,loadTilesWithAjax:queueItem.options.loadTilesWithAjax,ajaxHeaders:queueItem.options.ajaxHeaders,debugMode:_this.debugMode}),_this.collectionMode&&_this.world.setAutoRefigureSizes(!1),_this.world.addItem(tiledImage,{index:queueItem.options.index}),0===_this._loadQueue.length&&refreshWorld(queueItem),1!==_this.world.getItemCount()||_this.preserveViewport||_this.viewport.goHome(!0),_this.navigator&&(optionsClone=$.extend({},queueItem.options,{replace:!1,originalTiledImage:tiledImage,tileSource:queueItem.tileSource}),_this.navigator.addTiledImage(optionsClone)),queueItem.options.success&&queueItem.options.success({item:tiledImage})}}$.isArray(options.tileSource)?setTimeout((function(){raiseAddItemFailed({message:"[Viewer.addTiledImage] Sequences can not be added; add them one at a time instead.",source:options.tileSource,options})})):(this._loadQueue.push(myQueueItem),function getTileSourceImplementation(viewer,tileSource,imgOptions,successCallback,failCallback){var _this=viewer;if("string"==$.type(tileSource))if(tileSource.match(/^\s*<.*>\s*$/))tileSource=$.parseXml(tileSource);else if(tileSource.match(/^\s*[\{\[].*[\}\]]\s*$/))try{var tileSourceJ=$.parseJSON(tileSource);tileSource=tileSourceJ}catch(e){}function waitUntilReady(tileSource,originalTileSource){tileSource.ready?successCallback(tileSource):(tileSource.addHandler("ready",(function(){successCallback(tileSource)})),tileSource.addHandler("open-failed",(function(event){failCallback({message:event.message,source:originalTileSource})})))}setTimeout((function(){if("string"==$.type(tileSource))(tileSource=new $.TileSource({url:tileSource,crossOriginPolicy:void 0!==imgOptions.crossOriginPolicy?imgOptions.crossOriginPolicy:viewer.crossOriginPolicy,ajaxWithCredentials:viewer.ajaxWithCredentials,ajaxHeaders:viewer.ajaxHeaders,useCanvas:viewer.useCanvas,success:function(event){successCallback(event.tileSource)}})).addHandler("open-failed",(function(event){failCallback(event)}));else if($.isPlainObject(tileSource)||tileSource.nodeType)if(void 0!==tileSource.crossOriginPolicy||void 0===imgOptions.crossOriginPolicy&&void 0===viewer.crossOriginPolicy||(tileSource.crossOriginPolicy=void 0!==imgOptions.crossOriginPolicy?imgOptions.crossOriginPolicy:viewer.crossOriginPolicy),void 0===tileSource.ajaxWithCredentials&&(tileSource.ajaxWithCredentials=viewer.ajaxWithCredentials),void 0===tileSource.useCanvas&&(tileSource.useCanvas=viewer.useCanvas),$.isFunction(tileSource.getTileUrl)){var customTileSource=new $.TileSource(tileSource);customTileSource.getTileUrl=tileSource.getTileUrl,successCallback(customTileSource)}else{var $TileSource=$.TileSource.determineType(_this,tileSource);if(!$TileSource)return void failCallback({message:"Unable to load TileSource",source:tileSource});var options=$TileSource.prototype.configure.apply(_this,[tileSource]);waitUntilReady(new $TileSource(options),tileSource)}else waitUntilReady(tileSource,tileSource)}))}(this,options.tileSource,options,(function(tileSource){myQueueItem.tileSource=tileSource,processReadyItems()}),(function(event){event.options=options,raiseAddItemFailed(event),processReadyItems()})))},addSimpleImage:function(options){$.console.assert(options,"[Viewer.addSimpleImage] options is required"),$.console.assert(options.url,"[Viewer.addSimpleImage] options.url is required");var opts=$.extend({},options,{tileSource:{type:"image",url:options.url}});delete opts.url,this.addTiledImage(opts)},addLayer:function(options){var _this=this;$.console.error("[Viewer.addLayer] this function is deprecated; use Viewer.addTiledImage() instead.");var optionsClone=$.extend({},options,{success:function(event){_this.raiseEvent("add-layer",{options,drawer:event.item})},error:function(event){_this.raiseEvent("add-layer-failed",event)}});return this.addTiledImage(optionsClone),this},getLayerAtLevel:function(level){return $.console.error("[Viewer.getLayerAtLevel] this function is deprecated; use World.getItemAt() instead."),this.world.getItemAt(level)},getLevelOfLayer:function(drawer){return $.console.error("[Viewer.getLevelOfLayer] this function is deprecated; use World.getIndexOfItem() instead."),this.world.getIndexOfItem(drawer)},getLayersCount:function(){return $.console.error("[Viewer.getLayersCount] this function is deprecated; use World.getItemCount() instead."),this.world.getItemCount()},setLayerLevel:function(drawer,level){return $.console.error("[Viewer.setLayerLevel] this function is deprecated; use World.setItemIndex() instead."),this.world.setItemIndex(drawer,level)},removeLayer:function(drawer){return $.console.error("[Viewer.removeLayer] this function is deprecated; use World.removeItem() instead."),this.world.removeItem(drawer)},forceRedraw:function(){return THIS[this.hash].forceRedraw=!0,this},bindSequenceControls:function(){var onFocusHandler=$.delegate(this,onFocus),onBlurHandler=$.delegate(this,onBlur),onNextHandler=$.delegate(this,onNext),onPreviousHandler=$.delegate(this,onPrevious),navImages=this.navImages,useGroup=!0;return this.showSequenceControl&&((this.previousButton||this.nextButton)&&(useGroup=!1),this.previousButton=new $.Button({element:this.previousButton?$.getElement(this.previousButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.PreviousPage"),srcRest:resolveUrl(this.prefixUrl,navImages.previous.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.previous.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.previous.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.previous.DOWN),onRelease:onPreviousHandler,onFocus:onFocusHandler,onBlur:onBlurHandler}),this.nextButton=new $.Button({element:this.nextButton?$.getElement(this.nextButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.NextPage"),srcRest:resolveUrl(this.prefixUrl,navImages.next.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.next.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.next.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.next.DOWN),onRelease:onNextHandler,onFocus:onFocusHandler,onBlur:onBlurHandler}),this.navPrevNextWrap||this.previousButton.disable(),this.tileSources&&this.tileSources.length||this.nextButton.disable(),useGroup&&(this.paging=new $.ButtonGroup({buttons:[this.previousButton,this.nextButton],clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.pagingControl=this.paging.element,this.toolbar?this.toolbar.addControl(this.pagingControl,{anchor:$.ControlAnchor.BOTTOM_RIGHT}):this.addControl(this.pagingControl,{anchor:this.sequenceControlAnchor||$.ControlAnchor.TOP_LEFT}))),this},bindStandardControls:function(){var beginZoomingInHandler=$.delegate(this,beginZoomingIn),endZoomingHandler=$.delegate(this,endZooming),doSingleZoomInHandler=$.delegate(this,doSingleZoomIn),beginZoomingOutHandler=$.delegate(this,beginZoomingOut),doSingleZoomOutHandler=$.delegate(this,doSingleZoomOut),onHomeHandler=$.delegate(this,onHome),onFullScreenHandler=$.delegate(this,onFullScreen),onRotateLeftHandler=$.delegate(this,onRotateLeft),onRotateRightHandler=$.delegate(this,onRotateRight),onFlipHandler=$.delegate(this,onFlip),onFocusHandler=$.delegate(this,onFocus),onBlurHandler=$.delegate(this,onBlur),navImages=this.navImages,buttons=[],useGroup=!0;return this.showNavigationControl&&((this.zoomInButton||this.zoomOutButton||this.homeButton||this.fullPageButton||this.rotateLeftButton||this.rotateRightButton||this.flipButton)&&(useGroup=!1),this.showZoomControl&&(buttons.push(this.zoomInButton=new $.Button({element:this.zoomInButton?$.getElement(this.zoomInButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.ZoomIn"),srcRest:resolveUrl(this.prefixUrl,navImages.zoomIn.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.zoomIn.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.zoomIn.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.zoomIn.DOWN),onPress:beginZoomingInHandler,onRelease:endZoomingHandler,onClick:doSingleZoomInHandler,onEnter:beginZoomingInHandler,onExit:endZoomingHandler,onFocus:onFocusHandler,onBlur:onBlurHandler})),buttons.push(this.zoomOutButton=new $.Button({element:this.zoomOutButton?$.getElement(this.zoomOutButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.ZoomOut"),srcRest:resolveUrl(this.prefixUrl,navImages.zoomOut.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.zoomOut.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.zoomOut.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.zoomOut.DOWN),onPress:beginZoomingOutHandler,onRelease:endZoomingHandler,onClick:doSingleZoomOutHandler,onEnter:beginZoomingOutHandler,onExit:endZoomingHandler,onFocus:onFocusHandler,onBlur:onBlurHandler}))),this.showHomeControl&&buttons.push(this.homeButton=new $.Button({element:this.homeButton?$.getElement(this.homeButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.Home"),srcRest:resolveUrl(this.prefixUrl,navImages.home.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.home.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.home.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.home.DOWN),onRelease:onHomeHandler,onFocus:onFocusHandler,onBlur:onBlurHandler})),this.showFullPageControl&&buttons.push(this.fullPageButton=new $.Button({element:this.fullPageButton?$.getElement(this.fullPageButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.FullPage"),srcRest:resolveUrl(this.prefixUrl,navImages.fullpage.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.fullpage.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.fullpage.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.fullpage.DOWN),onRelease:onFullScreenHandler,onFocus:onFocusHandler,onBlur:onBlurHandler})),this.showRotationControl&&(buttons.push(this.rotateLeftButton=new $.Button({element:this.rotateLeftButton?$.getElement(this.rotateLeftButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.RotateLeft"),srcRest:resolveUrl(this.prefixUrl,navImages.rotateleft.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.rotateleft.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.rotateleft.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.rotateleft.DOWN),onRelease:onRotateLeftHandler,onFocus:onFocusHandler,onBlur:onBlurHandler})),buttons.push(this.rotateRightButton=new $.Button({element:this.rotateRightButton?$.getElement(this.rotateRightButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.RotateRight"),srcRest:resolveUrl(this.prefixUrl,navImages.rotateright.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.rotateright.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.rotateright.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.rotateright.DOWN),onRelease:onRotateRightHandler,onFocus:onFocusHandler,onBlur:onBlurHandler}))),this.showFlipControl&&buttons.push(this.flipButton=new $.Button({element:this.flipButton?$.getElement(this.flipButton):null,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,tooltip:$.getString("Tooltips.Flip"),srcRest:resolveUrl(this.prefixUrl,navImages.flip.REST),srcGroup:resolveUrl(this.prefixUrl,navImages.flip.GROUP),srcHover:resolveUrl(this.prefixUrl,navImages.flip.HOVER),srcDown:resolveUrl(this.prefixUrl,navImages.flip.DOWN),onRelease:onFlipHandler,onFocus:onFocusHandler,onBlur:onBlurHandler})),useGroup&&(this.buttons=new $.ButtonGroup({buttons,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold}),this.navControl=this.buttons.element,this.addHandler("open",$.delegate(this,lightUp)),this.toolbar?this.toolbar.addControl(this.navControl,{anchor:this.navigationControlAnchor||$.ControlAnchor.TOP_LEFT}):this.addControl(this.navControl,{anchor:this.navigationControlAnchor||$.ControlAnchor.TOP_LEFT}))),this},currentPage:function(){return this._sequenceIndex},goToPage:function(page){return this.tileSources&&page>=0&&page<this.tileSources.length&&(this._sequenceIndex=page,this._updateSequenceButtons(page),this.open(this.tileSources[page]),this.referenceStrip&&this.referenceStrip.setFocus(page),this.raiseEvent("page",{page})),this},addOverlay:function(element,location,placement,onDraw){var options;if(options=$.isPlainObject(element)?element:{element,location,placement,onDraw},element=$.getElement(options.element),getOverlayIndex(this.currentOverlays,element)>=0)return this;var overlay=getOverlayObject(this,options);return this.currentOverlays.push(overlay),overlay.drawHTML(this.overlaysContainer,this.viewport),this.raiseEvent("add-overlay",{element,location:options.location,placement:options.placement}),this},updateOverlay:function(element,location,placement){var i;return element=$.getElement(element),(i=getOverlayIndex(this.currentOverlays,element))>=0&&(this.currentOverlays[i].update(location,placement),THIS[this.hash].forceRedraw=!0,this.raiseEvent("update-overlay",{element,location,placement})),this},removeOverlay:function(element){var i;return element=$.getElement(element),(i=getOverlayIndex(this.currentOverlays,element))>=0&&(this.currentOverlays[i].destroy(),this.currentOverlays.splice(i,1),THIS[this.hash].forceRedraw=!0,this.raiseEvent("remove-overlay",{element})),this},clearOverlays:function(){for(;this.currentOverlays.length>0;)this.currentOverlays.pop().destroy();return THIS[this.hash].forceRedraw=!0,this.raiseEvent("clear-overlay",{}),this},getOverlayById:function(element){var i;return element=$.getElement(element),(i=getOverlayIndex(this.currentOverlays,element))>=0?this.currentOverlays[i]:null},_updateSequenceButtons:function(page){this.nextButton&&(this.tileSources&&this.tileSources.length-1!==page?this.nextButton.enable():this.navPrevNextWrap||this.nextButton.disable()),this.previousButton&&(page>0?this.previousButton.enable():this.navPrevNextWrap||this.previousButton.disable())},_showMessage:function(message){this._hideMessage();var div=$.makeNeutralElement("div");div.appendChild(document.createTextNode(message)),this.messageDiv=$.makeCenteredNode(div),$.addClass(this.messageDiv,"openseadragon-message"),this.container.appendChild(this.messageDiv)},_hideMessage:function(){var div=this.messageDiv;div&&(div.parentNode.removeChild(div),delete this.messageDiv)},gestureSettingsByDeviceType:function(type){switch(type){case"mouse":return this.gestureSettingsMouse;case"touch":return this.gestureSettingsTouch;case"pen":return this.gestureSettingsPen;default:return this.gestureSettingsUnknown}},_drawOverlays:function(){var i,length=this.currentOverlays.length;for(i=0;i<length;i++)this.currentOverlays[i].drawHTML(this.overlaysContainer,this.viewport)},_cancelPendingImages:function(){this._loadQueue=[]},removeReferenceStrip:function(){this.showReferenceStrip=!1,this.referenceStrip&&(this.referenceStrip.destroy(),this.referenceStrip=null)},addReferenceStrip:function(){if(this.showReferenceStrip=!0,this.sequenceMode){if(this.referenceStrip)return;this.tileSources.length&&this.tileSources.length>1&&(this.referenceStrip=new $.ReferenceStrip({id:this.referenceStripElement,position:this.referenceStripPosition,sizeRatio:this.referenceStripSizeRatio,scroll:this.referenceStripScroll,height:this.referenceStripHeight,width:this.referenceStripWidth,tileSources:this.tileSources,prefixUrl:this.prefixUrl,useCanvas:this.useCanvas,viewer:this}),this.referenceStrip.setFocus(this._sequenceIndex))}else $.console.warn('Attempting to display a reference strip while "sequenceMode" is off.')}})}(OpenSeadragon),function($){function onCanvasClick(event){var canvasClickEventArgs={tracker:event.eventSource,position:event.position,quick:event.quick,shift:event.shift,originalEvent:event.originalEvent,preventDefaultAction:event.preventDefaultAction};if(this.viewer.raiseEvent("navigator-click",canvasClickEventArgs),!canvasClickEventArgs.preventDefaultAction&&event.quick&&this.viewer.viewport&&(this.panVertical||this.panHorizontal)){this.viewer.viewport.flipped&&(event.position.x=this.viewport.getContainerSize().x-event.position.x);var target=this.viewport.pointFromPixel(event.position);this.panVertical?this.panHorizontal||(target.x=this.viewer.viewport.getCenter(!0).x):target.y=this.viewer.viewport.getCenter(!0).y,this.viewer.viewport.panTo(target),this.viewer.viewport.applyConstraints()}}function onCanvasDrag(event){var canvasDragEventArgs={tracker:event.eventSource,position:event.position,delta:event.delta,speed:event.speed,direction:event.direction,shift:event.shift,originalEvent:event.originalEvent,preventDefaultAction:event.preventDefaultAction};this.viewer.raiseEvent("navigator-drag",canvasDragEventArgs),!canvasDragEventArgs.preventDefaultAction&&this.viewer.viewport&&(this.panHorizontal||(event.delta.x=0),this.panVertical||(event.delta.y=0),this.viewer.viewport.flipped&&(event.delta.x=-event.delta.x),this.viewer.viewport.panBy(this.viewport.deltaPointsFromPixels(event.delta)),this.viewer.constrainDuringPan&&this.viewer.viewport.applyConstraints())}function onCanvasRelease(event){event.insideElementPressed&&this.viewer.viewport&&this.viewer.viewport.applyConstraints()}function onCanvasScroll(event){return this.viewer.raiseEvent("navigator-scroll",{tracker:event.eventSource,position:event.position,scroll:event.scroll,shift:event.shift,originalEvent:event.originalEvent}),!1}function _setTransformRotate(element,degrees){setElementTransform(element,"rotate("+degrees+"deg)")}function setElementTransform(element,rule){element.style.webkitTransform=rule,element.style.mozTransform=rule,element.style.msTransform=rule,element.style.oTransform=rule,element.style.transform=rule}$.Navigator=function(options){var viewerSize,navigatorSize,style,borderWidth,viewer=options.viewer,_this=this;function rotate(degrees){_setTransformRotate(_this.displayRegionContainer,degrees),_setTransformRotate(_this.displayRegion,-degrees),_this.viewport.setRotation(degrees)}(options.id?(this.element=document.getElementById(options.id),options.controlOptions={anchor:$.ControlAnchor.NONE,attachToViewer:!1,autoFade:!1}):(options.id="navigator-"+$.now(),this.element=$.makeNeutralElement("div"),options.controlOptions={anchor:$.ControlAnchor.TOP_RIGHT,attachToViewer:!0,autoFade:options.autoFade},options.position&&("BOTTOM_RIGHT"==options.position?options.controlOptions.anchor=$.ControlAnchor.BOTTOM_RIGHT:"BOTTOM_LEFT"==options.position?options.controlOptions.anchor=$.ControlAnchor.BOTTOM_LEFT:"TOP_RIGHT"==options.position?options.controlOptions.anchor=$.ControlAnchor.TOP_RIGHT:"TOP_LEFT"==options.position?options.controlOptions.anchor=$.ControlAnchor.TOP_LEFT:"ABSOLUTE"==options.position&&(options.controlOptions.anchor=$.ControlAnchor.ABSOLUTE,options.controlOptions.top=options.top,options.controlOptions.left=options.left,options.controlOptions.height=options.height,options.controlOptions.width=options.width))),this.element.id=options.id,this.element.className+=" navigator",(options=$.extend(!0,{sizeRatio:$.DEFAULT_SETTINGS.navigatorSizeRatio},options,{element:this.element,tabIndex:-1,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,autoResize:options.autoResize,minZoomImageRatio:1,background:options.background,opacity:options.opacity,borderColor:options.borderColor,displayRegionColor:options.displayRegionColor})).minPixelRatio=this.minPixelRatio=viewer.minPixelRatio,$.setElementTouchActionNone(this.element),this.borderWidth=2,this.fudge=new $.Point(1,1),this.totalBorderWidths=new $.Point(2*this.borderWidth,2*this.borderWidth).minus(this.fudge),options.controlOptions.anchor!=$.ControlAnchor.NONE&&(style=this.element.style,borderWidth=this.borderWidth,style.margin="0px",style.border=borderWidth+"px solid "+options.borderColor,style.padding="0px",style.background=options.background,style.opacity=options.opacity,style.overflow="hidden"),this.displayRegion=$.makeNeutralElement("div"),this.displayRegion.id=this.element.id+"-displayregion",this.displayRegion.className="displayregion",function(style,borderWidth){style.position="relative",style.top="0px",style.left="0px",style.fontSize="0px",style.overflow="hidden",style.border=borderWidth+"px solid "+options.displayRegionColor,style.margin="0px",style.padding="0px",style.background="transparent",style.float="left",style.cssFloat="left",style.styleFloat="left",style.zIndex=999999999,style.cursor="default"}(this.displayRegion.style,this.borderWidth),this.displayRegionContainer=$.makeNeutralElement("div"),this.displayRegionContainer.id=this.element.id+"-displayregioncontainer",this.displayRegionContainer.className="displayregioncontainer",this.displayRegionContainer.style.width="100%",this.displayRegionContainer.style.height="100%",viewer.addControl(this.element,options.controlOptions),this._resizeWithViewer=options.controlOptions.anchor!=$.ControlAnchor.ABSOLUTE&&options.controlOptions.anchor!=$.ControlAnchor.NONE,options.width&&options.height?(this.setWidth(options.width),this.setHeight(options.height)):this._resizeWithViewer&&(viewerSize=$.getElementSize(viewer.element),this.element.style.height=Math.round(viewerSize.y*options.sizeRatio)+"px",this.element.style.width=Math.round(viewerSize.x*options.sizeRatio)+"px",this.oldViewerSize=viewerSize,navigatorSize=$.getElementSize(this.element),this.elementArea=navigatorSize.x*navigatorSize.y),this.oldContainerSize=new $.Point(0,0),$.Viewer.apply(this,[options]),this.displayRegionContainer.appendChild(this.displayRegion),this.element.getElementsByTagName("div")[0].appendChild(this.displayRegionContainer),options.navigatorRotate)&&(rotate(options.viewer.viewport?options.viewer.viewport.getRotation():options.viewer.degrees||0),options.viewer.addHandler("rotate",(function(args){rotate(args.degrees)})));this.innerTracker.destroy(),this.innerTracker=new $.MouseTracker({element:this.element,dragHandler:$.delegate(this,onCanvasDrag),clickHandler:$.delegate(this,onCanvasClick),releaseHandler:$.delegate(this,onCanvasRelease),scrollHandler:$.delegate(this,onCanvasScroll)}),this.addHandler("reset-size",(function(){_this.viewport&&_this.viewport.goHome(!0)})),viewer.world.addHandler("item-index-change",(function(event){window.setTimeout((function(){var item=_this.world.getItemAt(event.previousIndex);_this.world.setItemIndex(item,event.newIndex)}),1)})),viewer.world.addHandler("remove-item",(function(event){var theirItem=event.item,myItem=_this._getMatchingItem(theirItem);myItem&&_this.world.removeItem(myItem)})),this.update(viewer.viewport)},$.extend($.Navigator.prototype,$.EventSource.prototype,$.Viewer.prototype,{updateSize:function(){if(this.viewport){var containerSize=new $.Point(0===this.container.clientWidth?1:this.container.clientWidth,0===this.container.clientHeight?1:this.container.clientHeight);containerSize.equals(this.oldContainerSize)||(this.viewport.resize(containerSize,!0),this.viewport.goHome(!0),this.oldContainerSize=containerSize,this.drawer.clear(),this.world.draw())}},setWidth:function(width){this.width=width,this.element.style.width="number"==typeof width?width+"px":width,this._resizeWithViewer=!1},setHeight:function(height){this.height=height,this.element.style.height="number"==typeof height?height+"px":height,this._resizeWithViewer=!1},setFlip:function(state){return this.viewport.setFlip(state),this.setDisplayTransform(this.viewer.viewport.getFlip()?"scale(-1,1)":"scale(1,1)"),this},setDisplayTransform:function(rule){setElementTransform(this.displayRegion,rule),setElementTransform(this.canvas,rule),setElementTransform(this.element,rule)},update:function(viewport){var viewerSize,newWidth,newHeight,bounds,topleft,bottomright;if(viewerSize=$.getElementSize(this.viewer.element),this._resizeWithViewer&&viewerSize.x&&viewerSize.y&&!viewerSize.equals(this.oldViewerSize)&&(this.oldViewerSize=viewerSize,this.maintainSizeRatio||!this.elementArea?(newWidth=viewerSize.x*this.sizeRatio,newHeight=viewerSize.y*this.sizeRatio):(newWidth=Math.sqrt(this.elementArea*(viewerSize.x/viewerSize.y)),newHeight=this.elementArea/newWidth),this.element.style.width=Math.round(newWidth)+"px",this.element.style.height=Math.round(newHeight)+"px",this.elementArea||(this.elementArea=newWidth*newHeight),this.updateSize()),viewport&&this.viewport){bounds=viewport.getBoundsNoRotate(!0),topleft=this.viewport.pixelFromPointNoRotate(bounds.getTopLeft(),!1),bottomright=this.viewport.pixelFromPointNoRotate(bounds.getBottomRight(),!1).minus(this.totalBorderWidths);var style=this.displayRegion.style;style.display=this.world.getItemCount()?"block":"none",style.top=Math.round(topleft.y)+"px",style.left=Math.round(topleft.x)+"px";var width=Math.abs(topleft.x-bottomright.x),height=Math.abs(topleft.y-bottomright.y);style.width=Math.round(Math.max(width,0))+"px",style.height=Math.round(Math.max(height,0))+"px"}},addTiledImage:function(options){var _this=this,original=options.originalTiledImage;delete options.original;var optionsClone=$.extend({},options,{success:function(event){var myItem=event.item;function matchBounds(){_this._matchBounds(myItem,original)}myItem._originalForNavigator=original,_this._matchBounds(myItem,original,!0),original.addHandler("bounds-change",matchBounds),original.addHandler("clip-change",matchBounds),original.addHandler("opacity-change",(function matchOpacity(){_this._matchOpacity(myItem,original)})),original.addHandler("composite-operation-change",(function matchCompositeOperation(){_this._matchCompositeOperation(myItem,original)}))}});return $.Viewer.prototype.addTiledImage.apply(this,[optionsClone])},_getMatchingItem:function(theirItem){for(var item,count=this.world.getItemCount(),i=0;i<count;i++)if((item=this.world.getItemAt(i))._originalForNavigator===theirItem)return item;return null},_matchBounds:function(myItem,theirItem,immediately){var bounds=theirItem.getBoundsNoRotate();myItem.setPosition(bounds.getTopLeft(),immediately),myItem.setWidth(bounds.width,immediately),myItem.setRotation(theirItem.getRotation(),immediately),myItem.setClip(theirItem.getClip())},_matchOpacity:function(myItem,theirItem){myItem.setOpacity(theirItem.opacity)},_matchCompositeOperation:function(myItem,theirItem){myItem.setCompositeOperation(theirItem.compositeOperation)}})}(OpenSeadragon),function($){var I18N={Errors:{Dzc:"Sorry, we don't support Deep Zoom Collections!",Dzi:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",Xml:"Hmm, this doesn't appear to be a valid Deep Zoom Image.",ImageFormat:"Sorry, we don't support {0}-based Deep Zoom Images.",Security:"It looks like a security restriction stopped us from loading this Deep Zoom Image.",Status:"This space unintentionally left blank ({0} {1}).",OpenFailed:"Unable to open {0}: {1}"},Tooltips:{FullPage:"Toggle full page",Home:"Go home",ZoomIn:"Zoom in",ZoomOut:"Zoom out",NextPage:"Next page",PreviousPage:"Previous page",RotateLeft:"Rotate left",RotateRight:"Rotate right",Flip:"Flip Horizontally"}};$.extend($,{getString:function(prop){var i,props=prop.split("."),string=null,args=arguments,container=I18N;for(i=0;i<props.length-1;i++)container=container[props[i]]||{};return"string"!=typeof(string=container[props[i]])&&($.console.log("Untranslated source string:",prop),string=""),string.replace(/\{\d+\}/g,(function(capture){var i=parseInt(capture.match(/\d+/),10)+1;return i<args.length?args[i]:""}))},setString:function(prop,value){var i,props=prop.split("."),container=I18N;for(i=0;i<props.length-1;i++)container[props[i]]||(container[props[i]]={}),container=container[props[i]];container[props[i]]=value}})}(OpenSeadragon),function($){$.Point=function(x,y){this.x="number"==typeof x?x:0,this.y="number"==typeof y?y:0},$.Point.prototype={clone:function(){return new $.Point(this.x,this.y)},plus:function(point){return new $.Point(this.x+point.x,this.y+point.y)},minus:function(point){return new $.Point(this.x-point.x,this.y-point.y)},times:function(factor){return new $.Point(this.x*factor,this.y*factor)},divide:function(factor){return new $.Point(this.x/factor,this.y/factor)},negate:function(){return new $.Point(-this.x,-this.y)},distanceTo:function(point){return Math.sqrt(Math.pow(this.x-point.x,2)+Math.pow(this.y-point.y,2))},squaredDistanceTo:function(point){return Math.pow(this.x-point.x,2)+Math.pow(this.y-point.y,2)},apply:function(func){return new $.Point(func(this.x),func(this.y))},equals:function(point){return point instanceof $.Point&&this.x===point.x&&this.y===point.y},rotate:function(degrees,pivot){var cos,sin;if(pivot=pivot||new $.Point(0,0),degrees%90==0){switch($.positiveModulo(degrees,360)){case 0:cos=1,sin=0;break;case 90:cos=0,sin=1;break;case 180:cos=-1,sin=0;break;case 270:cos=0,sin=-1}}else{var angle=degrees*Math.PI/180;cos=Math.cos(angle),sin=Math.sin(angle)}var x=cos*(this.x-pivot.x)-sin*(this.y-pivot.y)+pivot.x,y=sin*(this.x-pivot.x)+cos*(this.y-pivot.y)+pivot.y;return new $.Point(x,y)},toString:function(){return"("+Math.round(100*this.x)/100+","+Math.round(100*this.y)/100+")"}}}(OpenSeadragon),function($){$.TileSource=function(width,height,tileSize,tileOverlap,minLevel,maxLevel){var options,i,_this=this,args=arguments;if(options=$.isPlainObject(width)?width:{width:args[0],height:args[1],tileSize:args[2],tileOverlap:args[3],minLevel:args[4],maxLevel:args[5]},$.EventSource.call(this),$.extend(!0,this,options),!this.success)for(i=0;i<arguments.length;i++)if($.isFunction(arguments[i])){this.success=arguments[i];break}this.success&&this.addHandler("ready",(function(event){_this.success(event)})),"string"==$.type(arguments[0])&&(this.url=arguments[0]),this.url?(this.aspectRatio=1,this.dimensions=new $.Point(10,10),this._tileWidth=0,this._tileHeight=0,this.tileOverlap=0,this.minLevel=0,this.maxLevel=0,this.ready=!1,this.getImageInfo(this.url)):(this.ready=!0,this.aspectRatio=options.width&&options.height?options.width/options.height:1,this.dimensions=new $.Point(options.width,options.height),this.tileSize?(this._tileWidth=this._tileHeight=this.tileSize,delete this.tileSize):(this.tileWidth?(this._tileWidth=this.tileWidth,delete this.tileWidth):this._tileWidth=0,this.tileHeight?(this._tileHeight=this.tileHeight,delete this.tileHeight):this._tileHeight=0),this.tileOverlap=options.tileOverlap?options.tileOverlap:0,this.minLevel=options.minLevel?options.minLevel:0,this.maxLevel=void 0!==options.maxLevel&&null!==options.maxLevel?options.maxLevel:options.width&&options.height?Math.ceil(Math.log(Math.max(options.width,options.height))/Math.log(2)):0,this.success&&$.isFunction(this.success)&&this.success(this))},$.TileSource.prototype={getTileSize:function(level){return $.console.error("[TileSource.getTileSize] is deprecated. Use TileSource.getTileWidth() and TileSource.getTileHeight() instead"),this._tileWidth},getTileWidth:function(level){return this._tileWidth?this._tileWidth:this.getTileSize(level)},getTileHeight:function(level){return this._tileHeight?this._tileHeight:this.getTileSize(level)},getLevelScale:function(level){var i,levelScaleCache={};for(i=0;i<=this.maxLevel;i++)levelScaleCache[i]=1/Math.pow(2,this.maxLevel-i);return this.getLevelScale=function(_level){return levelScaleCache[_level]},this.getLevelScale(level)},getNumTiles:function(level){var scale=this.getLevelScale(level),x=Math.ceil(scale*this.dimensions.x/this.getTileWidth(level)),y=Math.ceil(scale*this.dimensions.y/this.getTileHeight(level));return new $.Point(x,y)},getPixelRatio:function(level){var imageSizeScaled=this.dimensions.times(this.getLevelScale(level)),rx=1/imageSizeScaled.x,ry=1/imageSizeScaled.y;return new $.Point(rx,ry)},getClosestLevel:function(){var i,tiles;for(i=this.minLevel+1;i<=this.maxLevel&&!((tiles=this.getNumTiles(i)).x>1||tiles.y>1);i++);return i-1},getTileAtPoint:function(level,point){var validPoint=point.x>=0&&point.x<=1&&point.y>=0&&point.y<=1/this.aspectRatio;$.console.assert(validPoint,"[TileSource.getTileAtPoint] must be called with a valid point.");var widthScaled=this.dimensions.x*this.getLevelScale(level),pixelX=point.x*widthScaled,pixelY=point.y*widthScaled,x=Math.floor(pixelX/this.getTileWidth(level)),y=Math.floor(pixelY/this.getTileHeight(level));point.x>=1&&(x=this.getNumTiles(level).x-1);return point.y>=1/this.aspectRatio-1e-15&&(y=this.getNumTiles(level).y-1),new $.Point(x,y)},getTileBounds:function(level,x,y,isSource){var dimensionsScaled=this.dimensions.times(this.getLevelScale(level)),tileWidth=this.getTileWidth(level),tileHeight=this.getTileHeight(level),px=0===x?0:tileWidth*x-this.tileOverlap,py=0===y?0:tileHeight*y-this.tileOverlap,sx=tileWidth+(0===x?1:2)*this.tileOverlap,sy=tileHeight+(0===y?1:2)*this.tileOverlap,scale=1/dimensionsScaled.x;return sx=Math.min(sx,dimensionsScaled.x-px),sy=Math.min(sy,dimensionsScaled.y-py),isSource?new $.Rect(0,0,sx,sy):new $.Rect(px*scale,py*scale,sx*scale,sy*scale)},getImageInfo:function(url){var callbackName,callback,readySource,options,urlParts,filename,lastDot,_this=this;url&&(lastDot=(filename=(urlParts=url.split("/"))[urlParts.length-1]).lastIndexOf("."))>-1&&(urlParts[urlParts.length-1]=filename.slice(0,lastDot)),callback=function(data){"string"==typeof data&&(data=$.parseXml(data));var $TileSource=$.TileSource.determineType(_this,data,url);$TileSource?(void 0===(options=$TileSource.prototype.configure.apply(_this,[data,url])).ajaxWithCredentials&&(options.ajaxWithCredentials=_this.ajaxWithCredentials),readySource=new $TileSource(options),_this.ready=!0,_this.raiseEvent("ready",{tileSource:readySource})):_this.raiseEvent("open-failed",{message:"Unable to load TileSource",source:url})},url.match(/\.js$/)?(callbackName=url.split("/").pop().replace(".js",""),$.jsonp({url,async:!1,callbackName,callback})):$.makeAjaxRequest({url,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,success:function(xhr){var data=function processResponse(xhr){var statusText,data,responseText=xhr.responseText,status=xhr.status;if(!xhr)throw new Error($.getString("Errors.Security"));if(200!==xhr.status&&0!==xhr.status)throw statusText=404==(status=xhr.status)?"Not Found":xhr.statusText,new Error($.getString("Errors.Status",status,statusText));if(responseText.match(/\s*<.*/))try{data=xhr.responseXML&&xhr.responseXML.documentElement?xhr.responseXML:$.parseXml(responseText)}catch(e){data=xhr.responseText}else if(responseText.match(/\s*[\{\[].*/))try{data=$.parseJSON(responseText)}catch(e){data=responseText}else data=responseText;return data}(xhr);callback(data)},error:function(xhr,exc){var msg;try{msg="HTTP "+xhr.status+" attempting to load TileSource"}catch(e){msg=(void 0!==exc&&exc.toString?exc.toString():"Unknown error")+" attempting to load TileSource"}_this.raiseEvent("open-failed",{message:msg,source:url})}})},supports:function(data,url){return!1},configure:function(data,url){throw new Error("Method not implemented.")},getTileUrl:function(level,x,y){throw new Error("Method not implemented.")},getTileAjaxHeaders:function(level,x,y){return{}},tileExists:function(level,x,y){var numTiles=this.getNumTiles(level);return level>=this.minLevel&&level<=this.maxLevel&&x>=0&&y>=0&&x<numTiles.x&&y<numTiles.y}},$.extend(!0,$.TileSource.prototype,$.EventSource.prototype),$.TileSource.determineType=function(tileSource,data,url){var property;for(property in OpenSeadragon)if(property.match(/.+TileSource$/)&&$.isFunction(OpenSeadragon[property])&&$.isFunction(OpenSeadragon[property].prototype.supports)&&OpenSeadragon[property].prototype.supports.call(tileSource,data,url))return OpenSeadragon[property];$.console.error("No TileSource was able to open %s %s",url,data)}}(OpenSeadragon),function($){function configureFromObject(tileSource,configuration){var rectData,i,imageData=configuration.Image,tilesUrl=imageData.Url,fileFormat=imageData.Format,sizeData=imageData.Size,dispRectData=imageData.DisplayRect||[],width=parseInt(sizeData.Width,10),height=parseInt(sizeData.Height,10),tileSize=parseInt(imageData.TileSize,10),tileOverlap=parseInt(imageData.Overlap,10),displayRects=[];for(i=0;i<dispRectData.length;i++)rectData=dispRectData[i].Rect,displayRects.push(new $.DisplayRect(parseInt(rectData.X,10),parseInt(rectData.Y,10),parseInt(rectData.Width,10),parseInt(rectData.Height,10),parseInt(rectData.MinLevel,10),parseInt(rectData.MaxLevel,10)));return $.extend(!0,{width,height,tileSize,tileOverlap,minLevel:null,maxLevel:null,tilesUrl,fileFormat,displayRects},configuration)}$.DziTileSource=function(width,height,tileSize,tileOverlap,tilesUrl,fileFormat,displayRects,minLevel,maxLevel){var i,rect,level,options;if(options=$.isPlainObject(width)?width:{width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4],fileFormat:arguments[5],displayRects:arguments[6],minLevel:arguments[7],maxLevel:arguments[8]},this._levelRects={},this.tilesUrl=options.tilesUrl,this.fileFormat=options.fileFormat,this.displayRects=options.displayRects,this.displayRects)for(i=this.displayRects.length-1;i>=0;i--)for(level=(rect=this.displayRects[i]).minLevel;level<=rect.maxLevel;level++)this._levelRects[level]||(this._levelRects[level]=[]),this._levelRects[level].push(rect);$.TileSource.apply(this,[options])},$.extend($.DziTileSource.prototype,$.TileSource.prototype,{supports:function(data,url){var ns;return data.Image?ns=data.Image.xmlns:data.documentElement&&("Image"!=data.documentElement.localName&&"Image"!=data.documentElement.tagName||(ns=data.documentElement.namespaceURI)),-1!==(ns=(ns||"").toLowerCase()).indexOf("schemas.microsoft.com/deepzoom/2008")||-1!==ns.indexOf("schemas.microsoft.com/deepzoom/2009")},configure:function(data,url){var options;return options=$.isPlainObject(data)?configureFromObject(this,data):function configureFromXML(tileSource,xmlDoc){if(!xmlDoc||!xmlDoc.documentElement)throw new Error($.getString("Errors.Xml"));var dispRectNodes,dispRectNode,rectNode,sizeNode,i,root=xmlDoc.documentElement,rootName=root.localName||root.tagName,ns=xmlDoc.documentElement.namespaceURI,configuration=null,displayRects=[];if("Image"==rootName)try{if(void 0===(sizeNode=root.getElementsByTagName("Size")[0])&&(sizeNode=root.getElementsByTagNameNS(ns,"Size")[0]),configuration={Image:{xmlns:"http://schemas.microsoft.com/deepzoom/2008",Url:root.getAttribute("Url"),Format:root.getAttribute("Format"),DisplayRect:null,Overlap:parseInt(root.getAttribute("Overlap"),10),TileSize:parseInt(root.getAttribute("TileSize"),10),Size:{Height:parseInt(sizeNode.getAttribute("Height"),10),Width:parseInt(sizeNode.getAttribute("Width"),10)}}},!$.imageFormatSupported(configuration.Image.Format))throw new Error($.getString("Errors.ImageFormat",configuration.Image.Format.toUpperCase()));for(void 0===(dispRectNodes=root.getElementsByTagName("DisplayRect"))&&(dispRectNodes=root.getElementsByTagNameNS(ns,"DisplayRect")[0]),i=0;i<dispRectNodes.length;i++)void 0===(rectNode=(dispRectNode=dispRectNodes[i]).getElementsByTagName("Rect")[0])&&(rectNode=dispRectNode.getElementsByTagNameNS(ns,"Rect")[0]),displayRects.push({Rect:{X:parseInt(rectNode.getAttribute("X"),10),Y:parseInt(rectNode.getAttribute("Y"),10),Width:parseInt(rectNode.getAttribute("Width"),10),Height:parseInt(rectNode.getAttribute("Height"),10),MinLevel:parseInt(dispRectNode.getAttribute("MinLevel"),10),MaxLevel:parseInt(dispRectNode.getAttribute("MaxLevel"),10)}});return displayRects.length&&(configuration.Image.DisplayRect=displayRects),configureFromObject(tileSource,configuration)}catch(e){throw e instanceof Error?e:new Error($.getString("Errors.Dzi"))}else{if("Collection"==rootName)throw new Error($.getString("Errors.Dzc"));if("Error"==rootName){var message=root.getElementsByTagName("Message")[0].firstChild.nodeValue;throw new Error(message)}}throw new Error($.getString("Errors.Dzi"))}(this,data),url&&!options.tilesUrl&&(options.tilesUrl=url.replace(/([^\/]+?)(\.(dzi|xml|js)?(\?[^\/]*)?)?\/?$/,"$1_files/"),-1!=url.search(/\.(dzi|xml|js)\?/)?options.queryParams=url.match(/\?.*/):options.queryParams=""),options},getTileUrl:function(level,x,y){return[this.tilesUrl,level,"/",x,"_",y,".",this.fileFormat,this.queryParams].join("")},tileExists:function(level,x,y){var rect,scale,xMin,yMin,xMax,yMax,i,rects=this._levelRects[level];if(this.minLevel&&level<this.minLevel||this.maxLevel&&level>this.maxLevel)return!1;if(!rects||!rects.length)return!0;for(i=rects.length-1;i>=0;i--)if(!(level<(rect=rects[i]).minLevel||level>rect.maxLevel)&&(scale=this.getLevelScale(level),xMin=rect.x*scale,yMin=rect.y*scale,xMax=xMin+rect.width*scale,yMax=yMin+rect.height*scale,xMin=Math.floor(xMin/this._tileWidth),yMin=Math.floor(yMin/this._tileWidth),xMax=Math.ceil(xMax/this._tileWidth),yMax=Math.ceil(yMax/this._tileWidth),xMin<=x&&x<xMax&&yMin<=y&&y<yMax))return!0;return!1}})}(OpenSeadragon),function($){function canBeTiled(options){var profileLevel=Array.isArray(options.profile)?options.profile[0]:options.profile,isLevel0=-1!==["http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://iiif.io/api/image/2/level0.json","level0","https://iiif.io/api/image/3/level0.json"].indexOf(profileLevel),hasCanoncicalSizeFeature=!1;return 2===options.version&&options.profile.length>1&&options.profile[1].supports&&(hasCanoncicalSizeFeature=-1!==options.profile[1].supports.indexOf("sizeByW")),3===options.version&&options.extraFeatures&&(hasCanoncicalSizeFeature=-1!==options.extraFeatures.indexOf("sizeByWh")),!isLevel0||hasCanoncicalSizeFeature}function constructLevels(options){for(var levels=[],i=0;i<options.sizes.length;i++)levels.push({url:options["@id"]+"/full/"+options.sizes[i].width+","+(3===options.version?options.sizes[i].height:"")+"/0/default."+options.tileFormat,width:options.sizes[i].width,height:options.sizes[i].height});return levels.sort((function(a,b){return a.width-b.width}))}function parseXML10(node,configuration,property){var i,value;if(3==node.nodeType&&property)(value=node.nodeValue.trim()).match(/^\d*$/)&&(value=Number(value)),configuration[property]?($.isArray(configuration[property])||(configuration[property]=[configuration[property]]),configuration[property].push(value)):configuration[property]=value;else if(1==node.nodeType)for(i=0;i<node.childNodes.length;i++)parseXML10(node.childNodes[i],configuration,node.nodeName)}$.IIIFTileSource=function(options){if($.extend(!0,this,options),!(this.height&&this.width&&this["@id"]))throw new Error("IIIF required parameters not provided.");if(options.tileSizePerScaleFactor={},this.tileFormat=this.tileFormat||"jpg",this.version=options.version,this.tile_width&&this.tile_height)options.tileWidth=this.tile_width,options.tileHeight=this.tile_height;else if(this.tile_width)options.tileSize=this.tile_width;else if(this.tile_height)options.tileSize=this.tile_height;else if(this.tiles)if(1==this.tiles.length)options.tileWidth=this.tiles[0].width,options.tileHeight=this.tiles[0].height||this.tiles[0].width,this.scale_factors=this.tiles[0].scaleFactors;else{this.scale_factors=[];for(var t=0;t<this.tiles.length;t++)for(var sf=0;sf<this.tiles[t].scaleFactors.length;sf++){var scaleFactor=this.tiles[t].scaleFactors[sf];this.scale_factors.push(scaleFactor),options.tileSizePerScaleFactor[scaleFactor]={width:this.tiles[t].width,height:this.tiles[t].height||this.tiles[t].width}}}else if(canBeTiled(options)){for(var shortDim=Math.min(this.height,this.width),tileOptions=[256,512,1024],smallerTiles=[],c=0;c<tileOptions.length;c++)tileOptions[c]<=shortDim&&smallerTiles.push(tileOptions[c]);smallerTiles.length>0?options.tileSize=Math.max.apply(null,smallerTiles):options.tileSize=shortDim}else this.sizes&&this.sizes.length>0?(this.emulateLegacyImagePyramid=!0,options.levels=constructLevels(this),$.extend(!0,options,{width:options.levels[options.levels.length-1].width,height:options.levels[options.levels.length-1].height,tileSize:Math.max(options.height,options.width),tileOverlap:0,minLevel:0,maxLevel:options.levels.length-1}),this.levels=options.levels):$.console.error("Nothing in the info.json to construct image pyramids from");if(!options.maxLevel&&!this.emulateLegacyImagePyramid)if(this.scale_factors){var maxScaleFactor=Math.max.apply(null,this.scale_factors);options.maxLevel=Math.round(Math.log(maxScaleFactor)*Math.LOG2E)}else options.maxLevel=Number(Math.ceil(Math.log(Math.max(this.width,this.height),2)));$.TileSource.apply(this,[options])},$.extend($.IIIFTileSource.prototype,$.TileSource.prototype,{supports:function(data,url){return!(!data.protocol||"http://iiif.io/api/image"!=data.protocol)||(!(!data["@context"]||"http://library.stanford.edu/iiif/image-api/1.1/context.json"!=data["@context"]&&"http://iiif.io/api/image/1/context.json"!=data["@context"])||(!(!data.profile||0!==data.profile.indexOf("http://library.stanford.edu/iiif/image-api/compliance.html"))||(!!(data.identifier&&data.width&&data.height)||!(!data.documentElement||"info"!=data.documentElement.tagName||"http://library.stanford.edu/iiif/image-api/ns/"!=data.documentElement.namespaceURI))))},configure:function(data,url){if($.isPlainObject(data)){if(data["@context"]){var context=data["@context"];if(Array.isArray(context))for(var i=0;i<context.length;i++)if("string"==typeof context[i]&&(/^http:\/\/iiif\.io\/api\/image\/[1-3]\/context\.json$/.test(context[i])||"http://library.stanford.edu/iiif/image-api/1.1/context.json"===context[i])){context=context[i];break}switch(context){case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":data.version=1;break;case"http://iiif.io/api/image/2/context.json":data.version=2;break;case"http://iiif.io/api/image/3/context.json":data.version=3;break;default:$.console.error("Data has a @context property which contains no known IIIF context URI.")}}else data["@context"]="http://iiif.io/api/image/1.0/context.json",data["@id"]=url.replace("/info.json",""),data.version=1;if(!data["@id"]&&data.id&&(data["@id"]=data.id),data.preferredFormats)for(var f=0;f<data.preferredFormats.length;f++)if(OpenSeadragon.imageFormatSupported(data.preferredFormats[f])){data.tileFormat=data.preferredFormats[f];break}return data}var options=function configureFromXml10(xmlDoc){if(!xmlDoc||!xmlDoc.documentElement)throw new Error($.getString("Errors.Xml"));var root=xmlDoc.documentElement,rootName=root.tagName,configuration=null;if("info"==rootName)try{return parseXML10(root,configuration={}),configuration}catch(e){throw e instanceof Error?e:new Error($.getString("Errors.IIIF"))}throw new Error($.getString("Errors.IIIF"))}(data);return options["@context"]="http://iiif.io/api/image/1.0/context.json",options["@id"]=url.replace("/info.xml",""),options.version=1,options},getTileWidth:function(level){if(this.emulateLegacyImagePyramid)return $.TileSource.prototype.getTileWidth.call(this,level);var scaleFactor=Math.pow(2,this.maxLevel-level);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[scaleFactor]?this.tileSizePerScaleFactor[scaleFactor].width:this._tileWidth},getTileHeight:function(level){if(this.emulateLegacyImagePyramid)return $.TileSource.prototype.getTileHeight.call(this,level);var scaleFactor=Math.pow(2,this.maxLevel-level);return this.tileSizePerScaleFactor&&this.tileSizePerScaleFactor[scaleFactor]?this.tileSizePerScaleFactor[scaleFactor].height:this._tileHeight},getLevelScale:function(level){if(this.emulateLegacyImagePyramid){var levelScale=NaN;return this.levels.length>0&&level>=this.minLevel&&level<=this.maxLevel&&(levelScale=this.levels[level].width/this.levels[this.maxLevel].width),levelScale}return $.TileSource.prototype.getLevelScale.call(this,level)},getNumTiles:function(level){return this.emulateLegacyImagePyramid?this.getLevelScale(level)?new $.Point(1,1):new $.Point(0,0):$.TileSource.prototype.getNumTiles.call(this,level)},getTileAtPoint:function(level,point){return this.emulateLegacyImagePyramid?new $.Point(0,0):$.TileSource.prototype.getTileAtPoint.call(this,level,point)},getTileUrl:function(level,x,y){if(this.emulateLegacyImagePyramid){var url=null;return this.levels.length>0&&level>=this.minLevel&&level<=this.maxLevel&&(url=this.levels[level].url),url}var tileWidth,tileHeight,iiifTileSizeWidth,iiifTileSizeHeight,iiifRegion,iiifTileX,iiifTileY,iiifTileW,iiifTileH,iiifSize,iiifSizeW,iiifSizeH,iiifQuality,scale=Math.pow(.5,this.maxLevel-level),levelWidth=Math.ceil(this.width*scale),levelHeight=Math.ceil(this.height*scale);return tileWidth=this.getTileWidth(level),tileHeight=this.getTileHeight(level),iiifTileSizeWidth=Math.ceil(tileWidth/scale),iiifTileSizeHeight=Math.ceil(tileHeight/scale),iiifQuality=1===this.version?"native."+this.tileFormat:"default."+this.tileFormat,levelWidth<tileWidth&&levelHeight<tileHeight?(iiifSize=2===this.version&&levelWidth===this.width||3===this.version&&levelWidth===this.width&&levelHeight===this.height?"max":3===this.version?levelWidth+","+levelHeight:levelWidth+",",iiifRegion="full"):(iiifTileX=x*iiifTileSizeWidth,iiifTileY=y*iiifTileSizeHeight,iiifTileW=Math.min(iiifTileSizeWidth,this.width-iiifTileX),iiifTileH=Math.min(iiifTileSizeHeight,this.height-iiifTileY),iiifRegion=0===x&&0===y&&iiifTileW===this.width&&iiifTileH===this.height?"full":[iiifTileX,iiifTileY,iiifTileW,iiifTileH].join(","),iiifSizeW=Math.ceil(iiifTileW*scale),iiifSizeH=Math.ceil(iiifTileH*scale),iiifSize=2===this.version&&iiifSizeW===this.width||3===this.version&&iiifSizeW===this.width&&iiifSizeH===this.height?"max":3===this.version?iiifSizeW+","+iiifSizeH:iiifSizeW+","),[this["@id"],iiifRegion,iiifSize,"0",iiifQuality].join("/")},__testonly__:{canBeTiled,constructLevels}})}(OpenSeadragon),function($){$.OsmTileSource=function(width,height,tileSize,tileOverlap,tilesUrl){var options;(options=$.isPlainObject(width)?width:{width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]}).width&&options.height||(options.width=65572864,options.height=65572864),options.tileSize||(options.tileSize=256,options.tileOverlap=0),options.tilesUrl||(options.tilesUrl="http://tile.openstreetmap.org/"),options.minLevel=8,$.TileSource.apply(this,[options])},$.extend($.OsmTileSource.prototype,$.TileSource.prototype,{supports:function(data,url){return data.type&&"openstreetmaps"==data.type},configure:function(data,url){return data},getTileUrl:function(level,x,y){return this.tilesUrl+(level-8)+"/"+x+"/"+y+".png"}})}(OpenSeadragon),function($){$.TmsTileSource=function(width,height,tileSize,tileOverlap,tilesUrl){var options;options=$.isPlainObject(width)?width:{width:arguments[0],height:arguments[1],tileSize:arguments[2],tileOverlap:arguments[3],tilesUrl:arguments[4]};var max,bufferedWidth=256*Math.ceil(options.width/256),bufferedHeight=256*Math.ceil(options.height/256);max=bufferedWidth>bufferedHeight?bufferedWidth/256:bufferedHeight/256,options.maxLevel=Math.ceil(Math.log(max)/Math.log(2))-1,options.tileSize=256,options.width=bufferedWidth,options.height=bufferedHeight,$.TileSource.apply(this,[options])},$.extend($.TmsTileSource.prototype,$.TileSource.prototype,{supports:function(data,url){return data.type&&"tiledmapservice"==data.type},configure:function(data,url){return data},getTileUrl:function(level,x,y){var yTiles=this.getNumTiles(level).y-1;return this.tilesUrl+level+"/"+x+"/"+(yTiles-y)+".png"}})}(OpenSeadragon),function($){$.ZoomifyTileSource=function(options){options.tileSize=256;var currentImageSize={x:options.width,y:options.height};for(options.imageSizes=[{x:options.width,y:options.height}],options.gridSize=[this._getGridSize(options.width,options.height,options.tileSize)];parseInt(currentImageSize.x,10)>options.tileSize||parseInt(currentImageSize.y,10)>options.tileSize;)currentImageSize.x=Math.floor(currentImageSize.x/2),currentImageSize.y=Math.floor(currentImageSize.y/2),options.imageSizes.push({x:currentImageSize.x,y:currentImageSize.y}),options.gridSize.push(this._getGridSize(currentImageSize.x,currentImageSize.y,options.tileSize));options.imageSizes.reverse(),options.gridSize.reverse(),options.minLevel=0,options.maxLevel=options.gridSize.length-1,OpenSeadragon.TileSource.apply(this,[options])},$.extend($.ZoomifyTileSource.prototype,$.TileSource.prototype,{_getGridSize:function(width,height,tileSize){return{x:Math.ceil(width/tileSize),y:Math.ceil(height/tileSize)}},_calculateAbsoluteTileNumber:function(level,x,y){for(var num=0,size={},z=0;z<level;z++)num+=(size=this.gridSize[z]).x*size.y;return num+=(size=this.gridSize[level]).x*y+x},supports:function(data,url){return data.type&&"zoomifytileservice"==data.type},configure:function(data,url){return data},getTileUrl:function(level,x,y){var result,num=this._calculateAbsoluteTileNumber(level,x,y);return result=Math.floor(num/256),this.tilesUrl+"TileGroup"+result+"/"+level+"-"+x+"-"+y+".jpg"}})}(OpenSeadragon),function($){function configureFromObject(tileSource,configuration){return configuration.levels}$.LegacyTileSource=function(levels){var options,width,height;$.isArray(levels)&&(options={type:"legacy-image-pyramid",levels}),options.levels=function filterFiles(files){var file,i,filtered=[];for(i=0;i<files.length;i++)(file=files[i]).height&&file.width&&file.url?filtered.push({url:file.url,width:Number(file.width),height:Number(file.height)}):$.console.error("Unsupported image format: %s",file.url?file.url:"<no URL>");return filtered.sort((function(a,b){return a.height-b.height}))}(options.levels),options.levels.length>0?(width=options.levels[options.levels.length-1].width,height=options.levels[options.levels.length-1].height):(width=0,height=0,$.console.error("No supported image formats found")),$.extend(!0,options,{width,height,tileSize:Math.max(height,width),tileOverlap:0,minLevel:0,maxLevel:options.levels.length>0?options.levels.length-1:0}),$.TileSource.apply(this,[options]),this.levels=options.levels},$.extend($.LegacyTileSource.prototype,$.TileSource.prototype,{supports:function(data,url){return data.type&&"legacy-image-pyramid"==data.type||data.documentElement&&"legacy-image-pyramid"==data.documentElement.getAttribute("type")},configure:function(configuration,dataUrl){return $.isPlainObject(configuration)?configureFromObject(this,configuration):function configureFromXML(tileSource,xmlDoc){if(!xmlDoc||!xmlDoc.documentElement)throw new Error($.getString("Errors.Xml"));var level,i,root=xmlDoc.documentElement,rootName=root.tagName,conf=null,levels=[];if("image"==rootName)try{for(conf={type:root.getAttribute("type"),levels:[]},levels=root.getElementsByTagName("level"),i=0;i<levels.length;i++)level=levels[i],conf.levels.push({url:level.getAttribute("url"),width:parseInt(level.getAttribute("width"),10),height:parseInt(level.getAttribute("height"),10)});return configureFromObject(tileSource,conf)}catch(e){throw e instanceof Error?e:new Error("Unknown error parsing Legacy Image Pyramid XML.")}else{if("collection"==rootName)throw new Error("Legacy Image Pyramid Collections not yet supported.");if("error"==rootName)throw new Error("Error: "+xmlDoc)}throw new Error("Unknown element "+rootName)}(this,configuration)},getLevelScale:function(level){var levelScale=NaN;return this.levels.length>0&&level>=this.minLevel&&level<=this.maxLevel&&(levelScale=this.levels[level].width/this.levels[this.maxLevel].width),levelScale},getNumTiles:function(level){return this.getLevelScale(level)?new $.Point(1,1):new $.Point(0,0)},getTileUrl:function(level,x,y){var url=null;return this.levels.length>0&&level>=this.minLevel&&level<=this.maxLevel&&(url=this.levels[level].url),url}})}(OpenSeadragon),function($){$.ImageTileSource=function(options){options=$.extend({buildPyramid:!0,crossOriginPolicy:!1,ajaxWithCredentials:!1,useCanvas:!0},options),$.TileSource.apply(this,[options])},$.extend($.ImageTileSource.prototype,$.TileSource.prototype,{supports:function(data,url){return data.type&&"image"===data.type},configure:function(options,dataUrl){return options},getImageInfo:function(url){var image=this._image=new Image,_this=this;this.crossOriginPolicy&&(image.crossOrigin=this.crossOriginPolicy),this.ajaxWithCredentials&&(image.useCredentials=this.ajaxWithCredentials),$.addEvent(image,"load",(function(){_this.width=Object.prototype.hasOwnProperty.call(image,"naturalWidth")?image.naturalWidth:image.width,_this.height=Object.prototype.hasOwnProperty.call(image,"naturalHeight")?image.naturalHeight:image.height,_this.aspectRatio=_this.width/_this.height,_this.dimensions=new $.Point(_this.width,_this.height),_this._tileWidth=_this.width,_this._tileHeight=_this.height,_this.tileOverlap=0,_this.minLevel=0,_this.levels=_this._buildLevels(),_this.maxLevel=_this.levels.length-1,_this.ready=!0,_this.raiseEvent("ready",{tileSource:_this})})),$.addEvent(image,"error",(function(){_this.raiseEvent("open-failed",{message:"Error loading image at "+url,source:url})})),image.src=url},getLevelScale:function(level){var levelScale=NaN;return level>=this.minLevel&&level<=this.maxLevel&&(levelScale=this.levels[level].width/this.levels[this.maxLevel].width),levelScale},getNumTiles:function(level){return this.getLevelScale(level)?new $.Point(1,1):new $.Point(0,0)},getTileUrl:function(level,x,y){var url=null;return level>=this.minLevel&&level<=this.maxLevel&&(url=this.levels[level].url),url},getContext2D:function(level,x,y){var context=null;return level>=this.minLevel&&level<=this.maxLevel&&(context=this.levels[level].context2D),context},_buildLevels:function(){var levels=[{url:this._image.src,width:Object.prototype.hasOwnProperty.call(this._image,"naturalWidth")?this._image.naturalWidth:this._image.width,height:Object.prototype.hasOwnProperty.call(this._image,"naturalHeight")?this._image.naturalHeight:this._image.height}];if(!this.buildPyramid||!$.supportsCanvas||!this.useCanvas)return delete this._image,levels;var currentWidth=Object.prototype.hasOwnProperty.call(this._image,"naturalWidth")?this._image.naturalWidth:this._image.width,currentHeight=Object.prototype.hasOwnProperty.call(this._image,"naturalHeight")?this._image.naturalHeight:this._image.height,bigCanvas=document.createElement("canvas"),bigContext=bigCanvas.getContext("2d");if(bigCanvas.width=currentWidth,bigCanvas.height=currentHeight,bigContext.drawImage(this._image,0,0,currentWidth,currentHeight),levels[0].context2D=bigContext,delete this._image,$.isCanvasTainted(bigCanvas))return levels;for(;currentWidth>=2&&currentHeight>=2;){currentWidth=Math.floor(currentWidth/2),currentHeight=Math.floor(currentHeight/2);var smallCanvas=document.createElement("canvas"),smallContext=smallCanvas.getContext("2d");smallCanvas.width=currentWidth,smallCanvas.height=currentHeight,smallContext.drawImage(bigCanvas,0,0,currentWidth,currentHeight),levels.splice(0,0,{context2D:smallContext,width:currentWidth,height:currentHeight}),bigCanvas=smallCanvas,bigContext=smallContext}return levels}})}(OpenSeadragon),function($){$.TileSourceCollection=function(tileSize,tileSources,rows,layout){$.console.error("TileSourceCollection is deprecated; use World instead")}}(OpenSeadragon),function($){function scheduleFade(button){$.requestAnimationFrame((function(){!function updateFade(button){var opacity;button.shouldFade&&(opacity=1-($.now()-button.fadeBeginTime)/button.fadeLength,opacity=Math.min(1,opacity),opacity=Math.max(0,opacity),button.imgGroup&&$.setElementOpacity(button.imgGroup,opacity,!0),opacity>0&&scheduleFade(button))}(button)}))}function inTo(button,newState){button.element.disabled||(newState>=$.ButtonState.GROUP&&button.currentState==$.ButtonState.REST&&(!function stopFading(button){button.shouldFade=!1,button.imgGroup&&$.setElementOpacity(button.imgGroup,1,!0)}(button),button.currentState=$.ButtonState.GROUP),newState>=$.ButtonState.HOVER&&button.currentState==$.ButtonState.GROUP&&(button.imgHover&&(button.imgHover.style.visibility=""),button.currentState=$.ButtonState.HOVER),newState>=$.ButtonState.DOWN&&button.currentState==$.ButtonState.HOVER&&(button.imgDown&&(button.imgDown.style.visibility=""),button.currentState=$.ButtonState.DOWN))}function outTo(button,newState){button.element.disabled||(newState<=$.ButtonState.HOVER&&button.currentState==$.ButtonState.DOWN&&(button.imgDown&&(button.imgDown.style.visibility="hidden"),button.currentState=$.ButtonState.HOVER),newState<=$.ButtonState.GROUP&&button.currentState==$.ButtonState.HOVER&&(button.imgHover&&(button.imgHover.style.visibility="hidden"),button.currentState=$.ButtonState.GROUP),newState<=$.ButtonState.REST&&button.currentState==$.ButtonState.GROUP&&(!function beginFading(button){button.shouldFade=!0,button.fadeBeginTime=$.now()+button.fadeDelay,window.setTimeout((function(){scheduleFade(button)}),button.fadeDelay)}(button),button.currentState=$.ButtonState.REST))}$.ButtonState={REST:0,GROUP:1,HOVER:2,DOWN:3},$.Button=function(options){var _this=this;$.EventSource.call(this),$.extend(!0,this,{tooltip:null,srcRest:null,srcGroup:null,srcHover:null,srcDown:null,clickTimeThreshold:$.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:$.DEFAULT_SETTINGS.clickDistThreshold,fadeDelay:0,fadeLength:2e3,onPress:null,onRelease:null,onClick:null,onEnter:null,onExit:null,onFocus:null,onBlur:null},options),this.element=options.element||$.makeNeutralElement("div"),options.element||(this.imgRest=$.makeTransparentImage(this.srcRest),this.imgGroup=$.makeTransparentImage(this.srcGroup),this.imgHover=$.makeTransparentImage(this.srcHover),this.imgDown=$.makeTransparentImage(this.srcDown),this.imgRest.alt=this.imgGroup.alt=this.imgHover.alt=this.imgDown.alt=this.tooltip,this.element.style.position="relative",$.setElementTouchActionNone(this.element),this.imgGroup.style.position=this.imgHover.style.position=this.imgDown.style.position="absolute",this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top="0px",this.imgGroup.style.left=this.imgHover.style.left=this.imgDown.style.left="0px",this.imgHover.style.visibility=this.imgDown.style.visibility="hidden",$.Browser.vendor==$.BROWSERS.FIREFOX&&$.Browser.version<3&&(this.imgGroup.style.top=this.imgHover.style.top=this.imgDown.style.top=""),this.element.appendChild(this.imgRest),this.element.appendChild(this.imgGroup),this.element.appendChild(this.imgHover),this.element.appendChild(this.imgDown)),this.addHandler("press",this.onPress),this.addHandler("release",this.onRelease),this.addHandler("click",this.onClick),this.addHandler("enter",this.onEnter),this.addHandler("exit",this.onExit),this.addHandler("focus",this.onFocus),this.addHandler("blur",this.onBlur),this.currentState=$.ButtonState.GROUP,this.fadeBeginTime=null,this.shouldFade=!1,this.element.style.display="inline-block",this.element.style.position="relative",this.element.title=this.tooltip,this.tracker=new $.MouseTracker({element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(event){event.insideElementPressed?(inTo(_this,$.ButtonState.DOWN),_this.raiseEvent("enter",{originalEvent:event.originalEvent})):event.buttonDownAny||inTo(_this,$.ButtonState.HOVER)},focusHandler:function(event){this.enterHandler(event),_this.raiseEvent("focus",{originalEvent:event.originalEvent})},exitHandler:function(event){outTo(_this,$.ButtonState.GROUP),event.insideElementPressed&&_this.raiseEvent("exit",{originalEvent:event.originalEvent})},blurHandler:function(event){this.exitHandler(event),_this.raiseEvent("blur",{originalEvent:event.originalEvent})},pressHandler:function(event){inTo(_this,$.ButtonState.DOWN),_this.raiseEvent("press",{originalEvent:event.originalEvent})},releaseHandler:function(event){event.insideElementPressed&&event.insideElementReleased?(outTo(_this,$.ButtonState.HOVER),_this.raiseEvent("release",{originalEvent:event.originalEvent})):event.insideElementPressed?outTo(_this,$.ButtonState.GROUP):inTo(_this,$.ButtonState.HOVER)},clickHandler:function(event){event.quick&&_this.raiseEvent("click",{originalEvent:event.originalEvent})},keyHandler:function(event){return 13!==event.keyCode||(_this.raiseEvent("click",{originalEvent:event.originalEvent}),_this.raiseEvent("release",{originalEvent:event.originalEvent}),!1)}}),outTo(this,$.ButtonState.REST)},$.extend($.Button.prototype,$.EventSource.prototype,{notifyGroupEnter:function(){inTo(this,$.ButtonState.GROUP)},notifyGroupExit:function(){outTo(this,$.ButtonState.REST)},disable:function(){this.notifyGroupExit(),this.element.disabled=!0,$.setElementOpacity(this.element,.2,!0)},enable:function(){this.element.disabled=!1,$.setElementOpacity(this.element,1,!0),this.notifyGroupEnter()}})}(OpenSeadragon),function($){$.ButtonGroup=function(options){$.extend(!0,this,{buttons:[],clickTimeThreshold:$.DEFAULT_SETTINGS.clickTimeThreshold,clickDistThreshold:$.DEFAULT_SETTINGS.clickDistThreshold,labelText:""},options);var i,buttons=this.buttons.concat([]),_this=this;if(this.element=options.element||$.makeNeutralElement("div"),!options.group)for(this.element.style.display="inline-block",i=0;i<buttons.length;i++)this.element.appendChild(buttons[i].element);$.setElementTouchActionNone(this.element),this.tracker=new $.MouseTracker({element:this.element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,enterHandler:function(event){var i;for(i=0;i<_this.buttons.length;i++)_this.buttons[i].notifyGroupEnter()},exitHandler:function(event){var i;if(!event.insideElementPressed)for(i=0;i<_this.buttons.length;i++)_this.buttons[i].notifyGroupExit()}})},$.ButtonGroup.prototype={emulateEnter:function(){this.tracker.enterHandler({eventSource:this.tracker})},emulateExit:function(){this.tracker.exitHandler({eventSource:this.tracker})}}}(OpenSeadragon),function($){$.Rect=function(x,y,width,height,degrees){var newTopLeft,newWidth;this.x="number"==typeof x?x:0,this.y="number"==typeof y?y:0,this.width="number"==typeof width?width:0,this.height="number"==typeof height?height:0,this.degrees="number"==typeof degrees?degrees:0,this.degrees=$.positiveModulo(this.degrees,360),this.degrees>=270?(newTopLeft=this.getTopRight(),this.x=newTopLeft.x,this.y=newTopLeft.y,newWidth=this.height,this.height=this.width,this.width=newWidth,this.degrees-=270):this.degrees>=180?(newTopLeft=this.getBottomRight(),this.x=newTopLeft.x,this.y=newTopLeft.y,this.degrees-=180):this.degrees>=90&&(newTopLeft=this.getBottomLeft(),this.x=newTopLeft.x,this.y=newTopLeft.y,newWidth=this.height,this.height=this.width,this.width=newWidth,this.degrees-=90)},$.Rect.fromSummits=function(topLeft,topRight,bottomLeft){var width=topLeft.distanceTo(topRight),height=topLeft.distanceTo(bottomLeft),diff=topRight.minus(topLeft),radians=Math.atan(diff.y/diff.x);return diff.x<0?radians+=Math.PI:diff.y<0&&(radians+=2*Math.PI),new $.Rect(topLeft.x,topLeft.y,width,height,radians/Math.PI*180)},$.Rect.prototype={clone:function(){return new $.Rect(this.x,this.y,this.width,this.height,this.degrees)},getAspectRatio:function(){return this.width/this.height},getTopLeft:function(){return new $.Point(this.x,this.y)},getBottomRight:function(){return new $.Point(this.x+this.width,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getTopRight:function(){return new $.Point(this.x+this.width,this.y).rotate(this.degrees,this.getTopLeft())},getBottomLeft:function(){return new $.Point(this.x,this.y+this.height).rotate(this.degrees,this.getTopLeft())},getCenter:function(){return new $.Point(this.x+this.width/2,this.y+this.height/2).rotate(this.degrees,this.getTopLeft())},getSize:function(){return new $.Point(this.width,this.height)},equals:function(other){return other instanceof $.Rect&&this.x===other.x&&this.y===other.y&&this.width===other.width&&this.height===other.height&&this.degrees===other.degrees},times:function(factor){return new $.Rect(this.x*factor,this.y*factor,this.width*factor,this.height*factor,this.degrees)},translate:function(delta){return new $.Rect(this.x+delta.x,this.y+delta.y,this.width,this.height,this.degrees)},union:function(rect){var thisBoundingBox=this.getBoundingBox(),otherBoundingBox=rect.getBoundingBox(),left=Math.min(thisBoundingBox.x,otherBoundingBox.x),top=Math.min(thisBoundingBox.y,otherBoundingBox.y),right=Math.max(thisBoundingBox.x+thisBoundingBox.width,otherBoundingBox.x+otherBoundingBox.width),bottom=Math.max(thisBoundingBox.y+thisBoundingBox.height,otherBoundingBox.y+otherBoundingBox.height);return new $.Rect(left,top,right-left,bottom-top)},intersection:function(rect){var intersectionPoints=[],thisTopLeft=this.getTopLeft();rect.containsPoint(thisTopLeft,1e-10)&&intersectionPoints.push(thisTopLeft);var thisTopRight=this.getTopRight();rect.containsPoint(thisTopRight,1e-10)&&intersectionPoints.push(thisTopRight);var thisBottomLeft=this.getBottomLeft();rect.containsPoint(thisBottomLeft,1e-10)&&intersectionPoints.push(thisBottomLeft);var thisBottomRight=this.getBottomRight();rect.containsPoint(thisBottomRight,1e-10)&&intersectionPoints.push(thisBottomRight);var rectTopLeft=rect.getTopLeft();this.containsPoint(rectTopLeft,1e-10)&&intersectionPoints.push(rectTopLeft);var rectTopRight=rect.getTopRight();this.containsPoint(rectTopRight,1e-10)&&intersectionPoints.push(rectTopRight);var rectBottomLeft=rect.getBottomLeft();this.containsPoint(rectBottomLeft,1e-10)&&intersectionPoints.push(rectBottomLeft);var rectBottomRight=rect.getBottomRight();this.containsPoint(rectBottomRight,1e-10)&&intersectionPoints.push(rectBottomRight);for(var thisSegments=this._getSegments(),rectSegments=rect._getSegments(),i=0;i<thisSegments.length;i++)for(var thisSegment=thisSegments[i],j=0;j<rectSegments.length;j++){var rectSegment=rectSegments[j],intersect=getIntersection(thisSegment[0],thisSegment[1],rectSegment[0],rectSegment[1]);intersect&&intersectionPoints.push(intersect)}function getIntersection(a,b,c,d){var abVector=b.minus(a),cdVector=d.minus(c),denom=-cdVector.x*abVector.y+abVector.x*cdVector.y;if(0===denom)return null;var s=(abVector.x*(a.y-c.y)-abVector.y*(a.x-c.x))/denom,t=(cdVector.x*(a.y-c.y)-cdVector.y*(a.x-c.x))/denom;return-1e-10<=s&&s<=1-1e-10&&-1e-10<=t&&t<=1-1e-10?new $.Point(a.x+t*abVector.x,a.y+t*abVector.y):null}if(0===intersectionPoints.length)return null;for(var minX=intersectionPoints[0].x,maxX=intersectionPoints[0].x,minY=intersectionPoints[0].y,maxY=intersectionPoints[0].y,k=1;k<intersectionPoints.length;k++){var point=intersectionPoints[k];point.x<minX&&(minX=point.x),point.x>maxX&&(maxX=point.x),point.y<minY&&(minY=point.y),point.y>maxY&&(maxY=point.y)}return new $.Rect(minX,minY,maxX-minX,maxY-minY)},_getSegments:function(){var topLeft=this.getTopLeft(),topRight=this.getTopRight(),bottomLeft=this.getBottomLeft(),bottomRight=this.getBottomRight();return[[topLeft,topRight],[topRight,bottomRight],[bottomRight,bottomLeft],[bottomLeft,topLeft]]},rotate:function(degrees,pivot){if(0===(degrees=$.positiveModulo(degrees,360)))return this.clone();pivot=pivot||this.getCenter();var newTopLeft=this.getTopLeft().rotate(degrees,pivot),diff=this.getTopRight().rotate(degrees,pivot).minus(newTopLeft);diff=diff.apply((function(x){return Math.abs(x)<1e-15?0:x}));var radians=Math.atan(diff.y/diff.x);return diff.x<0?radians+=Math.PI:diff.y<0&&(radians+=2*Math.PI),new $.Rect(newTopLeft.x,newTopLeft.y,this.width,this.height,radians/Math.PI*180)},getBoundingBox:function(){if(0===this.degrees)return this.clone();var topLeft=this.getTopLeft(),topRight=this.getTopRight(),bottomLeft=this.getBottomLeft(),bottomRight=this.getBottomRight(),minX=Math.min(topLeft.x,topRight.x,bottomLeft.x,bottomRight.x),maxX=Math.max(topLeft.x,topRight.x,bottomLeft.x,bottomRight.x),minY=Math.min(topLeft.y,topRight.y,bottomLeft.y,bottomRight.y),maxY=Math.max(topLeft.y,topRight.y,bottomLeft.y,bottomRight.y);return new $.Rect(minX,minY,maxX-minX,maxY-minY)},getIntegerBoundingBox:function(){var boundingBox=this.getBoundingBox(),x=Math.floor(boundingBox.x),y=Math.floor(boundingBox.y),width=Math.ceil(boundingBox.width+boundingBox.x-x),height=Math.ceil(boundingBox.height+boundingBox.y-y);return new $.Rect(x,y,width,height)},containsPoint:function(point,epsilon){epsilon=epsilon||0;var topLeft=this.getTopLeft(),topRight=this.getTopRight(),bottomLeft=this.getBottomLeft(),topDiff=topRight.minus(topLeft),leftDiff=bottomLeft.minus(topLeft);return(point.x-topLeft.x)*topDiff.x+(point.y-topLeft.y)*topDiff.y>=-epsilon&&(point.x-topRight.x)*topDiff.x+(point.y-topRight.y)*topDiff.y<=epsilon&&(point.x-topLeft.x)*leftDiff.x+(point.y-topLeft.y)*leftDiff.y>=-epsilon&&(point.x-bottomLeft.x)*leftDiff.x+(point.y-bottomLeft.y)*leftDiff.y<=epsilon},toString:function(){return"["+Math.round(100*this.x)/100+", "+Math.round(100*this.y)/100+", "+Math.round(100*this.width)/100+"x"+Math.round(100*this.height)/100+", "+Math.round(100*this.degrees)/100+"deg]"}}}(OpenSeadragon),function($){var THIS={};function onStripDrag(event){var offsetLeft=Number(this.element.style.marginLeft.replace("px","")),offsetTop=Number(this.element.style.marginTop.replace("px","")),scrollWidth=Number(this.element.style.width.replace("px","")),scrollHeight=Number(this.element.style.height.replace("px","")),viewerSize=$.getElementSize(this.viewer.canvas);return this.dragging=!0,this.element&&("horizontal"==this.scroll?-event.delta.x>0?offsetLeft>-(scrollWidth-viewerSize.x)&&(this.element.style.marginLeft=offsetLeft+2*event.delta.x+"px",loadPanels(this,viewerSize.x,offsetLeft+2*event.delta.x)):-event.delta.x<0&&offsetLeft<0&&(this.element.style.marginLeft=offsetLeft+2*event.delta.x+"px",loadPanels(this,viewerSize.x,offsetLeft+2*event.delta.x)):-event.delta.y>0?offsetTop>-(scrollHeight-viewerSize.y)&&(this.element.style.marginTop=offsetTop+2*event.delta.y+"px",loadPanels(this,viewerSize.y,offsetTop+2*event.delta.y)):-event.delta.y<0&&offsetTop<0&&(this.element.style.marginTop=offsetTop+2*event.delta.y+"px",loadPanels(this,viewerSize.y,offsetTop+2*event.delta.y))),!1}function onStripScroll(event){var offsetLeft=Number(this.element.style.marginLeft.replace("px","")),offsetTop=Number(this.element.style.marginTop.replace("px","")),scrollWidth=Number(this.element.style.width.replace("px","")),scrollHeight=Number(this.element.style.height.replace("px","")),viewerSize=$.getElementSize(this.viewer.canvas);return this.element&&("horizontal"==this.scroll?event.scroll>0?offsetLeft>-(scrollWidth-viewerSize.x)&&(this.element.style.marginLeft=offsetLeft-60*event.scroll+"px",loadPanels(this,viewerSize.x,offsetLeft-60*event.scroll)):event.scroll<0&&offsetLeft<0&&(this.element.style.marginLeft=offsetLeft-60*event.scroll+"px",loadPanels(this,viewerSize.x,offsetLeft-60*event.scroll)):event.scroll<0?offsetTop>viewerSize.y-scrollHeight&&(this.element.style.marginTop=offsetTop+60*event.scroll+"px",loadPanels(this,viewerSize.y,offsetTop+60*event.scroll)):event.scroll>0&&offsetTop<0&&(this.element.style.marginTop=offsetTop+60*event.scroll+"px",loadPanels(this,viewerSize.y,offsetTop+60*event.scroll))),!1}function loadPanels(strip,viewerSize,scroll){var panelSize,activePanelsStart,activePanelsEnd,miniViewer,style,i,element;for(panelSize="horizontal"==strip.scroll?strip.panelWidth:strip.panelHeight,activePanelsStart=Math.ceil(viewerSize/panelSize)+5,i=activePanelsStart=(activePanelsStart=(activePanelsEnd=Math.ceil((Math.abs(scroll)+viewerSize)/panelSize)+1)-activePanelsStart)<0?0:activePanelsStart;i<activePanelsEnd&&i<strip.panels.length;i++)if(!(element=strip.panels[i]).activePanel){var miniTileSource,originalTileSource=strip.viewer.tileSources[i];miniTileSource=originalTileSource.referenceStripThumbnailUrl?{type:"image",url:originalTileSource.referenceStripThumbnailUrl}:originalTileSource,(miniViewer=new $.Viewer({id:element.id,tileSources:[miniTileSource],element,navigatorSizeRatio:strip.sizeRatio,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1,immediateRender:!0,blendTime:0,animationTime:0,loadTilesWithAjax:strip.viewer.loadTilesWithAjax,ajaxHeaders:strip.viewer.ajaxHeaders,useCanvas:strip.useCanvas})).displayRegion=$.makeNeutralElement("div"),miniViewer.displayRegion.id=element.id+"-displayregion",miniViewer.displayRegion.className="displayregion",(style=miniViewer.displayRegion.style).position="relative",style.top="0px",style.left="0px",style.fontSize="0px",style.overflow="hidden",style.float="left",style.cssFloat="left",style.styleFloat="left",style.zIndex=999999999,style.cursor="default",style.width=strip.panelWidth-4+"px",style.height=strip.panelHeight-4+"px",miniViewer.displayRegion.innerTracker=new $.MouseTracker({element:miniViewer.displayRegion,startDisabled:!0}),element.getElementsByTagName("div")[0].appendChild(miniViewer.displayRegion),strip.miniViewers[element.id]=miniViewer,element.activePanel=!0}}function onStripEnter(event){var element=event.eventSource.element;return"horizontal"==this.scroll?element.style.marginBottom="0px":element.style.marginLeft="0px",!1}function onStripExit(event){var element=event.eventSource.element;return"horizontal"==this.scroll?element.style.marginBottom="-"+$.getElementSize(element).y/2+"px":element.style.marginLeft="-"+$.getElementSize(element).x/2+"px",!1}function onKeyDown(event){if(event.preventDefaultAction||event.ctrl||event.alt||event.meta)return!0;switch(event.keyCode){case 38:case 39:return onStripScroll.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;case 40:case 37:return onStripScroll.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;default:return!0}}function onKeyPress(event){if(event.preventDefaultAction||event.ctrl||event.alt||event.meta)return!0;switch(event.keyCode){case 61:case 48:case 119:case 87:case 100:return onStripScroll.call(this,{eventSource:this.tracker,position:null,scroll:1,shift:null}),!1;case 45:case 115:case 83:case 97:return onStripScroll.call(this,{eventSource:this.tracker,position:null,scroll:-1,shift:null}),!1;default:return!0}}$.ReferenceStrip=function(options){var element,style,i,viewer=options.viewer,viewerSize=$.getElementSize(viewer.element);for(options.id||(options.id="referencestrip-"+$.now(),this.element=$.makeNeutralElement("div"),this.element.id=options.id,this.element.className="referencestrip"),options=$.extend(!0,{sizeRatio:$.DEFAULT_SETTINGS.referenceStripSizeRatio,position:$.DEFAULT_SETTINGS.referenceStripPosition,scroll:$.DEFAULT_SETTINGS.referenceStripScroll,clickTimeThreshold:$.DEFAULT_SETTINGS.clickTimeThreshold},options,{element:this.element,showNavigator:!1,mouseNavEnabled:!1,showNavigationControl:!1,showSequenceControl:!1}),$.extend(this,options),THIS[this.id]={animating:!1},this.minPixelRatio=this.viewer.minPixelRatio,(style=this.element.style).marginTop="0px",style.marginRight="0px",style.marginBottom="0px",style.marginLeft="0px",style.left="0px",style.bottom="0px",style.border="0px",style.background="#000",style.position="relative",$.setElementTouchActionNone(this.element),$.setElementOpacity(this.element,.8),this.viewer=viewer,this.innerTracker=new $.MouseTracker({element:this.element,dragHandler:$.delegate(this,onStripDrag),scrollHandler:$.delegate(this,onStripScroll),enterHandler:$.delegate(this,onStripEnter),exitHandler:$.delegate(this,onStripExit),keyDownHandler:$.delegate(this,onKeyDown),keyHandler:$.delegate(this,onKeyPress)}),options.width&&options.height?(this.element.style.width=options.width+"px",this.element.style.height=options.height+"px",viewer.addControl(this.element,{anchor:$.ControlAnchor.BOTTOM_LEFT})):"horizontal"==options.scroll?(this.element.style.width=viewerSize.x*options.sizeRatio*viewer.tileSources.length+12*viewer.tileSources.length+"px",this.element.style.height=viewerSize.y*options.sizeRatio+"px",viewer.addControl(this.element,{anchor:$.ControlAnchor.BOTTOM_LEFT})):(this.element.style.height=viewerSize.y*options.sizeRatio*viewer.tileSources.length+12*viewer.tileSources.length+"px",this.element.style.width=viewerSize.x*options.sizeRatio+"px",viewer.addControl(this.element,{anchor:$.ControlAnchor.TOP_LEFT})),this.panelWidth=viewerSize.x*this.sizeRatio+8,this.panelHeight=viewerSize.y*this.sizeRatio+8,this.panels=[],this.miniViewers={},i=0;i<viewer.tileSources.length;i++)(element=$.makeNeutralElement("div")).id=this.element.id+"-"+i,element.style.width=this.panelWidth+"px",element.style.height=this.panelHeight+"px",element.style.display="inline",element.style.float="left",element.style.cssFloat="left",element.style.styleFloat="left",element.style.padding="2px",$.setElementTouchActionNone(element),element.innerTracker=new $.MouseTracker({element,clickTimeThreshold:this.clickTimeThreshold,clickDistThreshold:this.clickDistThreshold,pressHandler:function(event){event.eventSource.dragging=$.now()},releaseHandler:function(event){var tracker=event.eventSource,id=tracker.element.id,page=Number(id.split("-")[2]),now=$.now();event.insideElementPressed&&event.insideElementReleased&&tracker.dragging&&now-tracker.dragging<tracker.clickTimeThreshold&&(tracker.dragging=null,viewer.goToPage(page))}}),this.element.appendChild(element),element.activePanel=!1,this.panels.push(element);loadPanels(this,"vertical"==this.scroll?viewerSize.y:viewerSize.x,0),this.setFocus(0)},$.extend($.ReferenceStrip.prototype,$.EventSource.prototype,$.Viewer.prototype,{setFocus:function(page){var offset,element=this.element.querySelector("#"+this.element.id+"-"+page),viewerSize=$.getElementSize(this.viewer.canvas),scrollWidth=Number(this.element.style.width.replace("px","")),scrollHeight=Number(this.element.style.height.replace("px","")),offsetLeft=-Number(this.element.style.marginLeft.replace("px","")),offsetTop=-Number(this.element.style.marginTop.replace("px",""));this.currentSelected!==element&&(this.currentSelected&&(this.currentSelected.style.background="#000"),this.currentSelected=element,this.currentSelected.style.background="#999","horizontal"==this.scroll?(offset=Number(page)*(this.panelWidth+3))>offsetLeft+viewerSize.x-this.panelWidth?(offset=Math.min(offset,scrollWidth-viewerSize.x),this.element.style.marginLeft=-offset+"px",loadPanels(this,viewerSize.x,-offset)):offset<offsetLeft&&(offset=Math.max(0,offset-viewerSize.x/2),this.element.style.marginLeft=-offset+"px",loadPanels(this,viewerSize.x,-offset)):(offset=Number(page)*(this.panelHeight+3))>offsetTop+viewerSize.y-this.panelHeight?(offset=Math.min(offset,scrollHeight-viewerSize.y),this.element.style.marginTop=-offset+"px",loadPanels(this,viewerSize.y,-offset)):offset<offsetTop&&(offset=Math.max(0,offset-viewerSize.y/2),this.element.style.marginTop=-offset+"px",loadPanels(this,viewerSize.y,-offset)),this.currentPage=page,onStripEnter.call(this,{eventSource:this.innerTracker}))},update:function(){return!!THIS[this.id].animating&&($.console.log("image reference strip update"),!0)},destroy:function(){if(this.miniViewers)for(var key in this.miniViewers)this.miniViewers[key].destroy();this.element&&this.element.parentNode.removeChild(this.element)}})}(OpenSeadragon),function($){$.DisplayRect=function(x,y,width,height,minLevel,maxLevel){$.Rect.apply(this,[x,y,width,height]),this.minLevel=minLevel,this.maxLevel=maxLevel},$.extend($.DisplayRect.prototype,$.Rect.prototype)}(OpenSeadragon),function($){$.Spring=function(options){var args=arguments;"object"!=typeof options&&(options={initial:args.length&&"number"==typeof args[0]?args[0]:void 0,springStiffness:args.length>1?args[1].springStiffness:5,animationTime:args.length>1?args[1].animationTime:1.5}),$.console.assert("number"==typeof options.springStiffness&&0!==options.springStiffness,"[OpenSeadragon.Spring] options.springStiffness must be a non-zero number"),$.console.assert("number"==typeof options.animationTime&&options.animationTime>=0,"[OpenSeadragon.Spring] options.animationTime must be a number greater than or equal to 0"),options.exponential&&(this._exponential=!0,delete options.exponential),$.extend(!0,this,options),this.current={value:"number"==typeof this.initial?this.initial:this._exponential?0:1,time:$.now()},$.console.assert(!this._exponential||0!==this.current.value,"[OpenSeadragon.Spring] value must be non-zero for exponential springs"),this.start={value:this.current.value,time:this.current.time},this.target={value:this.current.value,time:this.current.time},this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},$.Spring.prototype={resetTo:function(target){$.console.assert(!this._exponential||0!==target,"[OpenSeadragon.Spring.resetTo] target must be non-zero for exponential springs"),this.start.value=this.target.value=this.current.value=target,this.start.time=this.target.time=this.current.time=$.now(),this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},springTo:function(target){$.console.assert(!this._exponential||0!==target,"[OpenSeadragon.Spring.springTo] target must be non-zero for exponential springs"),this.start.value=this.current.value,this.start.time=this.current.time,this.target.value=target,this.target.time=this.start.time+1e3*this.animationTime,this._exponential&&(this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},shiftBy:function(delta){this.start.value+=delta,this.target.value+=delta,this._exponential&&($.console.assert(0!==this.target.value&&0!==this.start.value,"[OpenSeadragon.Spring.shiftBy] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value))},setExponential:function(value){this._exponential=value,this._exponential&&($.console.assert(0!==this.current.value&&0!==this.target.value&&0!==this.start.value,"[OpenSeadragon.Spring.setExponential] spring value must be non-zero for exponential springs"),this.start._logValue=Math.log(this.start.value),this.target._logValue=Math.log(this.target.value),this.current._logValue=Math.log(this.current.value))},update:function(){var startValue,targetValue;this.current.time=$.now(),this._exponential?(startValue=this.start._logValue,targetValue=this.target._logValue):(startValue=this.start.value,targetValue=this.target.value);var currentValue=this.current.time>=this.target.time?targetValue:startValue+(targetValue-startValue)*function transform(stiffness,x){return(1-Math.exp(stiffness*-x))/(1-Math.exp(-stiffness))}(this.springStiffness,(this.current.time-this.start.time)/(this.target.time-this.start.time)),oldValue=this.current.value;return this._exponential?this.current.value=Math.exp(currentValue):this.current.value=currentValue,oldValue!=this.current.value},isAtTargetValue:function(){return this.current.value===this.target.value}}}(OpenSeadragon),function($){function ImageJob(options){$.extend(!0,this,{timeout:$.DEFAULT_SETTINGS.timeout,jobId:null},options),this.image=null}ImageJob.prototype={errorMsg:null,start:function(){var self=this,selfAbort=this.abort;this.image=new Image,this.image.onload=function(){self.finish(!0)},this.image.onabort=this.image.onerror=function(){self.errorMsg="Image load aborted",self.finish(!1)},this.jobId=window.setTimeout((function(){self.errorMsg="Image load exceeded timeout ("+self.timeout+" ms)",self.finish(!1)}),this.timeout),this.loadWithAjax?(this.request=$.makeAjaxRequest({url:this.src,withCredentials:this.ajaxWithCredentials,headers:this.ajaxHeaders,responseType:"arraybuffer",success:function(request){var blb;try{blb=new window.Blob([request.response])}catch(e){var BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if("TypeError"===e.name&&BlobBuilder){var bb=new BlobBuilder;bb.append(request.response),blb=bb.getBlob()}}0===blb.size&&(self.errorMsg="Empty image response.",self.finish(!1));var url=(window.URL||window.webkitURL).createObjectURL(blb);self.image.src=url},error:function(request){self.errorMsg="Image load aborted - XHR error",self.finish(!1)}}),this.abort=function(){self.request.abort(),"function"==typeof selfAbort&&selfAbort()}):(!1!==this.crossOriginPolicy&&(this.image.crossOrigin=this.crossOriginPolicy),this.image.src=this.src)},finish:function(successful){this.image.onload=this.image.onerror=this.image.onabort=null,successful||(this.image=null),this.jobId&&window.clearTimeout(this.jobId),this.callback(this)}},$.ImageLoader=function(options){$.extend(!0,this,{jobLimit:$.DEFAULT_SETTINGS.imageLoaderLimit,timeout:$.DEFAULT_SETTINGS.timeout,jobQueue:[],jobsInProgress:0},options)},$.ImageLoader.prototype={addJob:function(options){var _this=this,newJob=new ImageJob({src:options.src,loadWithAjax:options.loadWithAjax,ajaxHeaders:options.loadWithAjax?options.ajaxHeaders:null,crossOriginPolicy:options.crossOriginPolicy,ajaxWithCredentials:options.ajaxWithCredentials,callback:function(job){!function completeJob(loader,job,callback){loader.jobsInProgress--,(!loader.jobLimit||loader.jobsInProgress<loader.jobLimit)&&loader.jobQueue.length>0&&(loader.jobQueue.shift().start(),loader.jobsInProgress++);callback(job.image,job.errorMsg,job.request)}(_this,job,options.callback)},abort:options.abort,timeout:this.timeout});!this.jobLimit||this.jobsInProgress<this.jobLimit?(newJob.start(),this.jobsInProgress++):this.jobQueue.push(newJob)},clear:function(){for(var i=0;i<this.jobQueue.length;i++){var job=this.jobQueue[i];"function"==typeof job.abort&&job.abort()}this.jobQueue=[]}}}(OpenSeadragon),function($){$.Tile=function(level,x,y,bounds,exists,url,context2D,loadWithAjax,ajaxHeaders,sourceBounds){this.level=level,this.x=x,this.y=y,this.bounds=bounds,this.sourceBounds=sourceBounds,this.exists=exists,this.url=url,this.context2D=context2D,this.loadWithAjax=loadWithAjax,this.ajaxHeaders=ajaxHeaders,this.ajaxHeaders?this.cacheKey=this.url+"+"+JSON.stringify(this.ajaxHeaders):this.cacheKey=this.url,this.loaded=!1,this.loading=!1,this.element=null,this.imgElement=null,this.image=null,this.style=null,this.position=null,this.size=null,this.blendStart=null,this.opacity=null,this.squaredDistance=null,this.visibility=null,this.beingDrawn=!1,this.lastTouchTime=0,this.isRightMost=!1,this.isBottomMost=!1},$.Tile.prototype={toString:function(){return this.level+"/"+this.x+"_"+this.y},_hasTransparencyChannel:function(){return!!this.context2D||this.url.match(".png")},drawHTML:function(container){this.cacheImageRecord?this.loaded?(this.element||(this.element=$.makeNeutralElement("div"),this.imgElement=this.cacheImageRecord.getImage().cloneNode(),this.imgElement.style.msInterpolationMode="nearest-neighbor",this.imgElement.style.width="100%",this.imgElement.style.height="100%",this.style=this.element.style,this.style.position="absolute"),this.element.parentNode!=container&&container.appendChild(this.element),this.imgElement.parentNode!=this.element&&this.element.appendChild(this.imgElement),this.style.top=this.position.y+"px",this.style.left=this.position.x+"px",this.style.height=this.size.y+"px",this.style.width=this.size.x+"px",$.setElementOpacity(this.element,this.opacity)):$.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString()):$.console.warn("[Tile.drawHTML] attempting to draw tile %s when it's not cached",this.toString())},drawCanvas:function(context,drawingHandler,scale,translate){var rendered,sourceWidth,sourceHeight,position=this.position.times($.pixelDensityRatio),size=this.size.times($.pixelDensityRatio);this.context2D||this.cacheImageRecord?(rendered=this.context2D||this.cacheImageRecord.getRenderedContext(),this.loaded&&rendered?(context.save(),context.globalAlpha=this.opacity,"number"==typeof scale&&1!==scale&&(position=position.times(scale),size=size.times(scale)),translate instanceof $.Point&&(position=position.plus(translate)),1===context.globalAlpha&&this._hasTransparencyChannel()&&context.clearRect(position.x,position.y,size.x,size.y),drawingHandler({context,tile:this,rendered}),this.sourceBounds?(sourceWidth=Math.min(this.sourceBounds.width,rendered.canvas.width),sourceHeight=Math.min(this.sourceBounds.height,rendered.canvas.height)):(sourceWidth=rendered.canvas.width,sourceHeight=rendered.canvas.height),context.drawImage(rendered.canvas,0,0,sourceWidth,sourceHeight,position.x,position.y,size.x,size.y),context.restore()):$.console.warn("Attempting to draw tile %s when it's not yet loaded.",this.toString())):$.console.warn("[Tile.drawCanvas] attempting to draw tile %s when it's not cached",this.toString())},getScaleForEdgeSmoothing:function(){var context;if(this.cacheImageRecord)context=this.cacheImageRecord.getRenderedContext();else{if(!this.context2D)return $.console.warn("[Tile.drawCanvas] attempting to get tile scale %s when tile's not cached",this.toString()),1;context=this.context2D}return context.canvas.width/(this.size.x*$.pixelDensityRatio)},getTranslationForEdgeSmoothing:function(scale,canvasSize,sketchCanvasSize){var x=Math.max(1,Math.ceil((sketchCanvasSize.x-canvasSize.x)/2)),y=Math.max(1,Math.ceil((sketchCanvasSize.y-canvasSize.y)/2));return new $.Point(x,y).minus(this.position.times($.pixelDensityRatio).times(scale||1).apply((function(x){return x%1})))},unload:function(){this.imgElement&&this.imgElement.parentNode&&this.imgElement.parentNode.removeChild(this.imgElement),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.imgElement=null,this.loaded=!1,this.loading=!1}}}(OpenSeadragon),function($){$.OverlayPlacement=$.Placement,$.OverlayRotationMode=$.freezeObject({NO_ROTATION:1,EXACT:2,BOUNDING_BOX:3}),$.Overlay=function(element,location,placement){var options;options=$.isPlainObject(element)?element:{element,location,placement},this.element=options.element,this.style=options.element.style,this._init(options)},$.Overlay.prototype={_init:function(options){this.location=options.location,this.placement=void 0===options.placement?$.Placement.TOP_LEFT:options.placement,this.onDraw=options.onDraw,this.checkResize=void 0===options.checkResize||options.checkResize,this.width=void 0===options.width?null:options.width,this.height=void 0===options.height?null:options.height,this.rotationMode=options.rotationMode||$.OverlayRotationMode.EXACT,this.location instanceof $.Rect&&(this.width=this.location.width,this.height=this.location.height,this.location=this.location.getTopLeft(),this.placement=$.Placement.TOP_LEFT),this.scales=null!==this.width&&null!==this.height,this.bounds=new $.Rect(this.location.x,this.location.y,this.width,this.height),this.position=this.location},adjust:function(position,size){var properties=$.Placement.properties[this.placement];properties&&(properties.isHorizontallyCentered?position.x-=size.x/2:properties.isRight&&(position.x-=size.x),properties.isVerticallyCentered?position.y-=size.y/2:properties.isBottom&&(position.y-=size.y))},destroy:function(){var element=this.element,style=this.style;element.parentNode&&(element.parentNode.removeChild(element),element.prevElementParent&&(style.display="none",document.body.appendChild(element))),this.onDraw=null,style.top="",style.left="",style.position="",null!==this.width&&(style.width=""),null!==this.height&&(style.height="");var transformOriginProp=$.getCssPropertyWithVendorPrefix("transformOrigin"),transformProp=$.getCssPropertyWithVendorPrefix("transform");transformOriginProp&&transformProp&&(style[transformOriginProp]="",style[transformProp]="")},drawHTML:function(container,viewport){var element=this.element;element.parentNode!==container&&(element.prevElementParent=element.parentNode,element.prevNextSibling=element.nextSibling,container.appendChild(element),this.style.position="absolute",this.size=$.getElementSize(element));var positionAndSize=this._getOverlayPositionAndSize(viewport),position=positionAndSize.position,size=this.size=positionAndSize.size,rotate=positionAndSize.rotate;if(this.onDraw)this.onDraw(position,size,this.element);else{var style=this.style;style.left=position.x+"px",style.top=position.y+"px",null!==this.width&&(style.width=size.x+"px"),null!==this.height&&(style.height=size.y+"px");var transformOriginProp=$.getCssPropertyWithVendorPrefix("transformOrigin"),transformProp=$.getCssPropertyWithVendorPrefix("transform");transformOriginProp&&transformProp&&(rotate?(style[transformOriginProp]=this._getTransformOrigin(),style[transformProp]="rotate("+rotate+"deg)"):(style[transformOriginProp]="",style[transformProp]="")),"none"!==style.display&&(style.display="block")}},_getOverlayPositionAndSize:function(viewport){var position=viewport.pixelFromPoint(this.location,!0),size=this._getSizeInPixels(viewport);this.adjust(position,size);var rotate=0;if(viewport.degrees&&this.rotationMode!==$.OverlayRotationMode.NO_ROTATION)if(this.rotationMode===$.OverlayRotationMode.BOUNDING_BOX&&null!==this.width&&null!==this.height){var rect=new $.Rect(position.x,position.y,size.x,size.y),boundingBox=this._getBoundingBox(rect,viewport.degrees);position=boundingBox.getTopLeft(),size=boundingBox.getSize()}else rotate=viewport.degrees;return{position,size,rotate}},_getSizeInPixels:function(viewport){var width=this.size.x,height=this.size.y;if(null!==this.width||null!==this.height){var scaledSize=viewport.deltaPixelsFromPointsNoRotate(new $.Point(this.width||0,this.height||0),!0);null!==this.width&&(width=scaledSize.x),null!==this.height&&(height=scaledSize.y)}if(this.checkResize&&(null===this.width||null===this.height)){var eltSize=this.size=$.getElementSize(this.element);null===this.width&&(width=eltSize.x),null===this.height&&(height=eltSize.y)}return new $.Point(width,height)},_getBoundingBox:function(rect,degrees){var refPoint=this._getPlacementPoint(rect);return rect.rotate(degrees,refPoint).getBoundingBox()},_getPlacementPoint:function(rect){var result=new $.Point(rect.x,rect.y),properties=$.Placement.properties[this.placement];return properties&&(properties.isHorizontallyCentered?result.x+=rect.width/2:properties.isRight&&(result.x+=rect.width),properties.isVerticallyCentered?result.y+=rect.height/2:properties.isBottom&&(result.y+=rect.height)),result},_getTransformOrigin:function(){var result="",properties=$.Placement.properties[this.placement];return properties?(properties.isLeft?result="left":properties.isRight&&(result="right"),properties.isTop?result+=" top":properties.isBottom&&(result+=" bottom"),result):result},update:function(location,placement){var options=$.isPlainObject(location)?location:{location,placement};this._init({location:options.location||this.location,placement:void 0!==options.placement?options.placement:this.placement,onDraw:options.onDraw||this.onDraw,checkResize:options.checkResize||this.checkResize,width:void 0!==options.width?options.width:this.width,height:void 0!==options.height?options.height:this.height,rotationMode:options.rotationMode||this.rotationMode})},getBounds:function(viewport){$.console.assert(viewport,"A viewport must now be passed to Overlay.getBounds.");var width=this.width,height=this.height;if(null===width||null===height){var size=viewport.deltaPointsFromPixelsNoRotate(this.size,!0);null===width&&(width=size.x),null===height&&(height=size.y)}var location=this.location.clone();return this.adjust(location,new $.Point(width,height)),this._adjustBoundsForRotation(viewport,new $.Rect(location.x,location.y,width,height))},_adjustBoundsForRotation:function(viewport,bounds){if(!viewport||0===viewport.degrees||this.rotationMode===$.OverlayRotationMode.EXACT)return bounds;if(this.rotationMode===$.OverlayRotationMode.BOUNDING_BOX){if(null===this.width||null===this.height)return bounds;var positionAndSize=this._getOverlayPositionAndSize(viewport);return viewport.viewerElementToViewportRectangle(new $.Rect(positionAndSize.position.x,positionAndSize.position.y,positionAndSize.size.x,positionAndSize.size.y))}return bounds.rotate(-viewport.degrees,this._getPlacementPoint(bounds))}}}(OpenSeadragon),function($){$.Drawer=function(options){$.console.assert(options.viewer,"[Drawer] options.viewer is required");var args=arguments;if($.isPlainObject(options)||(options={source:args[0],viewport:args[1],element:args[2]}),$.console.assert(options.viewport,"[Drawer] options.viewport is required"),$.console.assert(options.element,"[Drawer] options.element is required"),options.source&&$.console.error("[Drawer] options.source is no longer accepted; use TiledImage instead"),this.viewer=options.viewer,this.viewport=options.viewport,this.debugGridColor="string"==typeof options.debugGridColor?[options.debugGridColor]:options.debugGridColor||$.DEFAULT_SETTINGS.debugGridColor,options.opacity&&$.console.error("[Drawer] options.opacity is no longer accepted; set the opacity on the TiledImage instead"),this.useCanvas=$.supportsCanvas&&(!this.viewer||this.viewer.useCanvas),this.container=$.getElement(options.element),this.canvas=$.makeNeutralElement(this.useCanvas?"canvas":"div"),this.context=this.useCanvas?this.canvas.getContext("2d"):null,this.sketchCanvas=null,this.sketchContext=null,this.element=this.container,this.container.dir="ltr",this.useCanvas){var viewportSize=this._calculateCanvasSize();this.canvas.width=viewportSize.x,this.canvas.height=viewportSize.y}this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="absolute",$.setElementOpacity(this.canvas,this.opacity,!0),this.container.style.textAlign="left",this.container.appendChild(this.canvas),this._imageSmoothingEnabled=!0},$.Drawer.prototype={addOverlay:function(element,location,placement,onDraw){return $.console.error("drawer.addOverlay is deprecated. Use viewer.addOverlay instead."),this.viewer.addOverlay(element,location,placement,onDraw),this},updateOverlay:function(element,location,placement){return $.console.error("drawer.updateOverlay is deprecated. Use viewer.updateOverlay instead."),this.viewer.updateOverlay(element,location,placement),this},removeOverlay:function(element){return $.console.error("drawer.removeOverlay is deprecated. Use viewer.removeOverlay instead."),this.viewer.removeOverlay(element),this},clearOverlays:function(){return $.console.error("drawer.clearOverlays is deprecated. Use viewer.clearOverlays instead."),this.viewer.clearOverlays(),this},viewportCoordToDrawerCoord:function(point){var vpPoint=this.viewport.pixelFromPointNoRotate(point,!0);return new $.Point(vpPoint.x*$.pixelDensityRatio,vpPoint.y*$.pixelDensityRatio)},clipWithPolygons:function(polygons,useSketch){if(this.useCanvas){var context=this._getContext(useSketch);context.beginPath(),polygons.forEach((function(polygon){polygon.forEach((function(coord,i){context[0===i?"moveTo":"lineTo"](coord.x,coord.y)}))})),context.clip()}},setOpacity:function(opacity){$.console.error("drawer.setOpacity is deprecated. Use tiledImage.setOpacity instead.");for(var world=this.viewer.world,i=0;i<world.getItemCount();i++)world.getItemAt(i).setOpacity(opacity);return this},getOpacity:function(){$.console.error("drawer.getOpacity is deprecated. Use tiledImage.getOpacity instead.");for(var world=this.viewer.world,maxOpacity=0,i=0;i<world.getItemCount();i++){var opacity=world.getItemAt(i).getOpacity();opacity>maxOpacity&&(maxOpacity=opacity)}return maxOpacity},needsUpdate:function(){return $.console.error("[Drawer.needsUpdate] this function is deprecated. Use World.needsDraw instead."),this.viewer.world.needsDraw()},numTilesLoaded:function(){return $.console.error("[Drawer.numTilesLoaded] this function is deprecated. Use TileCache.numTilesLoaded instead."),this.viewer.tileCache.numTilesLoaded()},reset:function(){return $.console.error("[Drawer.reset] this function is deprecated. Use World.resetItems instead."),this.viewer.world.resetItems(),this},update:function(){return $.console.error("[Drawer.update] this function is deprecated. Use Drawer.clear and World.draw instead."),this.clear(),this.viewer.world.draw(),this},canRotate:function(){return this.useCanvas},destroy:function(){this.canvas.width=1,this.canvas.height=1,this.sketchCanvas=null,this.sketchContext=null},clear:function(){if(this.canvas.innerHTML="",this.useCanvas){var viewportSize=this._calculateCanvasSize();if((this.canvas.width!=viewportSize.x||this.canvas.height!=viewportSize.y)&&(this.canvas.width=viewportSize.x,this.canvas.height=viewportSize.y,this._updateImageSmoothingEnabled(this.context),null!==this.sketchCanvas)){var sketchCanvasSize=this._calculateSketchCanvasSize();this.sketchCanvas.width=sketchCanvasSize.x,this.sketchCanvas.height=sketchCanvasSize.y,this._updateImageSmoothingEnabled(this.sketchContext)}this._clear()}},_clear:function(useSketch,bounds){if(this.useCanvas){var context=this._getContext(useSketch);if(bounds)context.clearRect(bounds.x,bounds.y,bounds.width,bounds.height);else{var canvas=context.canvas;context.clearRect(0,0,canvas.width,canvas.height)}}},viewportToDrawerRectangle:function(rectangle){var topLeft=this.viewport.pixelFromPointNoRotate(rectangle.getTopLeft(),!0),size=this.viewport.deltaPixelsFromPointsNoRotate(rectangle.getSize(),!0);return new $.Rect(topLeft.x*$.pixelDensityRatio,topLeft.y*$.pixelDensityRatio,size.x*$.pixelDensityRatio,size.y*$.pixelDensityRatio)},drawTile:function(tile,drawingHandler,useSketch,scale,translate){if($.console.assert(tile,"[Drawer.drawTile] tile is required"),$.console.assert(drawingHandler,"[Drawer.drawTile] drawingHandler is required"),this.useCanvas){var context=this._getContext(useSketch);scale=scale||1,tile.drawCanvas(context,drawingHandler,scale,translate)}else tile.drawHTML(this.canvas)},_getContext:function(useSketch){var context=this.context;if(useSketch){if(null===this.sketchCanvas){this.sketchCanvas=document.createElement("canvas");var sketchCanvasSize=this._calculateSketchCanvasSize();if(this.sketchCanvas.width=sketchCanvasSize.x,this.sketchCanvas.height=sketchCanvasSize.y,this.sketchContext=this.sketchCanvas.getContext("2d"),0===this.viewport.getRotation()){var self=this;this.viewer.addHandler("rotate",(function resizeSketchCanvas(){if(0!==self.viewport.getRotation()){self.viewer.removeHandler("rotate",resizeSketchCanvas);var sketchCanvasSize=self._calculateSketchCanvasSize();self.sketchCanvas.width=sketchCanvasSize.x,self.sketchCanvas.height=sketchCanvasSize.y}}))}this._updateImageSmoothingEnabled(this.sketchContext)}context=this.sketchContext}return context},saveContext:function(useSketch){this.useCanvas&&this._getContext(useSketch).save()},restoreContext:function(useSketch){this.useCanvas&&this._getContext(useSketch).restore()},setClip:function(rect,useSketch){if(this.useCanvas){var context=this._getContext(useSketch);context.beginPath(),context.rect(rect.x,rect.y,rect.width,rect.height),context.clip()}},drawRectangle:function(rect,fillStyle,useSketch){if(this.useCanvas){var context=this._getContext(useSketch);context.save(),context.fillStyle=fillStyle,context.fillRect(rect.x,rect.y,rect.width,rect.height),context.restore()}},blendSketch:function(opacity,scale,translate,compositeOperation){var options=opacity;if($.isPlainObject(options)||(options={opacity,scale,translate,compositeOperation}),this.useCanvas&&this.sketchCanvas){opacity=options.opacity,compositeOperation=options.compositeOperation;var bounds=options.bounds;if(this.context.save(),this.context.globalAlpha=opacity,compositeOperation&&(this.context.globalCompositeOperation=compositeOperation),bounds)bounds.x<0&&(bounds.width+=bounds.x,bounds.x=0),bounds.x+bounds.width>this.canvas.width&&(bounds.width=this.canvas.width-bounds.x),bounds.y<0&&(bounds.height+=bounds.y,bounds.y=0),bounds.y+bounds.height>this.canvas.height&&(bounds.height=this.canvas.height-bounds.y),this.context.drawImage(this.sketchCanvas,bounds.x,bounds.y,bounds.width,bounds.height,bounds.x,bounds.y,bounds.width,bounds.height);else{scale=options.scale||1;var position=(translate=options.translate)instanceof $.Point?translate:new $.Point(0,0),widthExt=0,heightExt=0;if(translate){var widthDiff=this.sketchCanvas.width-this.canvas.width,heightDiff=this.sketchCanvas.height-this.canvas.height;widthExt=Math.round(widthDiff/2),heightExt=Math.round(heightDiff/2)}this.context.drawImage(this.sketchCanvas,position.x-widthExt*scale,position.y-heightExt*scale,(this.canvas.width+2*widthExt)*scale,(this.canvas.height+2*heightExt)*scale,-widthExt,-heightExt,this.canvas.width+2*widthExt,this.canvas.height+2*heightExt)}this.context.restore()}},drawDebugInfo:function(tile,count,i,tiledImage){if(this.useCanvas){var colorIndex=this.viewer.world.getIndexOfItem(tiledImage)%this.debugGridColor.length,context=this.context;context.save(),context.lineWidth=2*$.pixelDensityRatio,context.font="small-caps bold "+13*$.pixelDensityRatio+"px arial",context.strokeStyle=this.debugGridColor[colorIndex],context.fillStyle=this.debugGridColor[colorIndex],0!==this.viewport.degrees&&this._offsetForRotation({degrees:this.viewport.degrees}),tiledImage.getRotation(!0)%360!=0&&this._offsetForRotation({degrees:tiledImage.getRotation(!0),point:tiledImage.viewport.pixelFromPointNoRotate(tiledImage._getRotationPoint(!0),!0)}),0===tiledImage.viewport.degrees&&tiledImage.getRotation(!0)%360==0&&tiledImage._drawer.viewer.viewport.getFlip()&&tiledImage._drawer._flip(),context.strokeRect(tile.position.x*$.pixelDensityRatio,tile.position.y*$.pixelDensityRatio,tile.size.x*$.pixelDensityRatio,tile.size.y*$.pixelDensityRatio);var tileCenterX=(tile.position.x+tile.size.x/2)*$.pixelDensityRatio,tileCenterY=(tile.position.y+tile.size.y/2)*$.pixelDensityRatio;context.translate(tileCenterX,tileCenterY),context.rotate(Math.PI/180*-this.viewport.degrees),context.translate(-tileCenterX,-tileCenterY),0===tile.x&&0===tile.y&&(context.fillText("Zoom: "+this.viewport.getZoom(),tile.position.x*$.pixelDensityRatio,(tile.position.y-30)*$.pixelDensityRatio),context.fillText("Pan: "+this.viewport.getBounds().toString(),tile.position.x*$.pixelDensityRatio,(tile.position.y-20)*$.pixelDensityRatio)),context.fillText("Level: "+tile.level,(tile.position.x+10)*$.pixelDensityRatio,(tile.position.y+20)*$.pixelDensityRatio),context.fillText("Column: "+tile.x,(tile.position.x+10)*$.pixelDensityRatio,(tile.position.y+30)*$.pixelDensityRatio),context.fillText("Row: "+tile.y,(tile.position.x+10)*$.pixelDensityRatio,(tile.position.y+40)*$.pixelDensityRatio),context.fillText("Order: "+i+" of "+count,(tile.position.x+10)*$.pixelDensityRatio,(tile.position.y+50)*$.pixelDensityRatio),context.fillText("Size: "+tile.size.toString(),(tile.position.x+10)*$.pixelDensityRatio,(tile.position.y+60)*$.pixelDensityRatio),context.fillText("Position: "+tile.position.toString(),(tile.position.x+10)*$.pixelDensityRatio,(tile.position.y+70)*$.pixelDensityRatio),0!==this.viewport.degrees&&this._restoreRotationChanges(),tiledImage.getRotation(!0)%360!=0&&this._restoreRotationChanges(),0===tiledImage.viewport.degrees&&tiledImage.getRotation(!0)%360==0&&tiledImage._drawer.viewer.viewport.getFlip()&&tiledImage._drawer._flip(),context.restore()}},debugRect:function(rect){if(this.useCanvas){var context=this.context;context.save(),context.lineWidth=2*$.pixelDensityRatio,context.strokeStyle=this.debugGridColor[0],context.fillStyle=this.debugGridColor[0],context.strokeRect(rect.x*$.pixelDensityRatio,rect.y*$.pixelDensityRatio,rect.width*$.pixelDensityRatio,rect.height*$.pixelDensityRatio),context.restore()}},setImageSmoothingEnabled:function(imageSmoothingEnabled){this.useCanvas&&(this._imageSmoothingEnabled=imageSmoothingEnabled,this._updateImageSmoothingEnabled(this.context),this.viewer.forceRedraw())},_updateImageSmoothingEnabled:function(context){context.msImageSmoothingEnabled=this._imageSmoothingEnabled,context.imageSmoothingEnabled=this._imageSmoothingEnabled},getCanvasSize:function(sketch){var canvas=this._getContext(sketch).canvas;return new $.Point(canvas.width,canvas.height)},getCanvasCenter:function(){return new $.Point(this.canvas.width/2,this.canvas.height/2)},_offsetForRotation:function(options){var point=options.point?options.point.times($.pixelDensityRatio):this.getCanvasCenter(),context=this._getContext(options.useSketch);context.save(),context.translate(point.x,point.y),this.viewer.viewport.flipped?(context.rotate(Math.PI/180*-options.degrees),context.scale(-1,1)):context.rotate(Math.PI/180*options.degrees),context.translate(-point.x,-point.y)},_flip:function(options){var point=(options=options||{}).point?options.point.times($.pixelDensityRatio):this.getCanvasCenter(),context=this._getContext(options.useSketch);context.translate(point.x,0),context.scale(-1,1),context.translate(-point.x,0)},_restoreRotationChanges:function(useSketch){this._getContext(useSketch).restore()},_calculateCanvasSize:function(){var pixelDensityRatio=$.pixelDensityRatio,viewportSize=this.viewport.getContainerSize();return{x:Math.round(viewportSize.x*pixelDensityRatio),y:Math.round(viewportSize.y*pixelDensityRatio)}},_calculateSketchCanvasSize:function(){var canvasSize=this._calculateCanvasSize();if(0===this.viewport.getRotation())return canvasSize;var sketchCanvasSize=Math.ceil(Math.sqrt(canvasSize.x*canvasSize.x+canvasSize.y*canvasSize.y));return{x:sketchCanvasSize,y:sketchCanvasSize}}}}(OpenSeadragon),function($){$.Viewport=function(options){var args=arguments;args.length&&args[0]instanceof $.Point&&(options={containerSize:args[0],contentSize:args[1],config:args[2]}),options.config&&($.extend(!0,options,options.config),delete options.config),this._margins=$.extend({left:0,top:0,right:0,bottom:0},options.margins||{}),delete options.margins,$.extend(!0,this,{containerSize:null,contentSize:null,zoomPoint:null,viewer:null,springStiffness:$.DEFAULT_SETTINGS.springStiffness,animationTime:$.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:$.DEFAULT_SETTINGS.minZoomImageRatio,maxZoomPixelRatio:$.DEFAULT_SETTINGS.maxZoomPixelRatio,visibilityRatio:$.DEFAULT_SETTINGS.visibilityRatio,wrapHorizontal:$.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:$.DEFAULT_SETTINGS.wrapVertical,defaultZoomLevel:$.DEFAULT_SETTINGS.defaultZoomLevel,minZoomLevel:$.DEFAULT_SETTINGS.minZoomLevel,maxZoomLevel:$.DEFAULT_SETTINGS.maxZoomLevel,degrees:$.DEFAULT_SETTINGS.degrees,flipped:$.DEFAULT_SETTINGS.flipped,homeFillsViewer:$.DEFAULT_SETTINGS.homeFillsViewer},options),this._updateContainerInnerSize(),this.centerSpringX=new $.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.centerSpringY=new $.Spring({initial:0,springStiffness:this.springStiffness,animationTime:this.animationTime}),this.zoomSpring=new $.Spring({exponential:!0,initial:1,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,this._setContentBounds(new $.Rect(0,0,1,1),1),this.goHome(!0),this.update()},$.Viewport.prototype={resetContentSize:function(contentSize){return $.console.assert(contentSize,"[Viewport.resetContentSize] contentSize is required"),$.console.assert(contentSize instanceof $.Point,"[Viewport.resetContentSize] contentSize must be an OpenSeadragon.Point"),$.console.assert(contentSize.x>0,"[Viewport.resetContentSize] contentSize.x must be greater than 0"),$.console.assert(contentSize.y>0,"[Viewport.resetContentSize] contentSize.y must be greater than 0"),this._setContentBounds(new $.Rect(0,0,1,contentSize.y/contentSize.x),contentSize.x),this},setHomeBounds:function(bounds,contentFactor){$.console.error("[Viewport.setHomeBounds] this function is deprecated; The content bounds should not be set manually."),this._setContentBounds(bounds,contentFactor)},_setContentBounds:function(bounds,contentFactor){$.console.assert(bounds,"[Viewport._setContentBounds] bounds is required"),$.console.assert(bounds instanceof $.Rect,"[Viewport._setContentBounds] bounds must be an OpenSeadragon.Rect"),$.console.assert(bounds.width>0,"[Viewport._setContentBounds] bounds.width must be greater than 0"),$.console.assert(bounds.height>0,"[Viewport._setContentBounds] bounds.height must be greater than 0"),this._contentBoundsNoRotate=bounds.clone(),this._contentSizeNoRotate=this._contentBoundsNoRotate.getSize().times(contentFactor),this._contentBounds=bounds.rotate(this.degrees).getBoundingBox(),this._contentSize=this._contentBounds.getSize().times(contentFactor),this._contentAspectRatio=this._contentSize.x/this._contentSize.y,this.viewer&&this.viewer.raiseEvent("reset-size",{contentSize:this._contentSizeNoRotate.clone(),contentFactor,homeBounds:this._contentBoundsNoRotate.clone(),contentBounds:this._contentBounds.clone()})},getHomeZoom:function(){if(this.defaultZoomLevel)return this.defaultZoomLevel;var aspectFactor=this._contentAspectRatio/this.getAspectRatio();return(this.homeFillsViewer?aspectFactor>=1?aspectFactor:1:aspectFactor>=1?1:aspectFactor)/this._contentBounds.width},getHomeBounds:function(){return this.getHomeBoundsNoRotate().rotate(-this.getRotation())},getHomeBoundsNoRotate:function(){var center=this._contentBounds.getCenter(),width=1/this.getHomeZoom(),height=width/this.getAspectRatio();return new $.Rect(center.x-width/2,center.y-height/2,width,height)},goHome:function(immediately){return this.viewer&&this.viewer.raiseEvent("home",{immediately}),this.fitBounds(this.getHomeBounds(),immediately)},getMinZoom:function(){var homeZoom=this.getHomeZoom();return this.minZoomLevel?this.minZoomLevel:this.minZoomImageRatio*homeZoom},getMaxZoom:function(){var zoom=this.maxZoomLevel;return zoom||(zoom=this._contentSize.x*this.maxZoomPixelRatio/this._containerInnerSize.x,zoom/=this._contentBounds.width),Math.max(zoom,this.getHomeZoom())},getAspectRatio:function(){return this._containerInnerSize.x/this._containerInnerSize.y},getContainerSize:function(){return new $.Point(this.containerSize.x,this.containerSize.y)},getMargins:function(){return $.extend({},this._margins)},setMargins:function(margins){$.console.assert("object"===$.type(margins),"[Viewport.setMargins] margins must be an object"),this._margins=$.extend({left:0,top:0,right:0,bottom:0},margins),this._updateContainerInnerSize(),this.viewer&&this.viewer.forceRedraw()},getBounds:function(current){return this.getBoundsNoRotate(current).rotate(-this.getRotation())},getBoundsNoRotate:function(current){var center=this.getCenter(current),width=1/this.getZoom(current),height=width/this.getAspectRatio();return new $.Rect(center.x-width/2,center.y-height/2,width,height)},getBoundsWithMargins:function(current){return this.getBoundsNoRotateWithMargins(current).rotate(-this.getRotation(),this.getCenter(current))},getBoundsNoRotateWithMargins:function(current){var bounds=this.getBoundsNoRotate(current),factor=this._containerInnerSize.x*this.getZoom(current);return bounds.x-=this._margins.left/factor,bounds.y-=this._margins.top/factor,bounds.width+=(this._margins.left+this._margins.right)/factor,bounds.height+=(this._margins.top+this._margins.bottom)/factor,bounds},getCenter:function(current){var oldZoomPixel,zoom,width,height,bounds,deltaZoomPoints,centerCurrent=new $.Point(this.centerSpringX.current.value,this.centerSpringY.current.value),centerTarget=new $.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return current?centerCurrent:this.zoomPoint?(oldZoomPixel=this.pixelFromPoint(this.zoomPoint,!0),height=(width=1/(zoom=this.getZoom()))/this.getAspectRatio(),bounds=new $.Rect(centerCurrent.x-width/2,centerCurrent.y-height/2,width,height),deltaZoomPoints=this._pixelFromPoint(this.zoomPoint,bounds).minus(oldZoomPixel).divide(this._containerInnerSize.x*zoom),centerTarget.plus(deltaZoomPoints)):centerTarget},getZoom:function(current){return current?this.zoomSpring.current.value:this.zoomSpring.target.value},_applyZoomConstraints:function(zoom){return Math.max(Math.min(zoom,this.getMaxZoom()),this.getMinZoom())},_applyBoundaryConstraints:function(bounds){var newBounds=new $.Rect(bounds.x,bounds.y,bounds.width,bounds.height);if(this.wrapHorizontal);else{var horizontalThreshold=this.visibilityRatio*newBounds.width,boundsRight=newBounds.x+newBounds.width,contentRight=this._contentBoundsNoRotate.x+this._contentBoundsNoRotate.width,leftDx=this._contentBoundsNoRotate.x-boundsRight+horizontalThreshold,rightDx=contentRight-newBounds.x-horizontalThreshold;horizontalThreshold>this._contentBoundsNoRotate.width?newBounds.x+=(leftDx+rightDx)/2:rightDx<0?newBounds.x+=rightDx:leftDx>0&&(newBounds.x+=leftDx)}if(this.wrapVertical);else{var verticalThreshold=this.visibilityRatio*newBounds.height,boundsBottom=newBounds.y+newBounds.height,contentBottom=this._contentBoundsNoRotate.y+this._contentBoundsNoRotate.height,topDy=this._contentBoundsNoRotate.y-boundsBottom+verticalThreshold,bottomDy=contentBottom-newBounds.y-verticalThreshold;verticalThreshold>this._contentBoundsNoRotate.height?newBounds.y+=(topDy+bottomDy)/2:bottomDy<0?newBounds.y+=bottomDy:topDy>0&&(newBounds.y+=topDy)}return newBounds},_raiseConstraintsEvent:function(immediately){this.viewer&&this.viewer.raiseEvent("constrain",{immediately})},applyConstraints:function(immediately){var actualZoom=this.getZoom(),constrainedZoom=this._applyZoomConstraints(actualZoom);actualZoom!==constrainedZoom&&this.zoomTo(constrainedZoom,this.zoomPoint,immediately);var bounds=this.getBoundsNoRotate(),constrainedBounds=this._applyBoundaryConstraints(bounds);return this._raiseConstraintsEvent(immediately),(bounds.x!==constrainedBounds.x||bounds.y!==constrainedBounds.y||immediately)&&this.fitBounds(constrainedBounds.rotate(-this.getRotation()),immediately),this},ensureVisible:function(immediately){return this.applyConstraints(immediately)},_fitBounds:function(bounds,options){var immediately=(options=options||{}).immediately||!1,constraints=options.constraints||!1,aspect=this.getAspectRatio(),center=bounds.getCenter(),newBounds=new $.Rect(bounds.x,bounds.y,bounds.width,bounds.height,bounds.degrees+this.getRotation()).getBoundingBox();newBounds.getAspectRatio()>=aspect?newBounds.height=newBounds.width/aspect:newBounds.width=newBounds.height*aspect,newBounds.x=center.x-newBounds.width/2,newBounds.y=center.y-newBounds.height/2;var newZoom=1/newBounds.width;if(constraints){var newBoundsAspectRatio=newBounds.getAspectRatio(),newConstrainedZoom=this._applyZoomConstraints(newZoom);newZoom!==newConstrainedZoom&&(newZoom=newConstrainedZoom,newBounds.width=1/newZoom,newBounds.x=center.x-newBounds.width/2,newBounds.height=newBounds.width/newBoundsAspectRatio,newBounds.y=center.y-newBounds.height/2),center=(newBounds=this._applyBoundaryConstraints(newBounds)).getCenter(),this._raiseConstraintsEvent(immediately)}if(immediately)return this.panTo(center,!0),this.zoomTo(newZoom,null,!0);this.panTo(this.getCenter(!0),!0),this.zoomTo(this.getZoom(!0),null,!0);var oldBounds=this.getBounds(),oldZoom=this.getZoom();if(0===oldZoom||Math.abs(newZoom/oldZoom-1)<1e-8)return this.zoomTo(newZoom,!0),this.panTo(center,immediately);var referencePoint=(newBounds=newBounds.rotate(-this.getRotation())).getTopLeft().times(newZoom).minus(oldBounds.getTopLeft().times(oldZoom)).divide(newZoom-oldZoom);return this.zoomTo(newZoom,referencePoint,immediately)},fitBounds:function(bounds,immediately){return this._fitBounds(bounds,{immediately,constraints:!1})},fitBoundsWithConstraints:function(bounds,immediately){return this._fitBounds(bounds,{immediately,constraints:!0})},fitVertically:function(immediately){var box=new $.Rect(this._contentBounds.x+this._contentBounds.width/2,this._contentBounds.y,0,this._contentBounds.height);return this.fitBounds(box,immediately)},fitHorizontally:function(immediately){var box=new $.Rect(this._contentBounds.x,this._contentBounds.y+this._contentBounds.height/2,this._contentBounds.width,0);return this.fitBounds(box,immediately)},getConstrainedBounds:function(current){var bounds;return bounds=this.getBounds(current),this._applyBoundaryConstraints(bounds)},panBy:function(delta,immediately){var center=new $.Point(this.centerSpringX.target.value,this.centerSpringY.target.value);return this.panTo(center.plus(delta),immediately)},panTo:function(center,immediately){return immediately?(this.centerSpringX.resetTo(center.x),this.centerSpringY.resetTo(center.y)):(this.centerSpringX.springTo(center.x),this.centerSpringY.springTo(center.y)),this.viewer&&this.viewer.raiseEvent("pan",{center,immediately}),this},zoomBy:function(factor,refPoint,immediately){return this.zoomTo(this.zoomSpring.target.value*factor,refPoint,immediately)},zoomTo:function(zoom,refPoint,immediately){var _this=this;return this.zoomPoint=refPoint instanceof $.Point&&!isNaN(refPoint.x)&&!isNaN(refPoint.y)?refPoint:null,immediately?this._adjustCenterSpringsForZoomPoint((function(){_this.zoomSpring.resetTo(zoom)})):this.zoomSpring.springTo(zoom),this.viewer&&this.viewer.raiseEvent("zoom",{zoom,refPoint,immediately}),this},setRotation:function(degrees){return this.viewer&&this.viewer.drawer.canRotate()?(this.degrees=$.positiveModulo(degrees,360),this._setContentBounds(this.viewer.world.getHomeBounds(),this.viewer.world.getContentFactor()),this.viewer.forceRedraw(),this.viewer.raiseEvent("rotate",{degrees}),this):this},getRotation:function(){return this.degrees},resize:function(newContainerSize,maintain){var widthDeltaFactor,oldBounds=this.getBoundsNoRotate(),newBounds=oldBounds;return this.containerSize.x=newContainerSize.x,this.containerSize.y=newContainerSize.y,this._updateContainerInnerSize(),maintain&&(widthDeltaFactor=newContainerSize.x/this.containerSize.x,newBounds.width=oldBounds.width*widthDeltaFactor,newBounds.height=newBounds.width/this.getAspectRatio()),this.viewer&&this.viewer.raiseEvent("resize",{newContainerSize,maintain}),this.fitBounds(newBounds,!0)},_updateContainerInnerSize:function(){this._containerInnerSize=new $.Point(Math.max(1,this.containerSize.x-(this._margins.left+this._margins.right)),Math.max(1,this.containerSize.y-(this._margins.top+this._margins.bottom)))},update:function(){var _this=this;this._adjustCenterSpringsForZoomPoint((function(){_this.zoomSpring.update()})),this.centerSpringX.update(),this.centerSpringY.update();var changed=this.centerSpringX.current.value!==this._oldCenterX||this.centerSpringY.current.value!==this._oldCenterY||this.zoomSpring.current.value!==this._oldZoom;return this._oldCenterX=this.centerSpringX.current.value,this._oldCenterY=this.centerSpringY.current.value,this._oldZoom=this.zoomSpring.current.value,changed},_adjustCenterSpringsForZoomPoint:function(zoomSpringHandler){if(this.zoomPoint){var oldZoomPixel=this.pixelFromPoint(this.zoomPoint,!0);zoomSpringHandler();var deltaZoomPixels=this.pixelFromPoint(this.zoomPoint,!0).minus(oldZoomPixel),deltaZoomPoints=this.deltaPointsFromPixels(deltaZoomPixels,!0);this.centerSpringX.shiftBy(deltaZoomPoints.x),this.centerSpringY.shiftBy(deltaZoomPoints.y),this.zoomSpring.isAtTargetValue()&&(this.zoomPoint=null)}else zoomSpringHandler()},deltaPixelsFromPointsNoRotate:function(deltaPoints,current){return deltaPoints.times(this._containerInnerSize.x*this.getZoom(current))},deltaPixelsFromPoints:function(deltaPoints,current){return this.deltaPixelsFromPointsNoRotate(deltaPoints.rotate(this.getRotation()),current)},deltaPointsFromPixelsNoRotate:function(deltaPixels,current){return deltaPixels.divide(this._containerInnerSize.x*this.getZoom(current))},deltaPointsFromPixels:function(deltaPixels,current){return this.deltaPointsFromPixelsNoRotate(deltaPixels,current).rotate(-this.getRotation())},pixelFromPointNoRotate:function(point,current){return this._pixelFromPointNoRotate(point,this.getBoundsNoRotate(current))},pixelFromPoint:function(point,current){return this._pixelFromPoint(point,this.getBoundsNoRotate(current))},_pixelFromPointNoRotate:function(point,bounds){return point.minus(bounds.getTopLeft()).times(this._containerInnerSize.x/bounds.width).plus(new $.Point(this._margins.left,this._margins.top))},_pixelFromPoint:function(point,bounds){return this._pixelFromPointNoRotate(point.rotate(this.getRotation(),this.getCenter(!0)),bounds)},pointFromPixelNoRotate:function(pixel,current){var bounds=this.getBoundsNoRotate(current);return pixel.minus(new $.Point(this._margins.left,this._margins.top)).divide(this._containerInnerSize.x/bounds.width).plus(bounds.getTopLeft())},pointFromPixel:function(pixel,current){return this.pointFromPixelNoRotate(pixel,current).rotate(-this.getRotation(),this.getCenter(!0))},_viewportToImageDelta:function(viewerX,viewerY){var scale=this._contentBoundsNoRotate.width;return new $.Point(viewerX*this._contentSizeNoRotate.x/scale,viewerY*this._contentSizeNoRotate.x/scale)},viewportToImageCoordinates:function(viewerX,viewerY){if(viewerX instanceof $.Point)return this.viewportToImageCoordinates(viewerX.x,viewerX.y);if(this.viewer){var count=this.viewer.world.getItemCount();if(count>1)$.console.error("[Viewport.viewportToImageCoordinates] is not accurate with multi-image; use TiledImage.viewportToImageCoordinates instead.");else if(1===count){return this.viewer.world.getItemAt(0).viewportToImageCoordinates(viewerX,viewerY,!0)}}return this._viewportToImageDelta(viewerX-this._contentBoundsNoRotate.x,viewerY-this._contentBoundsNoRotate.y)},_imageToViewportDelta:function(imageX,imageY){var scale=this._contentBoundsNoRotate.width;return new $.Point(imageX/this._contentSizeNoRotate.x*scale,imageY/this._contentSizeNoRotate.x*scale)},imageToViewportCoordinates:function(imageX,imageY){if(imageX instanceof $.Point)return this.imageToViewportCoordinates(imageX.x,imageX.y);if(this.viewer){var count=this.viewer.world.getItemCount();if(count>1)$.console.error("[Viewport.imageToViewportCoordinates] is not accurate with multi-image; use TiledImage.imageToViewportCoordinates instead.");else if(1===count){return this.viewer.world.getItemAt(0).imageToViewportCoordinates(imageX,imageY,!0)}}var point=this._imageToViewportDelta(imageX,imageY);return point.x+=this._contentBoundsNoRotate.x,point.y+=this._contentBoundsNoRotate.y,point},imageToViewportRectangle:function(imageX,imageY,pixelWidth,pixelHeight){var rect=imageX;if(rect instanceof $.Rect||(rect=new $.Rect(imageX,imageY,pixelWidth,pixelHeight)),this.viewer){var count=this.viewer.world.getItemCount();if(count>1)$.console.error("[Viewport.imageToViewportRectangle] is not accurate with multi-image; use TiledImage.imageToViewportRectangle instead.");else if(1===count){return this.viewer.world.getItemAt(0).imageToViewportRectangle(imageX,imageY,pixelWidth,pixelHeight,!0)}}var coordA=this.imageToViewportCoordinates(rect.x,rect.y),coordB=this._imageToViewportDelta(rect.width,rect.height);return new $.Rect(coordA.x,coordA.y,coordB.x,coordB.y,rect.degrees)},viewportToImageRectangle:function(viewerX,viewerY,pointWidth,pointHeight){var rect=viewerX;if(rect instanceof $.Rect||(rect=new $.Rect(viewerX,viewerY,pointWidth,pointHeight)),this.viewer){var count=this.viewer.world.getItemCount();if(count>1)$.console.error("[Viewport.viewportToImageRectangle] is not accurate with multi-image; use TiledImage.viewportToImageRectangle instead.");else if(1===count){return this.viewer.world.getItemAt(0).viewportToImageRectangle(viewerX,viewerY,pointWidth,pointHeight,!0)}}var coordA=this.viewportToImageCoordinates(rect.x,rect.y),coordB=this._viewportToImageDelta(rect.width,rect.height);return new $.Rect(coordA.x,coordA.y,coordB.x,coordB.y,rect.degrees)},viewerElementToImageCoordinates:function(pixel){var point=this.pointFromPixel(pixel,!0);return this.viewportToImageCoordinates(point)},imageToViewerElementCoordinates:function(pixel){var point=this.imageToViewportCoordinates(pixel);return this.pixelFromPoint(point,!0)},windowToImageCoordinates:function(pixel){$.console.assert(this.viewer,"[Viewport.windowToImageCoordinates] the viewport must have a viewer.");var viewerCoordinates=pixel.minus($.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(viewerCoordinates)},imageToWindowCoordinates:function(pixel){return $.console.assert(this.viewer,"[Viewport.imageToWindowCoordinates] the viewport must have a viewer."),this.imageToViewerElementCoordinates(pixel).plus($.getElementPosition(this.viewer.element))},viewerElementToViewportCoordinates:function(pixel){return this.pointFromPixel(pixel,!0)},viewportToViewerElementCoordinates:function(point){return this.pixelFromPoint(point,!0)},viewerElementToViewportRectangle:function(rectangle){return $.Rect.fromSummits(this.pointFromPixel(rectangle.getTopLeft(),!0),this.pointFromPixel(rectangle.getTopRight(),!0),this.pointFromPixel(rectangle.getBottomLeft(),!0))},viewportToViewerElementRectangle:function(rectangle){return $.Rect.fromSummits(this.pixelFromPoint(rectangle.getTopLeft(),!0),this.pixelFromPoint(rectangle.getTopRight(),!0),this.pixelFromPoint(rectangle.getBottomLeft(),!0))},windowToViewportCoordinates:function(pixel){$.console.assert(this.viewer,"[Viewport.windowToViewportCoordinates] the viewport must have a viewer.");var viewerCoordinates=pixel.minus($.getElementPosition(this.viewer.element));return this.viewerElementToViewportCoordinates(viewerCoordinates)},viewportToWindowCoordinates:function(point){return $.console.assert(this.viewer,"[Viewport.viewportToWindowCoordinates] the viewport must have a viewer."),this.viewportToViewerElementCoordinates(point).plus($.getElementPosition(this.viewer.element))},viewportToImageZoom:function(viewportZoom){if(this.viewer){var count=this.viewer.world.getItemCount();if(count>1)$.console.error("[Viewport.viewportToImageZoom] is not accurate with multi-image.");else if(1===count){return this.viewer.world.getItemAt(0).viewportToImageZoom(viewportZoom)}}var imageWidth=this._contentSizeNoRotate.x;return viewportZoom*(this._containerInnerSize.x/imageWidth*this._contentBoundsNoRotate.width)},imageToViewportZoom:function(imageZoom){if(this.viewer){var count=this.viewer.world.getItemCount();if(count>1)$.console.error("[Viewport.imageToViewportZoom] is not accurate with multi-image.");else if(1===count){return this.viewer.world.getItemAt(0).imageToViewportZoom(imageZoom)}}return imageZoom*(this._contentSizeNoRotate.x/this._containerInnerSize.x/this._contentBoundsNoRotate.width)},toggleFlip:function(){return this.setFlip(!this.getFlip()),this},getFlip:function(){return this.flipped},setFlip:function(state){return this.flipped===state||(this.flipped=state,this.viewer.navigator&&this.viewer.navigator.setFlip(this.getFlip()),this.viewer.forceRedraw(),this.viewer.raiseEvent("flip",{flipped:state})),this}}}(OpenSeadragon),function($){function updateLevel(tiledImage,haveDrawn,drawLevel,level,levelOpacity,levelVisibility,drawArea,currentTime,best){var topLeftBound=drawArea.getBoundingBox().getTopLeft(),bottomRightBound=drawArea.getBoundingBox().getBottomRight();tiledImage.viewer&&tiledImage.viewer.raiseEvent("update-level",{tiledImage,havedrawn:haveDrawn,level,opacity:levelOpacity,visibility:levelVisibility,drawArea,topleft:topLeftBound,bottomright:bottomRightBound,currenttime:currentTime,best}),resetCoverage(tiledImage.coverage,level),resetCoverage(tiledImage.loadingCoverage,level);for(var cornerTiles=tiledImage._getCornerTiles(level,topLeftBound,bottomRightBound),topLeftTile=cornerTiles.topLeft,bottomRightTile=cornerTiles.bottomRight,numberOfTiles=tiledImage.source.getNumTiles(level),viewportCenter=tiledImage.viewport.pixelFromPoint(tiledImage.viewport.getCenter()),x=topLeftTile.x;x<=bottomRightTile.x;x++)for(var y=topLeftTile.y;y<=bottomRightTile.y;y++){if(!tiledImage.wrapHorizontal&&!tiledImage.wrapVertical){var tileBounds=tiledImage.source.getTileBounds(level,x,y);if(null===drawArea.intersection(tileBounds))continue}best=updateTile(tiledImage,drawLevel,haveDrawn,x,y,level,levelOpacity,levelVisibility,viewportCenter,numberOfTiles,currentTime,best)}return best}function updateTile(tiledImage,haveDrawn,drawLevel,x,y,level,levelOpacity,levelVisibility,viewportCenter,numberOfTiles,currentTime,best){var tile=function getTile(x,y,level,tiledImage,tileSource,tilesMatrix,time,numTiles,worldWidth,worldHeight){var xMod,yMod,bounds,sourceBounds,exists,url,ajaxHeaders,context2D,tile;tilesMatrix[level]||(tilesMatrix[level]={});tilesMatrix[level][x]||(tilesMatrix[level][x]={});tilesMatrix[level][x][y]||(xMod=(numTiles.x+x%numTiles.x)%numTiles.x,yMod=(numTiles.y+y%numTiles.y)%numTiles.y,bounds=tileSource.getTileBounds(level,xMod,yMod),sourceBounds=tileSource.getTileBounds(level,xMod,yMod,!0),exists=tileSource.tileExists(level,xMod,yMod),url=tileSource.getTileUrl(level,xMod,yMod),tiledImage.loadTilesWithAjax?(ajaxHeaders=tileSource.getTileAjaxHeaders(level,xMod,yMod),$.isPlainObject(tiledImage.ajaxHeaders)&&(ajaxHeaders=$.extend({},tiledImage.ajaxHeaders,ajaxHeaders))):ajaxHeaders=null,context2D=tileSource.getContext2D?tileSource.getContext2D(level,xMod,yMod):void 0,bounds.x+=(x-xMod)/numTiles.x,bounds.y+=worldHeight/worldWidth*((y-yMod)/numTiles.y),tile=new $.Tile(level,x,y,bounds,exists,url,context2D,tiledImage.loadTilesWithAjax,ajaxHeaders,sourceBounds),xMod===numTiles.x-1&&(tile.isRightMost=!0),yMod===numTiles.y-1&&(tile.isBottomMost=!0),tilesMatrix[level][x][y]=tile);return tile=tilesMatrix[level][x][y],tile.lastTouchTime=time,tile}(x,y,level,tiledImage,tiledImage.source,tiledImage.tilesMatrix,currentTime,numberOfTiles,tiledImage._worldWidthCurrent,tiledImage._worldHeightCurrent),drawTile=drawLevel;tiledImage.viewer&&tiledImage.viewer.raiseEvent("update-tile",{tiledImage,tile}),setCoverage(tiledImage.coverage,level,x,y,!1);var loadingCoverage=tile.loaded||tile.loading||isCovered(tiledImage.loadingCoverage,level,x,y);if(setCoverage(tiledImage.loadingCoverage,level,x,y,loadingCoverage),!tile.exists)return best;if(haveDrawn&&!drawTile&&(isCovered(tiledImage.coverage,level,x,y)?setCoverage(tiledImage.coverage,level,x,y,!0):drawTile=!0),!drawTile)return best;if(function positionTile(tile,overlap,viewport,viewportCenter,levelVisibility,tiledImage){var boundsTL=tile.bounds.getTopLeft();boundsTL.x*=tiledImage._scaleSpring.current.value,boundsTL.y*=tiledImage._scaleSpring.current.value,boundsTL.x+=tiledImage._xSpring.current.value,boundsTL.y+=tiledImage._ySpring.current.value;var boundsSize=tile.bounds.getSize();boundsSize.x*=tiledImage._scaleSpring.current.value,boundsSize.y*=tiledImage._scaleSpring.current.value;var positionC=viewport.pixelFromPointNoRotate(boundsTL,!0),positionT=viewport.pixelFromPointNoRotate(boundsTL,!1),sizeC=viewport.deltaPixelsFromPointsNoRotate(boundsSize,!0),sizeT=viewport.deltaPixelsFromPointsNoRotate(boundsSize,!1),tileCenter=positionT.plus(sizeT.divide(2)),tileSquaredDistance=viewportCenter.squaredDistanceTo(tileCenter);overlap||(sizeC=sizeC.plus(new $.Point(1,1)));tile.isRightMost&&tiledImage.wrapHorizontal&&(sizeC.x+=.75);tile.isBottomMost&&tiledImage.wrapVertical&&(sizeC.y+=.75);tile.position=positionC,tile.size=sizeC,tile.squaredDistance=tileSquaredDistance,tile.visibility=levelVisibility}(tile,tiledImage.source.tileOverlap,tiledImage.viewport,viewportCenter,levelVisibility,tiledImage),!tile.loaded)if(tile.context2D)setTileLoaded(tiledImage,tile);else{var imageRecord=tiledImage._tileCache.getImageRecord(tile.cacheKey);if(imageRecord)setTileLoaded(tiledImage,tile,imageRecord.getImage())}if(tile.loaded){var needsDraw=function blendTile(tiledImage,tile,x,y,level,levelOpacity,currentTime){var deltaTime,opacity,blendTimeMillis=1e3*tiledImage.blendTime;tile.blendStart||(tile.blendStart=currentTime);deltaTime=currentTime-tile.blendStart,opacity=blendTimeMillis?Math.min(1,deltaTime/blendTimeMillis):1,tiledImage.alwaysBlend&&(opacity*=levelOpacity);if(tile.opacity=opacity,tiledImage.lastDrawn.push(tile),1===opacity)setCoverage(tiledImage.coverage,level,x,y,!0),tiledImage._hasOpaqueTile=!0;else if(deltaTime<blendTimeMillis)return!0;return!1}(tiledImage,tile,x,y,level,levelOpacity,currentTime);needsDraw&&(tiledImage._needsDraw=!0)}else tile.loading?tiledImage._tilesLoading++:loadingCoverage||(best=function compareTiles(previousBest,tile){if(!previousBest)return tile;if(tile.visibility>previousBest.visibility)return tile;if(tile.visibility==previousBest.visibility&&tile.squaredDistance<previousBest.squaredDistance)return tile;return previousBest}(best,tile));return best}function setTileLoaded(tiledImage,tile,image,cutoff,tileRequest){var increment=0;function getCompletionCallback(){return increment++,completionCallback}function completionCallback(){0===--increment&&(tile.loading=!1,tile.loaded=!0,tile.context2D||tiledImage._tileCache.cacheTile({image,tile,cutoff,tiledImage}),tiledImage._needsDraw=!0)}tiledImage.viewer.raiseEvent("tile-loaded",{tile,tiledImage,tileRequest,image,getCompletionCallback}),getCompletionCallback()()}function providesCoverage(coverage,level,x,y){var rows,cols,i,j;if(!coverage[level])return!1;if(void 0===x||void 0===y){for(i in rows=coverage[level])if(Object.prototype.hasOwnProperty.call(rows,i))for(j in cols=rows[i])if(Object.prototype.hasOwnProperty.call(cols,j)&&!cols[j])return!1;return!0}return void 0===coverage[level][x]||void 0===coverage[level][x][y]||!0===coverage[level][x][y]}function isCovered(coverage,level,x,y){return void 0===x||void 0===y?providesCoverage(coverage,level+1):providesCoverage(coverage,level+1,2*x,2*y)&&providesCoverage(coverage,level+1,2*x,2*y+1)&&providesCoverage(coverage,level+1,2*x+1,2*y)&&providesCoverage(coverage,level+1,2*x+1,2*y+1)}function setCoverage(coverage,level,x,y,covers){coverage[level]?(coverage[level][x]||(coverage[level][x]={}),coverage[level][x][y]=covers):$.console.warn("Setting coverage for a tile before its level's coverage has been reset: %s",level)}function resetCoverage(coverage,level){coverage[level]={}}$.TiledImage=function(options){var _this=this;$.console.assert(options.tileCache,"[TiledImage] options.tileCache is required"),$.console.assert(options.drawer,"[TiledImage] options.drawer is required"),$.console.assert(options.viewer,"[TiledImage] options.viewer is required"),$.console.assert(options.imageLoader,"[TiledImage] options.imageLoader is required"),$.console.assert(options.source,"[TiledImage] options.source is required"),$.console.assert(!options.clip||options.clip instanceof $.Rect,"[TiledImage] options.clip must be an OpenSeadragon.Rect if present"),$.EventSource.call(this),this._tileCache=options.tileCache,delete options.tileCache,this._drawer=options.drawer,delete options.drawer,this._imageLoader=options.imageLoader,delete options.imageLoader,options.clip instanceof $.Rect&&(this._clip=options.clip.clone()),delete options.clip;var x=options.x||0;delete options.x;var y=options.y||0;delete options.y,this.normHeight=options.source.dimensions.y/options.source.dimensions.x,this.contentAspectX=options.source.dimensions.x/options.source.dimensions.y;var scale=1;options.width?(scale=options.width,delete options.width,options.height&&($.console.error("specifying both width and height to a tiledImage is not supported"),delete options.height)):options.height&&(scale=options.height/this.normHeight,delete options.height);var fitBounds=options.fitBounds;delete options.fitBounds;var fitBoundsPlacement=options.fitBoundsPlacement||OpenSeadragon.Placement.CENTER;delete options.fitBoundsPlacement;var degrees=options.degrees||0;delete options.degrees,$.extend(!0,this,{viewer:null,tilesMatrix:{},coverage:{},loadingCoverage:{},lastDrawn:[],lastResetTime:0,_midDraw:!1,_needsDraw:!0,_hasOpaqueTile:!1,_tilesLoading:0,springStiffness:$.DEFAULT_SETTINGS.springStiffness,animationTime:$.DEFAULT_SETTINGS.animationTime,minZoomImageRatio:$.DEFAULT_SETTINGS.minZoomImageRatio,wrapHorizontal:$.DEFAULT_SETTINGS.wrapHorizontal,wrapVertical:$.DEFAULT_SETTINGS.wrapVertical,immediateRender:$.DEFAULT_SETTINGS.immediateRender,blendTime:$.DEFAULT_SETTINGS.blendTime,alwaysBlend:$.DEFAULT_SETTINGS.alwaysBlend,minPixelRatio:$.DEFAULT_SETTINGS.minPixelRatio,smoothTileEdgesMinZoom:$.DEFAULT_SETTINGS.smoothTileEdgesMinZoom,iOSDevice:$.DEFAULT_SETTINGS.iOSDevice,debugMode:$.DEFAULT_SETTINGS.debugMode,crossOriginPolicy:$.DEFAULT_SETTINGS.crossOriginPolicy,ajaxWithCredentials:$.DEFAULT_SETTINGS.ajaxWithCredentials,placeholderFillStyle:$.DEFAULT_SETTINGS.placeholderFillStyle,opacity:$.DEFAULT_SETTINGS.opacity,preload:$.DEFAULT_SETTINGS.preload,compositeOperation:$.DEFAULT_SETTINGS.compositeOperation},options),this._preload=this.preload,delete this.preload,this._fullyLoaded=!1,this._xSpring=new $.Spring({initial:x,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._ySpring=new $.Spring({initial:y,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._scaleSpring=new $.Spring({initial:scale,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._degreesSpring=new $.Spring({initial:degrees,springStiffness:this.springStiffness,animationTime:this.animationTime}),this._updateForScale(),fitBounds&&this.fitBounds(fitBounds,fitBoundsPlacement,!0),this._drawingHandler=function(args){_this.viewer.raiseEvent("tile-drawing",$.extend({tiledImage:_this},args))}},$.extend($.TiledImage.prototype,$.EventSource.prototype,{needsDraw:function(){return this._needsDraw},getFullyLoaded:function(){return this._fullyLoaded},_setFullyLoaded:function(flag){flag!==this._fullyLoaded&&(this._fullyLoaded=flag,this.raiseEvent("fully-loaded-change",{fullyLoaded:this._fullyLoaded}))},reset:function(){this._tileCache.clearTilesFor(this),this.lastResetTime=$.now(),this._needsDraw=!0},update:function(){var xUpdated=this._xSpring.update(),yUpdated=this._ySpring.update(),scaleUpdated=this._scaleSpring.update(),degreesUpdated=this._degreesSpring.update();return!!(xUpdated||yUpdated||scaleUpdated||degreesUpdated)&&(this._updateForScale(),this._needsDraw=!0,!0)},draw:function(){0!==this.opacity||this._preload?(this._midDraw=!0,this._updateViewport(),this._midDraw=!1):this._needsDraw=!1},destroy:function(){this.reset()},getBounds:function(current){return this.getBoundsNoRotate(current).rotate(this.getRotation(current),this._getRotationPoint(current))},getBoundsNoRotate:function(current){return current?new $.Rect(this._xSpring.current.value,this._ySpring.current.value,this._worldWidthCurrent,this._worldHeightCurrent):new $.Rect(this._xSpring.target.value,this._ySpring.target.value,this._worldWidthTarget,this._worldHeightTarget)},getWorldBounds:function(){return $.console.error("[TiledImage.getWorldBounds] is deprecated; use TiledImage.getBounds instead"),this.getBounds()},getClippedBounds:function(current){var bounds=this.getBoundsNoRotate(current);if(this._clip){var ratio=(current?this._worldWidthCurrent:this._worldWidthTarget)/this.source.dimensions.x,clip=this._clip.times(ratio);bounds=new $.Rect(bounds.x+clip.x,bounds.y+clip.y,clip.width,clip.height)}return bounds.rotate(this.getRotation(current),this._getRotationPoint(current))},getContentSize:function(){return new $.Point(this.source.dimensions.x,this.source.dimensions.y)},_viewportToImageDelta:function(viewerX,viewerY,current){var scale=current?this._scaleSpring.current.value:this._scaleSpring.target.value;return new $.Point(viewerX*(this.source.dimensions.x/scale),viewerY*(this.source.dimensions.y*this.contentAspectX/scale))},viewportToImageCoordinates:function(viewerX,viewerY,current){var point;return viewerX instanceof $.Point?(current=viewerY,point=viewerX):point=new $.Point(viewerX,viewerY),point=point.rotate(-this.getRotation(current),this._getRotationPoint(current)),current?this._viewportToImageDelta(point.x-this._xSpring.current.value,point.y-this._ySpring.current.value):this._viewportToImageDelta(point.x-this._xSpring.target.value,point.y-this._ySpring.target.value)},_imageToViewportDelta:function(imageX,imageY,current){var scale=current?this._scaleSpring.current.value:this._scaleSpring.target.value;return new $.Point(imageX/this.source.dimensions.x*scale,imageY/this.source.dimensions.y/this.contentAspectX*scale)},imageToViewportCoordinates:function(imageX,imageY,current){imageX instanceof $.Point&&(current=imageY,imageY=imageX.y,imageX=imageX.x);var point=this._imageToViewportDelta(imageX,imageY);return current?(point.x+=this._xSpring.current.value,point.y+=this._ySpring.current.value):(point.x+=this._xSpring.target.value,point.y+=this._ySpring.target.value),point.rotate(this.getRotation(current),this._getRotationPoint(current))},imageToViewportRectangle:function(imageX,imageY,pixelWidth,pixelHeight,current){var rect=imageX;rect instanceof $.Rect?current=imageY:rect=new $.Rect(imageX,imageY,pixelWidth,pixelHeight);var coordA=this.imageToViewportCoordinates(rect.getTopLeft(),current),coordB=this._imageToViewportDelta(rect.width,rect.height,current);return new $.Rect(coordA.x,coordA.y,coordB.x,coordB.y,rect.degrees+this.getRotation(current))},viewportToImageRectangle:function(viewerX,viewerY,pointWidth,pointHeight,current){var rect=viewerX;viewerX instanceof $.Rect?current=viewerY:rect=new $.Rect(viewerX,viewerY,pointWidth,pointHeight);var coordA=this.viewportToImageCoordinates(rect.getTopLeft(),current),coordB=this._viewportToImageDelta(rect.width,rect.height,current);return new $.Rect(coordA.x,coordA.y,coordB.x,coordB.y,rect.degrees-this.getRotation(current))},viewerElementToImageCoordinates:function(pixel){var point=this.viewport.pointFromPixel(pixel,!0);return this.viewportToImageCoordinates(point)},imageToViewerElementCoordinates:function(pixel){var point=this.imageToViewportCoordinates(pixel);return this.viewport.pixelFromPoint(point,!0)},windowToImageCoordinates:function(pixel){var viewerCoordinates=pixel.minus(OpenSeadragon.getElementPosition(this.viewer.element));return this.viewerElementToImageCoordinates(viewerCoordinates)},imageToWindowCoordinates:function(pixel){return this.imageToViewerElementCoordinates(pixel).plus(OpenSeadragon.getElementPosition(this.viewer.element))},_viewportToTiledImageRectangle:function(rect){var scale=this._scaleSpring.current.value;return rect=rect.rotate(-this.getRotation(!0),this._getRotationPoint(!0)),new $.Rect((rect.x-this._xSpring.current.value)/scale,(rect.y-this._ySpring.current.value)/scale,rect.width/scale,rect.height/scale,rect.degrees)},viewportToImageZoom:function(viewportZoom){return this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x*viewportZoom},imageToViewportZoom:function(imageZoom){return imageZoom/(this._scaleSpring.current.value*this.viewport._containerInnerSize.x/this.source.dimensions.x)},setPosition:function(position,immediately){var sameTarget=this._xSpring.target.value===position.x&&this._ySpring.target.value===position.y;if(immediately){if(sameTarget&&this._xSpring.current.value===position.x&&this._ySpring.current.value===position.y)return;this._xSpring.resetTo(position.x),this._ySpring.resetTo(position.y),this._needsDraw=!0}else{if(sameTarget)return;this._xSpring.springTo(position.x),this._ySpring.springTo(position.y),this._needsDraw=!0}sameTarget||this._raiseBoundsChange()},setWidth:function(width,immediately){this._setScale(width,immediately)},setHeight:function(height,immediately){this._setScale(height/this.normHeight,immediately)},setCroppingPolygons:function(polygons){var objectToSimpleXYObject=function(objs){return objs.map((function(obj){try{if(function(obj){return obj instanceof $.Point||"number"==typeof obj.x&&"number"==typeof obj.y}(obj))return{x:obj.x,y:obj.y};throw new Error}catch(e){throw new Error("A Provided cropping polygon point is not supported")}}))};try{if(!$.isArray(polygons))throw new Error("Provided cropping polygon is not an array");this._croppingPolygons=polygons.map((function(polygon){return objectToSimpleXYObject(polygon)}))}catch(e){$.console.error("[TiledImage.setCroppingPolygons] Cropping polygon format not supported"),$.console.error(e),this._croppingPolygons=null}},resetCroppingPolygons:function(){this._croppingPolygons=null},fitBounds:function(bounds,anchor,immediately){anchor=anchor||$.Placement.CENTER;var anchorProperties=$.Placement.properties[anchor],aspectRatio=this.contentAspectX,xOffset=0,yOffset=0,displayedWidthRatio=1,displayedHeightRatio=1;if(this._clip&&(aspectRatio=this._clip.getAspectRatio(),displayedWidthRatio=this._clip.width/this.source.dimensions.x,displayedHeightRatio=this._clip.height/this.source.dimensions.y,bounds.getAspectRatio()>aspectRatio?(xOffset=this._clip.x/this._clip.height*bounds.height,yOffset=this._clip.y/this._clip.height*bounds.height):(xOffset=this._clip.x/this._clip.width*bounds.width,yOffset=this._clip.y/this._clip.width*bounds.width)),bounds.getAspectRatio()>aspectRatio){var height=bounds.height/displayedHeightRatio,marginLeft=0;anchorProperties.isHorizontallyCentered?marginLeft=(bounds.width-bounds.height*aspectRatio)/2:anchorProperties.isRight&&(marginLeft=bounds.width-bounds.height*aspectRatio),this.setPosition(new $.Point(bounds.x-xOffset+marginLeft,bounds.y-yOffset),immediately),this.setHeight(height,immediately)}else{var width=bounds.width/displayedWidthRatio,marginTop=0;anchorProperties.isVerticallyCentered?marginTop=(bounds.height-bounds.width/aspectRatio)/2:anchorProperties.isBottom&&(marginTop=bounds.height-bounds.width/aspectRatio),this.setPosition(new $.Point(bounds.x-xOffset,bounds.y-yOffset+marginTop),immediately),this.setWidth(width,immediately)}},getClip:function(){return this._clip?this._clip.clone():null},setClip:function(newClip){$.console.assert(!newClip||newClip instanceof $.Rect,"[TiledImage.setClip] newClip must be an OpenSeadragon.Rect or null"),newClip instanceof $.Rect?this._clip=newClip.clone():this._clip=null,this._needsDraw=!0,this.raiseEvent("clip-change")},getOpacity:function(){return this.opacity},setOpacity:function(opacity){opacity!==this.opacity&&(this.opacity=opacity,this._needsDraw=!0,this.raiseEvent("opacity-change",{opacity:this.opacity}))},getPreload:function(){return this._preload},setPreload:function(preload){this._preload=!!preload,this._needsDraw=!0},getRotation:function(current){return current?this._degreesSpring.current.value:this._degreesSpring.target.value},setRotation:function(degrees,immediately){this._degreesSpring.target.value===degrees&&this._degreesSpring.isAtTargetValue()||(immediately?this._degreesSpring.resetTo(degrees):this._degreesSpring.springTo(degrees),this._needsDraw=!0,this._raiseBoundsChange())},_getRotationPoint:function(current){return this.getBoundsNoRotate(current).getCenter()},getCompositeOperation:function(){return this.compositeOperation},setCompositeOperation:function(compositeOperation){compositeOperation!==this.compositeOperation&&(this.compositeOperation=compositeOperation,this._needsDraw=!0,this.raiseEvent("composite-operation-change",{compositeOperation:this.compositeOperation}))},_setScale:function(scale,immediately){var sameTarget=this._scaleSpring.target.value===scale;if(immediately){if(sameTarget&&this._scaleSpring.current.value===scale)return;this._scaleSpring.resetTo(scale),this._updateForScale(),this._needsDraw=!0}else{if(sameTarget)return;this._scaleSpring.springTo(scale),this._updateForScale(),this._needsDraw=!0}sameTarget||this._raiseBoundsChange()},_updateForScale:function(){this._worldWidthTarget=this._scaleSpring.target.value,this._worldHeightTarget=this.normHeight*this._scaleSpring.target.value,this._worldWidthCurrent=this._scaleSpring.current.value,this._worldHeightCurrent=this.normHeight*this._scaleSpring.current.value},_raiseBoundsChange:function(){this.raiseEvent("bounds-change")},_isBottomItem:function(){return this.viewer.world.getItemAt(0)===this},_getLevelsInterval:function(){var lowestLevel=Math.max(this.source.minLevel,Math.floor(Math.log(this.minZoomImageRatio)/Math.log(2))),currentZeroRatio=this.viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(0),!0).x*this._scaleSpring.current.value,highestLevel=Math.min(Math.abs(this.source.maxLevel),Math.abs(Math.floor(Math.log(currentZeroRatio/this.minPixelRatio)/Math.log(2))));return highestLevel=Math.max(highestLevel,this.source.minLevel||0),{lowestLevel:lowestLevel=Math.min(lowestLevel,highestLevel),highestLevel}},_updateViewport:function(){for(this._needsDraw=!1,this._tilesLoading=0,this.loadingCoverage={};this.lastDrawn.length>0;){this.lastDrawn.pop().beingDrawn=!1}var viewport=this.viewport,drawArea=this._viewportToTiledImageRectangle(viewport.getBoundsWithMargins(!0));if(!this.wrapHorizontal&&!this.wrapVertical){var tiledImageBounds=this._viewportToTiledImageRectangle(this.getClippedBounds(!0));if(null===(drawArea=drawArea.intersection(tiledImageBounds)))return}for(var levelsInterval=this._getLevelsInterval(),lowestLevel=levelsInterval.lowestLevel,highestLevel=levelsInterval.highestLevel,bestTile=null,haveDrawn=!1,currentTime=$.now(),level=highestLevel;level>=lowestLevel;level--){var drawLevel=!1,currentRenderPixelRatio=viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(level),!0).x*this._scaleSpring.current.value;if(level===lowestLevel||!haveDrawn&&currentRenderPixelRatio>=this.minPixelRatio)drawLevel=!0,haveDrawn=!0;else if(!haveDrawn)continue;var targetRenderPixelRatio=viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(level),!1).x*this._scaleSpring.current.value,targetZeroRatio=viewport.deltaPixelsFromPointsNoRotate(this.source.getPixelRatio(Math.max(this.source.getClosestLevel(),0)),!1).x*this._scaleSpring.current.value,optimalRatio=this.immediateRender?1:targetZeroRatio;if(bestTile=updateLevel(this,haveDrawn,drawLevel,level,Math.min(1,(currentRenderPixelRatio-.5)/.5),optimalRatio/Math.abs(optimalRatio-targetRenderPixelRatio),drawArea,currentTime,bestTile),providesCoverage(this.coverage,level))break}!function drawTiles(tiledImage,lastDrawn){if(0===tiledImage.opacity||0===lastDrawn.length&&!tiledImage.placeholderFillStyle)return;var useSketch,sketchScale,sketchTranslate,tile=lastDrawn[0];tile&&(useSketch=tiledImage.opacity<1||tiledImage.compositeOperation&&"source-over"!==tiledImage.compositeOperation||!tiledImage._isBottomItem()&&tile._hasTransparencyChannel());var bounds,zoom=tiledImage.viewport.getZoom(!0),imageZoom=tiledImage.viewportToImageZoom(zoom);lastDrawn.length>1&&imageZoom>tiledImage.smoothTileEdgesMinZoom&&!tiledImage.iOSDevice&&tiledImage.getRotation(!0)%360==0&&$.supportsCanvas&&(useSketch=!0,sketchScale=tile.getScaleForEdgeSmoothing(),sketchTranslate=tile.getTranslationForEdgeSmoothing(sketchScale,tiledImage._drawer.getCanvasSize(!1),tiledImage._drawer.getCanvasSize(!0)));useSketch&&(sketchScale||(bounds=tiledImage.viewport.viewportToViewerElementRectangle(tiledImage.getClippedBounds(!0)).getIntegerBoundingBox(),tiledImage._drawer.viewer.viewport.getFlip()&&(0===tiledImage.viewport.degrees&&tiledImage.getRotation(!0)%360==0||(bounds.x=tiledImage._drawer.viewer.container.clientWidth-(bounds.x+bounds.width))),bounds=bounds.times($.pixelDensityRatio)),tiledImage._drawer._clear(!0,bounds));sketchScale||(0!==tiledImage.viewport.degrees&&tiledImage._drawer._offsetForRotation({degrees:tiledImage.viewport.degrees,useSketch}),tiledImage.getRotation(!0)%360!=0&&tiledImage._drawer._offsetForRotation({degrees:tiledImage.getRotation(!0),point:tiledImage.viewport.pixelFromPointNoRotate(tiledImage._getRotationPoint(!0),!0),useSketch}),0===tiledImage.viewport.degrees&&tiledImage.getRotation(!0)%360==0&&tiledImage._drawer.viewer.viewport.getFlip()&&tiledImage._drawer._flip());var usedClip=!1;if(tiledImage._clip){tiledImage._drawer.saveContext(useSketch);var box=tiledImage.imageToViewportRectangle(tiledImage._clip,!0);box=box.rotate(-tiledImage.getRotation(!0),tiledImage._getRotationPoint(!0));var clipRect=tiledImage._drawer.viewportToDrawerRectangle(box);sketchScale&&(clipRect=clipRect.times(sketchScale)),sketchTranslate&&(clipRect=clipRect.translate(sketchTranslate)),tiledImage._drawer.setClip(clipRect,useSketch),usedClip=!0}if(tiledImage._croppingPolygons){tiledImage._drawer.saveContext(useSketch);try{var polygons=tiledImage._croppingPolygons.map((function(polygon){return polygon.map((function(coord){var point=tiledImage.imageToViewportCoordinates(coord.x,coord.y,!0).rotate(-tiledImage.getRotation(!0),tiledImage._getRotationPoint(!0)),clipPoint=tiledImage._drawer.viewportCoordToDrawerCoord(point);return sketchScale&&(clipPoint=clipPoint.times(sketchScale)),clipPoint}))}));tiledImage._drawer.clipWithPolygons(polygons,useSketch)}catch(e){$.console.error(e)}usedClip=!0}if(tiledImage.placeholderFillStyle&&!1===tiledImage._hasOpaqueTile){var placeholderRect=tiledImage._drawer.viewportToDrawerRectangle(tiledImage.getBounds(!0));sketchScale&&(placeholderRect=placeholderRect.times(sketchScale)),sketchTranslate&&(placeholderRect=placeholderRect.translate(sketchTranslate));var fillStyle=null;fillStyle="function"==typeof tiledImage.placeholderFillStyle?tiledImage.placeholderFillStyle(tiledImage,tiledImage._drawer.context):tiledImage.placeholderFillStyle,tiledImage._drawer.drawRectangle(placeholderRect,fillStyle,useSketch)}for(var i=lastDrawn.length-1;i>=0;i--)tile=lastDrawn[i],tiledImage._drawer.drawTile(tile,tiledImage._drawingHandler,useSketch,sketchScale,sketchTranslate),tile.beingDrawn=!0,tiledImage.viewer&&tiledImage.viewer.raiseEvent("tile-drawn",{tiledImage,tile});usedClip&&tiledImage._drawer.restoreContext(useSketch);sketchScale||(tiledImage.getRotation(!0)%360!=0&&tiledImage._drawer._restoreRotationChanges(useSketch),0!==tiledImage.viewport.degrees&&tiledImage._drawer._restoreRotationChanges(useSketch));useSketch&&(sketchScale&&(0!==tiledImage.viewport.degrees&&tiledImage._drawer._offsetForRotation({degrees:tiledImage.viewport.degrees,useSketch:!1}),tiledImage.getRotation(!0)%360!=0&&tiledImage._drawer._offsetForRotation({degrees:tiledImage.getRotation(!0),point:tiledImage.viewport.pixelFromPointNoRotate(tiledImage._getRotationPoint(!0),!0),useSketch:!1})),tiledImage._drawer.blendSketch({opacity:tiledImage.opacity,scale:sketchScale,translate:sketchTranslate,compositeOperation:tiledImage.compositeOperation,bounds}),sketchScale&&(tiledImage.getRotation(!0)%360!=0&&tiledImage._drawer._restoreRotationChanges(!1),0!==tiledImage.viewport.degrees&&tiledImage._drawer._restoreRotationChanges(!1)));sketchScale||0===tiledImage.viewport.degrees&&tiledImage.getRotation(!0)%360==0&&tiledImage._drawer.viewer.viewport.getFlip()&&tiledImage._drawer._flip();!function drawDebugInfo(tiledImage,lastDrawn){if(tiledImage.debugMode)for(var i=lastDrawn.length-1;i>=0;i--){var tile=lastDrawn[i];try{tiledImage._drawer.drawDebugInfo(tile,lastDrawn.length,i,tiledImage)}catch(e){$.console.error(e)}}}(tiledImage,lastDrawn)}(this,this.lastDrawn),bestTile&&!bestTile.context2D?(!function loadTile(tiledImage,tile,time){tile.loading=!0,tiledImage._imageLoader.addJob({src:tile.url,loadWithAjax:tile.loadWithAjax,ajaxHeaders:tile.ajaxHeaders,crossOriginPolicy:tiledImage.crossOriginPolicy,ajaxWithCredentials:tiledImage.ajaxWithCredentials,callback:function(image,errorMsg,tileRequest){!function onTileLoad(tiledImage,tile,time,image,errorMsg,tileRequest){if(!image)return $.console.log("Tile %s failed to load: %s - error: %s",tile,tile.url,errorMsg),tiledImage.viewer.raiseEvent("tile-load-failed",{tile,tiledImage,time,message:errorMsg,tileRequest}),tile.loading=!1,void(tile.exists=!1);if(time<tiledImage.lastResetTime)return $.console.log("Ignoring tile %s loaded before reset: %s",tile,tile.url),void(tile.loading=!1);var finish=function(){var cutoff=tiledImage.source.getClosestLevel();setTileLoaded(tiledImage,tile,image,cutoff,tileRequest)};tiledImage._midDraw?window.setTimeout(finish,1):finish()}(tiledImage,tile,time,image,errorMsg,tileRequest)},abort:function(){tile.loading=!1}})}(this,bestTile,currentTime),this._needsDraw=!0,this._setFullyLoaded(!1)):this._setFullyLoaded(0===this._tilesLoading)},_getCornerTiles:function(level,topLeftBound,bottomRightBound){var leftX,rightX,topY,bottomY;this.wrapHorizontal?(leftX=$.positiveModulo(topLeftBound.x,1),rightX=$.positiveModulo(bottomRightBound.x,1)):(leftX=Math.max(0,topLeftBound.x),rightX=Math.min(1,bottomRightBound.x));var aspectRatio=1/this.source.aspectRatio;this.wrapVertical?(topY=$.positiveModulo(topLeftBound.y,aspectRatio),bottomY=$.positiveModulo(bottomRightBound.y,aspectRatio)):(topY=Math.max(0,topLeftBound.y),bottomY=Math.min(aspectRatio,bottomRightBound.y));var topLeftTile=this.source.getTileAtPoint(level,new $.Point(leftX,topY)),bottomRightTile=this.source.getTileAtPoint(level,new $.Point(rightX,bottomY)),numTiles=this.source.getNumTiles(level);return this.wrapHorizontal&&(topLeftTile.x+=numTiles.x*Math.floor(topLeftBound.x),bottomRightTile.x+=numTiles.x*Math.floor(bottomRightBound.x)),this.wrapVertical&&(topLeftTile.y+=numTiles.y*Math.floor(topLeftBound.y/aspectRatio),bottomRightTile.y+=numTiles.y*Math.floor(bottomRightBound.y/aspectRatio)),{topLeft:topLeftTile,bottomRight:bottomRightTile}}})}(OpenSeadragon),function($){var TileRecord=function(options){$.console.assert(options,"[TileCache.cacheTile] options is required"),$.console.assert(options.tile,"[TileCache.cacheTile] options.tile is required"),$.console.assert(options.tiledImage,"[TileCache.cacheTile] options.tiledImage is required"),this.tile=options.tile,this.tiledImage=options.tiledImage},ImageRecord=function(options){$.console.assert(options,"[ImageRecord] options is required"),$.console.assert(options.image,"[ImageRecord] options.image is required"),this._image=options.image,this._tiles=[]};ImageRecord.prototype={destroy:function(){this._image=null,this._renderedContext=null,this._tiles=null},getImage:function(){return this._image},getRenderedContext:function(){if(!this._renderedContext){var canvas=document.createElement("canvas");canvas.width=this._image.width,canvas.height=this._image.height,this._renderedContext=canvas.getContext("2d"),this._renderedContext.drawImage(this._image,0,0),this._image=null}return this._renderedContext},setRenderedContext:function(renderedContext){$.console.error("ImageRecord.setRenderedContext is deprecated. The rendered context should be created by the ImageRecord itself when calling ImageRecord.getRenderedContext."),this._renderedContext=renderedContext},addTile:function(tile){$.console.assert(tile,"[ImageRecord.addTile] tile is required"),this._tiles.push(tile)},removeTile:function(tile){for(var i=0;i<this._tiles.length;i++)if(this._tiles[i]===tile)return void this._tiles.splice(i,1);$.console.warn("[ImageRecord.removeTile] trying to remove unknown tile",tile)},getTileCount:function(){return this._tiles.length}},$.TileCache=function(options){options=options||{},this._maxImageCacheCount=options.maxImageCacheCount||$.DEFAULT_SETTINGS.maxImageCacheCount,this._tilesLoaded=[],this._imagesLoaded=[],this._imagesLoadedCount=0},$.TileCache.prototype={numTilesLoaded:function(){return this._tilesLoaded.length},cacheTile:function(options){$.console.assert(options,"[TileCache.cacheTile] options is required"),$.console.assert(options.tile,"[TileCache.cacheTile] options.tile is required"),$.console.assert(options.tile.cacheKey,"[TileCache.cacheTile] options.tile.cacheKey is required"),$.console.assert(options.tiledImage,"[TileCache.cacheTile] options.tiledImage is required");var cutoff=options.cutoff||0,insertionIndex=this._tilesLoaded.length,imageRecord=this._imagesLoaded[options.tile.cacheKey];if(imageRecord||($.console.assert(options.image,"[TileCache.cacheTile] options.image is required to create an ImageRecord"),imageRecord=this._imagesLoaded[options.tile.cacheKey]=new ImageRecord({image:options.image}),this._imagesLoadedCount++),imageRecord.addTile(options.tile),options.tile.cacheImageRecord=imageRecord,this._imagesLoadedCount>this._maxImageCacheCount){for(var prevTile,worstTime,worstLevel,prevTime,prevLevel,prevTileRecord,worstTile=null,worstTileIndex=-1,worstTileRecord=null,i=this._tilesLoaded.length-1;i>=0;i--)(prevTile=(prevTileRecord=this._tilesLoaded[i]).tile).level<=cutoff||prevTile.beingDrawn||(worstTile?(prevTime=prevTile.lastTouchTime,worstTime=worstTile.lastTouchTime,prevLevel=prevTile.level,worstLevel=worstTile.level,(prevTime<worstTime||prevTime==worstTime&&prevLevel>worstLevel)&&(worstTile=prevTile,worstTileIndex=i,worstTileRecord=prevTileRecord)):(worstTile=prevTile,worstTileIndex=i,worstTileRecord=prevTileRecord));worstTile&&worstTileIndex>=0&&(this._unloadTile(worstTileRecord),insertionIndex=worstTileIndex)}this._tilesLoaded[insertionIndex]=new TileRecord({tile:options.tile,tiledImage:options.tiledImage})},clearTilesFor:function(tiledImage){var tileRecord;$.console.assert(tiledImage,"[TileCache.clearTilesFor] tiledImage is required");for(var i=0;i<this._tilesLoaded.length;++i)(tileRecord=this._tilesLoaded[i]).tiledImage===tiledImage&&(this._unloadTile(tileRecord),this._tilesLoaded.splice(i,1),i--)},getImageRecord:function(cacheKey){return $.console.assert(cacheKey,"[TileCache.getImageRecord] cacheKey is required"),this._imagesLoaded[cacheKey]},_unloadTile:function(tileRecord){$.console.assert(tileRecord,"[TileCache._unloadTile] tileRecord is required");var tile=tileRecord.tile,tiledImage=tileRecord.tiledImage;tile.unload(),tile.cacheImageRecord=null;var imageRecord=this._imagesLoaded[tile.cacheKey];imageRecord.removeTile(tile),imageRecord.getTileCount()||(imageRecord.destroy(),delete this._imagesLoaded[tile.cacheKey],this._imagesLoadedCount--),tiledImage.viewer.raiseEvent("tile-unloaded",{tile,tiledImage})}}}(OpenSeadragon),function($){$.World=function(options){var _this=this;$.console.assert(options.viewer,"[World] options.viewer is required"),$.EventSource.call(this),this.viewer=options.viewer,this._items=[],this._needsDraw=!1,this._autoRefigureSizes=!0,this._needsSizesFigured=!1,this._delegatedFigureSizes=function(event){_this._autoRefigureSizes?_this._figureSizes():_this._needsSizesFigured=!0},this._figureSizes()},$.extend($.World.prototype,$.EventSource.prototype,{addItem:function(item,options){if($.console.assert(item,"[World.addItem] item is required"),$.console.assert(item instanceof $.TiledImage,"[World.addItem] only TiledImages supported at this time"),void 0!==(options=options||{}).index){var index=Math.max(0,Math.min(this._items.length,options.index));this._items.splice(index,0,item)}else this._items.push(item);this._autoRefigureSizes?this._figureSizes():this._needsSizesFigured=!0,this._needsDraw=!0,item.addHandler("bounds-change",this._delegatedFigureSizes),item.addHandler("clip-change",this._delegatedFigureSizes),this.raiseEvent("add-item",{item})},getItemAt:function(index){return $.console.assert(void 0!==index,"[World.getItemAt] index is required"),this._items[index]},getIndexOfItem:function(item){return $.console.assert(item,"[World.getIndexOfItem] item is required"),$.indexOf(this._items,item)},getItemCount:function(){return this._items.length},setItemIndex:function(item,index){$.console.assert(item,"[World.setItemIndex] item is required"),$.console.assert(void 0!==index,"[World.setItemIndex] index is required");var oldIndex=this.getIndexOfItem(item);if(index>=this._items.length)throw new Error("Index bigger than number of layers.");index!==oldIndex&&-1!==oldIndex&&(this._items.splice(oldIndex,1),this._items.splice(index,0,item),this._needsDraw=!0,this.raiseEvent("item-index-change",{item,previousIndex:oldIndex,newIndex:index}))},removeItem:function(item){$.console.assert(item,"[World.removeItem] item is required");var index=$.indexOf(this._items,item);-1!==index&&(item.removeHandler("bounds-change",this._delegatedFigureSizes),item.removeHandler("clip-change",this._delegatedFigureSizes),item.destroy(),this._items.splice(index,1),this._figureSizes(),this._needsDraw=!0,this._raiseRemoveItem(item))},removeAll:function(){var item,i;for(this.viewer._cancelPendingImages(),i=0;i<this._items.length;i++)(item=this._items[i]).removeHandler("bounds-change",this._delegatedFigureSizes),item.removeHandler("clip-change",this._delegatedFigureSizes),item.destroy();var removedItems=this._items;for(this._items=[],this._figureSizes(),this._needsDraw=!0,i=0;i<removedItems.length;i++)item=removedItems[i],this._raiseRemoveItem(item)},resetItems:function(){for(var i=0;i<this._items.length;i++)this._items[i].reset()},update:function(){for(var animated=!1,i=0;i<this._items.length;i++)animated=this._items[i].update()||animated;return animated},draw:function(){for(var i=0;i<this._items.length;i++)this._items[i].draw();this._needsDraw=!1},needsDraw:function(){for(var i=0;i<this._items.length;i++)if(this._items[i].needsDraw())return!0;return this._needsDraw},getHomeBounds:function(){return this._homeBounds.clone()},getContentFactor:function(){return this._contentFactor},setAutoRefigureSizes:function(value){this._autoRefigureSizes=value,value&this._needsSizesFigured&&(this._figureSizes(),this._needsSizesFigured=!1)},arrange:function(options){var wrap,immediately=(options=options||{}).immediately||!1,layout=options.layout||$.DEFAULT_SETTINGS.collectionLayout,rows=options.rows||$.DEFAULT_SETTINGS.collectionRows,columns=options.columns||$.DEFAULT_SETTINGS.collectionColumns,tileSize=options.tileSize||$.DEFAULT_SETTINGS.collectionTileSize,increment=tileSize+(options.tileMargin||$.DEFAULT_SETTINGS.collectionTileMargin);wrap=!options.rows&&columns?columns:Math.ceil(this._items.length/rows);var item,box,width,height,position,x=0,y=0;this.setAutoRefigureSizes(!1);for(var i=0;i<this._items.length;i++)i&&i%wrap==0&&("horizontal"===layout?(y+=increment,x=0):(x+=increment,y=0)),height=(width=(box=(item=this._items[i]).getBounds()).width>box.height?tileSize:tileSize*(box.width/box.height))*(box.height/box.width),position=new $.Point(x+(tileSize-width)/2,y+(tileSize-height)/2),item.setPosition(position,immediately),item.setWidth(width,immediately),"horizontal"===layout?x+=increment:y+=increment;this.setAutoRefigureSizes(!0)},_figureSizes:function(){var oldHomeBounds=this._homeBounds?this._homeBounds.clone():null,oldContentSize=this._contentSize?this._contentSize.clone():null,oldContentFactor=this._contentFactor||0;if(this._items.length){var item=this._items[0],bounds=item.getBounds();this._contentFactor=item.getContentSize().x/bounds.width;for(var clippedBounds=item.getClippedBounds().getBoundingBox(),left=clippedBounds.x,top=clippedBounds.y,right=clippedBounds.x+clippedBounds.width,bottom=clippedBounds.y+clippedBounds.height,i=1;i<this._items.length;i++)bounds=(item=this._items[i]).getBounds(),this._contentFactor=Math.max(this._contentFactor,item.getContentSize().x/bounds.width),clippedBounds=item.getClippedBounds().getBoundingBox(),left=Math.min(left,clippedBounds.x),top=Math.min(top,clippedBounds.y),right=Math.max(right,clippedBounds.x+clippedBounds.width),bottom=Math.max(bottom,clippedBounds.y+clippedBounds.height);this._homeBounds=new $.Rect(left,top,right-left,bottom-top),this._contentSize=new $.Point(this._homeBounds.width*this._contentFactor,this._homeBounds.height*this._contentFactor)}else this._homeBounds=new $.Rect(0,0,1,1),this._contentSize=new $.Point(1,1),this._contentFactor=1;this._contentFactor===oldContentFactor&&this._homeBounds.equals(oldHomeBounds)&&this._contentSize.equals(oldContentSize)||this.raiseEvent("metrics-change",{})},_raiseRemoveItem:function(item){this.raiseEvent("remove-item",{item})}})}(OpenSeadragon)},"../../node_modules/parse-srcset/src/parse-srcset.js":function(module,exports){var __WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;__WEBPACK_AMD_DEFINE_ARRAY__=[],void 0===(__WEBPACK_AMD_DEFINE_RESULT__="function"==typeof(__WEBPACK_AMD_DEFINE_FACTORY__=function(){return function(input){function isSpace(c){return" "===c||"\t"===c||"\n"===c||"\f"===c||"\r"===c}function collectCharacters(regEx){var chars,match=regEx.exec(input.substring(pos));if(match)return chars=match[0],pos+=chars.length,chars}for(var url,descriptors,currentDescriptor,state,c,inputLength=input.length,regexLeadingSpaces=/^[ \t\n\r\u000c]+/,regexLeadingCommasOrSpaces=/^[, \t\n\r\u000c]+/,regexLeadingNotSpaces=/^[^ \t\n\r\u000c]+/,regexTrailingCommas=/[,]+$/,regexNonNegativeInteger=/^\d+$/,regexFloatingPoint=/^-?(?:[0-9]+|[0-9]*\.[0-9]+)(?:[eE][+-]?[0-9]+)?$/,pos=0,candidates=[];;){if(collectCharacters(regexLeadingCommasOrSpaces),pos>=inputLength)return candidates;url=collectCharacters(regexLeadingNotSpaces),descriptors=[],","===url.slice(-1)?(url=url.replace(regexTrailingCommas,""),parseDescriptors()):tokenize()}function tokenize(){for(collectCharacters(regexLeadingSpaces),currentDescriptor="",state="in descriptor";;){if(c=input.charAt(pos),"in descriptor"===state)if(isSpace(c))currentDescriptor&&(descriptors.push(currentDescriptor),currentDescriptor="",state="after descriptor");else{if(","===c)return pos+=1,currentDescriptor&&descriptors.push(currentDescriptor),void parseDescriptors();if("("===c)currentDescriptor+=c,state="in parens";else{if(""===c)return currentDescriptor&&descriptors.push(currentDescriptor),void parseDescriptors();currentDescriptor+=c}}else if("in parens"===state)if(")"===c)currentDescriptor+=c,state="in descriptor";else{if(""===c)return descriptors.push(currentDescriptor),void parseDescriptors();currentDescriptor+=c}else if("after descriptor"===state)if(isSpace(c));else{if(""===c)return void parseDescriptors();state="in descriptor",pos-=1}pos+=1}}function parseDescriptors(){var w,d,h,i,desc,lastChar,value,intVal,floatVal,pError=!1,candidate={};for(i=0;i<descriptors.length;i++)lastChar=(desc=descriptors[i])[desc.length-1],value=desc.substring(0,desc.length-1),intVal=parseInt(value,10),floatVal=parseFloat(value),regexNonNegativeInteger.test(value)&&"w"===lastChar?((w||d)&&(pError=!0),0===intVal?pError=!0:w=intVal):regexFloatingPoint.test(value)&&"x"===lastChar?((w||d||h)&&(pError=!0),floatVal<0?pError=!0:d=floatVal):regexNonNegativeInteger.test(value)&&"h"===lastChar?((h||d)&&(pError=!0),0===intVal?pError=!0:h=intVal):pError=!0;pError?console&&console.log&&console.log("Invalid srcset descriptor found in '"+input+"' at '"+desc+"'."):(candidate.url=url,w&&(candidate.w=w),d&&(candidate.d=d),h&&(candidate.h=h),candidates.push(candidate))}}})?__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__):__WEBPACK_AMD_DEFINE_FACTORY__)||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)},"../../node_modules/picocolors/picocolors.browser.js":module=>{var x=String,create=function(){return{isColorSupported:!1,reset:x,bold:x,dim:x,italic:x,underline:x,inverse:x,hidden:x,strikethrough:x,black:x,red:x,green:x,yellow:x,blue:x,magenta:x,cyan:x,white:x,gray:x,bgBlack:x,bgRed:x,bgGreen:x,bgYellow:x,bgBlue:x,bgMagenta:x,bgCyan:x,bgWhite:x}};module.exports=create(),module.exports.createColors=create},"../../node_modules/react-remove-scroll-bar/dist/es2015/constants.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Av:()=>removedBarSizeVariable,pF:()=>zeroRightClassName,xv:()=>noScrollbarsClassName,zi:()=>fullWidthClassName});var zeroRightClassName="right-scroll-bar-position",fullWidthClassName="width-before-scroll-bar",noScrollbarsClassName="with-scroll-bars-hidden",removedBarSizeVariable="--removed-body-scroll-bar-size"},"../../node_modules/react-remove-scroll-bar/dist/es2015/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{jp:()=>RemoveScrollBar});var react=__webpack_require__("../../node_modules/react/index.js"),es2015=__webpack_require__("../../node_modules/react-style-singleton/dist/es2015/index.js"),constants=__webpack_require__("../../node_modules/react-remove-scroll-bar/dist/es2015/constants.js"),zeroGap={left:0,top:0,right:0,gap:0},parse=function(x){return parseInt(x||"",10)||0},getGapWidth=function(gapMode){if(void 0===gapMode&&(gapMode="margin"),"undefined"==typeof window)return zeroGap;var offsets=function(gapMode){var cs=window.getComputedStyle(document.body),left=cs["padding"===gapMode?"paddingLeft":"marginLeft"],top=cs["padding"===gapMode?"paddingTop":"marginTop"],right=cs["padding"===gapMode?"paddingRight":"marginRight"];return[parse(left),parse(top),parse(right)]}(gapMode),documentWidth=document.documentElement.clientWidth,windowWidth=window.innerWidth;return{left:offsets[0],top:offsets[1],right:offsets[2],gap:Math.max(0,windowWidth-documentWidth+offsets[2]-offsets[0])}},Style=(0,es2015.Ws)(),getStyles=function(_a,allowRelative,gapMode,important){var left=_a.left,top=_a.top,right=_a.right,gap=_a.gap;return void 0===gapMode&&(gapMode="margin"),"\n  .".concat(constants.xv," {\n   overflow: hidden ").concat(important,";\n   padding-right: ").concat(gap,"px ").concat(important,";\n  }\n  body {\n    overflow: hidden ").concat(important,";\n    overscroll-behavior: contain;\n    ").concat([allowRelative&&"position: relative ".concat(important,";"),"margin"===gapMode&&"\n    padding-left: ".concat(left,"px;\n    padding-top: ").concat(top,"px;\n    padding-right: ").concat(right,"px;\n    margin-left:0;\n    margin-top:0;\n    margin-right: ").concat(gap,"px ").concat(important,";\n    "),"padding"===gapMode&&"padding-right: ".concat(gap,"px ").concat(important,";")].filter(Boolean).join(""),"\n  }\n  \n  .").concat(constants.pF," {\n    right: ").concat(gap,"px ").concat(important,";\n  }\n  \n  .").concat(constants.zi," {\n    margin-right: ").concat(gap,"px ").concat(important,";\n  }\n  \n  .").concat(constants.pF," .").concat(constants.pF," {\n    right: 0 ").concat(important,";\n  }\n  \n  .").concat(constants.zi," .").concat(constants.zi," {\n    margin-right: 0 ").concat(important,";\n  }\n  \n  body {\n    ").concat(constants.Av,": ").concat(gap,"px;\n  }\n")},RemoveScrollBar=function(props){var noRelative=props.noRelative,noImportant=props.noImportant,_a=props.gapMode,gapMode=void 0===_a?"margin":_a,gap=react.useMemo((function(){return getGapWidth(gapMode)}),[gapMode]);return react.createElement(Style,{styles:getStyles(gap,!noRelative,gapMode,noImportant?"":"!important")})}},"../../node_modules/react-remove-scroll/dist/es2015/Combination.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Z:()=>Combination});var tslib_es6=__webpack_require__("../../node_modules/tslib/tslib.es6.mjs"),react=__webpack_require__("../../node_modules/react/index.js"),constants=__webpack_require__("../../node_modules/react-remove-scroll-bar/dist/es2015/constants.js"),useMergeRef=__webpack_require__("../../node_modules/use-callback-ref/dist/es2015/useMergeRef.js"),effectCar=(0,__webpack_require__("../../node_modules/use-sidecar/dist/es2015/medium.js")._)(),nothing=function(){},RemoveScroll=react.forwardRef((function(props,parentRef){var ref=react.useRef(null),_a=react.useState({onScrollCapture:nothing,onWheelCapture:nothing,onTouchMoveCapture:nothing}),callbacks=_a[0],setCallbacks=_a[1],forwardProps=props.forwardProps,children=props.children,className=props.className,removeScrollBar=props.removeScrollBar,enabled=props.enabled,shards=props.shards,sideCar=props.sideCar,noIsolation=props.noIsolation,inert=props.inert,allowPinchZoom=props.allowPinchZoom,_b=props.as,Container=void 0===_b?"div":_b,rest=(0,tslib_es6._T)(props,["forwardProps","children","className","removeScrollBar","enabled","shards","sideCar","noIsolation","inert","allowPinchZoom","as"]),SideCar=sideCar,containerRef=(0,useMergeRef.q)([ref,parentRef]),containerProps=(0,tslib_es6.pi)((0,tslib_es6.pi)({},rest),callbacks);return react.createElement(react.Fragment,null,enabled&&react.createElement(SideCar,{sideCar:effectCar,removeScrollBar,shards,noIsolation,inert,setCallbacks,allowPinchZoom:!!allowPinchZoom,lockRef:ref}),forwardProps?react.cloneElement(react.Children.only(children),(0,tslib_es6.pi)((0,tslib_es6.pi)({},containerProps),{ref:containerRef})):react.createElement(Container,(0,tslib_es6.pi)({},containerProps,{className,ref:containerRef}),children))}));RemoveScroll.defaultProps={enabled:!0,removeScrollBar:!0,inert:!1},RemoveScroll.classNames={fullWidth:constants.zi,zeroRight:constants.pF};var es2015_exports=__webpack_require__("../../node_modules/use-sidecar/dist/es2015/exports.js"),es2015=__webpack_require__("../../node_modules/react-remove-scroll-bar/dist/es2015/index.js"),dist_es2015=__webpack_require__("../../node_modules/react-style-singleton/dist/es2015/index.js"),passiveSupported=!1;if("undefined"!=typeof window)try{var options=Object.defineProperty({},"passive",{get:function(){return passiveSupported=!0,!0}});window.addEventListener("test",options,options),window.removeEventListener("test",options,options)}catch(err){passiveSupported=!1}var nonPassive=!!passiveSupported&&{passive:!1},elementCanBeScrolled=function(node,overflow){var styles=window.getComputedStyle(node);return"hidden"!==styles[overflow]&&!(styles.overflowY===styles.overflowX&&!function(node){return"TEXTAREA"===node.tagName}(node)&&"visible"===styles[overflow])},locationCouldBeScrolled=function(axis,node){var current=node;do{if("undefined"!=typeof ShadowRoot&&current instanceof ShadowRoot&&(current=current.host),elementCouldBeScrolled(axis,current)){var _a=getScrollVariables(axis,current);if(_a[1]>_a[2])return!0}current=current.parentNode}while(current&&current!==document.body);return!1},elementCouldBeScrolled=function(axis,node){return"v"===axis?function(node){return elementCanBeScrolled(node,"overflowY")}(node):function(node){return elementCanBeScrolled(node,"overflowX")}(node)},getScrollVariables=function(axis,node){return"v"===axis?[(_a=node).scrollTop,_a.scrollHeight,_a.clientHeight]:function(_a){return[_a.scrollLeft,_a.scrollWidth,_a.clientWidth]}(node);var _a},getTouchXY=function(event){return"changedTouches"in event?[event.changedTouches[0].clientX,event.changedTouches[0].clientY]:[0,0]},getDeltaXY=function(event){return[event.deltaX,event.deltaY]},extractRef=function(ref){return ref&&"current"in ref?ref.current:ref},generateStyle=function(id){return"\n  .block-interactivity-".concat(id," {pointer-events: none;}\n  .allow-interactivity-").concat(id," {pointer-events: all;}\n")},idCounter=0,lockStack=[];const sidecar=(0,es2015_exports.L)(effectCar,(function RemoveScrollSideCar(props){var shouldPreventQueue=react.useRef([]),touchStartRef=react.useRef([0,0]),activeAxis=react.useRef(),id=react.useState(idCounter++)[0],Style=react.useState((function(){return(0,dist_es2015.Ws)()}))[0],lastProps=react.useRef(props);react.useEffect((function(){lastProps.current=props}),[props]),react.useEffect((function(){if(props.inert){document.body.classList.add("block-interactivity-".concat(id));var allow_1=(0,tslib_es6.ev)([props.lockRef.current],(props.shards||[]).map(extractRef),!0).filter(Boolean);return allow_1.forEach((function(el){return el.classList.add("allow-interactivity-".concat(id))})),function(){document.body.classList.remove("block-interactivity-".concat(id)),allow_1.forEach((function(el){return el.classList.remove("allow-interactivity-".concat(id))}))}}}),[props.inert,props.lockRef.current,props.shards]);var shouldCancelEvent=react.useCallback((function(event,parent){if("touches"in event&&2===event.touches.length)return!lastProps.current.allowPinchZoom;var currentAxis,touch=getTouchXY(event),touchStart=touchStartRef.current,deltaX="deltaX"in event?event.deltaX:touchStart[0]-touch[0],deltaY="deltaY"in event?event.deltaY:touchStart[1]-touch[1],target=event.target,moveDirection=Math.abs(deltaX)>Math.abs(deltaY)?"h":"v";if("touches"in event&&"h"===moveDirection&&"range"===target.type)return!1;var canBeScrolledInMainDirection=locationCouldBeScrolled(moveDirection,target);if(!canBeScrolledInMainDirection)return!0;if(canBeScrolledInMainDirection?currentAxis=moveDirection:(currentAxis="v"===moveDirection?"h":"v",canBeScrolledInMainDirection=locationCouldBeScrolled(moveDirection,target)),!canBeScrolledInMainDirection)return!1;if(!activeAxis.current&&"changedTouches"in event&&(deltaX||deltaY)&&(activeAxis.current=currentAxis),!currentAxis)return!0;var cancelingAxis=activeAxis.current||currentAxis;return function(axis,endTarget,event,sourceDelta,noOverscroll){var directionFactor=function(axis,direction){return"h"===axis&&"rtl"===direction?-1:1}(axis,window.getComputedStyle(endTarget).direction),delta=directionFactor*sourceDelta,target=event.target,targetInLock=endTarget.contains(target),shouldCancelScroll=!1,isDeltaPositive=delta>0,availableScroll=0,availableScrollTop=0;do{var _a=getScrollVariables(axis,target),position=_a[0],elementScroll=_a[1]-_a[2]-directionFactor*position;(position||elementScroll)&&elementCouldBeScrolled(axis,target)&&(availableScroll+=elementScroll,availableScrollTop+=position),target=target.parentNode}while(!targetInLock&&target!==document.body||targetInLock&&(endTarget.contains(target)||endTarget===target));return(isDeltaPositive&&(noOverscroll&&0===availableScroll||!noOverscroll&&delta>availableScroll)||!isDeltaPositive&&(noOverscroll&&0===availableScrollTop||!noOverscroll&&-delta>availableScrollTop))&&(shouldCancelScroll=!0),shouldCancelScroll}(cancelingAxis,parent,event,"h"===cancelingAxis?deltaX:deltaY,!0)}),[]),shouldPrevent=react.useCallback((function(_event){var event=_event;if(lockStack.length&&lockStack[lockStack.length-1]===Style){var delta="deltaY"in event?getDeltaXY(event):getTouchXY(event),sourceEvent=shouldPreventQueue.current.filter((function(e){return e.name===event.type&&e.target===event.target&&(x=e.delta,y=delta,x[0]===y[0]&&x[1]===y[1]);var x,y}))[0];if(sourceEvent&&sourceEvent.should)event.cancelable&&event.preventDefault();else if(!sourceEvent){var shardNodes=(lastProps.current.shards||[]).map(extractRef).filter(Boolean).filter((function(node){return node.contains(event.target)}));(shardNodes.length>0?shouldCancelEvent(event,shardNodes[0]):!lastProps.current.noIsolation)&&event.cancelable&&event.preventDefault()}}}),[]),shouldCancel=react.useCallback((function(name,delta,target,should){var event={name,delta,target,should};shouldPreventQueue.current.push(event),setTimeout((function(){shouldPreventQueue.current=shouldPreventQueue.current.filter((function(e){return e!==event}))}),1)}),[]),scrollTouchStart=react.useCallback((function(event){touchStartRef.current=getTouchXY(event),activeAxis.current=void 0}),[]),scrollWheel=react.useCallback((function(event){shouldCancel(event.type,getDeltaXY(event),event.target,shouldCancelEvent(event,props.lockRef.current))}),[]),scrollTouchMove=react.useCallback((function(event){shouldCancel(event.type,getTouchXY(event),event.target,shouldCancelEvent(event,props.lockRef.current))}),[]);react.useEffect((function(){return lockStack.push(Style),props.setCallbacks({onScrollCapture:scrollWheel,onWheelCapture:scrollWheel,onTouchMoveCapture:scrollTouchMove}),document.addEventListener("wheel",shouldPrevent,nonPassive),document.addEventListener("touchmove",shouldPrevent,nonPassive),document.addEventListener("touchstart",scrollTouchStart,nonPassive),function(){lockStack=lockStack.filter((function(inst){return inst!==Style})),document.removeEventListener("wheel",shouldPrevent,nonPassive),document.removeEventListener("touchmove",shouldPrevent,nonPassive),document.removeEventListener("touchstart",scrollTouchStart,nonPassive)}}),[]);var removeScrollBar=props.removeScrollBar,inert=props.inert;return react.createElement(react.Fragment,null,inert?react.createElement(Style,{styles:generateStyle(id)}):null,removeScrollBar?react.createElement(es2015.jp,{gapMode:"margin"}):null)}));var ReactRemoveScroll=react.forwardRef((function(props,ref){return react.createElement(RemoveScroll,(0,tslib_es6.pi)({},props,{ref,sideCar:sidecar}))}));ReactRemoveScroll.classNames=RemoveScroll.classNames;const Combination=ReactRemoveScroll},"../../node_modules/react-style-singleton/dist/es2015/index.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Ws:()=>styleSingleton});var currentNonce,react=__webpack_require__("../../node_modules/react/index.js");function makeStyleTag(){if(!document)return null;var tag=document.createElement("style");tag.type="text/css";var nonce=currentNonce||__webpack_require__.nc;return nonce&&tag.setAttribute("nonce",nonce),tag}var stylesheetSingleton=function(){var counter=0,stylesheet=null;return{add:function(style){0==counter&&(stylesheet=makeStyleTag())&&(!function injectStyles(tag,css){tag.styleSheet?tag.styleSheet.cssText=css:tag.appendChild(document.createTextNode(css))}(stylesheet,style),function insertStyleTag(tag){(document.head||document.getElementsByTagName("head")[0]).appendChild(tag)}(stylesheet)),counter++},remove:function(){! --counter&&stylesheet&&(stylesheet.parentNode&&stylesheet.parentNode.removeChild(stylesheet),stylesheet=null)}}},styleSingleton=function(){var sheet,useStyle=(sheet=stylesheetSingleton(),function(styles,isDynamic){react.useEffect((function(){return sheet.add(styles),function(){sheet.remove()}}),[styles&&isDynamic])});return function(_a){var styles=_a.styles,dynamic=_a.dynamic;return useStyle(styles,dynamic),null}}},"../../node_modules/sanitize-html/index.js":(module,__unused_webpack_exports,__webpack_require__)=>{const htmlparser=__webpack_require__("../../node_modules/htmlparser2/lib/esm/index.js"),escapeStringRegexp=__webpack_require__("../../node_modules/escape-string-regexp/index.js"),{isPlainObject}=__webpack_require__("../../node_modules/sanitize-html/node_modules/is-plain-object/dist/is-plain-object.mjs"),deepmerge=__webpack_require__("../../node_modules/deepmerge/dist/cjs.js"),parseSrcset=__webpack_require__("../../node_modules/parse-srcset/src/parse-srcset.js"),{parse:postcssParse}=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/postcss.mjs"),mediaTags=["img","audio","video","picture","svg","object","map","iframe","embed"],vulnerableTags=["script","style"];function each(obj,cb){obj&&Object.keys(obj).forEach((function(key){cb(obj[key],key)}))}function has(obj,key){return{}.hasOwnProperty.call(obj,key)}function filter(a,cb){const n=[];return each(a,(function(v){cb(v)&&n.push(v)})),n}module.exports=sanitizeHtml;const VALID_HTML_ATTRIBUTE_NAME=/^[^\0\t\n\f\r /<=>]+$/;function sanitizeHtml(html,options,_recursing){if(null==html)return"";"number"==typeof html&&(html=html.toString());let result="",tempResult="";function Frame(tag,attribs){const that=this;this.tag=tag,this.attribs=attribs||{},this.tagPosition=result.length,this.text="",this.mediaChildren=[],this.updateParentNodeText=function(){if(stack.length){stack[stack.length-1].text+=that.text}},this.updateParentNodeMediaChildren=function(){if(stack.length&&mediaTags.includes(this.tag)){stack[stack.length-1].mediaChildren.push(this.tag)}}}(options=Object.assign({},sanitizeHtml.defaults,options)).parser=Object.assign({},htmlParserDefaults,options.parser);const tagAllowed=function(name){return!1===options.allowedTags||(options.allowedTags||[]).indexOf(name)>-1};vulnerableTags.forEach((function(tag){tagAllowed(tag)&&!options.allowVulnerableTags&&console.warn(`\n\n Your \`allowedTags\` option includes, \`${tag}\`, which is inherently\nvulnerable to XSS attacks. Please remove it from \`allowedTags\`.\nOr, to disable this warning, add the \`allowVulnerableTags\` option\nand ensure you are accounting for this risk.\n\n`)}));const nonTextTagsArray=options.nonTextTags||["script","style","textarea","option"];let allowedAttributesMap,allowedAttributesGlobMap;options.allowedAttributes&&(allowedAttributesMap={},allowedAttributesGlobMap={},each(options.allowedAttributes,(function(attributes,tag){allowedAttributesMap[tag]=[];const globRegex=[];attributes.forEach((function(obj){"string"==typeof obj&&obj.indexOf("*")>=0?globRegex.push(escapeStringRegexp(obj).replace(/\\\*/g,".*")):allowedAttributesMap[tag].push(obj)})),globRegex.length&&(allowedAttributesGlobMap[tag]=new RegExp("^("+globRegex.join("|")+")$"))})));const allowedClassesMap={},allowedClassesGlobMap={},allowedClassesRegexMap={};each(options.allowedClasses,(function(classes,tag){if(allowedAttributesMap&&(has(allowedAttributesMap,tag)||(allowedAttributesMap[tag]=[]),allowedAttributesMap[tag].push("class")),allowedClassesMap[tag]=classes,Array.isArray(classes)){const globRegex=[];allowedClassesMap[tag]=[],allowedClassesRegexMap[tag]=[],classes.forEach((function(obj){"string"==typeof obj&&obj.indexOf("*")>=0?globRegex.push(escapeStringRegexp(obj).replace(/\\\*/g,".*")):obj instanceof RegExp?allowedClassesRegexMap[tag].push(obj):allowedClassesMap[tag].push(obj)})),globRegex.length&&(allowedClassesGlobMap[tag]=new RegExp("^("+globRegex.join("|")+")$"))}}));const transformTagsMap={};let transformTagsAll,depth,stack,skipMap,transformMap,skipText,skipTextDepth;each(options.transformTags,(function(transform,tag){let transFun;"function"==typeof transform?transFun=transform:"string"==typeof transform&&(transFun=sanitizeHtml.simpleTransform(transform)),"*"===tag?transformTagsAll=transFun:transformTagsMap[tag]=transFun}));let addedText=!1;initializeState();const parser=new htmlparser.Parser({onopentag:function(name,attribs){if(options.enforceHtmlBoundary&&"html"===name&&initializeState(),skipText)return void skipTextDepth++;const frame=new Frame(name,attribs);stack.push(frame);let skip=!1;const hasText=!!frame.text;let transformedTag;if(has(transformTagsMap,name)&&(transformedTag=transformTagsMap[name](name,attribs),frame.attribs=attribs=transformedTag.attribs,void 0!==transformedTag.text&&(frame.innerText=transformedTag.text),name!==transformedTag.tagName&&(frame.name=name=transformedTag.tagName,transformMap[depth]=transformedTag.tagName)),transformTagsAll&&(transformedTag=transformTagsAll(name,attribs),frame.attribs=attribs=transformedTag.attribs,name!==transformedTag.tagName&&(frame.name=name=transformedTag.tagName,transformMap[depth]=transformedTag.tagName)),(!tagAllowed(name)||"recursiveEscape"===options.disallowedTagsMode&&!function isEmptyObject(obj){for(const key in obj)if(has(obj,key))return!1;return!0}(skipMap)||null!=options.nestingLimit&&depth>=options.nestingLimit)&&(skip=!0,skipMap[depth]=!0,"discard"===options.disallowedTagsMode&&-1!==nonTextTagsArray.indexOf(name)&&(skipText=!0,skipTextDepth=1),skipMap[depth]=!0),depth++,skip){if("discard"===options.disallowedTagsMode)return;tempResult=result,result=""}result+="<"+name,"script"===name&&(options.allowedScriptHostnames||options.allowedScriptDomains)&&(frame.innerText=""),(!allowedAttributesMap||has(allowedAttributesMap,name)||allowedAttributesMap["*"])&&each(attribs,(function(value,a){if(!VALID_HTML_ATTRIBUTE_NAME.test(a))return void delete frame.attribs[a];if(""===value&&(options.nonBooleanAttributes.includes(a)||options.nonBooleanAttributes.includes("*")))return void delete frame.attribs[a];let passedAllowedAttributesMapCheck=!1;if(!allowedAttributesMap||has(allowedAttributesMap,name)&&-1!==allowedAttributesMap[name].indexOf(a)||allowedAttributesMap["*"]&&-1!==allowedAttributesMap["*"].indexOf(a)||has(allowedAttributesGlobMap,name)&&allowedAttributesGlobMap[name].test(a)||allowedAttributesGlobMap["*"]&&allowedAttributesGlobMap["*"].test(a))passedAllowedAttributesMapCheck=!0;else if(allowedAttributesMap&&allowedAttributesMap[name])for(const o of allowedAttributesMap[name])if(isPlainObject(o)&&o.name&&o.name===a){passedAllowedAttributesMapCheck=!0;let newValue="";if(!0===o.multiple){const splitStrArray=value.split(" ");for(const s of splitStrArray)-1!==o.values.indexOf(s)&&(""===newValue?newValue=s:newValue+=" "+s)}else o.values.indexOf(value)>=0&&(newValue=value);value=newValue}if(passedAllowedAttributesMapCheck){if(-1!==options.allowedSchemesAppliedToAttributes.indexOf(a)&&naughtyHref(name,value))return void delete frame.attribs[a];if("script"===name&&"src"===a){let allowed=!0;try{const parsed=parseUrl(value);if(options.allowedScriptHostnames||options.allowedScriptDomains){const allowedHostname=(options.allowedScriptHostnames||[]).find((function(hostname){return hostname===parsed.url.hostname})),allowedDomain=(options.allowedScriptDomains||[]).find((function(domain){return parsed.url.hostname===domain||parsed.url.hostname.endsWith(`.${domain}`)}));allowed=allowedHostname||allowedDomain}}catch(e){allowed=!1}if(!allowed)return void delete frame.attribs[a]}if("iframe"===name&&"src"===a){let allowed=!0;try{const parsed=parseUrl(value);if(parsed.isRelativeUrl)allowed=has(options,"allowIframeRelativeUrls")?options.allowIframeRelativeUrls:!options.allowedIframeHostnames&&!options.allowedIframeDomains;else if(options.allowedIframeHostnames||options.allowedIframeDomains){const allowedHostname=(options.allowedIframeHostnames||[]).find((function(hostname){return hostname===parsed.url.hostname})),allowedDomain=(options.allowedIframeDomains||[]).find((function(domain){return parsed.url.hostname===domain||parsed.url.hostname.endsWith(`.${domain}`)}));allowed=allowedHostname||allowedDomain}}catch(e){allowed=!1}if(!allowed)return void delete frame.attribs[a]}if("srcset"===a)try{let parsed=parseSrcset(value);if(parsed.forEach((function(value){naughtyHref("srcset",value.url)&&(value.evil=!0)})),parsed=filter(parsed,(function(v){return!v.evil})),!parsed.length)return void delete frame.attribs[a];value=function stringifySrcset(parsedSrcset){return parsedSrcset.map((function(part){if(!part.url)throw new Error("URL missing");return part.url+(part.w?` ${part.w}w`:"")+(part.h?` ${part.h}h`:"")+(part.d?` ${part.d}x`:"")})).join(", ")}(filter(parsed,(function(v){return!v.evil}))),frame.attribs[a]=value}catch(e){return void delete frame.attribs[a]}if("class"===a){const allowedSpecificClasses=allowedClassesMap[name],allowedWildcardClasses=allowedClassesMap["*"],allowedSpecificClassesGlob=allowedClassesGlobMap[name],allowedSpecificClassesRegex=allowedClassesRegexMap[name],allowedClassesGlobs=[allowedSpecificClassesGlob,allowedClassesGlobMap["*"]].concat(allowedSpecificClassesRegex).filter((function(t){return t}));if(!(value=filterClasses(value,allowedSpecificClasses&&allowedWildcardClasses?deepmerge(allowedSpecificClasses,allowedWildcardClasses):allowedSpecificClasses||allowedWildcardClasses,allowedClassesGlobs)).length)return void delete frame.attribs[a]}if("style"===a)if(options.parseStyleAttributes)try{const filteredAST=function filterCss(abstractSyntaxTree,allowedStyles){if(!allowedStyles)return abstractSyntaxTree;const astRules=abstractSyntaxTree.nodes[0];let selectedRule;selectedRule=allowedStyles[astRules.selector]&&allowedStyles["*"]?deepmerge(allowedStyles[astRules.selector],allowedStyles["*"]):allowedStyles[astRules.selector]||allowedStyles["*"];selectedRule&&(abstractSyntaxTree.nodes[0].nodes=astRules.nodes.reduce(function filterDeclarations(selectedRule){return function(allowedDeclarationsList,attributeObject){if(has(selectedRule,attributeObject.prop)){selectedRule[attributeObject.prop].some((function(regularExpression){return regularExpression.test(attributeObject.value)}))&&allowedDeclarationsList.push(attributeObject)}return allowedDeclarationsList}}(selectedRule),[]));return abstractSyntaxTree}(postcssParse(name+" {"+value+"}"),options.allowedStyles);if(value=function stringifyStyleAttributes(filteredAST){return filteredAST.nodes[0].nodes.reduce((function(extractedAttributes,attrObject){return extractedAttributes.push(`${attrObject.prop}:${attrObject.value}${attrObject.important?" !important":""}`),extractedAttributes}),[]).join(";")}(filteredAST),0===value.length)return void delete frame.attribs[a]}catch(e){return"undefined"!=typeof window&&console.warn('Failed to parse "'+name+" {"+value+"}\", If you're running this in a browser, we recommend to disable style parsing: options.parseStyleAttributes: false, since this only works in a node environment due to a postcss dependency, More info: https://github.com/apostrophecms/sanitize-html/issues/547"),void delete frame.attribs[a]}else if(options.allowedStyles)throw new Error("allowedStyles option cannot be used together with parseStyleAttributes: false.");result+=" "+a,value&&value.length&&(result+='="'+escapeHtml(value,!0)+'"')}else delete frame.attribs[a]})),-1!==options.selfClosing.indexOf(name)?result+=" />":(result+=">",!frame.innerText||hasText||options.textFilter||(result+=escapeHtml(frame.innerText),addedText=!0)),skip&&(result=tempResult+escapeHtml(result),tempResult="")},ontext:function(text){if(skipText)return;const lastFrame=stack[stack.length-1];let tag;if(lastFrame&&(tag=lastFrame.tag,text=void 0!==lastFrame.innerText?lastFrame.innerText:text),"discard"!==options.disallowedTagsMode||"script"!==tag&&"style"!==tag){const escaped=escapeHtml(text,!1);options.textFilter&&!addedText?result+=options.textFilter(escaped,tag):addedText||(result+=escaped)}else result+=text;if(stack.length){stack[stack.length-1].text+=text}},onclosetag:function(name,isImplied){if(skipText){if(skipTextDepth--,skipTextDepth)return;skipText=!1}const frame=stack.pop();if(!frame)return;if(frame.tag!==name)return void stack.push(frame);skipText=!!options.enforceHtmlBoundary&&"html"===name,depth--;const skip=skipMap[depth];if(skip){if(delete skipMap[depth],"discard"===options.disallowedTagsMode)return void frame.updateParentNodeText();tempResult=result,result=""}transformMap[depth]&&(name=transformMap[depth],delete transformMap[depth]),options.exclusiveFilter&&options.exclusiveFilter(frame)?result=result.substr(0,frame.tagPosition):(frame.updateParentNodeMediaChildren(),frame.updateParentNodeText(),-1!==options.selfClosing.indexOf(name)||isImplied&&!tagAllowed(name)&&["escape","recursiveEscape"].indexOf(options.disallowedTagsMode)>=0?skip&&(result=tempResult,tempResult=""):(result+="</"+name+">",skip&&(result=tempResult+escapeHtml(result),tempResult=""),addedText=!1))}},options.parser);return parser.write(html),parser.end(),result;function initializeState(){result="",depth=0,stack=[],skipMap={},transformMap={},skipText=!1,skipTextDepth=0}function escapeHtml(s,quote){return"string"!=typeof s&&(s+=""),options.parser.decodeEntities&&(s=s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),quote&&(s=s.replace(/"/g,"&quot;"))),s=s.replace(/&(?![a-zA-Z0-9#]{1,20};)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),quote&&(s=s.replace(/"/g,"&quot;")),s}function naughtyHref(name,href){for(href=href.replace(/[\x00-\x20]+/g,"");;){const firstIndex=href.indexOf("\x3c!--");if(-1===firstIndex)break;const lastIndex=href.indexOf("--\x3e",firstIndex+4);if(-1===lastIndex)break;href=href.substring(0,firstIndex)+href.substring(lastIndex+3)}const matches=href.match(/^([a-zA-Z][a-zA-Z0-9.\-+]*):/);if(!matches)return!!href.match(/^[/\\]{2}/)&&!options.allowProtocolRelative;const scheme=matches[1].toLowerCase();return has(options.allowedSchemesByTag,name)?-1===options.allowedSchemesByTag[name].indexOf(scheme):!options.allowedSchemes||-1===options.allowedSchemes.indexOf(scheme)}function parseUrl(value){if((value=value.replace(/^(\w+:)?\s*[\\/]\s*[\\/]/,"$1//")).startsWith("relative:"))throw new Error("relative: exploit attempt");let base="relative://relative-site";for(let i=0;i<100;i++)base+=`/${i}`;const parsed=new URL(value,base);return{isRelativeUrl:parsed&&"relative-site"===parsed.hostname&&"relative:"===parsed.protocol,url:parsed}}function filterClasses(classes,allowed,allowedGlobs){return allowed?(classes=classes.split(/\s+/)).filter((function(clss){return-1!==allowed.indexOf(clss)||allowedGlobs.some((function(glob){return glob.test(clss)}))})).join(" "):classes}}const htmlParserDefaults={decodeEntities:!0};sanitizeHtml.defaults={allowedTags:["address","article","aside","footer","header","h1","h2","h3","h4","h5","h6","hgroup","main","nav","section","blockquote","dd","div","dl","dt","figcaption","figure","hr","li","main","ol","p","pre","ul","a","abbr","b","bdi","bdo","br","cite","code","data","dfn","em","i","kbd","mark","q","rb","rp","rt","rtc","ruby","s","samp","small","span","strong","sub","sup","time","u","var","wbr","caption","col","colgroup","table","tbody","td","tfoot","th","thead","tr"],nonBooleanAttributes:["abbr","accept","accept-charset","accesskey","action","allow","alt","as","autocapitalize","autocomplete","blocking","charset","cite","class","color","cols","colspan","content","contenteditable","coords","crossorigin","data","datetime","decoding","dir","dirname","download","draggable","enctype","enterkeyhint","fetchpriority","for","form","formaction","formenctype","formmethod","formtarget","headers","height","hidden","high","href","hreflang","http-equiv","id","imagesizes","imagesrcset","inputmode","integrity","is","itemid","itemprop","itemref","itemtype","kind","label","lang","list","loading","low","max","maxlength","media","method","min","minlength","name","nonce","optimum","pattern","ping","placeholder","popover","popovertarget","popovertargetaction","poster","preload","referrerpolicy","rel","rows","rowspan","sandbox","scope","shape","size","sizes","slot","span","spellcheck","src","srcdoc","srclang","srcset","start","step","style","tabindex","target","title","translate","type","usemap","value","width","wrap","onauxclick","onafterprint","onbeforematch","onbeforeprint","onbeforeunload","onbeforetoggle","onblur","oncancel","oncanplay","oncanplaythrough","onchange","onclick","onclose","oncontextlost","oncontextmenu","oncontextrestored","oncopy","oncuechange","oncut","ondblclick","ondrag","ondragend","ondragenter","ondragleave","ondragover","ondragstart","ondrop","ondurationchange","onemptied","onended","onerror","onfocus","onformdata","onhashchange","oninput","oninvalid","onkeydown","onkeypress","onkeyup","onlanguagechange","onload","onloadeddata","onloadedmetadata","onloadstart","onmessage","onmessageerror","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onoffline","ononline","onpagehide","onpageshow","onpaste","onpause","onplay","onplaying","onpopstate","onprogress","onratechange","onreset","onresize","onrejectionhandled","onscroll","onscrollend","onsecuritypolicyviolation","onseeked","onseeking","onselect","onslotchange","onstalled","onstorage","onsubmit","onsuspend","ontimeupdate","ontoggle","onunhandledrejection","onunload","onvolumechange","onwaiting","onwheel"],disallowedTagsMode:"discard",allowedAttributes:{a:["href","name","target"],img:["src","srcset","alt","title","width","height","loading"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:["http","https","ftp","mailto","tel"],allowedSchemesByTag:{},allowedSchemesAppliedToAttributes:["href","src","cite"],allowProtocolRelative:!0,enforceHtmlBoundary:!1,parseStyleAttributes:!0},sanitizeHtml.simpleTransform=function(newTagName,newAttribs,merge){return merge=void 0===merge||merge,newAttribs=newAttribs||{},function(tagName,attribs){let attrib;if(merge)for(attrib in newAttribs)attribs[attrib]=newAttribs[attrib];else attribs=newAttribs;return{tagName:newTagName,attribs}}}},"../../node_modules/sanitize-html/node_modules/is-plain-object/dist/is-plain-object.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";function isObject(o){return"[object Object]"===Object.prototype.toString.call(o)}function isPlainObject(o){var ctor,prot;return!1!==isObject(o)&&(void 0===(ctor=o.constructor)||!1!==isObject(prot=ctor.prototype)&&!1!==prot.hasOwnProperty("isPrototypeOf"))}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{isPlainObject:()=>isPlainObject})},"../../node_modules/sanitize-html/node_modules/postcss/lib/at-rule.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Container=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/container.js");class AtRule extends Container{constructor(defaults){super(defaults),this.type="atrule"}append(...children){return this.proxyOf.nodes||(this.nodes=[]),super.append(...children)}prepend(...children){return this.proxyOf.nodes||(this.nodes=[]),super.prepend(...children)}}module.exports=AtRule,AtRule.default=AtRule,Container.registerAtRule(AtRule)},"../../node_modules/sanitize-html/node_modules/postcss/lib/comment.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Node=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/node.js");class Comment extends Node{constructor(defaults){super(defaults),this.type="comment"}}module.exports=Comment,Comment.default=Comment},"../../node_modules/sanitize-html/node_modules/postcss/lib/container.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let parse,Rule,AtRule,Root,{isClean,my}=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/symbols.js"),Declaration=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/declaration.js"),Comment=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/comment.js"),Node=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/node.js");function cleanSource(nodes){return nodes.map((i=>(i.nodes&&(i.nodes=cleanSource(i.nodes)),delete i.source,i)))}function markDirtyUp(node){if(node[isClean]=!1,node.proxyOf.nodes)for(let i of node.proxyOf.nodes)markDirtyUp(i)}class Container extends Node{append(...children){for(let child of children){let nodes=this.normalize(child,this.last);for(let node of nodes)this.proxyOf.nodes.push(node)}return this.markDirty(),this}cleanRaws(keepBetween){if(super.cleanRaws(keepBetween),this.nodes)for(let node of this.nodes)node.cleanRaws(keepBetween)}each(callback){if(!this.proxyOf.nodes)return;let index,result,iterator=this.getIterator();for(;this.indexes[iterator]<this.proxyOf.nodes.length&&(index=this.indexes[iterator],result=callback(this.proxyOf.nodes[index],index),!1!==result);)this.indexes[iterator]+=1;return delete this.indexes[iterator],result}every(condition){return this.nodes.every(condition)}getIterator(){this.lastEach||(this.lastEach=0),this.indexes||(this.indexes={}),this.lastEach+=1;let iterator=this.lastEach;return this.indexes[iterator]=0,iterator}getProxyProcessor(){return{get:(node,prop)=>"proxyOf"===prop?node:node[prop]?"each"===prop||"string"==typeof prop&&prop.startsWith("walk")?(...args)=>node[prop](...args.map((i=>"function"==typeof i?(child,index)=>i(child.toProxy(),index):i))):"every"===prop||"some"===prop?cb=>node[prop](((child,...other)=>cb(child.toProxy(),...other))):"root"===prop?()=>node.root().toProxy():"nodes"===prop?node.nodes.map((i=>i.toProxy())):"first"===prop||"last"===prop?node[prop].toProxy():node[prop]:node[prop],set:(node,prop,value)=>(node[prop]===value||(node[prop]=value,"name"!==prop&&"params"!==prop&&"selector"!==prop||node.markDirty()),!0)}}index(child){return"number"==typeof child?child:(child.proxyOf&&(child=child.proxyOf),this.proxyOf.nodes.indexOf(child))}insertAfter(exist,add){let index,existIndex=this.index(exist),nodes=this.normalize(add,this.proxyOf.nodes[existIndex]).reverse();existIndex=this.index(exist);for(let node of nodes)this.proxyOf.nodes.splice(existIndex+1,0,node);for(let id in this.indexes)index=this.indexes[id],existIndex<index&&(this.indexes[id]=index+nodes.length);return this.markDirty(),this}insertBefore(exist,add){let index,existIndex=this.index(exist),type=0===existIndex&&"prepend",nodes=this.normalize(add,this.proxyOf.nodes[existIndex],type).reverse();existIndex=this.index(exist);for(let node of nodes)this.proxyOf.nodes.splice(existIndex,0,node);for(let id in this.indexes)index=this.indexes[id],existIndex<=index&&(this.indexes[id]=index+nodes.length);return this.markDirty(),this}normalize(nodes,sample){if("string"==typeof nodes)nodes=cleanSource(parse(nodes).nodes);else if(Array.isArray(nodes)){nodes=nodes.slice(0);for(let i of nodes)i.parent&&i.parent.removeChild(i,"ignore")}else if("root"===nodes.type&&"document"!==this.type){nodes=nodes.nodes.slice(0);for(let i of nodes)i.parent&&i.parent.removeChild(i,"ignore")}else if(nodes.type)nodes=[nodes];else if(nodes.prop){if(void 0===nodes.value)throw new Error("Value field is missed in node creation");"string"!=typeof nodes.value&&(nodes.value=String(nodes.value)),nodes=[new Declaration(nodes)]}else if(nodes.selector)nodes=[new Rule(nodes)];else if(nodes.name)nodes=[new AtRule(nodes)];else{if(!nodes.text)throw new Error("Unknown node type in node creation");nodes=[new Comment(nodes)]}return nodes.map((i=>(i[my]||Container.rebuild(i),(i=i.proxyOf).parent&&i.parent.removeChild(i),i[isClean]&&markDirtyUp(i),void 0===i.raws.before&&sample&&void 0!==sample.raws.before&&(i.raws.before=sample.raws.before.replace(/\S/g,"")),i.parent=this.proxyOf,i)))}prepend(...children){children=children.reverse();for(let child of children){let nodes=this.normalize(child,this.first,"prepend").reverse();for(let node of nodes)this.proxyOf.nodes.unshift(node);for(let id in this.indexes)this.indexes[id]=this.indexes[id]+nodes.length}return this.markDirty(),this}push(child){return child.parent=this,this.proxyOf.nodes.push(child),this}removeAll(){for(let node of this.proxyOf.nodes)node.parent=void 0;return this.proxyOf.nodes=[],this.markDirty(),this}removeChild(child){let index;child=this.index(child),this.proxyOf.nodes[child].parent=void 0,this.proxyOf.nodes.splice(child,1);for(let id in this.indexes)index=this.indexes[id],index>=child&&(this.indexes[id]=index-1);return this.markDirty(),this}replaceValues(pattern,opts,callback){return callback||(callback=opts,opts={}),this.walkDecls((decl=>{opts.props&&!opts.props.includes(decl.prop)||opts.fast&&!decl.value.includes(opts.fast)||(decl.value=decl.value.replace(pattern,callback))})),this.markDirty(),this}some(condition){return this.nodes.some(condition)}walk(callback){return this.each(((child,i)=>{let result;try{result=callback(child,i)}catch(e){throw child.addToError(e)}return!1!==result&&child.walk&&(result=child.walk(callback)),result}))}walkAtRules(name,callback){return callback?name instanceof RegExp?this.walk(((child,i)=>{if("atrule"===child.type&&name.test(child.name))return callback(child,i)})):this.walk(((child,i)=>{if("atrule"===child.type&&child.name===name)return callback(child,i)})):(callback=name,this.walk(((child,i)=>{if("atrule"===child.type)return callback(child,i)})))}walkComments(callback){return this.walk(((child,i)=>{if("comment"===child.type)return callback(child,i)}))}walkDecls(prop,callback){return callback?prop instanceof RegExp?this.walk(((child,i)=>{if("decl"===child.type&&prop.test(child.prop))return callback(child,i)})):this.walk(((child,i)=>{if("decl"===child.type&&child.prop===prop)return callback(child,i)})):(callback=prop,this.walk(((child,i)=>{if("decl"===child.type)return callback(child,i)})))}walkRules(selector,callback){return callback?selector instanceof RegExp?this.walk(((child,i)=>{if("rule"===child.type&&selector.test(child.selector))return callback(child,i)})):this.walk(((child,i)=>{if("rule"===child.type&&child.selector===selector)return callback(child,i)})):(callback=selector,this.walk(((child,i)=>{if("rule"===child.type)return callback(child,i)})))}get first(){if(this.proxyOf.nodes)return this.proxyOf.nodes[0]}get last(){if(this.proxyOf.nodes)return this.proxyOf.nodes[this.proxyOf.nodes.length-1]}}Container.registerParse=dependant=>{parse=dependant},Container.registerRule=dependant=>{Rule=dependant},Container.registerAtRule=dependant=>{AtRule=dependant},Container.registerRoot=dependant=>{Root=dependant},module.exports=Container,Container.default=Container,Container.rebuild=node=>{"atrule"===node.type?Object.setPrototypeOf(node,AtRule.prototype):"rule"===node.type?Object.setPrototypeOf(node,Rule.prototype):"decl"===node.type?Object.setPrototypeOf(node,Declaration.prototype):"comment"===node.type?Object.setPrototypeOf(node,Comment.prototype):"root"===node.type&&Object.setPrototypeOf(node,Root.prototype),node[my]=!0,node.nodes&&node.nodes.forEach((child=>{Container.rebuild(child)}))}},"../../node_modules/sanitize-html/node_modules/postcss/lib/css-syntax-error.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let pico=__webpack_require__("../../node_modules/picocolors/picocolors.browser.js"),terminalHighlight=__webpack_require__("?cb21");class CssSyntaxError extends Error{constructor(message,line,column,source,file,plugin){super(message),this.name="CssSyntaxError",this.reason=message,file&&(this.file=file),source&&(this.source=source),plugin&&(this.plugin=plugin),void 0!==line&&void 0!==column&&("number"==typeof line?(this.line=line,this.column=column):(this.line=line.line,this.column=line.column,this.endLine=column.line,this.endColumn=column.column)),this.setMessage(),Error.captureStackTrace&&Error.captureStackTrace(this,CssSyntaxError)}setMessage(){this.message=this.plugin?this.plugin+": ":"",this.message+=this.file?this.file:"<css input>",void 0!==this.line&&(this.message+=":"+this.line+":"+this.column),this.message+=": "+this.reason}showSourceCode(color){if(!this.source)return"";let css=this.source;null==color&&(color=pico.isColorSupported),terminalHighlight&&color&&(css=terminalHighlight(css));let mark,aside,lines=css.split(/\r?\n/),start=Math.max(this.line-3,0),end=Math.min(this.line+2,lines.length),maxWidth=String(end).length;if(color){let{bold,gray,red}=pico.createColors(!0);mark=text=>bold(red(text)),aside=text=>gray(text)}else mark=aside=str=>str;return lines.slice(start,end).map(((line,index)=>{let number=start+1+index,gutter=" "+(" "+number).slice(-maxWidth)+" | ";if(number===this.line){let spacing=aside(gutter.replace(/\d/g," "))+line.slice(0,this.column-1).replace(/[^\t]/g," ");return mark(">")+aside(gutter)+line+"\n "+spacing+mark("^")}return" "+aside(gutter)+line})).join("\n")}toString(){let code=this.showSourceCode();return code&&(code="\n\n"+code+"\n"),this.name+": "+this.message+code}}module.exports=CssSyntaxError,CssSyntaxError.default=CssSyntaxError},"../../node_modules/sanitize-html/node_modules/postcss/lib/declaration.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Node=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/node.js");class Declaration extends Node{constructor(defaults){defaults&&void 0!==defaults.value&&"string"!=typeof defaults.value&&(defaults={...defaults,value:String(defaults.value)}),super(defaults),this.type="decl"}get variable(){return this.prop.startsWith("--")||"$"===this.prop[0]}}module.exports=Declaration,Declaration.default=Declaration},"../../node_modules/sanitize-html/node_modules/postcss/lib/document.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let LazyResult,Processor,Container=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/container.js");class Document extends Container{constructor(defaults){super({type:"document",...defaults}),this.nodes||(this.nodes=[])}toResult(opts={}){return new LazyResult(new Processor,this,opts).stringify()}}Document.registerLazyResult=dependant=>{LazyResult=dependant},Document.registerProcessor=dependant=>{Processor=dependant},module.exports=Document,Document.default=Document},"../../node_modules/sanitize-html/node_modules/postcss/lib/fromJSON.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Declaration=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/declaration.js"),PreviousMap=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/previous-map.js"),Comment=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/comment.js"),AtRule=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/at-rule.js"),Input=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/input.js"),Root=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/root.js"),Rule=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/rule.js");function fromJSON(json,inputs){if(Array.isArray(json))return json.map((n=>fromJSON(n)));let{inputs:ownInputs,...defaults}=json;if(ownInputs){inputs=[];for(let input of ownInputs){let inputHydrated={...input,__proto__:Input.prototype};inputHydrated.map&&(inputHydrated.map={...inputHydrated.map,__proto__:PreviousMap.prototype}),inputs.push(inputHydrated)}}if(defaults.nodes&&(defaults.nodes=json.nodes.map((n=>fromJSON(n,inputs)))),defaults.source){let{inputId,...source}=defaults.source;defaults.source=source,null!=inputId&&(defaults.source.input=inputs[inputId])}if("root"===defaults.type)return new Root(defaults);if("decl"===defaults.type)return new Declaration(defaults);if("rule"===defaults.type)return new Rule(defaults);if("comment"===defaults.type)return new Comment(defaults);if("atrule"===defaults.type)return new AtRule(defaults);throw new Error("Unknown node type: "+json.type)}module.exports=fromJSON,fromJSON.default=fromJSON},"../../node_modules/sanitize-html/node_modules/postcss/lib/input.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let{SourceMapConsumer,SourceMapGenerator}=__webpack_require__("?5f2b"),{fileURLToPath,pathToFileURL}=__webpack_require__("?5bf4"),{isAbsolute,resolve}=__webpack_require__("?5f82"),{nanoid}=__webpack_require__("../../node_modules/nanoid/non-secure/index.js"),terminalHighlight=__webpack_require__("?cb21"),CssSyntaxError=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/css-syntax-error.js"),PreviousMap=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/previous-map.js"),fromOffsetCache=Symbol("fromOffsetCache"),sourceMapAvailable=Boolean(SourceMapConsumer&&SourceMapGenerator),pathAvailable=Boolean(resolve&&isAbsolute);class Input{constructor(css,opts={}){if(null==css||"object"==typeof css&&!css.toString)throw new Error(`PostCSS received ${css} instead of CSS string`);if(this.css=css.toString(),"\ufeff"===this.css[0]||""===this.css[0]?(this.hasBOM=!0,this.css=this.css.slice(1)):this.hasBOM=!1,opts.from&&(!pathAvailable||/^\w+:\/\//.test(opts.from)||isAbsolute(opts.from)?this.file=opts.from:this.file=resolve(opts.from)),pathAvailable&&sourceMapAvailable){let map=new PreviousMap(this.css,opts);if(map.text){this.map=map;let file=map.consumer().file;!this.file&&file&&(this.file=this.mapResolve(file))}}this.file||(this.id="<input css "+nanoid(6)+">"),this.map&&(this.map.file=this.from)}error(message,line,column,opts={}){let result,endLine,endColumn;if(line&&"object"==typeof line){let start=line,end=column;if("number"==typeof start.offset){let pos=this.fromOffset(start.offset);line=pos.line,column=pos.col}else line=start.line,column=start.column;if("number"==typeof end.offset){let pos=this.fromOffset(end.offset);endLine=pos.line,endColumn=pos.col}else endLine=end.line,endColumn=end.column}else if(!column){let pos=this.fromOffset(line);line=pos.line,column=pos.col}let origin=this.origin(line,column,endLine,endColumn);return result=origin?new CssSyntaxError(message,void 0===origin.endLine?origin.line:{column:origin.column,line:origin.line},void 0===origin.endLine?origin.column:{column:origin.endColumn,line:origin.endLine},origin.source,origin.file,opts.plugin):new CssSyntaxError(message,void 0===endLine?line:{column,line},void 0===endLine?column:{column:endColumn,line:endLine},this.css,this.file,opts.plugin),result.input={column,endColumn,endLine,line,source:this.css},this.file&&(pathToFileURL&&(result.input.url=pathToFileURL(this.file).toString()),result.input.file=this.file),result}fromOffset(offset){let lastLine,lineToIndex;if(this[fromOffsetCache])lineToIndex=this[fromOffsetCache];else{let lines=this.css.split("\n");lineToIndex=new Array(lines.length);let prevIndex=0;for(let i=0,l=lines.length;i<l;i++)lineToIndex[i]=prevIndex,prevIndex+=lines[i].length+1;this[fromOffsetCache]=lineToIndex}lastLine=lineToIndex[lineToIndex.length-1];let min=0;if(offset>=lastLine)min=lineToIndex.length-1;else{let mid,max=lineToIndex.length-2;for(;min<max;)if(mid=min+(max-min>>1),offset<lineToIndex[mid])max=mid-1;else{if(!(offset>=lineToIndex[mid+1])){min=mid;break}min=mid+1}}return{col:offset-lineToIndex[min]+1,line:min+1}}mapResolve(file){return/^\w+:\/\//.test(file)?file:resolve(this.map.consumer().sourceRoot||this.map.root||".",file)}origin(line,column,endLine,endColumn){if(!this.map)return!1;let to,fromUrl,consumer=this.map.consumer(),from=consumer.originalPositionFor({column,line});if(!from.source)return!1;"number"==typeof endLine&&(to=consumer.originalPositionFor({column:endColumn,line:endLine})),fromUrl=isAbsolute(from.source)?pathToFileURL(from.source):new URL(from.source,this.map.consumer().sourceRoot||pathToFileURL(this.map.mapFile));let result={column:from.column,endColumn:to&&to.column,endLine:to&&to.line,line:from.line,url:fromUrl.toString()};if("file:"===fromUrl.protocol){if(!fileURLToPath)throw new Error("file: protocol is not available in this PostCSS build");result.file=fileURLToPath(fromUrl)}let source=consumer.sourceContentFor(from.source);return source&&(result.source=source),result}toJSON(){let json={};for(let name of["hasBOM","css","file","id"])null!=this[name]&&(json[name]=this[name]);return this.map&&(json.map={...this.map},json.map.consumerCache&&(json.map.consumerCache=void 0)),json}get from(){return this.file||this.id}}module.exports=Input,Input.default=Input,terminalHighlight&&terminalHighlight.registerInput&&terminalHighlight.registerInput(Input)},"../../node_modules/sanitize-html/node_modules/postcss/lib/lazy-result.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let{isClean,my}=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/symbols.js"),MapGenerator=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/map-generator.js"),stringify=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/stringify.js"),Container=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/container.js"),Document=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/document.js"),Result=(__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/warn-once.js"),__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/result.js")),parse=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/parse.js"),Root=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/root.js");const TYPE_TO_CLASS_NAME={atrule:"AtRule",comment:"Comment",decl:"Declaration",document:"Document",root:"Root",rule:"Rule"},PLUGIN_PROPS={AtRule:!0,AtRuleExit:!0,Comment:!0,CommentExit:!0,Declaration:!0,DeclarationExit:!0,Document:!0,DocumentExit:!0,Once:!0,OnceExit:!0,postcssPlugin:!0,prepare:!0,Root:!0,RootExit:!0,Rule:!0,RuleExit:!0},NOT_VISITORS={Once:!0,postcssPlugin:!0,prepare:!0},CHILDREN=0;function isPromise(obj){return"object"==typeof obj&&"function"==typeof obj.then}function getEvents(node){let key=!1,type=TYPE_TO_CLASS_NAME[node.type];return"decl"===node.type?key=node.prop.toLowerCase():"atrule"===node.type&&(key=node.name.toLowerCase()),key&&node.append?[type,type+"-"+key,CHILDREN,type+"Exit",type+"Exit-"+key]:key?[type,type+"-"+key,type+"Exit",type+"Exit-"+key]:node.append?[type,CHILDREN,type+"Exit"]:[type,type+"Exit"]}function toStack(node){let events;return events="document"===node.type?["Document",CHILDREN,"DocumentExit"]:"root"===node.type?["Root",CHILDREN,"RootExit"]:getEvents(node),{eventIndex:0,events,iterator:0,node,visitorIndex:0,visitors:[]}}function cleanMarks(node){return node[isClean]=!1,node.nodes&&node.nodes.forEach((i=>cleanMarks(i))),node}let postcss={};class LazyResult{constructor(processor,css,opts){let root;if(this.stringified=!1,this.processed=!1,"object"!=typeof css||null===css||"root"!==css.type&&"document"!==css.type)if(css instanceof LazyResult||css instanceof Result)root=cleanMarks(css.root),css.map&&(void 0===opts.map&&(opts.map={}),opts.map.inline||(opts.map.inline=!1),opts.map.prev=css.map);else{let parser=parse;opts.syntax&&(parser=opts.syntax.parse),opts.parser&&(parser=opts.parser),parser.parse&&(parser=parser.parse);try{root=parser(css,opts)}catch(error){this.processed=!0,this.error=error}root&&!root[my]&&Container.rebuild(root)}else root=cleanMarks(css);this.result=new Result(processor,root,opts),this.helpers={...postcss,postcss,result:this.result},this.plugins=this.processor.plugins.map((plugin=>"object"==typeof plugin&&plugin.prepare?{...plugin,...plugin.prepare(this.result)}:plugin))}async(){return this.error?Promise.reject(this.error):this.processed?Promise.resolve(this.result):(this.processing||(this.processing=this.runAsync()),this.processing)}catch(onRejected){return this.async().catch(onRejected)}finally(onFinally){return this.async().then(onFinally,onFinally)}getAsyncError(){throw new Error("Use process(css).then(cb) to work with async plugins")}handleError(error,node){let plugin=this.result.lastPlugin;try{node&&node.addToError(error),this.error=error,"CssSyntaxError"!==error.name||error.plugin?plugin.postcssVersion:(error.plugin=plugin.postcssPlugin,error.setMessage())}catch(err){console&&console.error&&console.error(err)}return error}prepareVisitors(){this.listeners={};let add=(plugin,type,cb)=>{this.listeners[type]||(this.listeners[type]=[]),this.listeners[type].push([plugin,cb])};for(let plugin of this.plugins)if("object"==typeof plugin)for(let event in plugin){if(!PLUGIN_PROPS[event]&&/^[A-Z]/.test(event))throw new Error(`Unknown event ${event} in ${plugin.postcssPlugin}. Try to update PostCSS (${this.processor.version} now).`);if(!NOT_VISITORS[event])if("object"==typeof plugin[event])for(let filter in plugin[event])add(plugin,"*"===filter?event:event+"-"+filter.toLowerCase(),plugin[event][filter]);else"function"==typeof plugin[event]&&add(plugin,event,plugin[event])}this.hasListener=Object.keys(this.listeners).length>0}async runAsync(){this.plugin=0;for(let i=0;i<this.plugins.length;i++){let plugin=this.plugins[i],promise=this.runOnRoot(plugin);if(isPromise(promise))try{await promise}catch(error){throw this.handleError(error)}}if(this.prepareVisitors(),this.hasListener){let root=this.result.root;for(;!root[isClean];){root[isClean]=!0;let stack=[toStack(root)];for(;stack.length>0;){let promise=this.visitTick(stack);if(isPromise(promise))try{await promise}catch(e){let node=stack[stack.length-1].node;throw this.handleError(e,node)}}}if(this.listeners.OnceExit)for(let[plugin,visitor]of this.listeners.OnceExit){this.result.lastPlugin=plugin;try{if("document"===root.type){let roots=root.nodes.map((subRoot=>visitor(subRoot,this.helpers)));await Promise.all(roots)}else await visitor(root,this.helpers)}catch(e){throw this.handleError(e)}}}return this.processed=!0,this.stringify()}runOnRoot(plugin){this.result.lastPlugin=plugin;try{if("object"==typeof plugin&&plugin.Once){if("document"===this.result.root.type){let roots=this.result.root.nodes.map((root=>plugin.Once(root,this.helpers)));return isPromise(roots[0])?Promise.all(roots):roots}return plugin.Once(this.result.root,this.helpers)}if("function"==typeof plugin)return plugin(this.result.root,this.result)}catch(error){throw this.handleError(error)}}stringify(){if(this.error)throw this.error;if(this.stringified)return this.result;this.stringified=!0,this.sync();let opts=this.result.opts,str=stringify;opts.syntax&&(str=opts.syntax.stringify),opts.stringifier&&(str=opts.stringifier),str.stringify&&(str=str.stringify);let data=new MapGenerator(str,this.result.root,this.result.opts).generate();return this.result.css=data[0],this.result.map=data[1],this.result}sync(){if(this.error)throw this.error;if(this.processed)return this.result;if(this.processed=!0,this.processing)throw this.getAsyncError();for(let plugin of this.plugins){if(isPromise(this.runOnRoot(plugin)))throw this.getAsyncError()}if(this.prepareVisitors(),this.hasListener){let root=this.result.root;for(;!root[isClean];)root[isClean]=!0,this.walkSync(root);if(this.listeners.OnceExit)if("document"===root.type)for(let subRoot of root.nodes)this.visitSync(this.listeners.OnceExit,subRoot);else this.visitSync(this.listeners.OnceExit,root)}return this.result}then(onFulfilled,onRejected){return this.async().then(onFulfilled,onRejected)}toString(){return this.css}visitSync(visitors,node){for(let[plugin,visitor]of visitors){let promise;this.result.lastPlugin=plugin;try{promise=visitor(node,this.helpers)}catch(e){throw this.handleError(e,node.proxyOf)}if("root"!==node.type&&"document"!==node.type&&!node.parent)return!0;if(isPromise(promise))throw this.getAsyncError()}}visitTick(stack){let visit=stack[stack.length-1],{node,visitors}=visit;if("root"!==node.type&&"document"!==node.type&&!node.parent)return void stack.pop();if(visitors.length>0&&visit.visitorIndex<visitors.length){let[plugin,visitor]=visitors[visit.visitorIndex];visit.visitorIndex+=1,visit.visitorIndex===visitors.length&&(visit.visitors=[],visit.visitorIndex=0),this.result.lastPlugin=plugin;try{return visitor(node.toProxy(),this.helpers)}catch(e){throw this.handleError(e,node)}}if(0!==visit.iterator){let child,iterator=visit.iterator;for(;child=node.nodes[node.indexes[iterator]];)if(node.indexes[iterator]+=1,!child[isClean])return child[isClean]=!0,void stack.push(toStack(child));visit.iterator=0,delete node.indexes[iterator]}let events=visit.events;for(;visit.eventIndex<events.length;){let event=events[visit.eventIndex];if(visit.eventIndex+=1,event===CHILDREN)return void(node.nodes&&node.nodes.length&&(node[isClean]=!0,visit.iterator=node.getIterator()));if(this.listeners[event])return void(visit.visitors=this.listeners[event])}stack.pop()}walkSync(node){node[isClean]=!0;let events=getEvents(node);for(let event of events)if(event===CHILDREN)node.nodes&&node.each((child=>{child[isClean]||this.walkSync(child)}));else{let visitors=this.listeners[event];if(visitors&&this.visitSync(visitors,node.toProxy()))return}}warnings(){return this.sync().warnings()}get content(){return this.stringify().content}get css(){return this.stringify().css}get map(){return this.stringify().map}get messages(){return this.sync().messages}get opts(){return this.result.opts}get processor(){return this.result.processor}get root(){return this.sync().root}get[Symbol.toStringTag](){return"LazyResult"}}LazyResult.registerPostcss=dependant=>{postcss=dependant},module.exports=LazyResult,LazyResult.default=LazyResult,Root.registerLazyResult(LazyResult),Document.registerLazyResult(LazyResult)},"../../node_modules/sanitize-html/node_modules/postcss/lib/list.js":module=>{"use strict";let list={comma:string=>list.split(string,[","],!0),space:string=>list.split(string,[" ","\n","\t"]),split(string,separators,last){let array=[],current="",split=!1,func=0,inQuote=!1,prevQuote="",escape=!1;for(let letter of string)escape?escape=!1:"\\"===letter?escape=!0:inQuote?letter===prevQuote&&(inQuote=!1):'"'===letter||"'"===letter?(inQuote=!0,prevQuote=letter):"("===letter?func+=1:")"===letter?func>0&&(func-=1):0===func&&separators.includes(letter)&&(split=!0),split?(""!==current&&array.push(current.trim()),current="",split=!1):current+=letter;return(last||""!==current)&&array.push(current.trim()),array}};module.exports=list,list.default=list},"../../node_modules/sanitize-html/node_modules/postcss/lib/map-generator.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let{SourceMapConsumer,SourceMapGenerator}=__webpack_require__("?5f2b"),{dirname,relative,resolve,sep}=__webpack_require__("?5f82"),{pathToFileURL}=__webpack_require__("?5bf4"),Input=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/input.js"),sourceMapAvailable=Boolean(SourceMapConsumer&&SourceMapGenerator),pathAvailable=Boolean(dirname&&resolve&&relative&&sep);module.exports=class MapGenerator{constructor(stringify,root,opts,cssString){this.stringify=stringify,this.mapOpts=opts.map||{},this.root=root,this.opts=opts,this.css=cssString,this.originalCSS=cssString,this.usesFileUrls=!this.mapOpts.from&&this.mapOpts.absolute,this.memoizedFileURLs=new Map,this.memoizedPaths=new Map,this.memoizedURLs=new Map}addAnnotation(){let content;content=this.isInline()?"data:application/json;base64,"+this.toBase64(this.map.toString()):"string"==typeof this.mapOpts.annotation?this.mapOpts.annotation:"function"==typeof this.mapOpts.annotation?this.mapOpts.annotation(this.opts.to,this.root):this.outputFile()+".map";let eol="\n";this.css.includes("\r\n")&&(eol="\r\n"),this.css+=eol+"/*# sourceMappingURL="+content+" */"}applyPrevMaps(){for(let prev of this.previous()){let map,from=this.toUrl(this.path(prev.file)),root=prev.root||dirname(prev.file);!1===this.mapOpts.sourcesContent?(map=new SourceMapConsumer(prev.text),map.sourcesContent&&(map.sourcesContent=map.sourcesContent.map((()=>null)))):map=prev.consumer(),this.map.applySourceMap(map,from,this.toUrl(this.path(root)))}}clearAnnotation(){if(!1!==this.mapOpts.annotation)if(this.root){let node;for(let i=this.root.nodes.length-1;i>=0;i--)node=this.root.nodes[i],"comment"===node.type&&0===node.text.indexOf("# sourceMappingURL=")&&this.root.removeChild(i)}else this.css&&(this.css=this.css.replace(/\n*?\/\*#[\S\s]*?\*\/$/gm,""))}generate(){if(this.clearAnnotation(),pathAvailable&&sourceMapAvailable&&this.isMap())return this.generateMap();{let result="";return this.stringify(this.root,(i=>{result+=i})),[result]}}generateMap(){if(this.root)this.generateString();else if(1===this.previous().length){let prev=this.previous()[0].consumer();prev.file=this.outputFile(),this.map=SourceMapGenerator.fromSourceMap(prev)}else this.map=new SourceMapGenerator({file:this.outputFile()}),this.map.addMapping({generated:{column:0,line:1},original:{column:0,line:1},source:this.opts.from?this.toUrl(this.path(this.opts.from)):"<no source>"});return this.isSourcesContent()&&this.setSourcesContent(),this.root&&this.previous().length>0&&this.applyPrevMaps(),this.isAnnotation()&&this.addAnnotation(),this.isInline()?[this.css]:[this.css,this.map]}generateString(){this.css="",this.map=new SourceMapGenerator({file:this.outputFile()});let lines,last,line=1,column=1,mapping={generated:{column:0,line:0},original:{column:0,line:0},source:""};this.stringify(this.root,((str,node,type)=>{if(this.css+=str,node&&"end"!==type&&(mapping.generated.line=line,mapping.generated.column=column-1,node.source&&node.source.start?(mapping.source=this.sourcePath(node),mapping.original.line=node.source.start.line,mapping.original.column=node.source.start.column-1,this.map.addMapping(mapping)):(mapping.source="<no source>",mapping.original.line=1,mapping.original.column=0,this.map.addMapping(mapping))),lines=str.match(/\n/g),lines?(line+=lines.length,last=str.lastIndexOf("\n"),column=str.length-last):column+=str.length,node&&"start"!==type){let p=node.parent||{raws:{}};("decl"===node.type||"atrule"===node.type&&!node.nodes)&&node===p.last&&!p.raws.semicolon||(node.source&&node.source.end?(mapping.source=this.sourcePath(node),mapping.original.line=node.source.end.line,mapping.original.column=node.source.end.column-1,mapping.generated.line=line,mapping.generated.column=column-2,this.map.addMapping(mapping)):(mapping.source="<no source>",mapping.original.line=1,mapping.original.column=0,mapping.generated.line=line,mapping.generated.column=column-1,this.map.addMapping(mapping)))}}))}isAnnotation(){return!!this.isInline()||(void 0!==this.mapOpts.annotation?this.mapOpts.annotation:!this.previous().length||this.previous().some((i=>i.annotation)))}isInline(){if(void 0!==this.mapOpts.inline)return this.mapOpts.inline;let annotation=this.mapOpts.annotation;return(void 0===annotation||!0===annotation)&&(!this.previous().length||this.previous().some((i=>i.inline)))}isMap(){return void 0!==this.opts.map?!!this.opts.map:this.previous().length>0}isSourcesContent(){return void 0!==this.mapOpts.sourcesContent?this.mapOpts.sourcesContent:!this.previous().length||this.previous().some((i=>i.withContent()))}outputFile(){return this.opts.to?this.path(this.opts.to):this.opts.from?this.path(this.opts.from):"to.css"}path(file){if(this.mapOpts.absolute)return file;if(60===file.charCodeAt(0))return file;if(/^\w+:\/\//.test(file))return file;let cached=this.memoizedPaths.get(file);if(cached)return cached;let from=this.opts.to?dirname(this.opts.to):".";"string"==typeof this.mapOpts.annotation&&(from=dirname(resolve(from,this.mapOpts.annotation)));let path=relative(from,file);return this.memoizedPaths.set(file,path),path}previous(){if(!this.previousMaps)if(this.previousMaps=[],this.root)this.root.walk((node=>{if(node.source&&node.source.input.map){let map=node.source.input.map;this.previousMaps.includes(map)||this.previousMaps.push(map)}}));else{let input=new Input(this.originalCSS,this.opts);input.map&&this.previousMaps.push(input.map)}return this.previousMaps}setSourcesContent(){let already={};if(this.root)this.root.walk((node=>{if(node.source){let from=node.source.input.from;if(from&&!already[from]){already[from]=!0;let fromUrl=this.usesFileUrls?this.toFileUrl(from):this.toUrl(this.path(from));this.map.setSourceContent(fromUrl,node.source.input.css)}}}));else if(this.css){let from=this.opts.from?this.toUrl(this.path(this.opts.from)):"<no source>";this.map.setSourceContent(from,this.css)}}sourcePath(node){return this.mapOpts.from?this.toUrl(this.mapOpts.from):this.usesFileUrls?this.toFileUrl(node.source.input.from):this.toUrl(this.path(node.source.input.from))}toBase64(str){return Buffer?Buffer.from(str).toString("base64"):window.btoa(unescape(encodeURIComponent(str)))}toFileUrl(path){let cached=this.memoizedFileURLs.get(path);if(cached)return cached;if(pathToFileURL){let fileURL=pathToFileURL(path).toString();return this.memoizedFileURLs.set(path,fileURL),fileURL}throw new Error("`map.absolute` option is not available in this PostCSS build")}toUrl(path){let cached=this.memoizedURLs.get(path);if(cached)return cached;"\\"===sep&&(path=path.replace(/\\/g,"/"));let url=encodeURI(path).replace(/[#?]/g,encodeURIComponent);return this.memoizedURLs.set(path,url),url}}},"../../node_modules/sanitize-html/node_modules/postcss/lib/no-work-result.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let MapGenerator=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/map-generator.js"),stringify=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/stringify.js"),parse=(__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/warn-once.js"),__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/parse.js"));const Result=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/result.js");class NoWorkResult{constructor(processor,css,opts){css=css.toString(),this.stringified=!1,this._processor=processor,this._css=css,this._opts=opts,this._map=void 0;let str=stringify;this.result=new Result(this._processor,undefined,this._opts),this.result.css=css;let self=this;Object.defineProperty(this.result,"root",{get:()=>self.root});let map=new MapGenerator(str,undefined,this._opts,css);if(map.isMap()){let[generatedCSS,generatedMap]=map.generate();generatedCSS&&(this.result.css=generatedCSS),generatedMap&&(this.result.map=generatedMap)}else map.clearAnnotation(),this.result.css=map.css}async(){return this.error?Promise.reject(this.error):Promise.resolve(this.result)}catch(onRejected){return this.async().catch(onRejected)}finally(onFinally){return this.async().then(onFinally,onFinally)}sync(){if(this.error)throw this.error;return this.result}then(onFulfilled,onRejected){return this.async().then(onFulfilled,onRejected)}toString(){return this._css}warnings(){return[]}get content(){return this.result.css}get css(){return this.result.css}get map(){return this.result.map}get messages(){return[]}get opts(){return this.result.opts}get processor(){return this.result.processor}get root(){if(this._root)return this._root;let root,parser=parse;try{root=parser(this._css,this._opts)}catch(error){this.error=error}if(this.error)throw this.error;return this._root=root,root}get[Symbol.toStringTag](){return"NoWorkResult"}}module.exports=NoWorkResult,NoWorkResult.default=NoWorkResult},"../../node_modules/sanitize-html/node_modules/postcss/lib/node.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let{isClean,my}=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/symbols.js"),CssSyntaxError=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/css-syntax-error.js"),Stringifier=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/stringifier.js"),stringify=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/stringify.js");function cloneNode(obj,parent){let cloned=new obj.constructor;for(let i in obj){if(!Object.prototype.hasOwnProperty.call(obj,i))continue;if("proxyCache"===i)continue;let value=obj[i],type=typeof value;"parent"===i&&"object"===type?parent&&(cloned[i]=parent):"source"===i?cloned[i]=value:Array.isArray(value)?cloned[i]=value.map((j=>cloneNode(j,cloned))):("object"===type&&null!==value&&(value=cloneNode(value)),cloned[i]=value)}return cloned}class Node{constructor(defaults={}){this.raws={},this[isClean]=!1,this[my]=!0;for(let name in defaults)if("nodes"===name){this.nodes=[];for(let node of defaults[name])"function"==typeof node.clone?this.append(node.clone()):this.append(node)}else this[name]=defaults[name]}addToError(error){if(error.postcssNode=this,error.stack&&this.source&&/\n\s{4}at /.test(error.stack)){let s=this.source;error.stack=error.stack.replace(/\n\s{4}at /,`$&${s.input.from}:${s.start.line}:${s.start.column}$&`)}return error}after(add){return this.parent.insertAfter(this,add),this}assign(overrides={}){for(let name in overrides)this[name]=overrides[name];return this}before(add){return this.parent.insertBefore(this,add),this}cleanRaws(keepBetween){delete this.raws.before,delete this.raws.after,keepBetween||delete this.raws.between}clone(overrides={}){let cloned=cloneNode(this);for(let name in overrides)cloned[name]=overrides[name];return cloned}cloneAfter(overrides={}){let cloned=this.clone(overrides);return this.parent.insertAfter(this,cloned),cloned}cloneBefore(overrides={}){let cloned=this.clone(overrides);return this.parent.insertBefore(this,cloned),cloned}error(message,opts={}){if(this.source){let{end,start}=this.rangeBy(opts);return this.source.input.error(message,{column:start.column,line:start.line},{column:end.column,line:end.line},opts)}return new CssSyntaxError(message)}getProxyProcessor(){return{get:(node,prop)=>"proxyOf"===prop?node:"root"===prop?()=>node.root().toProxy():node[prop],set:(node,prop,value)=>(node[prop]===value||(node[prop]=value,"prop"!==prop&&"value"!==prop&&"name"!==prop&&"params"!==prop&&"important"!==prop&&"text"!==prop||node.markDirty()),!0)}}markDirty(){if(this[isClean]){this[isClean]=!1;let next=this;for(;next=next.parent;)next[isClean]=!1}}next(){if(!this.parent)return;let index=this.parent.index(this);return this.parent.nodes[index+1]}positionBy(opts,stringRepresentation){let pos=this.source.start;if(opts.index)pos=this.positionInside(opts.index,stringRepresentation);else if(opts.word){let index=(stringRepresentation=this.toString()).indexOf(opts.word);-1!==index&&(pos=this.positionInside(index,stringRepresentation))}return pos}positionInside(index,stringRepresentation){let string=stringRepresentation||this.toString(),column=this.source.start.column,line=this.source.start.line;for(let i=0;i<index;i++)"\n"===string[i]?(column=1,line+=1):column+=1;return{column,line}}prev(){if(!this.parent)return;let index=this.parent.index(this);return this.parent.nodes[index-1]}rangeBy(opts){let start={column:this.source.start.column,line:this.source.start.line},end=this.source.end?{column:this.source.end.column+1,line:this.source.end.line}:{column:start.column+1,line:start.line};if(opts.word){let stringRepresentation=this.toString(),index=stringRepresentation.indexOf(opts.word);-1!==index&&(start=this.positionInside(index,stringRepresentation),end=this.positionInside(index+opts.word.length,stringRepresentation))}else opts.start?start={column:opts.start.column,line:opts.start.line}:opts.index&&(start=this.positionInside(opts.index)),opts.end?end={column:opts.end.column,line:opts.end.line}:opts.endIndex?end=this.positionInside(opts.endIndex):opts.index&&(end=this.positionInside(opts.index+1));return(end.line<start.line||end.line===start.line&&end.column<=start.column)&&(end={column:start.column+1,line:start.line}),{end,start}}raw(prop,defaultType){return(new Stringifier).raw(this,prop,defaultType)}remove(){return this.parent&&this.parent.removeChild(this),this.parent=void 0,this}replaceWith(...nodes){if(this.parent){let bookmark=this,foundSelf=!1;for(let node of nodes)node===this?foundSelf=!0:foundSelf?(this.parent.insertAfter(bookmark,node),bookmark=node):this.parent.insertBefore(bookmark,node);foundSelf||this.remove()}return this}root(){let result=this;for(;result.parent&&"document"!==result.parent.type;)result=result.parent;return result}toJSON(_,inputs){let fixed={},emitInputs=null==inputs;inputs=inputs||new Map;let inputsNextIndex=0;for(let name in this){if(!Object.prototype.hasOwnProperty.call(this,name))continue;if("parent"===name||"proxyCache"===name)continue;let value=this[name];if(Array.isArray(value))fixed[name]=value.map((i=>"object"==typeof i&&i.toJSON?i.toJSON(null,inputs):i));else if("object"==typeof value&&value.toJSON)fixed[name]=value.toJSON(null,inputs);else if("source"===name){let inputId=inputs.get(value.input);null==inputId&&(inputId=inputsNextIndex,inputs.set(value.input,inputsNextIndex),inputsNextIndex++),fixed[name]={end:value.end,inputId,start:value.start}}else fixed[name]=value}return emitInputs&&(fixed.inputs=[...inputs.keys()].map((input=>input.toJSON()))),fixed}toProxy(){return this.proxyCache||(this.proxyCache=new Proxy(this,this.getProxyProcessor())),this.proxyCache}toString(stringifier=stringify){stringifier.stringify&&(stringifier=stringifier.stringify);let result="";return stringifier(this,(i=>{result+=i})),result}warn(result,text,opts){let data={node:this};for(let i in opts)data[i]=opts[i];return result.warn(text,data)}get proxyOf(){return this}}module.exports=Node,Node.default=Node},"../../node_modules/sanitize-html/node_modules/postcss/lib/parse.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Container=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/container.js"),Parser=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/parser.js"),Input=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/input.js");function parse(css,opts){let input=new Input(css,opts),parser=new Parser(input);try{parser.parse()}catch(e){throw e}return parser.root}module.exports=parse,parse.default=parse,Container.registerParse(parse)},"../../node_modules/sanitize-html/node_modules/postcss/lib/parser.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Declaration=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/declaration.js"),tokenizer=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/tokenize.js"),Comment=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/comment.js"),AtRule=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/at-rule.js"),Root=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/root.js"),Rule=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/rule.js");const SAFE_COMMENT_NEIGHBOR={empty:!0,space:!0};module.exports=class Parser{constructor(input){this.input=input,this.root=new Root,this.current=this.root,this.spaces="",this.semicolon=!1,this.customProperty=!1,this.createTokenizer(),this.root.source={input,start:{column:1,line:1,offset:0}}}atrule(token){let type,prev,shift,node=new AtRule;node.name=token[1].slice(1),""===node.name&&this.unnamedAtrule(node,token),this.init(node,token[2]);let last=!1,open=!1,params=[],brackets=[];for(;!this.tokenizer.endOfFile();){if(type=(token=this.tokenizer.nextToken())[0],"("===type||"["===type?brackets.push("("===type?")":"]"):"{"===type&&brackets.length>0?brackets.push("}"):type===brackets[brackets.length-1]&&brackets.pop(),0===brackets.length){if(";"===type){node.source.end=this.getPosition(token[2]),node.source.end.offset++,this.semicolon=!0;break}if("{"===type){open=!0;break}if("}"===type){if(params.length>0){for(shift=params.length-1,prev=params[shift];prev&&"space"===prev[0];)prev=params[--shift];prev&&(node.source.end=this.getPosition(prev[3]||prev[2]),node.source.end.offset++)}this.end(token);break}params.push(token)}else params.push(token);if(this.tokenizer.endOfFile()){last=!0;break}}node.raws.between=this.spacesAndCommentsFromEnd(params),params.length?(node.raws.afterName=this.spacesAndCommentsFromStart(params),this.raw(node,"params",params),last&&(token=params[params.length-1],node.source.end=this.getPosition(token[3]||token[2]),node.source.end.offset++,this.spaces=node.raws.between,node.raws.between="")):(node.raws.afterName="",node.params=""),open&&(node.nodes=[],this.current=node)}checkMissedSemicolon(tokens){let colon=this.colon(tokens);if(!1===colon)return;let token,founded=0;for(let j=colon-1;j>=0&&(token=tokens[j],"space"===token[0]||(founded+=1,2!==founded));j--);throw this.input.error("Missed semicolon","word"===token[0]?token[3]+1:token[2])}colon(tokens){let token,type,prev,brackets=0;for(let[i,element]of tokens.entries()){if(token=element,type=token[0],"("===type&&(brackets+=1),")"===type&&(brackets-=1),0===brackets&&":"===type){if(prev){if("word"===prev[0]&&"progid"===prev[1])continue;return i}this.doubleColon(token)}prev=token}return!1}comment(token){let node=new Comment;this.init(node,token[2]),node.source.end=this.getPosition(token[3]||token[2]),node.source.end.offset++;let text=token[1].slice(2,-2);if(/^\s*$/.test(text))node.text="",node.raws.left=text,node.raws.right="";else{let match=text.match(/^(\s*)([^]*\S)(\s*)$/);node.text=match[2],node.raws.left=match[1],node.raws.right=match[3]}}createTokenizer(){this.tokenizer=tokenizer(this.input)}decl(tokens,customProperty){let node=new Declaration;this.init(node,tokens[0][2]);let token,last=tokens[tokens.length-1];for(";"===last[0]&&(this.semicolon=!0,tokens.pop()),node.source.end=this.getPosition(last[3]||last[2]||function findLastWithPosition(tokens){for(let i=tokens.length-1;i>=0;i--){let token=tokens[i],pos=token[3]||token[2];if(pos)return pos}}(tokens)),node.source.end.offset++;"word"!==tokens[0][0];)1===tokens.length&&this.unknownWord(tokens),node.raws.before+=tokens.shift()[1];for(node.source.start=this.getPosition(tokens[0][2]),node.prop="";tokens.length;){let type=tokens[0][0];if(":"===type||"space"===type||"comment"===type)break;node.prop+=tokens.shift()[1]}for(node.raws.between="";tokens.length;){if(token=tokens.shift(),":"===token[0]){node.raws.between+=token[1];break}"word"===token[0]&&/\w/.test(token[1])&&this.unknownWord([token]),node.raws.between+=token[1]}"_"!==node.prop[0]&&"*"!==node.prop[0]||(node.raws.before+=node.prop[0],node.prop=node.prop.slice(1));let next,firstSpaces=[];for(;tokens.length&&(next=tokens[0][0],"space"===next||"comment"===next);)firstSpaces.push(tokens.shift());this.precheckMissedSemicolon(tokens);for(let i=tokens.length-1;i>=0;i--){if(token=tokens[i],"!important"===token[1].toLowerCase()){node.important=!0;let string=this.stringFrom(tokens,i);string=this.spacesFromEnd(tokens)+string," !important"!==string&&(node.raws.important=string);break}if("important"===token[1].toLowerCase()){let cache=tokens.slice(0),str="";for(let j=i;j>0;j--){let type=cache[j][0];if(0===str.trim().indexOf("!")&&"space"!==type)break;str=cache.pop()[1]+str}0===str.trim().indexOf("!")&&(node.important=!0,node.raws.important=str,tokens=cache)}if("space"!==token[0]&&"comment"!==token[0])break}tokens.some((i=>"space"!==i[0]&&"comment"!==i[0]))&&(node.raws.between+=firstSpaces.map((i=>i[1])).join(""),firstSpaces=[]),this.raw(node,"value",firstSpaces.concat(tokens),customProperty),node.value.includes(":")&&!customProperty&&this.checkMissedSemicolon(tokens)}doubleColon(token){throw this.input.error("Double colon",{offset:token[2]},{offset:token[2]+token[1].length})}emptyRule(token){let node=new Rule;this.init(node,token[2]),node.selector="",node.raws.between="",this.current=node}end(token){this.current.nodes&&this.current.nodes.length&&(this.current.raws.semicolon=this.semicolon),this.semicolon=!1,this.current.raws.after=(this.current.raws.after||"")+this.spaces,this.spaces="",this.current.parent?(this.current.source.end=this.getPosition(token[2]),this.current.source.end.offset++,this.current=this.current.parent):this.unexpectedClose(token)}endFile(){this.current.parent&&this.unclosedBlock(),this.current.nodes&&this.current.nodes.length&&(this.current.raws.semicolon=this.semicolon),this.current.raws.after=(this.current.raws.after||"")+this.spaces,this.root.source.end=this.getPosition(this.tokenizer.position())}freeSemicolon(token){if(this.spaces+=token[1],this.current.nodes){let prev=this.current.nodes[this.current.nodes.length-1];prev&&"rule"===prev.type&&!prev.raws.ownSemicolon&&(prev.raws.ownSemicolon=this.spaces,this.spaces="")}}getPosition(offset){let pos=this.input.fromOffset(offset);return{column:pos.col,line:pos.line,offset}}init(node,offset){this.current.push(node),node.source={input:this.input,start:this.getPosition(offset)},node.raws.before=this.spaces,this.spaces="","comment"!==node.type&&(this.semicolon=!1)}other(start){let end=!1,type=null,colon=!1,bracket=null,brackets=[],customProperty=start[1].startsWith("--"),tokens=[],token=start;for(;token;){if(type=token[0],tokens.push(token),"("===type||"["===type)bracket||(bracket=token),brackets.push("("===type?")":"]");else if(customProperty&&colon&&"{"===type)bracket||(bracket=token),brackets.push("}");else if(0===brackets.length){if(";"===type){if(colon)return void this.decl(tokens,customProperty);break}if("{"===type)return void this.rule(tokens);if("}"===type){this.tokenizer.back(tokens.pop()),end=!0;break}":"===type&&(colon=!0)}else type===brackets[brackets.length-1]&&(brackets.pop(),0===brackets.length&&(bracket=null));token=this.tokenizer.nextToken()}if(this.tokenizer.endOfFile()&&(end=!0),brackets.length>0&&this.unclosedBracket(bracket),end&&colon){if(!customProperty)for(;tokens.length&&(token=tokens[tokens.length-1][0],"space"===token||"comment"===token);)this.tokenizer.back(tokens.pop());this.decl(tokens,customProperty)}else this.unknownWord(tokens)}parse(){let token;for(;!this.tokenizer.endOfFile();)switch(token=this.tokenizer.nextToken(),token[0]){case"space":this.spaces+=token[1];break;case";":this.freeSemicolon(token);break;case"}":this.end(token);break;case"comment":this.comment(token);break;case"at-word":this.atrule(token);break;case"{":this.emptyRule(token);break;default:this.other(token)}this.endFile()}precheckMissedSemicolon(){}raw(node,prop,tokens,customProperty){let token,type,next,prev,length=tokens.length,value="",clean=!0;for(let i=0;i<length;i+=1)token=tokens[i],type=token[0],"space"!==type||i!==length-1||customProperty?"comment"===type?(prev=tokens[i-1]?tokens[i-1][0]:"empty",next=tokens[i+1]?tokens[i+1][0]:"empty",SAFE_COMMENT_NEIGHBOR[prev]||SAFE_COMMENT_NEIGHBOR[next]||","===value.slice(-1)?clean=!1:value+=token[1]):value+=token[1]:clean=!1;if(!clean){let raw=tokens.reduce(((all,i)=>all+i[1]),"");node.raws[prop]={raw,value}}node[prop]=value}rule(tokens){tokens.pop();let node=new Rule;this.init(node,tokens[0][2]),node.raws.between=this.spacesAndCommentsFromEnd(tokens),this.raw(node,"selector",tokens),this.current=node}spacesAndCommentsFromEnd(tokens){let lastTokenType,spaces="";for(;tokens.length&&(lastTokenType=tokens[tokens.length-1][0],"space"===lastTokenType||"comment"===lastTokenType);)spaces=tokens.pop()[1]+spaces;return spaces}spacesAndCommentsFromStart(tokens){let next,spaces="";for(;tokens.length&&(next=tokens[0][0],"space"===next||"comment"===next);)spaces+=tokens.shift()[1];return spaces}spacesFromEnd(tokens){let lastTokenType,spaces="";for(;tokens.length&&(lastTokenType=tokens[tokens.length-1][0],"space"===lastTokenType);)spaces=tokens.pop()[1]+spaces;return spaces}stringFrom(tokens,from){let result="";for(let i=from;i<tokens.length;i++)result+=tokens[i][1];return tokens.splice(from,tokens.length-from),result}unclosedBlock(){let pos=this.current.source.start;throw this.input.error("Unclosed block",pos.line,pos.column)}unclosedBracket(bracket){throw this.input.error("Unclosed bracket",{offset:bracket[2]},{offset:bracket[2]+1})}unexpectedClose(token){throw this.input.error("Unexpected }",{offset:token[2]},{offset:token[2]+1})}unknownWord(tokens){throw this.input.error("Unknown word",{offset:tokens[0][2]},{offset:tokens[0][2]+tokens[0][1].length})}unnamedAtrule(node,token){throw this.input.error("At-rule without name",{offset:token[2]},{offset:token[2]+token[1].length})}}},"../../node_modules/sanitize-html/node_modules/postcss/lib/postcss.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";var process=__webpack_require__("../../node_modules/process/browser.js");let CssSyntaxError=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/css-syntax-error.js"),Declaration=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/declaration.js"),LazyResult=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/lazy-result.js"),Container=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/container.js"),Processor=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/processor.js"),stringify=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/stringify.js"),fromJSON=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/fromJSON.js"),Document=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/document.js"),Warning=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/warning.js"),Comment=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/comment.js"),AtRule=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/at-rule.js"),Result=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/result.js"),Input=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/input.js"),parse=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/parse.js"),list=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/list.js"),Rule=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/rule.js"),Root=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/root.js"),Node=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/node.js");function postcss(...plugins){return 1===plugins.length&&Array.isArray(plugins[0])&&(plugins=plugins[0]),new Processor(plugins)}postcss.plugin=function plugin(name,initializer){let cache,warningPrinted=!1;function creator(...args){console&&console.warn&&!warningPrinted&&(warningPrinted=!0,console.warn(name+": postcss.plugin was deprecated. Migration guide:\nhttps://evilmartians.com/chronicles/postcss-8-plugin-migration"),process.env.LANG&&process.env.LANG.startsWith("cn")&&console.warn(name+":  postcss.plugin . :\nhttps://www.w3ctech.com/topic/2226"));let transformer=initializer(...args);return transformer.postcssPlugin=name,transformer.postcssVersion=(new Processor).version,transformer}return Object.defineProperty(creator,"postcss",{get:()=>(cache||(cache=creator()),cache)}),creator.process=function(css,processOpts,pluginOpts){return postcss([creator(pluginOpts)]).process(css,processOpts)},creator},postcss.stringify=stringify,postcss.parse=parse,postcss.fromJSON=fromJSON,postcss.list=list,postcss.comment=defaults=>new Comment(defaults),postcss.atRule=defaults=>new AtRule(defaults),postcss.decl=defaults=>new Declaration(defaults),postcss.rule=defaults=>new Rule(defaults),postcss.root=defaults=>new Root(defaults),postcss.document=defaults=>new Document(defaults),postcss.CssSyntaxError=CssSyntaxError,postcss.Declaration=Declaration,postcss.Container=Container,postcss.Processor=Processor,postcss.Document=Document,postcss.Comment=Comment,postcss.Warning=Warning,postcss.AtRule=AtRule,postcss.Result=Result,postcss.Input=Input,postcss.Rule=Rule,postcss.Root=Root,postcss.Node=Node,LazyResult.registerPostcss(postcss),module.exports=postcss,postcss.default=postcss},"../../node_modules/sanitize-html/node_modules/postcss/lib/postcss.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{AtRule:()=>AtRule,Comment:()=>Comment,Container:()=>Container,CssSyntaxError:()=>CssSyntaxError,Declaration:()=>Declaration,Document:()=>Document,Input:()=>Input,Node:()=>Node,Processor:()=>Processor,Result:()=>Result,Root:()=>Root,Rule:()=>Rule,Warning:()=>Warning,atRule:()=>atRule,comment:()=>comment,decl:()=>decl,default:()=>__WEBPACK_DEFAULT_EXPORT__,document:()=>document,fromJSON:()=>fromJSON,list:()=>list,parse:()=>parse,plugin:()=>plugin,root:()=>root,rule:()=>rule,stringify:()=>stringify});var _postcss_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/postcss.js"),_postcss_js__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_postcss_js__WEBPACK_IMPORTED_MODULE_0__);const __WEBPACK_DEFAULT_EXPORT__=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default(),stringify=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().stringify,fromJSON=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().fromJSON,plugin=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().plugin,parse=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().parse,list=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().list,document=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().document,comment=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().comment,atRule=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().atRule,rule=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().rule,decl=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().decl,root=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().root,CssSyntaxError=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().CssSyntaxError,Declaration=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Declaration,Container=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Container,Processor=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Processor,Document=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Document,Comment=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Comment,Warning=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Warning,AtRule=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().AtRule,Result=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Result,Input=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Input,Rule=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Rule,Root=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Root,Node=_postcss_js__WEBPACK_IMPORTED_MODULE_0___default().Node},"../../node_modules/sanitize-html/node_modules/postcss/lib/previous-map.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let{SourceMapConsumer,SourceMapGenerator}=__webpack_require__("?5f2b"),{existsSync,readFileSync}=__webpack_require__("?7c97"),{dirname,join}=__webpack_require__("?5f82");class PreviousMap{constructor(css,opts){if(!1===opts.map)return;this.loadAnnotation(css),this.inline=this.startWith(this.annotation,"data:");let prev=opts.map?opts.map.prev:void 0,text=this.loadMap(opts.from,prev);!this.mapFile&&opts.from&&(this.mapFile=opts.from),this.mapFile&&(this.root=dirname(this.mapFile)),text&&(this.text=text)}consumer(){return this.consumerCache||(this.consumerCache=new SourceMapConsumer(this.text)),this.consumerCache}decodeInline(text){if(/^data:application\/json;charset=utf-?8,/.test(text)||/^data:application\/json,/.test(text))return decodeURIComponent(text.substr(RegExp.lastMatch.length));if(/^data:application\/json;charset=utf-?8;base64,/.test(text)||/^data:application\/json;base64,/.test(text))return function fromBase64(str){return Buffer?Buffer.from(str,"base64").toString():window.atob(str)}(text.substr(RegExp.lastMatch.length));let encoding=text.match(/data:application\/json;([^,]+),/)[1];throw new Error("Unsupported source map encoding "+encoding)}getAnnotationURL(sourceMapString){return sourceMapString.replace(/^\/\*\s*# sourceMappingURL=/,"").trim()}isMap(map){return"object"==typeof map&&("string"==typeof map.mappings||"string"==typeof map._mappings||Array.isArray(map.sections))}loadAnnotation(css){let comments=css.match(/\/\*\s*# sourceMappingURL=/gm);if(!comments)return;let start=css.lastIndexOf(comments.pop()),end=css.indexOf("*/",start);start>-1&&end>-1&&(this.annotation=this.getAnnotationURL(css.substring(start,end)))}loadFile(path){if(this.root=dirname(path),existsSync(path))return this.mapFile=path,readFileSync(path,"utf-8").toString().trim()}loadMap(file,prev){if(!1===prev)return!1;if(prev){if("string"==typeof prev)return prev;if("function"!=typeof prev){if(prev instanceof SourceMapConsumer)return SourceMapGenerator.fromSourceMap(prev).toString();if(prev instanceof SourceMapGenerator)return prev.toString();if(this.isMap(prev))return JSON.stringify(prev);throw new Error("Unsupported previous source map format: "+prev.toString())}{let prevPath=prev(file);if(prevPath){let map=this.loadFile(prevPath);if(!map)throw new Error("Unable to load previous source map: "+prevPath.toString());return map}}}else{if(this.inline)return this.decodeInline(this.annotation);if(this.annotation){let map=this.annotation;return file&&(map=join(dirname(file),map)),this.loadFile(map)}}}startWith(string,start){return!!string&&string.substr(0,start.length)===start}withContent(){return!!(this.consumer().sourcesContent&&this.consumer().sourcesContent.length>0)}}module.exports=PreviousMap,PreviousMap.default=PreviousMap},"../../node_modules/sanitize-html/node_modules/postcss/lib/processor.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let NoWorkResult=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/no-work-result.js"),LazyResult=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/lazy-result.js"),Document=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/document.js"),Root=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/root.js");class Processor{constructor(plugins=[]){this.version="8.4.33",this.plugins=this.normalize(plugins)}normalize(plugins){let normalized=[];for(let i of plugins)if(!0===i.postcss?i=i():i.postcss&&(i=i.postcss),"object"==typeof i&&Array.isArray(i.plugins))normalized=normalized.concat(i.plugins);else if("object"==typeof i&&i.postcssPlugin)normalized.push(i);else if("function"==typeof i)normalized.push(i);else{if("object"!=typeof i||!i.parse&&!i.stringify)throw new Error(i+" is not a PostCSS plugin")}return normalized}process(css,opts={}){return this.plugins.length||opts.parser||opts.stringifier||opts.syntax?new LazyResult(this,css,opts):new NoWorkResult(this,css,opts)}use(plugin){return this.plugins=this.plugins.concat(this.normalize([plugin])),this}}module.exports=Processor,Processor.default=Processor,Root.registerProcessor(Processor),Document.registerProcessor(Processor)},"../../node_modules/sanitize-html/node_modules/postcss/lib/result.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Warning=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/warning.js");class Result{constructor(processor,root,opts){this.processor=processor,this.messages=[],this.root=root,this.opts=opts,this.css=void 0,this.map=void 0}toString(){return this.css}warn(text,opts={}){opts.plugin||this.lastPlugin&&this.lastPlugin.postcssPlugin&&(opts.plugin=this.lastPlugin.postcssPlugin);let warning=new Warning(text,opts);return this.messages.push(warning),warning}warnings(){return this.messages.filter((i=>"warning"===i.type))}get content(){return this.css}}module.exports=Result,Result.default=Result},"../../node_modules/sanitize-html/node_modules/postcss/lib/root.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let LazyResult,Processor,Container=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/container.js");class Root extends Container{constructor(defaults){super(defaults),this.type="root",this.nodes||(this.nodes=[])}normalize(child,sample,type){let nodes=super.normalize(child);if(sample)if("prepend"===type)this.nodes.length>1?sample.raws.before=this.nodes[1].raws.before:delete sample.raws.before;else if(this.first!==sample)for(let node of nodes)node.raws.before=sample.raws.before;return nodes}removeChild(child,ignore){let index=this.index(child);return!ignore&&0===index&&this.nodes.length>1&&(this.nodes[1].raws.before=this.nodes[index].raws.before),super.removeChild(child)}toResult(opts={}){return new LazyResult(new Processor,this,opts).stringify()}}Root.registerLazyResult=dependant=>{LazyResult=dependant},Root.registerProcessor=dependant=>{Processor=dependant},module.exports=Root,Root.default=Root,Container.registerRoot(Root)},"../../node_modules/sanitize-html/node_modules/postcss/lib/rule.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Container=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/container.js"),list=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/list.js");class Rule extends Container{constructor(defaults){super(defaults),this.type="rule",this.nodes||(this.nodes=[])}get selectors(){return list.comma(this.selector)}set selectors(values){let match=this.selector?this.selector.match(/,\s*/):null,sep=match?match[0]:","+this.raw("between","beforeOpen");this.selector=values.join(sep)}}module.exports=Rule,Rule.default=Rule,Container.registerRule(Rule)},"../../node_modules/sanitize-html/node_modules/postcss/lib/stringifier.js":module=>{"use strict";const DEFAULT_RAW={after:"\n",beforeClose:"\n",beforeComment:"\n",beforeDecl:"\n",beforeOpen:" ",beforeRule:"\n",colon:": ",commentLeft:" ",commentRight:" ",emptyBody:"",indent:"    ",semicolon:!1};class Stringifier{constructor(builder){this.builder=builder}atrule(node,semicolon){let name="@"+node.name,params=node.params?this.rawValue(node,"params"):"";if(void 0!==node.raws.afterName?name+=node.raws.afterName:params&&(name+=" "),node.nodes)this.block(node,name+params);else{let end=(node.raws.between||"")+(semicolon?";":"");this.builder(name+params+end,node)}}beforeAfter(node,detect){let value;value="decl"===node.type?this.raw(node,null,"beforeDecl"):"comment"===node.type?this.raw(node,null,"beforeComment"):"before"===detect?this.raw(node,null,"beforeRule"):this.raw(node,null,"beforeClose");let buf=node.parent,depth=0;for(;buf&&"root"!==buf.type;)depth+=1,buf=buf.parent;if(value.includes("\n")){let indent=this.raw(node,null,"indent");if(indent.length)for(let step=0;step<depth;step++)value+=indent}return value}block(node,start){let after,between=this.raw(node,"between","beforeOpen");this.builder(start+between+"{",node,"start"),node.nodes&&node.nodes.length?(this.body(node),after=this.raw(node,"after")):after=this.raw(node,"after","emptyBody"),after&&this.builder(after),this.builder("}",node,"end")}body(node){let last=node.nodes.length-1;for(;last>0&&"comment"===node.nodes[last].type;)last-=1;let semicolon=this.raw(node,"semicolon");for(let i=0;i<node.nodes.length;i++){let child=node.nodes[i],before=this.raw(child,"before");before&&this.builder(before),this.stringify(child,last!==i||semicolon)}}comment(node){let left=this.raw(node,"left","commentLeft"),right=this.raw(node,"right","commentRight");this.builder("/*"+left+node.text+right+"*/",node)}decl(node,semicolon){let between=this.raw(node,"between","colon"),string=node.prop+between+this.rawValue(node,"value");node.important&&(string+=node.raws.important||" !important"),semicolon&&(string+=";"),this.builder(string,node)}document(node){this.body(node)}raw(node,own,detect){let value;if(detect||(detect=own),own&&(value=node.raws[own],void 0!==value))return value;let parent=node.parent;if("before"===detect){if(!parent||"root"===parent.type&&parent.first===node)return"";if(parent&&"document"===parent.type)return""}if(!parent)return DEFAULT_RAW[detect];let root=node.root();if(root.rawCache||(root.rawCache={}),void 0!==root.rawCache[detect])return root.rawCache[detect];if("before"===detect||"after"===detect)return this.beforeAfter(node,detect);{let method="raw"+function capitalize(str){return str[0].toUpperCase()+str.slice(1)}(detect);this[method]?value=this[method](root,node):root.walk((i=>{if(value=i.raws[own],void 0!==value)return!1}))}return void 0===value&&(value=DEFAULT_RAW[detect]),root.rawCache[detect]=value,value}rawBeforeClose(root){let value;return root.walk((i=>{if(i.nodes&&i.nodes.length>0&&void 0!==i.raws.after)return value=i.raws.after,value.includes("\n")&&(value=value.replace(/[^\n]+$/,"")),!1})),value&&(value=value.replace(/\S/g,"")),value}rawBeforeComment(root,node){let value;return root.walkComments((i=>{if(void 0!==i.raws.before)return value=i.raws.before,value.includes("\n")&&(value=value.replace(/[^\n]+$/,"")),!1})),void 0===value?value=this.raw(node,null,"beforeDecl"):value&&(value=value.replace(/\S/g,"")),value}rawBeforeDecl(root,node){let value;return root.walkDecls((i=>{if(void 0!==i.raws.before)return value=i.raws.before,value.includes("\n")&&(value=value.replace(/[^\n]+$/,"")),!1})),void 0===value?value=this.raw(node,null,"beforeRule"):value&&(value=value.replace(/\S/g,"")),value}rawBeforeOpen(root){let value;return root.walk((i=>{if("decl"!==i.type&&(value=i.raws.between,void 0!==value))return!1})),value}rawBeforeRule(root){let value;return root.walk((i=>{if(i.nodes&&(i.parent!==root||root.first!==i)&&void 0!==i.raws.before)return value=i.raws.before,value.includes("\n")&&(value=value.replace(/[^\n]+$/,"")),!1})),value&&(value=value.replace(/\S/g,"")),value}rawColon(root){let value;return root.walkDecls((i=>{if(void 0!==i.raws.between)return value=i.raws.between.replace(/[^\s:]/g,""),!1})),value}rawEmptyBody(root){let value;return root.walk((i=>{if(i.nodes&&0===i.nodes.length&&(value=i.raws.after,void 0!==value))return!1})),value}rawIndent(root){if(root.raws.indent)return root.raws.indent;let value;return root.walk((i=>{let p=i.parent;if(p&&p!==root&&p.parent&&p.parent===root&&void 0!==i.raws.before){let parts=i.raws.before.split("\n");return value=parts[parts.length-1],value=value.replace(/\S/g,""),!1}})),value}rawSemicolon(root){let value;return root.walk((i=>{if(i.nodes&&i.nodes.length&&"decl"===i.last.type&&(value=i.raws.semicolon,void 0!==value))return!1})),value}rawValue(node,prop){let value=node[prop],raw=node.raws[prop];return raw&&raw.value===value?raw.raw:value}root(node){this.body(node),node.raws.after&&this.builder(node.raws.after)}rule(node){this.block(node,this.rawValue(node,"selector")),node.raws.ownSemicolon&&this.builder(node.raws.ownSemicolon,node,"end")}stringify(node,semicolon){if(!this[node.type])throw new Error("Unknown AST node type "+node.type+". Maybe you need to change PostCSS stringifier.");this[node.type](node,semicolon)}}module.exports=Stringifier,Stringifier.default=Stringifier},"../../node_modules/sanitize-html/node_modules/postcss/lib/stringify.js":(module,__unused_webpack_exports,__webpack_require__)=>{"use strict";let Stringifier=__webpack_require__("../../node_modules/sanitize-html/node_modules/postcss/lib/stringifier.js");function stringify(node,builder){new Stringifier(builder).stringify(node)}module.exports=stringify,stringify.default=stringify},"../../node_modules/sanitize-html/node_modules/postcss/lib/symbols.js":module=>{"use strict";module.exports.isClean=Symbol("isClean"),module.exports.my=Symbol("my")},"../../node_modules/sanitize-html/node_modules/postcss/lib/tokenize.js":module=>{"use strict";const SINGLE_QUOTE="'".charCodeAt(0),DOUBLE_QUOTE='"'.charCodeAt(0),BACKSLASH="\\".charCodeAt(0),SLASH="/".charCodeAt(0),NEWLINE="\n".charCodeAt(0),SPACE=" ".charCodeAt(0),FEED="\f".charCodeAt(0),TAB="\t".charCodeAt(0),CR="\r".charCodeAt(0),OPEN_SQUARE="[".charCodeAt(0),CLOSE_SQUARE="]".charCodeAt(0),OPEN_PARENTHESES="(".charCodeAt(0),CLOSE_PARENTHESES=")".charCodeAt(0),OPEN_CURLY="{".charCodeAt(0),CLOSE_CURLY="}".charCodeAt(0),SEMICOLON=";".charCodeAt(0),ASTERISK="*".charCodeAt(0),COLON=":".charCodeAt(0),AT="@".charCodeAt(0),RE_AT_END=/[\t\n\f\r "#'()/;[\\\]{}]/g,RE_WORD_END=/[\t\n\f\r !"#'():;@[\\\]{}]|\/(?=\*)/g,RE_BAD_BRACKET=/.[\r\n"'(/\\]/,RE_HEX_ESCAPE=/[\da-f]/i;module.exports=function tokenizer(input,options={}){let code,next,quote,content,escape,escaped,escapePos,prev,n,currentToken,css=input.css.valueOf(),ignore=options.ignoreErrors,length=css.length,pos=0,buffer=[],returned=[];function unclosed(what){throw input.error("Unclosed "+what,pos)}return{back:function back(token){returned.push(token)},endOfFile:function endOfFile(){return 0===returned.length&&pos>=length},nextToken:function nextToken(opts){if(returned.length)return returned.pop();if(pos>=length)return;let ignoreUnclosed=!!opts&&opts.ignoreUnclosed;switch(code=css.charCodeAt(pos),code){case NEWLINE:case SPACE:case TAB:case CR:case FEED:next=pos;do{next+=1,code=css.charCodeAt(next)}while(code===SPACE||code===NEWLINE||code===TAB||code===CR||code===FEED);currentToken=["space",css.slice(pos,next)],pos=next-1;break;case OPEN_SQUARE:case CLOSE_SQUARE:case OPEN_CURLY:case CLOSE_CURLY:case COLON:case SEMICOLON:case CLOSE_PARENTHESES:{let controlChar=String.fromCharCode(code);currentToken=[controlChar,controlChar,pos];break}case OPEN_PARENTHESES:if(prev=buffer.length?buffer.pop()[1]:"",n=css.charCodeAt(pos+1),"url"===prev&&n!==SINGLE_QUOTE&&n!==DOUBLE_QUOTE&&n!==SPACE&&n!==NEWLINE&&n!==TAB&&n!==FEED&&n!==CR){next=pos;do{if(escaped=!1,next=css.indexOf(")",next+1),-1===next){if(ignore||ignoreUnclosed){next=pos;break}unclosed("bracket")}for(escapePos=next;css.charCodeAt(escapePos-1)===BACKSLASH;)escapePos-=1,escaped=!escaped}while(escaped);currentToken=["brackets",css.slice(pos,next+1),pos,next],pos=next}else next=css.indexOf(")",pos+1),content=css.slice(pos,next+1),-1===next||RE_BAD_BRACKET.test(content)?currentToken=["(","(",pos]:(currentToken=["brackets",content,pos,next],pos=next);break;case SINGLE_QUOTE:case DOUBLE_QUOTE:quote=code===SINGLE_QUOTE?"'":'"',next=pos;do{if(escaped=!1,next=css.indexOf(quote,next+1),-1===next){if(ignore||ignoreUnclosed){next=pos+1;break}unclosed("string")}for(escapePos=next;css.charCodeAt(escapePos-1)===BACKSLASH;)escapePos-=1,escaped=!escaped}while(escaped);currentToken=["string",css.slice(pos,next+1),pos,next],pos=next;break;case AT:RE_AT_END.lastIndex=pos+1,RE_AT_END.test(css),next=0===RE_AT_END.lastIndex?css.length-1:RE_AT_END.lastIndex-2,currentToken=["at-word",css.slice(pos,next+1),pos,next],pos=next;break;case BACKSLASH:for(next=pos,escape=!0;css.charCodeAt(next+1)===BACKSLASH;)next+=1,escape=!escape;if(code=css.charCodeAt(next+1),escape&&code!==SLASH&&code!==SPACE&&code!==NEWLINE&&code!==TAB&&code!==CR&&code!==FEED&&(next+=1,RE_HEX_ESCAPE.test(css.charAt(next)))){for(;RE_HEX_ESCAPE.test(css.charAt(next+1));)next+=1;css.charCodeAt(next+1)===SPACE&&(next+=1)}currentToken=["word",css.slice(pos,next+1),pos,next],pos=next;break;default:code===SLASH&&css.charCodeAt(pos+1)===ASTERISK?(next=css.indexOf("*/",pos+2)+1,0===next&&(ignore||ignoreUnclosed?next=css.length:unclosed("comment")),currentToken=["comment",css.slice(pos,next+1),pos,next],pos=next):(RE_WORD_END.lastIndex=pos+1,RE_WORD_END.test(css),next=0===RE_WORD_END.lastIndex?css.length-1:RE_WORD_END.lastIndex-2,currentToken=["word",css.slice(pos,next+1),pos,next],buffer.push(currentToken),pos=next)}return pos++,currentToken},position:function position(){return pos}}}},"../../node_modules/sanitize-html/node_modules/postcss/lib/warn-once.js":module=>{"use strict";let printed={};module.exports=function warnOnce(message){printed[message]||(printed[message]=!0,"undefined"!=typeof console&&console.warn&&console.warn(message))}},"../../node_modules/sanitize-html/node_modules/postcss/lib/warning.js":module=>{"use strict";class Warning{constructor(text,opts={}){if(this.type="warning",this.text=text,opts.node&&opts.node.source){let range=opts.node.rangeBy(opts);this.line=range.start.line,this.column=range.start.column,this.endLine=range.end.line,this.endColumn=range.end.column}for(let opt in opts)this[opt]=opts[opt]}toString(){return this.node?this.node.error(this.text,{index:this.index,plugin:this.plugin,word:this.word}).message:this.plugin?this.plugin+": "+this.text:this.text}}module.exports=Warning,Warning.default=Warning},"../../node_modules/tslib/tslib.es6.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{_T:()=>__rest,ev:()=>__spreadArray,pi:()=>__assign});var __assign=function(){return __assign=Object.assign||function __assign(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)};function __rest(s,e){var t={};for(var p in s)Object.prototype.hasOwnProperty.call(s,p)&&e.indexOf(p)<0&&(t[p]=s[p]);if(null!=s&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(p=Object.getOwnPropertySymbols(s);i<p.length;i++)e.indexOf(p[i])<0&&Object.prototype.propertyIsEnumerable.call(s,p[i])&&(t[p[i]]=s[p[i]])}return t}Object.create;function __spreadArray(to,from,pack){if(pack||2===arguments.length)for(var ar,i=0,l=from.length;i<l;i++)!ar&&i in from||(ar||(ar=Array.prototype.slice.call(from,0,i)),ar[i]=from[i]);return to.concat(ar||Array.prototype.slice.call(from))}Object.create;"function"==typeof SuppressedError&&SuppressedError},"../../node_modules/typesafe-actions/dist/typesafe-actions.umd.production.js":function(__unused_webpack_module,exports){!function(n){"use strict";function t(n){return null==n}function r(n){throw new Error("Argument "+n+" is empty.")}function e(n){return"function"==typeof n&&"getType"in n}function i(n){throw new Error("Argument "+n+' is invalid, it should be an action-creator instance from "typesafe-actions"')}function o(n,t){if(null==n)throw new Error("Argument contains array with empty element at index "+t);if(null==n.getType)throw new Error("Argument contains array with invalid element at index "+t+', it should be an action-creator instance from "typesafe-actions"')}function u(n){return"string"==typeof n||"symbol"==typeof n}function a(n){return!u(n)}function c(n){throw new Error("Argument "+n+" is invalid, it should be an action type of type: string | symbol")}function f(n,t){if(null==n)throw new Error("Argument contains array with empty element at index "+t);if("string"!=typeof n&&"symbol"!=typeof n)throw new Error("Argument contains array with invalid element at index "+t+", it should be of type: string | symbol")}function s(n,e,o,u){return t(n)&&r(1),a(n)&&i(1),{type:n,payload:e,meta:o,error:u}}function y(n,e){return t(n)&&r(1),a(n)&&c(1),Object.assign((function(){var t=null!=e?e.apply(void 0,arguments):void 0;return Object.assign({type:n},t)}),{getType:function(){return n},toString:function(){return n}})}function l(n,e,i){return t(n)&&r(1),a(n)&&c(1),function(){return y(n,(function(){var n=arguments.length<=0?void 0:arguments[0],t=arguments.length<=1?void 0:arguments[1];return null==e&&null==i||(n=null!=e?e.apply(void 0,arguments):void 0,t=null!=i?i.apply(void 0,arguments):void 0),Object.assign({},void 0!==n&&{payload:n},{},void 0!==t&&{meta:t})}))}}function p(n){return t(n)&&r(1),e(n)||i(1),n.getType()}function d(n,e){t(n)&&r(1),a(n)&&c(1);var i=null!=e?e(n):function(){return{type:n}};return Object.assign(i,{getType:function(){return n},toString:function(){return n}})}var g={createAction:function(n,t){var r=null==t?function(){return s(n)}:t(s.bind(null,n));return Object.assign(r,{getType:function(){return n},toString:function(){return n}})},createCustomAction:d,createStandardAction:function(n){return t(n)&&r(1),a(n)&&c(1),Object.assign((function(){return d(n,(function(n){return function(t,r){return{type:n,payload:t,meta:r}}}))}),{map:function(t){return d(n,(function(n){return function(r,e){return Object.assign(t(r,e),{type:n})}}))}})}};n.action=s,n.createAction=l,n.createAsyncAction=function(n,t,r,e){return function(){var i=[n,t,r,e].map((function(n,t){return Array.isArray(n)?l(n[0],n[1],n[2])():"string"==typeof n||"symbol"==typeof n?l(n)():void(t<3&&function(n){throw new Error("Argument "+n+' is invalid, it should be an action type of "string | symbol" or a tuple of "[string | symbol, Function, Function?]"')}(t))}));return{request:i[0],success:i[1],failure:i[2],cancel:i[3]}}},n.createCustomAction=y,n.createReducer=function n(t,r){void 0===r&&(r={});var i=Object.assign({},r),o=function(r,o){var a=Array.isArray(r)?r:[r],c={};return a.map((function(n,t){return e(n)?p(n):u(n)?n:function(n){throw new Error("Argument "+n+' is invalid, it should be an action-creator instance from "typesafe-actions" or action type of type: string | symbol')}(t+1)})).forEach((function(n){return c[n]=o})),n(t,Object.assign({},i,{},c))};return Object.assign((function(n,r){if(void 0===n&&(n=t),i.hasOwnProperty(r.type)){var e=i[r.type];if("function"!=typeof e)throw Error('Reducer under "'+r.type+'" key is not a valid reducer');return e(n,r)}return n}),{handlers:Object.assign({},i),handleAction:o,handleType:o})},n.deprecated=g,n.getType=p,n.isActionOf=function(n,e){t(n)&&r(1);var i=Array.isArray(n)?n:[n];i.forEach(o);var u=function(n){return i.some((function(t){return n.type===t.getType()}))};return void 0===e?u:u(e)},n.isOfType=function(n,e){t(n)&&r(1);var i=Array.isArray(n)?n:[n];i.forEach(f);var o=function(n){return i.includes(n.type)};return void 0===e?o:o(e)}}(exports)},"../../node_modules/use-callback-ref/dist/es2015/useMergeRef.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{q:()=>useMergeRefs});var react=__webpack_require__("../../node_modules/react/index.js");function assignRef(ref,value){return"function"==typeof ref?ref(value):ref&&(ref.current=value),ref}var currentValues=new WeakMap;function useMergeRefs(refs,defaultValue){var callbackRef=function useCallbackRef(initialValue,callback){var ref=(0,react.useState)((function(){return{value:initialValue,callback,facade:{get current(){return ref.value},set current(value){var last=ref.value;last!==value&&(ref.value=value,ref.callback(value,last))}}}}))[0];return ref.callback=callback,ref.facade}(defaultValue||null,(function(newValue){return refs.forEach((function(ref){return assignRef(ref,newValue)}))}));return react.useLayoutEffect((function(){var oldValue=currentValues.get(callbackRef);if(oldValue){var prevRefs_1=new Set(oldValue),nextRefs_1=new Set(refs),current_1=callbackRef.current;prevRefs_1.forEach((function(ref){nextRefs_1.has(ref)||assignRef(ref,null)})),nextRefs_1.forEach((function(ref){prevRefs_1.has(ref)||assignRef(ref,current_1)}))}currentValues.set(callbackRef,refs)}),[refs]),callbackRef}},"../../node_modules/use-sidecar/dist/es2015/exports.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{L:()=>exportSidecar});var tslib__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/tslib/tslib.es6.mjs"),react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/react/index.js"),SideCar=function(_a){var sideCar=_a.sideCar,rest=(0,tslib__WEBPACK_IMPORTED_MODULE_1__._T)(_a,["sideCar"]);if(!sideCar)throw new Error("Sidecar: please provide `sideCar` property to import the right car");var Target=sideCar.read();if(!Target)throw new Error("Sidecar medium not found");return react__WEBPACK_IMPORTED_MODULE_0__.createElement(Target,(0,tslib__WEBPACK_IMPORTED_MODULE_1__.pi)({},rest))};function exportSidecar(medium,exported){return medium.useMedium(exported),SideCar}SideCar.isSideCarExport=!0},"../../node_modules/use-sidecar/dist/es2015/medium.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{_:()=>createSidecarMedium});var tslib__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/tslib/tslib.es6.mjs");function ItoI(a){return a}function innerCreateMedium(defaults,middleware){void 0===middleware&&(middleware=ItoI);var buffer=[],assigned=!1;return{read:function(){if(assigned)throw new Error("Sidecar: could not `read` from an `assigned` medium. `read` could be used only with `useMedium`.");return buffer.length?buffer[buffer.length-1]:defaults},useMedium:function(data){var item=middleware(data,assigned);return buffer.push(item),function(){buffer=buffer.filter((function(x){return x!==item}))}},assignSyncMedium:function(cb){for(assigned=!0;buffer.length;){var cbs=buffer;buffer=[],cbs.forEach(cb)}buffer={push:function(x){return cb(x)},filter:function(){return buffer}}},assignMedium:function(cb){assigned=!0;var pendingQueue=[];if(buffer.length){var cbs=buffer;buffer=[],cbs.forEach(cb),pendingQueue=buffer}var executeQueue=function(){var cbs=pendingQueue;pendingQueue=[],cbs.forEach(cb)},cycle=function(){return Promise.resolve().then(executeQueue)};cycle(),buffer={push:function(x){pendingQueue.push(x),cycle()},filter:function(filter){return pendingQueue=pendingQueue.filter(filter),buffer}}}}}function createSidecarMedium(options){void 0===options&&(options={});var medium=innerCreateMedium(null);return medium.options=(0,tslib__WEBPACK_IMPORTED_MODULE_0__.pi)({async:!0,ssr:!1},options),medium}}}]);